<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>zhongyp&#39;blog</title>
  
  <subtitle>é’Ÿå®‡é¹çš„åšå®¢</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://zhongyp.me/"/>
  <updated>2019-09-29T01:51:10.571Z</updated>
  <id>https://zhongyp.me/</id>
  
  <author>
    <name>zhongyp</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>çŸ¥è¯†ç»“æ„å›¾</title>
    <link href="https://zhongyp.me/java/2019-09-29-knowledge-structure/"/>
    <id>https://zhongyp.me/java/2019-09-29-knowledge-structure/</id>
    <published>2019-09-28T16:00:00.000Z</published>
    <updated>2019-09-29T01:51:10.571Z</updated>
    
    <content type="html"><![CDATA[<p><img src="/media/article/knowledge-structure.png" alt="knowledge-structure"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;img src=&quot;/media/article/knowledge-structure.png&quot; alt=&quot;knowledge-structure&quot;&gt;&lt;/p&gt;

      
    
    </summary>
    
    
      <category term="Java" scheme="https://zhongyp.me/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>é—²è°ˆJavaå¼•ç”¨</title>
    <link href="https://zhongyp.me/java/2019-09-15-reference/"/>
    <id>https://zhongyp.me/java/2019-09-15-reference/</id>
    <published>2019-09-14T16:00:00.000Z</published>
    <updated>2019-09-23T11:33:10.812Z</updated>
    
    <content type="html"><![CDATA[<p>Javaè¯­è¨€å¯¹å¯¹è±¡çš„å¼•ç”¨æœ‰å¦‚ä¸‹å››ç§ï¼šå¼ºå¼•ç”¨(StrongReference)ã€ è½¯å¼•ç”¨(SoftReference)ã€è™šå¼•ç”¨(PhantomReference)ã€ å¼±å¼•ç”¨(WeakReference)ã€‚</p><h2 id="1-å¼ºå¼•ç”¨-StrongReference"><a href="#1-å¼ºå¼•ç”¨-StrongReference" class="headerlink" title="1. å¼ºå¼•ç”¨(StrongReference)"></a>1. å¼ºå¼•ç”¨(StrongReference)</h2><p>Javaä¸­æœ€å¸¸è§çš„å¼•ç”¨æ–¹å¼ã€‚å½“ä¸€ä¸ªå¯¹è±¡è¢«ä¸€ä¸ªæˆ–è€…ä¸€ä¸ªä»¥ä¸Šçš„å¼•ç”¨å˜é‡å¼•ç”¨æ—¶ï¼Œå®ƒå¤„äºæ¿€æ´»çŠ¶æ€ï¼Œä¸å¯èƒ½è¢«ç³»ç»Ÿåƒåœ¾å›æ”¶æœºåˆ¶å›æ”¶ã€‚</p><h2 id="2-è½¯å¼•ç”¨-SoftReference"><a href="#2-è½¯å¼•ç”¨-SoftReference" class="headerlink" title="2. è½¯å¼•ç”¨(SoftReference)"></a>2. è½¯å¼•ç”¨(SoftReference)</h2><p>è½¯å¼•ç”¨éœ€è¦é€šè¿‡SoftRefrenceç±»æ¥å®ç°ï¼Œå½“ä¸€ä¸ªå¯¹è±¡åªå…·æœ‰è½¯å¼•ç”¨æ—¶ï¼Œå¯èƒ½è¢«åƒåœ¾å›æ”¶æœºåˆ¶å›æ”¶ã€‚å½“ç³»ç»Ÿå†…å­˜ç©ºé—´è¶³å¤Ÿæ—¶ï¼Œå®ƒä¸ä¼šè¢«ç³»ç»Ÿå›æ”¶ï¼Œå½“ç³»ç»Ÿå†…å­˜ç©ºé—´ä¸å¤Ÿæ—¶ï¼Œç³»ç»Ÿå°†ä¼šå›æ”¶ã€‚</p><p>å’Œå¼±å¼•ç”¨çš„åŒºåˆ«ä»…ä»…åœ¨äºåƒåœ¾å›æ”¶æ—¶ï¼Œ æ˜¯å¦æ ¹æ®ç©ºé—´å¤§å°å›æ”¶çš„åŒºåˆ«ã€‚</p><p>ä½•æ—¶å›æ”¶è½¯å¼•ç”¨çš„å¯¹è±¡ï¼Ÿ</p><p>ä»1.3.1å¼€å§‹è½¯å¯è¾¾å¯¹è±¡å°†åœ¨æœ€åè¢«å¼•ç”¨ä¹‹åå­˜æ´»ä¸€æ®µæ—¶é—´ã€‚é»˜è®¤å€¼æ˜¯å †ä¸­æ¯MBç©ºé—²ç©ºé—´ä¸€ç§’çš„ç”Ÿå­˜æ—¶é—´ã€‚è¿™ä¸ªå€¼å¯ä»¥ä½¿ç”¨<code>-XX:SoftRefLRUPolicyMSPerMB</code>è°ƒæ•´ã€‚<br>Java HotspotæœåŠ¡ç«¯è™šæ‹Ÿæœºä½¿ç”¨æœ€å¤§å¯èƒ½çš„å †å¤§å°è®¡ç®—å‰©ä½™å¯ç”¨ç©ºé—´ã€‚<br>Java Hotspotå®¢æˆ·ç«¯è™šæ‹Ÿæœºä½¿ç”¨å½“å‰å †å¤§å°è®¡ç®—ç©ºé—²ç©ºé—´ã€‚<br>è¿™å°±æ„å‘³ç€å¯¹äºæœåŠ¡ç«¯è™šæ‹Ÿæœºæ€»ä½“è¶‹åŠ¿æ˜¯å¢é•¿å †è€Œä¸æ˜¯æ¸…ç†è½¯å¼•ç”¨ï¼Œå› æ­¤åœ¨åƒåœ¾å›æ”¶æ—¶<code>-Xmx</code>å¯¹è½¯å¼•ç”¨çš„å›æ”¶æœ‰é‡è¦çš„å½±å“ã€‚<br>ç›¸åï¼Œå®¢æˆ·ç«¯è™šæ‹Ÿæœºå°†å¾ˆå¤§è¶‹åŠ¿å»æ¸…ç†è½¯å¼•ç”¨è€Œä¸æ˜¯å¢é•¿å †ã€‚</p><p>ä¸Šè¿°è¡Œä¸ºå¯¹äº1.3.1åˆ°Java SE 6ç‰ˆæœ¬çš„Java HotSpot VMéƒ½æ˜¯æ­£ç¡®çš„ã€‚ä½†æ˜¯ï¼Œæ­¤è¡Œä¸ºä¸æ˜¯VMè§„èŒƒçš„ä¸€éƒ¨åˆ†ï¼Œå¹¶ä¸”åœ¨å°†æ¥çš„ç‰ˆæœ¬ä¸­å¯èƒ½ä¼šæ›´æ”¹ã€‚åŒæ ·ï¼Œä¸ä¿è¯-XXï¼šSoftRefLRUPolicyMSPerMBæ ‡å¿—åœ¨ä»»ä½•ç»™å®šçš„å‘è¡Œç‰ˆä¸­å‡ä¸å­˜åœ¨ã€‚</p><p>åœ¨1.3.1ç‰ˆä¹‹å‰ï¼ŒJava HotSpot VMä¼šåœ¨å‘ç°è½¯å¼•ç”¨æ—¶æ¸…é™¤å®ƒä»¬ã€‚</p><p>å½“æˆ‘å®šæœŸæ‰“å¼€-verboseï¼šgcæ—¶ï¼Œæˆ‘å¾—åˆ°äº†å¾ˆå¤šå®Œæ•´çš„GCï¼Œå·²ç»è°ƒæ•´äº†å †å¹¶ä¸”æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œè¿™æ˜¯æ€ä¹ˆå›äº‹ï¼Ÿ</p><p>å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯RMIï¼Œåˆ™å¯èƒ½ä¼šé‡åˆ°åˆ†å¸ƒå¼GCã€‚å¦å¤–ï¼ŒæŸäº›åº”ç”¨ç¨‹åºæ·»åŠ äº†æ˜¾å¼GCçš„æ€æƒ³ï¼Œå³å®ƒå°†ä½¿å®ƒä»¬çš„åº”ç”¨ç¨‹åºæ›´å¿«ã€‚å¹¸è¿çš„æ˜¯ï¼Œæ‚¨å¯ä»¥åœ¨1.3åŠæ›´é«˜ç‰ˆæœ¬ä¸­ä½¿ç”¨å‘½ä»¤è¡Œé€‰é¡¹ç¦ç”¨æ­¤åŠŸèƒ½ã€‚å°è¯•å°†-XXï¼š+ DisableExplicitGCä¸-verboseï¼šgcä¸€èµ·ä½¿ç”¨ï¼Œçœ‹çœ‹æ˜¯å¦æœ‰å¸®åŠ©ã€‚</p><h2 id="3-è™šå¼•ç”¨-PhantomReference"><a href="#3-è™šå¼•ç”¨-PhantomReference" class="headerlink" title="3. è™šå¼•ç”¨(PhantomReference)"></a>3. è™šå¼•ç”¨(PhantomReference)</h2><p>è™šå¼•ç”¨é€šè¿‡PhantomReferenceå®ç°ï¼Œè™šå¼•ç”¨ç±»ä¼¼äºå®Œå…¨æ²¡æœ‰å¼•ç”¨ï¼Œè™šå¼•ç”¨å¯¹å¯¹è±¡æœ¬èº«æ²¡æœ‰å¤ªå¤§çš„å½±å“ã€‚è™šå¼•ç”¨ä¸»è¦ç”¨äºè·Ÿè¸ªå¯¹è±¡è¢«åƒåœ¾å›æ”¶çš„çŠ¶æ€ï¼Œè™šå¼•ç”¨ä¸èƒ½å•ç‹¬ä½¿ç”¨ï¼Œè™šå¼•ç”¨å¿…é¡»å’Œå¼•ç”¨é˜Ÿåˆ—(ReferenceQueue)è”åˆä½¿ç”¨ã€‚</p><p>ä¸¾ä¾‹æ¥è¯´å°±æ˜¯ï¼Œå¦‚æœåƒåœ¾å›æ”¶æ—¶ï¼Œå‘ç°ä¸€ä¸ªå®ä¾‹å¯¹è±¡é™¤äº†è™šå¼•ç”¨å¤–æ²¡æœ‰ä»»ä½•å…¶ä»–çš„å¼•ç”¨ï¼Œå°†ä¼šæŠŠè¿™ä¸ªå¼•ç”¨æ”¾åˆ°<br><code>java.lang.ref.Reference.pending</code>é˜Ÿåˆ—é‡Œï¼ŒGCå®Œæˆæ—¶ï¼Œé€šçŸ¥ReferenceHandlerè¿™ä¸ªå®ˆæŠ¤çº¿ç¨‹åšä¸€äº›åç»­å¤„ç†ï¼ˆå¦‚é‡Šæ”¾å†…å­˜ç­‰ç­‰æ“ä½œï¼‰ã€‚</p><h2 id="4-å¼±å¼•ç”¨-WeakReference"><a href="#4-å¼±å¼•ç”¨-WeakReference" class="headerlink" title="4. å¼±å¼•ç”¨(WeakReference)"></a>4. å¼±å¼•ç”¨(WeakReference)</h2><p>å¼±å¼•ç”¨é€šè¿‡WeakReferenceç±»å®ç°ï¼Œå¯¹åªæœ‰å¼±å¼•ç”¨çš„å¯¹è±¡è€Œè¨€ï¼Œå½“ç³»ç»Ÿåƒåœ¾å›æ”¶æœºåˆ¶è¿è¡Œæ—¶ï¼Œä¸ç®¡å†…å­˜æ˜¯å¦è¶³å¤Ÿï¼Œæ€»ä¼šå›æ”¶è¯¥å¯¹è±¡æ‰€å ç”¨çš„å†…å­˜ã€‚</p><h3 id="4-1-ç¤ºä¾‹"><a href="#4-1-ç¤ºä¾‹" class="headerlink" title="4.1 ç¤ºä¾‹"></a>4.1 ç¤ºä¾‹</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ReferenceQueue referenceQueue = new ReferenceQueue();</span><br><span class="line">WeakReference weakReference = new WeakReference(new TestEntity(), referenceQueue);</span><br><span class="line">((TestEntity) weakReference.get()).test();</span><br></pre></td></tr></table></figure><p>ReferenceQueueçš„ä½œç”¨æ˜¯ä¸ºäº†æŸ¥çœ‹å“ªäº›WeakReferenceå’ŒSoftRefereceè¢«å›æ”¶äº†ã€‚</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a href="https://book.douban.com/subject/3246499/" target="_blank" rel="noopener">ç–¯ç‹‚Javaè®²ä¹‰</a></p><p><a href="https://www.jianshu.com/p/e66930caca9c" target="_blank" rel="noopener">Java PhantomReferenceè¯¦è§£</a></p><p><a href="oracle.com/technetwork/java/hotspotfaq-138619.html#gc_softrefs">Frequently Asked Questions About the Java HotSpot VM</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Javaè¯­è¨€å¯¹å¯¹è±¡çš„å¼•ç”¨æœ‰å¦‚ä¸‹å››ç§ï¼šå¼ºå¼•ç”¨(StrongReference)ã€ è½¯å¼•ç”¨(SoftReference)ã€è™šå¼•ç”¨(PhantomReference)ã€ å¼±å¼•ç”¨(WeakReference)ã€‚&lt;/p&gt;
&lt;h2 id=&quot;1-å¼ºå¼•ç”¨-StrongReference&quot;&gt;
      
    
    </summary>
    
    
      <category term="Java" scheme="https://zhongyp.me/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>Javaè™šæ‹ŸæœºçŸ¥è¯†ç‚¹æ¶æ„å›¾</title>
    <link href="https://zhongyp.me/jvm/2019-09-08-jvm-structure/"/>
    <id>https://zhongyp.me/jvm/2019-09-08-jvm-structure/</id>
    <published>2019-09-07T16:00:00.000Z</published>
    <updated>2019-09-08T12:59:18.234Z</updated>
    
    <content type="html"><![CDATA[<p><img src="/media/article/jvm-structure.png" alt="jvm-structure"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;img src=&quot;/media/article/jvm-structure.png&quot; alt=&quot;jvm-structure&quot;&gt;&lt;/p&gt;

      
    
    </summary>
    
    
      <category term="JVM" scheme="https://zhongyp.me/tags/JVM/"/>
    
  </entry>
  
  <entry>
    <title>åŠ¨æ€ä»£ç†æµ…æ</title>
    <link href="https://zhongyp.me/java/2019-09-09-java-proxy/"/>
    <id>https://zhongyp.me/java/2019-09-09-java-proxy/</id>
    <published>2019-09-06T16:00:00.000Z</published>
    <updated>2019-09-30T12:04:33.631Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-åŠ¨æ€ä»£ç†"><a href="#1-åŠ¨æ€ä»£ç†" class="headerlink" title="1. åŠ¨æ€ä»£ç†"></a>1. åŠ¨æ€ä»£ç†</h2><p>ä»£ç†æ˜¯ä¸€ç§å¸¸ç”¨çš„è®¾è®¡æ¨¡å¼ï¼Œå…¶ç›®çš„å°±æ˜¯ä¸ºå…¶ä»–å¯¹è±¡æä¾›ä¸€ä¸ªä»£ç†ä»¥æ§åˆ¶å¯¹æŸä¸ªå¯¹è±¡çš„è®¿é—®ã€‚ä»£ç†ç±»è´Ÿè´£ä¸ºå§”æ‰˜ç±»é¢„å¤„ç†æ¶ˆæ¯ï¼Œè¿‡æ»¤æ¶ˆæ¯å¹¶è½¬å‘æ¶ˆæ¯ï¼Œä»¥åŠè¿›è¡Œæ¶ˆæ¯è¢«å§”æ‰˜ç±»æ‰§è¡Œåçš„åç»­å¤„ç†ã€‚</p><p>åŠ¨æ€ä»£ç†åˆ™æ˜¯ä¸€ç§æ–¹ä¾¿è¿è¡Œæ—¶åŠ¨æ€æ„å»ºä»£ç†ã€åŠ¨æ€å¤„ç†ä»£ç†æ–¹æ³•è°ƒç”¨çš„æœºåˆ¶ã€‚</p><p>å®ç°åŠ¨æ€ä»£ç†çš„æ–¹å¼æœ‰å¾ˆå¤šï¼Œå¦‚ ASMã€AspectJã€Javassistã€Java Proxyç­‰ã€‚<br><img src="/media/article/15688575046625.png" alt="jclasslib"><br>å›¾ç‰‡å¼•ç”¨è‡ª<a href="https://tech.meituan.com/2019/09/05/java-bytecode-enhancement.html" target="_blank" rel="noopener">ã€Šç¾å›¢æŠ€æœ¯å›¢é˜Ÿã€‹-å­—èŠ‚ç å¢å¼ºæŠ€æœ¯æ¢ç´¢</a></p><h2 id="2-åå°„"><a href="#2-åå°„" class="headerlink" title="2. åå°„"></a>2. åå°„</h2><p>Java åŠ¨æ€ä»£ç†ä¸­é™¤äº†å­—èŠ‚ç å¢å¼ºæŠ€æœ¯å¤–ï¼Œæœ€ä¸»è¦çš„å°±æ˜¯Javaçš„åå°„æœºåˆ¶ã€‚</p><blockquote><p>Reflection is commonly used by programs which require the ability to examine or modify the runtime behavior of applications running in the Java virtual machine. This is a relatively advanced feature and should be used only by developers who have a strong grasp of the fundamentals of the language. With that caveat in mind, reflection is a powerful technique and can enable applications to perform operations which would otherwise be impossible. â€“å¼•ç”¨è‡ª<a href="https://docs.oracle.com/javase/tutorial/reflect/index.html" target="_blank" rel="noopener">Java Reflection API</a></p></blockquote><p>åœ¨Javaä¸­çš„åå°„æœºåˆ¶æ˜¯æŒ‡åœ¨è¿è¡ŒçŠ¶æ€ä¸­ï¼Œå¯¹äºä»»æ„ä¸€ä¸ªç±»éƒ½èƒ½å¤ŸçŸ¥é“è¿™ä¸ªç±»æ‰€æœ‰çš„å±æ€§å’Œæ–¹æ³•;å¹¶ä¸”å¯¹äºä»»æ„ä¸€ä¸ªå¯¹è±¡ï¼Œéƒ½èƒ½å¤Ÿè°ƒç”¨å®ƒçš„ä»»æ„ä¸€ä¸ªæ–¹æ³•;è¿™ç§åŠ¨æ€è·å–ä¿¡æ¯ä»¥åŠåŠ¨æ€è°ƒç”¨å¯¹è±¡æ–¹æ³•çš„åŠŸèƒ½æˆä¸ºJavaè¯­è¨€çš„åå°„æœºåˆ¶ã€‚</p><h2 id="3-å¸¸ç”¨çš„ä¸‰ç§ä»£ç†æ–¹å¼"><a href="#3-å¸¸ç”¨çš„ä¸‰ç§ä»£ç†æ–¹å¼" class="headerlink" title="3. å¸¸ç”¨çš„ä¸‰ç§ä»£ç†æ–¹å¼"></a>3. å¸¸ç”¨çš„ä¸‰ç§ä»£ç†æ–¹å¼</h2><blockquote><p>åœ¨Java è¯­è¨€ä¸­ï¼Œä»ç»‡å…¥åˆ‡é¢çš„æ–¹å¼ä¸Šæ¥çœ‹ï¼Œå­˜åœ¨ä¸‰ç§ç»‡å…¥æ–¹å¼ï¼šç¼–è¯‘æœŸç»‡å…¥ã€ç±»åŠ è½½æœŸç»‡å…¥å’Œè¿è¡ŒæœŸç»‡å…¥ã€‚ç¼–è¯‘æœŸç»‡å…¥æ˜¯æŒ‡åœ¨Javaç¼–è¯‘æœŸï¼Œé‡‡ç”¨ç‰¹æ®Šçš„ç¼–è¯‘å™¨ï¼Œå°†åˆ‡é¢ç»‡å…¥åˆ°Javaç±»ä¸­ï¼›è€Œç±»åŠ è½½æœŸç»‡å…¥åˆ™æŒ‡é€šè¿‡ç‰¹æ®Šçš„ç±»åŠ è½½å™¨ï¼Œåœ¨ç±»å­—èŠ‚ç åŠ è½½åˆ°JVMæ—¶ï¼Œç»‡å…¥åˆ‡é¢ï¼›è¿è¡ŒæœŸç»‡å…¥åˆ™æ˜¯é‡‡ç”¨CGLibå·¥å…·æˆ–JDKåŠ¨æ€ä»£ç†è¿›è¡Œåˆ‡é¢çš„ç»‡å…¥ã€‚</p></blockquote><h3 id="3-1-JavaåŠ¨æ€ä»£ç†ç±»"><a href="#3-1-JavaåŠ¨æ€ä»£ç†ç±»" class="headerlink" title="3.1 JavaåŠ¨æ€ä»£ç†ç±»"></a>3.1 JavaåŠ¨æ€ä»£ç†ç±»</h3><p><a href="https://github.com/zhongyp/demo/tree/master/src/main/java/com/zhongyp/advanced/proxy" target="_blank" rel="noopener">ä»£ç ç¤ºä¾‹</a>ğŸ‘ˆğŸ»ğŸ‘ˆğŸ»ğŸ‘ˆğŸ»</p><p>Javaé€šè¿‡<code>Proxy</code>ç±»å’Œ<code>InvocationHandler</code>æ¥å£ç”ŸæˆåŠ¨æ€ä»£ç†ç±»<code>$Proxy0</code>ã€‚</p><p><img src="/media/article/java-proxy.001.png" alt="java-proxy"></p><p>ç”Ÿæˆçš„<code>$Proxy0</code>ä»£ç†ç±»ï¼Œè¿™ä¸ªä»£ç†ç±»å®ç°äº†äº†æ‰€æœ‰çš„æ¥å£(å‚æ•°æ¥å£ç±»æ•°ç»„ä¸­çš„æ‰€æœ‰æ¥å£):</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">//</span><br><span class="line">// Source code recreated from a .class file by IntelliJ IDEA</span><br><span class="line">// (powered by Fernflower decompiler)</span><br><span class="line">//</span><br><span class="line"></span><br><span class="line">package com.zhongyp.advanced.proxy;</span><br><span class="line"></span><br><span class="line">import java.lang.reflect.InvocationHandler;</span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line">import java.lang.reflect.Proxy;</span><br><span class="line">import java.lang.reflect.UndeclaredThrowableException;</span><br><span class="line"></span><br><span class="line">final class $Proxy0 extends Proxy implements TestService, TestService1 &#123;</span><br><span class="line">    private static Method m1;</span><br><span class="line">    private static Method m3;</span><br><span class="line">    private static Method m4;</span><br><span class="line">    private static Method m6;</span><br><span class="line">    private static Method m2;</span><br><span class="line">    private static Method m5;</span><br><span class="line">    private static Method m0;</span><br><span class="line"></span><br><span class="line">    public $Proxy0(InvocationHandler var1) throws  &#123;</span><br><span class="line">        super(var1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public final boolean equals(Object var1) throws  &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            return (Boolean)super.h.invoke(this, m1, new Object[]&#123;var1&#125;);</span><br><span class="line">        &#125; catch (RuntimeException | Error var3) &#123;</span><br><span class="line">            throw var3;</span><br><span class="line">        &#125; catch (Throwable var4) &#123;</span><br><span class="line">            throw new UndeclaredThrowableException(var4);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public final void test() throws  &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            super.h.invoke(this, m3, (Object[])null);</span><br><span class="line">        &#125; catch (RuntimeException | Error var2) &#123;</span><br><span class="line">            throw var2;</span><br><span class="line">        &#125; catch (Throwable var3) &#123;</span><br><span class="line">            throw new UndeclaredThrowableException(var3);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public final void test3() throws  &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            super.h.invoke(this, m4, (Object[])null);</span><br><span class="line">        &#125; catch (RuntimeException | Error var2) &#123;</span><br><span class="line">            throw var2;</span><br><span class="line">        &#125; catch (Throwable var3) &#123;</span><br><span class="line">            throw new UndeclaredThrowableException(var3);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public final void test4() throws  &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            super.h.invoke(this, m6, (Object[])null);</span><br><span class="line">        &#125; catch (RuntimeException | Error var2) &#123;</span><br><span class="line">            throw var2;</span><br><span class="line">        &#125; catch (Throwable var3) &#123;</span><br><span class="line">            throw new UndeclaredThrowableException(var3);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public final String toString() throws  &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            return (String)super.h.invoke(this, m2, (Object[])null);</span><br><span class="line">        &#125; catch (RuntimeException | Error var2) &#123;</span><br><span class="line">            throw var2;</span><br><span class="line">        &#125; catch (Throwable var3) &#123;</span><br><span class="line">            throw new UndeclaredThrowableException(var3);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public final void test1() throws  &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            super.h.invoke(this, m5, (Object[])null);</span><br><span class="line">        &#125; catch (RuntimeException | Error var2) &#123;</span><br><span class="line">            throw var2;</span><br><span class="line">        &#125; catch (Throwable var3) &#123;</span><br><span class="line">            throw new UndeclaredThrowableException(var3);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public final int hashCode() throws  &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            return (Integer)super.h.invoke(this, m0, (Object[])null);</span><br><span class="line">        &#125; catch (RuntimeException | Error var2) &#123;</span><br><span class="line">            throw var2;</span><br><span class="line">        &#125; catch (Throwable var3) &#123;</span><br><span class="line">            throw new UndeclaredThrowableException(var3);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            m1 = Class.forName(&quot;java.lang.Object&quot;).getMethod(&quot;equals&quot;, Class.forName(&quot;java.lang.Object&quot;));</span><br><span class="line">            m3 = Class.forName(&quot;com.zhongyp.advanced.proxy.TestService&quot;).getMethod(&quot;test&quot;);</span><br><span class="line">            m4 = Class.forName(&quot;com.zhongyp.advanced.proxy.TestService&quot;).getMethod(&quot;test3&quot;);</span><br><span class="line">            m6 = Class.forName(&quot;com.zhongyp.advanced.proxy.TestService1&quot;).getMethod(&quot;test4&quot;);</span><br><span class="line">            m2 = Class.forName(&quot;java.lang.Object&quot;).getMethod(&quot;toString&quot;);</span><br><span class="line">            m5 = Class.forName(&quot;com.zhongyp.advanced.proxy.TestService1&quot;).getMethod(&quot;test1&quot;);</span><br><span class="line">            m0 = Class.forName(&quot;java.lang.Object&quot;).getMethod(&quot;hashCode&quot;);</span><br><span class="line">        &#125; catch (NoSuchMethodException var2) &#123;</span><br><span class="line">            throw new NoSuchMethodError(var2.getMessage());</span><br><span class="line">        &#125; catch (ClassNotFoundException var3) &#123;</span><br><span class="line">            throw new NoClassDefFoundError(var3.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-1-1-JavaåŠ¨æ€ä»£ç†æºç è§£æ"><a href="#3-1-1-JavaåŠ¨æ€ä»£ç†æºç è§£æ" class="headerlink" title="3.1.1 JavaåŠ¨æ€ä»£ç†æºç è§£æ"></a>3.1.1 JavaåŠ¨æ€ä»£ç†æºç è§£æ</h4><blockquote><p>Classå¯¹è±¡æ¯ä¸ªç±»åªæœ‰ä¸€ä¸ªï¼ˆåŒä¸€ä¸ªç±»åŠ è½½å™¨çš„æƒ…å†µä¸‹ï¼‰ï¼Œè¯¥Classå¯¹è±¡åœ¨ç±»åŠ è½½é˜¶æ®µç”Ÿæˆï¼Œå­˜å‚¨åœ¨å†…å­˜ä¸­ï¼ŒéJavaè™šæ‹Ÿæœºå †ï¼Œæ˜¯è¯¥ç±»å¯¹å¤–è®¿é—®çš„å”¯ä¸€å…¥å£ã€‚<a href="https://docs.oracle.com/javase/specs/jls/se9/html/jls-12.html#jls-12.4" target="_blank" rel="noopener">Java Language Specification 12.4</a></p></blockquote><p>Javaç”ŸæˆåŠ¨æ€ä»£ç†ç±»çš„æ ¸å¿ƒæ–¹æ³•æ˜¯ï¼šProxyClassFactoryçš„<code>Class&lt;?&gt; apply(ClassLoader loader, Class&lt;?&gt;[] interfaces)</code>ã€‚</p><p>æˆ‘ä»¬å…ˆä»æ–¹æ³•å‚æ•°å¼€å§‹ï¼Œ<code>ClassLoader loader</code>æ¥å£ç±»åŠ è½½å™¨ï¼Œ<code>Class&lt;?&gt;[] interfaces</code>æ¥å£ç±»çš„Classã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">// éå†æ¥å£ç±»çš„Classæ•°ç»„</span><br><span class="line">  for (Class&lt;?&gt; intf : interfaces) &#123;</span><br><span class="line">      </span><br><span class="line">      Class&lt;?&gt; interfaceClass = null;</span><br><span class="line">      try &#123;</span><br><span class="line">          // åå°„è·å¾—æ¥å£ç±»Classå¯¹è±¡</span><br><span class="line">          interfaceClass = Class.forName(intf.getName(), false, loader);</span><br><span class="line">      &#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">      </span><br><span class="line">      &#125;</span><br><span class="line">      // æ ¡éªŒæ˜¯å¦æ˜¯åŒä¸€ä¸ªç±»åŠ è½½å™¨ï¼Œå¦‚æœæ˜¯ä¸åŒçš„ç±»åŠ è½½å™¨ï¼Œç”Ÿæˆçš„æ¥å£Classå¯¹è±¡æ˜¯ä¸åŒçš„</span><br><span class="line">      if (interfaceClass != intf) &#123;</span><br><span class="line">          throw new IllegalArgumentException(</span><br><span class="line">              intf + &quot; is not visible from class loader&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">      // JavaåŠ¨æ€ä»£ç†ä»…æ”¯æŒæ¥å£ä»£ç†</span><br><span class="line">      if (!interfaceClass.isInterface()) &#123;</span><br><span class="line">          throw new IllegalArgumentException(</span><br><span class="line">              interfaceClass.getName() + &quot; is not an interface&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">      // ä½¿ç”¨Setæ¥éªŒè¯ä¼ å…¥çš„æ¥å£æ•°ç»„ä¸­æ˜¯å¦å­˜åœ¨ç›¸åŒçš„æ¥å£</span><br><span class="line">      if (interfaceSet.put(interfaceClass, Boolean.TRUE) != null) &#123;</span><br><span class="line">          throw new IllegalArgumentException(</span><br><span class="line">              &quot;repeated interface: &quot; + interfaceClass.getName());</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p><p>ä¸‹é¢è¿™ä¹ˆå¤šä»£ç æ˜¯ä¸ºäº†ç»™ä¸‹é¢ç”Ÿæˆçš„ä»£ç†ç±»æ‰¾åˆ°ä¸€ä¸ªåˆç†çš„åŒ…åå’Œç±»åï¼Œå¦‚æœæ¥å£æ•°ç»„ä¸­æœ‰épublicå±æ€§çš„æ¥å£ï¼Œå¦‚æœæ­¤æ¥å£çš„åŒ…åä¸ä¸ºnullï¼Œåˆ™ä½¿ç”¨è¿™ä¸ªæ¥å£çš„åŒ…åï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤çš„<code>com.sun.proxy</code>åŒ…åï¼Œç±»ååˆ™æ˜¯ä¸Šè¿°â€œåŒ…å+$Proxy+è‡ªå¢æ•°å­—â€ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">String proxyPkg = null;     </span><br><span class="line">int accessFlags = Modifier.PUBLIC | Modifier.FINAL;</span><br><span class="line">for (Class&lt;?&gt; intf : interfaces) &#123;</span><br><span class="line">    int flags = intf.getModifiers();</span><br><span class="line">    if (!Modifier.isPublic(flags)) &#123;</span><br><span class="line">        accessFlags = Modifier.FINAL;</span><br><span class="line">        String name = intf.getName();</span><br><span class="line">        int n = name.lastIndexOf(&apos;.&apos;);</span><br><span class="line">        String pkg = ((n == -1) ? &quot;&quot; : name.substring(0, n + 1));</span><br><span class="line">        if (proxyPkg == null) &#123;</span><br><span class="line">            proxyPkg = pkg;</span><br><span class="line">        &#125; else if (!pkg.equals(proxyPkg)) &#123;</span><br><span class="line">            throw new IllegalArgumentException(</span><br><span class="line">                &quot;non-public interfaces from different packages&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (proxyPkg == null) &#123;</span><br><span class="line">    // if no non-public proxy interfaces, use com.sun.proxy package</span><br><span class="line">    proxyPkg = ReflectUtil.PROXY_PACKAGE + &quot;.&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// ä½¿ç”¨è‡ªå¢æ•°å­—åŒºåˆ†ä¸åŒçš„ç±»</span><br><span class="line">long num = nextUniqueNumber.getAndIncrement();</span><br><span class="line">String proxyName = proxyPkg + proxyClassNamePrefix + num;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢å°±æ˜¯æ•´ä¸ªåŠ¨æ€ä»£ç†æœ€æ ¸å¿ƒçš„ä»£ç ã€‚ç”Ÿæˆä»£ç†ç±»classæ–‡ä»¶çš„å­—èŠ‚ç ï¼Œæ ¹æ®è¿™ä¸ªæ–‡ä»¶çš„å­—èŠ‚ç ç”Ÿæˆä»£ç†ç±»çš„Classå¯¹è±¡ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// ç”Ÿæˆå­—èŠ‚æ•°ç»„ï¼Œè¿™ä¸ªå­—èŠ‚æ•°ç»„æ˜¯ç”Ÿæˆçš„Classæ–‡ä»¶çš„å­—èŠ‚æ•°ç»„ï¼Œå°†è¿™ä¸ªå­—èŠ‚æµè¾“å‡ºåˆ°classæ–‡ä»¶ï¼Œå°±æ˜¯ä¸Šé¢çš„$Proxy0ä»£ç†ç±»ã€‚  </span><br><span class="line">byte[] proxyClassFile = ProxyGenerator.generateProxyClass(</span><br><span class="line"> proxyName, interfaces, accessFlags);</span><br><span class="line">try &#123;</span><br><span class="line"> // é€šè¿‡åˆšæ‰ç”Ÿæˆçš„ä»£ç†ç±»æ–‡ä»¶ï¼Œç”Ÿæˆä»£ç†ç±»çš„Classå¯¹è±¡ã€‚</span><br><span class="line"> return defineClass0(loader, proxyName,</span><br><span class="line">                     proxyClassFile, 0, proxyClassFile.length);</span><br><span class="line">&#125; catch (ClassFormatError e) &#123;</span><br><span class="line"> throw new IllegalArgumentException(e.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¼˜ç‚¹ï¼š</p><ul><li>æœ€å°åŒ–ä¾èµ–å…³ç³»ï¼Œå‡å°‘ä¾èµ–æ„å‘³ç€ç®€åŒ–å¼€å‘å’Œç»´æŠ¤ï¼ŒJDKæœ¬èº«çš„æ”¯æŒï¼Œå¯èƒ½æ¯”cglibæ›´åŠ å¯é ã€‚</li><li>å¹³æ»‘è¿›è¡ŒJDKç‰ˆæœ¬å‡çº§ï¼Œè€Œå­—èŠ‚ç ç±»åº“é€šå¸¸éœ€è¦è¿›è¡Œæ›´æ–°æ¥ä¿è¯åœ¨æ–°ç‰ˆJavaä¸Šèƒ½å¤Ÿä½¿ç”¨ã€‚</li><li>ä»£ç å®ç°ç®€å•ã€‚</li><li>å¦‚æœä»…ä»…åœ¨åŒä¸€ä¸ªç±»åŠ è½½å™¨ä¸‹å¯¹ä¸€ä¸ªç±»åšå¤šæ¬¡åˆ›å»ºä»£ç†æ“ä½œï¼ŒJavaåŠ¨æ€ä»£ç†å¿«äºCglibã€‚</li></ul><h3 id="3-1-2-CglibåŠ¨æ€ä»£ç†"><a href="#3-1-2-CglibåŠ¨æ€ä»£ç†" class="headerlink" title="3.1.2 CglibåŠ¨æ€ä»£ç†"></a>3.1.2 CglibåŠ¨æ€ä»£ç†</h3><p>ä¸‹å›¾æ˜¯cglibåŠ¨æ€ä»£ç†ç”Ÿæˆä»£ç†ç±»å®ä¾‹çš„ä»£ç å¤§è‡´æµç¨‹ï¼š<br><img src="/media/article/cglib-processor.png" alt="cglib-processor"></p><blockquote><p><strong>TIPS</strong><br>åœ¨åŒä¸€ä¸ªç±»åŠ è½½å™¨ä¸‹ç”ŸæˆåŒä¸€ä¸ªåŠ¨æ€ä»£ç†ç±»çš„æ€§èƒ½æ¯”è¾ƒåˆ†æã€‚<br>cglibç”Ÿæˆ1wæ¬¡å¤§æ¦‚æ˜¯220msã€‚JDKåŠ¨æ€ä»£ç†1wæ¬¡å¤§æ¦‚æ˜¯110msã€‚<br>cglibç”Ÿæˆ10wæ¬¡å¤§æ¦‚æ˜¯520msã€‚JDKåŠ¨æ€ä»£ç†10wæ¬¡å¤§æ¦‚æ˜¯520msã€‚<br>cglibç”Ÿæˆ100wæ¬¡å¤§æ¦‚æ˜¯3290msã€‚JDKåŠ¨æ€ä»£ç†100wæ¬¡å¤§æ¦‚æ˜¯3610msã€‚</p></blockquote><p>ç¤ºä¾‹ä»£ç ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">long start = System.currentTimeMillis();</span><br><span class="line">for (int i = 0; i &lt; 10000 ; i++) &#123;</span><br><span class="line">    TestServiceImpl testService = new TestServiceImpl();</span><br><span class="line">    // å£°æ˜è‡ªå·±çš„å¤„ç†ç±»</span><br><span class="line">    MyInvokeHandler myInvokeHandler = new MyInvokeHandler(testService);</span><br><span class="line">    // ç¬¬ä¸€æ¬¡ç”Ÿæˆä»£ç†ç±»</span><br><span class="line">    TestService proxy = (TestService)     Proxy.newProxyInstance(TestService.class.getClassLoader(),new Class[]&#123;TestService.class, TestService1.class&#125;,myInvokeHandler);</span><br><span class="line">    // ç¬¬äºŒæ¬¡ç”Ÿæˆä»£ç†ç±»ï¼Œç¬¬äºŒæ¬¡ç”Ÿæˆçš„ä»£ç†ç±»ä»weakCacheä¸­ç›´æ¥è·å–ï¼Œä¸å†é‡æ–°ç”Ÿæˆ</span><br><span class="line">    // ä»£ç†ç±»è°ƒç”¨æ¥å£æ–¹æ³•</span><br><span class="line">    proxy.test();</span><br><span class="line">&#125;</span><br><span class="line">System.out.println(System.currentTimeMillis()-start);</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">long start = System.currentTimeMillis();</span><br><span class="line">Enhancer enhancer = new Enhancer();</span><br><span class="line">LogInterceptor logInterceptor = new LogInterceptor();</span><br><span class="line">for (int i = 0; i &lt; 10000; i++) &#123;</span><br><span class="line">  // è®¾ç½®è¶…ç±»ï¼Œcglibæ˜¯é€šè¿‡ç»§æ‰¿æ¥å®ç°çš„</span><br><span class="line">  enhancer.setSuperclass(UserDao.class);</span><br><span class="line">  enhancer.setCallback(logInterceptor);</span><br><span class="line">  // åˆ›å»ºä»£ç†ç±»</span><br><span class="line">  Dao dao = (Dao)enhancer.create();</span><br><span class="line">  dao.select();</span><br><span class="line">&#125;</span><br><span class="line">System.out.println(System.currentTimeMillis()-start);</span><br></pre></td></tr></table></figure><p>cglibåŠ¨æ€ä»£ç†åŸºäºASMæŠ€æœ¯ï¼Œä½¿ç”¨ASMæŠ€æœ¯çš„éƒ¨åˆ†å°±æ˜¯å›¾ä¸­æ ‡çº¢çš„æ¨¡å—ã€‚</p><blockquote><p><strong><a href="https://asm.ow2.io/" target="_blank" rel="noopener">ASM</a>æŠ€æœ¯æ˜¯ä¸ªå•¥ï¼Ÿ</strong><br>ASM æ˜¯ä¸€ä¸ª Java å­—èŠ‚ç æ“æ§æ¡†æ¶ã€‚å®ƒèƒ½å¤Ÿä»¥äºŒè¿›åˆ¶å½¢å¼ä¿®æ”¹å·²æœ‰ç±»æˆ–è€…åŠ¨æ€ç”Ÿæˆç±»ã€‚ASM å¯ä»¥ç›´æ¥äº§ç”ŸäºŒè¿›åˆ¶ class æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥åœ¨ç±»è¢«åŠ è½½å…¥ Java è™šæ‹Ÿæœºä¹‹å‰åŠ¨æ€æ”¹å˜ç±»è¡Œä¸ºã€‚ASM ä»ç±»æ–‡ä»¶ä¸­è¯»å…¥ä¿¡æ¯åï¼Œèƒ½å¤Ÿæ”¹å˜ç±»è¡Œä¸ºï¼Œåˆ†æç±»ä¿¡æ¯ï¼Œç”šè‡³èƒ½å¤Ÿæ ¹æ®ç”¨æˆ·è¦æ±‚ç”Ÿæˆæ–°ç±»ã€‚<br>ASMæ˜¯ä¸€ä¸ªé€šç”¨çš„Javaå­—èŠ‚ç æ“ä½œå’Œåˆ†ææ¡†æ¶ã€‚å®ƒå¯ä»¥ç›´æ¥ä»¥äºŒè¿›åˆ¶å½¢å¼ç”¨äºä¿®æ”¹ç°æœ‰ç±»æˆ–åŠ¨æ€ç”Ÿæˆç±»ã€‚ ASMæä¾›äº†ä¸€äº›å¸¸è§çš„å­—èŠ‚ç è½¬æ¢å’Œåˆ†æç®—æ³•ï¼Œå¯ä»¥ä»ä¸­æ„å»ºå®šåˆ¶çš„å¤æ‚è½¬æ¢å’Œä»£ç åˆ†æå·¥å…·ã€‚ ASMæä¾›ä¸å…¶ä»–Javaå­—èŠ‚ç æ¡†æ¶ç±»ä¼¼çš„åŠŸèƒ½ï¼Œä½†ä¾§é‡äºæ€§èƒ½ã€‚å› ä¸ºå®ƒçš„è®¾è®¡å’Œå®ç°æ˜¯å°½å¯èƒ½çš„å°å’Œå°½å¯èƒ½å¿«ï¼Œæ‰€ä»¥å®ƒéå¸¸é€‚åˆåœ¨åŠ¨æ€ç³»ç»Ÿä¸­ä½¿ç”¨ï¼ˆä½†å½“ç„¶ä¹Ÿå¯ä»¥ä»¥é™æ€æ–¹å¼ä½¿ç”¨ï¼Œä¾‹å¦‚åœ¨ç¼–è¯‘å™¨ä¸­ä½¿ç”¨ï¼‰ã€‚<br>ASMåº”ç”¨å¹¿æ³›ï¼šOpenJDK lambda call sitesï¼Œ<a href="http://hg.openjdk.java.net/jdk8/jdk8/nashorn/file/096dc407d310/src/jdk/nashorn/internal/codegen/ClassEmitter.java" target="_blank" rel="noopener">Nashorn compiler</a><br>CGLIBï¼Œä»¥åŠ¨æ€ç”Ÿæˆä»£ç†ç±»ï¼ˆç”¨äºå…¶ä»–é¡¹ç›®ï¼Œä¾‹å¦‚Mockitoå’ŒEasyMockï¼‰ï¼ŒGradleï¼Œåœ¨è¿è¡Œæ—¶ç”Ÿæˆä¸€äº›ç±»ã€‚</p></blockquote><p>ä¼˜ç‚¹ï¼š</p><ul><li>æœ‰çš„æ—¶å€™è°ƒç”¨ç›®æ ‡å¯èƒ½ä¸ä¾¿å®ç°é¢å¤–æ¥å£ï¼Œä»æŸç§è§’åº¦çœ‹ï¼Œé™å®šè°ƒç”¨è€…å®ç°æ¥å£æ˜¯æœ‰äº›ä¾µå…¥æ€§çš„å®è·µï¼Œç±»ä¼¼cglibåŠ¨æ€ä»£ç†å°±æ²¡æœ‰è¿™ç§é™åˆ¶ã€‚</li><li>åªæ“ä½œæˆ‘ä»¬å…³å¿ƒçš„ç±»ï¼Œä¸å¿…ä¸ºå…¶ä»–ç›¸å…³ç±»å¢åŠ å·¥ä½œé‡ã€‚</li><li>é«˜æ€§èƒ½ã€‚</li></ul><p>ç”Ÿæˆçš„ä»£ç†ç±»ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br></pre></td><td class="code"><pre><span class="line">//</span><br><span class="line">// Source code recreated from a .class file by IntelliJ IDEA</span><br><span class="line">// (powered by Fernflower decompiler)</span><br><span class="line">//</span><br><span class="line"></span><br><span class="line">package com.zhongyp.advanced.proxy.cglib;</span><br><span class="line"></span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line">import org.springframework.cglib.core.ReflectUtils;</span><br><span class="line">import org.springframework.cglib.core.Signature;</span><br><span class="line">import org.springframework.cglib.proxy.Callback;</span><br><span class="line">import org.springframework.cglib.proxy.Factory;</span><br><span class="line">import org.springframework.cglib.proxy.MethodInterceptor;</span><br><span class="line">import org.springframework.cglib.proxy.MethodProxy;</span><br><span class="line"></span><br><span class="line">public class UserDao$$EnhancerByCGLIB$$c00e2e9b extends UserDao implements Factory &#123;</span><br><span class="line">    private boolean CGLIB$BOUND;</span><br><span class="line">    public static Object CGLIB$FACTORY_DATA;</span><br><span class="line">    private static final ThreadLocal CGLIB$THREAD_CALLBACKS;</span><br><span class="line">    private static final Callback[] CGLIB$STATIC_CALLBACKS;</span><br><span class="line">    private MethodInterceptor CGLIB$CALLBACK_0;</span><br><span class="line">    private static Object CGLIB$CALLBACK_FILTER;</span><br><span class="line">    private static final Method CGLIB$update$0$Method;</span><br><span class="line">    private static final MethodProxy CGLIB$update$0$Proxy;</span><br><span class="line">    private static final Object[] CGLIB$emptyArgs;</span><br><span class="line">    private static final Method CGLIB$select$1$Method;</span><br><span class="line">    private static final MethodProxy CGLIB$select$1$Proxy;</span><br><span class="line">    private static final Method CGLIB$equals$2$Method;</span><br><span class="line">    private static final MethodProxy CGLIB$equals$2$Proxy;</span><br><span class="line">    private static final Method CGLIB$toString$3$Method;</span><br><span class="line">    private static final MethodProxy CGLIB$toString$3$Proxy;</span><br><span class="line">    private static final Method CGLIB$hashCode$4$Method;</span><br><span class="line">    private static final MethodProxy CGLIB$hashCode$4$Proxy;</span><br><span class="line">    private static final Method CGLIB$clone$5$Method;</span><br><span class="line">    private static final MethodProxy CGLIB$clone$5$Proxy;</span><br><span class="line"></span><br><span class="line">    static void CGLIB$STATICHOOK1() &#123;</span><br><span class="line">        CGLIB$THREAD_CALLBACKS = new ThreadLocal();</span><br><span class="line">        CGLIB$emptyArgs = new Object[0];</span><br><span class="line">        Class var0 = Class.forName(&quot;com.zhongyp.advanced.proxy.cglib.UserDao$$EnhancerByCGLIB$$c00e2e9b&quot;);</span><br><span class="line">        Class var1;</span><br><span class="line">        Method[] var10000 = ReflectUtils.findMethods(new String[]&#123;&quot;update&quot;, &quot;()V&quot;, &quot;select&quot;, &quot;()V&quot;&#125;, (var1 = Class.forName(&quot;com.zhongyp.advanced.proxy.cglib.UserDao&quot;)).getDeclaredMethods());</span><br><span class="line">        CGLIB$update$0$Method = var10000[0];</span><br><span class="line">        CGLIB$update$0$Proxy = MethodProxy.create(var1, var0, &quot;()V&quot;, &quot;update&quot;, &quot;CGLIB$update$0&quot;);</span><br><span class="line">        CGLIB$select$1$Method = var10000[1];</span><br><span class="line">        CGLIB$select$1$Proxy = MethodProxy.create(var1, var0, &quot;()V&quot;, &quot;select&quot;, &quot;CGLIB$select$1&quot;);</span><br><span class="line">        var10000 = ReflectUtils.findMethods(new String[]&#123;&quot;equals&quot;, &quot;(Ljava/lang/Object;)Z&quot;, &quot;toString&quot;, &quot;()Ljava/lang/String;&quot;, &quot;hashCode&quot;, &quot;()I&quot;, &quot;clone&quot;, &quot;()Ljava/lang/Object;&quot;&#125;, (var1 = Class.forName(&quot;java.lang.Object&quot;)).getDeclaredMethods());</span><br><span class="line">        CGLIB$equals$2$Method = var10000[0];</span><br><span class="line">        CGLIB$equals$2$Proxy = MethodProxy.create(var1, var0, &quot;(Ljava/lang/Object;)Z&quot;, &quot;equals&quot;, &quot;CGLIB$equals$2&quot;);</span><br><span class="line">        CGLIB$toString$3$Method = var10000[1];</span><br><span class="line">        CGLIB$toString$3$Proxy = MethodProxy.create(var1, var0, &quot;()Ljava/lang/String;&quot;, &quot;toString&quot;, &quot;CGLIB$toString$3&quot;);</span><br><span class="line">        CGLIB$hashCode$4$Method = var10000[2];</span><br><span class="line">        CGLIB$hashCode$4$Proxy = MethodProxy.create(var1, var0, &quot;()I&quot;, &quot;hashCode&quot;, &quot;CGLIB$hashCode$4&quot;);</span><br><span class="line">        CGLIB$clone$5$Method = var10000[3];</span><br><span class="line">        CGLIB$clone$5$Proxy = MethodProxy.create(var1, var0, &quot;()Ljava/lang/Object;&quot;, &quot;clone&quot;, &quot;CGLIB$clone$5&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    final void CGLIB$update$0() &#123;</span><br><span class="line">        super.update();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public final void update() &#123;</span><br><span class="line">        MethodInterceptor var10000 = this.CGLIB$CALLBACK_0;</span><br><span class="line">        if (this.CGLIB$CALLBACK_0 == null) &#123;</span><br><span class="line">            CGLIB$BIND_CALLBACKS(this);</span><br><span class="line">            var10000 = this.CGLIB$CALLBACK_0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (var10000 != null) &#123;</span><br><span class="line">            var10000.intercept(this, CGLIB$update$0$Method, CGLIB$emptyArgs, CGLIB$update$0$Proxy);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            super.update();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    final void CGLIB$select$1() &#123;</span><br><span class="line">        super.select();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public final void select() &#123;</span><br><span class="line">        MethodInterceptor var10000 = this.CGLIB$CALLBACK_0;</span><br><span class="line">        if (this.CGLIB$CALLBACK_0 == null) &#123;</span><br><span class="line">            CGLIB$BIND_CALLBACKS(this);</span><br><span class="line">            var10000 = this.CGLIB$CALLBACK_0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (var10000 != null) &#123;</span><br><span class="line">            var10000.intercept(this, CGLIB$select$1$Method, CGLIB$emptyArgs, CGLIB$select$1$Proxy);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            super.select();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    final boolean CGLIB$equals$2(Object var1) &#123;</span><br><span class="line">        return super.equals(var1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public final boolean equals(Object var1) &#123;</span><br><span class="line">        MethodInterceptor var10000 = this.CGLIB$CALLBACK_0;</span><br><span class="line">        if (this.CGLIB$CALLBACK_0 == null) &#123;</span><br><span class="line">            CGLIB$BIND_CALLBACKS(this);</span><br><span class="line">            var10000 = this.CGLIB$CALLBACK_0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (var10000 != null) &#123;</span><br><span class="line">            Object var2 = var10000.intercept(this, CGLIB$equals$2$Method, new Object[]&#123;var1&#125;, CGLIB$equals$2$Proxy);</span><br><span class="line">            return var2 == null ? false : (Boolean)var2;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return super.equals(var1);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    final String CGLIB$toString$3() &#123;</span><br><span class="line">        return super.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public final String toString() &#123;</span><br><span class="line">        MethodInterceptor var10000 = this.CGLIB$CALLBACK_0;</span><br><span class="line">        if (this.CGLIB$CALLBACK_0 == null) &#123;</span><br><span class="line">            CGLIB$BIND_CALLBACKS(this);</span><br><span class="line">            var10000 = this.CGLIB$CALLBACK_0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return var10000 != null ? (String)var10000.intercept(this, CGLIB$toString$3$Method, CGLIB$emptyArgs, CGLIB$toString$3$Proxy) : super.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    final int CGLIB$hashCode$4() &#123;</span><br><span class="line">        return super.hashCode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public final int hashCode() &#123;</span><br><span class="line">        MethodInterceptor var10000 = this.CGLIB$CALLBACK_0;</span><br><span class="line">        if (this.CGLIB$CALLBACK_0 == null) &#123;</span><br><span class="line">            CGLIB$BIND_CALLBACKS(this);</span><br><span class="line">            var10000 = this.CGLIB$CALLBACK_0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (var10000 != null) &#123;</span><br><span class="line">            Object var1 = var10000.intercept(this, CGLIB$hashCode$4$Method, CGLIB$emptyArgs, CGLIB$hashCode$4$Proxy);</span><br><span class="line">            return var1 == null ? 0 : ((Number)var1).intValue();</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return super.hashCode();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    final Object CGLIB$clone$5() throws CloneNotSupportedException &#123;</span><br><span class="line">        return super.clone();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected final Object clone() throws CloneNotSupportedException &#123;</span><br><span class="line">        MethodInterceptor var10000 = this.CGLIB$CALLBACK_0;</span><br><span class="line">        if (this.CGLIB$CALLBACK_0 == null) &#123;</span><br><span class="line">            CGLIB$BIND_CALLBACKS(this);</span><br><span class="line">            var10000 = this.CGLIB$CALLBACK_0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return var10000 != null ? var10000.intercept(this, CGLIB$clone$5$Method, CGLIB$emptyArgs, CGLIB$clone$5$Proxy) : super.clone();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static MethodProxy CGLIB$findMethodProxy(Signature var0) &#123;</span><br><span class="line">        String var10000 = var0.toString();</span><br><span class="line">        switch(var10000.hashCode()) &#123;</span><br><span class="line">        case -1949253108:</span><br><span class="line">            if (var10000.equals(&quot;update()V&quot;)) &#123;</span><br><span class="line">                return CGLIB$update$0$Proxy;</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">        case -1716030215:</span><br><span class="line">            if (var10000.equals(&quot;select()V&quot;)) &#123;</span><br><span class="line">                return CGLIB$select$1$Proxy;</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">        case -508378822:</span><br><span class="line">            if (var10000.equals(&quot;clone()Ljava/lang/Object;&quot;)) &#123;</span><br><span class="line">                return CGLIB$clone$5$Proxy;</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">        case 1826985398:</span><br><span class="line">            if (var10000.equals(&quot;equals(Ljava/lang/Object;)Z&quot;)) &#123;</span><br><span class="line">                return CGLIB$equals$2$Proxy;</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">        case 1913648695:</span><br><span class="line">            if (var10000.equals(&quot;toString()Ljava/lang/String;&quot;)) &#123;</span><br><span class="line">                return CGLIB$toString$3$Proxy;</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">        case 1984935277:</span><br><span class="line">            if (var10000.equals(&quot;hashCode()I&quot;)) &#123;</span><br><span class="line">                return CGLIB$hashCode$4$Proxy;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public UserDao$$EnhancerByCGLIB$$c00e2e9b() &#123;</span><br><span class="line">        CGLIB$BIND_CALLBACKS(this);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void CGLIB$SET_THREAD_CALLBACKS(Callback[] var0) &#123;</span><br><span class="line">        CGLIB$THREAD_CALLBACKS.set(var0);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void CGLIB$SET_STATIC_CALLBACKS(Callback[] var0) &#123;</span><br><span class="line">        CGLIB$STATIC_CALLBACKS = var0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static final void CGLIB$BIND_CALLBACKS(Object var0) &#123;</span><br><span class="line">        UserDao$$EnhancerByCGLIB$$c00e2e9b var1 = (UserDao$$EnhancerByCGLIB$$c00e2e9b)var0;</span><br><span class="line">        if (!var1.CGLIB$BOUND) &#123;</span><br><span class="line">            var1.CGLIB$BOUND = true;</span><br><span class="line">            Object var10000 = CGLIB$THREAD_CALLBACKS.get();</span><br><span class="line">            if (var10000 == null) &#123;</span><br><span class="line">                var10000 = CGLIB$STATIC_CALLBACKS;</span><br><span class="line">                if (CGLIB$STATIC_CALLBACKS == null) &#123;</span><br><span class="line">                    return;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            var1.CGLIB$CALLBACK_0 = (MethodInterceptor)((Callback[])var10000)[0];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Object newInstance(Callback[] var1) &#123;</span><br><span class="line">        CGLIB$SET_THREAD_CALLBACKS(var1);</span><br><span class="line">        UserDao$$EnhancerByCGLIB$$c00e2e9b var10000 = new UserDao$$EnhancerByCGLIB$$c00e2e9b();</span><br><span class="line">        CGLIB$SET_THREAD_CALLBACKS((Callback[])null);</span><br><span class="line">        return var10000;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Object newInstance(Callback var1) &#123;</span><br><span class="line">        CGLIB$SET_THREAD_CALLBACKS(new Callback[]&#123;var1&#125;);</span><br><span class="line">        UserDao$$EnhancerByCGLIB$$c00e2e9b var10000 = new UserDao$$EnhancerByCGLIB$$c00e2e9b();</span><br><span class="line">        CGLIB$SET_THREAD_CALLBACKS((Callback[])null);</span><br><span class="line">        return var10000;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Object newInstance(Class[] var1, Object[] var2, Callback[] var3) &#123;</span><br><span class="line">        CGLIB$SET_THREAD_CALLBACKS(var3);</span><br><span class="line">        UserDao$$EnhancerByCGLIB$$c00e2e9b var10000 = new UserDao$$EnhancerByCGLIB$$c00e2e9b;</span><br><span class="line">        switch(var1.length) &#123;</span><br><span class="line">        case 0:</span><br><span class="line">            var10000.&lt;init&gt;();</span><br><span class="line">            CGLIB$SET_THREAD_CALLBACKS((Callback[])null);</span><br><span class="line">            return var10000;</span><br><span class="line">        default:</span><br><span class="line">            throw new IllegalArgumentException(&quot;Constructor not found&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Callback getCallback(int var1) &#123;</span><br><span class="line">        CGLIB$BIND_CALLBACKS(this);</span><br><span class="line">        MethodInterceptor var10000;</span><br><span class="line">        switch(var1) &#123;</span><br><span class="line">        case 0:</span><br><span class="line">            var10000 = this.CGLIB$CALLBACK_0;</span><br><span class="line">            break;</span><br><span class="line">        default:</span><br><span class="line">            var10000 = null;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return var10000;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setCallback(int var1, Callback var2) &#123;</span><br><span class="line">        switch(var1) &#123;</span><br><span class="line">        case 0:</span><br><span class="line">            this.CGLIB$CALLBACK_0 = (MethodInterceptor)var2;</span><br><span class="line">        default:</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Callback[] getCallbacks() &#123;</span><br><span class="line">        CGLIB$BIND_CALLBACKS(this);</span><br><span class="line">        return new Callback[]&#123;this.CGLIB$CALLBACK_0&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setCallbacks(Callback[] var1) &#123;</span><br><span class="line">        this.CGLIB$CALLBACK_0 = (MethodInterceptor)var1[0];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static &#123;</span><br><span class="line">        CGLIB$STATICHOOK1();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-1-3-AspectJ"><a href="#3-1-3-AspectJ" class="headerlink" title="3.1.3 AspectJ"></a>3.1.3 AspectJ</h3><p>AspectJæ˜¯ç›®å‰å®ç°AOPæ¡†æ¶ä¸­æœ€æˆç†Ÿï¼ŒåŠŸèƒ½æœ€ä¸°å¯Œçš„è¯­è¨€ã€‚å½“ç„¶ï¼ŒAspectJéœ€è¦ä½¿ç”¨é¢å¤–çš„ç¼–è¯‘å™¨ã€‚</p><p>AspectJå¯ä»¥é€šè¿‡å¤šç§æ–¹å¼å®ç°ï¼ŒåŒ…æ‹¬æºç ç»‡å…¥æˆ–å­—èŠ‚ç ç»‡å…¥ï¼Œå¹¶ä¸”å¯ä»¥ç›´æ¥åœ¨è™šæ‹Ÿæœºï¼ˆVMï¼‰ä¸­å®ç°ã€‚åœ¨æ‰€æœ‰æƒ…å†µä¸‹ï¼ŒAspectJç¨‹åºéƒ½å°†æˆä¸ºåœ¨Java VMä¸­è¿è¡Œçš„æœ‰æ•ˆJavaç¨‹åºã€‚å—åˆ‡é¢å½±å“çš„ç±»ä¸ä¸å—å½±å“çš„ç±»å…·æœ‰äºŒè¿›åˆ¶å…¼å®¹æ€§ï¼ˆä»¥ä¿æŒä¸ä¸å—å½±å“çš„åŸå§‹æ–‡ä»¶ç¼–è¯‘çš„ç±»å…¼å®¹ï¼‰ã€‚æ”¯æŒå¤šç§å®ç°æ–¹å¼ä½¿è¯¥è¯­è¨€å¯ä»¥éšç€æŠ€æœ¯çš„å˜åŒ–è€Œå‘å±•ï¼Œå¹¶ä¸”ä¸Javaå…¼å®¹å¯ç¡®ä¿å¹³å°å¯ç”¨æ€§ã€‚<br>AspectJé‡‡ç”¨ç¼–è¯‘æœŸç»‡å…¥å’Œç±»åŠ è½½æœŸç»‡å…¥çš„æ–¹å¼ç»‡å…¥åˆ‡é¢ï¼Œæ˜¯è¯­è¨€çº§çš„AOPå®ç°ï¼Œæä¾›äº†å®Œå¤‡çš„AOPæ”¯æŒã€‚å®ƒç”¨AspectJè¯­è¨€å®šä¹‰åˆ‡é¢ï¼Œåœ¨ç¼–è¯‘æœŸæˆ–ç±»åŠ è½½æœŸå°†åˆ‡é¢ç»‡å…¥åˆ°Javaç±»ä¸­ã€‚<br>AspectJæä¾›äº†ä¸¤ç§åˆ‡é¢ç»‡å…¥æ–¹å¼ï¼Œç¬¬ä¸€ç§é€šè¿‡ç‰¹æ®Šç¼–è¯‘å™¨ï¼Œåœ¨ç¼–è¯‘æœŸï¼Œå°†AspectJè¯­è¨€ç¼–å†™çš„åˆ‡é¢ç±»ç»‡å…¥åˆ°Javaç±»ä¸­ï¼Œå¯ä»¥é€šè¿‡ä¸€ä¸ªAntæˆ–Mavenä»»åŠ¡æ¥å®Œæˆè¿™ä¸ªæ“ä½œï¼›ç¬¬äºŒç§æ–¹å¼æ˜¯ç±»åŠ è½½æœŸç»‡å…¥ï¼Œä¹Ÿç®€ç§°ä¸ºLTWï¼ˆLoad Time Weavingï¼‰ã€‚<br>ä½¿ç”¨AspectJ LTWæœ‰ä¸¤ä¸ªä¸»è¦æ­¥éª¤ï¼Œç¬¬ä¸€ï¼Œé€šè¿‡JVMçš„-javaagentå‚æ•°è®¾ç½®LTWçš„ç»‡å…¥å™¨ç±»åŒ…ï¼Œä»¥ä»£ç†JVMé»˜è®¤çš„ç±»åŠ è½½å™¨ï¼›ç¬¬äºŒï¼ŒLTWç»‡å…¥å™¨éœ€è¦ä¸€ä¸ªaop.xmlæ–‡ä»¶ï¼Œåœ¨è¯¥æ–‡ä»¶ä¸­æŒ‡å®šåˆ‡é¢ç±»å’Œéœ€è¦è¿›è¡Œåˆ‡é¢ç»‡å…¥çš„ç›®æ ‡ç±»ã€‚</p><p>è®¾ç½®-javaagent JVMå‚æ•°çš„æ–¹æ³•:<br>(1)åœ¨Eclipseä¸‹çš„è®¾ç½®:<br>è¿è¡Œç±»-&gt;å³é”®å•å‡»-&gt;Run As-&gt;Runâ€¦ï¼Œå¯ä»¥åœ¨å¼¹å‡ºçš„Runè®¾ç½®çª—å£è®¾ç½®è¯¥ç±»çš„å„é¡¹è¿è¡Œå±æ€§ï¼Œåˆ‡æ¢åˆ°Arguments Tabé¡µï¼Œåœ¨VM argumentsä¸­é€šè¿‡-javaagentæŒ‡å®šAspectJ ç»‡å…¥å™¨ç±»åŒ…ã€‚-javaagent:E:\workspace\lib\spring2.5\aspectjweaver.jar<br>(2)åœ¨Tomcatä¸‹çš„è®¾ç½®<br>æ‰“å¼€&lt;Tomcat_Home&gt;\bin\catalina.batï¼Œåœ¨è¯¥æ‰¹å¤„ç†æ–‡ä»¶å¤´éƒ¨æ·»åŠ ä»¥ä¸‹çš„è®¾ç½®ï¼š<br>set JAVA_OPTS=-javaagent:E:\workspace\lib\spring2.5\aspectjweaver.jar</p><h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h2><p>1.Javaç”ŸæˆåŠ¨æ€ä»£ç†çš„æ—¶å€™ï¼Œä½¿ç”¨WeakCacheç¼“å­˜å·²ç»ç”Ÿæˆçš„åŠ¨æ€ä»£ç†å·¥å‚ï¼Œç–‘é—®ç‚¹åœ¨äºï¼Œä¸ºä»€ä¹ˆç¼“å­˜çš„keyä½¿ç”¨çš„æ˜¯<a href="/java/2019-09-15-reference/">å¼±å¼•ç”¨</a>ï¼Ÿ</p><p>ç­”: ç±»ä¸­çš„é™æ€å˜é‡ï¼Œå½“å®ƒæŒæœ‰ä¸€ä¸ªæŒ‡å‘ä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨æ—¶ï¼Œå®ƒå°±ä½œä¸ºGC Rootï¼Œç¬¬ä¸€ç±»è¢«åˆ—ä¸ºGC Rootçš„å…ƒç´ å°±æ˜¯é™æ€æˆå‘˜å˜é‡ã€‚å› æ­¤è‹¥ç¼“å­˜ä¸å†éœ€è¦æ—¶ï¼Œä½¿ç”¨å¼ºå¼•ç”¨ä¼šè®©GCè¿›è¡Œæ ‡è®°åˆ†ææ—¶è®¤ä¸ºä»GC Rootå¯è¾¾ï¼Œä¸å¤ªä¼šå»æ ‡è®°è¿™å—å†…å­˜ï¼Œåä¹‹èƒ½å¤Ÿæœ‰æ•ˆåœ°æ ‡è®°è¿™äº›ç¼“å­˜ï¼Œä»è€Œæé«˜å†…å­˜å›æ”¶æ•ˆç‡ã€‚å¼•ç”¨è‡ª<a href="https://segmentfault.com/q/1010000011711958" target="_blank" rel="noopener">ä¸ºä»€ä¹ˆjdkåŠ¨æ€ä»£ç†ç±»çš„ç¼“å­˜æ˜¯å¼±å¼•ç”¨</a></p><p>ä¸ªäººåˆ†æ: æ—¢ç„¶ç¼“å­˜ä»£ç†å·¥å‚ç±»ï¼Œä¸ºä»€ä¹ˆä¸ä½¿ç”¨SoftReferenceï¼Œè¿™æ ·åªæœ‰å†…å­˜ç©ºé—´ä¸å¤Ÿæ—¶æ‰ä¼šè¿›è¡Œå›æ”¶ã€‚è¿™æ ·å¯ä»¥æœ€å¤§é™åº¦çš„ç¼“å­˜ç”Ÿæˆçš„ä»£ç†å·¥å‚ï¼Ÿ<br>å¦‚æœä½¿ç”¨SoftReferenceï¼Œå½“æœåŠ¡ä½¿ç”¨åŠ¨æ€ä»£ç†è¾ƒå¤šæ—¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´é¢‘ç¹çš„FullGCã€‚</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a href="https://www.ibm.com/developerworks/cn/java/j-lo-proxy1/index.html" target="_blank" rel="noopener">JavaåŠ¨æ€ä»£ç†æœºåˆ¶åˆ†æåŠæ‰©å±•ï¼Œç¬¬1éƒ¨åˆ†</a><br><a href="https://www.cnblogs.com/whirly/p/10154887.html" target="_blank" rel="noopener">Java åŠ¨æ€ä»£ç†è¯¦è§£</a><br><a href="https://tech.meituan.com/2019/09/05/java-bytecode-enhancement.html" target="_blank" rel="noopener">å­—èŠ‚ç å¢å¼ºæŠ€æœ¯æ¢ç´¢</a><br><a href="https://segmentfault.com/q/1010000011711958" target="_blank" rel="noopener">ä¸ºä»€ä¹ˆjdkåŠ¨æ€ä»£ç†ç±»çš„ç¼“å­˜æ˜¯å¼±å¼•ç”¨</a><br><a href="https://docs.oracle.com/javase/tutorial/reflect/index.html" target="_blank" rel="noopener">Java Reflection API</a><br><a href="https://www.iteye.com/blog/log-cd-562056" target="_blank" rel="noopener">AspectJ LTW(Load Time Weaving)</a><br><a href="https://www.eclipse.org/aspectj/doc/released/progguide/index.html" target="_blank" rel="noopener">The AspectJTM Programming Guide</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;1-åŠ¨æ€ä»£ç†&quot;&gt;&lt;a href=&quot;#1-åŠ¨æ€ä»£ç†&quot; class=&quot;headerlink&quot; title=&quot;1. åŠ¨æ€ä»£ç†&quot;&gt;&lt;/a&gt;1. åŠ¨æ€ä»£ç†&lt;/h2&gt;&lt;p&gt;ä»£ç†æ˜¯ä¸€ç§å¸¸ç”¨çš„è®¾è®¡æ¨¡å¼ï¼Œå…¶ç›®çš„å°±æ˜¯ä¸ºå…¶ä»–å¯¹è±¡æä¾›ä¸€ä¸ªä»£ç†ä»¥æ§åˆ¶å¯¹æŸä¸ªå¯¹è±¡çš„è®¿é—®ã€‚ä»£ç†ç±»è´Ÿè´£ä¸ºå§”æ‰˜ç±»é¢„å¤„
      
    
    </summary>
    
    
      <category term="Java" scheme="https://zhongyp.me/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>Javaè™šæ‹Ÿæœºç±»åŠ è½½æœºåˆ¶</title>
    <link href="https://zhongyp.me/jvm/2019-08-18-jvm-classloading/"/>
    <id>https://zhongyp.me/jvm/2019-08-18-jvm-classloading/</id>
    <published>2019-08-17T16:00:00.000Z</published>
    <updated>2019-09-10T08:44:34.872Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>ç¿»è¯‘è‡ª<a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-5.html" target="_blank" rel="noopener">Chapter 5. Loading, Linking, and Initializing</a></p></blockquote><p>Java è™šæ‹ŸæœºåŠ¨æ€çš„åŠ è½½ï¼Œè¿æ¥ï¼Œåˆå§‹åŒ–ç±»æˆ–è€…æ¥å£ã€‚</p><p>åŠ è½½æ˜¯ä¸€ä¸ªé€šè¿‡ç‰¹æ®Šç¬¦å·æŸ¥æ‰¾ç±»æˆ–è€…æ¥å£ç±»å‹çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼ŒåŒæ—¶ä½¿ç”¨äºŒè¿›åˆ¶æ–‡ä»¶åˆ›å»ºç±»æˆ–è€…æ¥å£çš„è¿‡ç¨‹ã€‚</p><p>è¿æ¥æ˜¯ä¸€ä¸ªåŠ è½½ç±»æˆ–è€…æ¥å£å¹¶ç»“åˆå®ƒå˜ä¸ºJavaè™šæ‹Ÿæœºçš„è¿è¡Œæ—¶çŠ¶æ€çš„è¿‡ç¨‹ï¼Œä»¥ä¾¿äºå®ƒå¯ä»¥è¢«Javaè™šæ‹Ÿæœºæ‰§è¡Œã€‚</p><p>ä¸€ä¸ªç±»æˆ–è€…æ¥å£çš„åˆå§‹åŒ–ç”±æ‰§è¡Œç±»æˆ–è€…æ¥å£çš„åˆå§‹åŒ–æ–¹æ³•<code>&lt;clinit&gt;</code>ç»„æˆ(<a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-2.html#jvms-2.9" target="_blank" rel="noopener">Â§2.9</a>)ã€‚</p><p>ä¸‹å›¾æ˜¯ç±»æˆ–è€…æ¥å£åŠ¨æ€åŠ è½½ã€è¿æ¥ã€åˆå§‹åŒ–çš„è¿‡ç¨‹ï¼š</p><p><img src="/media/article/jvm-classloading.png" alt="jvm-classloading"></p><p>å›¾ç‰‡æ‘˜è‡ª<a href="">æ·±å…¥ç†è§£Javaè™šæ‹Ÿæœº</a></p><h2 id="1-åŠ è½½"><a href="#1-åŠ è½½" class="headerlink" title="1. åŠ è½½"></a>1. åŠ è½½</h2><p>åŠ è½½é˜¶æ®µï¼š</p><ul><li><ol><li>é€šè¿‡ä¸€ä¸ªç±»çš„å…¨é™å®šåæ¥è·å–å®šä¹‰æ­¤ç±»äºŒè¿›åˆ¶å­—èŠ‚æµã€‚</li></ol></li><li><ol start="2"><li>å°†è¿™ä¸ªå­—èŠ‚æµä»£è¡¨çš„é™æ€å­˜å‚¨ç»“æ„è½¬æ¢ä¸ºæ–¹æ³•åŒºçš„è¿è¡Œæ—¶æ•°æ®ç»“æ„(è¿è¡Œæ—¶æ•°æ®ç»“æ„è¯¦è§ç¬¬å››å°èŠ‚<a href="#4-è¿è¡Œæ—¶å¸¸é‡æ± "></a>)ã€‚</li></ol></li><li><ol start="3"><li>åœ¨<strong><em>å†…å­˜(Classå¯¹è±¡æ¯”è¾ƒç‰¹æ®Šï¼Œå®ƒè™½ç„¶æ˜¯å¯¹è±¡ï¼Œä½†æ˜¯å­˜å‚¨åœ¨æ–¹æ³•åŒºä¸­)</em></strong>ç”Ÿæˆä¸€ä¸ªä»£è¡¨è¿™ä¸ªç±»çš„java.lang.Classå¯¹è±¡ï¼Œä½œä¸ºæ–¹æ³•åŒºè¿™ä¸ªç±»çš„å„ç§æ•°æ®çš„è®¿é—®å…¥å£ã€‚</li></ol></li></ul><p>å¯¹äºæ•°ç»„ç±»æœ¬èº«ä¸é€šè¿‡ç±»åŠ è½½å™¨åˆ›å»ºï¼Œå®ƒç”±Javaè™šæ‹Ÿæœºç›´æ¥åˆ›å»ºã€‚æ•°ç»„ç±»å‹å´ç”±ç±»åŠ è½½å™¨åˆ›å»ºï¼Œåˆ›å»ºè¿‡ç¨‹éµå¾ªä»¥ä¸‹è§„åˆ™ï¼š</p><ul><li>å¦‚æœæ•°ç»„ç»„ä»¶ç±»å‹æ˜¯å¼•ç”¨ç±»å‹ï¼Œåˆ™æ•°ç»„è¢«æ ‡è®°ä¸ºç»„ä»¶ç±»å‹å®šä¹‰çš„ç±»åŠ è½½å™¨å®šä¹‰ã€‚å¦åˆ™ï¼Œæ•°ç»„è¢«æ ‡è®°ä¸ºå¼•å¯¼ç±»åŠ è½½å™¨å®šä¹‰ã€‚</li><li>å¦‚æœæ•°ç»„çš„ç»„ä»¶ç±»å‹ä¸æ˜¯å¼•ç”¨ç±»å‹ï¼ŒJavaè™šæ‹Ÿæœºå°†ä¼šæŠŠæ•°ç»„æ ‡è®°ä¸ºä¸å¼•å¯¼ç±»åŠ è½½å™¨å…³è”ã€‚</li><li>æ•°ç»„ç±»çš„å¯è§æ€§ä¸å®ƒçš„ç»„ä»¶ç±»å‹çš„å¯è§æ€§ä¸€è‡´ï¼Œå¦‚æœç»„ä»¶ç±»å‹ä¸æ˜¯å¼•ç”¨ç±»å‹ï¼Œé‚£æ•°ç»„ç±»çš„å¯è§æ€§é»˜è®¤æ˜¯publicã€‚</li></ul><p>åŠ è½½å’Œè¿æ¥é˜¶æ®µæ˜¯äº¤å‰è¿›è¡Œçš„ã€‚</p><h2 id="2-è¿æ¥"><a href="#2-è¿æ¥" class="headerlink" title="2. è¿æ¥"></a>2. è¿æ¥</h2><p>å¦‚æœéœ€è¦è¿æ¥ç±»æˆ–æ¥å£æ¶‰åŠéªŒè¯å’Œå‡†å¤‡è¯¥ç±»æˆ–æ¥å£ï¼Œç›´æ¥è¶…ç±»ï¼Œç›´æ¥è¶…æ¥å£åŠå…¶å…ƒç´ ç±»å‹ï¼ˆå¦‚æœå®ƒæ˜¯æ•°ç»„ç±»å‹ï¼‰ã€‚ç±»æˆ–æ¥å£ä¸­ç¬¦å·å¼•ç”¨çš„è§£ææ˜¯è¿æ¥çš„å¯é€‰éƒ¨åˆ†ã€‚</p><p>åªè¦ç»´æŠ¤äº†ä»¥ä¸‹æ‰€æœ‰å±æ€§ï¼Œæ­¤è§„èŒƒå…è®¸å®ç°çµæ´»æ€§ï¼Œä»¥ä¾¿ä½•æ—¶å‘ç”Ÿè¿æ¥æ´»åŠ¨ï¼ˆä»¥åŠç”±äºé€’å½’ï¼ŒåŠ è½½ï¼‰ã€‚</p><ul><li><p>ç±»æˆ–æ¥å£åœ¨è¿æ¥ä¹‹å‰å·²å®Œå…¨åŠ è½½ã€‚</p></li><li><p>åœ¨åˆå§‹åŒ–ä¹‹å‰ï¼Œç±»æˆ–æ¥å£å·²å®Œå…¨éªŒè¯å¹¶å‡†å¤‡å¥½ã€‚</p></li></ul><p>åœ¨è¿æ¥æœŸé—´æ£€æµ‹åˆ°çš„é”™è¯¯è¢«æŠ›å‡ºåˆ°ç¨‹åºä¸­çš„æŸä¸ªç‚¹ï¼Œç¨‹åºå¯èƒ½ä¼šç›´æ¥æˆ–é—´æ¥åœ°éœ€è¦è¿æ¥åˆ°é”™è¯¯ä¸­æ¶‰åŠçš„ç±»æˆ–æ¥å£ã€‚</p><p>ä¾‹å¦‚ï¼ŒJavaè™šæ‹Ÿæœºå®ç°å¯ä»¥é€‰æ‹©åœ¨ä½¿ç”¨å®ƒæ—¶åˆ†åˆ«è§£æç±»æˆ–æ¥å£ä¸­çš„æ¯ä¸ªç¬¦å·å¼•ç”¨ï¼Œæˆ–è€…åœ¨éªŒè¯ç±»æ—¶ç«‹å³è§£æå®ƒä»¬ã€‚è¿™æ„å‘³ç€åœ¨ä¸€äº›å®ç°ä¸­ï¼Œåœ¨åˆå§‹åŒ–ç±»æˆ–æ¥å£ä¹‹åï¼Œè§£æè¿‡ç¨‹å¯ä»¥ç»§ç»­ã€‚æ— è®ºé‡‡ç”¨å“ªç§ç­–ç•¥ï¼Œåœ¨è§£ææœŸé—´æ£€æµ‹åˆ°çš„ä»»ä½•é”™è¯¯éƒ½å¿…é¡»æŠ›å‡ºåˆ°ç¨‹åºä¸­ï¼ˆç›´æ¥æˆ–é—´æ¥ï¼‰ä½¿ç”¨å¯¹ç±»æˆ–æ¥å£çš„ç¬¦å·å¼•ç”¨çš„ä½ç½®ã€‚</p><p>å› ä¸ºè¿æ¥æ¶‰åŠæ–°æ•°æ®ç»“æ„çš„åˆ†é…ï¼Œæ‰€ä»¥å®ƒå¯èƒ½ä¼šå¤±è´¥OutOfMemoryErrorã€‚</p><h3 id="2-1-éªŒè¯"><a href="#2-1-éªŒè¯" class="headerlink" title="2.1 éªŒè¯"></a>2.1 éªŒè¯</h3><p>éªŒè¯é˜¶æ®µä¼šå®Œæˆ4ä¸ªé˜¶æ®µçš„éªŒè¯åŠ¨ä½œï¼šæ–‡ä»¶æ ¼å¼éªŒè¯ã€å…ƒæ•°æ®éªŒè¯ã€å­—èŠ‚ç éªŒè¯ã€ç¬¦å·å¼•ç”¨éªŒè¯ã€‚</p><h3 id="2-2-å‡†å¤‡"><a href="#2-2-å‡†å¤‡" class="headerlink" title="2.2 å‡†å¤‡"></a>2.2 å‡†å¤‡</h3><p>å‡†å¤‡é˜¶æ®µæ˜¯æ­£å¼ä¸º<strong>ç±»å˜é‡</strong>åˆ†é…å†…å­˜å¹¶è®¾ç½®ç±»å˜é‡<strong>åˆå§‹å€¼</strong>çš„é˜¶æ®µï¼Œè¿™äº›å˜é‡æ‰€ä½¿ç”¨çš„å†…å­˜éƒ½å°†åœ¨æ–¹æ³•åŒºä¸­è¿›è¡Œåˆ†é…ã€‚è¿›è¡Œå†…å­˜åˆ†é…çš„ä»…åŒ…æ‹¬<strong><em>ç±»å˜é‡[staticå˜é‡]</em></strong>ï¼Œä¸åŒ…æ‹¬å®ä¾‹å˜é‡ï¼Œå®ä¾‹å˜é‡å°†ä¼šåœ¨å¯¹è±¡å®ä¾‹åŒ–æ—¶éšç€å¯¹è±¡ä¸€èµ·åˆ†é…åœ¨Javaå †ä¸­ã€‚</p><h3 id="2-3-è§£æ"><a href="#2-3-è§£æ" class="headerlink" title="2.3 è§£æ"></a>2.3 è§£æ</h3><p>è§£æé˜¶æ®µæ˜¯è™šæ‹Ÿæœºå°†å¸¸é‡æ± å†…çš„ç¬¦å·å¼•ç”¨æ›¿æ¢ä¸ºç›´æ¥å¼•ç”¨çš„è¿‡ç¨‹ã€‚</p><p>anewarray, checkcast, getfield, getstatic, instanceof, invokedynamic, invokeinterface, invokespecial, invokestatic, invokevirtual, ldc, ldc_w, multianewarray, new, putfield, putstaticï¼Œè¿™äº›è™šæ‹ŸæœºæŒ‡ä»¤å¯¹è¿è¡Œæ—¶å¸¸é‡æ± è¿›è¡Œç¬¦å·å¼•ç”¨ï¼Œæ‰§è¡Œä»»ä½•è¿™äº›æŒ‡ä»¤éƒ½éœ€è¦è§£æå…¶ç¬¦å·å¼•ç”¨ã€‚</p><p>è§£ææ˜¯ä»è¿è¡Œæ—¶å¸¸é‡æ± ä¸­çš„ç¬¦å·å¼•ç”¨åŠ¨æ€ç¡®å®šå…·ä½“å€¼çš„è¿‡ç¨‹ã€‚</p><p>å¯¹å‡ºç°åœ¨invokedynamicæŒ‡ä»¤çš„ç›¸åŒçš„ç¬¦å·å¼•ç”¨è¢«è§£æä¸€æ¬¡å¹¶ä¸æ„å‘³ç€è¢«ä»»ä½•å…¶ä»–invokedynamicæŒ‡ä»¤è®¤ä¸ºå·²è§£æã€‚</p><p>å¯¹äºä¸Šè¿°æåˆ°çš„æ‰€æœ‰æŒ‡ä»¤ï¼Œå¦‚æœå…¶ä¸­ä¸€ä¸ªæŒ‡ä»¤å¯¹ç¬¦å·å¼•ç”¨è¿›è¡Œäº†è§£æï¼Œåˆ™æ„å‘³ç€ä»»ä½•éinvokedynamicæŒ‡ä»¤è®¤ä¸ºè¿™ä¸ªç¬¦å·å¼•ç”¨å·²ç»è§£æã€‚</p><p>å¦‚æœåœ¨è§£æç¬¦å·å¼•ç”¨æœŸé—´å‘ç”Ÿé”™è¯¯ï¼Œåˆ™å¿…é¡»åœ¨ç¨‹åºä¸­(ç›´æ¥æˆ–é—´æ¥)ä½¿ç”¨ç¬¦å·å¼•ç”¨æ—¶çš„æŸä¸€ç‚¹æŠ›å‡ºIncompatibleClassChangeError(æˆ–å­ç±»)çš„å®ä¾‹ã€‚</p><p>å¦‚æœJavaè™šæ‹Ÿæœºå°è¯•è§£æç¬¦å·å¼•ç”¨å¤±è´¥ï¼ŒæŠ›å‡ºçš„é”™è¯¯æ˜¯LinkageError(æˆ–å­ç±»)çš„å®ä¾‹ï¼Œåç»­å°è¯•è§£æå¼•ç”¨å§‹ç»ˆå¤±è´¥ï¼Œå¹¶ä¸”å’Œåˆå§‹è§£æå°è¯•è€Œå¼•å‘çš„é”™è¯¯ç›¸åŒã€‚</p><p>åœ¨æ‰§è¡ŒæŒ‡ä»¤ä¹‹å‰ï¼Œä¸å¾—è§£æç‰¹å®šinvokedynamicæŒ‡ä»¤å¯¹è°ƒç”¨siteè¯´æ˜ç¬¦çš„ç¬¦å·å¼•ç”¨ã€‚</p><p>åœ¨<code>invokedynamic</code>æŒ‡ä»¤è§£æå¤±è´¥çš„æƒ…å†µä¸‹ï¼Œåç»­è§£æå°è¯•ä¸ä¼šé‡æ–°æ‰§è¡Œå¼•å¯¼æ–¹æ³•ã€‚</p><p>ä¸Šè¿°æŸäº›æŒ‡ä»¤åœ¨è§£æç¬¦å·å¼•ç”¨æ—¶éœ€è¦é¢å¤–çš„è¿æ¥æ£€æŸ¥ã€‚ä¾‹å¦‚ï¼Œä¸ºäº†ä½¿getfieldæŒ‡ä»¤æˆåŠŸè§£æå¯¹å…¶è¿è¡Œçš„å­—æ®µçš„ç¬¦å·å¼•ç”¨ï¼Œå®ƒä¸ä»…å¿…é¡»å®Œæˆç¬¬<a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-5.html#jvms-5.4.3.2" target="_blank" rel="noopener">5.4.3.2</a>èŠ‚ä¸­ç»™å‡ºçš„å­—æ®µè§£ææ­¥éª¤ï¼Œè¿˜è¦æ£€æŸ¥å­—æ®µæ˜¯å¦ä¸ºé™æ€ã€‚å¦‚æœå®ƒæ˜¯é™æ€å­—æ®µï¼Œåˆ™å¿…é¡»æŠ›å‡ºé“¾æ¥å¼‚å¸¸ã€‚</p><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œä¸ºäº†ä½¿<code>invokedynamic</code>æŒ‡ä»¤æˆåŠŸè§£æå¯¹è°ƒç”¨siteè¯´æ˜ç¬¦çš„ç¬¦å·å¼•ç”¨ï¼Œå…¶ä¸­æŒ‡å®šçš„å¼•å¯¼æ–¹æ³•å¿…é¡»æ­£å¸¸å®Œæˆå¹¶è¿”å›åˆé€‚çš„è°ƒç”¨ç«™ç‚¹å¯¹è±¡ã€‚å¦‚æœå¼•å¯¼æ–¹æ³•çªç„¶å®Œæˆæˆ–è¿”å›ä¸åˆé€‚çš„è°ƒç”¨ç«™ç‚¹å¯¹è±¡ï¼Œåˆ™å¿…é¡»æŠ›å‡ºè¿æ¥å¼‚å¸¸ã€‚</p><p>è¿æ¥ç”±ç‰¹å®šæ‰§è¡Œç‰¹å®šJavaè™šæ‹ŸæœºæŒ‡ä»¤æ£€æŸ¥ç”Ÿæˆçš„å¼‚å¸¸åœ¨è¯¥æŒ‡ä»¤çš„æè¿°ä¸­ç»™å‡ºï¼Œå¹¶ä¸”åœ¨æœ¬è§£æçš„ä¸€èˆ¬æ€§è®¨è®ºä¸­æœªæ¶‰åŠã€‚è¯·æ³¨æ„ï¼Œæ­¤ç±»å¼‚å¸¸è™½ç„¶è¢«æè¿°ä¸ºJavaè™šæ‹ŸæœºæŒ‡ä»¤æ‰§è¡Œè€Œéè§£æçš„ä¸€éƒ¨åˆ†ï¼Œä½†ä»ç„¶è¢«è§†ä¸ºè§£æå¤±è´¥ã€‚</p><h2 id="3-åˆå§‹åŒ–"><a href="#3-åˆå§‹åŒ–" class="headerlink" title="3. åˆå§‹åŒ–"></a>3. åˆå§‹åŒ–</h2><p>ä¸€ä¸ªç±»çš„åŠ è½½è¿‡ç¨‹ä¸­åŠ è½½ã€éªŒè¯ã€å‡†å¤‡ã€åˆå§‹åŒ–ã€å¸è½½è¿™5ä¸ªé˜¶æ®µçš„é¡ºåºæ˜¯ç¡®å®šçš„ï¼Œè§£æé˜¶æ®µåˆ™ä¸ä¸€å®šã€‚è§£æå¯ä»¥åœ¨åˆå§‹åŒ–å®Œæˆåå†å¼€å§‹ï¼Œè¿™æ—¶ä¸ºäº†æ”¯æŒJavaçš„è¿è¡Œæ—¶ç»‘å®šã€‚</p><p>Javaè™šæ‹Ÿæœºæ²¡æœ‰è¿›è¡Œå¼ºåˆ¶çº¦æŸä»€ä¹ˆæ—¶å€™åŠ è½½ï¼Œåªæ˜¯ä¸¥æ ¼è§„èŒƒäº†5ä¸­æƒ…å†µå¿…é¡»å¯¹ç±»è¿›è¡Œâ€åˆå§‹åŒ–â€ã€‚</p><ul><li>é‡åˆ°newã€getstaticã€putstaticæˆ–invokestaticè¿™4æ¡æŒ‡ä»¤æ—¶ï¼Œå¦‚æœç±»æ²¡æœ‰è¿›è¡Œåˆå§‹åŒ–ï¼Œåˆ™éœ€è¦å…ˆè§¦å‘å…¶åˆå§‹åŒ–ã€‚4æ¡æŒ‡ä»¤çš„å¸¸è§åœºæ™¯æ˜¯:ä½¿ç”¨new å…³é”®å­—å®ä¾‹åŒ–å¯¹è±¡çš„æ—¶å€™ã€è¯»å–æˆ–è®¾ç½®ä¸€ä¸ªç±»çš„é™æ€å­—æ®µ(è¢«finalä¿®é¥°ã€å·²åœ¨ç¼–è¯‘å™¨æŠŠç»“æœæ”¾å…¥å¸¸é‡æ± çš„é™æ€å­—æ®µé™¤å¤–)ã€ä»¥åŠè°ƒç”¨ä¸€ä¸ªç±»çš„é™æ€æ–¹æ³•çš„æ—¶å€™ã€‚</li><li>ä½¿ç”¨java.lang.reflectåŒ…çš„æ–¹æ³•å¯¹ç±»è¿›è¡Œåå°„è°ƒç”¨çš„æ—¶å€™ï¼Œå¦‚æœç±»æ²¡æœ‰è¿›è¡Œè¿‡åˆå§‹åŒ–ï¼Œåˆ™éœ€è¦å…ˆè§¦å‘å…¶åˆå§‹åŒ–ã€‚</li><li>å½“åˆå§‹åŒ–ä¸€ä¸ªç±»çš„æ—¶å€™ï¼Œå¦‚æœå‘ç°å…¶çˆ¶ç±»è¿˜æ²¡æœ‰è¿›è¡Œè¿‡åˆå§‹åŒ–ï¼Œåˆ™éœ€è¦å…ˆè§¦å‘å…¶çˆ¶ç±»çš„åˆå§‹åŒ–ã€‚</li><li>å½“è™šæ‹Ÿæœºå¯åŠ¨æ—¶ï¼Œç”¨æˆ·éœ€è¦æŒ‡å®šä¸€ä¸ªè¦æ‰§è¡Œçš„ä¸»ç±»(åŒ…å«main()æ–¹æ³•çš„é‚£ä¸ªç±»)ï¼Œè™šæ‹Ÿæœºä¼šå…ˆåˆå§‹åŒ–è¿™ä¸ªä¸»ç±»ã€‚</li><li>å½“ä½¿ç”¨JDK1.7åŠä»¥ä¸Šç‰ˆæœ¬çš„åŠ¨æ€è¯­è¨€(è¯¦ç»†äº†è§£ <a href="https://www.infoq.cn/article/jdk-dynamically-typed-language/" target="_blank" rel="noopener">JavaåŠ¨æ€è¯­è¨€æ”¯æŒ â€“å‘¨å¿—æ˜</a>)æ”¯æŒæ—¶ï¼Œå¦‚æœä¸€ä¸ªjava.lang.incoke.MethodHandleå®ä¾‹æœ€åè§£æç»“æœæ˜¯REF_getStaticã€REF_putStaticã€REF_invokeStaticçš„æ–¹æ³•å¥æŸ„ï¼Œå¹¶ä¸”è¿™ä¸ªæ–¹æ³•å¥æŸ„æ‰€å¯¹åº”çš„ç±»æ²¡æœ‰è¿›è¡Œè¿‡åˆå§‹åŒ–ï¼Œåˆ™å…ˆè§¦å‘å…¶åˆå§‹åŒ–ã€‚</li></ul><p>åˆå§‹åŒ–é˜¶æ®µæ˜¯æ‰§è¡Œç±»æ„é€ å™¨<code>&lt;clinit&gt;()</code>æ–¹æ³•çš„è¿‡ç¨‹ã€‚</p><blockquote><p><code>&lt;clinit&gt;()</code>æ–¹æ³•æ˜¯ç”±ç¼–è¯‘å™¨è‡ªåŠ¨æ”¶é›†ç±»ä¸­çš„æ‰€æœ‰ <strong><em>ç±»å˜é‡çš„èµ‹å€¼åŠ¨ä½œ</em></strong>å’Œ<strong><em>é™æ€è¯­å¥å—(static{}å—)ä¸­çš„è¯­å¥</em></strong>åˆå¹¶äº§ç”Ÿçš„ï¼Œç¼–è¯‘å™¨æ”¶é›†çš„é¡ºåºæ˜¯ç”±è¯­å¥åœ¨æºæ–‡ä»¶ä¸­å‡ºç°çš„é¡ºåºæ‰€å†³å®šçš„ï¼Œé™æ€è¯­å¥å—ä¸­åªèƒ½è®¿é—®åˆ°å®šä¹‰åœ¨é™æ€è¯­ä¹‰å—ä¹‹å‰çš„å˜é‡ï¼Œå®šä¹‰åœ¨å®ƒä¹‹åçš„å˜é‡ï¼Œå¯ä»¥èµ‹å€¼ï¼Œä½†æ˜¯ä¸èƒ½è®¿é—®ã€‚</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public class Test()&#123;</span><br><span class="line">    static &#123;</span><br><span class="line">        i = 0;</span><br><span class="line">        System.out.print(i);</span><br><span class="line">    &#125;</span><br><span class="line">    static int i = 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>æ¥å£ä¸­ä¸èƒ½ä½¿ç”¨é™æ€è¯­å¥å—ï¼Œä½†ä»ç„¶æœ‰å˜é‡åˆå§‹åŒ–çš„èµ‹å€¼æ“ä½œï¼Œå› æ­¤æ¥å£ä¸ç±»ä¸€æ ·éƒ½ä¼šç”Ÿæˆ<code>&lt;clinit&gt;()</code>æ–¹æ³•ã€‚ä½†æ¥å£ä¸ç±»ä¸åŒçš„æ˜¯ï¼Œæ‰§è¡Œæ¥å£çš„<code>&lt;clinit&gt;()</code>ä¸éœ€è¦æ‰§è¡Œå…¶çˆ¶æ¥å£çš„<code>&lt;clinit&gt;()</code>æ–¹æ³•ã€‚<br>è™šæ‹Ÿæœºä¼šä¿è¯ä¸€ä¸ªç±»çš„<code>&lt;clinit&gt;()</code>æ–¹æ³•åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­è¢«æ­£ç¡®çš„åŠ é”ã€åŒæ­¥ã€‚å¦‚æœå¤šä¸ªçº¿ç¨‹åŒæ—¶å»åˆå§‹åŒ–ä¸€ä¸ªç±»ï¼Œé‚£ä¹ˆåªä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹å»æ‰§è¡Œè¿™ä¸ªç±»çš„<code>&lt;clinit&gt;()</code>æ–¹æ³•ï¼Œå…¶ä»–çº¿ç¨‹éƒ½éœ€è¦é˜»å¡ç­‰å¾…ã€‚</p></blockquote><h2 id="4-è¿è¡Œæ—¶å¸¸é‡æ± "><a href="#4-è¿è¡Œæ—¶å¸¸é‡æ± " class="headerlink" title="4. è¿è¡Œæ—¶å¸¸é‡æ± "></a>4. è¿è¡Œæ—¶å¸¸é‡æ± </h2><p>Javaè™šæ‹Ÿæœºç»´æŠ¤æ¯ç§ç±»å‹å¸¸é‡æ± ï¼Œè¿™æ˜¯ä¸€ç§è¿è¡Œæ—¶æ•°æ®ç»“æ„ï¼Œå®ƒæœåŠ¡äºå¸¸è§„ç¼–ç¨‹è¯­è¨€å®ç°çš„ç¬¦å·è¡¨çš„è®¸å¤šç›®çš„ã€‚</p><p>ç±»æˆ–æ¥å£çš„äºŒè¿›åˆ¶è¡¨ç¤ºå½¢å¼ä¸­çš„constant_poolè¡¨ç”¨äºåœ¨åˆ›å»ºç±»æˆ–æ¥å£å¯¹è±¡æ—¶æ„é€ è¿è¡Œæ—¶å¸¸é‡æ± ã€‚è¿è¡Œæ—¶å¸¸é‡æ± ä¸­çš„æ‰€æœ‰å¼•ç”¨æœ€åˆéƒ½æ˜¯ç¬¦å·å¼•ç”¨ã€‚è¿è¡Œæ—¶å¸¸é‡æ± ä¸­çš„ç¬¦å·å¼•ç”¨æ˜¯ä»ç±»æˆ–æ¥å£çš„äºŒè¿›åˆ¶è¡¨ç¤ºä¸­çš„ç»“æ„æ´¾ç”Ÿçš„ï¼Œå¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">// å­—ç¬¦ä¸²</span><br><span class="line">String str = &quot;str&quot;;</span><br><span class="line"></span><br><span class="line">System.out.println(str);</span><br><span class="line"></span><br><span class="line">// åŸºæœ¬ç±»å‹</span><br><span class="line">int i = 1;</span><br><span class="line"></span><br><span class="line">// åŸºæœ¬ç±»å‹æ•°ç»„</span><br><span class="line">int[] arrayI = new int[3];</span><br><span class="line"></span><br><span class="line">// å¼•ç”¨ç±»å‹æ•°ç»„</span><br><span class="line">A [] arrayA = new A[3];</span><br><span class="line"></span><br><span class="line">// å¼•ç”¨ç±»å‹</span><br><span class="line">A a = new A();</span><br><span class="line"></span><br><span class="line">// å¼•ç”¨æ–¹æ³•</span><br><span class="line">a.test();</span><br><span class="line"></span><br><span class="line">// æ¥å£å£°æ˜</span><br><span class="line">C c = new B();</span><br><span class="line"></span><br><span class="line">// æ¥å£æ–¹æ³•</span><br><span class="line">c.test();</span><br><span class="line"></span><br><span class="line">// lambda</span><br><span class="line">Runnable x = ()-&gt;&#123;&#125;;</span><br></pre></td></tr></table></figure></p><p><code>javap -v</code>ç¼–è¯‘å¦‚ä¸‹:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">Constant pool:</span><br><span class="line">   #1 = Methodref          #13.#42        // java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">   #2 = String             #25            // str</span><br><span class="line">   #3 = Fieldref           #43.#44        // java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">   #4 = Methodref          #45.#46        // java/io/PrintStream.println:(Ljava/lang/String;)V</span><br><span class="line">   #5 = Class              #47            // com/zhongyp/test/A</span><br><span class="line">   #6 = Methodref          #5.#42         // com/zhongyp/test/A.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">   #7 = Methodref          #5.#48         // com/zhongyp/test/A.test:()V</span><br><span class="line">   #8 = Class              #49            // com/zhongyp/test/B</span><br><span class="line">   #9 = Methodref          #8.#42         // com/zhongyp/test/B.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">  #10 = InterfaceMethodref #50.#48        // com/zhongyp/test/C.test:()V</span><br><span class="line">  #11 = InvokeDynamic      #0:#55         // #0:run:()Ljava/lang/Runnable;</span><br><span class="line">  #12 = Class              #56            // com/zhongyp/test/Test</span><br><span class="line">  #13 = Class              #57            // java/lang/Object</span><br><span class="line">  #14 = Utf8               &lt;init&gt;</span><br><span class="line">  #15 = Utf8               ()V</span><br><span class="line">  #16 = Utf8               Code</span><br><span class="line">  #17 = Utf8               LineNumberTable</span><br><span class="line">  #18 = Utf8               LocalVariableTable</span><br><span class="line">  #19 = Utf8               this</span><br><span class="line">  #20 = Utf8               Lcom/zhongyp/test/Test;</span><br><span class="line">  #21 = Utf8               main</span><br><span class="line">  #22 = Utf8               ([Ljava/lang/String;)V</span><br><span class="line">  #23 = Utf8               args</span><br><span class="line">  #24 = Utf8               [Ljava/lang/String;</span><br><span class="line">  #25 = Utf8               str</span><br><span class="line">  #26 = Utf8               Ljava/lang/String;</span><br><span class="line">  #27 = Utf8               i</span><br><span class="line">  #28 = Utf8               I</span><br><span class="line">  #29 = Utf8               arrayI</span><br><span class="line">  #30 = Utf8               [I</span><br><span class="line">  #31 = Utf8               arrayA</span><br><span class="line">  #32 = Utf8               [Lcom/zhongyp/test/A;</span><br><span class="line">  #33 = Utf8               a</span><br><span class="line">  #34 = Utf8               Lcom/zhongyp/test/A;</span><br><span class="line">  #35 = Utf8               c</span><br><span class="line">  #36 = Utf8               Lcom/zhongyp/test/C;</span><br><span class="line">  #37 = Utf8               x</span><br><span class="line">  #38 = Utf8               Ljava/lang/Runnable;</span><br><span class="line">  #39 = Utf8               lambda$main$0</span><br><span class="line">  #40 = Utf8               SourceFile</span><br><span class="line">  #41 = Utf8               Test.java</span><br><span class="line">  #42 = NameAndType        #14:#15        // &quot;&lt;init&gt;&quot;:()V</span><br><span class="line">  #43 = Class              #58            // java/lang/System</span><br><span class="line">  #44 = NameAndType        #59:#60        // out:Ljava/io/PrintStream;</span><br><span class="line">  #45 = Class              #61            // java/io/PrintStream</span><br><span class="line">  #46 = NameAndType        #62:#63        // println:(Ljava/lang/String;)V</span><br><span class="line">  #47 = Utf8               com/zhongyp/test/A</span><br><span class="line">  #48 = NameAndType        #64:#15        // test:()V</span><br><span class="line">  #49 = Utf8               com/zhongyp/test/B</span><br><span class="line">  #50 = Class              #65            // com/zhongyp/test/C</span><br><span class="line">  #51 = Utf8               BootstrapMethods</span><br><span class="line">  #52 = MethodHandle       #6:#66         // invokestatic java/lang/invoke/LambdaMetafactory.metafactory:(Ljava/lang/invoke/MethodHandles$Lookup;Ljava/lang/String;Ljava/lang/invoke/MethodType;Ljava/lang/invoke/MethodType;Ljava/lang/invoke/MethodHandle;Ljava/lang/invoke/MethodType;)Ljava/lang/invoke/CallSite;</span><br><span class="line">  #53 = MethodType         #15            //  ()V</span><br><span class="line">  #54 = MethodHandle       #6:#67         // invokestatic com/zhongyp/test/Test.lambda$main$0:()V</span><br><span class="line">  #55 = NameAndType        #68:#69        // run:()Ljava/lang/Runnable;</span><br><span class="line">  #56 = Utf8               com/zhongyp/test/Test</span><br><span class="line">  #57 = Utf8               java/lang/Object</span><br><span class="line">  #58 = Utf8               java/lang/System</span><br><span class="line">  #59 = Utf8               out</span><br><span class="line">  #60 = Utf8               Ljava/io/PrintStream;</span><br><span class="line">  #61 = Utf8               java/io/PrintStream</span><br><span class="line">  #62 = Utf8               println</span><br><span class="line">  #63 = Utf8               (Ljava/lang/String;)V</span><br><span class="line">  #64 = Utf8               test</span><br><span class="line">  #65 = Utf8               com/zhongyp/test/C</span><br><span class="line">  #66 = Methodref          #70.#71        // java/lang/invoke/LambdaMetafactory.metafactory:(Ljava/lang/invoke/MethodHandles$Lookup;Ljava/lang/String;Ljava/lang/invoke/MethodType;Ljava/lang/invoke/MethodType;Ljava/lang/invoke/MethodHandle;Ljava/lang/invoke/MethodType;)Ljava/lang/invoke/CallSite;</span><br><span class="line">  #67 = Methodref          #12.#72        // com/zhongyp/test/Test.lambda$main$0:()V</span><br><span class="line">  #68 = Utf8               run</span><br><span class="line">  #69 = Utf8               ()Ljava/lang/Runnable;</span><br><span class="line">  #70 = Class              #73            // java/lang/invoke/LambdaMetafactory</span><br><span class="line">  #71 = NameAndType        #74:#78        // metafactory:(Ljava/lang/invoke/MethodHandles$Lookup;Ljava/lang/String;Ljava/lang/invoke/MethodType;Ljava/lang/invoke/MethodType;Ljava/lang/invoke/MethodHandle;Ljava/lang/invoke/MethodType;)Ljava/lang/invoke/CallSite;</span><br><span class="line">  #72 = NameAndType        #39:#15        // lambda$main$0:()V</span><br><span class="line">  #73 = Utf8               java/lang/invoke/LambdaMetafactory</span><br><span class="line">  #74 = Utf8               metafactory</span><br><span class="line">  #75 = Class              #80            // java/lang/invoke/MethodHandles$Lookup</span><br><span class="line">  #76 = Utf8               Lookup</span><br><span class="line">  #77 = Utf8               InnerClasses</span><br><span class="line">  #78 = Utf8               (Ljava/lang/invoke/MethodHandles$Lookup;Ljava/lang/String;Ljava/lang/invoke/MethodType;Ljava/lang/invoke/MethodType;Ljava/lang/invoke/MethodHandle;Ljava/lang/invoke/MethodType;)Ljava/lang/invoke/CallSite;</span><br><span class="line">  #79 = Class              #81            // java/lang/invoke/MethodHandles</span><br><span class="line">  #80 = Utf8               java/lang/invoke/MethodHandles$Lookup</span><br><span class="line">  #81 = Utf8               java/lang/invoke/MethodHandles</span><br></pre></td></tr></table></figure><h3 id="4-1-CONSTANT-Class-infoç»“æ„"><a href="#4-1-CONSTANT-Class-infoç»“æ„" class="headerlink" title="4.1 CONSTANT_Class_infoç»“æ„"></a>4.1 CONSTANT_Class_infoç»“æ„</h3><p>å¯¹ç±»æˆ–æ¥å£çš„ç¬¦å·å¼•ç”¨æ˜¯ä»ç±»æˆ–æ¥å£çš„äºŒè¿›åˆ¶è¡¨ç¤ºå½¢å¼ä¸­çš„CONSTANT_Class_infoç»“æ„<a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html#jvms-4.4.1" target="_blank" rel="noopener">ç¬¬4.4.1èŠ‚</a>æ´¾ç”Ÿçš„ã€‚è¿™æ ·çš„å¼•ç”¨ç»™å‡ºäº†Class.getNameæ–¹æ³•è¿”å›çš„è¡¨å•ä¸­çš„ç±»æˆ–æ¥å£çš„åç§°ã€‚</p><p>å¯¹äºéæ•°ç»„ç±»æˆ–æ¥å£ï¼Œåç§°æ˜¯ç±»æˆ–æ¥å£çš„äºŒè¿›åˆ¶åç§°<a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html#jvms-4.2.1" target="_blank" rel="noopener">ç¬¬4.2.1èŠ‚</a>ã€‚</p><p>å¯¹äºnç»´çš„æ•°ç»„ç±»ï¼Œåç§°ä»¥nä¸ªå‡ºç°çš„ASCIIâ€œ[â€å­—ç¬¦å¼€å¤´ï¼Œåè·Ÿå…ƒç´ ç±»å‹çš„è¡¨ç¤ºï¼š</p><ul><li><p>å¦‚æœå…ƒç´ ç±»å‹æ˜¯åŸºæœ¬ç±»å‹ï¼Œåˆ™å®ƒç”±ç›¸åº”çš„å­—æ®µæè¿°ç¬¦<a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html#jvms-4.3.2" target="_blank" rel="noopener">ç¬¬4.3.2èŠ‚</a>è¡¨ç¤ºã€‚</p></li><li><p>å¦åˆ™ï¼Œå¦‚æœå…ƒç´ ç±»å‹æ˜¯å¼•ç”¨ç±»å‹ï¼Œåˆ™å®ƒç”±ASCIIâ€œLâ€å­—ç¬¦åè·Ÿå…ƒç´ ç±»å‹çš„äºŒè¿›åˆ¶åç§°<a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html#jvms-4.2.1" target="_blank" rel="noopener">ç¬¬4.2.1èŠ‚</a>åè·ŸASCIIâ€œ;â€ç¬¦å·è¡¨ç¤ºã€‚</p></li></ul><h3 id="4-2-CONSTANT-Fieldref-infoç»“æ„"><a href="#4-2-CONSTANT-Fieldref-infoç»“æ„" class="headerlink" title="4.2 CONSTANT_Fieldref_infoç»“æ„"></a>4.2 CONSTANT_Fieldref_infoç»“æ„</h3><p>å¯¹ç±»æˆ–æ¥å£çš„å­—æ®µçš„ç¬¦å·å¼•ç”¨æ˜¯ä»ç±»æˆ–æ¥å£çš„äºŒè¿›åˆ¶è¡¨ç¤ºå½¢å¼ä¸­çš„CONSTANT_Fieldref_infoç»“æ„<a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html#jvms-4.4.2" target="_blank" rel="noopener">ç¬¬4.4.2èŠ‚</a>æ´¾ç”Ÿçš„ã€‚è¿™æ ·çš„å¼•ç”¨ç»™å‡ºäº†å­—æ®µçš„åç§°å’Œæè¿°ç¬¦ï¼Œä»¥åŠå¯¹è¦åœ¨å…¶ä¸­æ‰¾åˆ°å­—æ®µçš„ç±»æˆ–æ¥å£çš„ç¬¦å·å¼•ç”¨ã€‚</p><h3 id="4-3-CONSTANT-Methodref-infoç»“æ„"><a href="#4-3-CONSTANT-Methodref-infoç»“æ„" class="headerlink" title="4.3 CONSTANT_Methodref_infoç»“æ„"></a>4.3 CONSTANT_Methodref_infoç»“æ„</h3><p>å¯¹ç±»çš„æ–¹æ³•çš„ç¬¦å·å¼•ç”¨æ˜¯ä»ç±»æˆ–æ¥å£çš„äºŒè¿›åˆ¶è¡¨ç¤ºå½¢å¼ä¸­çš„CONSTANT_Methodref_infoç»“æ„<a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html#jvms-4.4.2" target="_blank" rel="noopener">ç¬¬4.4.2èŠ‚</a>æ´¾ç”Ÿçš„ã€‚è¿™æ ·çš„å¼•ç”¨ç»™å‡ºäº†æ–¹æ³•çš„åç§°å’Œæè¿°ç¬¦ï¼Œä»¥åŠå¯¹è¦åœ¨å…¶ä¸­æ‰¾åˆ°æ–¹æ³•çš„ç±»çš„ç¬¦å·å¼•ç”¨ã€‚</p><h3 id="4-4-CONSTANT-InterfaceMethodref-info"><a href="#4-4-CONSTANT-InterfaceMethodref-info" class="headerlink" title="4.4 CONSTANT_InterfaceMethodref_info"></a>4.4 CONSTANT_InterfaceMethodref_info</h3><p>å¯¹æ¥å£æ–¹æ³•çš„ç¬¦å·å¼•ç”¨æ˜¯ä»ç±»æˆ–æ¥å£çš„äºŒè¿›åˆ¶è¡¨ç¤ºå½¢å¼ä¸­çš„CONSTANT_InterfaceMethodref_infoç»“æ„<a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html#jvms-4.4.2" target="_blank" rel="noopener">ç¬¬4.4.2èŠ‚</a>æ´¾ç”Ÿçš„ã€‚è¿™æ ·çš„å¼•ç”¨ç»™å‡ºäº†æ¥å£æ–¹æ³•çš„åç§°å’Œæè¿°ç¬¦ï¼Œä»¥åŠå¯¹è¦åœ¨å…¶ä¸­æ‰¾åˆ°æ–¹æ³•çš„æ¥å£çš„ç¬¦å·å¼•ç”¨ã€‚</p><h3 id="4-5-CONSTANT-MethodHandle-infoç»“æ„"><a href="#4-5-CONSTANT-MethodHandle-infoç»“æ„" class="headerlink" title="4.5 CONSTANT_MethodHandle_infoç»“æ„"></a>4.5 CONSTANT_MethodHandle_infoç»“æ„</h3><p>æ–¹æ³•å¥æŸ„çš„ç¬¦å·å¼•ç”¨æ˜¯ä»ç±»æˆ–æ¥å£çš„äºŒè¿›åˆ¶è¡¨ç¤ºå½¢å¼ä¸­çš„CONSTANT_MethodHandle_infoç»“æ„<a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html#jvms-4.4.8" target="_blank" rel="noopener">ç¬¬4.4.8èŠ‚</a>æ´¾ç”Ÿçš„ã€‚è¿™æ ·çš„å¼•ç”¨æ ¹æ®æ–¹æ³•å¥æŸ„çš„ç±»å‹ç»™å‡ºäº†ç±»æˆ–æ¥å£çš„å­—æ®µï¼Œç±»çš„æ–¹æ³•æˆ–æ¥å£çš„æ–¹æ³•çš„ç¬¦å·å¼•ç”¨ã€‚</p><h3 id="4-6-CONSTANT-MethodType-infoç»“æ„"><a href="#4-6-CONSTANT-MethodType-infoç»“æ„" class="headerlink" title="4.6 CONSTANT_MethodType_infoç»“æ„"></a>4.6 CONSTANT_MethodType_infoç»“æ„</h3><p>æ–¹æ³•ç±»å‹çš„ç¬¦å·å¼•ç”¨æ˜¯ä»ç±»æˆ–æ¥å£çš„äºŒè¿›åˆ¶è¡¨ç¤ºå½¢å¼ä¸­çš„CONSTANT_MethodType_infoç»“æ„<a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html#jvms-4.4.9" target="_blank" rel="noopener">ç¬¬4.4.9èŠ‚</a>æ´¾ç”Ÿçš„ã€‚è¿™æ ·çš„å¼•ç”¨ç»™å‡ºäº†æ–¹æ³•æè¿°ç¬¦<a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html#jvms-4.3.3" target="_blank" rel="noopener">Â§4.3.3</a>ã€‚</p><h3 id="4-7-CONSTANT-InvokeDynamic-infoç»“æ„"><a href="#4-7-CONSTANT-InvokeDynamic-infoç»“æ„" class="headerlink" title="4.7 CONSTANT_InvokeDynamic_infoç»“æ„"></a>4.7 CONSTANT_InvokeDynamic_infoç»“æ„</h3><blockquote><h3 id="invokedynamic-instructions"><a href="#invokedynamic-instructions" class="headerlink" title="invokedynamic instructions"></a>invokedynamic instructions</h3><p>A dynamic call site is originally in an unlinked state. In this state, there is no target method for the call site to invoke.<br>åŠ¨æ€çš„è°ƒç”¨siteèµ·åˆå¤„åœ¨æœªè¿æ¥çš„çŠ¶æ€ã€‚åœ¨è¿™ç§çŠ¶æ€ä¸‹ï¼Œè°ƒç”¨siteæ²¡æœ‰è°ƒç”¨çš„ç›®æ ‡æ–¹æ³•ã€‚<br>Before the JVM can execute a dynamic call site (an invokedynamic instruction), the call site must first be linked. Linking is accomplished by calling a bootstrap method which is given the static information content of the call site, and which must produce a method handle that gives the behavior of the call site.<br>åœ¨JVMå¯ä»¥æ‰§è¡ŒåŠ¨æ€è°ƒç”¨siteï¼ˆinvokedynamicæŒ‡ä»¤ï¼‰ä¹‹å‰ï¼Œå¿…é¡»é¦–å…ˆè¿æ¥è°ƒç”¨siteã€‚è¿æ¥æ˜¯é€šè¿‡è°ƒç”¨ä¸€ä¸ªbootstrapæ–¹æ³•æ¥å®Œæˆçš„ï¼Œè¯¥æ–¹æ³•è¢«èµ‹äºˆäº†è°ƒç”¨ç«™ç‚¹çš„é™æ€ä¿¡æ¯å†…å®¹ï¼Œå¹¶ä¸”å¿…é¡»äº§ç”Ÿä¸€ä¸ªæ–¹æ³•å¥æŸ„æ¥ç»™å‡ºè°ƒç”¨ç«™ç‚¹çš„è¡Œä¸ºã€‚<br>Each invokedynamic instruction statically specifies its own bootstrap method as a constant pool reference. The constant pool reference also specifies the call siteâ€™s name and type descriptor, just like invokevirtual and the other invoke instructions.<br>æ¯ä¸ªinvokedynamicæŒ‡ä»¤é™æ€çš„å°†å®ƒè‡ªå·±çš„å¼•å¯¼æ–¹æ³•æŒ‡å®šä½œä¸ºä¸€ä¸ªå¸¸é‡æ± å¼•ç”¨ã€‚å¸¸é‡æ± å¼•ç”¨ä¹ŸæŒ‡å®šè°ƒç”¨siteçš„åç§°å’Œç±»å‹æè¿°ï¼Œå°±åƒinvokevirtualå’Œå…¶ä»–çš„è°ƒç”¨æè¿°ä¸€æ ·ã€‚<br>Linking starts with resolving the constant pool entry for the bootstrap method, and resolving a MethodType object for the type descriptor of the dynamic call site. This resolution process may trigger class loading. It may therefore throw an error if a class fails to load. This error becomes the abnormal termination of the dynamic call site execution. Linkage does not trigger class initialization.<br>è¿æ¥ä»è§£æå¼•å¯¼æ–¹æ³•çš„å¸¸é‡æ± æ¡ç›®å¼€å§‹ï¼Œå¹¶ä¸ºåŠ¨æ€è°ƒç”¨siteçš„ç±»å‹æè¿°ç¬¦è§£æMethodTypeå¯¹è±¡ã€‚è¿™ä¸ªè§£å†³çš„è¿›ç¨‹å¯èƒ½è§¦å‘ç±»åŠ è½½ã€‚å¦‚æœä¸€ä¸ªç±»åŠ è½½å¤±è´¥ï¼Œå¯èƒ½å› æ­¤æŠ›å‡ºä¸€ä¸ªerrorã€‚è¿™ä¸ªerrorå°†æˆä¸ºåŠ¨æ€è°ƒç”¨siteæ‰§è¡Œçš„å¼‚å¸¸ç»ˆæ­¢ã€‚è¿æ¥ä¸èƒ½è§¦å‘ç±»çš„åˆå§‹åŒ–ã€‚<br>The bootstrap method is invoked on at least three values:<br>å¼•å¯¼æ–¹æ³•è‡³å°‘ä½¿ç”¨3ä¸ªå€¼è°ƒç”¨:</p><ul><li>a MethodHandles.Lookup, a lookup object on the caller class in which dynamic call site occurs</li><li>ä¸€ä¸ªæ˜¯MethodHandles.Lookupï¼Œå‘ç”ŸåŠ¨æ€è°ƒç”¨siteçš„è°ƒç”¨ç±»ä¸Šçš„ä¸€ä¸ªlookupå¯¹è±¡ã€‚</li><li>a String, the method name mentioned in the call site</li><li>ä¸€ä¸ªå­—ç¬¦åˆ›ï¼Œåœ¨è°ƒç”¨siteä¸­æåˆ°çš„æ–¹æ³•åç§°ã€‚</li><li>a MethodType, the resolved type descriptor of the call</li><li>ä¸€ä¸ªMethodTypeï¼Œå·²è§£æçš„è°ƒç”¨çš„ç±»å‹æè¿°ã€‚</li><li>optionally, between 1 and 251 additional static arguments taken from the constant poolã€‚</li><li>å¯é€‰åœ°ï¼Œä»å¸¸é‡æ± ä¸­è·å–1åˆ°251ä¸ªé¢å¤–çš„é™æ€å‚æ•°ã€‚</li></ul></blockquote><p>å¯¹è°ƒç”¨ç«™ç‚¹è¯´æ˜ç¬¦çš„ç¬¦å·å¼•ç”¨æ˜¯ä»ç±»æˆ–æ¥å£çš„äºŒè¿›åˆ¶è¡¨ç¤ºå½¢å¼ä¸­çš„CONSTANT_InvokeDynamic_infoç»“æ„<a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html#jvms-4.4.10" target="_blank" rel="noopener">ç¬¬4.4.10èŠ‚</a>æ´¾ç”Ÿçš„ã€‚è¿™æ ·çš„å‚è€ƒç»™å‡ºï¼š</p><ul><li><p>æ–¹æ³•å¥æŸ„çš„ç¬¦å·å¼•ç”¨ï¼Œå®ƒå°†ä½œä¸ºinvokedynamicæŒ‡ä»¤çš„å¼•å¯¼æ–¹æ³•<a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-6.html#jvms-6.5.invokedynamic" target="_blank" rel="noopener">Â§invokedynamic</a>;</p></li><li><p>ä¸€ç³»åˆ—ç¬¦å·å¼•ç”¨(å¯¹ç±»ï¼Œæ–¹æ³•ç±»å‹å’Œæ–¹æ³•å¥æŸ„)ï¼Œå­—ç¬¦ä¸²æ–‡å­—å’Œè¿è¡Œæ—¶å¸¸é‡å€¼ï¼Œå®ƒä»¬å°†ä½œä¸ºå¼•å¯¼æ–¹æ³•çš„é™æ€å‚æ•°;</p></li><li><p>æ–¹æ³•åç§°å’Œæ–¹æ³•æè¿°ç¬¦ã€‚</p></li></ul><h3 id="4-8-CONSTANT-String-infoç»“æ„"><a href="#4-8-CONSTANT-String-infoç»“æ„" class="headerlink" title="4.8 CONSTANT_String_infoç»“æ„"></a>4.8 CONSTANT_String_infoç»“æ„</h3><p>æ­¤å¤–ï¼ŒæŸäº›ä¸æ˜¯ç¬¦å·å¼•ç”¨çš„è¿è¡Œæ—¶å€¼æ˜¯ä»constant_poolè¡¨ä¸­æ‰¾åˆ°çš„é¡¹æ´¾ç”Ÿçš„ï¼š</p><p>å­—ç¬¦ä¸²æ–‡å­—æ˜¯å¯¹ç±»Stringå®ä¾‹çš„å¼•ç”¨ï¼Œå®ƒæ˜¯ä»ç±»æˆ–æ¥å£çš„äºŒè¿›åˆ¶è¡¨ç¤ºå½¢å¼çš„CONSTANT_String_infoç»“æ„<a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html#jvms-4.4.3" target="_blank" rel="noopener">ç¬¬4.4.3èŠ‚</a>æ´¾ç”Ÿè€Œæ¥çš„ã€‚ CONSTANT_String_infoç»“æ„ç»™å‡ºäº†æ„æˆå­—ç¬¦ä¸²æ–‡å­—çš„Unicodeä»£ç ç‚¹åºåˆ—ã€‚</p><p>Javaç¼–ç¨‹è¯­è¨€è¦æ±‚ç›¸åŒçš„å­—ç¬¦ä¸²æ–‡å­—[å³åŒ…å«ç›¸åŒä»£ç ç‚¹åºåˆ—çš„æ–‡å­—]å¿…é¡»å¼•ç”¨ç±»Stringçš„ç›¸åŒå®ä¾‹(JLSÂ§3.10.5)ã€‚æ­¤å¤–ï¼Œå¦‚æœåœ¨ä»»ä½•å­—ç¬¦ä¸²ä¸Šè°ƒç”¨String.internæ–¹æ³•ï¼Œåˆ™ç»“æœæ˜¯å¯¹è¯¥å­—ç¬¦ä¸²æ˜¾ç¤ºä¸ºæ–‡å­—æ—¶å°†è¿”å›çš„åŒä¸€ç±»å®ä¾‹çš„å¼•ç”¨ã€‚å› æ­¤ï¼Œä»¥ä¸‹è¡¨è¾¾å¼çš„å€¼å¿…é¡»ä¸ºtrueï¼š</p><p><code>(&quot;a&quot;+&quot;b&quot;+&quot;c&quot;).intern()==&quot;abc&quot;</code></p><p>ä¸ºäº†æ´¾ç”Ÿå­—ç¬¦ä¸²æ–‡å­—ï¼ŒJavaè™šæ‹Ÿæœºæ£€æŸ¥CONSTANT_String_infoç»“æ„ç»™å‡ºçš„ä»£ç ç‚¹åºåˆ—ã€‚</p><p>å¦‚æœå…ˆå‰åœ¨ç±»Stringçš„å®ä¾‹ä¸Šè°ƒç”¨äº†String.internæ–¹æ³•ï¼Œè¯¥ç±»åŒ…å«ä¸CONSTANT_String_infoç»“æ„ç»™å‡ºçš„Unicodeä»£ç ç‚¹åºåˆ—ç›¸åŒçš„Unicodeä»£ç ç‚¹åºåˆ—ï¼Œåˆ™å­—ç¬¦ä¸²æ–‡å­—æ´¾ç”Ÿçš„ç»“æœæ˜¯å¯¹ç±»Stringçš„åŒä¸€å®ä¾‹çš„å¼•ç”¨ã€‚</p><p>å¦åˆ™ï¼Œå°†åˆ›å»ºä¸€ä¸ªç±»Stringçš„æ–°å®ä¾‹ï¼Œå…¶ä¸­åŒ…å«CONSTANT_String_infoç»“æ„ç»™å‡ºçš„Unicodeä»£ç ç‚¹åºåˆ—;å¯¹è¯¥ç±»å®ä¾‹çš„å¼•ç”¨æ˜¯å­—ç¬¦ä¸²æ–‡å­—æ´¾ç”Ÿçš„ç»“æœã€‚æœ€åï¼Œè°ƒç”¨æ–°Stringå®ä¾‹çš„internæ–¹æ³•ã€‚</p><h3 id="4-9-å…¶ä»–ç»“æ„"><a href="#4-9-å…¶ä»–ç»“æ„" class="headerlink" title="4.9 å…¶ä»–ç»“æ„"></a>4.9 å…¶ä»–ç»“æ„</h3><p>è¿è¡Œæ—¶å¸¸é‡å€¼æ˜¯ä»ç±»æˆ–æ¥å£çš„äºŒè¿›åˆ¶è¡¨ç¤ºå½¢å¼ä¸­çš„CONSTANT_Integer_infoï¼ŒCONSTANT_Float_infoï¼ŒCONSTANT_Long_infoæˆ–CONSTANT_Double_infoç»“æ„<a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html#jvms-4.4.4" target="_blank" rel="noopener">ç¬¬4.4.4èŠ‚ï¼Œç¬¬4.4.5èŠ‚</a>æ´¾ç”Ÿçš„ã€‚</p><p>è¯·æ³¨æ„ï¼ŒCONSTANT_Float_infoç»“æ„è¡¨ç¤ºIEEE 754å•ä¸€æ ¼å¼çš„å€¼ï¼ŒCONSTANT_Double_infoç»“æ„è¡¨ç¤ºIEEE 754åŒæ ¼å¼<a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html#jvms-4.4.4" target="_blank" rel="noopener">Â§4.4.4ï¼ŒÂ§4.4.5</a>ä¸­çš„å€¼ã€‚å› æ­¤ï¼Œä»è¿™äº›ç»“æ„å¯¼å‡ºçš„è¿è¡Œæ—¶å¸¸æ•°å€¼å¿…é¡»æ˜¯å¯ä»¥åˆ†åˆ«ä½¿ç”¨IEEE 754å•æ ¼å¼å’ŒåŒæ ¼å¼è¡¨ç¤ºçš„å€¼ã€‚</p><p>ç±»æˆ–æ¥å£çš„äºŒè¿›åˆ¶è¡¨ç¤ºçš„constant_poolè¡¨ä¸­çš„å…¶ä½™ç»“æ„ - CONSTANT_NameAndType_infoå’ŒCONSTANT_Utf8_infoç»“æ„<a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html#jvms-4.4.6" target="_blank" rel="noopener">Â§4.4.6ï¼ŒÂ§4.4.7</a> - ä»…åœ¨æ´¾ç”Ÿå¯¹ç±»ï¼Œæ¥å£ï¼Œæ–¹æ³•ï¼Œå­—æ®µçš„ç¬¦å·å¼•ç”¨æ—¶é—´æ¥ä½¿ç”¨ï¼Œæ–¹æ³•ç±»å‹å’Œæ–¹æ³•å¥æŸ„ï¼Œä»¥åŠæ´¾ç”Ÿå­—ç¬¦ä¸²æ–‡å­—å’Œè°ƒç”¨ç«™ç‚¹è¯´æ˜ç¬¦æ—¶ã€‚</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a href="https://www.infoq.cn/article/jdk-dynamically-typed-language/" target="_blank" rel="noopener">JavaåŠ¨æ€è¯­è¨€æ”¯æŒ â€“å‘¨å¿—æ˜</a></p><p><a href="">æ·±å…¥ç†è§£Javaè™šæ‹Ÿæœº</a></p><p><a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-5.html" target="_blank" rel="noopener">Chapter 5. Loading, Linking, and Initializing</a></p><p><a href="https://docs.oracle.com/javase/8/docs/api/java/lang/invoke/package-summary.html#package.description" target="_blank" rel="noopener">Package java.lang.invoke Description</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;ç¿»è¯‘è‡ª&lt;a href=&quot;https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-5.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Chapter 5. Loadin
      
    
    </summary>
    
    
      <category term="JVM" scheme="https://zhongyp.me/tags/JVM/"/>
    
      <category term="ç¿»è¯‘" scheme="https://zhongyp.me/tags/%E7%BF%BB%E8%AF%91/"/>
    
  </entry>
  
  <entry>
    <title>JVMå®˜æ–¹æ–‡æ¡£æŒ‡å—</title>
    <link href="https://zhongyp.me/jvm/2019-08-08-offical-document/"/>
    <id>https://zhongyp.me/jvm/2019-08-08-offical-document/</id>
    <published>2019-08-07T16:00:00.000Z</published>
    <updated>2019-08-11T11:01:42.708Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://docs.oracle.com/javase/specs/jvms/se8/html/index.html" target="_blank" rel="noopener">Javaè™šæ‹Ÿæœºè§„èŒƒ</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;a href=&quot;https://docs.oracle.com/javase/specs/jvms/se8/html/index.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Javaè™šæ‹Ÿæœºè§„èŒƒ&lt;/a&gt;&lt;/p&gt;

      
    
    </summary>
    
    
      <category term="JVM" scheme="https://zhongyp.me/tags/JVM/"/>
    
  </entry>
  
  <entry>
    <title>Spring Data Redisçš„executeå’ŒexecutePipelinedçš„åŒºåˆ«</title>
    <link href="https://zhongyp.me/redis/2019-08-06-execute-executePipelined/"/>
    <id>https://zhongyp.me/redis/2019-08-06-execute-executePipelined/</id>
    <published>2019-08-05T16:00:00.000Z</published>
    <updated>2019-09-05T06:31:08.333Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>Spring-data-redis 2.0.7.RELEASE</p></blockquote><h2 id="executePipelinedæ–¹æ³•è¯´æ˜"><a href="#executePipelinedæ–¹æ³•è¯´æ˜" class="headerlink" title="executePipelinedæ–¹æ³•è¯´æ˜"></a>executePipelinedæ–¹æ³•è¯´æ˜</h2><p>executePipelinedæ–¹æ³•åŸºäºRedisçš„pipeliningã€‚å…³äºpipeliningå®˜æ–¹è§£é‡Šå¦‚ä¸‹: </p><p>A Request/Response server can be implemented so that it is able to process new requests even if the client didnâ€™t already read the old responses. This way it is possible to send multiple commands to the server without waiting for the replies at all, and finally read the replies in a single step.<br>â€”æ‘˜è‡ª<a href="https://redis.io/topics/pipelining" target="_blank" rel="noopener">Redis Piplining</a></p><p>ä¸Šé¢çš„æ„æ€å¤§æ¦‚æ˜¯RedisæœåŠ¡å™¨å¯ä»¥å®ç°å³ä½¿æ²¡æœ‰è¯»å–æ—§å“åº”çš„æƒ…å†µä¸‹ä¹Ÿå¯ä»¥å‘é€æ–°çš„è¯·æ±‚ï¼Œä»¥è¿™ç§æ–¹å¼å¯ä»¥å‘é€å¤šä¸ªå‘½ä»¤åˆ°æœåŠ¡å™¨è€Œä¸ç”¨ç­‰å¾…å›å¤ï¼Œæœ€åä¸€æ¬¡è·å–å…¨éƒ¨çš„å›å¤ã€‚è¿™å°±æ˜¯Redis Pipeliningã€‚</p><p>executePipelinedçš„å®˜æ–¹æ³¨é‡Š:</p><p>Executes the given action object on a pipelined connection, returning the results. Note that the callback cannot return a non-null value as it gets overwritten by the pipeline. This method will use the default serializers to deserialize results.</p><p>ä¸Šé¢è¿™å¥è¯çš„æ„æ€åœ¨ä¸€ä¸ª<strong><em>ç®¡é“è¿æ¥</em></strong>ä¸­æ‰§è¡Œç»™å®šçš„åŠ¨ä½œå¯¹è±¡ï¼Œå¹¶è¿”å›ç»“æœã€‚ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯callbackä¸èƒ½è¿”å›ä¸€ä¸ªénullçš„å€¼ï¼Œcallbackçš„å€¼å°†è¢«pipelineè¦†ç›–ã€‚è¿™ä¸ªæ–¹æ³•å°†ä½¿ç”¨é»˜è®¤çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ–¹å¼å¤„ç†ç»“æœé›†ã€‚</p><p>ä¾‹ä¸¾executePipelined(SessionCallback&lt;?&gt; session, @Nullable RedisSerializer&lt;?&gt; resultSerializer) æ–¹æ³•æºç :</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">public List&lt;Object&gt; executePipelined(SessionCallback&lt;?&gt; session, @Nullable RedisSerializer&lt;?&gt; resultSerializer) &#123;</span><br><span class="line">        Assert.isTrue(this.initialized, &quot;template not initialized; call afterPropertiesSet() before using it&quot;);</span><br><span class="line">        Assert.notNull(session, &quot;Callback object must not be null&quot;);</span><br><span class="line">        RedisConnectionFactory factory = this.getRequiredConnectionFactory();</span><br><span class="line">        // æ˜¯å¦å¼€å¯äº‹åŠ¡ç®¡ç†ï¼Œå°†å½“å‰è¿æ¥æ³¨å†Œåˆ°äº‹åŠ¡ç®¡ç†å™¨</span><br><span class="line">        RedisConnectionUtils.bindConnection(factory, this.enableTransactionSupport);</span><br><span class="line"></span><br><span class="line">        List var4;</span><br><span class="line">        try &#123;</span><br><span class="line">            // this.executeå…¶å®å°±æ˜¯executeï¼Œæ‰€ä»¥æœ¬è´¨ä¸Šæ¥è¯´ï¼Œä¸¤ä¸ªæ–¹æ³•çš„åŒºåˆ«åœ¨äºexecutePipelineæ–¹æ³•å¼€å¯äº†pipeline</span><br><span class="line">            var4 = (List)this.execute((connection) -&gt; &#123;</span><br><span class="line">                // å¼€å¯ç®¡é“</span><br><span class="line">                connection.openPipeline();</span><br><span class="line">                boolean pipelinedClosed = false;</span><br><span class="line"></span><br><span class="line">                List var7;</span><br><span class="line">                try &#123;</span><br><span class="line">                    // åœ¨è¿æ¥ä¸­æ‰§è¡ŒSessionCallbackä¸­çš„åŠ¨ä½œï¼Œå¹¶è·å–ç»“æœé›†</span><br><span class="line">                    Object result = this.executeSession(session);</span><br><span class="line">                    // å¦‚æœç»“æœé›†ä¸ä¸ºç©ºï¼ŒæŠ›å‡ºInvalidDataAccessApiUsageException</span><br><span class="line">                    if (result != null) &#123;</span><br><span class="line">                        throw new InvalidDataAccessApiUsageException(&quot;Callback cannot return a non-null value as it gets overwritten by the pipeline&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    List&lt;Object&gt; closePipeline = connection.closePipeline();</span><br><span class="line">                    pipelinedClosed = true;</span><br><span class="line">                    // è·å–ç®¡é“è¿”å›çš„ç»“æœé›†å¹¶åºåˆ—åŒ–</span><br><span class="line">                    var7 = this.deserializeMixedResults(closePipeline, resultSerializer, this.hashKeySerializer, this.hashValueSerializer);</span><br><span class="line">                &#125; finally &#123;</span><br><span class="line">                    if (!pipelinedClosed) &#123;</span><br><span class="line">                        connection.closePipeline();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">                // è¿”å›ç®¡é“çš„ç»“æœé›†</span><br><span class="line">                return var7;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            RedisConnectionUtils.unbindConnection(factory);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return var4;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç ä¸­<code>this.execute((connection)...</code>å…¶å®å°±æ˜¯execute(RedisCallback&lt;?&gt; session)æ–¹æ³•ã€‚æ‰€ä»¥executePipelinedæ–¹æ³•åªæ˜¯åœ¨executeå†…ä¸­å¼€å¯äº†pipelineè€Œå·²ã€‚</p><h2 id="executeæ–¹æ³•è¯´æ˜"><a href="#executeæ–¹æ³•è¯´æ˜" class="headerlink" title="executeæ–¹æ³•è¯´æ˜"></a>executeæ–¹æ³•è¯´æ˜</h2><p>executeç›¸å¯¹äº<code>executePipelined(SessionCallback&lt;?&gt; session)</code>æ¯”è¾ƒç®€å•ï¼Œæ²¡æœ‰è¿‡å¤šçš„å¤„ç†ï¼Œè€Œæ˜¯ç›´æ¥æ‰§è¡ŒSessionCallbackä¸­çš„åŠ¨ä½œï¼Œå®˜æ–¹æ³¨é‡Šå¦‚ä¸‹:</p><p>Executes a Redis session. Allows multiple operations to be executed in the same session enabling â€˜transactionalâ€™ capabilities through RedisOperations.multi() and RedisOperations.watch(Collection) operations.</p><p>å¤§æ¦‚æ„æ€æ˜¯æ‰§è¡Œä¸€ä¸ªRedisä¼šè¯ã€‚å…è®¸åœ¨<strong><em>åŒä¸€ä¼šè¯</em></strong>ä¸­æ‰§è¡Œå¤šä¸ªæ“ä½œï¼Œé€šè¿‡RedisOperations.multi()å’ŒRedisOperations.watch(Collection)æ“ä½œå¯ç”¨â€œäº‹åŠ¡â€åŠŸèƒ½ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public &lt;T&gt; T execute(SessionCallback&lt;T&gt; session) &#123;</span><br><span class="line">        Assert.isTrue(this.initialized, &quot;template not initialized; call afterPropertiesSet() before using it&quot;);</span><br><span class="line">        Assert.notNull(session, &quot;Callback object must not be null&quot;);</span><br><span class="line">        RedisConnectionFactory factory = this.getRequiredConnectionFactory();</span><br><span class="line">        RedisConnectionUtils.bindConnection(factory, this.enableTransactionSupport);</span><br><span class="line"></span><br><span class="line">        Object var3;</span><br><span class="line">        try &#123;</span><br><span class="line">            // æ‰§è¡ŒSessionCallbackå¹¶è·å–æ‰§è¡ŒSessionCallbackè¿”å›çš„ç»“æœé›†</span><br><span class="line">            var3 = session.execute(this);</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            RedisConnectionUtils.unbindConnection(factory);</span><br><span class="line">        &#125;</span><br><span class="line">        // ç›´æ¥è¿”å›ç»“æœé›†</span><br><span class="line">        return var3;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="executeå’ŒexecutePipelinedåŒºåˆ«"><a href="#executeå’ŒexecutePipelinedåŒºåˆ«" class="headerlink" title="executeå’ŒexecutePipelinedåŒºåˆ«"></a>executeå’ŒexecutePipelinedåŒºåˆ«</h2><p>ä»ä¸Šé¢ä¸¤æ®µæºç ç¤ºä¾‹å¯ä»¥çœ‹å‡ºï¼Œexecuteå’ŒexecutePipelinedçš„æœ€ä¸»è¦åŒºåˆ«æ˜¯executePipelinedå¼€å¯äº†pipelineã€‚piplineä¸executeæ­£å¸¸çš„è¯·æ±‚/å“åº”çš„åŒºåˆ«ä¸»è¦åœ¨äºè¯·æ±‚/å“åº”æ¨¡å¼ä¸Šï¼Œexecuteæ˜¯ä¸²è¡ŒåŒ–çš„å‘½ä»¤è¯·æ±‚ï¼ŒexecutePipelinedè¯·æ±‚ä¸å“åº”åˆ™æ˜¯ç©¿æ’è¿›è¡Œã€‚ä¸¤è€…åŒºåˆ«å¦‚å›¾æ‰€ç¤º:<br>ä¸²è¡Œ:<br><img src="/media/article/redis-execute.png" alt="redis-execute"></p><p>executeæ–¹æ³•æ˜¯ä¸²è¡Œçš„ï¼Œå‘½ä»¤è¯·æ±‚å‘å‡ºåï¼Œå¿…é¡»å¾—åˆ°å“åº”æ•°æ®ï¼Œæ‰èƒ½å‘é€ä¸‹ä¸€æ¡å‘½ä»¤è¯·æ±‚ã€‚æ‰€ä»¥åœ¨ä¸€æ¬¡Redisä¼šè¯ä¸­ï¼Œä¸€æ¬¡ä¼šè¯å¯èƒ½åŒ…å«å¤šæ¬¡è¯·æ±‚ï¼Œå³å¤šæ¬¡RTTã€‚</p><p>ç©¿æ’:</p><p><img src="/media/article/redis-executepipeline.png" alt="redis-executepipeline.png"></p><p>executePipelinedæ˜¯ç©¿æ’çš„ï¼Œå¯ä»¥æ‰¹é‡å‘é€å‘½ä»¤åˆ°æœåŠ¡å™¨ï¼Œä¹Ÿå¯ä»¥æ‰¹é‡è·å–å“åº”æ•°æ®ã€‚å³å¯èƒ½ä½¿ç”¨ä¸€æ¬¡RTTå°±èƒ½å®Œæˆæ‰¹é‡æ“ä½œã€‚</p><p>é™¤äº†ç½‘ç»œåè®®ä¸Šçš„åŒºåˆ«å¤–ï¼Œexecuteå’ŒexecutePipelinedéƒ½æ”¯æŒäº‹åŠ¡ç®¡ç†å™¨ï¼Œæ”¯æŒmultiï¼Œwatchï¼Œexecï¼Œdiscardç­‰äº‹åŠ¡æ“ä½œï¼Œä¸è¿‡executeä¸executePipelinedçš„è¿™äº›æ“ä½œè¿˜æ˜¯æœ‰äº›åŒºåˆ«çš„ã€‚</p><p>ä¾‹å¦‚ JedisConnectionå¼€å¯multi:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public void multi() &#123;</span><br><span class="line">   if (!this.isQueueing()) &#123;</span><br><span class="line">       try &#123;</span><br><span class="line">           if (this.isPipelined()) &#123;</span><br><span class="line">               // å¦‚æœå¼€å¯äº†pipelineï¼Œåˆ™ä½¿ç”¨Pipelineå†…éƒ¨çš„multi</span><br><span class="line">               // Pipelineç»‘å®šçš„æ˜¯client</span><br><span class="line">               this.getRequiredPipeline().multi();</span><br><span class="line">           &#125; else &#123;</span><br><span class="line">               // æ²¡æœ‰å¼€å¯pipelineä½¿ç”¨jedisçš„multi</span><br><span class="line">               // jedisçš„multiç»‘å®šçš„æ˜¯connection</span><br><span class="line">               this.transaction = this.jedis.multi();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; catch (Exception var2) &#123;</span><br><span class="line">           throw this.convertJedisAccessException(var2);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>jedisä¸Pipelineçš„å‘½ä»¤ç»‘å®šçš„å¯¹è±¡ä¸ä¸€æ ·ï¼Œå‰è€…ç»‘å®šçš„æ˜¯connectionï¼Œåè€…ç»‘å®šclientã€‚è¿™å’Œä¸Šé¢æåˆ°çš„è¯·æ±‚/å“åº”æ¨¡å¼æœ‰å…³ã€‚<br>watchï¼Œexecï¼Œdiscardç­‰æ“ä½œä¹Ÿæ˜¯å¦‚æ­¤ã€‚</p><p>é™¤æ­¤ä¹‹å¤–ï¼ŒexecutePipelinedçš„SessionCallbackæ˜¯ä¸èƒ½æœ‰è¿”å›å€¼çš„ï¼ŒexecutePipelinedéœ€è¦è¿”å›Piplelineçš„è¿”å›å€¼ã€‚</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a href="https://blog.csdn.net/wuxian90/article/details/81322536" target="_blank" rel="noopener">Rediså®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯äº¤äº’è¯¦è§£</a></p><p><a href="https://redis.io/topics/pipelining" target="_blank" rel="noopener">pipelining</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;Spring-data-redis 2.0.7.RELEASE&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;executePipelinedæ–¹æ³•è¯´æ˜&quot;&gt;&lt;a href=&quot;#executePipelinedæ–¹æ³•è¯´æ˜&quot; class=&quot;heade
      
    
    </summary>
    
    
      <category term="redis" scheme="https://zhongyp.me/tags/redis/"/>
    
      <category term="FAQ" scheme="https://zhongyp.me/tags/FAQ/"/>
    
  </entry>
  
  <entry>
    <title>Redis è®¾è®¡ä¸å®ç°</title>
    <link href="https://zhongyp.me/redis/2019-06-21-redis/"/>
    <id>https://zhongyp.me/redis/2019-06-21-redis/</id>
    <published>2019-06-20T16:00:00.000Z</published>
    <updated>2019-07-19T11:22:00.326Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-æ•°æ®ç»“æ„ä¸å¯¹è±¡"><a href="#1-æ•°æ®ç»“æ„ä¸å¯¹è±¡" class="headerlink" title="1. æ•°æ®ç»“æ„ä¸å¯¹è±¡"></a>1. æ•°æ®ç»“æ„ä¸å¯¹è±¡</h2><h3 id="1-1-ç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆSDSï¼‰"><a href="#1-1-ç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆSDSï¼‰" class="headerlink" title="1.1 ç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆSDSï¼‰"></a>1.1 ç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆSDSï¼‰</h3><p>Redisæ²¡æœ‰ä½¿ç”¨Cè¯­è¨€ä¼ ç»Ÿçš„å­—ç¬¦ä¸²è¡¨ç¤ºï¼Œè€Œæ˜¯æ„å»ºäº†ä¸€ç§ç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆsimple dynamic stringï¼ŒSDSï¼‰çš„æŠ½è±¡ç±»å‹ï¼Œå¹¶å°†SDSç”¨ä½œRedisçš„é»˜è®¤å­—ç¬¦ä¸²è¡¨ç¤ºã€‚Redisåªä¼šä½¿ç”¨Cå­—ç¬¦ä¸²ä½œä¸ºå­—é¢é‡ã€‚<br>é™¤äº†ç”¨æ¥ä¿å­˜æ•°æ®åº“ä¸­çš„å­—ç¬¦ä¸²å€¼ä¹‹å¤–ï¼ŒSDSè¿˜è¢«ç”¨åšç¼“å†²åŒº(buffer): AOFæ¨¡å—ä¸­çš„AOFç¼“å†²åŒºï¼Œä»¥åŠå®¢æˆ·ç«¯çŠ¶æ€ä¸­çš„è¾“å…¥ç¼“å†²åŒºï¼Œéƒ½æ˜¯SDSå®ç°çš„ã€‚</p><blockquote><p>åœ¨è®¡ç®—æœºç§‘å­¦ä¸­ï¼Œå­—é¢é‡ï¼ˆliteralï¼‰æ˜¯ç”¨äºè¡¨è¾¾æºä»£ç ä¸­ä¸€ä¸ªå›ºå®šå€¼çš„è¡¨ç¤ºæ³•ï¼ˆnotationï¼‰ã€‚</p></blockquote><h4 id="1-1-1-SDSçš„å®šä¹‰"><a href="#1-1-1-SDSçš„å®šä¹‰" class="headerlink" title="1.1.1 SDSçš„å®šä¹‰"></a>1.1.1 SDSçš„å®šä¹‰</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">struct sdshdr&#123;</span><br><span class="line">    // è®°å½•bufæ•°ç»„ä¸­å·²ä½¿ç”¨å­—èŠ‚çš„æ•°é‡</span><br><span class="line">    // ç­‰äºSDSæ‰€ä¿å­˜å­—ç¬¦ä¸²çš„é•¿åº¦</span><br><span class="line">    int len;</span><br><span class="line">    // è®°å½•bufæ•°ç»„ä¸­æœªä½¿ç”¨å­—èŠ‚çš„æ•°é‡</span><br><span class="line">    int free;</span><br><span class="line">    // å­—èŠ‚æ•°ç»„ï¼Œç”¨äºä¿å­˜å­—ç¬¦ä¸²</span><br><span class="line">    char buf[];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/media/article/15611092689335.jpg" alt="SDSç¤ºä¾‹"></p><p>SDSéµå¾ªCå­—ç¬¦ä¸²ä»¥ç©ºå­—ç¬¦ç»“å°¾çš„æƒ¯ä¾‹ï¼Œä¿å­˜ç©ºå­—ç¬¦çš„1å­—èŠ‚ç©ºé—´ä¸è®¡ç®—åœ¨SDSçš„lenå±æ€§é‡Œé¢ã€‚</p><h4 id="1-1-2-ä¸Cå­—ç¬¦ä¸²çš„åŒºåˆ«"><a href="#1-1-2-ä¸Cå­—ç¬¦ä¸²çš„åŒºåˆ«" class="headerlink" title="1.1.2 ä¸Cå­—ç¬¦ä¸²çš„åŒºåˆ«"></a>1.1.2 ä¸Cå­—ç¬¦ä¸²çš„åŒºåˆ«</h4><ol><li>è·å–å­—ç¬¦ä¸²é•¿åº¦å¤æ‚åº¦ï¼šCå­—ç¬¦ä¸²ä¸è®°å½•é•¿åº¦ä¿¡æ¯ï¼Œæ‰€ä»¥è·å–å­—ç¬¦ä¸²é•¿åº¦å¤æ‚åº¦ä¸ºO(N)ï¼ŒSDSä¸ºO(1)ã€‚</li><li>æœç»ç¼“å†²åŒºæº¢å‡ºï¼š<code>strcat</code>å‡½æ•°å¯ä»¥å°†srcå­—ç¬¦ä¸²ä¸­çš„å†…å®¹æ‹¼æ¥åˆ°destå­—ç¬¦ä¸²çš„æœ«å°¾:<br><code>char *strcat(char *dest, const char *src)</code><br>å› ä¸ºCå­—ç¬¦åˆ›ä¸è®°å½•è‡ªèº«çš„é•¿åº¦ï¼Œæ‰€ä»¥<code>strcat</code>å‡å®šç”¨æˆ·åœ¨æ‰§è¡Œè¿™ä¸ªå‡½æ•°æ—¶ï¼Œå·²ç»ä¸ºdeståˆ†é…äº†è¶³å¤Ÿå¤šçš„å†…å­˜ï¼Œå¯ä»¥å®¹çº³srcå­—ç¬¦ä¸²ä¸­çš„æ‰€æœ‰å†…å®¹ï¼Œè€Œä¸€æ—¦è¿™ä¸ªå‡å®šä¸æˆç«‹ï¼Œå°±ä¼šäº§ç”Ÿç¼“å†²åŒºæº¢å‡ºã€‚SDSåœ¨æ‰§è¡Œæ‹¼æ¥æ“ä½œä¹‹å‰æ£€æŸ¥sçš„é•¿åº¦æ˜¯å¦è¶³å¤Ÿï¼Œåœ¨å‘ç°sç›®å‰çš„ç©ºé—´ä¸è¶³ä»¥æ‹¼æ¥æ—¶ï¼Œsdscatå°±ä¼šæ‰©å±•sçš„ç©ºé—´ï¼Œç„¶åæ‰§è¡Œæ‹¼æ¥æ“ä½œã€‚</li><li>å‡å°‘ä¿®æ”¹å­—ç¬¦ä¸²æ—¶å¸¦æ¥çš„å†…å­˜é‡åˆ†é…æ¬¡æ•°ï¼šbä¸­è¯´é“æ¯æ¬¡æ‹¼æ¥å­—ç¬¦ä¸²æ—¶ï¼ŒCå­—ç¬¦ä¸²éƒ½è¦å¯¹Cå­—ç¬¦ä¸²è¿›è¡Œä¸€æ¬¡å†…å­˜é‡åˆ†é…æ“ä½œï¼ˆå³ï¼šåœ¨æ‹¼æ¥æ“ä½œï¼Œéœ€è¦æ‰©å±•ç©ºé—´å¤§å°ï¼Œå¦åˆ™ç¼“å†²åŒºæº¢å‡ºï¼›åœ¨æˆªæ–­æ“ä½œï¼Œéœ€è¦é‡Šæ”¾å¤šä½™ç©ºé—´ï¼Œå¦åˆ™å†…å­˜æ³„æ¼ï¼‰ï¼Œå› ä¸ºé‡åˆ†é…æ˜¯æ¯”è¾ƒè€—æ—¶çš„æ“ä½œï¼Œæ‰€ä»¥ä¸ºäº†é¿å…é¢‘ç¹ä¿®æ”¹å­—ç¬¦ä¸²å¯¹æ€§èƒ½é€ æˆçš„å½±å“ï¼ŒSDSé€šè¿‡æœªä½¿ç”¨ç©ºé—´æ¥è§¦äº†å­—ç¬¦ä¸²é•¿åº¦å’Œåº•å±‚æ•°ç»„é•¿åº¦ä¹‹é—´çš„å…³è”ï¼šSDSä¸­ï¼Œbufçš„é•¿åº¦ä¸ä¸€å®šæ˜¯å­—ç¬¦æ•°é‡+1ï¼Œæ•°ç»„é‡Œé¢å¯ä»¥åŒ…å«æœªä½¿ç”¨çš„å­—èŠ‚ï¼Œè€Œè¿™äº›å­—èŠ‚çš„æ•°é‡å°±ç”±SDSçš„freeå±æ€§è®°å½•ã€‚é€šè¿‡æœªä½¿ç”¨ç©ºé—´ï¼ŒSDSå®ç°äº†ç©ºé—´é¢„åˆ†é…å’Œæƒ°æ€§ç©ºé—´é‡Šæ”¾ä¸¤ç§ä¼˜åŒ–ç­–ç•¥ã€‚</li></ol><blockquote><p>ç©ºé—´é¢„åˆ†é…</p><ul><li>å¦‚æœå¯¹SDSè¿›è¡Œä¿®æ”¹ä¹‹åï¼ŒSDSçš„é•¿åº¦å°äº1MBï¼Œé‚£ä¹ˆç¨‹åºåˆ†é…å’Œlenå±æ€§åŒæ ·å¤§å°çš„æœªä½¿ç”¨ç©ºé—´ï¼Œè¿™æ—¶SDS lenå±æ€§çš„å€¼å°†å’Œfreeå±æ€§çš„å€¼ç›¸åŒã€‚</li><li>å¦‚æœå¯¹SDSä¿®æ”¹ä¹‹åï¼ŒSDSçš„é•¿åº¦å¤§äº1MBï¼Œé‚£ä¹ˆç¨‹åºä¼šåˆ†é…1MBçš„æœªä½¿ç”¨ç©ºé—´ã€‚</li></ul><p>æƒ°æ€§ç©ºé—´é‡Šæ”¾</p><ul><li>å½“ SDSçš„APIéœ€è¦ç¼©çŸ­SDSä¿å­˜çš„å­—ç¬¦ä¸²æ—¶ï¼Œç¨‹åºå¹¶ä¸ç«‹å³ä½¿ç”¨å†…å­˜é‡åˆ†é…æ¥å›æ”¶ç¼©çŸ­åå¤šå‡ºæ¥çš„å­—èŠ‚ï¼Œè€Œæ˜¯ä½¿ç”¨freeå±æ€§å°†è¿™äº›å­—èŠ‚çš„æ•°é‡è®°å½•ä¸‹æ¥ï¼Œå¹¶ç­‰å¾…å°†æ¥ä½¿ç”¨ã€‚åŒæ—¶SDSæä¾›äº†ç›¸åº”çš„APIï¼Œåœ¨æœ‰éœ€è¦æ—¶ï¼Œé‡Šæ”¾SDSæœªä½¿ç”¨çš„ç©ºé—´ï¼Œè¿™æ ·å°±å¯ä»¥é¿å…æƒ°æ€§ç©ºé—´é‡Šæ”¾ç­–ç•¥ä¼šé€ æˆå†…å­˜æµªè´¹ã€‚</li></ul></blockquote><h4 id="1-1-3-äºŒè¿›åˆ¶å®‰å…¨"><a href="#1-1-3-äºŒè¿›åˆ¶å®‰å…¨" class="headerlink" title="1.1.3 äºŒè¿›åˆ¶å®‰å…¨"></a>1.1.3 äºŒè¿›åˆ¶å®‰å…¨</h4><p>Cè¯­è¨€å­—ç¬¦ä¸²ä¸­çš„å­—ç¬¦å¿…é¡»ç¬¦åˆæŸç§ç¼–ç ï¼ˆæ¯”å¦‚ASCIIï¼‰ï¼Œå¹¶ä¸”é™¤äº†å­—ç¬¦ä¸²çš„æœ«å°¾ä¹‹å¤–ï¼Œå­—ç¬¦ä¸²é‡Œé¢ä¸èƒ½åŒ…å«ç©ºå­—ç¬¦ä¸²ï¼Œæ‰€ä»¥Cå­—ç¬¦ä¸²åªèƒ½ä¿å­˜æ–‡æœ¬æ•°æ®ï¼Œä¸èƒ½ä¿å­˜äºŒè¿›åˆ¶æ•°æ®ã€‚<br>SDSçš„APIéƒ½æ˜¯äºŒè¿›åˆ¶å®‰å…¨(binary-safe)çš„ã€‚</p><h4 id="1-1-4-å…¼å®¹éƒ¨åˆ†Cå­—ç¬¦ä¸²çš„å‡½æ•°"><a href="#1-1-4-å…¼å®¹éƒ¨åˆ†Cå­—ç¬¦ä¸²çš„å‡½æ•°" class="headerlink" title="1.1.4 å…¼å®¹éƒ¨åˆ†Cå­—ç¬¦ä¸²çš„å‡½æ•°"></a>1.1.4 å…¼å®¹éƒ¨åˆ†Cå­—ç¬¦ä¸²çš„å‡½æ•°</h4><p>è™½ç„¶SDSçš„APIéƒ½æ˜¯äºŒè¿›åˆ¶å®‰å…¨çš„ï¼Œä½†æ˜¯APIæ€»ä¼šå°†SDSä¿å­˜çš„æ•°æ®çš„æœ«å°¾è®¾ç½®ä¸ºç©ºå­—ç¬¦ä¸²ï¼Œè¿™æ˜¯ä¸ºäº†è®©é‚£äº›ä¿å­˜æ–‡æœ¬æ•°æ®çš„SDSå¯ä»¥é‡ç”¨ä¸€éƒ¨åˆ†&lt;string.h&gt;åº“å®šä¹‰çš„å‡½æ•°ã€‚</p><h3 id="1-2-é“¾è¡¨"><a href="#1-2-é“¾è¡¨" class="headerlink" title="1.2 é“¾è¡¨"></a>1.2 é“¾è¡¨</h3><p>å½“ä¸€ä¸ªåˆ—è¡¨é”®åŒ…å«æ•°é‡æ¯”è¾ƒå¤šçš„å…ƒç´ ï¼Œåˆæˆ–è€…åŒ…å«çš„å…ƒç´ éƒ½æ˜¯æ¯”è¾ƒé•¿çš„å­—ç¬¦ä¸²æ—¶ï¼ŒRediså°±ä¼šä½¿ç”¨é“¾è¡¨ä½œä¸ºåˆ—è¡¨é”®çš„åº•å±‚å®ç°ã€‚é™¤äº†é“¾è¡¨é”®ä¹‹å¤–ï¼Œå‘å¸ƒä¸è®¢é˜…ã€æ…¢æŸ¥è¯¢ã€ç›‘è§†å™¨ç­‰åŠŸèƒ½ä¹Ÿç”¨åˆ°äº†é“¾è¡¨ï¼ŒRedisæœåŠ¡å™¨æœ¬èº«è¿˜æ˜¯ç”¨é“¾è¡¨æ¥ä¿å­˜å¤šä¸ªå®¢æˆ·ç«¯çš„çŠ¶æ€ä¿¡æ¯ï¼Œä»¥åŠä½¿ç”¨é“¾è¡¨æ¥æ„å»ºå®¢æˆ·ç«¯è¾“å‡ºç¼“å†²åŒº(output buffer)ã€‚</p><p>Redisçš„é“¾è¡¨å®ç°çš„ç‰¹æ€§å¯ä»¥æ€»ç»“å¦‚ä¸‹ï¼š</p><ul><li>åŒç«¯ï¼šé“¾è¡¨èŠ‚ç‚¹å¸¦æœ‰prevå’ŒnextæŒ‡é’ˆï¼Œè·å–æŸä¸ªèŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹å’Œåç½®èŠ‚ç‚¹çš„å¤æ‚åº¦éƒ½æ˜¯O(1)ã€‚</li><li>æ— ç¯ï¼šè¡¨å¤´èŠ‚ç‚¹çš„prevæŒ‡é’ˆå’Œè¡¨å°¾èŠ‚ç‚¹çš„nextæŒ‡é’ˆéƒ½æŒ‡å‘NULLï¼Œå¯¹é“¾è¡¨çš„è®¿é—®ä»¥NULLä¸ºç»ˆç‚¹ã€‚</li><li>å¸¦è¡¨å¤´æŒ‡é’ˆå’Œè¡¨å°¾æŒ‡é’ˆï¼šé€šè¿‡listç»“æ„çš„headæŒ‡é’ˆå’ŒtailæŒ‡é’ˆï¼Œç¨‹åºè·å–é“¾è¡¨çš„è¡¨å¤´èŠ‚ç‚¹å’Œè¡¨å°¾èŠ‚ç‚¹çš„å¤æ‚åº¦ä¸ºO(1)ã€‚</li><li>å¸¦é“¾è¡¨é•¿åº¦çš„è®¡æ•°å™¨ï¼šç¨‹åºä½¿ç”¨listç»“æ„çš„lenå±æ€§æ¥å¯¹listæŒæœ‰çš„é“¾è¡¨èŠ‚ç‚¹è¿›è¡Œè®¡æ•°ï¼Œç¨‹åºè·å–é“¾è¡¨ä¸­èŠ‚ç‚¹æ•°é‡çš„å¤æ‚åº¦ä¸ºO(1)ã€‚</li><li>å¤šæ€ï¼šé“¾è¡¨èŠ‚ç‚¹ä½¿ç”¨void*æŒ‡é’ˆæ¥ä¿å­˜èŠ‚ç‚¹å€¼ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡listç»“æ„çš„dupã€freeã€matchä¸‰ä¸ªå±æ€§ä¸ºèŠ‚ç‚¹å€¼è®¾ç½®ç±»å‹ç‰¹å®šå‡½æ•°ï¼Œæ‰€ä»¥é“¾è¡¨å¯ä»¥ç”¨äºä¿å­˜å„ç§ä¸åŒç±»å‹çš„å€¼ã€‚</li></ul><h3 id="1-3-å­—å…¸"><a href="#1-3-å­—å…¸" class="headerlink" title="1.3 å­—å…¸"></a>1.3 å­—å…¸</h3><h4 id="1-3-1-ç»“æ„"><a href="#1-3-1-ç»“æ„" class="headerlink" title="1.3.1 ç»“æ„"></a>1.3.1 ç»“æ„</h4><p>å­—å…¸ï¼Œåˆç§°ä¸ºç¬¦å·è¡¨(symbol table)ã€å…³è”æ•°ç»„(associative array)æˆ–æ˜ å°„(map)ï¼Œæ˜¯ä¸€ç§ç”¨äºä¿å­˜é”®å€¼å¯¹(key-value pair)çš„æŠ½è±¡æ•°æ®ç»“æ„ã€‚</p><p>Redisçš„å­—å…¸ä½¿ç”¨å“ˆå¸Œè¡¨ä½œä¸ºåº•å±‚å®ç°ï¼Œä¸€ä¸ªå“ˆå¸Œè¡¨é‡Œé¢å¯ä»¥æœ‰å¤šä¸ªå“ˆå¸Œè¡¨èŠ‚ç‚¹ï¼Œè€Œæ¯ä¸ªå“ˆå¸Œè¡¨èŠ‚ç‚¹å°±ä¿å­˜äº†å­—å…¸ä¸­çš„ä¸€ä¸ªé”®å€¼å¯¹ã€‚</p><p>å­—å…¸ç»“æ„ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">typedef struct dict&#123;</span><br><span class="line">    // ç±»å‹ç‰¹å®šå‡½æ•°</span><br><span class="line">    dicType *type;</span><br><span class="line">    </span><br><span class="line">    // ç§æœ‰æ•°æ®</span><br><span class="line">    void *privdata;</span><br><span class="line">    </span><br><span class="line">    // å“ˆå¸Œè¡¨</span><br><span class="line">    dictht ht[2];</span><br><span class="line">    </span><br><span class="line">    // rehashç´¢å¼•</span><br><span class="line">    // å½“rehashä¸åœ¨è¿›è¡Œæ—¶ï¼Œå€¼ä¸º-1</span><br><span class="line">    in threhash; /* rehashing not in progress if rehashidx == -1 */</span><br><span class="line"></span><br><span class="line">&#125; dict;</span><br></pre></td></tr></table></figure><p>typeå±æ€§æ˜¯ä¸€ä¸ªæŒ‡å‘dictTypeç»“æ„çš„æŒ‡é’ˆï¼Œæ¯ä¸ªdictTypeç»“æ„ä¿å­˜äº†ä¸€ç°‡ç”¨äºç‰¹å®šç±»å‹é”®å€¼å¯¹çš„å‡½æ•°ï¼ŒRedisä¼šä¸ºç”¨é€”ä¸åŒçš„å­—å…¸è®¾ç½®ä¸åŒçš„ç±»å‹ç‰¹å®šå‡½æ•°ã€‚<br>pridataå±æ€§åˆ™ä¿å­˜äº†éœ€è¦ä¼ ç»™é‚£äº›ç±»å‹ç‰¹å®šå‡½æ•°çš„å¯é€‰å‚æ•°ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">typedef struct dicType&#123;</span><br><span class="line"></span><br><span class="line">// è®¡ç®—å“ˆå¸Œå€¼çš„å‡½æ•°</span><br><span class="line">unsigned int (*hashFunction)(const void *key);</span><br><span class="line"></span><br><span class="line">// å¤åˆ¶é”®çš„å‡½æ•°</span><br><span class="line">void *(*keyDup)(void *privdata, const void *key);</span><br><span class="line"></span><br><span class="line">// å¯¹æ¯”é”®çš„å‡½æ•°</span><br><span class="line">int (*keyCompare)(void *privdata,const void *key1,const void *key);</span><br><span class="line"></span><br><span class="line">// é”€æ¯é”®</span><br><span class="line">(*keyDestructor)(void *privdata,void *key);</span><br><span class="line"></span><br><span class="line">// å¤åˆ¶å€¼</span><br><span class="line">void(*valDup)(void *privdata, const void *obj);</span><br><span class="line"></span><br><span class="line">// é”€æ¯å€¼</span><br><span class="line">void(*valDestructor)(void *privdata,void *obj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>htå±æ€§æ˜¯ä¸€ä¸ªåŒ…å«ä¸¤ä¸ªé¡¹çš„æ•°ç»„ï¼Œæ•°ç»„çš„æ¯é¡¹éƒ½æ˜¯dicthtå“ˆå¸Œè¡¨ï¼Œä¸€èˆ¬æƒ…å†µä¸‹åªæ˜¯ç”¨ht[0]ï¼Œht[1]åªä¼šåœ¨å¯¹ht[0]å“ˆå¸Œè¡¨è¿›è¡Œrehashæ—¶ä½¿ç”¨ã€‚<br>é™¤ht[1]ä¹‹å¤–ï¼Œå¦ä¸€ä¸ªå’Œrehashæœ‰å…³çš„å±æ€§å°±æ˜¯rehashidxï¼Œå®ƒè®°å½•äº†rehashç›®å‰çš„è¿›åº¦ï¼Œå¦‚æœç›®å‰æ²¡æœ‰è¿›è¡Œrehashï¼Œé‚£ä¹ˆå®ƒçš„å€¼ä¸º-1ã€‚<br><img src="/media/article/dicht.png" alt="dic"></p><h4 id="1-3-2-å“ˆå¸Œç®—æ³•"><a href="#1-3-2-å“ˆå¸Œç®—æ³•" class="headerlink" title="1.3.2 å“ˆå¸Œç®—æ³•"></a>1.3.2 å“ˆå¸Œç®—æ³•</h4><p>Redisä½¿ç”¨çš„æ˜¯<a href="http://code.google.com/p/smhasher/" target="_blank" rel="noopener">MurmurHash2</a>ç®—æ³•ã€‚</p><ol><li>ç®—å‡ºhashå€¼ï¼šhash=dict-&gt;type-&gt;hashFunction(key);</li><li>æ ¹æ®hashå€¼è®¡ç®—ç´¢å¼•å€¼ï¼šindex = hash &amp; dict-&gt;ht[x].sizemask;//xæ˜¯0æˆ–1</li></ol><h4 id="1-3-4-é”®å†²çª"><a href="#1-3-4-é”®å†²çª" class="headerlink" title="1.3.4 é”®å†²çª"></a>1.3.4 é”®å†²çª</h4><p>Redisçš„å“ˆå¸Œè¡¨ä½¿ç”¨é“¾åœ°å€æ³•(separate chaining)æ¥è§£å†³å†²çªï¼Œæ¯ä¸ªå“ˆå¸Œè¡¨èŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ªnextæŒ‡é’ˆï¼Œå¤šä¸ªå“ˆå¸Œè¡¨èŠ‚ç‚¹å°±å¯ä»¥ç”¨nextæŒ‡é’ˆæ„æˆä¸€ä¸ªå•é¡¹é“¾è¡¨ã€‚é€Ÿåº¦è€ƒè™‘ï¼Œæœ€æ–°èŠ‚ç‚¹æ·»åŠ åˆ°è¡¨å¤´ä½ç½®ï¼Œå¤æ‚åº¦O(1)ã€‚</p><h4 id="1-3-5-rehash"><a href="#1-3-5-rehash" class="headerlink" title="1.3.5 rehash"></a>1.3.5 rehash</h4><blockquote><p><strong>ä¸ºä»€ä¹ˆæ— è®ºæ˜¯HashMapè¿˜æ˜¯Redisï¼Œæ‰©å®¹/æ”¶ç¼©æ—¶å®¹é‡å¤§å°éƒ½æ˜¯2çš„å¹‚ï¼Ÿ</strong></p><ul><li>å‡å°‘ç¢°æ’æ¬¡æ•°ï¼Œæ¯”å¦‚1111&amp;1110=1110ï¼Œ1110&amp;1110=1110ï¼›</li><li>å®¹é‡*2ä¸è‡³äºåˆ†é…ç©ºé—´è¿‡å¤§é€ æˆæµªè´¹ï¼›</li></ul></blockquote><p>Rediså¯¹å­—å…¸çš„rehashæ­¥éª¤å¦‚ä¸‹ï¼š</p><ol><li>ä¸ºå­—å…¸çš„ht[1]å“ˆå¸Œè¡¨åˆ†é…ç©ºé—´ï¼Œè¿™ä¸ªå“ˆå¸Œè¡¨çš„ç©ºé—´å¤§å°å–å†³äºè¦æ‰§è¡Œçš„æ“ä½œï¼Œä»¥åŠht[0]å½“å‰åŒ…å«çš„é”®å€¼å¯¹æ•°é‡ï¼š</li></ol><ul><li>å¦‚æœæ‰§è¡Œçš„æ˜¯æ‰©å±•æ“ä½œï¼Œé‚£ä¹ˆht[1]çš„å¤§å°ä¸ºç¬¬ä¸€ä¸ªå¤§äºç­‰äºht[0].used*2çš„2^nï¼›</li><li>å¦‚æœæ‰§è¡Œçš„æ˜¯æ”¶ç¼©æ“ä½œï¼Œé‚£ä¹ˆht[1]çš„å¤§å°ä¸ºç¬¬ä¸€ä¸ªå¤§äºç­‰äºht[0].usedçš„2^2ï¼›</li></ul><ol start="2"><li>å°†ä¿å­˜åœ¨ht[0]ä¸­çš„æ‰€æœ‰é”®å€¼å¯¹rehashåˆ°ht[1]ä¸Š:rehashæŒ‡çš„æ˜¯é‡æ–°è®¡ç®—é”®çš„å“ˆå¸Œå€¼å’Œç´¢å¼•å€¼ï¼Œç„¶åå°†é”®å€¼å¯¹æ”¾ç½®åˆ°ht[1]å“ˆå¸Œè¡¨çš„æŒ‡å®šä½ç½®ä¸Šã€‚</li><li>å½“ht[0]åŒ…å«çš„æ‰€æœ‰é”®å€¼å¯¹éƒ½è¿ç§»åˆ°äº†ht[1]ä¹‹åï¼Œé‡Šæ”¾ht[0]ï¼Œå°†ht[1]è®¾ç½®ä¸ºht[0]ï¼Œå¹¶åœ¨ht[1]æ–°åˆ›å»ºä¸€ä¸ªç©ºç™½å“ˆå¸Œè¡¨ï¼Œä¸ºä¸‹ä¸€æ¬¡rehashåšå‡†å¤‡ã€‚</li></ol><p><strong> å“ˆå¸Œè¡¨çš„æ‰©å±•ä¸æ”¶ç¼© </strong></p><p>å½“ä»¥ä¸‹æ¡ä»¶ä¸­çš„ä»»æ„ä¸€ä¸ªè¢«æ»¡è¶³æ—¶ï¼Œç¨‹åºä¼šè‡ªåŠ¨å¼€å§‹å¯¹å“ˆå¸Œè¡¨æ‰§è¡Œæ‰©å±•æ“ä½œï¼š</p><ul><li>æœåŠ¡å™¨ç›®å‰æ²¡æœ‰æ‰§è¡ŒBGSAVEå‘½ä»¤æˆ–è€…BGREWRITEAOFå‘½ä»¤ï¼Œå¹¶ä¸”å“ˆå¸Œè¡¨è´Ÿè½½å› å­å¤§äºç­‰äº1ã€‚</li><li>æœåŠ¡å™¨ç›®å‰æ­£åœ¨æ‰§è¡ŒBGSAVEå‘½ä»¤æˆ–è€…BGREWRITEAOFå‘½ä»¤ï¼Œå¹¶ä¸”å“ˆå¸Œè¡¨çš„è´Ÿè½½å› å­å¤§äºç­‰äº5ã€‚</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># è´Ÿè½½å› å­=å“ˆå¸Œè¡¨å·²ä¿å­˜èŠ‚ç‚¹æ•°é‡/å“ˆå¸Œè¡¨å¤§å°</span><br><span class="line">load_factor = ht[0].used/ht[0].size</span><br></pre></td></tr></table></figure><p>æ‰§è¡ŒBGSAVEæˆ–BGREWRITEAOFå‘½ä»¤çš„è¿‡ç¨‹ä¸­ï¼ŒRediséœ€è¦åˆ›å»ºå½“å‰æœåŠ¡å™¨è¿›ç¨‹çš„å­è¿›ç¨‹ï¼Œå¤§å¤šæ•°æ“ä½œç³»ç»Ÿéƒ½é‡‡ç”¨å†™æ—¶å¤åˆ¶(copy-on-write)æŠ€æœ¯ä¼˜åŒ–å­è¿›ç¨‹çš„ä½¿ç”¨æ•ˆç‡ï¼Œæ‰€ä»¥åœ¨å­è¿›ç¨‹å­˜åœ¨æœŸé—´ï¼ŒæœåŠ¡å™¨ä¼šæé«˜æ‰§è¡Œæ‰©å±•æ“ä½œæ‰€éœ€çš„è´Ÿè½½å› å­ã€‚<br>å½“å“ˆå¸Œè¡¨çš„è´Ÿè½½å› å­å°äº0.1æ—¶ï¼Œç¨‹åºè‡ªåŠ¨å¼€å§‹æ‰§è¡Œæ”¶ç¼©æ“ä½œã€‚</p><h4 id="1-3-6-æ¸è¿›å¼rehash"><a href="#1-3-6-æ¸è¿›å¼rehash" class="headerlink" title="1.3.6 æ¸è¿›å¼rehash"></a>1.3.6 æ¸è¿›å¼rehash</h4><p>rehashåŠ¨ä½œä¸æ˜¯ä¸€æ¬¡æ€§ã€é›†ä¸­å¼çš„å®Œæˆï¼Œè€Œæ˜¯åˆ†å¤šæ¬¡ã€æ¸è¿›å¼çš„å®Œæˆã€‚<br>æ¸è¿›å¼rehashæ­¥éª¤:</p><ol><li>ä¸ºht[1]åˆ†é…ç©ºé—´ï¼Œè®©å­—å…¸åŒæ—¶æŒæœ‰ht[0]å’Œht[1]ä¸¤ä¸ªå“ˆå¸Œè¡¨ã€‚</li><li>åœ¨å­—å…¸ä¸­ç»´æŒä¸€ä¸ªç´¢å¼•è®¡æ•°å™¨å˜é‡rehashidxï¼Œå¹¶å°†å®ƒçš„å€¼è®¾ç½®ä¸º0ï¼Œè¡¨ç¤ºrehashå·¥ä½œæ­£å¼å¼€å§‹ã€‚</li><li>åœ¨rehashè¿›è¡ŒæœŸé—´ï¼Œæ¯æ¬¡å¯¹å­—å…¸æ‰§è¡Œæ·»åŠ ã€åˆ é™¤ã€æŸ¥æ‰¾æˆ–è€…æ›´æ–°æ“ä½œæ—¶ï¼Œç¨‹åºé™¤äº†æ‰§è¡ŒæŒ‡å®šçš„æ“ä½œå¤–ï¼Œè¿˜ä¼šé¡ºå¸¦å°†ht[0]å“ˆå¸Œè¡¨åœ¨rehashidxç´¢å¼•ä¸Šçš„æ‰€æœ‰é”®å€¼å¯¹rehashåˆ°ht[1]ï¼Œå½“rehashå·¥ä½œå®Œæˆåï¼Œç¨‹åºå°†rehashidxå±æ€§çš„å€¼å¢ä¸€ã€‚</li><li>éšç€å­—å…¸æ“ä½œçš„ä¸æ–­æ‰§è¡Œï¼Œæœ€ç»ˆåœ¨æŸä¸ªæ—¶é—´ç‚¹ä¸Šï¼Œht[0]çš„æ‰€æœ‰é”®å€¼å¯¹éƒ½ä¼šè¢«rehashå€¼ht[1]ï¼Œè¿™æ—¶ç¨‹åºå°†rehashidxå±æ€§çš„å€¼è®¾ä¸º-1ï¼Œè¡¨ç¤ºrehashæ“ä½œå®Œæˆã€‚</li></ol><p>åœ¨æ¸è¿›å¼rehashæœŸé—´ï¼Œå­—å…¸çš„åˆ é™¤ã€æŸ¥æ‰¾ã€æ›´æ–°ç­‰æ“ä½œä¼šåœ¨ä¸¤ä¸ªå“ˆå¸Œè¡¨ä¸Šè¿›è¡Œã€‚å¦‚æœæ–°åŠ åˆ°å­—å…¸çš„é”®å€¼å¯¹ä¸€å¾‹è¢«ä¿å­˜åˆ°ht[1]é‡Œé¢ã€‚</p><h3 id="1-4-è·³è·ƒè¡¨"><a href="#1-4-è·³è·ƒè¡¨" class="headerlink" title="1.4 è·³è·ƒè¡¨"></a>1.4 è·³è·ƒè¡¨</h3><p>è·³è·ƒè¡¨(skiplist)æ˜¯ä¸€ç§æœ‰åºæ•°æ®ç»“æ„ï¼Œå®ƒé€šè¿‡åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸­ç»´æŒå¤šä¸ªæŒ‡å‘å…¶ä»–èŠ‚ç‚¹çš„æŒ‡é’ˆï¼Œä»è€Œè¾¾åˆ°å¿«é€Ÿè®¿é—®èŠ‚ç‚¹çš„ç›®çš„ã€‚<br>è·³è·ƒè¡¨æ”¯æŒå¹³å‡O(logN)ã€æœ€åO(N)å¤æ‚åº¦çš„èŠ‚ç‚¹æŸ¥æ‰¾ï¼Œè¿˜å¯ä»¥é€šè¿‡é¡ºåºæ€§æ“ä½œæ¥æ‰¹é‡å¤„ç†èŠ‚ç‚¹ã€‚</p><p>Redisä½¿ç”¨è·³è·ƒè¡¨ä½œä¸ºæœ‰åºé›†åˆé”®çš„åº•å±‚å®ç°ä¹‹ä¸€ï¼Œå¦‚æœä¸€ä¸ªæœ‰åºé›†åˆåŒ…å«çš„å…ƒç´ æ•°é‡æ¯”è¾ƒå¤šï¼Œåˆæˆ–è€…æœ‰åºé›†åˆä¸­å…ƒç´ çš„æˆå‘˜æ˜¯æ¯”è¾ƒé•¿çš„å­—ç¬¦ä¸²æ—¶ï¼ŒRediså°±ä¼šä½¿ç”¨è·³è·ƒè¡¨æ¥ä½œä¸ºæœ‰åºé›†åˆé”®çš„åº•å±‚å®ç°ã€‚</p><p>Redisåªåœ¨ä¸¤ä¸ªåœ°æ–¹ç”¨åˆ°äº†è·³è·ƒè¡¨ï¼Œä¸€ä¸ªæ˜¯å®ç°æœ‰åºé›†åˆé”®ï¼Œå¦ä¸€ä¸ªæ˜¯åœ¨é›†ç¾¤èŠ‚ç‚¹ä¸­ç”¨ä½œå†…éƒ¨æ•°æ®ç»“æ„ã€‚</p><h4 id="1-4-1-ç»“æ„"><a href="#1-4-1-ç»“æ„" class="headerlink" title="1.4.1 ç»“æ„"></a>1.4.1 ç»“æ„</h4><p><img src="/media/article/skiplist.png" alt="skiplist"><br>ä¸Šå›¾å±•ç¤ºäº†ä¸€ä¸ªè·³è·ƒè¡¨ç¤ºä¾‹ï¼Œå·¦è¾¹æ˜¯zskiplistç»“æ„ï¼š</p><ul><li>header: æŒ‡å‘è·³è·ƒè¡¨çš„è¡¨å¤´èŠ‚ç‚¹</li><li>tail: æŒ‡å‘è·³è·ƒè¡¨çš„ç»“å°¾èŠ‚ç‚¹</li><li>level: è®°å½•ç›®å‰è·³è·ƒè¡¨å†…ï¼Œå±‚æ•°æœ€å¤§çš„é‚£ä¸ªèŠ‚ç‚¹çš„å±‚æ•°(è¡¨å¤´èŠ‚ç‚¹çš„å±‚æ•°ä¸è®¡ç®—åœ¨å†…)</li><li>length: è®°å½•è·³è·ƒè¡¨çš„é•¿åº¦ï¼Œè·³è·ƒè¡¨ç›®å‰åŒ…å«èŠ‚ç‚¹çš„æ•°é‡(è¡¨å¤´èŠ‚ç‚¹ä¸è®¡ç®—åœ¨å†…)</li></ul><p>å³ä¾§æ˜¯zskiplistNodeç»“æ„ï¼š</p><ul><li>level: èŠ‚ç‚¹ä¸­ç”¨L1ã€L2ã€L3ç­‰å­—æ ·æ ‡è®°èŠ‚ç‚¹çš„å„ä¸ªå±‚ï¼ŒL1ä»£è¡¨ç¬¬ä¸€å±‚ï¼Œä»¥æ­¤ç±»æ¨ã€‚æ¯å±‚ä¸¤ä¸ªå±æ€§ï¼šå‰è¿›æŒ‡é’ˆå’Œè·¨åº¦ã€‚å‰è¿›æŒ‡é’ˆç”¨äºè®¿é—®ä½äºè¡¨å°¾æ–¹å‘çš„å…¶ä»–èŠ‚ç‚¹ï¼Œè·¨åº¦åˆ™è®°å½•äº†å‰è¿›æŒ‡é’ˆæ‰€æŒ‡å‘èŠ‚ç‚¹å’Œå½“å‰èŠ‚ç‚¹çš„è·ç¦»ã€‚</li><li>backward: èŠ‚ç‚¹ä¸­ç”¨BWå­—æ ·æ ‡è®°èŠ‚ç‚¹çš„åé€€æŒ‡é’ˆï¼Œå®ƒæŒ‡å‘ä½äºå½“å‰èŠ‚ç‚¹çš„å‰ä¸€ä¸ªèŠ‚ç‚¹ã€‚åé€€æŒ‡é’ˆåœ¨ç¨‹åºä»è¡¨å°¾å‘è¡¨å¤´éå†æ—¶ä½¿ç”¨ã€‚</li><li>score: å„ä¸ªèŠ‚ç‚¹ä¸­çš„1.0ã€2.0ã€å’Œ3.0æ˜¯èŠ‚ç‚¹æ‰€ä¿å­˜çš„åˆ†å€¼ã€‚åœ¨è·³è·ƒè¡¨ä¸­ï¼ŒèŠ‚ç‚¹æŒ‰å„è‡ªæ‰€ä¿å­˜çš„åˆ†å€¼ä»å°åˆ°å¤§æ’åºã€‚</li><li>obj: å„ä¸ªèŠ‚ç‚¹ä¸­çš„o1ã€o2å’Œo3æ—¶èŠ‚ç‚¹æ‰€ä¿å­˜çš„æˆå‘˜å¯¹è±¡ã€‚</li></ul><h3 id="1-5-æ•´æ•°é›†åˆ"><a href="#1-5-æ•´æ•°é›†åˆ" class="headerlink" title="1.5 æ•´æ•°é›†åˆ"></a>1.5 æ•´æ•°é›†åˆ</h3><p>æ•´æ•°é›†åˆ(intset)æ˜¯é›†åˆé”®çš„åº•å±‚å®ç°ä¹‹ä¸€ï¼Œå½“ä¸€ä¸ªé›†åˆåªåŒ…å«æ•´æ•°å€¼å…ƒç´ ï¼Œå¹¶ä¸”è¿™ä¸ªé›†åˆçš„å…ƒç´ æ•°é‡ä¸å¤šæ—¶ï¼ŒRediså°±ä¼šä½¿ç”¨æ•´æ•°é›†åˆä½œä¸ºé›†åˆé”®çš„åº•å±‚å®ç°ã€‚<br>æ•´æ•°é›†åˆæ˜¯Redisç”¨äºä¿å­˜æ•´æ•°å€¼çš„é›†åˆæŠ½è±¡æ•°æ®ç»“æ„ï¼Œä»–å¯ä»¥ä¿å­˜é›†åˆç±»å‹ä¸ºint16_tã€int32_tæˆ–è€…int64_tçš„æ•´æ•°å€¼ï¼Œå¹¶ä¸”ä¿è¯é›†åˆä¸­ä¸ä¼šå‡ºç°é‡å¤å…ƒç´ ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">typedef struct intset&#123;</span><br><span class="line">    // ç¼–ç æ–¹å¼</span><br><span class="line">    uint32_t encoding;</span><br><span class="line">    // é›†åˆåŒ…å«çš„å…ƒç´ </span><br><span class="line">    uint32_t length;</span><br><span class="line">    // ä¿å­˜å…ƒç´ çš„æ•°æ®</span><br><span class="line">    int8_t contents[];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>contentsæ•°ç»„æ˜¯æ•´æ•°é›†åˆçš„åº•å±‚å®ç°:æ•´æ•°é›†åˆçš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯contentsæ•°ç»„çš„ä¸€ä¸ªæ•°ç»„é¡¹(item)ï¼Œå„ä¸ªé¡¹åœ¨æ•°ç»„ä¸­æŒ‰å€¼çš„å¤§å°ä»å°æ‰“åˆ°æœ‰åºçš„æ’åˆ—ï¼Œå¹¶ä¸”æ•°ç»„ä¸­ä¸åŒ…å«ä»»ä½•é‡å¤é¡¹ã€‚</p><h4 id="1-5-1-æ•´æ•°é›†åˆå‡çº§"><a href="#1-5-1-æ•´æ•°é›†åˆå‡çº§" class="headerlink" title="1.5.1 æ•´æ•°é›†åˆå‡çº§"></a>1.5.1 æ•´æ•°é›†åˆå‡çº§</h4><p>æ¯å½“æˆ‘ä»¬å°†ä¸€ä¸ªæ–°å…ƒç´ æ·»åŠ åˆ°æ•´æ•°é›†åˆé‡Œé¢ï¼Œå¹¶ä¸”æ–°å…ƒç´ çš„ç±»å‹æ¯”æ•´æ•°é›†åˆç°æœ‰æ‰€æœ‰å…ƒç´ çš„ç±»å‹éƒ½è¦é•¿æ—¶ï¼Œæ•´æ•°é›†åˆå…ˆè¿›è¡Œå‡çº§ï¼Œç„¶åæ·»åŠ åˆ°æ•´æ•°é›†åˆé‡Œé¢ã€‚</p><p>å‡çº§æ­¥éª¤ï¼š</p><ol><li>æ ¹æ®æ–°å…ƒç´ çš„ç±»å‹ï¼Œæ‰©å±•æ•´æ•°é›†åˆåº•å±‚æ•°ç»„çš„ç©ºé—´å¤§å°ï¼Œå¹¶ä¸ºæ–°å…ƒç´ åˆ†é…ç©ºé—´ã€‚</li><li>å°†åº•å±‚æ•°ç»„ç°æœ‰çš„æ‰€æœ‰å…ƒç´ éƒ½è½¬æ¢æˆä¸æ–°å…ƒç´ ç›¸åŒçš„ç±»å‹ï¼Œå¹¶å°†ç±»å‹è½¬æ¢åçš„å…ƒç´ æ”¾ç½®åˆ°æ­£ç¡®çš„ä½ä¸Šï¼Œæ”¾ç½®å…ƒç´ è¿‡ç¨‹ä¸­ï¼Œéœ€è¦ç»´æŒåº•å±‚æ•°ç»„çš„æœ‰åºæ€§è´¨ä¸å˜ã€‚</li><li>å°†æ–°å…ƒç´ æ·»åŠ åˆ°åº•å±‚æ•°ç»„é‡Œé¢ã€‚</li></ol><h3 id="1-6-å‹ç¼©åˆ—è¡¨"><a href="#1-6-å‹ç¼©åˆ—è¡¨" class="headerlink" title="1.6 å‹ç¼©åˆ—è¡¨"></a>1.6 å‹ç¼©åˆ—è¡¨</h3><p>å½“ä¸€ä¸ªåˆ—è¡¨é”®åªåŒ…å«å°‘é‡çš„åˆ—è¡¨é¡¹ï¼Œå¹¶ä¸”æ¯ä¸ªåˆ—è¡¨é¡¹è¦ä¹ˆå°±æ˜¯å°æ•´æ•°å€¼ï¼Œè¦ä¹ˆå°±æ˜¯é•¿åº¦æ¯”è¾ƒçŸ­çš„å­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆRediså°±ä¼šä½¿ç”¨å‹ç¼©åˆ—è¡¨æ¥åšåˆ—è¡¨é”®çš„åº•å±‚å®ç°ã€‚</p><p>å‹ç¼©åˆ—è¡¨æ˜¯ä¸ºäº†èŠ‚çº¦å†…å­˜å¼€å‘çš„ï¼Œæ˜¯ç”±ä¸€ç³»åˆ—ç‰¹æ®Šç¼–ç çš„è¿ç»­å†…å­˜å—ç»„ç»‡çš„é¡ºåº(sequential)æ•°æ®ç»“æ„ã€‚</p><p><img src="/media/article/ziplist.png" alt="ziplist"><br><img src="/media/article/ziplistintroduce.png" alt="ziplistintroduce"></p><p>èŠ‚ç‚¹contentå±æ€§è´Ÿè´£ä¿å­˜èŠ‚ç‚¹çš„å€¼ï¼ŒèŠ‚ç‚¹å€¼å¯ä»¥æ˜¯ä¸€ä¸ªå­—èŠ‚æ•°ç»„æˆ–è€…æ•´æ•°ï¼Œå€¼çš„ç±»å‹å’Œé•¿åº¦ç”±èŠ‚ç‚¹çš„encodingå±æ€§å†³å®šã€‚</p><h4 id="1-6-1-è¿é”æ›´æ–°"><a href="#1-6-1-è¿é”æ›´æ–°" class="headerlink" title="1.6.1 è¿é”æ›´æ–°"></a>1.6.1 è¿é”æ›´æ–°</h4><p>è¿é”æ›´æ–°æœ€åæƒ…å†µä¸‹éœ€è¦å¯¹å‹ç¼©åˆ—è¡¨æ‰§è¡ŒNæ¬¡ç©ºé—´é‡åˆ†é…æ“ä½œï¼Œè€Œæ¯æ¬¡ç©ºé—´é‡åˆ†é…çš„æœ€å¿«å¤æ‚åº¦ä¸ºO(N)ï¼Œæ‰€ä»¥æ›´æ–°çš„æœ€å¿«å¤æ‚åº¦ä¸ºO(N^2)ã€‚</p><h3 id="1-7-å¿«é€Ÿåˆ—è¡¨-quicklist"><a href="#1-7-å¿«é€Ÿåˆ—è¡¨-quicklist" class="headerlink" title="1.7 å¿«é€Ÿåˆ—è¡¨(quicklist)"></a>1.7 å¿«é€Ÿåˆ—è¡¨(quicklist)</h3><p>quicklistæ˜¯ä¸€ä¸ªziplistçš„åŒå‘é“¾è¡¨ï¼ˆåŒå‘é“¾è¡¨æ˜¯ç”±å¤šä¸ªèŠ‚ç‚¹Nodeç»„æˆçš„ï¼‰ã€‚ä¹Ÿå°±æ˜¯è¯´quicklistçš„æ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ä¸€ä¸ªziplistã€‚ziplistæœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªèƒ½ç»´æŒæ•°æ®é¡¹å…ˆåé¡ºåºçš„åˆ—è¡¨ï¼ˆæŒ‰æ’å…¥ä½ç½®ï¼‰ï¼Œè€Œä¸”æ˜¯ä¸€ä¸ªå„ä¸ªæ•°æ®é¡¹åœ¨å†…å­˜ä¸Šå‰åç›¸é‚»çš„åˆ—è¡¨ã€‚<br>ç»“æ„å¦‚ä¸‹:</p><p><img src="/media/article/quicklist.png" alt="quicklist"><br>å›¾ç‰‡æ¥è‡ª<a href="https://www.cnblogs.com/exceptioneye/p/7044341.html?utm_source=itdadao&amp;utm_medium=referral" target="_blank" rel="noopener">ä¸‰çŸ³é›¨-Redisç»“æ„ä¹‹quicklist</a></p><p>quickliståŸºäºç©ºé—´å’Œæ—¶é—´çš„è€ƒè™‘ï¼Œç»“åˆåŒå‘é“¾è¡¨å’Œziplistçš„ä¼˜ç‚¹ã€‚</p><blockquote><p>åŒå‘é“¾è¡¨linkedlistä¾¿äºåœ¨è¡¨çš„ä¸¤ç«¯è¿›è¡Œpushå’Œpopæ“ä½œï¼Œåœ¨æ’å…¥èŠ‚ç‚¹ä¸Šå¤æ‚åº¦å¾ˆä½ï¼Œä½†æ˜¯å®ƒçš„å†…å­˜å¼€é”€æ¯”è¾ƒå¤§ã€‚é¦–å…ˆï¼Œå®ƒåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šé™¤äº†è¦ä¿å­˜æ•°æ®ä¹‹å¤–ï¼Œè¿˜è¦é¢å¤–ä¿å­˜ä¸¤ä¸ªæŒ‡é’ˆï¼›å…¶æ¬¡ï¼ŒåŒå‘é“¾è¡¨çš„å„ä¸ªèŠ‚ç‚¹æ˜¯å•ç‹¬çš„å†…å­˜å—ï¼Œåœ°å€ä¸è¿ç»­ï¼ŒèŠ‚ç‚¹å¤šäº†å®¹æ˜“äº§ç”Ÿå†…å­˜ç¢ç‰‡ã€‚<br>ziplistå­˜å‚¨åœ¨ä¸€æ®µè¿ç»­çš„å†…å­˜ä¸Šï¼Œæ‰€ä»¥å­˜å‚¨æ•ˆç‡å¾ˆé«˜ã€‚ä½†æ˜¯ï¼Œå®ƒä¸åˆ©äºä¿®æ”¹æ“ä½œï¼Œæ’å…¥å’Œåˆ é™¤æ“ä½œéœ€è¦é¢‘ç¹çš„ç”³è¯·å’Œé‡Šæ”¾å†…å­˜ã€‚ç‰¹åˆ«æ˜¯å½“ziplisté•¿åº¦å¾ˆé•¿çš„æ—¶å€™ï¼Œä¸€æ¬¡reallocå¯èƒ½ä¼šå¯¼è‡´å¤§æ‰¹é‡çš„æ•°æ®æ‹·è´ã€‚<br>æ‘˜è‡ª<a href="https://blog.csdn.net/harleylau/article/details/80534159" target="_blank" rel="noopener">harleylau Redisæºç å‰–æâ€“quicklist</a></p></blockquote><h3 id="1-8-å¯¹è±¡"><a href="#1-8-å¯¹è±¡" class="headerlink" title="1.8 å¯¹è±¡"></a>1.8 å¯¹è±¡</h3><p>Rediså¹¶æ²¡æœ‰ ç›´æ¥ä½¿ç”¨SDSã€åŒç«¯é“¾è¡¨ã€å­—å…¸ã€å‹ç¼©åˆ—è¡¨ã€æ•´æ•°é›†åˆè¿™äº›æ•°æ®ç»“æ„å®ç°é”®å€¼å¯¹æ•°æ®åº“ï¼Œè€Œæ˜¯åŸºäºè¿™äº›æ•°æ®ç»“æ„åˆ›å»ºäº†ä¸€ä¸ªå¯¹è±¡ç³»ç»Ÿã€‚å¯¹è±¡ç³»ç»ŸåŒ…å«ï¼šå­—ç¬¦ä¸²å¯¹è±¡ã€åˆ—è¡¨å¯¹è±¡ã€å“ˆå¸Œå¯¹è±¡ã€é›†åˆå¯¹è±¡å’Œæœ‰åºé›†åˆå¯¹è±¡ã€‚<br>Redisçš„å¯¹è±¡ç³»ç»Ÿå®ç°äº†åŸºäºå¼•ç”¨è®¡æ•°è®¡æ•°çš„å†…å­˜å›æ”¶æœºåˆ¶ï¼Œå½“ç¨‹åº ä¸å†ä½¿ç”¨æŸä¸ªå¯¹è±¡çš„æ—¶å€™ï¼Œè¿™ä¸ªå¯¹è±¡æ‰€å ç”¨çš„å†…å­˜å°±ä¼šè¢«è‡ªåŠ¨é‡Šæ”¾ï¼›å¦å¤–Redisè¿˜é€šè¿‡å¼•ç”¨è®¡æ•°æŠ€æœ¯å®ç°äº†å¯¹è±¡å…±äº«æœºåˆ¶ï¼Œè¿™ç§æœºåˆ¶åœ¨é€‚å½“æƒ…å†µä¸‹ï¼Œé€šè¿‡è®©å¤šä¸ªæ•°æ®åº“é”®å…±äº«åŒä¸€ä¸ªå¯¹è±¡æ¥èŠ‚çº¦å†…å­˜ã€‚<br>Rediså¯¹è±¡å¸¦æœ‰è®¿é—®æ—¶é—´è®°å½•ä¿¡æ¯ï¼Œè¯¥ä¿¡æ¯å¯ä»¥ç”¨äºè®¡ç®—æ•°æ®åº“é”®çš„ç©ºè½¬æ—¶é•¿ï¼Œåœ¨æœåŠ¡å™¨å¯ç”¨äº†maxmemoryåŠŸèƒ½æƒ…å†µä¸‹ï¼Œç©ºè½¬æ—¶é•¿è¾ƒå¤§çš„é‚£äº›é”®å¯èƒ½ä¼šä¼˜å…ˆè¢«æœåŠ¡å™¨åˆ é™¤ã€‚</p><h4 id="1-8-1-å¯¹è±¡çš„ç±»å‹ä¸ç¼–ç "><a href="#1-8-1-å¯¹è±¡çš„ç±»å‹ä¸ç¼–ç " class="headerlink" title="1.8.1 å¯¹è±¡çš„ç±»å‹ä¸ç¼–ç "></a>1.8.1 å¯¹è±¡çš„ç±»å‹ä¸ç¼–ç </h4><p>Redisä½¿ç”¨å¯¹è±¡æ¥è¡¨ç¤ºæ•°æ®åº“ä¸­çš„é”®å’Œå€¼ï¼Œæ¯æ¬¡å½“æˆ‘ä»¬åœ¨Redisçš„æ•°æ®åº“ä¸­æ–°å»ºä¸€ä¸ªé”®å€¼å¯¹æ—¶ï¼Œæˆ‘ä»¬è‡³å°‘ä¼šåˆ›å»ºä¸¤ä¸ªå¯¹è±¡ï¼Œä¸€ä¸ªå¯¹è±¡ç”¨ä½œé”®å€¼å¯¹çš„é”®ï¼Œä¸€ä¸ªå¯¹è±¡ç”¨ä½œé”®å€¼å¯¹çš„å€¼ã€‚</p><p>Redisä¸­çš„æ¯ä¸ªå¯¹è±¡éƒ½ç”±ä¸€ä¸ªRedisObjectç»“æ„è¡¨ç¤ºï¼Œè¯¥ç»“æ„ä¸­å’Œä¿å­˜æ•°æ®æœ‰å…³çš„ä¸‰ä¸ªå±æ€§åˆ†åˆ«æ˜¯typeå±æ€§ã€encodingå±æ€§å’Œptrå±æ€§:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">typedef struct redisObject&#123;</span><br><span class="line">    // ç±»å‹</span><br><span class="line">    unsigned type:4;</span><br><span class="line">    </span><br><span class="line">    // ç¼–ç </span><br><span class="line">    unsigned encoding:4;</span><br><span class="line">    </span><br><span class="line">    // æŒ‡å‘åº•å±‚å®ç°æ•°æ®ç»“æ„çš„æŒ‡é’ˆ</span><br><span class="line">    void *ptr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>typeè®°å½•äº†å¯¹è±¡çš„ç±»å‹ï¼š</p><ul><li>REDIS_STRING:å­—ç¬¦ä¸²å¯¹è±¡</li><li>REDIS_LIST:åˆ—è¡¨å¯¹è±¡</li><li>REDIS_HASH:å“ˆå¸Œå¯¹è±¡</li><li>REDIS_SET:é›†åˆå¯¹è±¡</li><li>REDIS_ZSET:æœ‰åºé›†åˆå¯¹è±¡</li></ul><blockquote><p>å­—ç¬¦ä¸²é”®æŒ‡çš„æ˜¯è¿™ä¸ªæ•°æ®åº“é”®æ‰€å¯¹åº”çš„å€¼å¾—å­—ç¬¦ä¸²å¯¹è±¡<br>åˆ—è¡¨é”®æŒ‡çš„æ˜¯æ•°æ®åº“é”®æ‰€å¯¹åº”çš„å€¼ä¸ºåˆ—è¡¨å¯¹è±¡</p></blockquote><p>ptræŒ‡é’ˆæŒ‡å‘å¯¹è±¡çš„åº•å±‚å®ç°æ•°æ®ç»“æ„ï¼Œè¿™äº›æ•°æ®ç»“æ„ç”±å¯¹è±¡çš„encodingå±æ€§å†³å®šã€‚encodingè®°å½•å¯¹è±¡ä½¿ç”¨çš„ç¼–ç ï¼š</p><p><img src="/media/article/encoding-type.png" alt="encoding"><br>é™¤ä¸Šè¿°åˆ—è¡¨å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªæ˜¯REDIS_ENCODING_QUICKLISTç¼–ç ï¼Œå¿«é€Ÿåˆ—è¡¨ã€‚</p><p>æ¯ç§ç±»å‹çš„å¯¹è±¡éƒ½è‡³å°‘ä½¿ç”¨äº†ä¸¤ç§ä¸åŒç¼–ç ï¼Œä¸‹è¡¨åˆ—å‡ºäº†æ¯ç§ç±»å‹çš„å¯¹è±¡å¯ä»¥ä½¿ç”¨çš„ç¼–ç ã€‚</p><p><img src="/media/article/type-encoding.png" alt="type-encoding"></p><p>é™¤ä¸Šè¿°åˆ—è¡¨å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªæ˜¯REDIS_LISTå¯¹åº”REDIS_ENCODING_QUICKLISTã€‚</p><h4 id="1-8-2-å­—ç¬¦ä¸²å¯¹è±¡"><a href="#1-8-2-å­—ç¬¦ä¸²å¯¹è±¡" class="headerlink" title="1.8.2 å­—ç¬¦ä¸²å¯¹è±¡"></a>1.8.2 å­—ç¬¦ä¸²å¯¹è±¡</h4><p>å­—ç¬¦ä¸²å¯¹è±¡çš„ç¼–ç å¯ä»¥æ˜¯intã€rawæˆ–è€…embstrã€‚<br>å¦‚æœå­—ç¬¦ä¸²å¯¹è±¡ä¿å­˜çš„æ˜¯æ•´æ•°å€¼ï¼Œå°†å­—ç¬¦ä¸²å¯¹è±¡çš„ç¼–ç è®¾ç½®ä¸ºintã€‚<br>å¦‚æœå­—ç¬¦ä¸²å¯¹è±¡ä¿å­˜çš„æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å€¼ï¼Œå¹¶ä¸”è¿™ä¸ªå­—ç¬¦ä¸²å€¼é•¿åº¦å¤§äº32å­—èŠ‚ï¼Œå­—ç¬¦ä¸²å¯¹è±¡å°†ä½¿ç”¨ä¸€ä¸ªç®€å•åŠ¨æ€å­—ç¬¦ä¸²(SDS)æ¥ä¿å­˜è¿™ä¸ªå­—ç¬¦ä¸²å€¼ï¼Œå¹¶å°†å¯¹è±¡çš„ç¼–ç è®¾ç½®ä¸ºrawã€‚<br>rawç»“æ„ï¼š<br><img src="/media/article/raw.png" alt="raw"><br>å¦‚æœå­—ç¬¦ä¸²å¯¹è±¡ä¿å­˜çš„æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å€¼ï¼Œå¹¶ä¸”è¿™ä¸ªå­—ç¬¦ä¸²å€¼é•¿åº¦å°äº32å­—èŠ‚ï¼Œå­—ç¬¦ä¸²å¯¹è±¡å°†ä½¿ç”¨embstrç¼–ç çš„æ–¹å¼ä¿å­˜è¿™ä¸ªå­—ç¬¦ä¸²å€¼ã€‚<br>embstrå†…å­˜å—ç»“æ„ï¼š<br><img src="/media/article/embstr.png" alt="embstr"><br><strong>rawå’ŒembstråŒºåˆ«ï¼š</strong></p><ul><li>embstrç¼–ç å°†åˆ›å»ºå­—ç¬¦ä¸²å¯¹è±¡æ‰€éœ€çš„å†…å­˜åˆ†é…æ¬¡æ•°ä»rawç¼–ç çš„ä¸¤æ¬¡é™ä½ä¸ºä¸€æ¬¡ã€‚</li><li>é‡Šæ”¾embstrç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡åªéœ€è¦è°ƒç”¨ä¸€æ¬¡å†…å­˜é‡Šæ”¾å‡½æ•°ï¼Œè€Œé‡Šæ”¾rawç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡éœ€è¦è°ƒç”¨ä¸¤æ¬¡å†…å­˜é‡Šæ”¾å‡½æ•°ã€‚</li><li>embstrç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡çš„æ‰€æœ‰æ•°æ®éƒ½ä¿å­˜åœ¨ä¸€å—è¿ç»­çš„å†…å­˜é‡Œé¢ï¼Œæ‰€ä»¥è¿™ç§ç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡æ¯”èµ·rawç¼–ç å­—ç¬¦ä¸²å¯¹è±¡æ¯”èµ·æ¥rawç¼–ç çš„å­—ç¬¦ä¸²èƒ½å¤Ÿæ›´å¥½åœ°åˆ©ç”¨ç¼“å­˜å¸¦æ¥çš„ä¼˜åŠ¿ã€‚</li></ul><p>å­—ç¬¦ä¸²å¯¹è±¡ä¿å­˜å„ç±»å‹å€¼å¾—ç¼–ç æ–¹å¼:</p><p><img src="/media/article/string-type-value.png" alt="string"></p><p>intç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡å’Œembstrç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡åœ¨æ¡ä»¶æ»¡è¶³çš„æƒ…å†µä¸‹ï¼Œä¼šè¢«è½¬æ¢ä¸ºrawç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡ã€‚<br>Redisæ²¡æœ‰ä¸ºembstrç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡ç¼–å†™ä»»ä½•å“åº”çš„ä¿®æ”¹ç¨‹åºï¼Œæ‰€ä»¥embstrç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡å®é™…ä¸Šæ˜¯åªè¯»çš„ã€‚</p><p><img src="/media/article/string-order-implement.png" alt="string"></p><h4 id="1-8-3-åˆ—è¡¨å¯¹è±¡"><a href="#1-8-3-åˆ—è¡¨å¯¹è±¡" class="headerlink" title="1.8.3 åˆ—è¡¨å¯¹è±¡"></a>1.8.3 åˆ—è¡¨å¯¹è±¡</h4><p>åˆ—è¡¨å¯¹è±¡çš„ç¼–ç å¯ä»¥ä½¿ziplistæˆ–è€…linkedlistã€‚<br>ziplistç»“æ„å¦‚ä¸‹ï¼š<br><img src="/media/article/ziplist-store.png" alt="ziplist"></p><p>linkedlistç»“æ„å¦‚ä¸‹ï¼š</p><p><img src="/media/article/linkedlist-store.png" alt="linkedlist"></p><p>StringObjectç»“æ„ï¼š</p><p><img src="/media/article/string-obj-store.png" alt="string-object"></p><p>å½“åˆ—è¡¨å¯¹è±¡æ»¡è¶³å¦‚ä¸‹æ¡ä»¶æ—¶ï¼Œä½¿ç”¨ziplistç¼–ç ï¼š<br>åˆ—è¡¨å¯¹è±¡ä¿å­˜çš„æ‰€æœ‰å­—ç¬¦ä¸²å…ƒç´ çš„é•¿åº¦éƒ½å°äº64å­—èŠ‚ï¼›<br>åˆ—è¡¨å¯¹è±¡ä¿å­˜çš„å…ƒç´ æ•°é‡å°äº512ä¸ªï¼›</p><p><strong>åˆ—è¡¨å‘½ä»¤çš„å®ç°ï¼š</strong><br><img src="/media/article/list-order-implement.png" alt="list-order"></p><h4 id="1-8-4-å“ˆå¸Œå¯¹è±¡"><a href="#1-8-4-å“ˆå¸Œå¯¹è±¡" class="headerlink" title="1.8.4 å“ˆå¸Œå¯¹è±¡"></a>1.8.4 å“ˆå¸Œå¯¹è±¡</h4><p>å“ˆå¸Œå¯¹è±¡çš„ç¼–ç å¯ä»¥æ˜¯ziplistæˆ–è€…hashtableã€‚</p><p>ziplistç¼–ç çš„å“ˆå¸Œå¯¹è±¡ä½¿ç”¨å‹ç¼©åˆ—è¡¨ä½œä¸ºåº•å±‚å®ç°ï¼Œæ¯å½“æœ‰æ–°çš„é”®å€¼å¯¹è¦åŠ å…¥åˆ°å“ˆå¸Œå¯¹è±¡æ—¶ï¼Œç¨‹åºä¼šå…ˆå°†ä¿å­˜äº†é”®çš„å‹ç¼©åˆ—è¡¨èŠ‚ç‚¹æ¨å…¥åˆ°å‹ç¼©åˆ—è¡¨è¡¨å°¾ï¼Œç„¶åå†å°†ä¿å­˜äº†å€¼å¾—å‹ç¼©åˆ—è¡¨èŠ‚ç‚¹æ¨å…¥åˆ°å‹ç¼©åˆ—è¡¨è¡¨å°¾ï¼š</p><ul><li>å› æ­¤ä¿å­˜äº†åŒä¸€é”®å€¼å¯¹çš„ä¸¤ä¸ªèŠ‚ç‚¹æ€»æ˜¯ç´§æŒ¨åœ¨ä¸€èµ·ï¼Œä¿å­˜é”®çš„èŠ‚ç‚¹åœ¨å‰ï¼Œä¿å­˜å€¼çš„èŠ‚ç‚¹åœ¨åï¼›</li><li>å…ˆæ·»åŠ åˆ°å“ˆå¸Œå¯¹è±¡ä¸­çš„é”®å€¼å¯¹ä¼šè¢«æ”¾åœ¨å‹ç¼©åˆ—è¡¨çš„è¡¨å¤´æ–¹å‘ï¼Œè€Œåæ·»åŠ åˆ°å“ˆå¸Œå¯¹è±¡ä¸­çš„é”®å€¼å¯¹ä¼šè¢«æ”¾åœ¨å‹ç¼©åˆ—è¡¨çš„è¡¨å°¾æ–¹å‘ã€‚</li></ul><p>ä¾‹å¦‚ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;HSET profile name &quot;Tom&quot;</span><br><span class="line">&gt;HSET profile age 25</span><br><span class="line">&gt;HSET profile career &quot;Programmer&quot;</span><br></pre></td></tr></table></figure></p><p>å“ˆå¸Œå¯¹è±¡çš„å‹ç¼©åˆ—è¡¨åº•å±‚å®ç°ï¼š</p><p><img src="/media/article/hash-ziplist-implement.png" alt="hash-ziplist-implement"></p><p>hashtableç¼–ç çš„å“ˆå¸Œå¯¹è±¡ä½¿ç”¨å­—å…¸ä½œä¸ºåº•å±‚å®ç°ï¼Œå“ˆå¸Œå¯¹è±¡ä¸­æ¯ä¸ªé”®å€¼å¯¹éƒ½ä½¿ç”¨ä¸€ä¸ªå­—å…¸é”®å€¼å¯¹æ¥ä¿å­˜ï¼š</p><ul><li>å­—å…¸çš„æ¯ä¸ªé”®éƒ½æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ï¼Œå¯¹è±¡ä¸­ä¿å­˜äº†é”®å€¼å¯¹çš„é”®ï¼›</li><li>å­—å…¸çš„æ¯ä¸ªå€¼éƒ½æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ï¼Œå¯¹è±¡ä¸­ä¿å­˜äº†é”®å€¼å¯¹çš„å€¼ã€‚</li></ul><p>å¦‚æœä¸Šè¿°ä¾‹å­ä¸æ˜¯ziplistè€Œæ˜¯hashtableï¼Œåˆ™ç»“æ„å¦‚ä¸‹ï¼š</p><p><img src="/media/article/hashtable-implement.png" alt="hashtable-implement"></p><p>å¦‚æœå“ˆå¸Œå¯¹è±¡æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶æ—¶ï¼Œå“ˆå¸Œå¯¹è±¡ä½¿ç”¨ziplistç¼–ç ï¼š</p><ul><li>å“ˆå¸Œå¯¹è±¡ä¿å­˜çš„æ‰€æœ‰é”®å€¼å¯¹çš„é”®å’Œå€¼å¾—å­—ç¬¦ä¸²é•¿åº¦éƒ½å°äº64å­—èŠ‚ï¼›</li><li>å“ˆå¸Œå¯¹è±¡ä¿å­˜çš„é”®å€¼å¯¹æ•°é‡å°äº512ä¸ªï¼›</li></ul><p><strong>hashå‘½ä»¤ï¼š</strong></p><p><img src="/media/article/hash-order.png" alt="hash-order"></p><h4 id="1-8-5-é›†åˆå¯¹è±¡"><a href="#1-8-5-é›†åˆå¯¹è±¡" class="headerlink" title="1.8.5 é›†åˆå¯¹è±¡"></a>1.8.5 é›†åˆå¯¹è±¡</h4><p>é›†åˆå¯¹è±¡ç¼–ç å¯ä»¥æ˜¯intsetæˆ–è€…hashtableã€‚</p><p><strong>é›†åˆå‘½ä»¤ï¼š</strong></p><p><img src="/media/article/set-order.png" alt="set-order"><br><img src="/media/article/set-order1.png" alt="set-order"></p><h4 id="1-8-6-æœ‰åºé›†åˆå¯¹è±¡"><a href="#1-8-6-æœ‰åºé›†åˆå¯¹è±¡" class="headerlink" title="1.8.6 æœ‰åºé›†åˆå¯¹è±¡"></a>1.8.6 æœ‰åºé›†åˆå¯¹è±¡</h4><p>æœ‰åºé›†åˆçš„ç¼–ç å¯ä»¥æ˜¯ziplistæˆ–è€…skiplistã€‚</p><p><strong>ziplistçš„çš„å­˜å‚¨ç»“æ„ï¼š</strong></p><p><img src="/media/article/sorted-set-ziplist.png" alt="sorted-set-ziplist"><br><img src="/media/article/sorted-set-ziplist1.png" alt="sorted-set-ziplist"></p><p>skiplistç¼–ç çš„æœ‰åºé›†åˆå¯¹è±¡ä½¿ç”¨zsetç»“æ„ä½œä¸ºåº•å±‚å®ç°ï¼Œä¸€ä¸ªzsetç»“æ„åŒæ—¶åŒ…å«ä¸€ä¸ªå­—å…¸å’Œä¸€ä¸ªè·³è·ƒè¡¨:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">typedef struct zset&#123;</span><br><span class="line">    zskiplist *zsl;</span><br><span class="line">    dict *dict;</span><br><span class="line">&#125; zset;</span><br></pre></td></tr></table></figure></p><p>zsetç»“æ„ä¸­çš„zslè·³è·ƒè¡¨æŒ‰åˆ†å€¼ä»å°åˆ°å¤§ä¿å­˜äº†æ‰€æœ‰é›†åˆå…ƒç´ ï¼Œæ¯ä¸ªè·³è·ƒè¡¨èŠ‚ç‚¹ä¿å­˜äº†ä¸€ä¸ªé›†åˆå…ƒç´ :è·³è·ƒè¡¨èŠ‚ç‚¹çš„Objectå±æ€§ä¿å­˜äº†å…ƒç´ çš„æˆå‘˜ï¼Œè€Œè·³è·ƒè¡¨çš„scoreå±æ€§åˆ™ä¿å­˜äº†å…ƒç´ çš„åˆ†å€¼ã€‚é€šè¿‡è¿™ä¸ªè·³è·ƒè¡¨ï¼Œç¨‹åºå¯ä»¥å¯¹æœ‰åºé›†åˆè¿›è¡ŒèŒƒå›´å‹æ“ä½œï¼Œå¦‚<code>ZRANK</code>ã€<code>ZRANGE</code>ç­‰å‘½ä»¤å°±æ˜¯åŸºäºè·³è·ƒè¡¨APIæ¥å®ç°çš„ã€‚</p><p>é™¤æ­¤ä¹‹å¤–ï¼Œzsetç»“æ„ä¸­çš„dictå­—å…¸ä¸ºæœ‰åºé›†åˆåˆ›å»ºäº†ä¸€ä¸ªä»æˆå‘˜çš„åˆ†å€¼çš„æ˜ å°„ï¼Œå­—å…¸ä¸­çš„æ¯ä¸ªé”®å€¼å¯¹éƒ½ä¿å­˜äº†ä¸€ä¸ªé›†åˆå…ƒç´ :å­—å…¸çš„é”®ä¿å­˜äº†å…ƒç´ çš„æˆå‘˜ï¼Œè€Œå­—å…¸çš„å€¼ä¿å­˜äº†å…ƒç´ çš„åˆ†å€¼ã€‚é€šè¿‡è¿™ä¸ªå­—å…¸ï¼Œç¨‹åºå¯ä»¥O(1)å¤æ‚åº¦æŸ¥æ‰¾ç»™å®šæˆå‘˜çš„åˆ†å€¼ï¼ŒZSCOREå‘½ä»¤å°±æ˜¯æ ¹æ®è¿™ä¸€ç‰¹æ€§å®ç°çš„ã€‚</p><p>è™½ç„¶zsetç»“æ„åŒæ—¶ä½¿ç”¨è·³è·ƒè¡¨å’Œå­—å…¸æ¥ä¿å­˜æœ‰åºé›†åˆå…ƒç´ ï¼Œè€Œè¿™ä¸¤ç§æ•°æ®æœºæ„éƒ½ä¼šé€šè¿‡æŒ‡é’ˆæ¥å…±äº«ç›¸åŒå…ƒç´ çš„æˆå‘˜å’Œåˆ†å€¼ï¼Œæ‰€ä»¥åŒæ—¶ä½¿ç”¨è·³è·ƒè¡¨å’Œå­—å…¸æ¥ä¿å­˜é›†åˆå…ƒç´ ä¸ä¼šäº§ç”Ÿä»»ä½•é‡å¤æˆå‘˜æˆ–åˆ†å€¼ï¼Œä¹Ÿä¸ä¼šæµªè´¹é¢å¤–å†…å­˜ã€‚</p><blockquote><p><strong>ä¸ºä»€ä¹ˆæœ‰åºé›†åˆéœ€è¦åŒæ—¶ä½¿ç”¨è·³è·ƒè¡¨å’Œå­—å…¸æ¥å®ç°ï¼Ÿ</strong><br>å¦‚æœæˆ‘ä»¬åªæ˜¯ç”¨å­—å…¸æ¥å®ç°æœ‰åºé›†åˆï¼Œé‚£ä¹ˆè™½ç„¶å·²O(1)å¤æ‚åº¦æŸ¥æ‰¾æˆå‘˜çš„åˆ†å€¼è¿™ä¸€ç‰¹æ€§è¢«ä¿ç•™ï¼Œä½†æ˜¯å­—å…¸ä»¥æ— åºçš„æ–¹å¼ä¿å­˜é›†åˆå…ƒç´ ï¼Œæ‰€ä»¥æ¯æ¬¡åœ¨æ‰§è¡ŒèŒƒå›´æ“ä½œæ—¶ï¼Œéƒ½éœ€è¦å¯¹å­—å…¸ä¿å­˜çš„æ‰€æœ‰å…ƒç´ è¿›è¡Œæ’åºï¼Œå®Œæˆè¿™ç§æ’åºè‡³å°‘éœ€è¦O(NlogN)æ—¶é—´å¤æ‚åº¦ï¼Œä»¥åŠé¢å¤–çš„O(N)å†…å­˜ç©ºé—´ã€‚åŒæ ·å¦‚æœåªæ˜¯ç”¨è·³è·ƒè¡¨ï¼Œæ ¹æ®æˆå‘˜æŸ¥æ‰¾åˆ†å€¼æ“ä½œå¤æ‚åº¦å°†ä¸ºO(logN)ã€‚</p></blockquote><p><strong>skiplistç»“æ„ï¼š</strong></p><p><img src="/media/article/sorted-set-skiplist.png" alt="sorted-set-skiplist"></p><p><strong><em>æ³¨æ„ï¼šå­—å…¸å’Œè·³è·ƒè¡¨ä¼šå…±äº«å…ƒç´ çš„æˆå‘˜å’Œåˆ†å€¼ï¼Œå¹¶ä¸ä¼šé€ æˆæ•°æ®é‡å¤ã€‚</em></strong></p><p><strong>å‘½ä»¤å®ç°ï¼š</strong></p><p><img src="/media/article/sorted-set-order.png" alt="sorted-set-order"></p><h4 id="1-8-7-ç±»å‹æ£€æŸ¥ä¸å‘½ä»¤å¤šæ€"><a href="#1-8-7-ç±»å‹æ£€æŸ¥ä¸å‘½ä»¤å¤šæ€" class="headerlink" title="1.8.7 ç±»å‹æ£€æŸ¥ä¸å‘½ä»¤å¤šæ€"></a>1.8.7 ç±»å‹æ£€æŸ¥ä¸å‘½ä»¤å¤šæ€</h4><p>Redisä¸­ç”¨äºæ“ä½œé”®çš„å‘½ä»¤åŸºæœ¬ä¸Šå¯ä»¥åˆ†ä¸ºä¸¤ç§ç±»å‹ã€‚<br>ä¸€ç§å¯ä»¥å¯¹ä»»ä½•ç±»å‹é”®æ‰§è¡Œï¼›å¦ä¸€ç§åªèƒ½å¯¹ç‰¹å®šç±»å‹çš„é”®æ‰§è¡Œã€‚</p><p>Redisåœ¨æ‰§è¡Œä¸€ä¸ªç±»å‹ç‰¹å®šçš„å‘½ä»¤ä¹‹å‰ï¼Œä¼šå…ˆæ£€æŸ¥è¾“å…¥é”®çš„ç±»å‹æ˜¯å¦æ­£ç¡®ï¼Œç„¶åå†å†³å®šæ˜¯å¦æ‰§è¡Œç»™å®šçš„å‘½ä»¤ã€‚<br>ç±»å‹ç‰¹å®šå‘½ä»¤æ‰€è¿›è¡Œçš„ç±»å‹æ£€æŸ¥æ˜¯é€šè¿‡redisObjectç»“æ„çš„typeå±æ€§æ¥å®ç°çš„:</p><ul><li>åœ¨æ‰§è¡Œä¸€ä¸ªç±»å‹ç‰¹å®šå‘½ä»¤ä¹‹å‰ï¼ŒæœåŠ¡å™¨ä¼šå…ˆæ£€æŸ¥è¾“å…¥æ•°æ®åº“é”®çš„å€¼å¯¹è±¡æ˜¯å¦ä¸ºæ‰§è¡Œå‘½ä»¤æ‰€éœ€ç±»å‹ï¼Œå¦‚æœæ˜¯çš„è¯æ‰§è¡Œã€‚</li><li>å¦åˆ™ï¼Œæ‹’ç»æ‰§è¡Œï¼Œè¿”å›ç±»å‹é”™è¯¯ã€‚</li></ul><p>Redisé™¤äº†ä¼šæ ¹æ®å€¼å¯¹è±¡çš„ç±»å‹æ¥åˆ¤æ–­é”®æ˜¯å¦èƒ½å¤Ÿæ‰§è¡ŒæŒ‡å®šå‘½ä»¤ä¹‹å¤–ï¼Œè¿˜ä¼šæ ¹æ®å€¼å¯¹è±¡çš„ç¼–ç æ–¹å¼ï¼Œé€‰æ‹©æ­£ç¡®çš„å‘½ä»¤å®ç°ä»£ç æ¥æ‰§è¡Œå‘½ä»¤ã€‚å¦‚llenï¼š</p><p><img src="/media/article/llen-order.png" alt="llen-order"></p><h4 id="1-8-8-å†…å­˜å›æ”¶"><a href="#1-8-8-å†…å­˜å›æ”¶" class="headerlink" title="1.8.8 å†…å­˜å›æ”¶"></a>1.8.8 å†…å­˜å›æ”¶</h4><p>å› ä¸ºCä¸å…·å¤‡è‡ªåŠ¨å†…å­˜å›æ”¶åŠŸèƒ½ï¼Œæ‰€ä»¥Redisåœ¨è‡ªå·±çš„å¯¹è±¡ç³»ç»Ÿä¸­æ„å»ºäº†ä¸€ä¸ªå¼•ç”¨è®¡æ•°(reference counting)æŠ€æœ¯å®ç°çš„å†…å­˜å›æ”¶æœºåˆ¶ã€‚</p><h4 id="1-8-9-å¯¹è±¡å…±äº«"><a href="#1-8-9-å¯¹è±¡å…±äº«" class="headerlink" title="1.8.9 å¯¹è±¡å…±äº«"></a>1.8.9 å¯¹è±¡å…±äº«</h4><p>Rediså¯¹è±¡çš„å¼•ç”¨è®¡æ•°å±æ€§è¿˜å¸¦æœ‰å¯¹è±¡å…±äº«çš„ä½œç”¨ï¼ˆå¤šä¸ªé”®å…±äº«åŒä¸€ä¸ªå€¼å¯¹è±¡ï¼‰ã€‚<br>è¿™äº›å…±äº«å¯¹è±¡ä¸å•å•åªæœ‰å­—ç¬¦ä¸²é”®å¯ä»¥ä½¿ç”¨ï¼Œé‚£äº›æ•°æ®ç»“æ„ä¸­åµŒå¥—äº†å­—ç¬¦ä¸²å¯¹è±¡çš„å¯¹è±¡éƒ½å¯ä»¥ä½¿ç”¨è¿™äº›å…±äº«å¯¹è±¡ã€‚</p><p>Redisåªå¯¹åŒ…å«æ•´æ•°å€¼çš„å­—ç¬¦ä¸²å¯¹è±¡è¿›è¡Œå…±äº«ã€‚</p><h4 id="1-8-10-å¯¹è±¡çš„ç©ºè½¬æ—¶é•¿"><a href="#1-8-10-å¯¹è±¡çš„ç©ºè½¬æ—¶é•¿" class="headerlink" title="1.8.10 å¯¹è±¡çš„ç©ºè½¬æ—¶é•¿"></a>1.8.10 å¯¹è±¡çš„ç©ºè½¬æ—¶é•¿</h4><p>é™¤äº†typeã€encodingã€ptrå’Œrefcountå››ä¸ªå±æ€§å¤–ï¼ŒredisObjectç»“æ„åŒ…å«çš„æœ€åä¸€ä¸ªå±æ€§ä¸ºlruå±æ€§:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">typedef struct redisObject&#123;</span><br><span class="line">    unsigned lru:22;</span><br><span class="line">&#125; robj;</span><br></pre></td></tr></table></figure></p><p>OBJECT IDLETIMEå‘½ä»¤å¯ä»¥æ‰“å°å‡ºé”®çš„ç©ºè½¬æ—¶é•¿ï¼Œè®¡ç®—æ–¹å¼ï¼šå½“å‰æ—¶é—´-lruã€‚</p><h2 id="2-å•æœºæ•°æ®åº“å®ç°"><a href="#2-å•æœºæ•°æ®åº“å®ç°" class="headerlink" title="2. å•æœºæ•°æ®åº“å®ç°"></a>2. å•æœºæ•°æ®åº“å®ç°</h2><p>RedisæœåŠ¡å™¨å°†æ‰€æœ‰æ•°æ®åº“éƒ½ä¿å­˜åœ¨æœåŠ¡å™¨çŠ¶æ€redis.h/redisServerç»“æ„çš„dbæ•°ç»„ä¸­ï¼Œdbæ•°ç»„çš„æ¯ä¸ªé¡¹éƒ½æ˜¯ä¸€ä¸ªredis.h/redisDbç»“æ„ï¼Œæ¯ä¸ªredisDbç»“æ„ä»£è¡¨ä¸€ä¸ªæ•°æ®åº“ã€‚</p><p><strong>æ•°æ®åº“ç»“æ„ç¤ºä¾‹ï¼š</strong><br><img src="/media/article/redis-db.png" alt="db"></p><p>redisDbç»“æ„çš„dictå­—å…¸ä¿å­˜äº†æ•°æ®åº“ä¸­çš„æ‰€æœ‰é”®å€¼å¯¹ï¼Œæˆ‘ä»¬å°†è¿™ä¸ªå­—å…¸æˆä¸ºé”®ç©ºé—´ï¼š</p><p><strong>æ•°æ®åº“é”®ç©ºé—´ç¤ºä¾‹ï¼š</strong><br><img src="/media/article/redis-db-keyspace.png" alt="db"></p><p>é”®ç©ºé—´çš„é”®ä¹Ÿå°±æ˜¯æ•°æ®åº“çš„é”®ï¼Œæ¯ä¸ªé”®éƒ½æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ã€‚<br>é”®ç©ºé—´çš„å€¼ä¹Ÿå°±æ˜¯æ•°æ®åº“çš„å€¼ï¼Œæ¯ä¸ªå€¼å¯ä»¥æ˜¯å­—ç¬¦ä¸²å¯¹è±¡ã€åˆ—è¡¨å¯¹è±¡ã€å“ˆå¸Œè¡¨å¯¹è±¡ã€é›†åˆå¯¹è±¡å’Œæœ‰åºé›†åˆå¯¹è±¡ä¸­çš„ä»»æ„ä¸€ç§Rediså¯¹è±¡ã€‚<br>æ•°æ®åº“çš„é”®ç©ºé—´æ˜¯ä¸€ä¸ªå­—å…¸ã€‚</p><p><strong> è¯»å†™ç©ºé—´æ—¶çš„ç»´æŠ¤æ“ä½œ</strong></p><ul><li>è¯»å–ä¸€ä¸ªé”®åï¼ŒæœåŠ¡å™¨ä¼šæ ¹æ®é”®æ˜¯å¦å­˜åœ¨æ¥æ›´æ–°æœåŠ¡å™¨çš„é”®ç©ºé—´å‘½ä¸­æ¬¡æ•°æˆ–é”®ç©ºé—´ä¸å‘½ä¸­æ¬¡æ•°ï¼Œè¿™ä¸¤ä¸ªå€¼å¯ä»¥åœ¨INFO statså‘½ä»¤çš„keyspace_hitså±æ€§å’Œkeyspace_misseså±æ€§ä¸­æŸ¥çœ‹ã€‚</li><li>è¯»å–ä¸€ä¸ªé”®åï¼ŒæœåŠ¡å™¨ä¼šæ›´æ–°é”®çš„LRUæ—¶é—´ï¼Œå¯ä»¥ä½¿ç”¨OBJECT idletime <key> å‘½ä»¤æŸ¥çœ‹é”®keyçš„é—²ç½®æ—¶é—´ã€‚</key></li><li>å¦‚æœæœåŠ¡å™¨åœ¨è¯»å–ä¸€ä¸ªé”®æ—¶å‘ç°è¯¥é”®è¿‡æœŸï¼ŒæœåŠ¡å™¨ä¼šå…ˆåˆ é™¤è¿™ä¸ªè¿‡æœŸé”®ï¼Œç„¶åæ‰æ‰§è¡Œä½™ä¸‹çš„å…¶ä»–æ“ä½œã€‚</li><li>å¦‚æœå®¢æˆ·ç«¯ä½¿ç”¨watchå‘½ä»¤ç›‘è§†äº†æŸä¸ªé”®ï¼Œé‚£ä¹ˆæœåŠ¡å™¨åœ¨å¯¹è¢«ç›‘è§†çš„é”®è¿›è¡Œä¿®æ”¹åï¼Œä¼šå°†è¿™ä¸ªé”®æ ‡è®°ä¸ºè„(dirty)ã€‚</li><li>æœåŠ¡å™¨æ¯æ¬¡ä¿®æ”¹ä¸€ä¸ªé”®åï¼Œéƒ½ä¼šå¯¹(dirty)é”®è®¡æ•°å™¨çš„å€¼å¢1ï¼Œè¿™ä¸ªè®¡æ•°å™¨ä¼šè§¦å‘æœåŠ¡å™¨çš„æŒä¹…åŒ–åŠå¤åˆ¶æ“ä½œã€‚</li><li>å¦‚æœæœåŠ¡å™¨å¼€å¯äº†æ•°æ®åº“é€šçŸ¥åŠŸèƒ½ï¼Œé‚£ä¹ˆå¯¹é”®è¿›è¡Œä¿®æ”¹ä¹‹åï¼ŒæœåŠ¡å™¨å°†æŒ‰é…ç½®å‘é€å“åº”çš„æ•°æ®åº“é€šçŸ¥ã€‚</li></ul><h3 id="2-1-è¿‡æœŸæ—¶é—´"><a href="#2-1-è¿‡æœŸæ—¶é—´" class="headerlink" title="2.1 è¿‡æœŸæ—¶é—´"></a>2.1 è¿‡æœŸæ—¶é—´</h3><p>Redisæœ‰å››ç§ä¸åŒçš„å‘½ä»¤å¯ä»¥ç”¨äºè®¾ç½®é”®çš„ç”Ÿå­˜æ—¶é—´æˆ–è¿‡æœŸæ—¶é—´:</p><ul><li><code>EXPIRE&lt;key&gt;&lt;ttl&gt;</code>å‘½ä»¤ç”¨äºå°†é”®keyçš„ç”Ÿå­˜æ—¶é—´è®¾ç½®ä¸ºttlç§’ã€‚</li><li><code>PEXPIRE&lt;key&gt;&lt;ttl&gt;</code>å‘½ä»¤ç”¨äºå°†é”®keyçš„ç”Ÿå­˜æ—¶é—´è®¾ç½®ä¸ºttlæ¯«ç§’ã€‚</li><li><code>EXPIREAT&lt;key&gt;&lt;timestamp&gt;</code>å‘½ä»¤ç”¨äºå°†é”®keyçš„ç”Ÿå­˜æ—¶é—´è®¾ç½®ä¸ºtimestampç§’æ•°æ—¶é—´æˆ³ã€‚</li><li><code>PEXPIRE&lt;key&gt;&lt;timestamp&gt;</code>å‘½ä»¤ç”¨äºå°†é”®keyçš„ç”Ÿå­˜æ—¶é—´è®¾ç½®ä¸ºtimestampæ¯«ç§’æ•°æ—¶é—´æˆ³ã€‚</li></ul><p>redisDbç»“æ„çš„expireså­—å…¸ä¿å­˜äº†æ•°æ®åº“ä¸­æ‰€æœ‰é”®çš„è¿‡æœŸæ—¶é—´ï¼Œæˆ‘ä»¬ç§°è¿™ä¸ªå­—å…¸ä¸ºè¿‡æœŸå­—å…¸:</p><ul><li>è¿‡æœŸå­—å…¸çš„é”®æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œè¿™ä¸ªæŒ‡é’ˆæŒ‡å‘é”®ç©ºé—´ä¸­çš„æŸä¸ªé”®å¯¹è±¡ã€‚</li><li>è¿‡æœŸå­—å…¸çš„å€¼æ˜¯ä¸€ä¸ªlong longç±»å‹çš„æ•´æ•°ï¼Œè¿™ä¸ªæ•´æ•°ä¿å­˜äº†é”®æ‰€æŒ‡å‘çš„æ•°æ®åº“é”®çš„è¿‡æœŸæ—¶é—´â€”â€”ä¸€ä¸ªæ¯«ç§’ç²¾åº¦çš„UNIXæ—¶é—´æˆ³ã€‚</li></ul><p>PERSISTå‘½ä»¤å¯ä»¥ç§»é™¤ä¸€ä¸ªé”®çš„è¿‡æœŸæ—¶é—´ã€‚</p><p>TTLå‘½ä»¤ä»¥ç§’çº§å•ä½è¿”å›é”®çš„å‰©ä½™ç”Ÿå­˜æ—¶é—´ï¼ŒPTTLå‘½ä»¤ä»¥æ¯«ç§’ä¸ºå•ä½è¿”å›é”®çš„å‰©ä½™ç”Ÿå­˜æ—¶é—´ã€‚</p><h3 id="2-2-è¿‡æœŸé”®åˆ é™¤ç­–ç•¥"><a href="#2-2-è¿‡æœŸé”®åˆ é™¤ç­–ç•¥" class="headerlink" title="2.2 è¿‡æœŸé”®åˆ é™¤ç­–ç•¥"></a>2.2 è¿‡æœŸé”®åˆ é™¤ç­–ç•¥</h3><p>å®šæ—¶åˆ é™¤: åœ¨è®¾ç½®é”®çš„è¿‡æœŸæ—¶é—´çš„åŒæ—¶ï¼Œåˆ›å»ºä¸€ä¸ªå®šæ—¶å™¨(timer)ï¼Œè®©å®šæ—¶å™¨åœ¨é”®çš„è¿‡æœŸæ—¶é—´æ¥ä¸´æ—¶ï¼Œç«‹å³æ‰§è¡Œå¯¹é”®çš„åˆ é™¤æ“ä½œã€‚<br>æƒ°æ€§åˆ é™¤: æ”¾ä»»é”®è¿‡æœŸä¸ç®¡ï¼Œä½†æ˜¯æ¯æ¬¡ä»é”®ç©ºé—´ä¸­è·å–é”®æ—¶ï¼Œéƒ½æ£€æŸ¥å–å¾—çš„é”®æ˜¯å¦è¿‡æœŸï¼Œå¦‚æœè¿‡æœŸçš„è¯ï¼Œå°±åˆ é™¤è¯¥é”®ï¼›å¦‚æœæ²¡æœ‰è¿‡æœŸï¼Œå°±è¿”å›è¯¥é”®ã€‚<br>å®šæœŸåˆ é™¤: æ¯éš”ä¸€æ®µæ—¶é—´ï¼Œç¨‹åºå°±å¯¹æ•°æ®åº“è¿›è¡Œä¸€æ¬¡æ£€æŸ¥ï¼Œåˆ é™¤é‡Œé¢çš„è¿‡æœŸé”®ã€‚è‡³äºè¦åˆ é™¤å¤šå°‘è¿‡æœŸé”®ï¼Œä»¥åŠè¦æ£€æŸ¥å¤šå°‘ä¸ªæ•°æ®åº“ï¼Œåˆ™ç”±ç®—æ³•å†³å®šã€‚</p><h4 id="2-2-1-å®šæ—¶åˆ é™¤"><a href="#2-2-1-å®šæ—¶åˆ é™¤" class="headerlink" title="2.2.1 å®šæ—¶åˆ é™¤"></a>2.2.1 å®šæ—¶åˆ é™¤</h4><p>å®šæ—¶åˆ é™¤å¯¹å†…å­˜å‹å¥½ï¼Œå¯¹CPUæ—¶é—´ä¸å‹å¥½ï¼Œåœ¨è¿‡æœŸé”®æ¯”è¾ƒå¤šçš„æƒ…å†µä¸‹ï¼Œåˆ é™¤è¿‡æœŸé”®è¿™ä¸€è¡Œä¸ºå¯èƒ½ä¼šå ç”¨ç›¸åŒä¸€éƒ¨åˆ†CPUæ—¶é—´ã€‚</p><h4 id="2-2-2-æƒ°æ€§åˆ é™¤"><a href="#2-2-2-æƒ°æ€§åˆ é™¤" class="headerlink" title="2.2.2 æƒ°æ€§åˆ é™¤"></a>2.2.2 æƒ°æ€§åˆ é™¤</h4><p>æƒ°æ€§åˆ é™¤ç­–ç•¥å¯¹CPUå‹å¥½ï¼Œå¯¹å†…å­˜ä¸å‹å¥½ã€‚æœ‰å†…å­˜æ³„æ¼çš„é£é™©ã€‚</p><h4 id="2-2-3-å®šæœŸåˆ é™¤"><a href="#2-2-3-å®šæœŸåˆ é™¤" class="headerlink" title="2.2.3 å®šæœŸåˆ é™¤"></a>2.2.3 å®šæœŸåˆ é™¤</h4><p>å®šæœŸåˆ é™¤æ“ä½œçš„éš¾ç‚¹åœ¨äºå¦‚æœç¡®å®šåˆ é™¤æ“ä½œçš„æ—¶é•¿å’Œé¢‘ç‡ã€‚</p><h4 id="2-2-4-Redisçš„è¿‡æœŸåˆ é™¤ç­–ç•¥"><a href="#2-2-4-Redisçš„è¿‡æœŸåˆ é™¤ç­–ç•¥" class="headerlink" title="2.2.4 Redisçš„è¿‡æœŸåˆ é™¤ç­–ç•¥"></a>2.2.4 Redisçš„è¿‡æœŸåˆ é™¤ç­–ç•¥</h4><p>RedisæœåŠ¡å™¨å®é™…ä½¿ç”¨çš„æ˜¯æƒ°æ€§åˆ é™¤å’Œå®šæœŸåˆ é™¤ä¸¤ç§ç­–ç•¥ã€‚</p><h4 id="2-2-5-AOFã€RDBå’Œå¤åˆ¶åŠŸèƒ½å¯¹è¿‡æœŸé”®çš„å¤„ç†"><a href="#2-2-5-AOFã€RDBå’Œå¤åˆ¶åŠŸèƒ½å¯¹è¿‡æœŸé”®çš„å¤„ç†" class="headerlink" title="2.2.5 AOFã€RDBå’Œå¤åˆ¶åŠŸèƒ½å¯¹è¿‡æœŸé”®çš„å¤„ç†"></a>2.2.5 AOFã€RDBå’Œå¤åˆ¶åŠŸèƒ½å¯¹è¿‡æœŸé”®çš„å¤„ç†</h4><p>åœ¨æ‰§è¡ŒSAVEå‘½ä»¤æˆ–è€…BGSAVEå‘½ä»¤åˆ›å»ºä¸€ä¸ªæ–°çš„RDBæ–‡ä»¶æ˜¯ï¼Œç¨‹åºä¼šå¯¹æ•°æ®åº“ä¸­çš„é”®è¿›è¡Œæ£€æŸ¥ï¼Œå·²è¿‡æœŸçš„é”®ä¸ä¼šä¿å­˜åˆ°æ–°å»ºçš„RDBæ–‡ä»¶ä¸­ã€‚</p><p><strong>RDBæ–‡ä»¶è½½å…¥ï¼š</strong></p><ul><li>å¦‚æœæœåŠ¡å™¨ä»¥ä¸»æœåŠ¡å™¨æ¨¡å¼è¿è¡Œï¼Œé‚£ä¹ˆåœ¨è½½å…¥RDBæ–‡ä»¶æ—¶ï¼Œç¨‹åºä¼šå¯¹æ–‡ä»¶ä¸­ä¿å­˜çš„é”®è¿›è¡Œæ£€æŸ¥ï¼Œæœªè¿‡æœŸçš„é”®ä¼šè¢«è½½å…¥åˆ°æ•°æ®åº“ä¸­ï¼Œè€Œè¿‡æœŸé”®åˆ™ä¼šè¢«å¿½ç•¥ï¼Œæ‰€ä»¥è¿‡æœŸé”®å¯¹è½½å…¥RDBæ–‡ä»¶çš„ä¸»æœåŠ¡å™¨ä¸ä¼šé€ æˆå½±å“ã€‚</li><li>å¦‚æœæœåŠ¡å™¨ä»¥ä»æœåŠ¡å™¨æ¨¡å‹è¿è¡Œï¼Œé‚£ä¹ˆè½½å…¥RDBæ–‡ä»¶æ—¶ï¼Œæ–‡ä»¶ä¸­ä¿å­˜çš„æ‰€æœ‰é”®ï¼Œä¸è®ºæ˜¯å¦è¿‡æœŸï¼Œéƒ½ä¼šè¢«è½½å…¥åˆ°æ•°æ®åº“ä¸­ã€‚ä¸è¿‡ä¸»ä»æœåŠ¡å™¨åœ¨è¿›è¡Œæ•°æ®åŒæ­¥æ—¶ï¼Œä»æœåŠ¡å™¨çš„æ•°æ®åº“ä¼šè¢«æ¸…ç©ºã€‚</li></ul><p>AOFé‡å†™çš„è¿‡ç¨‹ä¸­ï¼Œä¼šå¯¹æ•°æ®åº“ä¸­çš„é”®è¿›è¡Œæ£€æŸ¥ï¼Œå·²è¿‡æœŸçš„é”®ä¸ä¼šè¢«ä¿å­˜åˆ°é‡å†™åçš„AOFæ–‡ä»¶ä¸­ã€‚</p><p>å½“æœåŠ¡å™¨åœ¨å¤åˆ¶æ¨¡å¼ä¸‹æ—¶ï¼Œä»æœåŠ¡å™¨çš„è¿‡æœŸé”®åˆ é™¤åŠ¨ä½œæœ‰ä¸»æœåŠ¡å™¨æ§åˆ¶:</p><ul><li>ä¸»æœåŠ¡å™¨åœ¨åˆ é™¤ä¸€ä¸ªè¿‡æœŸé”®åï¼Œä¼šæ˜¾å¼åœ°å‘æ‰€æœ‰ä»æœåŠ¡å™¨å‘é€ä¸€ä¸ªDELå‘½ä»¤ï¼Œå‘Šè¯‰ä»æœåŠ¡å™¨åˆ é™¤è¿™ä¸ªè¿‡æœŸé”®ã€‚</li><li>ä»æœåŠ¡å™¨åœ¨æ‰§è¡Œå®¢æˆ·ç«¯å‘é€çš„è¯»å‘½ä»¤æ—¶ï¼ŒåŠæ—¶ç¢°åˆ°è¿‡æœŸé”®ä¹Ÿä¸ä¼šå°†è¿‡æœŸé”®åˆ é™¤ï¼Œè€Œç»§ç»­åƒå¤„ç†æœªè¿‡æœŸçš„é”®ä¸€æ ·å¤„ç†è¿‡æœŸé”®ã€‚</li><li>ä»æœåŠ¡å™¨åªæœ‰åœ¨æ¥åˆ°ä¸»æœåŠ¡å™¨å‘æ¥çš„DELå‘½ä»¤åï¼Œæ‰ä¼šåˆ é™¤è¿‡æœŸé”®ã€‚</li></ul><h4 id="2-2-6-æ•°æ®åº“é€šçŸ¥"><a href="#2-2-6-æ•°æ®åº“é€šçŸ¥" class="headerlink" title="2.2.6 æ•°æ®åº“é€šçŸ¥"></a>2.2.6 æ•°æ®åº“é€šçŸ¥</h4><p>æ•°æ®åº“é€šçŸ¥æ—¶Redis 2.8ç‰ˆæœ¬æ–°å¢åŠ çš„åŠŸèƒ½ï¼Œè¿™ä¸ªåŠŸèƒ½å¯ä»¥è®©å®¢æˆ·ç«¯é€šè¿‡è®¢é˜…ç»™å®šçš„é¢‘é“æˆ–è€…æ¨¡å¼ï¼Œè·çŸ¥æ•°æ®åº“ä¸­é”®çš„å˜åŒ–ï¼Œä»¥åŠæ•°æ®åº“ä¸­å‘½ä»¤çš„æ‰§è¡Œæƒ…å†µã€‚</p><p>ç›‘å¬ç´¢å¼•ä¸º0çš„é”®ç©ºé—´keyä¸ºmessageæ‰€æœ‰æ“ä½œã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; SUBSCRIBE __keyspace@0__:message</span><br></pre></td></tr></table></figure></p><h3 id="2-3-RDBæŒä¹…åŒ–"><a href="#2-3-RDBæŒä¹…åŒ–" class="headerlink" title="2.3 RDBæŒä¹…åŒ–"></a>2.3 RDBæŒä¹…åŒ–</h3><h4 id="2-3-1-RDBæ–‡ä»¶çš„åˆ›å»ºä¸è½½å…¥"><a href="#2-3-1-RDBæ–‡ä»¶çš„åˆ›å»ºä¸è½½å…¥" class="headerlink" title="2.3.1 RDBæ–‡ä»¶çš„åˆ›å»ºä¸è½½å…¥"></a>2.3.1 RDBæ–‡ä»¶çš„åˆ›å»ºä¸è½½å…¥</h4><p>Rediså‘½ä»¤å¯ç”¨äºç”ŸæˆRDBæ–‡ä»¶ï¼Œä¸€ä¸ªæ˜¯SAVEï¼Œå¦ä¸€ä¸ªæ˜¯BGSAVEã€‚<br>SAVEä¼šé˜»å¡RedisæœåŠ¡è¿›ç¨‹ï¼ŒçŸ¥é“RDBæ–‡ä»¶åˆ›å»ºå®Œæ¯•ï¼Œé˜»å¡æœŸé—´ï¼ŒæœåŠ¡å™¨ä¸èƒ½å¤„ç†ä»»ä½•å‘½ä»¤è¯·æ±‚ã€‚<br>BGSAVEå‘½ä»¤ä¼šæ´¾ç”Ÿé™¤ä¸€ä¸ªå­è¿›ç¨‹ï¼Œç„¶åç”±å­è¿›ç¨‹è´Ÿè´£åˆ›å»ºRDBæ–‡ä»¶ï¼ŒæœåŠ¡å™¨è¿›ç¨‹ç»§ç»­å¤„ç†å‘½ä»¤è¯·æ±‚ã€‚<br>BGSAVEå‘½ä»¤æ­£åœ¨æ‰§è¡Œï¼Œå®¢æˆ·ç«¯å‘é€çš„BGREWRITEAOFå‘½ä»¤ä¼šè¢«å»¶è¿Ÿåˆ°BGSAVEå‘½ä»¤æ‰§è¡Œå®Œæ¯•åæ‰§è¡Œã€‚<br>BGREWRITEAOFæ­£åœ¨æ‰§è¡Œï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯å‘é€çš„BGSAVEå‘½ä»¤ä¼šè¢«æœåŠ¡å™¨æ‹’ç»ã€‚</p><blockquote><p>å¦‚æœå¼€å¯äº†AOFæŒä¹…åŒ–åŠŸèƒ½ï¼ŒæœåŠ¡å™¨ä¼šä¼˜å…ˆä½¿ç”¨AOFæ–‡ä»¶è¿˜åŸæ•°æ®åº“çŠ¶æ€ã€‚<br>åªæœ‰AOFæŒä¹…åŒ–åŠŸèƒ½å¤„äºå…³é—­çŠ¶æ€æ—¶ï¼ŒæœåŠ¡å™¨æ‰ä¼šä½¿ç”¨RDBæ–‡ä»¶æ¥è¿˜åŸæ•°æ®åº“çŠ¶æ€ã€‚</p></blockquote><h4 id="2-3-2-è‡ªåŠ¨é—´éš”æ€§ä¿å­˜"><a href="#2-3-2-è‡ªåŠ¨é—´éš”æ€§ä¿å­˜" class="headerlink" title="2.3.2 è‡ªåŠ¨é—´éš”æ€§ä¿å­˜"></a>2.3.2 è‡ªåŠ¨é—´éš”æ€§ä¿å­˜</h4><h4 id="2-3-3-RDBæ–‡ä»¶ç»“æ„"><a href="#2-3-3-RDBæ–‡ä»¶ç»“æ„" class="headerlink" title="2.3.3 RDBæ–‡ä»¶ç»“æ„"></a>2.3.3 RDBæ–‡ä»¶ç»“æ„</h4><p><img src="/media/article/rdb-structure.png" alt="rdb"></p><p>REDISéƒ¨åˆ†ç”¨æ¥æ ¡éªŒæ˜¯å¦ä¸ºRDBæ–‡ä»¶ã€‚<br>db_versioné•¿åº¦ä¸º4å­—èŠ‚ï¼Œè®°å½•RDBæ–‡ä»¶çš„ç‰ˆæœ¬å·ã€‚<br>databaseséƒ¨åˆ†åŒ…å«ç€ä¸¤ä¸ªæˆ–è€…ä»»æ„å¤šä¸ªæ•°æ®åº“ï¼Œä»¥åŠå„ä¸ªæ•°æ®åº“ä¸­çš„é”®å€¼å¯¹æ•°æ®ã€‚<br>EOFæ ‡å¿—ç€RDBæ–‡ä»¶çš„æ­£æ–‡ç»“æŸã€‚<br>check_sumä¿å­˜ç€ä¸€ä¸ªæ ¡éªŒå’Œï¼Œç”±REDISã€db_versionã€databasesã€EOFè®¡ç®—å¾—å‡ºã€‚æ ¡éªŒRDBæ–‡ä»¶æ˜¯å¦å‡ºé”™æˆ–è€…æŸåã€‚</p><p>databaseéƒ¨åˆ†ä¿å­˜ä»»æ„å¤šä¸ªéç©ºæ•°æ®åº“ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ¯ä¸ªéç©ºæ•°æ®åº“å¯ä»¥ä¿å­˜SELECTDBã€db_numberã€key_value_pairs:</p><p><img src="/media/article/rdb-structure1.png" alt="rdb"><br><img src="/media/article/rdb-database.png" alt="rdb"></p><p>SELEECTè¡¨ç¤ºæ•°æ®åº“å·ç ã€‚<br>db_numberä¿å­˜ä¸€ä¸ªæ•°æ®åº“å·ç ã€‚<br>key_value_pairsä¿å­˜æ•°æ®åº“ä¸­çš„æ‰€æœ‰é”®å€¼å¯¹æ•°æ®ã€‚</p><p><img src="/media/article/rdb-file-structure.png" alt="rdb"></p><p>key_values_pairsä¿å­˜äº†ä¸€ä¸ªä»¥ä¸Šçš„é”®å€¼å¯¹ï¼Œå¦‚æœé”®å€¼å¯¹å¸¦æœ‰è¿‡æœŸæ—¶é—´çš„è¯ï¼Œé‚£ä¹ˆé”®å€¼å¯¹çš„è¿‡æœŸæ—¶é—´ä¹Ÿä¼šè¢«ä¿å­˜åœ¨å†…ã€‚<br>ä¸è¿‡æœŸæ—¶é—´çš„é”®å€¼å¯¹ç”±TYPEã€keyã€valueç»„æˆã€‚<br>TYPE:</p><ul><li>REDIS_RDB_TYPE_STRING</li><li>REDIS_RDB_TYPE_LIST</li><li>REDIS_RDB_TYPE_SET</li><li>REDIS_RDB_TYPE_ZSET</li><li>REDIS_RDB_TYPE_HASH</li><li>REDIS_RDB_TYPE_LIST_ZIPLIST</li><li>REDIS_RDB_TYPE_SET_INTSET</li><li>REDIS_RDB_TYPE_ZSET_ZIPLIST</li><li>REDIS_RDB_TYPE_ZIPLIST</li></ul><p>è¿‡æœŸæ—¶é—´çš„é”®å€¼å¯¹åœ¨RDBæ–‡ä»¶ä¸­ç»“æ„:<br><img src="/media/article/rdb-expire-structure.png" alt="rdb"></p><h3 id="2-4-AOFæŒä¹…åŒ–"><a href="#2-4-AOFæŒä¹…åŒ–" class="headerlink" title="2.4 AOFæŒä¹…åŒ–"></a>2.4 AOFæŒä¹…åŒ–</h3><p>AOFæŒä¹…åŒ–åŠŸèƒ½çš„å®ç°å¯ä»¥åˆ†ä¸ºå‘½ä»¤è¿½åŠ ã€æ–‡ä»¶å†™å…¥ã€æ–‡ä»¶åŒæ­¥ä¸‰ä¸ªæ­¥éª¤ã€‚</p><h4 id="2-4-1-å‘½ä»¤è¿½åŠ "><a href="#2-4-1-å‘½ä»¤è¿½åŠ " class="headerlink" title="2.4.1 å‘½ä»¤è¿½åŠ "></a>2.4.1 å‘½ä»¤è¿½åŠ </h4><p>å½“AOFæŒä¹…åŒ–åŠŸèƒ½å¤„äºæ‰“å¼€çŠ¶æ€æ—¶ï¼ŒæœåŠ¡å™¨åœ¨æ‰§è¡Œå®Œä¸€ä¸ªå†™å‘½ä»¤åï¼Œä¼šä»¥åè®®æ ¼å¼å°†è¢«æ‰§è¡Œçš„å†™å‘½ä»¤è¿½åŠ åˆ°æœåŠ¡å™¨çŠ¶æ€çš„aof_bufç¼“å†²åŒºæœ«å°¾:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">struct redisServer&#123;</span><br><span class="line">    sds aof_buf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="2-4-2-æ–‡ä»¶å†™å…¥ä¸åŒæ­¥"><a href="#2-4-2-æ–‡ä»¶å†™å…¥ä¸åŒæ­¥" class="headerlink" title="2.4.2 æ–‡ä»¶å†™å…¥ä¸åŒæ­¥"></a>2.4.2 æ–‡ä»¶å†™å…¥ä¸åŒæ­¥</h4><p>Redisçš„æœåŠ¡å™¨è¿›ç¨‹å°±æ˜¯ä¸€ä¸ªäº‹ä»¶å¾ªç¯ï¼Œè¿™ä¸ªå¾ªç¯ä¸­çš„æ–‡ä»¶äº‹ä»¶è´Ÿè´£æ¥æ”¶å®¢æˆ·ç«¯çš„å‘½ä»¤è¯·æ±‚ï¼Œä»¥åŠå‘å®¢æˆ·ç«¯å‘é€å‘½ä»¤å›å¤ï¼Œè€Œæ—¶é—´äº‹ä»¶åˆ™è´Ÿè´£æ‰§è¡ŒåƒserverCronå‡½æ•°è¿™æ ·éœ€è¦å®šæ—¶è¿è¡Œçš„å‡½æ•°ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">def eventLoop():</span><br><span class="line">    while True:</span><br><span class="line">        # å¤„ç†æ–‡ä»¶äº‹ä»¶ï¼Œæ¥æ”¶å‘½ä»¤è¯·æ±‚ä»¥åŠå‘é€å‘½ä»¤å›å¤</span><br><span class="line">        # å¤„ç†å‘½ä»¤è¯·æ±‚æ—¶å¯èƒ½ä¼šæœ‰æ–°å†…å®¹è¢«è¿½åŠ åˆ°aof_bufç¼“å†²åŒºä¸­</span><br><span class="line">        processFileEvents()</span><br><span class="line">        </span><br><span class="line">        # å¤„ç†æ—¶é—´äº‹ä»¶</span><br><span class="line">        processTimeEvents()</span><br><span class="line">        </span><br><span class="line">        # è€ƒè™‘æ˜¯å¦å°†aof_bufä¸­çš„å†…å®¹å†™å…¥å’Œä¿å­˜åˆ°AOFæ–‡ä»¶é‡Œé¢</span><br><span class="line">        flushAppendOnlyFile()</span><br></pre></td></tr></table></figure><p>flushAppendOnlyFileå‡½æ•°çš„è¡Œä¸ºç”±æœåŠ¡å™¨é…ç½®çš„appendfsyncé€‰é¡¹çš„å€¼æ¥å†³å®šï¼Œå„ä¸ªä¸åŒå€¼äº§ç”Ÿçš„è¡Œä¸ºå¦‚è¡¨:<br><img src="/media/article/appendfsycn.png" alt="appendfsync"></p><h4 id="2-4-3-AOFé‡å†™"><a href="#2-4-3-AOFé‡å†™" class="headerlink" title="2.4.3 AOFé‡å†™"></a>2.4.3 AOFé‡å†™</h4><p>å› ä¸ºAOFé€šè¿‡ä¿å­˜æ‰§è¡Œçš„å†™å‘½ä»¤æ¥è®°å½•æ•°æ®åº“çŠ¶æ€ï¼Œæ‰€ä»¥å¯èƒ½é€ æˆAOFæ–‡ä»¶è¿‡å¤§ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒRedisæä¾›äº†AOFæ–‡ä»¶é‡å†™åŠŸèƒ½ã€‚é€šè¿‡åˆ›å»ºä¸€ä¸ªæ–°çš„AOFæ–‡ä»¶æ›¿ä»£ç°æœ‰çš„AOFæ–‡ä»¶ï¼Œæ–°æ—§ä¸¤ä¸ªAOFæ–‡ä»¶æ‰€ä¿å­˜çš„æ•°æ®åº“çŠ¶æ€ç›¸åŒï¼Œä½†æ–°AOFæ–‡ä»¶ä¸ä¼šåŒ…å«ä»»ä½•æµªè´¹ç©ºé—´çš„å†—ä½™å‘½ä»¤ï¼Œæ‰€ä»¥æ–°AOFé€šå¸¸æ¯”æ—§AOFå°å¾—å¤šã€‚<br>é‡å†™åŠŸèƒ½é€šè¿‡è¯»å–æœåŠ¡å™¨å½“å‰çš„æ•°æ®çŠ¶æ€æ¥å®ç°çš„ã€‚å› ä¸ºaofâ€”â€”rewirteå‡½æ•°ç”Ÿæˆçš„æ–°çš„AOFåªåŒ…å«è¿˜åŸå½“å‰æ•°æ®åº“çŠ¶æ€æ‰€å¿…éœ€çš„çš„å‘½ä»¤ï¼Œæ‰€ä»¥æ–°AOFæ–‡ä»¶ä¸ä¼šæµªè´¹ä»»ä½•ç¡¬ç›˜ç©ºé—´ã€‚</p><p><strong>æ³¨æ„:</strong><br>åœ¨å®é™…ä¸­ï¼Œä¸ºäº†é¿å…æ‰§è¡Œå‘½ä»¤æ—¶é€ æˆå®¢æˆ·ç«¯è¾“å…¥ç¼“å†²åŒºæº¢å‡ºï¼Œé‡å†™ç¨‹åºåœ¨å¤„ç†åˆ—è¡¨ã€å“ˆå¸Œè¡¨ã€é›†åˆã€æœ‰åºé›†åˆè¿™å››ç§å¯èƒ½ä¼šå¸¦æœ‰å¤šä¸ªå…ƒç´ çš„é”®æ—¶ï¼Œä¼šå…ˆæ£€æŸ¥æ‰€åŒ…å«çš„å…ƒç´ æ•°é‡ï¼Œå¦‚æœå…ƒç´ æ•°é‡è¶…è¿‡äº†redis.h/REDIS_AOF_REWRITE_ITEMS_PER_CMDå¸¸é‡çš„å€¼ï¼Œé‚£ä¹ˆé‡å†™ç¨‹åºå°†ä½¿ç”¨å¤šæ¡å‘½ä»¤æ¥è®°å½•é”®çš„å€¼ã€‚</p><p>aof_rewriteä¼šé•¿æ—¶é—´é˜»å¡ï¼Œæ‰€ä»¥Rediså°†AOFé‡å†™ç¨‹åºæ”¾åˆ°å­è¿›ç¨‹é‡Œæ‰§è¡Œ:</p><ul><li>å­è¿›ç¨‹è¿›è¡ŒAOFé‡å†™æœŸé—´ï¼ŒæœåŠ¡å™¨è¿›ç¨‹å¯ä»¥ç»§ç»­å¤„ç†å‘½ä»¤è¯·æ±‚ã€‚</li><li>å­è¿›ç¨‹å¸¦æœ‰æœåŠ¡å™¨è¿›ç¨‹çš„æ•°æ®å‰¯æœ¬ï¼Œä½¿ç”¨å­è¿›ç¨‹è€Œä¸æ˜¯çº¿ç¨‹ï¼Œå¯ä»¥åœ¨é¿å…ä½¿ç”¨é”çš„æƒ…å†µä¸‹ï¼Œä¿è¯æ•°æ®çš„å®‰å…¨æ€§ã€‚</li></ul><p>AOFé‡å†™æœŸé—´ï¼Œå®¢æˆ·ç«¯å‘½ä»¤å¯èƒ½å¯¹ç°æœ‰æ•°æ®åº“çŠ¶æ€ä¿®æ”¹ï¼Œé€ æˆå½“å‰æ•°æ®åº“çŠ¶æ€å’ŒAOFæ–‡ä»¶ä¸ä¸€è‡´çš„æƒ…å†µã€‚</p><p>ä¸ºäº†è§£å†³ä¸ä¸€è‡´çš„æƒ…å†µï¼ŒRedisæœåŠ¡å™¨è®¾ç½®äº†ä¸€ä¸ªAOFé‡å†™ç¼“å†²åŒºï¼Œè¿™ä¸ªç¼“å†²åŒºåœ¨æœåŠ¡å™¨åˆ›å»ºå­è¿›ç¨‹ä¹‹åå¼€å§‹ä½¿ç”¨ï¼Œå½“RedisæœåŠ¡å™¨æ‰§è¡Œå®Œä¸€ä¸ªå†™å‘½ä»¤åï¼Œå®ƒåŒæ—¶å°†è¿™ä¸ªå†™å‘½ä»¤å‘é€ç»™AOFç¼“å†²åŒºå’ŒAOFé‡å†™ç¼“å†²åŒºã€‚</p><p>AOFå®Œæˆé‡å†™åï¼Œå®ƒä¼šå‘çˆ¶è¿›ç¨‹å‘é€ä¸€ä¸ªä¿¡å·ï¼Œçˆ¶è¿›ç¨‹åœ¨æ¥åˆ°è¯¥ä¿¡å·ä¹‹åï¼Œä¼šè°ƒç”¨ä¸€ä¸ªä¿¡å·å¤„ç†å‡½æ•°ï¼Œå¹¶æ‰§è¡Œä»¥ä¸‹å·¥ä½œ:</p><ul><li>å°†AOFé‡å†™ç¼“å†²åŒºä¸­çš„æ‰€æœ‰å†…å®¹å†™å…¥åˆ°æ–°AOFæ–‡ä»¶ä¸­ï¼Œè¿™æ—¶æ–°AOFæ–‡ä»¶æ‰€ä¿å­˜çš„æ•°æ®åº“çŠ¶æ€å°†å’ŒæœåŠ¡å™¨å½“å‰çš„æ•°æ®åº“çŠ¶æ€ä¸€è‡´ã€‚</li><li>å¯¹æ–°çš„AOFæ–‡ä»¶è¿›è¡Œæ”¹åï¼ŒåŸå­çš„è¦†ç›–ç°æœ‰çš„AOFæ–‡ä»¶ï¼Œå®Œæˆæ–°æ—§ä¸¤ä¸ªAOFæ–‡ä»¶çš„æ›¿æ¢ã€‚</li></ul><p>AOFåå°é‡å†™è¿‡ç¨‹ä¸­ï¼Œåªæœ‰ä¿¡å·å¤„ç†å‡½æ•°æ‰§è¡Œæ—¶ä¼šå¯¹æœåŠ¡å™¨è¿›ç¨‹é€ æˆé˜»å¡ï¼Œå…¶ä»–æ—¶å€™ï¼ŒAOFä¸ä¼šé˜»å¡çˆ¶è¿›ç¨‹ã€‚</p><h3 id="2-5-äº‹ä»¶"><a href="#2-5-äº‹ä»¶" class="headerlink" title="2.5 äº‹ä»¶"></a>2.5 äº‹ä»¶</h3><p>RedisæœåŠ¡å™¨æ˜¯ä¸€ä¸ªäº‹ä»¶é©±åŠ¨ç¨‹åº:</p><ul><li>æ–‡ä»¶äº‹ä»¶: RedisæœåŠ¡å™¨é€šè¿‡å¥—æ¥å­—ä¸å®¢æˆ·ç«¯è¿›è¡Œè¿æ¥ï¼Œè€Œæ–‡ä»¶äº‹ä»¶å°±æ˜¯æœåŠ¡å™¨å¯¹å¥—æ¥å­—æ“ä½œçš„æŠ½è±¡ã€‚æœåŠ¡å™¨ä¸å®¢æˆ·ç«¯çš„é€šä¿¡äº§ç”Ÿå“åº”çš„æ–‡ä»¶äº‹ä»¶ï¼Œè€ŒæœåŠ¡å™¨åˆ™é€šè¿‡ç›‘å¬å¹¶å¤„ç†è¿™äº›äº‹ä»¶æ¥å®Œæˆä¸€ç³»åˆ—ç½‘ç»œé€šä¿¡æ“ä½œã€‚</li><li>æ—¶é—´äº‹ä»¶: RedisæœåŠ¡å™¨ä¸­çš„ä¸€äº›æ“ä½œéœ€è¦åœ¨ç»™å®šçš„æ—¶é—´ç‚¹æ‰§è¡Œï¼Œè€Œæ—¶é—´äº‹ä»¶å°±æ˜¯æœåŠ¡å™¨å¯¹è¿™ç±»å®šæ—¶æ“ä½œçš„æŠ½è±¡ã€‚</li></ul><h4 id="2-5-1-æ–‡ä»¶äº‹ä»¶"><a href="#2-5-1-æ–‡ä»¶äº‹ä»¶" class="headerlink" title="2.5.1 æ–‡ä»¶äº‹ä»¶"></a>2.5.1 æ–‡ä»¶äº‹ä»¶</h4><p>RedisåŸºäºReactoræ¨¡å¼å¼€å‘äº†è‡ªå·±çš„ç½‘ç»œäº‹ä»¶å¤„ç†å™¨: è¿™ä¸ªå¤„ç†å™¨è¢«ç§°ä¸ºæ–‡ä»¶äº‹ä»¶å¤„ç†å™¨:</p><ul><li>æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ä½¿ç”¨I/Oå¤šè·¯å¤ç”¨ç¨‹åºæ¥åŒæ—¶ç›‘å¬å¤šä¸ªå¥—æ¥å­—ï¼Œå¹¶æ ¹æ®å¥—æ¥å­—ç›®å‰æ‰§è¡Œçš„ä»»åŠ¡æ¥ä¸ºå¥—æ¥å­—å…³è”ä¸åŒçš„äº‹ä»¶å¤„ç†å™¨ã€‚</li><li>å½“è¢«ç›‘å¬çš„å¥—æ¥å­—å‡†å¤‡å¥½æ‰§è¡Œè¿æ¥åº”ç­”ã€è¯»å–ã€å†™å…¥ã€å…³é—­ç­‰æ“ä½œæ—¶ï¼Œä¸æ“ä½œå¯¹åº”çš„æ–‡ä»¶äº‹ä»¶å°±ä¼šäº§ç”Ÿï¼Œè¿™æ—¶æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨å°±ä¼šè°ƒç”¨å¥—æ¥å­—ä¹‹å‰å…³è”å¥½çš„äº‹ä»¶å¤„ç†å™¨æ¥å¤„ç†è¿™äº›äº‹ä»¶ã€‚</li></ul><h4 id="2-5-2-æ—¶é—´äº‹ä»¶"><a href="#2-5-2-æ—¶é—´äº‹ä»¶" class="headerlink" title="2.5.2 æ—¶é—´äº‹ä»¶"></a>2.5.2 æ—¶é—´äº‹ä»¶</h4><p>Redisçš„æ—¶é—´äº‹ä»¶åˆ†ä¸ºä»¥ä¸‹ä¸¤ç±»:</p><ul><li>å®šæ—¶äº‹ä»¶: è®©ä¸€æ®µç¨‹åºåœ¨æŒ‡å®šçš„æ—¶é—´ä¹‹åæ‰§è¡Œä¸€æ¬¡ã€‚</li><li>å‘¨æœŸæ€§æ—¶é—´: è®©ä¸€æ®µç¨‹åºæ¯éš”æŒ‡å®šæ—¶é—´æ‰§è¡Œä¸€æ¬¡ã€‚</li></ul><p>ä¸€ä¸ªæ—¶é—´äº‹ä»¶ä¸»è¦ç”±ä»¥ä¸‹ä¸‰ä¸ªå±æ€§ç»„æˆ:</p><ul><li>id: æœåŠ¡å™¨ä¸ºæ—¶é—´äº‹ä»¶åˆ›å»ºçš„å…¨å±€å”¯ä¸€IDã€‚ä»å°åˆ°å¤§é€’å¢ã€‚</li><li>when: æ¯«ç§’çº§ç²¾åº¦çš„UNIXæ—¶é—´æˆ³ï¼Œè®°å½•äº†æ—¶é—´äº‹ä»¶çš„åˆ°è¾¾æ—¶é—´ã€‚</li><li>timeProc: æ—¶é—´äº‹ä»¶å¤„ç†å™¨ï¼Œä¸€ä¸ªå‡½æ•°ã€‚å½“æ—¶é—´äº‹ä»¶åˆ°è¾¾æ—¶ï¼ŒæœåŠ¡å™¨å°±ä¼šè°ƒç”¨ç›¸åº”çš„å¤„ç†å™¨æ¥å¤„ç†äº‹ä»¶ã€‚</li></ul><p>ä¸€ä¸ªæ—¶é—´äº‹ä»¶æ˜¯å®šæ—¶äº‹ä»¶è¿˜æ˜¯å‘¨æœŸæ€§äº‹ä»¶å–å†³äºæ—¶é—´äº‹ä»¶å¤„ç†å™¨çš„è¿”å›å€¼:</p><ul><li>å¦‚æœäº‹ä»¶å¤„ç†å™¨è¿”å›ae.h/AE_NOMOREï¼Œé‚£ä¹ˆè¿™ä¸ªäº‹ä»¶ä¸ºå®šæ—¶äº‹ä»¶: è¯¥äº‹ä»¶åœ¨è¾¾åˆ°ä¸€æ¬¡ä¹‹åå°±ä¼šè¢«åˆ é™¤ï¼Œä¹‹åä¸å†åˆ°è¾¾ã€‚</li><li>å¦‚æœäº‹ä»¶å¤„ç†å™¨è¿”å›ä¸€ä¸ªéAE_NOMOREçš„æ•´æ•°å€¼ï¼Œé‚£ä¹ˆè¿™ä¸ªäº‹ä»¶ä¸ºå‘¨æœŸæ€§äº‹ä»¶: å½“ä¸€ä¸ªæ—¶é—´äº‹ä»¶åˆ°è¾¾ä¹‹åï¼ŒæœåŠ¡å™¨ä¼šæ ¹æ®äº‹ä»¶å¤„ç†å™¨è¿”å›çš„å€¼ï¼Œå¯¹äº‹ä»¶äº‹ä»¶çš„whenå±æ€§è¿›è¡Œæ›´æ–°ï¼Œè¿™ä¸ªäº‹ä»¶åœ¨ä¸€æ®µæ—¶é—´ä¹‹åå†æ¬¡åˆ°è¾¾ï¼Œå¹¶ä»¥è¿™ç§æ–¹å¼ä¸€è‡´æ›´æ–°å¹¶è¿è¡Œä¸‹å»ã€‚</li></ul><p>æŒç»­è¿è¡Œçš„RedisæœåŠ¡å™¨éœ€è¦å®šæœŸå¯¹è‡ªèº«çš„èµ„æºå’ŒçŠ¶æ€è¿›è¡Œæ£€æŸ¥å’Œè°ƒæ•´ï¼Œä»è€Œç¡®ä¿æœåŠ¡å™¨å¯ä»¥é•¿æœŸã€ç¨³å®šçš„è¿è¡Œï¼Œè¿™äº›å®šæœŸæ“ä½œç”±redis.c/serverCronå‡½æ•°è´Ÿè´£æ‰§è¡Œï¼Œä¸»è¦å·¥ä½œåŒ…æ‹¬:</p><ul><li>æ›´æ–°æœåŠ¡å™¨çš„å„ç±»ç»Ÿè®¡ä¿¡æ¯ï¼Œæ¯”å¦‚æ—¶é—´ã€å†…å­˜å ç”¨ã€æ•°æ®åº“å ç”¨æƒ…å†µã€‚</li><li>æ¸…ç†æ•°æ®åº“ä¸­çš„è¿‡æœŸé”®å€¼å¯¹ã€‚</li><li>å…³é—­å’Œæ¸…ç†è¿æ¥å¤±æ•ˆçš„å®¢æˆ·ç«¯ã€‚</li><li>å°è¯•è¿›è¡ŒAOFå’ŒRDBæŒä¹…åŒ–æ“ä½œã€‚</li><li>å¦‚æœæœåŠ¡å™¨æ˜¯ä¸»æœåŠ¡å™¨ï¼Œé‚£ä¹ˆå¯¹ä»æœåŠ¡å™¨è¿›è¡Œå®šæœŸåŒæ­¥ã€‚</li><li>å¦‚æœå¤„äºé›†ç¾¤æ¨¡å¼ï¼Œå¯¹é›†ç¾¤è¿›è¡Œå®šæœŸåŒæ­¥å’Œè¿æ¥æµ‹è¯•ã€‚</li></ul><h4 id="2-5-3-äº‹ä»¶è°ƒåº¦ä¸æ‰§è¡Œ"><a href="#2-5-3-äº‹ä»¶è°ƒåº¦ä¸æ‰§è¡Œ" class="headerlink" title="2.5.3 äº‹ä»¶è°ƒåº¦ä¸æ‰§è¡Œ"></a>2.5.3 äº‹ä»¶è°ƒåº¦ä¸æ‰§è¡Œ</h4><p>äº‹ä»¶è°ƒåº¦å’Œæ‰§è¡Œç”±ae.c/aeProcessEventså‡½æ•°è´Ÿè´£ã€‚</p><blockquote><p>processFileEventè¿™ä¸ªå‡½æ•°å¹¶ä¸å­˜åœ¨ï¼Œåœ¨å®é™…ä¸­ï¼Œå¤„ç†å·²äº§ç”Ÿæ–‡ä»¶äº‹ä»¶çš„ä»£ç æ˜¯ç›´æ¥å†™åœ¨aeProcessEventså‡½æ•°é‡Œé¢ã€‚</p></blockquote><p>äº‹ä»¶è°ƒåº¦å’Œæ‰§è¡Œè§„åˆ™:</p><ol><li>aeApiPollå‡½æ•°çš„æœ€å¤§é˜»å¡æ—¶é—´ç”±åˆ°è¾¾æ—¶é—´æœ€è¿‘å½“å‰æ—¶é—´çš„æ—¶é—´äº‹ä»¶å†³å®šï¼Œè¿™ä¸ªæ–¹æ³•æ—¢å¯ä»¥é¿å…æœåŠ¡å™¨å¯¹äº‹ä»¶äº‹ä»¶è¿›è¡Œé¢‘ç¹çš„è½®è¯¢ï¼Œä¹Ÿå¯ä»¥ç¡®ä¿aeApiPollå‡½æ•°ä¸ä¼šé˜»å¡è¿‡é•¿æ—¶é—´ã€‚</li><li>å› ä¸ºæ–‡ä»¶äº‹ä»¶æ˜¯éšæœºå‡ºç°çš„ï¼Œå¦‚æœç­‰å¾…å¹¶å¤„ç†å®Œä¸€æ¬¡æ–‡ä»¶äº‹ä»¶ä¹‹åï¼Œä»æœªæœ‰ä»»ä½•äº‹ä»¶äº‹ä»¶åˆ°è¾¾ï¼Œé‚£ä¹ˆæœåŠ¡å™¨å°†å†æ¬¡ç­‰å¾…å¤„ç†æ–‡ä»¶äº‹ä»¶ã€‚éšç€æ–‡ä»¶äº‹ä»¶çš„ä¸æ–­æ‰§è¡Œï¼Œæ—¶é—´ä¼šé€æ¸å‘æ—¶é—´äº‹ä»¶æ‰€è®¾ç½®çš„åˆ°è¾¾æ—¶é—´é€¼è¿‘ï¼Œå¹¶æœ€ç»ˆæ¥åˆ°åˆ°è¾¾æ—¶é—´ï¼Œè¿™æ—¶æœåŠ¡å™¨å°±å¯ä»¥å¼€å§‹å¤„ç†åˆ°è¾¾çš„æ—¶é—´äº‹ä»¶ã€‚</li><li>å¯¹æ–‡ä»¶äº‹ä»¶å’Œæ—¶é—´äº‹ä»¶çš„å¤„ç†éƒ½æ˜¯åŒæ­¥ã€æœ‰åºã€åŸå­çš„æ‰§è¡Œçš„ï¼ŒæœåŠ¡å™¨ä¸ä¼šä¸­é€”ä¸­æ–­äº‹ä»¶å¤„ç†ï¼Œä¹Ÿä¸ä¼šå¯¹äº‹ä»¶è¿›è¡ŒæŠ¢å ï¼Œå› æ­¤ä¸ç®¡æ˜¯æ–‡ä»¶äº‹ä»¶çš„å¤„ç†å™¨ï¼Œè¿˜æ˜¯æ—¶é—´äº‹ä»¶çš„å¤„ç†å™¨ï¼Œä¹Ÿä¸ä¼šå¯¹äº‹ä»¶è¿›è¡ŒæŠ¢å ï¼Œä¸€æ¬¡ä¸ç®¡æ˜¯æ–‡ä»¶äº‹ä»¶çš„å¤„ç†å™¨ï¼Œè¿˜æ˜¯æ—¶é—´äº‹ä»¶çš„å¤„ç†å™¨ï¼Œå®ƒä»¬éƒ½ä¼šå°½å¯çš„å‡å°‘ç¨‹åºé˜»å¡æ—¶é—´ï¼Œå¹¶åœ¨æœ‰éœ€è¦æ—¶ä¸»åŠ¨è®©å‡ºæ‰§è¡Œæƒï¼Œä»è€Œé™ä½é€ æˆæ—¶é—´é¥¥é¥¿çš„å¯èƒ½æ€§ã€‚å¦å¤–ï¼Œæ—¶é—´äº‹ä»¶ä¹Ÿä¼šå°†éå¸¸è€—æ—¶çš„æŒä¹…åŒ–æ“ä½œæ”¾åˆ°å­çº¿ç¨‹æˆ–è€…å­è¿›ç¨‹æ‰§è¡Œã€‚</li><li>å› ä¸ºæ—¶é—´äº‹ä»¶åœ¨æ–‡ä»¶äº‹ä»¶ä¹‹åæ‰§è¡Œï¼Œå¹¶ä¸”äº‹ä»¶ä¹‹é—´ä¸ä¼šå‡ºç°æŠ¢å ï¼Œæ‰€ä»¥æ—¶é—´äº‹ä»¶çš„å®é™…å¤„ç†æ—¶é—´ï¼Œé€šå¸¸ä¼šæ¯”æ—¶é—´äº‹ä»¶è®¾å®šçš„åˆ°è¾¾æ—¶é—´æ™šä¸€äº›ã€‚</li></ol><h2 id="3-å¤šæœºæ•°æ®åº“å®ç°"><a href="#3-å¤šæœºæ•°æ®åº“å®ç°" class="headerlink" title="3. å¤šæœºæ•°æ®åº“å®ç°"></a>3. å¤šæœºæ•°æ®åº“å®ç°</h2><h3 id="3-1-å¤åˆ¶"><a href="#3-1-å¤åˆ¶" class="headerlink" title="3.1 å¤åˆ¶"></a>3.1 å¤åˆ¶</h3><p>åœ¨Redisä¸­ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡æ‰§è¡ŒSLAVEOFå‘½ä»¤æˆ–è€…è®¾ç½®slaveofé€‰é¡¹ï¼Œè®©ä¸€ä¸ªæœåŠ¡å™¨å»å¤åˆ¶(replicate)å¦ä¸€ä¸ªæœåŠ¡å™¨ã€‚</p><p>Rediså¤åˆ¶åŠŸèƒ½åˆ†ä¸ºåŒæ­¥å’Œå‘½ä»¤ä¼ æ’­ä¸¤ä¸ªæ“ä½œï¼š</p><ul><li>åŒæ­¥æ“ä½œç”¨äºå°†æœåŠ¡å™¨çš„æ•°æ®åº“çŠ¶æ€æ›´æ–°è‡³ä¸»æœåŠ¡å™¨å½“å‰æ‰€å¤„çš„æ•°æ®åº“çŠ¶æ€ã€‚</li><li>å‘½ä»¤ä¼ æ’­æ“ä½œåˆ™ç”¨äºåœ¨ä¸»æœåŠ¡å™¨çš„æ•°æ®åº“çŠ¶æ€è¢«ä¿®æ”¹ï¼Œå¯¼è‡´ä¸»ä»æœåŠ¡å™¨çš„æ•°æ®åº“çŠ¶æ€å‡ºç°ä¸ä¸€è‡´æ—¶ï¼Œè®©ä¸»ä»æœåŠ¡å™¨çš„æ•°æ®åº“é‡æ–°å›åˆ°ä¸€è‡´çš„çŠ¶æ€ã€‚</li></ul><p>Rediså¤åˆ¶å®ç°ï¼š</p><ol><li>å®¢æˆ·ç«¯å‘é€å‘½ä»¤(æ­¤å‘½ä»¤æ˜¯å¼‚æ­¥çš„)ï¼š<code>&gt;SLAVEOF master-ip master-port</code>ã€‚</li><li>1å‘½ä»¤åœ¨ä»æœåŠ¡ä¸Šå®Œæˆmasterhostå’Œmasterportå±æ€§çš„è®¾ç½®ä¹‹åï¼Œä»æœåŠ¡å™¨è¿”å›OKã€‚</li><li>ä»æœåŠ¡å™¨æ ¹æ®masterhostå’Œmasterportå»ºç«‹socketè¿æ¥ã€‚</li><li>å‘é€PINGå‘½ä»¤ï¼Œæ£€æŸ¥socketè¿æ¥çš„è¯»å†™çŠ¶æ€ï¼Œæ£€æŸ¥ä¸»æœåŠ¡å™¨çš„å‘½ä»¤å¤„ç†ï¼Œå¦‚æœä¸»æœåŠ¡å™¨è¿”å›éPONGï¼Œåˆ™æ–­å¼€å¹¶é‡è¿ä¸»æœåŠ¡å™¨ã€‚</li><li>ä»æœåŠ¡å™¨å‘é€èº«ä»½éªŒè¯ä¿¡æ¯ã€‚</li><li>å‘é€ä»æœåŠ¡å™¨çš„ç«¯å£ä¿¡æ¯ã€‚</li><li>åŒæ­¥PSYNCã€‚</li><li>æœ€åå‘½ä»¤ä¼ æ’­ã€‚</li></ol><p>Rediså¤åˆ¶æµç¨‹å›¾ï¼š</p><p><img src="/media/article/redis-replicate.png" alt="redis-replicate"></p><p>ä»Redis 2.8ç‰ˆæœ¬å¼€å§‹ï¼ŒRedisä½¿ç”¨PSYNCä»£æ›¿SYNCå‘½ä»¤æ‰§è¡Œå¤åˆ¶æ“ä½œã€‚<br>PSYNCå‘½ä»¤æ‰§è¡Œï¼š</p><p><img src="/media/article/psync.png" alt="PSYNC"></p><p>PSYNCä¸SYNCæœ€æ˜¾è‘—çš„åŒºåˆ«æ˜¯PSYNCæ”¯æŒéƒ¨åˆ†é‡åŒæ­¥ã€‚</p><h3 id="3-2-Sentinel"><a href="#3-2-Sentinel" class="headerlink" title="3.2 Sentinel"></a>3.2 Sentinel</h3><p>Sentinelæ˜¯Redisçš„é«˜å¯ç”¨è§£å†³æ–¹æ¡ˆã€‚</p><p>å¯åŠ¨Sentinelæ—¶ï¼Œæ‰§è¡Œ<code>redis-server /path/sentinel.conf --sentinel</code>æˆ–è€…<code>redis-sentinel /path/sentinel.conf</code>å‘½ä»¤å³å¯ã€‚</p><p>Sentinelå¯åŠ¨æ—¶ï¼Œéœ€è¦æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š</p><ol><li>åˆå§‹åŒ–æœåŠ¡å™¨</li><li>å°†æ™®é€šRedisæœåŠ¡å™¨ä½¿ç”¨çš„ä»£ç æ›¿æ¢æˆSentinelä¸“ç”¨ä»£ç </li><li>åˆå§‹åŒ–SentinelçŠ¶æ€</li><li>æ ¹æ®ç»™å®šé…ç½®æ–‡ä»¶ï¼Œåˆå§‹åŒ–Sentinelçš„ç›‘è§†ä¸»æœåŠ¡å™¨åˆ—è¡¨</li><li>åˆ›å»ºè¿å‘ä¸»æœåŠ¡å™¨çš„ç½‘ç»œè¿æ¥</li></ol><p>SentinelçŠ¶æ€å›¾ï¼š<br><img src="/media/article/redis-sentinel-state.png" alt="redis-sentinel-state"></p><h4 id="3-2-1-è·å–ä¸»ä»ã€Sentinelçš„ä¿¡æ¯"><a href="#3-2-1-è·å–ä¸»ä»ã€Sentinelçš„ä¿¡æ¯" class="headerlink" title="3.2.1 è·å–ä¸»ä»ã€Sentinelçš„ä¿¡æ¯"></a>3.2.1 è·å–ä¸»ä»ã€Sentinelçš„ä¿¡æ¯</h4><p>åˆå§‹åŒ–Sentinelæœ€åä¸€æ­¥æ˜¯åˆ›å»ºè¿å‘ä¸»æœåŠ¡å™¨çš„ç½‘ç»œè¿æ¥ï¼ŒSentinelå°†æˆä¸ºä¸»æœåŠ¡å™¨çš„å®¢æˆ·ç«¯ã€‚</p><p>å¯¹äºæ¯ä¸ªè¢«Sentinelç›‘è§†çš„ä¸»æœåŠ¡å™¨æ¥è¯´ï¼ŒSentinelä¼šåˆ›å»ºä¸¤ä¸ªè¿å‘ä¸»æœåŠ¡å™¨çš„å¼‚æ­¥ç½‘ç»œï¼š</p><ul><li>å‘½ä»¤è¿æ¥ï¼Œè¿™ä¸ªè¿æ¥ä¸“é—¨å‘ä¸»æœåŠ¡å™¨å‘é€å‘½ä»¤ï¼Œå¹¶æ¥æ”¶å‘½ä»¤å›å¤ã€‚</li><li>è®¢é˜…è¿æ¥ï¼Œè¿™ä¸ªè¿æ¥ä¸“é—¨ç”¨äºè®¢é˜…ä¸»æœåŠ¡å™¨çš„<code>__sentinel__:hello</code>é¢‘é“ã€‚ </li></ul><p>Sentinelé»˜è®¤ä»¥æ¯åç§’ä¸€æ¬¡çš„é¢‘ç‡ï¼Œé€šè¿‡å‘½ä»¤è¿æ¥å‘è¢«ç›‘è§†çš„ä¸»æœåŠ¡å™¨å‘é€INFOå‘½ä»¤ï¼Œé€šè¿‡INFOè·å–ä¸»æœåŠ¡å™¨çš„å½“å‰ä¿¡æ¯ã€‚<br>Sentinelé€šè¿‡ä¸»æœåŠ¡å™¨å‘ç°ä»æœåŠ¡å™¨æ—¶ï¼Œä¹Ÿä¼šå»ºç«‹ä¸Šè¿°çš„ä¸¤ä¸ªè¿æ¥ï¼Œæ¯10ç§’å‘é€INFOå‘½ä»¤ï¼Œè·å–ä»æœåŠ¡å™¨çš„å½“å‰ä¿¡æ¯ã€‚<br>é»˜è®¤æƒ…å†µä¸‹ï¼ŒSentinelæ¯2ç§’é€šè¿‡å‘½ä»¤è¿æ¥å‘æ‰€æœ‰ä¸»ä»æœåŠ¡å™¨å‘é€å¦‚ä¸‹å‘½ä»¤ï¼š<br><code>PUBLISH __sentinel__:hello &quot;&lt;s_ip&gt;,&lt;s_port&gt;,&lt;s_runid&gt;,&lt;s_epoch&gt;,&lt;m_name&gt;,&lt;m_id&gt;,&lt;m_port&gt;,&lt;m_epoch&gt;</code>â€œ</p><p>så¼€å¤´çš„æ˜¯sentinelçš„ä¿¡æ¯ï¼Œmå¼€å¤´çš„æ˜¯ä¸»æœåŠ¡å™¨çš„ä¿¡æ¯ï¼Œå¦‚æœå‘é€çš„æ˜¯ä»æœåŠ¡å™¨ï¼Œåˆ™mä¸ºä»æœåŠ¡å™¨æ­£åœ¨å¤åˆ¶çš„ä¸»æœåŠ¡å™¨çš„ä¿¡æ¯ã€‚<br>Sentinelä¸ä¸€ä¸ªä¸»æˆ–ä»æœåŠ¡å™¨å»ºç«‹è®¢é˜…è¿æ¥åï¼ŒSentinelå°±ä¼šé€šè¿‡è®¢é˜…è¿æ¥ï¼Œå‘æœåŠ¡å™¨å‘é€ä»¥ä¸‹å‘½ä»¤:<br><code>SUBSCRIBE __sentinel__:hello</code></p><p>Sentinelé€šè¿‡é¢‘é“ä¿¡æ¯å‘ç°ä¸€ä¸ªæ–°çš„Sentinelæ—¶ï¼Œä¸ä»…ä¼šä¸ºæ–°çš„Sentinelåˆ›å»ºç›¸åº”çš„å®ä¾‹ç»“æ„ï¼Œè¿˜ä¼šåˆ›å»ºä¸€ä¸ªè¿å‘æ–°Sentinelçš„å‘½ä»¤è¿æ¥ã€‚</p><h4 id="3-2-1-ä¸‹çº¿çŠ¶æ€"><a href="#3-2-1-ä¸‹çº¿çŠ¶æ€" class="headerlink" title="3.2.1 ä¸‹çº¿çŠ¶æ€"></a>3.2.1 ä¸‹çº¿çŠ¶æ€</h4><p>Sentinelæ¯1ç§’ä¸€æ¬¡çš„é¢‘ç‡å‘æ‰€æœ‰ä¸å®ƒå»ºç«‹å‘½ä»¤è¿æ¥çš„å®ä¾‹å‘é€PINGå‘½ä»¤ï¼Œåˆ¤æ–­æ˜¯å¦åœ¨çº¿ã€‚<br>å®ä¾‹åœ¨down-after-millisecondså†…è¿”å›+PONGã€-LOADINGã€-MASTERDOWNä»¥å¤–çš„å›å¤ï¼ŒSentinelå°†ä¿®æ”¹è¯¥å®ä¾‹çš„flagså±æ€§:SRI_S_DOWNæ ‡è¯†ï¼Œæ ‡è¯†è¿›å…¥ä¸»è§‚ä¸‹çº¿çŠ¶æ€ã€‚<br>è¶…æ—¶ä¹Ÿä¼šè¢«ç½®ä¸ºä¸»è§‚ä¸‹çº¿çŠ¶æ€ã€‚</p><p>å½“ä¸»æœåŠ¡å™¨è¢«åˆ¤å®šä¸ºä¸»è§‚ä¸‹çº¿åï¼Œä¸ºç¡®è®¤æ˜¯å¦çœŸçš„ä¸‹çº¿äº†ï¼ŒSentinelä¼šè¯¢é—®ç›‘è§†æ­¤æœåŠ¡å™¨çš„å…¶ä»–Sentinelï¼Œå¦‚æœä»å…¶ä»–Sentinelå¾—åˆ°è¶³å¤Ÿæ•°é‡çš„å·²ä¸‹çº¿åˆ¤æ–­åï¼ŒSentinelå°†æ­¤æœåŠ¡å™¨ç½®ä¸ºå®¢è§‚ä¸‹çº¿ã€‚</p><p>Redisä¸‹çº¿çŠ¶æ€åŠSentinelé¢†å¤´é€‰ä¸¾ï¼š<br><img src="/media/article/redis-down.png" alt="redis-down"><br>ä¸Šå›¾ä¸­ï¼Œ1. masterä»£è¡¨ä¸€ä¸ªä¸»æœåŠ¡å™¨ï¼Œ2. ç›‘è§†masterçš„sentinelä»£è¡¨å…¶ä¸­ä¸€ä¸ªç›‘è§†masterçš„sentinel(æ‰€æœ‰ç›‘è§†masterçš„sentineléƒ½ä¼šè¿™æ ·å»æ“ä½œï¼Œè¿™ä¸ªåœ°æ–¹åªæ˜¯åˆ—å‡ºæ¥ä¸€ä¸ªä½œä¸ºç¤ºä¾‹)ï¼Œ3. ç›‘è§†masterçš„sentinelä»£è¡¨ç›‘è§†masterçš„sentinelçš„é›†åˆã€‚</p><h4 id="3-2-2-æ•…éšœè½¬ç§»"><a href="#3-2-2-æ•…éšœè½¬ç§»" class="headerlink" title="3.2.2 æ•…éšœè½¬ç§»"></a>3.2.2 æ•…éšœè½¬ç§»</h4><p>æ•…éšœè½¬ç§»æ­¥éª¤ï¼š</p><ul><li><ol><li>åœ¨å·²ä¸‹çº¿çš„ä¸»æœåŠ¡å™¨çš„ä»æœåŠ¡å™¨ä¸­ï¼Œé€‰ä¸€ä¸ªä½œä¸ºä¸»æœåŠ¡å™¨ã€‚</li></ol></li><li><ol start="2"><li>è®©å…¶ä»–æ²¡æœ‰ä½œä¸ºä¸»æœåŠ¡å™¨çš„ä»æœåŠ¡å™¨å¤åˆ¶æ–°çš„ä¸»æœåŠ¡å™¨ã€‚</li></ol></li><li><ol start="3"><li>å°†å·²ä¸‹çº¿çš„ä¸»æœåŠ¡å™¨ç½®ä¸ºæ–°ä¸»æœåŠ¡å™¨çš„ä»æœåŠ¡å™¨ï¼Œå½“ä¸‹çº¿çš„ä¸»æœåŠ¡å™¨å†ä¸Šçº¿æ—¶ï¼Œå®ƒå°±ä¼šæˆä¸ºæ–°ä¸»æœåŠ¡å™¨çš„ä»æœåŠ¡å™¨ã€‚</li></ol></li></ul><h3 id="3-3-é›†ç¾¤"><a href="#3-3-é›†ç¾¤" class="headerlink" title="3.3 é›†ç¾¤"></a>3.3 é›†ç¾¤</h3><p>Redisé›†ç¾¤æ˜¯Redisæä¾›çš„åˆ†å¸ƒå¼æ•°æ®åº“æ–¹æ¡ˆï¼Œé›†ç¾¤é€šè¿‡åˆ†ç‰‡(sharding)æ¥è¿›è¡Œæ•°æ®å…±äº«ï¼Œå¹¶æä¾›å¤åˆ¶å’Œæ•…éšœè½¬ç§»åŠŸèƒ½ã€‚</p><h4 id="3-3-1-èŠ‚ç‚¹"><a href="#3-3-1-èŠ‚ç‚¹" class="headerlink" title="3.3.1 èŠ‚ç‚¹"></a>3.3.1 èŠ‚ç‚¹</h4><p>å½“ä¸€ä¸ªèŠ‚ç‚¹nodeå‘é€<code>CLUSTER MEET &lt;IP&gt; &lt;PORT&gt;</code>å‘½ä»¤ï¼Œå¯ä»¥è®©nodeèŠ‚ç‚¹ä¸ipå’Œportæ‰€æŒ‡å®šçš„èŠ‚ç‚¹è¿›è¡Œæ¡æ‰‹(handshake)ï¼Œå½“æ¡æ‰‹æˆåŠŸåï¼ŒnodeèŠ‚ç‚¹å°±ä¼šå°†ipå’Œportæ‰€æŒ‡å®šçš„èŠ‚ç‚¹æ·»åŠ åˆ°nodeèŠ‚ç‚¹å½“å‰æ‰€åœ¨çš„é›†ç¾¤ä¸­ã€‚<br>é›†ç¾¤æ•°æ®ç»“æ„ç¤ºä¾‹:<br><img src="/media/article/redis-cluster.png" alt="cluster"></p><h4 id="3-3-2-æ§½"><a href="#3-3-2-æ§½" class="headerlink" title="3.3.2 æ§½"></a>3.3.2 æ§½</h4><p>Redisé›†ç¾¤é€šè¿‡åˆ†ç‰‡çš„æ–¹å¼æ¥ä¿å­˜æ•°æ®åº“ä¸­çš„é”®å€¼å¯¹:é›†ç¾¤çš„æ•´ä¸ªæ•°æ®åº“è¢«åˆ†ä¸º16384ä¸ªæ§½(slot)ï¼Œæ•°æ®åº“ä¸­çš„æ¯ä¸ªé”®éƒ½å±äºè¿™16384ä¸ªæ§½çš„å…¶ä¸­ä¸€ä¸ªï¼Œé›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½å¯ä»¥å¤„ç†0ä¸ªæˆ–è€…æœ€å¤š16384ä¸ªæ§½ã€‚</p><p>å¦‚æœ16384ä¸ªæ§½éƒ½æœ‰èŠ‚ç‚¹åœ¨å¤„ç†æ—¶ï¼Œé›†ç¾¤å¤„äºä¸Šçº¿çŠ¶æ€(ok)ï¼Œç›¸åå¦‚æœæ•°æ®åº“ä¸­æœ‰ä»»ä½•ä¸€ä¸ªæ§½æ²¡æœ‰å¾—åˆ°å¤„ç†ï¼Œé‚£ä¹ˆé›†ç¾¤å¤„äºä¸‹çº¿çŠ¶æ€(fail)ã€‚</p><p>æ§½åˆ†é…å‘½ä»¤<code>CLUSTER ADSLOTS &lt;slot&gt; [slot ...]</code>ï¼Œä¾‹å¦‚<code>127.0.0.1:6379&gt;cluster addslots 0 1 2 ... 1000</code>å°†0åˆ°1000çš„æ§½åˆ†é…ç»™æœ¬åœ°çš„6379èŠ‚ç‚¹è´Ÿè´£ã€‚</p><p>æ§½åˆ†é…åèŠ‚ç‚¹çš„ClusterStateç»“æ„:</p><p><img src="/media/article/redis-clusterstate.png" alt="clusterstate"></p><p>é›†ç¾¤èŠ‚ç‚¹æ•°æ®åº“å­˜å‚¨ç»“æ„:</p><p><img src="/media/article/redis-clusterstate1.png" alt="clusterstate"></p><p>é›†ç¾¤èŠ‚ç‚¹ä¿å­˜keyå¯¹åº”æ§½çš„è·³è·ƒè¡¨:</p><p><img src="/media/article/redis-slots-to-key.png" alt="clusterstate"></p><h4 id="3-3-3-åˆ†ç‰‡"><a href="#3-3-3-åˆ†ç‰‡" class="headerlink" title="3.3.3 åˆ†ç‰‡"></a>3.3.3 åˆ†ç‰‡</h4><p>Redisé›†ç¾¤çš„é‡æ–°åˆ†ç‰‡æ“ä½œå¯ä»¥å°†ä»»æ„æ•°é‡å·²ç»æŒ‡æ´¾ç»™æŸä¸ªèŠ‚ç‚¹çš„æ§½æ”¹ä¸ºæŒ‡æ´¾ç»™å¦ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¹¶ä¸”ç›¸å…³æ§½æ‰€å±çš„å‡å€¼å¯¹ä¹Ÿä¼šä»æºèŠ‚ç‚¹è¢«ç§»åŠ¨åˆ°ç›®æ ‡èŠ‚ç‚¹ã€‚</p><p>Redisé›†ç¾¤çš„é‡æ–°åˆ†ç‰‡æ“ä½œæ˜¯ç”±Redisçš„é›†ç¾¤ç®¡ç†è½¯ä»¶redis-tribè´Ÿè´£æ‰§è¡Œçš„ï¼ŒRedisæä¾›äº†è¿›è¡Œé‡åˆ†é…åˆ†ç‰‡æ‰€éœ€è¦çš„æ‰€æœ‰å‘½ä»¤ã€‚</p><p>Redisé‡åˆ†ç‰‡è¿ç§»è¿‡ç¨‹:</p><p><img src="/media/article/redis-migrate.png" alt="migrate"></p><p>è¿ç§»è¿‡ç¨‹ä¸­ï¼ŒæŸ¥è¯¢keyçš„å‘½ä»¤è¿‡ç¨‹å¦‚ä¸‹:</p><p><img src="/media/article/redis-ask.png" alt="redis-ask"></p><p><img src="/media/article/redis-asking.png" alt="redis-asking"></p><h4 id="3-3-4-æ•…éšœæ£€æµ‹"><a href="#3-3-4-æ•…éšœæ£€æµ‹" class="headerlink" title="3.3.4 æ•…éšœæ£€æµ‹"></a>3.3.4 æ•…éšœæ£€æµ‹</h4><p>é›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šå®šæœŸçš„å‘é›†ç¾¤ä¸­çš„å…¶ä»–èŠ‚ç‚¹å‘é€PINGæ¶ˆæ¯ï¼Œä»¥æ­¤æ¥æ£€æµ‹å¯¹æ–¹æ˜¯å¦åœ¨çº¿ã€‚</p><h4 id="3-3-5-æ¶ˆæ¯"><a href="#3-3-5-æ¶ˆæ¯" class="headerlink" title="3.3.5 æ¶ˆæ¯"></a>3.3.5 æ¶ˆæ¯</h4><p>é›†ç¾¤ä¸­çš„å„ä¸ªèŠ‚ç‚¹é€šè¿‡å‘é€å’Œæ¥æ”¶æ¶ˆæ¯(message)æ¥è¿›è¡Œé€šä¿¡ã€‚æ¶ˆæ¯ä¸»è¦ä»¥ä¸‹äº”ç§:</p><ul><li>MEETæ¶ˆæ¯:å½“å‘é€è€…æ¥æ”¶å®¢æˆ·ç«¯å‘é€çš„CLUSTER MEETå‘½ä»¤æ—¶ï¼Œå‘é€è€…ä¼šå‘æ¥æ”¶è€…å‘é€MEETæ¶ˆæ¯ï¼Œè¯·æ±‚æ¥æ”¶è€…åŠ å…¥åˆ°å‘é€è€…å½“å‰æ‰€å¤„çš„é›†ç¾¤é‡Œé¢ã€‚</li><li>PINGæ¶ˆæ¯:é›†ç¾¤é‡Œçš„æ¯ä¸ªèŠ‚ç‚¹é»˜è®¤æ¯éš”ä¸€ç§’é’Ÿå°±ä¼šä»å·²çŸ¥èŠ‚ç‚¹åˆ—è¡¨ä¸­éšæœºé€‰å‡ºäº”ä¸ªèŠ‚ç‚¹ï¼Œç„¶åå¯¹äº”ä¸ªèŠ‚ç‚¹ä¸­æœ€é•¿æ—¶é—´æ²¡æœ‰å‘é€è¿‡PINGæ¶ˆæ¯çš„èŠ‚ç‚¹å‘é€PINGæ¶ˆæ¯ã€‚</li><li>PONGæ¶ˆæ¯:å½“æ¥æ”¶è€…æ”¶åˆ°å‘é€è€…å‘æ¥çš„MEETæ¶ˆæ¯æˆ–è€…PINGæ¶ˆæ¯æ—¶ï¼Œä¸ºäº†å‘å‘é€è€…ç¡®è®¤è¿™æ¡MEETæ¶ˆæ¯æˆ–è€…PINGæ¶ˆæ¯å·²åˆ°è¾¾ï¼Œæ¥æ”¶è€…ä¼šå‘å‘é€è€…è¿”å›ä¸€æ¡PONGæ¶ˆæ¯ã€‚</li><li>FAILæ¶ˆæ¯:å½“ä¸€ä¸ªä¸»èŠ‚ç‚¹Aåˆ¤æ–­å¦ä¸€ä¸ªä¸»èŠ‚ç‚¹Bè¿›å…¥FAILçŠ¶æ€æ—¶ï¼ŒèŠ‚ç‚¹Aä¼šå‘é›†ç¾¤å¹¿æ’­ä¸€æ¡å…³äºBçš„FAILæ¶ˆæ¯ï¼Œæ‰€æœ‰æ¥æ”¶åˆ°è¿™æ¡æ¶ˆæ¯çš„èŠ‚ç‚¹éƒ½ä¼šç«‹å³å°†Bæ ‡è®°ä¸ºå·²ä¸‹çº¿ã€‚</li><li>PUBLISHæ¶ˆæ¯:å½“èŠ‚ç‚¹æ¥æ”¶åˆ°ä¸€ä¸ªPUBLISHå‘½ä»¤æ—¶ï¼ŒèŠ‚ç‚¹ä¼šæ‰§è¡Œè¿™ä¸ªå‘½ä»¤ï¼Œå¹¶å‘é›†ç¾¤å¹¿æ’­ä¸€æ¡PUBLISHæ¶ˆæ¯ï¼Œæ‰€æœ‰æ¥æ”¶è€…éƒ½ä¼šæ‰§è¡Œç›¸åŒçš„PUBLISHå‘½ä»¤ã€‚</li></ul><p>Redisé›†ç¾¤ä¸­çš„å„ä¸ªèŠ‚ç‚¹é€šè¿‡Gossipåè®®æ¥äº¤æ¢å„è‡ªå…³äºä¸åŒèŠ‚ç‚¹çš„çŠ¶æ€ä¿¡æ¯ï¼Œå…¶ä¸­Gossipåè®®ç”±MEETã€PINGã€PONGæ˜¯ä¸‰ç§æ¶ˆæ¯å®ç°ã€‚ä¸‰ç§æ¶ˆæ¯ä½¿ç”¨ç›¸åŒçš„æ¶ˆæ¯æ­£æ–‡ï¼Œé€šè¿‡æ¶ˆæ¯å¤´typeåŒºåˆ†æ¶ˆæ¯ã€‚</p><h2 id="4-ç‹¬ç«‹åŠŸèƒ½çš„å®ç°"><a href="#4-ç‹¬ç«‹åŠŸèƒ½çš„å®ç°" class="headerlink" title="4. ç‹¬ç«‹åŠŸèƒ½çš„å®ç°"></a>4. ç‹¬ç«‹åŠŸèƒ½çš„å®ç°</h2><h3 id="4-1-äº‹åŠ¡"><a href="#4-1-äº‹åŠ¡" class="headerlink" title="4.1 äº‹åŠ¡"></a>4.1 äº‹åŠ¡</h3><p>Redis é€šè¿‡MULTIã€EXECã€WATCHç­‰å‘½ä»¤æ¥è¯´å®ç°äº‹åŠ¡ã€‚<br>äº‹åŠ¡åœ¨æ‰§è¡ŒæœŸé—´ï¼ŒæœåŠ¡å™¨ä¸ä¼šä¸­æ–­äº‹åŠ¡å¤„ç†å…¶ä»–è¯·æ±‚ã€‚</p><h4 id="4-1-1-äº‹åŠ¡çš„å®ç°"><a href="#4-1-1-äº‹åŠ¡çš„å®ç°" class="headerlink" title="4.1.1 äº‹åŠ¡çš„å®ç°"></a>4.1.1 äº‹åŠ¡çš„å®ç°</h4><p>ä¸€ä¸ªäº‹åŠ¡ä»å¼€å§‹æ—¶åˆ°ç»“æŸé€šå¸¸ç»å†3ä¸ªé˜¶æ®µ:</p><ol><li>äº‹åŠ¡å¼€å§‹: MULTI</li><li>å‘½ä»¤å…¥é˜Ÿ: <command></li><li>äº‹åŠ¡æ‰§è¡Œ: EXEC</li></ol><h4 id="4-1-2-WATCH-å‘½ä»¤çš„å®ç°"><a href="#4-1-2-WATCH-å‘½ä»¤çš„å®ç°" class="headerlink" title="4.1.2 WATCH å‘½ä»¤çš„å®ç°"></a>4.1.2 WATCH å‘½ä»¤çš„å®ç°</h4><p>WATCHå‘½ä»¤æ˜¯ä¸€ä¸ªä¹è§‚é”(optimistic locking)ï¼Œå®ƒå¯ä»¥åœ¨EXECå‘½ä»¤æ‰§è¡Œä¹‹å‰ï¼Œç›‘è§†ä»»æ„æ•°é‡çš„æ•°æ®åº“é”®ï¼Œå¹¶åœ¨EXECå‘½ä»¤æ‰§è¡Œæ—¶ï¼Œæ£€æŸ¥è¢«ç›‘è§†çš„é”®æ˜¯å¦è‡³å°‘å°‘æœ‰ä¸€ä¸ªå·²ç»è¢«ä¿®æ”¹è¿‡äº†ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™æ‹’ç»æ‰§è¡Œäº‹åŠ¡ï¼Œå¹¶å‘å®¢æˆ·ç«¯è¿”å›ä»£è¡¨äº‹åŠ¡æ‰§è¡Œå¤±è´¥çš„ç©ºå›å¤ã€‚<br>æ¯ä¸ªRedisæ•°æ®åº“éƒ½ä¿å­˜ç€ä¸€ä¸ªwatched_keyså­—å…¸ï¼Œè¿™ä¸ªå­—å…¸çš„é”®æ—¶æŸä¸ªè¢«WATCHå‘½ä»¤ç›‘è§†çš„æ•°æ®åº“é”®ï¼Œè€Œå­—å…¸çš„å€¼åˆ™æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œé“¾è¡¨ä¸­è®°å½•äº†æ‰€æœ‰ç›‘è§†ç›¸åº”æ•°æ®åº“é”®çš„å®¢æˆ·ç«¯ã€‚<br>å¦‚æœæœ‰ä¿®æ”¹å‘½ä»¤å¯¹æ•°æ®åº“é”®ä¿®æ”¹è¿‡ï¼Œé‚£ä¹ˆtouchWatchKeyå‡½æ•°å°†ç›‘è§†è¢«ä¿®æ”¹é”®çš„å®¢æˆ·ç«¯çš„REDIS_DIRTY_CASæ ‡è¯†æ‰“å¼€ï¼Œæ ‡è¯†è¯¥å®¢æˆ·ç«¯çš„äº‹åŠ¡å®‰å…¨æ€§è¢«ç ´åã€‚</p><p><img src="/media/article/watch-transaction.png" alt="watch"></p><h4 id="4-1-3-äº‹åŠ¡çš„ACIDæ€§è´¨"><a href="#4-1-3-äº‹åŠ¡çš„ACIDæ€§è´¨" class="headerlink" title="4.1.3 äº‹åŠ¡çš„ACIDæ€§è´¨"></a>4.1.3 äº‹åŠ¡çš„ACIDæ€§è´¨</h4><p>Redisçš„äº‹åŠ¡å’Œä¼ ç»Ÿçš„å…³ç³»å‹æ•°æ®åº“äº‹åŠ¡çš„æœ€å¤§åŒºåˆ«åœ¨äºï¼ŒRedisä¸æ”¯æŒäº‹åŠ¡å›æ»šæœºåˆ¶ï¼Œå³ä½¿äº‹åŠ¡é˜Ÿåˆ—ä¸­çš„æŸä¸ªå‘½ä»¤åœ¨æ‰§è¡ŒæœŸé—´å‡ºç°äº†é”™è¯¯ï¼Œæ•´ä¸ªäº‹åŠ¡ä¹Ÿä¼šç»§ç»­æ‰§è¡Œä¸‹å»ï¼Œç›´åˆ°å°†äº‹åŠ¡é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰å‘½ä»¤éƒ½æ‰§è¡Œå®Œæ¯•ã€‚</p><p>Redis é€šè¿‡è°¨æ…çš„é”™è¯¯æ£€æµ‹å’Œç®€å•çš„è®¾è®¡æ¥ä¿è¯äº‹åŠ¡çš„ä¸€è‡´æ€§ï¼Œä»è€Œç¡®ä¿äº‹åŠ¡çš„ä¸€è‡´æ€§ã€‚ä»¥ä¸‹ä»‹ç»Redisäº‹åŠ¡å¯èƒ½å‡ºé”™çš„åœ°æ–¹ï¼Œå¹¶è¯´æ˜Redisæ˜¯å¦‚ä½•å¦¥å–„å¤„ç†è¿™äº›é”™è¯¯ã€‚</p><ol><li>å…¥é˜Ÿé”™è¯¯ï¼šæœåŠ¡å™¨ä¼šæ‹’ç»æ‰§è¡Œå…¥é˜Ÿè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯çš„äº‹åŠ¡ï¼Œæ‰€ä»¥Redisäº‹åŠ¡çš„ä¸€è‡´æ€§ä¸ä¼šè¢«å¸¦æœ‰å…¥é˜Ÿé”™è¯¯çš„äº‹åŠ¡å½±å“ã€‚</li><li>æ‰§è¡Œé”™è¯¯ï¼š</li></ol><ul><li>æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿçš„é”™è¯¯éƒ½æ˜¯ä¸€äº›ä¸èƒ½åœ¨å…¥é˜Ÿæ—¶è¢«æœåŠ¡å™¨å‘ç°çš„é”™è¯¯ï¼Œè¿™äº›é”™è¯¯åªä¼šåœ¨å‘½ä»¤å®é™…æ‰§è¡Œæ—¶è§¦å‘ã€‚</li><li>å³ä½¿åœ¨äº‹åŠ¡çš„æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼ŒæœåŠ¡å™¨ä¹Ÿä¸ä¼šä¸­æ–­äº‹åŠ¡çš„æ‰§è¡Œï¼Œå®ƒä¼šç»§ç»­æ‰§è¡Œäº‹åŠ¡ä¸­ä½™ä¸‹çš„å…¶ä»–å‘½ä»¤ï¼Œå¹¶ä¸”å·²æ‰§è¡Œçš„å‘½ä»¤ä¸ä¼šè¢«å‡ºé”™çš„å‘½ä»¤å½±å“ã€‚</li></ul><ol start="3"><li>æœåŠ¡å™¨åœæœºï¼š</li></ol><ul><li>å¦‚æœRedisæœåŠ¡å™¨è¿è¡Œåœ¨æ— æŒä¹…åŒ–çš„å†…å­˜æ¨¡å¼ä¸‹ï¼Œé‚£ä¹ˆé‡å¯ä¹‹åçš„æ•°æ®åº“å°†æ˜¯ç©ºç™½çš„ï¼Œå› æ­¤æ•°æ®æ€»æ˜¯ä¸€è‡´çš„ã€‚</li><li>å¦‚æœæœåŠ¡å™¨è¿è¡Œåœ¨RDBæ¨¡å¼ä¸‹ï¼Œé‚£ä¹ˆåœ¨äº‹åŠ¡ä¸­é€”åœæœºä¸ä¼šå¯¼è‡´ä¸ä¸€è‡´æ€§ï¼Œå› ä¸ºæœåŠ¡å™¨å¯ä»¥æ ¹æ®ç°æœ‰çš„RDBæ–‡ä»¶æ¥æ¢å¤æ•°æ®ï¼Œä»è€Œå°†æ•°æ®åº“è¿˜åŸåˆ°ä¸€ä¸ªä¸€è‡´çš„çŠ¶æ€ã€‚å¦‚æœæ‰¾ä¸åˆ°å¯ä¾›ä½¿ç”¨çš„RDBæ–‡ä»¶ï¼Œé‚£ä¹ˆé‡å¯ä¹‹åçš„æ•°æ®åº“å°†æ˜¯ç©ºç™½çš„ï¼Œç©ºç™½çš„æ€»æ˜¯ä¸€è‡´çš„ã€‚</li><li>å¦‚æœæœåŠ¡å™¨è¿è¡Œåœ¨AOFæ¨¡å¼ä¸‹ï¼Œé‚£ä¹ˆäº‹åŠ¡ä¸­é€”åœæœºä¸ä¼šå¯¼è‡´ä¸ä¸€è‡´æ€§ï¼Œå› ä¸ºæœåŠ¡å™¨å¯ä»¥æ ¹æ®ç°æœ‰çš„AOFæ–‡ä»¶æ¥æ¢å¤æ•°æ®ï¼Œä»è€Œå°†æ•°æ®è¿˜åŸåˆ°ä¸€ä¸ªä¸€è‡´çš„çŠ¶æ€ã€‚å¦‚æœæ‰¾ä¸åˆ°å¯ä¾›ä½¿ç”¨çš„AOFæ–‡ä»¶ï¼Œé‚£ä¹ˆé‡å¯ä¹‹åçš„æ•°æ®åº“å°†æ˜¯ç©ºç™½çš„ï¼Œè€Œç©ºç™½æ•°æ®åº“æ€»æ˜¯ä¸€è‡´çš„ã€‚</li></ul><h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h2><ol><li>BGSAVE æ˜¯å¦ä¼šå­˜æ‰§è¡ŒBGSAVEå‘½ä»¤åå®¢æˆ·ç«¯è¯·æ±‚çš„å‘½ä»¤ï¼Ÿ</li><li>å‡å¦‚è¯´æ¯ç§’æ‰§è¡Œä¸€æ¬¡AOFæŒä¹…åŒ–ï¼Œé‚£ä¹ˆRedisä»aofç¼“å†²åŒºå†™å…¥AOFæ–‡ä»¶æ—¶ï¼ŒæœåŠ¡ç«¯å¤„ç†çš„å‘½ä»¤æ˜¯å¦ä¼šå­˜å…¥ç¼“å†²åŒºï¼Œæ˜¯å¦ä¼šè¿›å…¥AOFæ–‡ä»¶ï¼Ÿ</li></ol><h2 id="å¼•ç”¨"><a href="#å¼•ç”¨" class="headerlink" title="å¼•ç”¨"></a>å¼•ç”¨</h2><p><strong><em>æ–‡ä¸­çš„åˆ—è¡¨å’Œå›¾ç‰‡å¤§éƒ½å¼•ç”¨è‡ª<a href="https://book.douban.com/subject/25900156/" target="_blank" rel="noopener">Redis è®¾è®¡ä¸å®ç°ï¼ˆç¬¬äºŒç‰ˆï¼‰</a></em></strong></p><p><a href="https://book.douban.com/subject/25900156/" target="_blank" rel="noopener">Redis è®¾è®¡ä¸å®ç°ï¼ˆç¬¬äºŒç‰ˆï¼‰</a><br><a href="https://blog.csdn.net/harleylau/article/details/80534159" target="_blank" rel="noopener">harleylau-Redisæºç è§£æ-quicklist</a><br><a href="https://www.cnblogs.com/exceptioneye/p/7044341.html?utm_source=itdadao&amp;utm_medium=referral" target="_blank" rel="noopener">ä¸‰çŸ³é›¨-Redisç»“æ„ä¹‹quicklist</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;1-æ•°æ®ç»“æ„ä¸å¯¹è±¡&quot;&gt;&lt;a href=&quot;#1-æ•°æ®ç»“æ„ä¸å¯¹è±¡&quot; class=&quot;headerlink&quot; title=&quot;1. æ•°æ®ç»“æ„ä¸å¯¹è±¡&quot;&gt;&lt;/a&gt;1. æ•°æ®ç»“æ„ä¸å¯¹è±¡&lt;/h2&gt;&lt;h3 id=&quot;1-1-ç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆSDSï¼‰&quot;&gt;&lt;a href=&quot;#1-1-ç®€å•åŠ¨
      
    
    </summary>
    
    
      <category term="redis" scheme="https://zhongyp.me/tags/redis/"/>
    
      <category term="ç¬”è®°" scheme="https://zhongyp.me/tags/%E7%AC%94%E8%AE%B0/"/>
    
  </entry>
  
  <entry>
    <title>How to Write Doc Comments for the Javadoc Tool</title>
    <link href="https://zhongyp.me/java/2019-05-19-javadoc-guide/"/>
    <id>https://zhongyp.me/java/2019-05-19-javadoc-guide/</id>
    <published>2019-05-18T16:00:00.000Z</published>
    <updated>2019-05-19T12:28:11.035Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å¼•ç”¨"><a href="#å¼•ç”¨" class="headerlink" title="å¼•ç”¨"></a>å¼•ç”¨</h2><p><a href="https://www.oracle.com/technetwork/articles/javase/index-137868.html" target="_blank" rel="noopener">How to Write Doc Comments for the Javadoc Tool</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;å¼•ç”¨&quot;&gt;&lt;a href=&quot;#å¼•ç”¨&quot; class=&quot;headerlink&quot; title=&quot;å¼•ç”¨&quot;&gt;&lt;/a&gt;å¼•ç”¨&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://www.oracle.com/technetwork/articles/javase/index-1378
      
    
    </summary>
    
    
      <category term="Java" scheme="https://zhongyp.me/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>Java æ³›å‹</title>
    <link href="https://zhongyp.me/java/2019-05-06-java-generics/"/>
    <id>https://zhongyp.me/java/2019-05-06-java-generics/</id>
    <published>2019-05-05T16:00:00.000Z</published>
    <updated>2019-06-05T11:29:39.842Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-æ¦‚å¿µ"><a href="#1-æ¦‚å¿µ" class="headerlink" title="1. æ¦‚å¿µ"></a>1. æ¦‚å¿µ</h2><blockquote><p><strong>å…¶ä»–å‚æ•°æœ¯è¯­ï¼š</strong><br>å‚æ•°åŒ–çš„ç±»å‹(parameterized type)ï¼š<code>List&lt;String&gt;</code><br>å®é™…ç±»å‹å‚æ•°(type arguments)ï¼š<code>String</code><br>æ³›å‹(generic type)ï¼š<code>List&lt;E&gt;</code><br>å½¢å¼ç±»å‹å‚æ•°(formal parameter types)ï¼š<code>E</code><br>æ— é™åˆ¶é€šé…ç¬¦ç±»å‹(unbounded wildcards)ï¼š<code>List&lt;?&gt;</code><br>åŸç”Ÿæ€ç±»å‹(raw type)ï¼š<code>List</code><br>æœ‰é™åˆ¶ç±»å‹å‚æ•°(bounded type parameter)ï¼š<code>&lt;E extends Number&gt;</code><br>é€’å½’ç±»å‹é™åˆ¶(recursive type restriction)ï¼š<code>&lt;T extends Comparable&lt;T&gt;&gt;</code><br>æœ‰é™åˆ¶é€šé…ç¬¦ç±»å‹(bounded wildcards)ï¼š<code>List&lt;? extends Number&gt;</code><br>æ³›å‹æ–¹æ³•(generic method)ï¼š<code>static &lt;E&gt; List&lt;E&gt; asList(E[] a)</code><br>ç±»å‹ä»¤ç‰Œ(type token)ï¼š<code>String.class</code></p><p>â€“ æ‘˜è‡ªã€ŠEffective Javaã€‹</p></blockquote><p>Javaé›†åˆæœ‰ä¸ªç¼ºç‚¹ï¼šé›†åˆå¯¹å…ƒç´ ç±»å‹æ²¡æœ‰ä»»ä½•é™åˆ¶ï¼Œè¿™æ ·å°±ä¼šå¼•å‘ä¸€äº›é—®é¢˜ï¼Œä¾‹å¦‚ï¼šåˆ›å»ºä¸€ä¸ªåªä¿å­˜Dogå¯¹è±¡çš„é›†åˆï¼Œä½†æ˜¯ç¨‹åºä¹Ÿèƒ½å°†Catå¯¹è±¡æ”¾è¿›å»ã€‚ç”±äºæŠŠå¯¹è±¡æ”¾è¿›é›†åˆæ—¶ï¼Œé›†åˆä¸¢å¤±äº†å¯¹è±¡çš„çŠ¶æ€ä¿¡æ¯ï¼Œé›†åˆåªçŸ¥é“å®ƒç››è£…çš„æ˜¯Objectï¼Œå› æ­¤å»é™¤é›†åˆå…ƒç´ åé€šå¸¸è¿˜éœ€è¦è¿›è¡Œå¼ºåˆ¶ç±»å‹è½¬æ¢ã€‚</p><p>ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œä»JDK1.5ä¹‹åï¼ŒJavaå¼•å…¥äº†â€œå‚æ•°åŒ–ç±»å‹ï¼ˆparameterized typeï¼‰â€çš„æ¦‚å¿µï¼ŒJavaçš„å‚æ•°åŒ–ç±»å‹è¢«ç§°ä¸ºæ³›å‹ï¼ˆGenericï¼‰ã€‚</p><p>æ‰€è°“æ³›å‹ï¼šå°±æ˜¯å…è®¸åœ¨å®šä¹‰ç±»ã€æ¥å£æ—¶æŒ‡å®šç±»å‹å½¢å‚ï¼ˆtype parametersï¼‰ï¼Œè¿™ä¸ªç±»å‹å½¢å‚å°†åœ¨å£°æ˜å˜é‡ã€åˆ›å»ºå¯¹è±¡æ—¶ç¡®å®šã€‚æ³›å‹çš„ä½œç”¨å°±æ˜¯åœ¨ç¼–è¯‘æ—¶ä¿è¯ç±»å‹å®‰å…¨ã€‚</p><h2 id="2-ä½¿ç”¨"><a href="#2-ä½¿ç”¨" class="headerlink" title="2. ä½¿ç”¨"></a>2. ä½¿ç”¨</h2><p>å®šä¹‰æ³›å‹æ¥å£ã€ç±»ç¤ºä¾‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//å®šä¹‰æ¥å£æ—¶æŒ‡å®šä¸€ä¸ªç±»å‹å½¢å‚</span><br><span class="line">public interface List&lt;E&gt;&#123;</span><br><span class="line">    //åœ¨æ¥å£é‡Œï¼ŒEå¯ä»¥ä½œä¸ºç±»å‹ä½¿ç”¨</span><br><span class="line">    void add(E x);</span><br><span class="line">    Iterator&lt;E&gt; iterator();</span><br><span class="line">    E asList();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong><em>æ³¨æ„ï¼š</em></strong></p><ul><li>åŒ…å«æ³›å‹å£°æ˜çš„ç±»å‹å¯ä»¥åœ¨å®šä¹‰å˜é‡ã€åˆ›å»ºå¯¹è±¡æ—¶ä¼ å…¥ä¸€ä¸ªç±»å‹å®å‚(type arguments)ï¼Œä»è€Œå¯ä»¥åŠ¨æ€ç”Ÿæˆæ— æ•°å¤šä¸ªé€»è¾‘ä¸Šçš„å­ç±»ï¼Œä½†è¿™ç§å­ç±»åœ¨ç‰©ç†ä¸Šå¹¶ä¸å­˜åœ¨ã€‚</li><li>å½“åˆ›å»ºæ³›å‹å£°æ˜çš„è‡ªå®šä¹‰ç±»ï¼Œä¸ºè¯¥ç±»å®šä¹‰æ„é€ å™¨æ—¶ï¼Œæ„é€ å™¨åè¿˜æ˜¯åŸæ¥çš„ç±»åï¼Œä¸è¦å¢åŠ æ³›å‹å£°æ˜ã€‚ä¾‹å¦‚ï¼šä¸º<code>Apple&lt;T&gt;</code>ç±»å®šä¹‰æ„é€ å™¨ï¼Œå…¶æ„é€ å™¨åä¾ç„¶æ˜¯<code>Apple</code>ï¼Œè€Œä¸æ˜¯<code>Apple&lt;T&gt;</code>ï¼Œä½†è°ƒç”¨æ„é€ å™¨æ—¶å¯ä»¥ä½¿ç”¨<code>Apple&lt;T&gt;</code>ï¼Œæ­¤æ—¶Tåº”è¯¥ä¸ºå®å‚ç±»å‹ã€‚</li></ul><h3 id="2-1-ä»æ³›å‹ç±»æ´¾ç”Ÿå­ç±»"><a href="#2-1-ä»æ³›å‹ç±»æ´¾ç”Ÿå­ç±»" class="headerlink" title="2.1 ä»æ³›å‹ç±»æ´¾ç”Ÿå­ç±»"></a>2.1 ä»æ³›å‹ç±»æ´¾ç”Ÿå­ç±»</h3><p>å½“åˆ›å»ºå­ç±»ä½¿ç”¨æ³›å‹æ¥å£æˆ–ç±»æ—¶ï¼Œä¸èƒ½å†åŒ…å«ç±»å‹å½¢å‚ã€‚å¦‚ä¸‹ä»£ç æ—¶é”™è¯¯çš„ï¼š<br><code>public class A extends Apple&lt;T&gt;{}</code><br>æ­£ç¡®æ–¹å¼å¦‚ä¸‹ï¼š<br><code>public class A extends Apple&lt;String&gt;{}</code></p><p>ç±»çš„é™æ€å˜é‡å’Œæ–¹æ³•åœ¨æ‰€æœ‰çš„å®ä¾‹é—´å…±äº«ï¼Œæ‰€ä»¥åœ¨é™æ€æ–¹æ³•ã€é™æ€åˆå§‹åŒ–æˆ–è€…é™æ€å˜é‡çš„å£°æ˜å’Œåˆå§‹åŒ–ä¸­ä¸å…è®¸ä½¿ç”¨ç±»å‹å½¢å‚ã€‚åŸå› è§<a href="#4-3-ä¸èƒ½å£°æ˜é™æ€å­—æ®µçš„ç±»å‹ä¸ºç±»å‹å‚æ•°">4.3 ä¸èƒ½å£°æ˜é™æ€å­—æ®µçš„ç±»å‹ä¸ºç±»å‹å‚æ•°</a></p><p>ç”±äºç³»ç»Ÿå¯¹äºæ³›å‹ç±»æˆ–æ¥å£å¹¶ä¸ä¼šç”ŸæˆçœŸæ­£çš„æ³›å‹ç±»æˆ–æ¥å£ï¼ˆå³é€»è¾‘ä¸Šçš„å­ç±»ï¼Œå¹¶ä¸æ˜¯ç”ŸæˆçœŸæ­£çš„å­ç±»ï¼‰ï¼Œæ‰€ä»¥instanceofè¿ç®—ç¬¦åä¸èƒ½ä½¿ç”¨æ³›å‹ç±»ã€‚ï¼ˆå…·ä½“åŸå› è§<a href="#4-4-ä¸èƒ½ä½¿ç”¨å‚æ•°åŒ–ç±»å‹å¼ºåˆ¶ç±»å‹è½¬æ¢æˆ–è€…instanceof">4.4 ä¸èƒ½ä½¿ç”¨å‚æ•°åŒ–ç±»å‹å¼ºåˆ¶ç±»å‹è½¬æ¢æˆ–è€…instanceof</a>ï¼‰å¦‚ä¸‹çš„ä»£ç æ—¶é”™è¯¯çš„:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Collection cs = new ArrayList&lt;String&gt;();</span><br><span class="line">if(cs instanceof List&lt;String&gt;)&#123;&#125;</span><br></pre></td></tr></table></figure><h3 id="2-2-ç±»å‹é€šé…ç¬¦"><a href="#2-2-ç±»å‹é€šé…ç¬¦" class="headerlink" title="2.2 ç±»å‹é€šé…ç¬¦"></a>2.2 ç±»å‹é€šé…ç¬¦</h3><p>ç±»å‹é€šé…ç¬¦æ—¢å¯ä»¥åœ¨æ–¹æ³•ç­¾åä¸­å®šä¹‰å½¢å‚çš„ç±»å‹ï¼Œä¹Ÿå¯ä»¥ç”¨äºå®šä¹‰å˜é‡çš„ç±»å‹ã€‚ä½¿ç”¨é€šé…ç¬¦æ¯”æ˜¾å¼å£°æ˜é€šé…ç¬¦å£°æ˜ç±»å‹å½¢å‚æ›´åŠ æ¸…æ™°å‡†ç¡®ï¼Œæ‰€ä»¥åœ¨å¯èƒ½çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨é€šé…ç¬¦æ›´å¥½ã€‚</p><h4 id="2-2-1-ä¸å—çº¦æŸçš„é€šé…ç¬¦"><a href="#2-2-1-ä¸å—çº¦æŸçš„é€šé…ç¬¦" class="headerlink" title="2.2.1 ä¸å—çº¦æŸçš„é€šé…ç¬¦"></a>2.2.1 ä¸å—çº¦æŸçš„é€šé…ç¬¦</h4><p>é€šé…ç¬¦å¯ç”¨äºå„ç§æƒ…å†µï¼šä½œä¸ºå‚æ•°ï¼Œå­—æ®µæˆ–å±€éƒ¨å˜é‡çš„ç±»å‹;æœ‰æ—¶ä½œä¸ºè¿”å›ç±»å‹ï¼ˆè™½ç„¶æ›´å¥½çš„ç¼–ç¨‹å®è·µæ›´å…·ä½“ï¼‰ã€‚é€šé…ç¬¦ä»ä¸ç”¨ä½œæ³›å‹æ–¹æ³•è°ƒç”¨ï¼Œæ³›å‹ç±»å®ä¾‹åˆ›å»ºæˆ–è¶…ç±»å‹çš„ç±»å‹å‚æ•°ã€‚</p><p>å¦‚æœæ»¡è¶³ä¸‹é¢çš„æ¡ä»¶ä»»æ„ä¸€ä¸ªï¼Œå°±å¯ä»¥ä½¿ç”¨ä¸å—çº¦æŸé€šé…ç¬¦ï¼š</p><ul><li>å¦‚æœä½ æ­£åœ¨ç¼–å†™å¯ä»¥<strong>ä½¿ç”¨Objectç±»ä¸­æä¾›çš„æ–¹æ³•å®ç°</strong>çš„æ–¹æ³•ã€‚</li><li>å½“ä»£ç ä½¿ç”¨åœ¨æ³›å‹ç±»ä¸­ä¸ä¾èµ–ç±»å‹å‚æ•°æ–¹æ³•æ—¶ã€‚ä¾‹å¦‚ï¼šList.size æˆ–è€… List.clearã€‚ äº‹å®ä¸Šï¼ŒClass&lt;?&gt;ç»å¸¸è¢«ä½¿ç”¨ï¼Œå› ä¸ºClass<t>ä¸­çš„å¤§å¤šæ•°æ–¹æ³•ä¸ä¾èµ–Tã€‚</t></li></ul><p>ä½¿ç”¨é€šé…ç¬¦æ—¶ï¼Œä¸èƒ½å°†å…ƒç´ æ”¾å…¥æœªçŸ¥ç±»å‹çš„é›†åˆä¸­ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">List&lt;?&gt; list = new ArrayList&lt;String&gt;();</span><br><span class="line">list.add(&quot;aaa&quot;);//è¿™è¡Œä»£ç å¼•èµ·ç¼–è¯‘æ—¶é”™è¯¯ã€‚å› ä¸ºä¸çŸ¥é“listçš„ç±»å‹ï¼Œæ‰€ä»¥ä¸èƒ½å¾€é‡Œé¢æ”¾ä»»ä½•å…ƒç´ ï¼Œé™¤äº†nullã€‚</span><br></pre></td></tr></table></figure><h4 id="2-2-2-ä¸Šé™é€šé…ç¬¦"><a href="#2-2-2-ä¸Šé™é€šé…ç¬¦" class="headerlink" title="2.2.2 ä¸Šé™é€šé…ç¬¦"></a>2.2.2 ä¸Šé™é€šé…ç¬¦</h4><p>ä½¿ç”¨<code>? extend type</code>è¡¨ç¤ºæ‰€æœ‰typeæ³›å‹ç±»çš„å­ç±»ï¼ˆåŒ…å«typeæœ¬èº«ï¼‰ã€‚</p><h4 id="2-2-3-ä¸‹é™é€šé…ç¬¦"><a href="#2-2-3-ä¸‹é™é€šé…ç¬¦" class="headerlink" title="2.2.3 ä¸‹é™é€šé…ç¬¦"></a>2.2.3 ä¸‹é™é€šé…ç¬¦</h4><p>ä½¿ç”¨<code>? super type</code>è¡¨ç¤ºæ‰€æœ‰typeæ³›å‹ç±»çš„çˆ¶ç±»ï¼ˆåŒ…å«typeæœ¬èº«ï¼‰ã€‚<del>åªèƒ½ç”¨äºæ³›å‹æ–¹æ³•ï¼ˆæœ‰å¾…éªŒè¯ï¼‰ã€‚</del></p><h4 id="2-2-4-é€šé…ç¬¦æ•è·å’ŒHelperæ–¹æ³•"><a href="#2-2-4-é€šé…ç¬¦æ•è·å’ŒHelperæ–¹æ³•" class="headerlink" title="2.2.4 é€šé…ç¬¦æ•è·å’ŒHelperæ–¹æ³•"></a>2.2.4 é€šé…ç¬¦æ•è·å’ŒHelperæ–¹æ³•</h4><p>åœ¨ä¸€äº›æƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨ä¼šæ¨æ–­ä¸€ä¸ªé€šé…ç¬¦çš„ç±»å‹ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªåˆ—è¡¨å¯ä»¥è¢«å®šä¹‰ä¸º<code>List&lt;?&gt;</code>ï¼Œå½“è¯„ä¼°ä¸€ä¸ªè¡¨è¾¾å¼æ—¶ï¼Œç¼–è¯‘å™¨ä¼šä»ä»£ç ä¸­æ¨æ–­ä¸€ä¸ªç‰¹å®šç±»å‹ã€‚æ­¤æ–¹æ¡ˆç§°ä¸ºé€šé…ç¬¦æ•è·ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public class WildcardError &#123;</span><br><span class="line">    void foo(List&lt;?&gt; i) &#123;</span><br><span class="line">        i.set(0, i.get(0));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œ<code>i.set</code>æ–¹æ³•ç¼–è¯‘å¼‚å¸¸ï¼Œç±»å‹å‚æ•°<code>List&lt;?&gt;</code>ä¸ºä¸ç¡®å®šç±»å‹å‚æ•°ï¼Œæ‰€ä»¥<code>i.get(0)</code>è·å–çš„ç±»å‹å‚æ•°ä¸ç¡®å®šï¼Œå› æ­¤<code>i.set</code>æ–¹æ³•ä¸èƒ½å°†æœªçŸ¥ç±»å‹æ”¾å…¥<code>i</code>ä¸­ã€‚ï¼ˆå…¶ä¸­i.seté»˜è®¤æ˜¯i.set(Integer,Object)ï¼Œå› ä¸ºä¸ç¡®å®ši.get(0)çš„ç±»å‹ï¼Œæ‰€ä»¥äº§ç”Ÿç¼–è¯‘é—®é¢˜ï¼‰è§£å†³æ–¹æ¡ˆå¦‚ä¸‹:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public class WildcardFixed &#123;</span><br><span class="line"></span><br><span class="line">    void foo(List&lt;?&gt; i) &#123;</span><br><span class="line">        fooHelper(i);</span><br><span class="line">    &#125;</span><br><span class="line">    // Helper method created so that the wildcard can be captured</span><br><span class="line">    // through type inference.</span><br><span class="line">    private &lt;T&gt; void fooHelper(List&lt;T&gt; l) &#123;</span><br><span class="line">        l.set(0, l.get(0));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-2-5-é€šé…ç¬¦å’Œå­ç±»å‹"><a href="#2-2-5-é€šé…ç¬¦å’Œå­ç±»å‹" class="headerlink" title="2.2.5 é€šé…ç¬¦å’Œå­ç±»å‹"></a>2.2.5 é€šé…ç¬¦å’Œå­ç±»å‹</h4><p>å¦‚æ³›å‹ï¼Œç»§æ‰¿å’Œå­ç±»å‹ä¸­æ‰€è¿°ï¼Œæ³›å‹ç±»æˆ–æ¥å£ä»…ä»…å› ä¸ºå®ƒä»¬çš„ç±»å‹ä¸åŒè€Œæ— å…³ã€‚ä½†æ˜¯ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨é€šé…ç¬¦åœ¨æ³›å‹ç±»æˆ–æ¥å£ä¹‹é—´åˆ›å»ºå…³ç³»ã€‚ä¸‹å›¾æ˜¯Numberå’ŒIntegerä¹‹é—´çš„ç»§æ‰¿å…³ç³»ï¼š<br><img src="/media/article/15579245029350.jpg" alt=""></p><h3 id="2-3-æ³›å‹æ–¹æ³•"><a href="#2-3-æ³›å‹æ–¹æ³•" class="headerlink" title="2.3 æ³›å‹æ–¹æ³•"></a>2.3 æ³›å‹æ–¹æ³•</h3><p>ç¤ºä¾‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">static &lt;T&gt; void fromArrayToCollection(T[] a, Collection&lt;T&gt; c)&#123;</span><br><span class="line">    for(T o:a)&#123;</span><br><span class="line">        c.add(o);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ä¸Šé¢ç¤ºä¾‹ä¸­ï¼Œå®šä¹‰äº†ä¸€ä¸ªæ³›å‹æ–¹æ³•ï¼Œè¯¥æ³›å‹æ–¹æ³•ä¸­å®šä¹‰äº†ä¸€ä¸ªTç±»å‹å½¢å‚ï¼Œè¿™ä¸ªTç±»å‹å½¢å‚å°±å¯ä»¥åœ¨è¯¥æ–¹æ³•å†…å½“æˆæ™®é€šç±»å‹ä½¿ç”¨ã€‚ä¸æ¥å£ã€ç±»å£°æ˜ä¸­å®šä¹‰çš„ç±»å‹å½¢å‚ä¸åŒçš„æ˜¯ï¼Œæ–¹æ³•å£°æ˜ä¸­å®šä¹‰çš„å½¢å‚åªèƒ½åœ¨è¯¥æ–¹æ³•é‡Œä½¿ç”¨ï¼Œè€Œæ¥å£ã€ç±»å£°æ˜ä¸­çš„å®šä¹‰çš„ç±»å‹å½¢å‚åˆ™å¯ä»¥åœ¨æ•´ä¸ªæ¥å£ã€ç±»ä¸­ä½¿ç”¨ã€‚<br>ä¸ç±»ã€æ¥å£ä¸­ä½¿ç”¨æ³›å‹å‚æ•°ä¸åŒçš„æ˜¯ï¼Œæ–¹æ³•ä¸­çš„æ³›å‹å‚æ•°æ— éœ€æ˜¾å¼ä¼ å…¥å®é™…ç±»å‹å‚æ•°ï¼Œæ ¹æ®å®å‚æ¨æ–­ç±»å‹å½¢å‚çš„å€¼ã€‚å¦‚æœç¼–è¯‘å™¨ä¸èƒ½æ¨æ–­ä½ å¸Œæœ›å®ƒæ‹¥æœ‰çš„ç±»å‹ï¼Œå¯ä»¥é€šè¿‡ä¸€ä¸ªæ˜¾ç¤ºçš„ç±»å‹å‚æ•°ï¼ˆexplicit type parameterï¼‰æ¥å‘Šè¯‰å®ƒè¦ä½¿ç”¨å“ªç§ç±»å‹ã€‚<br>æ³›å‹æ–¹æ³•çš„ç”¨æ³•æ ¼å¼ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ä¿®é¥°ç¬¦ &lt;T,S&gt; è¿”å›å€¼ç±»å‹ æ–¹æ³•åï¼ˆå½¢å‚åˆ—è¡¨ï¼‰&#123;</span><br><span class="line">    //æ–¹æ³•ä½“</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><blockquote><p><strong><em>æç¤ºï¼š</em></strong><br>å¦‚æœæŸä¸ªæ–¹æ³•ä¸­ä¸€ä¸ªå½¢å‚ï¼ˆaï¼‰çš„ç±»å‹æˆ–è¿”å›å€¼ç±»å‹ä¾èµ–äºå¦ä¸€ä¸ªå½¢å‚ï¼ˆbï¼‰çš„ç±»å‹ï¼Œåˆ™å½¢å‚ï¼ˆbï¼‰çš„ç±»å‹å£°æ˜ä¸åº”è¯¥ä½¿ç”¨é€šé…ç¬¦ï¼Œå› ä¸ºå½¢å‚ï¼ˆaï¼‰ã€æˆ–è¿”å›å€¼ä¸è¯¥å½¢å‚ï¼ˆbï¼‰çš„ç±»å‹ï¼Œå¦‚æœå½¢å‚ï¼ˆbï¼‰çš„ç±»å‹æ— æ³•ç¡®å®šï¼Œç¨‹åºæ— æ³•å®šä¹‰å½¢å‚ï¼ˆaï¼‰çš„ç±»å‹ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ<strong><em>åªèƒ½è€ƒè™‘ä½¿ç”¨åœ¨æ–¹æ³•ç­¾åä¸­å£°æ˜ç±»å‹å½¢å‚</em></strong>ã€‚</p></blockquote><p>ç±»å‹é€šé…ç¬¦ä¸æ˜¾å¼å£°æ˜ç±»å‹å½¢å‚åŒºåˆ«ï¼š</p><ul><li>ç±»å‹é€šé…ç¬¦å³å¯åœ¨æ–¹æ³•ç­¾åä¸­å®šä¹‰å½¢å‚çš„ç±»å‹ï¼Œä¹Ÿå¯ä»¥ç”¨äºå®šä¹‰å˜é‡çš„ç±»å‹ã€‚ä½†æ³›å‹æ–¹æ³•ä¸­ç±»å‹å½¢å‚å¿…é¡»åœ¨å¯¹åº”æ–¹æ³•ä¸­æ˜¾å¼å£°æ˜ã€‚</li><li><strong><em>æ³›å‹æ–¹æ³•å…è®¸ç±»å‹å½¢å‚ç”¨æ¥è¡¨ç¤ºæ–¹æ³•çš„ä¸€ä¸ªæˆ–å¤šä¸ªå‚æ•°ä¹‹é—´çš„ç±»å‹ä¾èµ–å…³ç³»ï¼Œæˆ–è€…æ–¹æ³•è¿”å›å€¼ä¸å‚æ•°ä¹‹é—´çš„ç±»å‹ä¾èµ–å…³ç³»ã€‚å¦‚æœæ²¡æœ‰è¿™æ ·çš„ä¾èµ–å…³ç³»ï¼Œä¸åº”è¯¥ä½¿ç”¨æ³›å‹æ–¹æ³•ã€‚</em></strong></li></ul><h3 id="2-4-æ³›å‹ä½¿ç”¨å‡†åˆ™"><a href="#2-4-æ³›å‹ä½¿ç”¨å‡†åˆ™" class="headerlink" title="2.4 æ³›å‹ä½¿ç”¨å‡†åˆ™"></a>2.4 æ³›å‹ä½¿ç”¨å‡†åˆ™</h3><blockquote><p>â€œinâ€å˜é‡ï¼šinå˜é‡å‘ä»£ç æä¾›æ•°æ®ã€‚æƒ³è±¡å¤åˆ¶æ–¹æ³•æœ‰ä¸¤ä¸ªå‚æ•°ï¼š<code>copy(src, dest)</code>ã€‚<code>src</code>å‚æ•°æä¾›å¤åˆ¶æ•°æ®ï¼Œå› æ­¤æ—¶â€inâ€å‚æ•°ã€‚<br>â€œoutâ€å˜é‡ï¼šoutå˜é‡ä¿å­˜æ•°æ®ä»¥ä¾›å…¶ä»–åœ°æ–¹ä½¿ç”¨ã€‚åœ¨å¤åˆ¶çš„ä¾‹å­ä¸­ï¼Œ<code>copy(src, dest)</code>ï¼Œ<code>dest</code>å‚æ•°æ¥å—æ•°æ®ï¼Œå› æ­¤æ—¶â€outâ€å‚æ•°ã€‚</p></blockquote><ul><li>ä½¿ç”¨<code>extends</code>å…³é”®å­—å®šä¹‰å¸¦æœ‰ä¸Šé™é€šé…ç¬¦çš„â€œinâ€å˜é‡ã€‚</li><li>ä½¿ç”¨<code>super</code>å…³é”®å­—å®šä¹‰å¸¦æœ‰ä¸‹é™é€šé…ç¬¦çš„â€œoutâ€å˜é‡ã€‚</li><li>åœ¨å¯ä»¥ä½¿ç”¨Objectç±»ä¸­å®šä¹‰çš„æ–¹æ³•è®¿é—®â€œinâ€å˜é‡çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨æ— ç•Œé€šé…ç¬¦ã€‚</li><li>åœ¨ä»£ç éœ€è¦ä½œä¸ºâ€œinâ€å’Œâ€œoutâ€å˜é‡è®¿é—®çš„æƒ…å†µä¸‹ï¼Œä¸è¦ä½¿ç”¨é€šé…ç¬¦ã€‚</li></ul><h2 id="3-æ³›å‹çš„æ“¦é™¤ä¸è½¬æ¢"><a href="#3-æ³›å‹çš„æ“¦é™¤ä¸è½¬æ¢" class="headerlink" title="3. æ³›å‹çš„æ“¦é™¤ä¸è½¬æ¢"></a>3. æ³›å‹çš„æ“¦é™¤ä¸è½¬æ¢</h2><p>æ³›å‹è¢«å¼•å…¥Javaè¯­è¨€ï¼Œä»¥ä¾¿åœ¨ç¼–è¯‘æ—¶æä¾›æ›´ä¸¥æ ¼çš„ç±»å‹æ£€æŸ¥å¹¶æ”¯æŒé€šç”¨ç¼–ç¨‹ï¼ˆå‘ä¸Šå…¼å®¹ï¼‰ã€‚ä¸ºäº†å®ç°æ³›å‹ï¼ŒJavaç¼–è¯‘å™¨å°†ç±»å‹æ“¦é™¤åº”ç”¨äºï¼š</p><ul><li>ä½¿ç”¨è¾¹ç•Œæ›¿æ¢æ‰€æœ‰åœ¨æ³›å‹ä¸­çš„ç±»å‹å‚æ•°æˆ–è€…å¦‚æœç±»å‹å‚æ•°æ˜¯æ— ç•Œçš„åˆ™ä½¿ç”¨<code>Object</code>æ›¿æ¢ã€‚å› æ­¤ç”Ÿæˆçš„å­—èŠ‚ç åªåŒ…å«é€šç”¨çš„ç±»ï¼Œæ¥å£å’Œæ–¹æ³•ã€‚</li><li>å¦‚æœå¿…è¦ï¼Œæ’å…¥ç±»å‹å¼ºåˆ¶è½¬æ¢æ¥ä¿è¯ç±»å‹å®‰å…¨ã€‚</li><li>ç”Ÿæˆæ¡¥æ¥æ–¹æ³•ä»¥ä¿ç•™æ‰©å±•æ³›å‹ç±»å‹ä¸­çš„å¤šæ€æ€§ã€‚</li></ul><p>å¯¹äºä»¥ä¸Š3ç‚¹ï¼Œ1å’Œ3å¯èƒ½åœ¨<a href="#3-1-%E6%B3%9B%E5%9E%8B%E6%96%B9%E6%B3%95%E7%9A%84%E6%93%A6%E9%99%A4">3.1</a>å’Œ<a href="#3-2-%E7%B1%BB%E5%9E%8B%E6%93%A6%E9%99%A4%E7%9A%84%E5%BD%B1%E5%93%8D%E5%92%8C%E6%A1%A5%E6%96%B9%E6%B3%95">3.2</a>ä¸­ä¼šè¯¦ç»†è¯´æ˜ï¼Œä½†æ˜¯ç¬¬äºŒç‚¹å¯èƒ½ä¸æ˜¯é‚£ä¹ˆæ¸…æ¥šï¼Œå¦‚æœæœ‰å¿…è¦ï¼Œç±»å‹æ“¦é™¤æ—¶ï¼Œä¼šè¿›è¡Œå¼ºåˆ¶ç±»å‹è½¬æ¢ã€‚ä¸€èˆ¬è¿™ç§æƒ…å†µåŒ…æ‹¬ï¼š</p><ul><li>æ–¹æ³•çš„è¿”å›ç±»å‹æ˜¯ç±»å‹å‚æ•°ï¼›</li><li>åœ¨è®¿é—®æ•°æ®åŸŸæ—¶ï¼ŒåŸŸçš„ç±»å‹æ˜¯ä¸€ä¸ªç±»å‹å‚æ•°ã€‚</li></ul><p>ä¾‹å¦‚ï¼š<br>é¡¹ç›®ä¸­çš„ä»£ç ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; list1 = new ArrayList&lt;&gt;();</span><br><span class="line">list1.add(&quot;Hell&quot;);</span><br><span class="line">System.out.println(list1.get(0));</span><br></pre></td></tr></table></figure></p><p>ç¼–è¯‘åï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">List list1 = new ArrayList();</span><br><span class="line">list1.add(&quot;Hell&quot;);</span><br><span class="line">System.out.println((String)list1.get(0));</span><br></pre></td></tr></table></figure></p><p>å­—èŠ‚ç ï¼Œå­—èŠ‚ç å‘½ä»¤è¯·å‚é˜…<a href="https://docs.oracle.com/javase/specs/jvms/se7/html/jvms-6.html" target="_blank" rel="noopener">Chapter 6. The Java Virtual Machine Instruction Set</a>ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Code:</span><br><span class="line">       0: new           #3                  // class java/util/ArrayList</span><br><span class="line">       3: dup</span><br><span class="line">       4: invokespecial #4                  // Method java/util/ArrayList.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">       7: astore_1</span><br><span class="line">       8: aload_1</span><br><span class="line">       9: ldc           #5                  // String Hell</span><br><span class="line">      11: invokeinterface #6,  2            // InterfaceMethod java/util/List.add:(Ljava/lang/Object;)Z</span><br><span class="line">      16: pop</span><br><span class="line">      17: getstatic     #7                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">      20: aload_1</span><br><span class="line">      21: iconst_0</span><br><span class="line">      22: invokeinterface #8,  2            // InterfaceMethod java/util/List.get:(I)Ljava/lang/Object;</span><br><span class="line">      27: checkcast     #9                  // class java/lang/String å¼ºåˆ¶ç±»å‹è½¬æ¢æ ¡éªŒæ˜¯å¦ä¸ºStringç±»å‹</span><br><span class="line">      30: invokevirtual #10                 // Method java/io/PrintStream.println:(Ljava/lang/String;)V</span><br><span class="line">      33: return</span><br></pre></td></tr></table></figure></p><p>ä¸Šé¢çš„ä¾‹å­è¯´æ˜ï¼Œç¼–è¯‘å™¨åœ¨æ“¦é™¤æ³›å‹ä»£ç æ—¶ï¼Œç¡®å®ä¿ç•™äº†List<string>çš„ç›¸å…³ä¿¡æ¯ï¼Œä½†æ˜¯ä½ æ— æ³•æ‰¾åˆ°åˆ—è¡¨å¯¹è±¡æœ¬èº«çš„T=Stringï¼Œå‚é˜…è‡ª<a href="https://stackoverflow.com/questions/339699/java-generics-type-erasure-when-and-what-happens/339708#339708" target="_blank" rel="noopener">Java generics type erasure: when and what happens?</a>Jon Skeetçš„answerã€‚</string></p><p>è¯¦ç»†äº†è§£è¯·å‚é˜…<a href="https://stackoverflow.com/questions/55084504/insert-type-casts-if-necessary-to-preserve-type-safety" target="_blank" rel="noopener">Insert type casts if necessary to preserve type safety</a></p><h3 id="3-1-æ³›å‹æ–¹æ³•çš„æ“¦é™¤"><a href="#3-1-æ³›å‹æ–¹æ³•çš„æ“¦é™¤" class="headerlink" title="3.1 æ³›å‹æ–¹æ³•çš„æ“¦é™¤"></a>3.1 æ³›å‹æ–¹æ³•çš„æ“¦é™¤</h3><p>Javaç¼–è¯‘å™¨ä¹Ÿä¼šæ“¦é™¤æ³›å‹æ–¹æ³•ä¸­çš„ç±»å‹å‚æ•°ã€‚</p><p>ä¾‹å¦‚ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public static &lt;T&gt; int count(T[] anArray, T elem)&#123;</span><br><span class="line"></span><br><span class="line">    int cnt = 0;</span><br><span class="line">    for(T e : anArray)&#123;</span><br><span class="line">        if(e.equals(elem))&#123;</span><br><span class="line">            ++cnt;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return cnt;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› ä¸ºTæ˜¯æ— é™åˆ¶çš„ï¼Œæ‰€ä»¥Javaç¼–è¯‘å™¨ä¼šä½¿ç”¨Objectä»£æ›¿å®ƒï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public static int count(Object[] anArray, Object elem) &#123;</span><br><span class="line">    int cnt = 0;</span><br><span class="line">    for (Object e : anArray)</span><br><span class="line">        if (e.equals(elem))</span><br><span class="line">            ++cnt;</span><br><span class="line">        return cnt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-2-ç±»å‹æ“¦é™¤çš„å½±å“å’Œæ¡¥æ–¹æ³•"><a href="#3-2-ç±»å‹æ“¦é™¤çš„å½±å“å’Œæ¡¥æ–¹æ³•" class="headerlink" title="3.2 ç±»å‹æ“¦é™¤çš„å½±å“å’Œæ¡¥æ–¹æ³•"></a>3.2 ç±»å‹æ“¦é™¤çš„å½±å“å’Œæ¡¥æ–¹æ³•</h3><p>åœ¨ç¼–è¯‘æ‰©å±•å‚æ•°åŒ–ç±»æˆ–å®ç°å‚æ•°åŒ–æ¥å£çš„ç±»æˆ–æ¥å£æ—¶ï¼Œç¼–è¯‘å™¨å¯èƒ½éœ€è¦åˆ›å»ºä¸€ä¸ªç§°ä¸ºæ¡¥æ¥æ–¹æ³•çš„åˆæˆæ–¹æ³•ï¼Œä½œä¸ºç±»å‹æ“¦é™¤è¿‡ç¨‹çš„ä¸€éƒ¨åˆ†ã€‚æ‚¨é€šå¸¸ä¸éœ€è¦æ‹…å¿ƒæ¡¥æ¥æ–¹æ³•ï¼Œä½†å¦‚æœå‡ºç°åœ¨å †æ ˆè·Ÿè¸ªä¸­ï¼Œæ‚¨å¯èƒ½ä¼šæ„Ÿåˆ°å›°æƒ‘ã€‚</p><p>ç”Ÿæˆæ¡¥æ¥æ–¹æ³•ä»¥ä¿ç•™æ‰©å±•æ³›å‹ç±»å‹ä¸­çš„å¤šæ€æ€§ã€‚<br>ä¾‹å¦‚ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">public class Node&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    public T data;</span><br><span class="line"></span><br><span class="line">    public Node(T data) &#123; this.data = data; &#125;</span><br><span class="line"></span><br><span class="line">    public void setData(T data) &#123;</span><br><span class="line">        System.out.println(&quot;Node.setData&quot;);</span><br><span class="line">        this.data = data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class MyNode extends Node&lt;Integer&gt; &#123;</span><br><span class="line">    public MyNode(Integer data) &#123; super(data); &#125;</span><br><span class="line"></span><br><span class="line">    public void setData(Integer data) &#123;</span><br><span class="line">        System.out.println(&quot;MyNode.setData&quot;);</span><br><span class="line">        super.setData(data);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€ƒè™‘å¦‚ä¸‹ä»£ç :<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">MyNode mn = new MyNode(5);</span><br><span class="line">Node n = mn;            // A raw type - compiler throws an unchecked warning</span><br><span class="line">n.setData(&quot;Hello&quot;);     </span><br><span class="line">Integer x = mn.data;    // Causes a ClassCastException to be thrown.</span><br></pre></td></tr></table></figure></p><p>ç±»å‹æ“¦é™¤å, ä»£ç å˜æˆ:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">MyNode mn = new MyNode(5);</span><br><span class="line">Node n = (MyNode)mn;         // A raw type - compiler throws an unchecked warning</span><br><span class="line">n.setData(&quot;Hello&quot;);</span><br><span class="line">Integer x = (String)mn.data; // Causes a ClassCastException to be thrown.</span><br></pre></td></tr></table></figure></p><p>ä»£ç æ‰§è¡Œé€»è¾‘å¦‚ä¸‹ï¼š</p><p><code>n.setData(&quot;Hello&quot;)</code>ä½¿å¾—MyNodeç±»å¯¹è±¡ä¸­çš„<code>setData(Object)</code>è¢«æ‰§è¡Œã€‚<br>åœ¨<code>setData(Object)</code>æ–¹æ³•ä½“å†…ï¼Œå¯¹è±¡çš„æ•°æ®å­—æ®µå¼•ç”¨è¢«åˆ†é…ä¸ºStringã€‚<br>é€šè¿‡mnå¼•ç”¨çš„ç›¸åŒå¯¹è±¡æ•°æ®å­—æ®µï¼Œå¯ä»¥è®¿é—®ã€ä¸”æœŸæœ›æ˜¯Intergerç±»å‹ã€‚<br>å°è¯•åˆ†é…Stringåˆ°Integeré€ æˆClassCastExceptionã€‚</p><p>ç±»å‹æ“¦é™¤åä»£ç ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public class Node &#123;</span><br><span class="line"></span><br><span class="line">    public Object data;</span><br><span class="line"></span><br><span class="line">    public Node(Object data) &#123; this.data = data; &#125;</span><br><span class="line"></span><br><span class="line">    public void setData(Object data) &#123;</span><br><span class="line">        System.out.println(&quot;Node.setData&quot;);</span><br><span class="line">        this.data = data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class MyNode extends Node &#123;</span><br><span class="line"></span><br><span class="line">    public MyNode(Integer data) &#123; super(data); &#125;</span><br><span class="line"></span><br><span class="line">    public void setData(Integer data) &#123;</span><br><span class="line">        System.out.println(&quot;MyNode.setData&quot;);</span><br><span class="line">        super.setData(data);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ç±»å‹æ“¦é™¤ä¹‹åï¼Œæ–¹æ³•ç­¾åä¸åŒ¹é…ã€‚ Nodeæ–¹æ³•å˜ä¸ºsetDataï¼ˆObjectï¼‰ï¼ŒMyNodeæ–¹æ³•å˜ä¸ºsetDataï¼ˆIntegerï¼‰ã€‚å› æ­¤ï¼ŒMyNode setDataæ–¹æ³•ä¸ä¼šè¦†ç›–Node setDataæ–¹æ³•ã€‚ ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜å¹¶åœ¨ç±»å‹æ“¦é™¤åä¿ç•™æ³›å‹ç±»å‹çš„å¤šæ€æ€§ï¼ŒJavaç¼–è¯‘å™¨ä¼šç”Ÿæˆä¸€ä¸ªæ¡¥æ¥æ–¹æ³•ï¼Œä»¥ç¡®ä¿å­ç±»å‹æŒ‰é¢„æœŸå·¥ä½œã€‚å¯¹äºMyNodeç±»ï¼Œç¼–è¯‘å™¨ä¸ºsetDataç”Ÿæˆä»¥ä¸‹æ¡¥æ¥æ–¹æ³•ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">class MyNode extends Node &#123;</span><br><span class="line"></span><br><span class="line">    // Bridge method generated by the compiler</span><br><span class="line">    //</span><br><span class="line">    public void setData(Object data) &#123;</span><br><span class="line">        setData((Integer) data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setData(Integer data) &#123;</span><br><span class="line">        System.out.println(&quot;MyNode.setData&quot;);</span><br><span class="line">        super.setData(data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>æ¡¥æ¥æ–¹æ³•ä¸ç±»å‹æ“¦é™¤åçš„Nodeç±»çš„setDataæ–¹æ³•å…·æœ‰ç›¸åŒçš„æ–¹æ³•ç­¾åï¼Œå§”æ‰˜ç»™åŸå§‹çš„setDataæ–¹æ³•(æ¡¥æ¥æ–¹æ³•åœ¨å­—èŠ‚ç ä¸­å¯è§ï¼Œ<code>javap -c class</code>)ã€‚</p><h3 id="3-3-ä¸å¯å…·ä½“åŒ–ç±»å‹"><a href="#3-3-ä¸å¯å…·ä½“åŒ–ç±»å‹" class="headerlink" title="3.3 ä¸å¯å…·ä½“åŒ–ç±»å‹"></a>3.3 ä¸å¯å…·ä½“åŒ–ç±»å‹</h3><p>å¯å…·ä½“åŒ–ç±»å‹æ˜¯åœ¨è¿è¡Œæ—¶ç±»å‹ä¿¡æ¯å®Œå…¨å¯ç”¨çš„ä¸€ç§ç±»å‹ã€‚åŒ…æ‹¬åŸºæœ¬ç±»å‹ï¼Œéæ³›å‹ç±»å‹ï¼ŒåŸå§‹ç±»å‹ï¼Œæ— ç•Œçš„é€šé…ç¬¦è°ƒç”¨ã€‚å”¯ä¸€å¯å…·ä½“åŒ–å‚æ•°åŒ–ç±»å‹æ˜¯æ— é™åˆ¶é€šé…ç¬¦ç±»å‹ï¼Œå¦‚<code>List&lt;?&gt;</code>å’Œ<code>Map&lt;?,?&gt;</code>ã€‚<br>ä¸å¯å…·ä½“åŒ–ç±»å‹æ˜¯ç±»å‹ä¿¡æ¯åœ¨ç¼–è¯‘æ—¶é€šè¿‡ç±»å‹æ“¦é™¤è¢«åˆ é™¤â€”â€”â€”â€”è°ƒç”¨æœªå®šä¹‰ä¸ºæ— ç•Œé€šé…ç¬¦çš„æ³›å‹ç±»å‹ã€‚ä¸å¯å…·ä½“åŒ–çš„ç±»å‹åœ¨è¿è¡Œæ—¶ä¸æ˜¯æ‰€æœ‰ä¿¡æ¯éƒ½å¯ç”¨ã€‚ä¸å¯å…·ä½“åŒ–ç±»å‹çš„ç¤ºä¾‹æ˜¯<code>List &lt;String&gt;</code>å’Œ<code>List &lt;Number&gt;</code>; JVMæ— æ³•åœ¨è¿è¡Œæ—¶åŒºåˆ†è¿™äº›ç±»å‹ã€‚å¦‚<a href="#4-æ³›å‹çš„é™åˆ¶">4 æ³›å‹çš„é™åˆ¶</a>ä¸­æ‰€ç¤ºï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä¸èƒ½ä½¿ç”¨ä¸å¯å…·ä½“åŒ–çš„ç±»å‹ï¼šä¾‹å¦‚ï¼Œåœ¨<code>instanceof</code>è¡¨è¾¾å¼çš„å®ä¾‹ä¸­ï¼Œæˆ–ä½œä¸ºæ•°ç»„ä¸­çš„å…ƒç´ ã€‚</p><h3 id="3-4-å †æ±¡æŸ“"><a href="#3-4-å †æ±¡æŸ“" class="headerlink" title="3.4 å †æ±¡æŸ“"></a>3.4 å †æ±¡æŸ“</h3><p>å †æ±¡æŸ“å‘ç”Ÿåœ¨å½“å‚æ•°åŒ–ç±»å‹çš„å˜é‡å¼•ç”¨ä¸æ˜¯è¯¥å‚æ•°åŒ–ç±»å‹çš„å¯¹è±¡æ—¶ã€‚å¦‚æœç¨‹åºæ‰§è¡ŒæŸäº›æ“ä½œï¼Œåœ¨ç¼–è¯‘æ—¶äº§ç”Ÿæœªç»æ£€æŸ¥çš„è­¦å‘Šï¼Œåˆ™ä¼šå‡ºç°è¿™ç§æƒ…å†µã€‚å¦‚æœåœ¨ç¼–è¯‘æ—¶ï¼ˆåœ¨ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥è§„åˆ™çš„é™åˆ¶å†…ï¼‰æˆ–åœ¨è¿è¡Œæ—¶ï¼Œä¸€ä¸ªåŒ…å«å‚æ•°åŒ–ç±»å‹æ“ä½œçš„æ­£ç¡®æ€§ä¸èƒ½è¢«éªŒè¯ï¼Œåˆ™ä¼šç”Ÿæˆæœªç»æ£€æŸ¥çš„è­¦å‘Šã€‚ä¾‹å¦‚ï¼Œåœ¨æ··åˆåŸå§‹ç±»å‹å’Œå‚æ•°åŒ–ç±»å‹æ—¶ï¼Œæˆ–è€…åœ¨æ‰§è¡Œæœªç»æ£€æŸ¥çš„å¼ºåˆ¶è½¬æ¢æ—¶ï¼Œä¼šå‘ç”Ÿå †æ±¡æŸ“ã€‚</p><p>åœ¨é€šå¸¸æƒ…å†µä¸‹ï¼Œå½“æ‰€æœ‰ä»£ç åœ¨ç›¸åŒæ—¶é—´è¢«ç¼–è¯‘ï¼Œç¼–è¯‘å™¨ä¸ºæ½œåœ¨çš„å †æ±¡æŸ“äº§ç”Ÿä¸€ä¸ªæœªç»æ£€æŸ¥è­¦å‘Šæ¥å¼•èµ·ä½ çš„æ³¨æ„ã€‚å¦‚æœä½ åˆ†å¼€ç¼–è¯‘ä»£ç çš„å„ä¸ªéƒ¨åˆ†ï¼Œå¾ˆéš¾æ£€æŸ¥å‡ºå †æ±¡æŸ“çš„æ½œåœ¨é£é™©ã€‚å¦‚æœä½ ç¡®ä¿ä½ çš„ä»£ç ç¼–è¯‘æ²¡æœ‰è­¦å‘Šï¼Œåˆ™ä¸ä¼šæœ‰å †æ±¡æŸ“å¯ä»¥å‘ç”Ÿã€‚</p><h3 id="3-5-ä½¿ç”¨ä¸å¯å…·ä½“åŒ–å½¢å‚çš„å¯å˜å‚æ•°æ–¹æ³•çš„æ½œåœ¨æ¼æ´"><a href="#3-5-ä½¿ç”¨ä¸å¯å…·ä½“åŒ–å½¢å‚çš„å¯å˜å‚æ•°æ–¹æ³•çš„æ½œåœ¨æ¼æ´" class="headerlink" title="3.5 ä½¿ç”¨ä¸å¯å…·ä½“åŒ–å½¢å‚çš„å¯å˜å‚æ•°æ–¹æ³•çš„æ½œåœ¨æ¼æ´"></a>3.5 ä½¿ç”¨ä¸å¯å…·ä½“åŒ–å½¢å‚çš„å¯å˜å‚æ•°æ–¹æ³•çš„æ½œåœ¨æ¼æ´</h3><p>åŒ…å«å¯å˜è¾“å…¥å‚æ•°æ³›å‹æ–¹æ³•å¯ä»¥é€ æˆå †æ±¡æŸ“ã€‚<br>è€ƒè™‘å¦‚ä¸‹classï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public class ArrayBuilder &#123;</span><br><span class="line"></span><br><span class="line">  public static &lt;T&gt; void addToList (List&lt;T&gt; listArg, T... elements) &#123;</span><br><span class="line">    for (T x : elements) &#123;</span><br><span class="line">      listArg.add(x);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public static void faultyMethod(List&lt;String&gt;... l) &#123;</span><br><span class="line">    Object[] objectArray = l;     // Valid</span><br><span class="line">    objectArray[0] = Arrays.asList(42);</span><br><span class="line">    String s = l[0].get(0);       // ClassCastException thrown here</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å¦‚ä¸‹ä¾‹å­ï¼Œ<code>HeapPollutionExample</code>ä½¿ç”¨<code>ArrayBuilder</code>ç±»ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public class HeapPollutionExample &#123;</span><br><span class="line"></span><br><span class="line">  public static void main(String[] args) &#123;</span><br><span class="line"></span><br><span class="line">    List&lt;String&gt; stringListA = new ArrayList&lt;String&gt;();</span><br><span class="line">    List&lt;String&gt; stringListB = new ArrayList&lt;String&gt;();</span><br><span class="line"></span><br><span class="line">    ArrayBuilder.addToList(stringListA, &quot;Seven&quot;, &quot;Eight&quot;, &quot;Nine&quot;);</span><br><span class="line">    ArrayBuilder.addToList(stringListB, &quot;Ten&quot;, &quot;Eleven&quot;, &quot;Twelve&quot;);</span><br><span class="line">    List&lt;List&lt;String&gt;&gt; listOfStringLists =</span><br><span class="line">      new ArrayList&lt;List&lt;String&gt;&gt;();</span><br><span class="line">    ArrayBuilder.addToList(listOfStringLists,</span><br><span class="line">      stringListA, stringListB);</span><br><span class="line"></span><br><span class="line">    ArrayBuilder.faultyMethod(Arrays.asList(&quot;Hello!&quot;), Arrays.asList(&quot;World!&quot;));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ç¼–è¯‘æ—¶ï¼Œå¦‚ä¸‹<code>ArrayBuilder.addToList</code>æ–¹æ³•çš„å®šä¹‰å°†äº§ç”Ÿwarningï¼š<br><code>warning: [varargs] Possible heap pollution from parameterized vararg type T</code><br>å½“ç¼–è¯‘å™¨é‡åˆ°ä¸€ä¸ªå¯å˜å‚æ•°æ–¹æ³•ï¼Œå®ƒè½¬æ¢å¯å˜å½¢å‚ä¸ºæ•°ç»„ã€‚ç„¶è€Œï¼ŒJavaç¼–ç¨‹è¯­è¨€ä¸å…è®¸å‚æ•°åŒ–ç±»å‹æ•°ç»„çš„åˆ›å»ºã€‚åœ¨<code>ArrrayBuilder.addToList</code>æ–¹æ³•ä¸­ï¼Œç¼–è¯‘å™¨è½¬æ¢å¯å˜å½¢å‚<code>T...</code>è¦ç´ ä¸º<code>T[]</code>è¦ç´ ã€‚å› ä¸ºç±»å‹æ“¦é™¤ï¼Œç¼–è¯‘å™¨è½¬æ¢å¯å˜å½¢å‚ä¸º<code>Object[]</code>è¦ç´ ã€‚æ‰€ä»¥ï¼Œæœ‰å †æ±¡æŸ“çš„å¯èƒ½æ€§ã€‚<br>å¦‚ä¸‹å£°æ˜åˆ†é…å¯å˜å½¢å‚ç»™å¯¹è±¡æ•°ç»„ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Object[] objectArray = l;</span><br></pre></td></tr></table></figure></p><p>è¿™ç§å£°æ˜å¯èƒ½å¼•èµ·å †æ±¡æŸ“ã€‚å¯ä»¥å°†ä¸å¯å˜å½¢å‚<code>l</code>çš„å‚æ•°åŒ–ç±»å‹åŒ¹é…çš„å€¼åˆ†é…ç»™å˜é‡objectArrayï¼Œå› æ­¤å¯ä»¥åˆ†é…ç»™<code>l</code>ã€‚ç„¶è€Œï¼Œåœ¨æ­¤å£°æ˜ä¸­ï¼Œç¼–è¯‘å™¨ä¸èƒ½ç”Ÿæˆä¸€ä¸ªæœªç»æ£€æŸ¥è­¦å‘Šã€‚ç¼–è¯‘å™¨æ—©å·²åœ¨è½¬æ¢å¯å˜å½¢å‚<code>List&lt;String&gt;...l</code> åˆ°å½¢å‚<code>List[] l</code>æ—¶ç”Ÿæˆè­¦å‘Šã€‚è¿™ä¸ªå£°æ˜æ˜¯æœ‰æ•ˆçš„ï¼›<code>l</code>å˜é‡çš„ç±»å‹æ˜¯<code>List[]</code>ï¼Œæ˜¯<code>Object[]</code>çš„å­ç±»å‹ã€‚</p><p>å› æ­¤ï¼Œå¦‚æœå°†ä»»ä½•ç±»å‹çš„Listå¯¹è±¡åˆ†é…ç»™objectArrayæ•°ç»„çš„ä»»ä½•æ•°ç»„ç»„ä»¶ï¼Œç¼–è¯‘å™¨ä¸ä¼šå‘å‡ºè­¦å‘Šæˆ–é”™è¯¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<br><code>ArrayBuilder.faultyMethod(Arrays.asList(&quot;Hello!&quot;), Arrays.asList(&quot;World!&quot;));</code><br>åœ¨è¿è¡Œæ—¶ï¼ŒJVMåœ¨ä»¥ä¸‹è¯­å¥ä¸­æŠ›å‡º<code>ClassCastException</code>:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// ClassCastException thrown here</span><br><span class="line">String s = l[0].get(0);</span><br></pre></td></tr></table></figure></p><p>å­˜å‚¨åœ¨å˜é‡<code>l</code>çš„ç¬¬ä¸€ä¸ªæ•°ç»„ç»„ä»¶ä¸­çš„å¯¹è±¡å…·æœ‰<code>List&lt;Integer&gt;</code>ç±»å‹ï¼Œä½†æ­¤è¯­å¥éœ€è¦ä¸€ä¸ª<code>List &lt;String&gt;</code>ç±»å‹çš„å¯¹è±¡ã€‚</p><h3 id="3-6-ä½¿ç”¨ä¸å¯å…·ä½“åŒ–çš„å½¢å‚é˜²æ­¢å¯å˜å‚æ•°æ–¹æ³•å‘å‡ºè­¦å‘Š"><a href="#3-6-ä½¿ç”¨ä¸å¯å…·ä½“åŒ–çš„å½¢å‚é˜²æ­¢å¯å˜å‚æ•°æ–¹æ³•å‘å‡ºè­¦å‘Š" class="headerlink" title="3.6 ä½¿ç”¨ä¸å¯å…·ä½“åŒ–çš„å½¢å‚é˜²æ­¢å¯å˜å‚æ•°æ–¹æ³•å‘å‡ºè­¦å‘Š"></a>3.6 ä½¿ç”¨ä¸å¯å…·ä½“åŒ–çš„å½¢å‚é˜²æ­¢å¯å˜å‚æ•°æ–¹æ³•å‘å‡ºè­¦å‘Š</h3><p>å¦‚æœå£°æ˜å…·æœ‰å‚æ•°åŒ–ç±»å‹å‚æ•°çš„å¯å˜å‚æ•°æ–¹æ³•ï¼Œå¹¶ç¡®ä¿æ–¹æ³•ä½“ä¸ä¼šå› å¯å˜å‚æ•°å½¢å‚å¤„ç†ä¸å½“è€ŒæŠ›å‡º<code>ClassCastException</code>æˆ–å…¶ä»–ç±»ä¼¼å¼‚å¸¸ï¼Œä½ å¯ä»¥é€šè¿‡ç»™é™æ€å’Œéæ„é€ æ–¹æ³•å£°æ˜æ·»åŠ å¦‚ä¸‹çš„æ³¨è§£é˜²æ­¢ç¼–è¯‘å™¨ç»™è¿™äº›å¯å˜å‚æ•°æ–¹æ³•ç”Ÿæˆè­¦å‘Šï¼š<br><code>@SafeVarargs</code><br><code>@SafeVarargs</code>æ³¨è§£æ˜¯æ–¹æ³•çº¦å®šçš„è®°å½•éƒ¨åˆ†;è¿™ä¸ªæ³¨é‡Šæ–­è¨€è¯¥æ–¹æ³•çš„å®ç°ä¸ä¼šä¸æ­£ç¡®åœ°å¤„ç†å¯å˜å½¢å‚ã€‚<br> å°½ç®¡ä¸å¤ªå¯å–ï¼Œä½†é€šè¿‡åœ¨æ–¹æ³•å£°æ˜ä¸­æ·»åŠ ä»¥ä¸‹å†…å®¹æ¥æ¶ˆé™¤æ­¤ç±»è­¦å‘Šä¹Ÿæ˜¯å¯ä»¥çš„ï¼š<br><code>@SuppressWarnings({&quot;unchecked&quot;, &quot;varargs&quot;})</code><br>ä½†æ˜¯ï¼Œæ­¤æ–¹æ³•ä¸ä¼šæ¶ˆé™¤ä»æ–¹æ³•çš„è°ƒç”¨ç‚¹ç”Ÿæˆçš„è­¦å‘Šã€‚å¦‚æœæ‚¨ä¸ç†Ÿæ‚‰<code>@SuppressWarnings</code>è¯­æ³•ï¼Œè¯·å‚é˜…æ³¨é‡Šã€‚</p><h2 id="4-æ³›å‹çš„é™åˆ¶"><a href="#4-æ³›å‹çš„é™åˆ¶" class="headerlink" title="4 æ³›å‹çš„é™åˆ¶"></a>4 æ³›å‹çš„é™åˆ¶</h2><h3 id="4-1-ä¸èƒ½ä½¿ç”¨åŸºæœ¬ç±»å‹å®ä¾‹åŒ–é€šç”¨ç±»å‹"><a href="#4-1-ä¸èƒ½ä½¿ç”¨åŸºæœ¬ç±»å‹å®ä¾‹åŒ–é€šç”¨ç±»å‹" class="headerlink" title="4.1 ä¸èƒ½ä½¿ç”¨åŸºæœ¬ç±»å‹å®ä¾‹åŒ–é€šç”¨ç±»å‹"></a>4.1 ä¸èƒ½ä½¿ç”¨åŸºæœ¬ç±»å‹å®ä¾‹åŒ–é€šç”¨ç±»å‹</h3><p>è€ƒè™‘å¦‚ä¸‹ä»£ç ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">class Pair&lt;K, V&gt; &#123;</span><br><span class="line"></span><br><span class="line">    private K key;</span><br><span class="line">    private V value;</span><br><span class="line"></span><br><span class="line">    public Pair(K key, V value) &#123;</span><br><span class="line">        this.key = key;</span><br><span class="line">        this.value = value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å½“åˆ›å»ºä¸€ä¸ª<code>Pair</code>å¯¹è±¡ï¼Œä½ ä¸èƒ½ä¸ºç±»å‹å‚æ•°<code>K</code>æˆ–è€…<code>V</code>æ›¿æ¢æˆåŸºæœ¬ç±»å‹ï¼š<br><code>Pair&lt;int, char&gt; p = new Pair&lt;&gt;(8, &#39;a&#39;);  // compile-time error</code><br>ä½ ä»…å¯ä»¥ä¸ºç±»å‹å‚æ•°<code>K</code>æˆ–è€…<code>V</code>æ›¿æ¢éåŸºæœ¬ç±»å‹ï¼š<br><code>Pair&lt;Integer, Character&gt; p = new Pair&lt;&gt;(8, &#39;a&#39;);</code><br>Javaç¼–è¯‘å™¨è‡ªåŠ¨è£…ç®±<code>8</code>ä¸º<code>Integer.valueOf(8)</code>å’Œ<code>a</code>ä¸º<code>Character(&#39;a&#39;)</code>ï¼š<br><code>Pair&lt;Integer, Character&gt; p = new Pair&lt;&gt;(Integer.valueOf(8), new Character(&#39;a&#39;));</code></p><h3 id="4-2-ä¸èƒ½åˆ›å»ºç±»å‹å‚æ•°å®ä¾‹"><a href="#4-2-ä¸èƒ½åˆ›å»ºç±»å‹å‚æ•°å®ä¾‹" class="headerlink" title="4.2 ä¸èƒ½åˆ›å»ºç±»å‹å‚æ•°å®ä¾‹"></a>4.2 ä¸èƒ½åˆ›å»ºç±»å‹å‚æ•°å®ä¾‹</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public static &lt;E&gt; void append(List&lt;E&gt; list) &#123;</span><br><span class="line">    E elem = new E();  // compile-time error</span><br><span class="line">    list.add(elem);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ‰ä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œä½ å¯ä»¥åˆ›å»ºä¸€ä¸ªç±»å‹å‚æ•°å¯¹è±¡é€šè¿‡åå°„ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public static &lt;E&gt; void append(List&lt;E&gt; list, Class&lt;E&gt; cls) throws Exception &#123;</span><br><span class="line">    E elem = cls.newInstance();   // OK</span><br><span class="line">    list.add(elem);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ä½ å¯ä»¥è°ƒç”¨<code>append</code>æ–¹æ³•å¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; ls = new ArrayList&lt;&gt;();</span><br><span class="line">append(ls, String.class);</span><br></pre></td></tr></table></figure></p><h3 id="4-3-ä¸èƒ½å£°æ˜é™æ€å­—æ®µçš„ç±»å‹ä¸ºç±»å‹å‚æ•°"><a href="#4-3-ä¸èƒ½å£°æ˜é™æ€å­—æ®µçš„ç±»å‹ä¸ºç±»å‹å‚æ•°" class="headerlink" title="4.3 ä¸èƒ½å£°æ˜é™æ€å­—æ®µçš„ç±»å‹ä¸ºç±»å‹å‚æ•°"></a>4.3 ä¸èƒ½å£°æ˜é™æ€å­—æ®µçš„ç±»å‹ä¸ºç±»å‹å‚æ•°</h3><p>ç±»çš„é™æ€å­—æ®µæ˜¯ç±»ç­‰çº§å˜é‡ï¼Œè¢«å½“å‰ç±»çš„æ‰€æœ‰éé™æ€å¯¹è±¡å…±äº«ã€‚å› æ­¤ï¼Œç±»å‹å‚æ•°çš„é™æ€å­—æ®µæ˜¯ä¸å…è®¸çš„ã€‚è€ƒè™‘å¦‚ä¸‹ç±»ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public class MobileDevice&lt;T&gt; &#123;</span><br><span class="line">    private static T os;</span><br><span class="line"></span><br><span class="line">    // ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å¦‚æœç±»å‹å‚æ•°çš„é™æ€å­—æ®µè¢«å…è®¸ï¼Œå¦‚ä¸‹çš„ä»£ç å°†ä¼šæ··ä¹±ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MobileDevice&lt;Smartphone&gt; phone = new MobileDevice&lt;&gt;();</span><br><span class="line">MobileDevice&lt;Pager&gt; pager = new MobileDevice&lt;&gt;();</span><br><span class="line">MobileDevice&lt;TabletPC&gt; pc = new MobileDevice&lt;&gt;();</span><br></pre></td></tr></table></figure></p><p>å› ä¸ºé™æ€å­—æ®µ<code>os</code>è¢«<code>phone</code>,<code>pager</code>å’Œ<code>pc</code>å…±äº«ï¼Œä»€ä¹ˆæ˜¯<code>os</code>çš„çœŸå®ç±»å‹ï¼Ÿåœ¨ç›¸åŒçš„æ—¶é—´å®ƒä¸å¯èƒ½æ˜¯<code>Smartphone</code>ï¼Œ<code>Pager</code>ï¼Œå’Œ<code>TablePc</code>ã€‚å› æ­¤ä½ ä¸èƒ½åˆ›å»ºç±»å‹å‚æ•°é™æ€å­—æ®µã€‚</p><h3 id="4-4-ä¸èƒ½ä½¿ç”¨å‚æ•°åŒ–ç±»å‹å¼ºåˆ¶ç±»å‹è½¬æ¢æˆ–è€…instanceof"><a href="#4-4-ä¸èƒ½ä½¿ç”¨å‚æ•°åŒ–ç±»å‹å¼ºåˆ¶ç±»å‹è½¬æ¢æˆ–è€…instanceof" class="headerlink" title="4.4 ä¸èƒ½ä½¿ç”¨å‚æ•°åŒ–ç±»å‹å¼ºåˆ¶ç±»å‹è½¬æ¢æˆ–è€…instanceof"></a>4.4 ä¸èƒ½ä½¿ç”¨å‚æ•°åŒ–ç±»å‹å¼ºåˆ¶ç±»å‹è½¬æ¢æˆ–è€…<code>instanceof</code></h3><p>å› ä¸ºJavaç¼–è¯‘å™¨åœ¨æ³›å‹ä»£ç ä¸­æ“¦é™¤æ‰€æœ‰ç±»å‹å‚æ•°ï¼Œæ‚¨æ— æ³•éªŒè¯åœ¨è¿è¡Œæ—¶ä½¿ç”¨æ³›å‹ç±»å‹çš„å‚æ•°åŒ–ç±»å‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public static &lt;E&gt; void rtti(List&lt;E&gt; list) &#123;</span><br><span class="line">    if (list instanceof ArrayList&lt;Integer&gt;) &#123;  // compile-time error</span><br><span class="line">        // ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ä¼ é€’åˆ°<code>rtti</code>æ–¹æ³•çš„å‚æ•°åŒ–ç±»å‹é›†åˆæ˜¯ï¼š<br><code>S = { ArrayList&lt;Integer&gt;, ArrayList&lt;String&gt; LinkedList&lt;Character&gt;, ... }</code><br>è¿è¡Œæ—¶ä¸ä¿æŒå¯¹ç±»å‹å‚æ•°çš„è·Ÿè¸ªï¼Œå› æ­¤å®ƒä¸èƒ½å‘Šè¯‰<code>ArrayList&lt;Integer&gt;</code>å’Œ<code>ArrayList&lt;String&gt;</code>ä¹‹é—´çš„ä¸åŒã€‚ä½ æœ€å¤šæ˜¯ä½¿ç”¨æ— é™é€šé…ç¬¦æ¥éªŒè¯åˆ—è¡¨æ˜¯å¦ä¸ºArrayListã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public static void rtti(List&lt;?&gt; list) &#123;</span><br><span class="line">    if (list instanceof ArrayList&lt;?&gt;) &#123;  // OK; instanceof requires a reifiable type</span><br><span class="line">        // ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>é€šå¸¸ï¼Œä½ ä¸èƒ½å¼ºåˆ¶è½¬æ¢å‚æ•°åŒ–ç±»å‹ï¼Œé™¤éå®ƒé€šè¿‡æ— é™åˆ¶é€šé…ç¬¦å‚æ•°åŒ–ã€‚ä¾‹å¦‚ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Integer&gt; li = new ArrayList&lt;&gt;();</span><br><span class="line">List&lt;Number&gt;  ln = (List&lt;Number&gt;) li;  // compile-time error</span><br></pre></td></tr></table></figure></p><p>ä½†æ˜¯ï¼Œåœ¨ä¸€äº›æƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨çŸ¥é“ç±»å‹å‚æ•°æ€»æ˜¯æœ‰æ•ˆçš„ï¼Œå…è®¸å¼ºåˆ¶ç±»å‹è½¬æ¢ã€‚ä¾‹å¦‚ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; l1 = ...;</span><br><span class="line">ArrayList&lt;String&gt; l2 = (ArrayList&lt;String&gt;)l1;  // OK</span><br></pre></td></tr></table></figure></p><h3 id="4-5-ä¸èƒ½åˆ›å»ºå‚æ•°åŒ–ç±»å‹çš„æ•°ç»„"><a href="#4-5-ä¸èƒ½åˆ›å»ºå‚æ•°åŒ–ç±»å‹çš„æ•°ç»„" class="headerlink" title="4.5 ä¸èƒ½åˆ›å»ºå‚æ•°åŒ–ç±»å‹çš„æ•°ç»„"></a>4.5 ä¸èƒ½åˆ›å»ºå‚æ•°åŒ–ç±»å‹çš„æ•°ç»„</h3><p>ä¾‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Integer&gt;[] arrayOfLists = new List&lt;Integer&gt;[2];  // compile-time error</span><br></pre></td></tr></table></figure></p><p>å¦‚ä¸‹ä»£ç è¯´æ˜åœ¨ä¸åŒç±»å‹æ’å…¥åˆ—è¡¨æ˜¯å‘ç”Ÿäº†ä»€ä¹ˆï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Object[] strings = new String[2];</span><br><span class="line">strings[0] = &quot;hi&quot;;   // OK</span><br><span class="line">strings[1] = 100;    // An ArrayStoreException is thrown.</span><br></pre></td></tr></table></figure></p><p>å¦‚æœä½ ä½¿ç”¨æ³›å‹åˆ—è¡¨å°è¯•ç›¸åŒçš„äº‹æƒ…ï¼Œå°†ä¼šæœ‰å¦‚ä¸‹é—®é¢˜ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Object[] stringLists = new List&lt;String&gt;[];  // compiler error, but pretend it&apos;s allowed</span><br><span class="line">stringLists[0] = new ArrayList&lt;String&gt;();   // OK</span><br><span class="line">stringLists[1] = new ArrayList&lt;Integer&gt;();  // An ArrayStoreException should be thrown,</span><br><span class="line">                                            // but the runtime can&apos;t detect it.</span><br></pre></td></tr></table></figure></p><p> å¦‚æœå‚æ•°åŒ–åˆ—è¡¨æ•°ç»„æ˜¯å…è®¸çš„ï¼Œä¹‹å‰çš„ä»£ç å°†å¤±è´¥æŠ›å‡º<code>ArrayStoreException</code>ã€‚</p><h3 id="4-6-ä¸èƒ½åˆ›å»ºã€æ•è·æˆ–è€…æŠ›å‡ºå‚æ•°åŒ–ç±»å‹å¯¹è±¡"><a href="#4-6-ä¸èƒ½åˆ›å»ºã€æ•è·æˆ–è€…æŠ›å‡ºå‚æ•°åŒ–ç±»å‹å¯¹è±¡" class="headerlink" title="4.6 ä¸èƒ½åˆ›å»ºã€æ•è·æˆ–è€…æŠ›å‡ºå‚æ•°åŒ–ç±»å‹å¯¹è±¡"></a>4.6 ä¸èƒ½åˆ›å»ºã€æ•è·æˆ–è€…æŠ›å‡ºå‚æ•°åŒ–ç±»å‹å¯¹è±¡</h3><p>æ³›å‹ç±»ä¹Ÿä¸èƒ½ç›´æ¥æˆ–é—´æ¥ç»§æ‰¿è‡ªThrowableã€‚åŸå› æ˜¯å› ä¸ºåœ¨ç¼–è¯‘æœŸå’Œè¿è¡Œæ—¶éƒ½å¿…é¡»çŸ¥é“å¼‚å¸¸çš„ç¡®åˆ‡ç±»å‹ã€‚ä¾‹å¦‚å¦‚ä¸‹ç±»å°†ä¸ç¼–è¯‘ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// Extends Throwable indirectly</span><br><span class="line">class MathException&lt;T&gt; extends Exception &#123; /* ... */ &#125;    // compile-time error</span><br><span class="line"></span><br><span class="line">// Extends Throwable directly</span><br><span class="line">class QueueFullException&lt;T&gt; extends Throwable &#123; /* ... */ // compile-time error</span><br></pre></td></tr></table></figure></p><p>ä¸€ä¸ªæ–¹æ³•ä¸èƒ½æ•è·ä¸€ä¸ªç±»å‹å‚æ•°çš„å®ä¾‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public static &lt;T extends Exception, J&gt; void execute(List&lt;J&gt; jobs) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        for (J job : jobs)</span><br><span class="line">            // ...</span><br><span class="line">    &#125; catch (T e) &#123;   // compile-time error</span><br><span class="line">        // ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ä½†æ˜¯ï¼Œä½ å¯ä»¥åœ¨ä¸€ä¸ª<code>throws</code>å­å¥ä¸­ä½¿ç”¨ç±»å‹å‚æ•°ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">class Parser&lt;T extends Exception&gt; &#123;</span><br><span class="line">    public void parse(File file) throws T &#123;     // OK</span><br><span class="line">        // ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å¦‚æœä¸èƒ½å‚æ•°åŒ–æ‰€æŠ›å‡ºçš„å¼‚å¸¸ï¼Œé‚£ä¹ˆç”±äºæ£€æŸ¥å‹å¼‚å¸¸çš„ç¼˜æ•…ï¼Œå°†ä¸èƒ½ç¼–å†™å‡ºä¸Šè¿°æ³›åŒ–çš„ä»£ç ã€‚</p><h3 id="4-7-ä¸èƒ½é‡è½½å½¢å¼ç±»å‹å‚æ•°æ“¦é™¤åç›¸åŒåŸå§‹ç±»å‹çš„æ–¹æ³•"><a href="#4-7-ä¸èƒ½é‡è½½å½¢å¼ç±»å‹å‚æ•°æ“¦é™¤åç›¸åŒåŸå§‹ç±»å‹çš„æ–¹æ³•" class="headerlink" title="4.7 ä¸èƒ½é‡è½½å½¢å¼ç±»å‹å‚æ•°æ“¦é™¤åç›¸åŒåŸå§‹ç±»å‹çš„æ–¹æ³•"></a>4.7 ä¸èƒ½é‡è½½å½¢å¼ç±»å‹å‚æ•°æ“¦é™¤åç›¸åŒåŸå§‹ç±»å‹çš„æ–¹æ³•</h3><p>ä¾‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public class Example &#123;</span><br><span class="line">    public void print(Set&lt;String&gt; strSet) &#123; &#125;</span><br><span class="line">    public void print(Set&lt;Integer&gt; intSet) &#123; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>é‡è½½å°†å…±äº«ç›¸åŒçš„ç±»æ–‡ä»¶è¡¨ç¤ºï¼Œå¹¶å°†ç”Ÿæˆç¼–è¯‘æ—¶é”™è¯¯ã€‚</p><h2 id="5-æ³›å‹ä¸æ•°ç»„"><a href="#5-æ³›å‹ä¸æ•°ç»„" class="headerlink" title="5. æ³›å‹ä¸æ•°ç»„"></a>5. æ³›å‹ä¸æ•°ç»„</h2><p>JDK1.5çš„æ³›å‹æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„è®¾è®¡åŸåˆ™ï¼šå¦‚æœä¸€æ®µä»£ç åœ¨ç¼–è¯‘æ—¶ç³»ç»Ÿæ²¡æœ‰äº§ç”Ÿï¼šâ€œ[unchecked]æœªç»æ£€æŸ¥çš„è½¬æ¢â€œè­¦å‘Šï¼Œåˆ™ç¨‹åºåœ¨è¿è¡Œæ—¶ä¸ä¼šå¼•å‘â€ClassCastExceptionâ€œå¼‚å¸¸ã€‚</p><p>æ•°ç»„æ˜¯åå˜çš„ï¼ˆconvariantï¼‰: å¦‚æœSubä¸ºSuperçš„å­ç±»å‹ï¼Œé‚£ä¹ˆæ•°ç»„ç±»å‹<code>Sub[]</code>å°±æ˜¯<code>Super[]</code>çš„å­ç±»å‹ã€‚<br>æ•°ç»„æ˜¯å…·ä½“åŒ–çš„ï¼ˆreifiedï¼‰: æ•°ç»„åœ¨è¿è¡Œæ—¶æ‰çŸ¥é“å¹¶æ£€æŸ¥ä»–ä»¬çš„å…ƒç´ ç±»å‹çº¦æŸã€‚</p><p>æ³›å‹æ—¶ä¸å¯å˜çš„ï¼ˆinvariantï¼‰: å¯¹äºä»»æ„ä¸¤ä¸ªä¸åŒçš„ç±»å‹Type1å’ŒType2ï¼Œ<code>List&lt;Type1&gt;</code>æ—¢ä¸æ˜¯<code>List&lt;Type2&gt;</code>çš„å­ç±»å‹ï¼Œä¹Ÿä¸æ˜¯<code>List&lt;Type2&gt;</code>çš„è¶…ç±»å‹ã€‚</p><p>æ³›å‹åªåœ¨ç¼–è¯‘æ—¶å¼ºåŒ–å®ƒä»¬çš„ç±»å‹ä¿¡æ¯ï¼Œå¹¶åœ¨è¿è¡Œæ—¶ä¸¢å¼ƒï¼ˆæˆ–è€…æ“¦é™¤ï¼‰å®ƒä»¬çš„å…ƒç´ ç±»å‹ä¿¡æ¯ã€‚æ“¦é™¤å°±æ˜¯ä½¿æ³›å‹å¯ä»¥ä¸æ²¡æœ‰ä½¿ç”¨æ³›å‹çš„ä»£ç éšæ„è¿›è¡Œäº’ç”¨ã€‚</p><p>ä»æŠ€æœ¯è§’åº¦æ¥è¯´ï¼Œåƒ<code>E</code>ã€<code>List&lt;E&gt;</code>å’Œ<code>List&lt;String&gt;</code>è¿™æ ·çš„ç±»å‹åº”ç§°ä½œä¸å¯å…·ä½“åŒ–ï¼ˆnon-reifiableï¼‰çš„ç±»å‹ã€‚ä¸å¯å…·ä½“åŒ–ç±»å‹æ˜¯æŒ‡å…¶è¿è¡Œæ—¶è¡¨ç¤ºæ³•åŒ…å«çš„ä¿¡æ¯æ¯”å®ƒç¼–è¯‘æ—¶è¡¨ç¤ºæ³•åŒ…å«çš„ä¿¡æ¯æ›´å°‘çš„ç±»å‹ã€‚å”¯ä¸€å¯å…·ä½“åŒ–çš„ï¼ˆreifiableï¼‰å‚æ•°åŒ–ç±»å‹æ˜¯æ— é™åˆ¶é€šé…ç¬¦ç±»å‹ï¼Œå¦‚<code>List&lt;?&gt;</code>å’Œ<code>Map&lt;?,?&gt;</code>ã€‚<strong>åˆ›å»ºæ— é™åˆ¶é€šé…ç±»å‹çš„æ•°ç»„æ˜¯åˆæ³•çš„ï¼›ä¸å¯å…·ä½“åŒ–çš„ç±»å‹çš„æ•°ç»„è½¬æ¢åªèƒ½åœ¨ç‰¹æ®Šæƒ…å†µä¸‹ä½¿ç”¨ã€‚</strong></p><h2 id="TIPs"><a href="#TIPs" class="headerlink" title="TIPs"></a>TIPs</h2><p>å¦‚æœä»¥ä¸Šéƒ½çœ‹å®Œäº†ï¼Œå¯ä»¥è®¿é—®<a href="https://docs.oracle.com/javase/tutorial/java/generics/QandE/generics-questions.html" target="_blank" rel="noopener">Questions</a>è¯•è¯•è‡ªå·±æ˜¯å¦çœŸçš„æ‡‚äº†ã€‚</p><h2 id="å¼•ç”¨"><a href="#å¼•ç”¨" class="headerlink" title="å¼•ç”¨"></a>å¼•ç”¨</h2><p><a href="https://book.douban.com/subject/3246499/" target="_blank" rel="noopener">ç–¯ç‹‚Javaè®²ä¹‰</a><br><a href="https://book.douban.com/subject/3360807/" target="_blank" rel="noopener">Effective Java</a><br><a href="https://docs.oracle.com/javase/tutorial/java/generics/" target="_blank" rel="noopener">Java Document Generic</a><br><a href="http://www.jiangjun.name/thinking-in-java/chapter15" target="_blank" rel="noopener">ç¬¬åäº”ç«  æ³›å‹</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;1-æ¦‚å¿µ&quot;&gt;&lt;a href=&quot;#1-æ¦‚å¿µ&quot; class=&quot;headerlink&quot; title=&quot;1. æ¦‚å¿µ&quot;&gt;&lt;/a&gt;1. æ¦‚å¿µ&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;å…¶ä»–å‚æ•°æœ¯è¯­ï¼š&lt;/strong&gt;&lt;br&gt;å‚æ•°åŒ–çš„ç±»å‹(parameterize
      
    
    </summary>
    
    
      <category term="Java" scheme="https://zhongyp.me/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>Effective Java</title>
    <link href="https://zhongyp.me/java/2019-05-02-effective-java/"/>
    <id>https://zhongyp.me/java/2019-05-02-effective-java/</id>
    <published>2019-05-01T16:00:00.000Z</published>
    <updated>2019-06-26T02:44:53.168Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>æ‘˜è‡ªã€ŠEffective Javaã€‹</p></blockquote><h1 id="Effective-Java"><a href="#Effective-Java" class="headerlink" title="Effective Java"></a>Effective Java</h1><h2 id="ä¸€ã€åˆ›å»ºå’Œé”€æ¯å¯¹è±¡"><a href="#ä¸€ã€åˆ›å»ºå’Œé”€æ¯å¯¹è±¡" class="headerlink" title="ä¸€ã€åˆ›å»ºå’Œé”€æ¯å¯¹è±¡"></a>ä¸€ã€åˆ›å»ºå’Œé”€æ¯å¯¹è±¡</h2><h3 id="1-è€ƒè™‘ä½¿ç”¨é™æ€å·¥å‚æ–¹æ³•æ›¿ä»£æ„é€ å™¨"><a href="#1-è€ƒè™‘ä½¿ç”¨é™æ€å·¥å‚æ–¹æ³•æ›¿ä»£æ„é€ å™¨" class="headerlink" title="1.è€ƒè™‘ä½¿ç”¨é™æ€å·¥å‚æ–¹æ³•æ›¿ä»£æ„é€ å™¨"></a>1.è€ƒè™‘ä½¿ç”¨é™æ€å·¥å‚æ–¹æ³•æ›¿ä»£æ„é€ å™¨</h3><ul><li>é™æ€å·¥å‚æ–¹æ³•ä¸æ„é€ å™¨ä¸åŒçš„ç¬¬ä¸€å¤§ä¼˜åŠ¿åœ¨äºï¼Œå®ƒä»¬æœ‰åç§°ï¼Œä¸å¿…å’Œç±»åç›¸åŒã€‚</li><li>é™æ€å·¥å‚æ–¹æ³•ä¸æ„é€ å™¨ä¸åŒçš„ç¬¬äºŒå¤§ä¼˜åŠ¿åœ¨äºä¸å¿…åœ¨æ¯æ¬¡è°ƒç”¨ä»–ä»¬çš„æ—¶å€™éƒ½åˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡ã€‚</li><li>é™æ€å·¥å‚æ–¹æ³•ä¸æ„é€ å™¨ä¸åŒçš„ç¬¬ä¸‰å¤§ä¼˜åŠ¿åœ¨äºä»–ä»¬å¯ä»¥è¿”å›åŸç±»å‹çš„ä»»ä½•å­ç±»å‹å¯¹è±¡ã€‚</li><li>é™æ€å·¥å‚æ–¹æ³•çš„ç¬¬å››å¤§ä¼˜åŠ¿åœ¨äºï¼Œåœ¨åˆ›å»ºå‚æ•°åŒ–ç±»å‹å®ä¾‹çš„æ—¶å€™ï¼Œå®ƒä»¬æ˜¯ä»£ç å˜å¾—æ›´åŠ ç®€æ´ã€‚</li><li>é™æ€å·¥å‚æ–¹æ³•çš„ä¸»è¦ç¼ºç‚¹åœ¨äºç±»å¦‚æœä¸å«å…¬æœ‰çš„æ´»ç€å—ä¿æŠ¤çš„æ„é€ å™¨ï¼Œå°±ä¸èƒ½è¢«å­ç±»åŒ–ã€‚</li><li>é™æ€å·¥å‚æ–¹æ³•ç¬¬äºŒä¸ªç¼ºç‚¹åœ¨äºå®ƒä»¬ä¸å…¶ä»–çš„é™æ€æ–¹æ³•å®é™…ä¸Šæ²¡æœ‰ä»»ä½•åŒºåˆ«ã€‚</li></ul><h3 id="2-é‡åˆ°å¤šä¸ªæ„é€ å™¨å‚æ•°æ—¶è¦è€ƒè™‘ç”¨æ„å»ºå™¨"><a href="#2-é‡åˆ°å¤šä¸ªæ„é€ å™¨å‚æ•°æ—¶è¦è€ƒè™‘ç”¨æ„å»ºå™¨" class="headerlink" title="2.é‡åˆ°å¤šä¸ªæ„é€ å™¨å‚æ•°æ—¶è¦è€ƒè™‘ç”¨æ„å»ºå™¨"></a>2.é‡åˆ°å¤šä¸ªæ„é€ å™¨å‚æ•°æ—¶è¦è€ƒè™‘ç”¨æ„å»ºå™¨</h3><h3 id="3-ç”¨ç§æœ‰æ„é€ å™¨æˆ–ç€æšä¸¾ç±»å¼ºåŒ–Singletonå±æ€§"><a href="#3-ç”¨ç§æœ‰æ„é€ å™¨æˆ–ç€æšä¸¾ç±»å¼ºåŒ–Singletonå±æ€§" class="headerlink" title="3.ç”¨ç§æœ‰æ„é€ å™¨æˆ–ç€æšä¸¾ç±»å¼ºåŒ–Singletonå±æ€§"></a>3.ç”¨ç§æœ‰æ„é€ å™¨æˆ–ç€æšä¸¾ç±»å¼ºåŒ–Singletonå±æ€§</h3><h3 id="4-é€šè¿‡ç§æœ‰æ„é€ å™¨å¼ºåŒ–ä¸å¯å®ä¾‹åŒ–çš„èƒ½åŠ›"><a href="#4-é€šè¿‡ç§æœ‰æ„é€ å™¨å¼ºåŒ–ä¸å¯å®ä¾‹åŒ–çš„èƒ½åŠ›" class="headerlink" title="4.é€šè¿‡ç§æœ‰æ„é€ å™¨å¼ºåŒ–ä¸å¯å®ä¾‹åŒ–çš„èƒ½åŠ›"></a>4.é€šè¿‡ç§æœ‰æ„é€ å™¨å¼ºåŒ–ä¸å¯å®ä¾‹åŒ–çš„èƒ½åŠ›</h3><h3 id="5-é¿å…åˆ›å»ºä¸å¿…è¦çš„å¯¹è±¡"><a href="#5-é¿å…åˆ›å»ºä¸å¿…è¦çš„å¯¹è±¡" class="headerlink" title="5.é¿å…åˆ›å»ºä¸å¿…è¦çš„å¯¹è±¡"></a>5.é¿å…åˆ›å»ºä¸å¿…è¦çš„å¯¹è±¡</h3><h3 id="6-æ¶ˆé™¤è¿‡æœŸçš„å¯¹è±¡å¼•ç”¨"><a href="#6-æ¶ˆé™¤è¿‡æœŸçš„å¯¹è±¡å¼•ç”¨" class="headerlink" title="6.æ¶ˆé™¤è¿‡æœŸçš„å¯¹è±¡å¼•ç”¨"></a>6.æ¶ˆé™¤è¿‡æœŸçš„å¯¹è±¡å¼•ç”¨</h3><ul><li>åªè¦ç±»æ˜¯è‡ªå·±ç®¡ç†å†…å­˜ï¼Œç¨‹åºå‘˜å°±åº”è¯¥è­¦æƒ•å†…å­˜æ³„éœ²é—®é¢˜ã€‚</li><li>å†…å­˜æ³„æ¼çš„å¦ä¸€ä¸ªå¸¸è§æ¥æºæ˜¯ç¼“å­˜ã€‚</li><li>å†…å­˜çš„ç¬¬ä¸‰ä¸ªå¸¸è§æ¥æºæ˜¯ç›‘å¬å™¨å’Œå…¶ä»–å›è°ƒã€‚ç¡®ä¿å›è°ƒç«‹å³è¢«å½“ä½œåƒåœ¾å›æ”¶çš„æœ€ä½³æ–¹æ³•æ˜¯åªä¿å­˜å®ƒä»¬çš„å¼±å¼•ç”¨ã€‚</li></ul><h3 id="7-é¿å…ä½¿ç”¨ç»ˆç»“æ–¹æ³•"><a href="#7-é¿å…ä½¿ç”¨ç»ˆç»“æ–¹æ³•" class="headerlink" title="7.é¿å…ä½¿ç”¨ç»ˆç»“æ–¹æ³•"></a>7.é¿å…ä½¿ç”¨ç»ˆç»“æ–¹æ³•</h3><ul><li>ç»ˆç»“æ–¹æ³•ï¼ˆfinalizerï¼‰é€šå¸¸æ˜¯ä¸å¯é¢„æµ‹çš„ï¼Œä¹Ÿæ˜¯å±é™©çš„ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æ˜¯ä¸å¿…è¦çš„ã€‚</li><li>ä½¿ç”¨ç»ˆç»“æ–¹æ³•æœ‰éå¸¸ä¸¥é‡çš„ï¼ˆSevereï¼‰æ€§èƒ½æŸå¤±ã€‚</li></ul><h2 id="äºŒã€å¯¹äºæ‰€æœ‰å¯¹è±¡éƒ½é€šç”¨çš„æ–¹æ³•"><a href="#äºŒã€å¯¹äºæ‰€æœ‰å¯¹è±¡éƒ½é€šç”¨çš„æ–¹æ³•" class="headerlink" title="äºŒã€å¯¹äºæ‰€æœ‰å¯¹è±¡éƒ½é€šç”¨çš„æ–¹æ³•"></a>äºŒã€å¯¹äºæ‰€æœ‰å¯¹è±¡éƒ½é€šç”¨çš„æ–¹æ³•</h2><h3 id="8-è¦†ç›–equalsæ—¶è¯·éµå®ˆé€šç”¨çº¦å®š"><a href="#8-è¦†ç›–equalsæ—¶è¯·éµå®ˆé€šç”¨çº¦å®š" class="headerlink" title="8.è¦†ç›–equalsæ—¶è¯·éµå®ˆé€šç”¨çº¦å®š"></a>8.è¦†ç›–equalsæ—¶è¯·éµå®ˆé€šç”¨çº¦å®š</h3><ul><li>ç±»çš„æ¯ä¸ªå®ä¾‹æœ¬è´¨éƒ½æ˜¯å”¯ä¸€çš„ã€‚</li><li>ä¸å…³å¿ƒç±»æ˜¯å¦æä¾›äº†â€œé€»è¾‘ç›¸ç­‰ï¼ˆlogical equalityï¼‰â€œçš„æµ‹è¯•åŠŸèƒ½ã€‚</li><li>è¶…ç±»å·²ç»è¦†ç›–äº†equalsï¼Œä»è¶…ç±»ç»§æ‰¿è¿‡æ¥çš„è¡Œä¸ºå¯¹äºå­ç±»ä¹Ÿæ˜¯åˆé€‚çš„ã€‚</li><li>ç±»æ˜¯ç§æœ‰çš„æˆ–æ˜¯åŒ…çº§ç§æœ‰çš„ï¼Œå¯ä»¥ç¡®å®šå®ƒçš„equalsæ–¹æ³•æ°¸è¿œä¸ä¼šè¢«è°ƒç”¨ã€‚</li><li>åœ¨è¦†ç›–equalsæ–¹æ³•æ—¶ï¼Œå¿…é¡»éµå®ˆï¼š<strong>è‡ªåæ€§ï¼ˆreflexiveï¼‰ã€å¯¹ç§°æ€§ï¼ˆsymmetricï¼‰ã€ä¼ é€’æ€§ï¼ˆtransitiveï¼‰ã€ä¸€è‡´æ€§ï¼ˆconsistentï¼‰å’Œå¯¹äºä»»ä½•énullçš„å¼•ç”¨ï¼Œequals(null)å¿…é¡»è¿”å›false</strong>ã€‚</li></ul><blockquote><p>é‡Œæ°æ›¿æ¢åŸåˆ™ï¼ˆLiskov substitution principleï¼‰è®¤ä¸ºï¼Œä¸€ä¸ªç±»å‹çš„ä»»ä½•é‡è¦å±æ€§ä¹Ÿå°†é€‚ç”¨å®ƒçš„å­ç±»å‹ï¼Œå› æ­¤ä¸ºè¯¥ç±»å‹ç¼–å†™çš„ä»»ä½•æ–¹æ³•ï¼Œåœ¨å®ƒçš„å­ç±»å‹ä¸Šä¹Ÿåº”è¯¥åŒæ ·è¿è¡Œçš„å¾ˆå¥½ã€‚</p></blockquote><ul><li>è¦†ç›–equalsæ—¶æ€»è¦è¦†ç›–hashCodeã€‚</li><li>ä¸è¦ä¼å›¾è®©equalsæ–¹æ³•è¿‡äºæ™ºèƒ½ã€‚</li><li>ä¸è¦å°†equalså£°æ˜ä¸­çš„Objectå¯¹è±¡æ›¿æ¢ä¸ºå…¶ä»–çš„ç±»å‹ã€‚</li></ul><h3 id="9-è¦†ç›–equalsæ€»è¦è¦†ç›–hashCode"><a href="#9-è¦†ç›–equalsæ€»è¦è¦†ç›–hashCode" class="headerlink" title="9.è¦†ç›–equalsæ€»è¦è¦†ç›–hashCode"></a>9.è¦†ç›–equalsæ€»è¦è¦†ç›–hashCode</h3><ul><li>åœ¨åº”ç”¨ç¨‹åºçš„æ‰§è¡ŒæœŸé—´ï¼Œåªè¦å¯¹è±¡çš„equalsæ–¹æ³•æ¯”è¾ƒæ“ä½œæ‰€ç”¨åˆ°çš„ä¿¡æ¯æ²¡æœ‰è¢«ä¿®æ”¹ï¼Œé‚£ä¹ˆå¯¹è¿™åŒä¸€ä¸ªå¯¹è±¡è°ƒç”¨å¤šæ¬¡ï¼ŒhashCodeæ–¹æ³•éƒ½å¿…é¡»å§‹ç»ˆå¦‚ä¸€åœ°è¿”å›åŒä¸€ä¸ªæ•´æ•°ã€‚åœ¨åŒä¸€ä¸ªåº”ç”¨ç¨‹åºçš„å¤šæ¬¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæ¯æ¬¡æ‰§è¡Œæ‰€è¿”å›çš„æ•´æ•°å¯ä»¥ä¸ä¸€è‡´ã€‚</li><li>å¦‚æœä¸¤ä¸ªå¯¹è±¡æ ¹æ®equals(Object)æ–¹æ³•æ¯”è¾ƒæ˜¯ç›¸ç­‰çš„ï¼Œé‚£ä¹ˆè°ƒç”¨è¿™ä¸¤ä¸ªå¯¹è±¡ä¸­ä»»æ„ä¸€ä¸ªå¯¹è±¡çš„hashCodeæ–¹æ³•éƒ½å¿…é¡»äº§ç”ŸåŒæ ·çš„æ•´æ•°ç»“æœã€‚<strong>ï¼ˆè¿åç¬¬äºŒæ¡ï¼‰</strong></li><li>å¦‚æœä¸¤ä¸ªå¯¹è±¡æ ¹æ®equals(Object)æ–¹æ³•æ¯”è¾ƒæ˜¯ä¸ç›¸ç­‰çš„ï¼Œé‚£ä¹ˆè°ƒç”¨è¿™ä¸¤ä¸ªå¯¹è±¡ä¸­ä»»æ„ä¸€ä¸ªå¯¹è±¡çš„hashCodeæ–¹æ³•ï¼Œåˆ™ä¸ä¸€å®šäº§ç”Ÿä¸åŒçš„æ•´æ•°ç»“æœã€‚ä½†æ˜¯ç¨‹åºçŒ¿åº”è¯¥çŸ¥é“ï¼Œç»™ä¸ç›¸ç­‰çš„å¯¹è±¡äº§ç”Ÿæˆªç„¶ä¸åŒçš„æ•´æ•°ç»“æœï¼Œæœ‰å¯èƒ½æé«˜æ•£åˆ—ï¼ˆhash tableï¼‰çš„æ€§èƒ½ã€‚</li></ul><h3 id="10-å§‹ç»ˆè¦è¦†ç›–toString"><a href="#10-å§‹ç»ˆè¦è¦†ç›–toString" class="headerlink" title="10.å§‹ç»ˆè¦è¦†ç›–toString()"></a>10.å§‹ç»ˆè¦è¦†ç›–toString()</h3><h3 id="11-è°¨æ…è¦†ç›–clone"><a href="#11-è°¨æ…è¦†ç›–clone" class="headerlink" title="11.è°¨æ…è¦†ç›–clone()"></a>11.è°¨æ…è¦†ç›–clone()</h3><ul><li>å¦‚æœä¸“é—¨ä¸ºäº†ç»§æ‰¿è€Œè®¾è®¡çš„ç±»ï¼Œè¦†ç›–äº†cloneæ–¹æ³•ï¼Œè¦†ç›–ç‰ˆæœ¬çš„cloneæ–¹æ³•å°±åº”è¯¥æ¨¡æ‹ŸObject.cloneçš„è¡Œä¸ºï¼šä»–åº”è¯¥å£°æ˜ä¸ºprotectedã€æŠ›å‡ºCloneNotSupportedExceptionå¼‚å¸¸ï¼Œå¹¶ä¸”è¯¥ç±»ä¸åº”è¯¥å®ç°Cloneableæ¥å£ã€‚</li><li>å¦‚æœç”¨çº¿ç¨‹å®‰å…¨çš„ç±»å®ç°Cloneableæ¥å£ï¼Œè¦è®°å¾—å®ƒçš„cloneæ–¹æ³•å¿…é¡»å¾—åˆ°åŒæ­¥ã€‚</li><li>ä»»ä½•å®ç°Cloneableæ¥å£çš„ç±»éƒ½åº”è¯¥ç”¨ä¸€ä¸ªå…¬æœ‰çš„æ–¹æ³•è¦†ç›–cloneï¼Œé¦–å…ˆè°ƒç”¨super.cloneï¼Œå†ä¿®æ­£ä»»ä½•éœ€è¦ä¿®æ­£çš„åŸŸã€‚</li><li>å¦ä¸€ç§å®ç°å¯¹è±¡æ‹·è´çš„å¥½æ–¹æ³•æ˜¯æä¾›ä¸€ä¸ªæ‹·è´æ„é€ å™¨(copy constructor)æˆ–è€…æ‹·è´å·¥å‚(copy factory)ã€‚</li></ul><h3 id="12-è€ƒè™‘å®ç°Comparableæ¥å£"><a href="#12-è€ƒè™‘å®ç°Comparableæ¥å£" class="headerlink" title="12.è€ƒè™‘å®ç°Comparableæ¥å£"></a>12.è€ƒè™‘å®ç°Comparableæ¥å£</h3><h2 id="ä¸‰ã€ç±»å’Œæ¥å£"><a href="#ä¸‰ã€ç±»å’Œæ¥å£" class="headerlink" title="ä¸‰ã€ç±»å’Œæ¥å£"></a>ä¸‰ã€ç±»å’Œæ¥å£</h2><h3 id="13-ä½¿ç±»å’Œæˆå‘˜çš„å¯è®¿é—®æ€§æœ€å°åŒ–"><a href="#13-ä½¿ç±»å’Œæˆå‘˜çš„å¯è®¿é—®æ€§æœ€å°åŒ–" class="headerlink" title="13.ä½¿ç±»å’Œæˆå‘˜çš„å¯è®¿é—®æ€§æœ€å°åŒ–"></a>13.ä½¿ç±»å’Œæˆå‘˜çš„å¯è®¿é—®æ€§æœ€å°åŒ–</h3><ul><li>å°½å¯èƒ½çš„ä½¿æ¯ä¸ªç±»æˆ–è€…æˆå‘˜ä¸è¢«å¤–ç•Œè®¿é—®ã€‚</li><li>å®ä¾‹åŸŸç»ä¸èƒ½ä½¿å…¬æœ‰çš„ã€‚</li><li>ç±»å…·æœ‰å…±æœ‰çš„é™æ€finalæ•°ç»„åŸŸï¼Œæˆ–è€…è¿”å›è¿™ç§åŸŸçš„è®¿é—®æ–¹æ³•ï¼Œè¿™ç§å‡ ä¹æ€»æ˜¯é”™è¯¯çš„ã€‚</li><li>å…¬æœ‰ç±»éƒ½ä¸åº”è¯¥åŒ…å«å…¬æœ‰åŸŸï¼Œé™¤äº†å…¬æœ‰é™æ€finalåŸŸçš„ç‰¹æ®Šæƒ…å½¢å¤–ã€‚</li><li>ç¡®ä¿å…¬æœ‰é™æ€finalåŸŸæ‰€å¼•ç”¨çš„å¯¹è±¡éƒ½æ˜¯ä¸å¯å˜çš„ã€‚</li></ul><h3 id="14-åœ¨å…¬æœ‰ç±»ä¸­ä½¿ç”¨è®¿é—®æ–¹æ³•è€Œéå…¬æœ‰åŸŸ"><a href="#14-åœ¨å…¬æœ‰ç±»ä¸­ä½¿ç”¨è®¿é—®æ–¹æ³•è€Œéå…¬æœ‰åŸŸ" class="headerlink" title="14.åœ¨å…¬æœ‰ç±»ä¸­ä½¿ç”¨è®¿é—®æ–¹æ³•è€Œéå…¬æœ‰åŸŸ"></a>14.åœ¨å…¬æœ‰ç±»ä¸­ä½¿ç”¨è®¿é—®æ–¹æ³•è€Œéå…¬æœ‰åŸŸ</h3><ul><li>å¦‚æœç±»å¯ä»¥åœ¨å®ƒæ‰€åœ¨çš„åŒ…çš„å¤–éƒ¨è¿›è¡Œè®¿é—®ï¼Œå°±æä¾›è®¿é—®æ–¹æ³•ã€‚</li><li>å¦‚æœç±»æ˜¯åŒ…çº§ç§æœ‰çš„ï¼Œæˆ–è€…ç§æœ‰çš„åµŒå¥—ç±»ï¼Œç›´æ¥æš´éœ²å®ƒçš„æ•°æ®åŸŸå¹¶æ²¡æœ‰æœ¬è´¨çš„é”™è¯¯ã€‚</li></ul><h3 id="15-ä½¿å¯å˜æ€§æœ€å°åŒ–"><a href="#15-ä½¿å¯å˜æ€§æœ€å°åŒ–" class="headerlink" title="15.ä½¿å¯å˜æ€§æœ€å°åŒ–"></a>15.ä½¿å¯å˜æ€§æœ€å°åŒ–</h3><p>ä¸å¯å˜ç±»åªæ˜¯å®ä¾‹ä¸èƒ½è¢«ä¿®æ”¹çš„ç±»ã€‚æ¯ä¸ªå®ä¾‹ä¸­åŒ…å«çš„ä¿¡æ¯éƒ½å¿…é¡»åœ¨åˆ›å»ºè¯¥å®ä¾‹çš„æ—¶å€™æä¾›ï¼Œå¹¶åœ¨å¯¹è±¡çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸå›ºå®šä¸å˜ã€‚</p><ul><li>ä¸è¦æä¾›ä»»ä½•ä¼šä¿®æ”¹å¯¹è±¡çŠ¶æ€çš„æ–¹æ³•ã€‚</li><li>ä¿è¯ç±»ä¸è¢«æ‰©å±•ã€‚</li><li>ä½¿æ‰€æœ‰çš„åŸŸéƒ½æ˜¯finalçš„ã€‚</li><li>ä½¿æ‰€æœ‰çš„åŸŸéƒ½æˆä¸ºç§æœ‰çš„ã€‚</li><li>ç¡®ä¿å¯¹äºä»»ä½•å¯å˜ç»„ä»¶çš„äº’æ–¥è®¿é—®ã€‚</li></ul><h3 id="16-å¤åˆä¼˜å…ˆäºç»§æ‰¿"><a href="#16-å¤åˆä¼˜å…ˆäºç»§æ‰¿" class="headerlink" title="16.å¤åˆä¼˜å…ˆäºç»§æ‰¿"></a>16.å¤åˆä¼˜å…ˆäºç»§æ‰¿</h3><ul><li>ä¸æ–¹æ³•è°ƒç”¨ä¸åŒçš„æ˜¯ï¼Œç»§æ‰¿æ‰“ç ´äº†å°è£…æ€§ã€‚</li></ul><h3 id="17-è¦ä¹ˆä¸ºç»§æ‰¿è€Œè®¾è®¡ï¼Œå¹¶æä¾›æ–‡æ¡£è¯´æ˜ï¼Œè¦ä¹ˆå°±ç¦æ­¢ç»§æ‰¿ã€‚"><a href="#17-è¦ä¹ˆä¸ºç»§æ‰¿è€Œè®¾è®¡ï¼Œå¹¶æä¾›æ–‡æ¡£è¯´æ˜ï¼Œè¦ä¹ˆå°±ç¦æ­¢ç»§æ‰¿ã€‚" class="headerlink" title="17.è¦ä¹ˆä¸ºç»§æ‰¿è€Œè®¾è®¡ï¼Œå¹¶æä¾›æ–‡æ¡£è¯´æ˜ï¼Œè¦ä¹ˆå°±ç¦æ­¢ç»§æ‰¿ã€‚"></a>17.è¦ä¹ˆä¸ºç»§æ‰¿è€Œè®¾è®¡ï¼Œå¹¶æä¾›æ–‡æ¡£è¯´æ˜ï¼Œè¦ä¹ˆå°±ç¦æ­¢ç»§æ‰¿ã€‚</h3><ul><li>æ„é€ å™¨ç»ä¸èƒ½è°ƒç”¨å¯è¢«è¦†ç›–çš„æ–¹æ³•ã€‚</li><li>æ— è®ºæ˜¯cloneè¿˜æ˜¯readObjectï¼Œéƒ½ä¸å¯ä»¥è°ƒç”¨å¯è¦†ç›–çš„æ–¹æ³•ï¼Œä¸ç®¡æ˜¯ä»¥ç›´æ¥è¿˜æ˜¯é—´æ¥çš„æ–¹å¼ã€‚</li></ul><h3 id="18-æ¥å£ä¼˜äºæŠ½è±¡ç±»"><a href="#18-æ¥å£ä¼˜äºæŠ½è±¡ç±»" class="headerlink" title="18.æ¥å£ä¼˜äºæŠ½è±¡ç±»"></a>18.æ¥å£ä¼˜äºæŠ½è±¡ç±»</h3><ul><li>ç°æœ‰çš„ç±»å¯ä»¥å¾ˆå®¹æ˜“è¢«æ›´æ–°ï¼Œä»¥å®ç°æ–°çš„æ¥å£ã€‚</li><li>æ¥å£æ˜¯å®šä¹‰mixin(æ··åˆç±»å‹)çš„ç†æƒ³é€‰æ‹©ã€‚</li><li>æ¥å£å…è®¸æ„é€ éå±‚æ¬¡ç»“æ„çš„ç±»å‹æ¡†æ¶ã€‚</li><li>æ¥å£ä½¿å¾—å®‰å…¨çš„å¢å¼ºç±»çš„åŠŸèƒ½æˆä¸ºå¯èƒ½ã€‚</li><li>é€šè¿‡å¯¹ä½ å¯¼å‡ºçš„æ¯ä¸ªé‡è¦æ¥å£éƒ½æä¾›ä¸€ä¸ªæŠ½è±¡çš„éª¨æ¶å®ç°ç±»ï¼ŒæŠŠæ¥å£å’ŒæŠ½è±¡ç±»çš„ä¼˜ç‚¹ç»“åˆèµ·æ¥ã€‚</li></ul><h3 id="19-æ¥å£åªç”¨äºå®šä¹‰ç±»å‹"><a href="#19-æ¥å£åªç”¨äºå®šä¹‰ç±»å‹" class="headerlink" title="19.æ¥å£åªç”¨äºå®šä¹‰ç±»å‹"></a>19.æ¥å£åªç”¨äºå®šä¹‰ç±»å‹</h3><ul><li>å¸¸é‡æ¥å£æ¨¡å¼æ˜¯å¯¹æ¥å£çš„ä¸è‰¯ä½¿ç”¨ã€‚</li></ul><h3 id="20-ç±»å±‚çº§ä¼˜äºæ ‡ç­¾ç±»"><a href="#20-ç±»å±‚çº§ä¼˜äºæ ‡ç­¾ç±»" class="headerlink" title="20.ç±»å±‚çº§ä¼˜äºæ ‡ç­¾ç±»"></a>20.ç±»å±‚çº§ä¼˜äºæ ‡ç­¾ç±»</h3><h3 id="21-ç”¨å‡½æ•°å¯¹è±¡è¡¨ç¤ºç­–ç•¥"><a href="#21-ç”¨å‡½æ•°å¯¹è±¡è¡¨ç¤ºç­–ç•¥" class="headerlink" title="21.ç”¨å‡½æ•°å¯¹è±¡è¡¨ç¤ºç­–ç•¥"></a>21.ç”¨å‡½æ•°å¯¹è±¡è¡¨ç¤ºç­–ç•¥</h3><p>ç­–ç•¥æ¨¡å¼</p><h3 id="22-ä¼˜å…ˆè€ƒè™‘é™æ€æˆå‘˜ç±»"><a href="#22-ä¼˜å…ˆè€ƒè™‘é™æ€æˆå‘˜ç±»" class="headerlink" title="22.ä¼˜å…ˆè€ƒè™‘é™æ€æˆå‘˜ç±»"></a>22.ä¼˜å…ˆè€ƒè™‘é™æ€æˆå‘˜ç±»</h3><p>é™æ€ç±»æˆå‘˜ï¼šMapä¸­çš„Entry<br>éé™æ€ç±»æˆå‘˜ï¼šIterator<br>åŒ¿åç±»ï¼šæ— æ³•å®ä¾‹åŒ–ï¼Œæ— æ³•å£°æ˜å®ç°æ¥å£ï¼Œæ‰©å±•ç±»ï¼Œæ— æ³•è°ƒç”¨ä»»ä½•æˆå‘˜é™¤äº†ä»å®ƒçš„è¶…ç±»ç»§æ‰¿çš„ï¼Œå¿…é¡»ç®€æ´ï¼Œå¸¸ç”¨æ¥ä½œä¸ºå‡½æ•°å¯¹è±¡ï¼Œå³å‡½æ•°è¡¨è¾¾å¼ï¼›å¦ä¸€ç§æ˜¯åˆ›å»ºè¿‡ç¨‹å¯¹è±¡ï¼ˆRunableï¼‰<br>å±€éƒ¨ç±»ï¼šå£°æ˜å±€éƒ¨å˜é‡çš„åœ°æ–¹éƒ½å¯ä»¥å£°æ˜å±€éƒ¨ç±»ã€‚</p><p>å¦‚æœå£°æ˜æˆå‘˜ç±»ä¸è¦æ±‚è®¿é—®å¤–å›´å®ä¾‹ï¼Œå°±è¦å§‹ç»ˆæŠŠstaticä¿®é¥°ç¬¦æ”¾åœ¨å®ƒçš„å£°æ˜ä¸­ã€‚</p><h2 id="å››ã€æ³›å‹"><a href="#å››ã€æ³›å‹" class="headerlink" title="å››ã€æ³›å‹"></a>å››ã€æ³›å‹</h2><h3 id="23-è¯·ä¸è¦åœ¨æ–°ä»£ç ä¸­ä½¿ç”¨åŸç”Ÿæ€ç±»å‹"><a href="#23-è¯·ä¸è¦åœ¨æ–°ä»£ç ä¸­ä½¿ç”¨åŸç”Ÿæ€ç±»å‹" class="headerlink" title="23.è¯·ä¸è¦åœ¨æ–°ä»£ç ä¸­ä½¿ç”¨åŸç”Ÿæ€ç±»å‹"></a>23.è¯·ä¸è¦åœ¨æ–°ä»£ç ä¸­ä½¿ç”¨åŸç”Ÿæ€ç±»å‹</h3><ul><li>å¦‚æœä½¿ç”¨åŸç”Ÿæ€ç±»å‹ï¼Œå°±å¤±æ‰äº†æ³›å‹åœ¨å®‰å…¨æ€§å’Œè¡¨è¿°æ€§æ–¹é¢çš„æ‰€æœ‰ä¼˜åŠ¿ã€‚</li><li>æ³›å‹æœ‰å­ç±»åŒ–çš„è§„åˆ™ï¼Œè™½ç„¶å¯ä»¥å°†List<string>ä¼ é€’ç»™Listçš„å‚æ•°ï¼Œä½†æ˜¯ä¸èƒ½å°†å®ƒä¼ ç»™ç±»å‹List<object>çš„å‚æ•°ã€‚</object></string></li><li>å¦‚æœä½¿ç”¨åƒListè¿™æ ·çš„åŸç”Ÿæ€ç±»å‹ï¼Œå°±ä¼šå¤±æ‰ç±»å‹å®‰å…¨æ€§ï¼Œä½†æ˜¯å¦‚æœä½¿ç”¨åƒList<object>è¿™æ ·çš„å‚æ•°åŒ–ç±»å‹ï¼Œåˆ™ä¸ä¼šã€‚</object></li><li>åœ¨ç±»æ–‡å­—ä¸­å¿…é¡»ä½¿ç”¨åŸç”Ÿæ€ç±»å‹ã€‚</li><li>åœ¨å‚æ•°åŒ–ç±»å‹è€Œéæ— é™åˆ¶é€šé…ç¬¦ç±»å‹ä¸Šä½¿ç”¨instanceofæ“ä½œæ³•æ˜¯éæ³•çš„ã€‚</li></ul><h3 id="24-æ¶ˆé™¤éå—æ£€è­¦å‘Š"><a href="#24-æ¶ˆé™¤éå—æ£€è­¦å‘Š" class="headerlink" title="24.æ¶ˆé™¤éå—æ£€è­¦å‘Š"></a>24.æ¶ˆé™¤éå—æ£€è­¦å‘Š</h3><ul><li>å°½å¯èƒ½æ¶ˆé™¤æ¯ä¸€ä¸ªéå—æ£€è­¦å‘Š</li><li>å¦‚æœæ— æ³•æ¶ˆé™¤è­¦å‘Šï¼ŒåŒæ—¶å¯ä»¥è¯æ˜å¼•èµ·è­¦å‘Šçš„ä»£ç æ˜¯ç±»å‹å®‰å…¨çš„ï¼Œåªæœ‰è¿™ç§æƒ…å†µä¸‹å¯ä»¥ç”¨@SuppressWarnings(â€œuncheckedâ€)æ³¨è§£æ¥ç¦æ­¢è¿™æ¡è­¦å‘Šã€‚</li><li>åº”è¯¥åœ¨å°½å¯èƒ½å°çš„èŒƒå›´å†…ä½¿ç”¨SuppressWarningsæ³¨è§£ã€‚</li><li>æ¯å½“ä½¿ç”¨SuppressWarningsæ³¨è§£ï¼Œéƒ½è¦å¢åŠ æ³¨é‡Šï¼Œè¯´æ˜ä¸ºä»€ä¹ˆè¿™ä¹ˆåšæ˜¯å®‰å…¨çš„ã€‚</li></ul><h3 id="25-åˆ—è¡¨ä¼˜äºæ•°ç»„"><a href="#25-åˆ—è¡¨ä¼˜äºæ•°ç»„" class="headerlink" title="25.åˆ—è¡¨ä¼˜äºæ•°ç»„"></a>25.åˆ—è¡¨ä¼˜äºæ•°ç»„</h3><p>JDK1.5çš„æ³›å‹æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„è®¾è®¡åŸåˆ™ï¼šå¦‚æœä¸€æ®µä»£ç åœ¨ç¼–è¯‘æ—¶ç³»ç»Ÿæ²¡æœ‰äº§ç”Ÿï¼šâ€œ[unchecked]æœªç»æ£€æŸ¥çš„è½¬æ¢â€œè­¦å‘Šï¼Œåˆ™ç¨‹åºåœ¨è¿è¡Œæ—¶ä¸ä¼šå¼•å‘â€ClassCastExceptionâ€œå¼‚å¸¸ã€‚</p><p>æ•°ç»„æ˜¯åå˜çš„ï¼ˆconvariantï¼‰: å¦‚æœSubä¸ºSuperçš„å­ç±»å‹ï¼Œé‚£ä¹ˆæ•°ç»„ç±»å‹Sub[]å°±æ˜¯Super[]çš„å­ç±»å‹ã€‚<br><strong>æ•°ç»„æ˜¯å…·ä½“åŒ–çš„ï¼ˆreifiedï¼‰: æ•°ç»„åœ¨è¿è¡Œæ—¶æ‰çŸ¥é“å¹¶æ£€æŸ¥ä»–ä»¬çš„å…ƒç´ ç±»å‹çº¦æŸã€‚</strong></p><p>æ³›å‹æ—¶ä¸å¯å˜çš„ï¼ˆinvariantï¼‰: å¯¹äºä»»æ„ä¸¤ä¸ªä¸åŒçš„ç±»å‹Type1å’ŒType2ï¼Œ<code>List&lt;Type1&gt;</code>æ—¢ä¸æ˜¯<code>List&lt;Type2&gt;</code>çš„å­ç±»å‹ï¼Œä¹Ÿä¸æ˜¯<code>List&lt;Type2&gt;</code>çš„è¶…ç±»å‹ã€‚</p><p><strong>æ³›å‹åªåœ¨ç¼–è¯‘æ—¶å¼ºåŒ–å®ƒä»¬çš„ç±»å‹ä¿¡æ¯ï¼Œå¹¶åœ¨è¿è¡Œæ—¶ä¸¢å¼ƒï¼ˆæˆ–è€…æ“¦é™¤ï¼‰å®ƒä»¬çš„å…ƒç´ ç±»å‹ä¿¡æ¯ã€‚æ“¦é™¤å°±æ˜¯ä½¿æ³›å‹å¯ä»¥ä¸æ²¡æœ‰ä½¿ç”¨æ³›å‹çš„ä»£ç éšæ„è¿›è¡Œäº’ç”¨ã€‚</strong></p><p>ä»æŠ€æœ¯è§’åº¦æ¥è¯´ï¼Œåƒ<code>E</code>ã€<code>List&lt;E&gt;</code>å’Œ<code>List&lt;String&gt;</code>è¿™æ ·çš„ç±»å‹åº”ç§°ä½œä¸å¯å…·ä½“åŒ–ï¼ˆnon-reifiableï¼‰çš„ç±»å‹ã€‚ä¸å¯å…·ä½“åŒ–ç±»å‹æ˜¯æŒ‡å…¶è¿è¡Œæ—¶è¡¨ç¤ºæ³•åŒ…å«çš„ä¿¡æ¯æ¯”å®ƒç¼–è¯‘æ—¶è¡¨ç¤ºæ³•åŒ…å«çš„ä¿¡æ¯æ›´å°‘çš„ç±»å‹ã€‚å”¯ä¸€å¯å…·ä½“åŒ–çš„ï¼ˆreifiableï¼‰å‚æ•°åŒ–ç±»å‹æ—¶æ— é™åˆ¶é€šé…ç¬¦ç±»å‹ï¼Œå¦‚List&lt;?&gt;å’ŒMap&lt;?,?&gt;ã€‚<strong>åˆ›å»ºæ— é™åˆ¶é€šé…ç±»å‹çš„æ•°ç»„æ˜¯åˆæ³•çš„ï¼›ä¸å¯å…·ä½“åŒ–çš„ç±»å‹çš„æ•°ç»„è½¬æ¢åªèƒ½åœ¨ç‰¹æ®Šæƒ…å†µä¸‹ä½¿ç”¨ã€‚</strong></p><h3 id="26-ä¼˜å…ˆè€ƒè™‘æ³›å‹"><a href="#26-ä¼˜å…ˆè€ƒè™‘æ³›å‹" class="headerlink" title="26.ä¼˜å…ˆè€ƒè™‘æ³›å‹"></a>26.ä¼˜å…ˆè€ƒè™‘æ³›å‹</h3><ul><li>ä¸èƒ½åˆ›å»ºä¸å¯å…·ä½“åŒ–çš„ï¼ˆnon-reifiableï¼‰ç±»å‹çš„æ•°ç»„ã€‚è§£å†³æ–¹æ¡ˆæ˜¯æ–°å»ºObjectæ•°ç»„å¼ºåˆ¶è½¬æ¢ä¸ºä¸å¯å…·ä½“åŒ–ç±»å‹ï¼Œç¡®ä¿æœªå—æ£€çš„è½¬æ¢æ˜¯å®‰å…¨çš„ï¼Œå°±è¦å°½å¯èƒ½å°çš„èŒƒå›´ä¸­ç¦æ­¢è­¦å‘Šã€‚</li></ul><h3 id="27-ä¼˜å…ˆè€ƒè™‘æ³›å‹æ–¹æ³•"><a href="#27-ä¼˜å…ˆè€ƒè™‘æ³›å‹æ–¹æ³•" class="headerlink" title="27.ä¼˜å…ˆè€ƒè™‘æ³›å‹æ–¹æ³•"></a>27.ä¼˜å…ˆè€ƒè™‘æ³›å‹æ–¹æ³•</h3><h3 id="28-åˆ©ç”¨æœ‰é™åˆ¶é€šé…ç¬¦æ¥æå‡APIçš„çµæ´»æ€§"><a href="#28-åˆ©ç”¨æœ‰é™åˆ¶é€šé…ç¬¦æ¥æå‡APIçš„çµæ´»æ€§" class="headerlink" title="28.åˆ©ç”¨æœ‰é™åˆ¶é€šé…ç¬¦æ¥æå‡APIçš„çµæ´»æ€§"></a>28.åˆ©ç”¨æœ‰é™åˆ¶é€šé…ç¬¦æ¥æå‡APIçš„çµæ´»æ€§</h3><ul><li>ä¸ºäº†è·å¾—æœ€å¤§é™åº¦çš„çµæ´»æ€§ï¼Œè¦åœ¨è¡¨ç¤ºç”Ÿäº§è€…æˆ–è€…æ¶ˆè´¹è€…çš„è¾“å…¥å‚æ•°ä¸Šä½¿ç”¨é€šé…ç¬¦ç±»å‹ã€‚</li><li>å¦‚æœç±»å‹å‚æ•°åªåœ¨æ–¹æ³•å£°æ˜ä¸­å‡ºç°ä¸€æ¬¡ï¼Œå°±å¯ä»¥ç”¨é€šé…ç¬¦å–ä»£å®ƒï¼Œå¦‚æœæ˜¯æ— é™åˆ¶çš„ç±»å‹å‚æ•°ï¼Œå°±ç”¨æ— é™åˆ¶çš„é€šé…ç¬¦å–ä»£å®ƒã€‚</li><li>å¦‚æœç±»çš„ç”¨æˆ·å¿…é¡»è€ƒè™‘é€šé…ç¬¦ç±»å‹ï¼Œç±»çš„APIæˆ–è®¸å°±ä¼šå‡ºé”™ã€‚</li><li>ä¸è¦ç”¨é€šé…ç¬¦ç±»å‹ä½œä¸ºè¿”å›ç±»å‹ï¼Œé™¤äº†ä¸ºç”¨æˆ·æä¾›é¢å¤–çš„çµæ´»æ€§ä¹‹å¤–ï¼Œå®ƒè¿˜ä¼šå¼ºåˆ¶ç”¨æˆ·åœ¨å®¢æˆ·ç«¯ä»£ç ä¸­ä½¿ç”¨é€šé…ç¬¦ç±»å‹ã€‚</li></ul><h3 id="29-ä¼˜å…ˆè€ƒè™‘ç±»å‹å®‰å…¨çš„å¼‚æ„å®¹å™¨"><a href="#29-ä¼˜å…ˆè€ƒè™‘ç±»å‹å®‰å…¨çš„å¼‚æ„å®¹å™¨" class="headerlink" title="29.ä¼˜å…ˆè€ƒè™‘ç±»å‹å®‰å…¨çš„å¼‚æ„å®¹å™¨"></a>29.ä¼˜å…ˆè€ƒè™‘ç±»å‹å®‰å…¨çš„å¼‚æ„å®¹å™¨</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public class Favorites&#123;</span><br><span class="line">    public &lt;T&gt; void putFavorite(Class&lt;T&gt; type, T instance);</span><br><span class="line">    public &lt;T&gt; T getFavorite(Class&lt;T&gt; type);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸åƒæ™®é€šçš„mapï¼Œå®ƒçš„<strong>æ‰€æœ‰é”®éƒ½æ˜¯ä¸åŒç±»å‹</strong>çš„ï¼Œå› æ­¤Favoritesç§°ä½œç±»å‹å®‰å…¨çš„å¼‚æ„å®¹å™¨ï¼ˆtypesafe heterogeneous containerï¼‰ã€‚</p><p>é›†åˆAPIè¯´æ˜äº†æ³›å‹çš„ä¸€èˆ¬ç”¨æ³•ï¼Œé™åˆ¶ä½ æ¯ä¸ªå®¹å™¨åªèƒ½æœ‰å›ºå®šæ•°ç›®çš„ç±»å‹å‚æ•°ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡å°†ç±»å‹å‚æ•°æ”¾åœ¨é”®ä¸Šè€Œä¸æ˜¯å®¹å™¨ä¸Šæ¥é¿å¼€è¿™ä¸€é™åˆ¶ã€‚</p><h2 id="äº”ã€æšä¸¾å’Œæ³¨è§£"><a href="#äº”ã€æšä¸¾å’Œæ³¨è§£" class="headerlink" title="äº”ã€æšä¸¾å’Œæ³¨è§£"></a>äº”ã€æšä¸¾å’Œæ³¨è§£</h2><h3 id="30-ç”¨enumä»£æ›¿intå¸¸é‡"><a href="#30-ç”¨enumä»£æ›¿intå¸¸é‡" class="headerlink" title="30.ç”¨enumä»£æ›¿intå¸¸é‡"></a>30.ç”¨enumä»£æ›¿intå¸¸é‡</h3><p>åªæœ‰æå°‘æ•°çš„æšä¸¾å—ç›Šäºå°†å¤šç§è¡Œä¸ºä¸å•ä¸ªæ–¹æ³•å…³è”ã€‚åœ¨è¿™ç§ç›¸å¯¹å°‘è§çš„æƒ…å†µä¸‹ï¼Œç‰¹å®šäºå¸¸é‡çš„æ–¹æ³•è¦ä¼˜å…ˆäºå¯ç”¨è‡ªæœ‰å€¼çš„æšä¸¾ã€‚</p><p>å¦‚æœå¤šä¸ªæšä¸¾å¸¸é‡åŒæ—¶å…±äº«ç›¸åŒçš„è¡Œä¸ºï¼Œåˆ™è€ƒè™‘ç­–ç•¥æšä¸¾ï¼ˆstrategy enumï¼‰ã€‚</p><h3 id="31-ç”¨å®ä¾‹ä»£æ›¿åºæ•°ç´¢å¼•"><a href="#31-ç”¨å®ä¾‹ä»£æ›¿åºæ•°ç´¢å¼•" class="headerlink" title="31.ç”¨å®ä¾‹ä»£æ›¿åºæ•°ç´¢å¼•"></a>31.ç”¨å®ä¾‹ä»£æ›¿åºæ•°ç´¢å¼•</h3><p>æ°¸è¿œä¸è¦æ ¹æ®æšä¸¾çš„åºæ•°å¯¼å‡ºä¸å®ƒå…³è”çš„å€¼ï¼Œè€Œæ˜¯è¦å°†å®ƒä¿å­˜åœ¨ä¸€ä¸ªå®ä¾‹åŸŸä¸­:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public enum Ensemble&#123;</span><br><span class="line">    SOLO(1),DUET(2);</span><br><span class="line">    private final int numberOfMusicians;</span><br><span class="line">    Ensemble(int size)&#123;this.numberOfMusicians = size;&#125;</span><br><span class="line">    public int numberOfMusicians()&#123;return numberOfMusicians;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="32-ç”¨EnumSetä»£æ›¿ä½åŸŸ"><a href="#32-ç”¨EnumSetä»£æ›¿ä½åŸŸ" class="headerlink" title="32.ç”¨EnumSetä»£æ›¿ä½åŸŸ"></a>32.ç”¨EnumSetä»£æ›¿ä½åŸŸ</h3><h3 id="33-ç”¨EnumMapä»£æ›¿åºæ•°ç´¢å¼•"><a href="#33-ç”¨EnumMapä»£æ›¿åºæ•°ç´¢å¼•" class="headerlink" title="33.ç”¨EnumMapä»£æ›¿åºæ•°ç´¢å¼•"></a>33.ç”¨EnumMapä»£æ›¿åºæ•°ç´¢å¼•</h3><h3 id="34-ç”¨æ¥å£æ¨¡æ‹Ÿå¯ä¼¸ç¼©çš„æšä¸¾"><a href="#34-ç”¨æ¥å£æ¨¡æ‹Ÿå¯ä¼¸ç¼©çš„æšä¸¾" class="headerlink" title="34.ç”¨æ¥å£æ¨¡æ‹Ÿå¯ä¼¸ç¼©çš„æšä¸¾"></a>34.ç”¨æ¥å£æ¨¡æ‹Ÿå¯ä¼¸ç¼©çš„æšä¸¾</h3><h3 id="35-æ³¨è§£ä¼˜å…ˆäºå‘½åæ¨¡å¼"><a href="#35-æ³¨è§£ä¼˜å…ˆäºå‘½åæ¨¡å¼" class="headerlink" title="35.æ³¨è§£ä¼˜å…ˆäºå‘½åæ¨¡å¼"></a>35.æ³¨è§£ä¼˜å…ˆäºå‘½åæ¨¡å¼</h3><h3 id="36-åšæŒä½¿ç”¨Overrideæ³¨è§£"><a href="#36-åšæŒä½¿ç”¨Overrideæ³¨è§£" class="headerlink" title="36.åšæŒä½¿ç”¨Overrideæ³¨è§£"></a>36.åšæŒä½¿ç”¨Overrideæ³¨è§£</h3><h3 id="37-ç”¨æ ‡è®°æ¥å£å®šä¹‰ç±»å‹"><a href="#37-ç”¨æ ‡è®°æ¥å£å®šä¹‰ç±»å‹" class="headerlink" title="37.ç”¨æ ‡è®°æ¥å£å®šä¹‰ç±»å‹"></a>37.ç”¨æ ‡è®°æ¥å£å®šä¹‰ç±»å‹</h3><h2 id="å…­ã€æ–¹æ³•"><a href="#å…­ã€æ–¹æ³•" class="headerlink" title="å…­ã€æ–¹æ³•"></a>å…­ã€æ–¹æ³•</h2><h3 id="38-æ£€æŸ¥å‚æ•°çš„æœ‰æ•ˆæ€§"><a href="#38-æ£€æŸ¥å‚æ•°çš„æœ‰æ•ˆæ€§" class="headerlink" title="38.æ£€æŸ¥å‚æ•°çš„æœ‰æ•ˆæ€§"></a>38.æ£€æŸ¥å‚æ•°çš„æœ‰æ•ˆæ€§</h3><p>æ¯å½“ç¼–å†™æ–¹æ³•æˆ–è€…æ„é€ å™¨æ—¶ï¼Œåº”è¯¥è€ƒè™‘å®ƒçš„å‚æ•°æœ‰å“ªäº›é™åˆ¶ã€‚åº”è¯¥æŠŠè¿™äº›é™åˆ¶å†™åˆ°æ–‡æ¡£ä¸­ï¼Œå¹¶ä¸”åœ¨è¿™ä¸ªæ–¹æ³•ä½“çš„å¼€å¤´å¤„ï¼Œé€šè¿‡æ˜¾ç¤ºçš„æ£€æŸ¥æ¥å®æ–½è¿™äº›é™åˆ¶ã€‚<br>éå…¬æœ‰çš„æ–¹æ³•é€šå¸¸åº”è¯¥ä½¿ç”¨æ–­è¨€ï¼ˆassertionï¼‰æ¥æ£€æŸ¥å®ƒä»¬çš„å‚æ•°ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">private static void sort(long a[], int offset, int length)&#123;</span><br><span class="line">    assert a != null;</span><br><span class="line">    assert offset &gt;= 0 &amp;&amp; offset &lt;= a.length;</span><br><span class="line">    assert length &gt;= 0 &amp;&amp; length &lt;= a.length - offset;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="39-å¿…è¦æ—¶è¿›è¡Œä¿æŠ¤æ€§æ‹·è´"><a href="#39-å¿…è¦æ—¶è¿›è¡Œä¿æŠ¤æ€§æ‹·è´" class="headerlink" title="39.å¿…è¦æ—¶è¿›è¡Œä¿æŠ¤æ€§æ‹·è´"></a>39.å¿…è¦æ—¶è¿›è¡Œä¿æŠ¤æ€§æ‹·è´</h3><p>å¯¹äºæ„é€ å™¨çš„æ¯ä¸ªå¯å˜å‚æ•°è¿›è¡Œä¿æŠ¤æ€§æ‹·è´ï¼ˆdefensive copyï¼‰æ˜¯å¿…è¦çš„ã€‚<br>ä¿æŠ¤æ€§æ‹·è´æ˜¯åœ¨æ£€æŸ¥å‚æ•°çš„æœ‰æ•ˆæ€§ä¹‹å‰è¿›è¡Œçš„ï¼Œå¹¶ä¸”æœ‰æ•ˆæ€§æ£€æŸ¥æ˜¯é’ˆå¯¹æ‹·è´ä¹‹åçš„å¯¹è±¡ï¼Œè€Œä¸æ˜¯é’ˆå¯¹åŸå§‹çš„å¯¹è±¡ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public Period(Date start, Date end)&#123;</span><br><span class="line">    if(start.compareTo(end) &gt; 0)</span><br><span class="line">        throw new IllegalArgumentException(start + &quot; after &quot; + end);</span><br><span class="line">    this.start = start;</span><br><span class="line">    this.end = end;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ä¸Šé¢ä»£ç ä¸­è™½ç„¶å¢åŠ çº¦æŸæ¡ä»¶ï¼Œä½†æ˜¯Dateåœ¨æ­¤å¯¹è±¡å¤–éƒ¨è¿˜æ˜¯å¯ä»¥è¢«ä¿®æ”¹çš„ï¼Œå› ä¸ºDateæ˜¯å¼•ç”¨ä¼ é€’ï¼Œæ‰€ä»¥ä¸ºé¿å…è¿™ç§é—®é¢˜ï¼Œä½¿ç”¨å¤‡ä»½å¯¹è±¡ï¼Œè€Œä¸æ˜¯ä½¿ç”¨åŸå§‹å¯¹è±¡ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public Period(Date start, Date end)&#123;</span><br><span class="line">    this.start = new Date(start.getTime);</span><br><span class="line">    this.end = new Date(end.getTime);</span><br><span class="line">    if(start.compareTo(end) &gt; 0)</span><br><span class="line">        throw new IllegalArgumentException(start + &quot; after &quot; + end);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å¯¹äºå‚æ•°ç±»å‹å¯ä»¥è¢«ä¸å¯ä¿¡ä»»æ–¹å­ç±»åŒ–çš„å‚æ•°ï¼Œè¯·ä¸è¦ä½¿ç”¨cloneæ–¹æ³•è¿›è¡Œä¿æŠ¤æ€§æ‹·è´ã€‚<br>å¦‚æœç±»ä¸­æä¾›äº†å¯¹å…¶å¯å˜å†…éƒ¨æˆå‘˜çš„è®¿é—®èƒ½åŠ›ï¼Œåˆ™ä½¿å®ƒè¿”å›å¯å˜å†…éƒ¨åŸŸçš„ä¿æŠ¤æ€§æ‹·è´å³å¯ã€‚</p><p>ä¾‹å¦‚ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Date start = new Date();</span><br><span class="line">Date end = new Date();</span><br><span class="line">Period p = new Period(start, end);</span><br><span class="line">p.end().setYear(78);//end()æ–¹æ³•è¿”å›Dateå¯¹è±¡ï¼ŒPeriodä¸­æä¾›setYearæ”¹å˜Dateå±æ€§ã€‚</span><br></pre></td></tr></table></figure><p>ä¸ºäº†ä¿è¯ä¼ å…¥Periodä¸­çš„startæˆ–è€…endä¸è¢«æ”¹å˜ï¼Œåªéœ€è¦ä¿®æ”¹Periodä¸­è·å–startå’Œendçš„è®¿é—®æ–¹æ³•å³å¯ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public Date start()&#123;</span><br><span class="line">    return new Date(start.getTime());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public Date end()&#123;</span><br><span class="line"></span><br><span class="line">    return new Date(end.getTime());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å‚æ•°çš„ä¿æŠ¤æ€§æ‹·è´ä¸ä»…ä»…é’ˆå¯¹ä¸å¯å˜ç±»ã€‚å¦‚æœå®¢æˆ·ç«¯æä¾›çš„å¯¹è±¡æ˜¯å¯å˜çš„ä¸”è¯¥å¯¹è±¡ä¸å…è®¸åœ¨ä½ çš„ç±»å¯¹è±¡ä¸­å˜åŒ–ï¼Œå°±å¿…é¡»å¯¹è¯¥å¯¹è±¡è¿›è¡Œä¿æŠ¤æ€§æ‹·è´ã€‚</p><p>å¦‚æœæ‹·è´æˆæœ¬å—åˆ°é™åˆ¶ï¼Œå¹¶ä¸”ä¿¡ä»»å®ƒçš„å®¢æˆ·ç«¯ä¸ä¼šä¸æ°å½“çš„ä¿®æ”¹ç»„ä»¶ï¼Œå°±å¯ä»¥åœ¨æ–‡æ¡£ä¸­å£°æ˜å®¢æˆ·ç«¯çš„èŒè´£æ˜¯ä¸å¾—ä¿®æ”¹å—åˆ°å½±å“çš„ç»„ä»¶ï¼Œä»¥æ­¤æ¥ä»£æ›¿ä¿æŠ¤æ€§æ‹·è´ã€‚</p><h3 id="40-è°¨æ…è®¾è®¡æ–¹æ³•ç­¾å"><a href="#40-è°¨æ…è®¾è®¡æ–¹æ³•ç­¾å" class="headerlink" title="40.è°¨æ…è®¾è®¡æ–¹æ³•ç­¾å"></a>40.è°¨æ…è®¾è®¡æ–¹æ³•ç­¾å</h3><p>è°¨æ…çš„é€‰æ‹©æ–¹æ³•çš„åç§°ï¼›<br>ä¸è¦è¿‡äºè¿½æ±‚æä¾›ä¾¿åˆ©çš„æ–¹æ³•ã€‚åªæœ‰å½“ä¸€é¡¹æ“ä½œè¢«ç»å¸¸ç”¨åˆ°çš„æ—¶å€™ï¼Œæ‰è€ƒè™‘ä¸ºå®ƒæä¾›å¿«æ·æ–¹å¼ï¼ˆshorthandï¼‰ã€‚å¦‚æœä¸ç¡®å®šè¿˜æ˜¯ä¸æä¾›å¿«æ·ä¸ºå¥½ï¼›<br>é¿å…è¿‡é•¿çš„å‚æ•°åˆ—è¡¨ï¼›</p><h3 id="41-æ…ç”¨é‡è½½"><a href="#41-æ…ç”¨é‡è½½" class="headerlink" title="41.æ…ç”¨é‡è½½"></a>41.æ…ç”¨é‡è½½</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">public class CollectionClassifier&#123;</span><br><span class="line"></span><br><span class="line">    public static String classify(Set&lt;?&gt; s)&#123;</span><br><span class="line">        return &quot;set&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    public static String classify(List&lt;?&gt; s)&#123;</span><br><span class="line">        return &quot;list&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    public static String classify(Collection&lt;?&gt; s)&#123;</span><br><span class="line">        return &quot;unknow&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public static void main(String[] args)&#123;</span><br><span class="line">        Collection&lt;?&gt;[] collections = &#123;</span><br><span class="line">            new HashSet&lt;String&gt;(),</span><br><span class="line">            new ArrayList&lt;BigInteger&gt;(),</span><br><span class="line">            new HashMap&lt;String, String&gt;().value()</span><br><span class="line">        &#125;;</span><br><span class="line">        for(Collection&lt;?&gt; c : collections)</span><br><span class="line">            System.out.println(classify(c)); </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç è¾“å‡ºç»“æœæ˜¯æ‰“å°â€œunknowâ€ä¸‰æ¬¡ã€‚</p><h3 id="42-æ…ç”¨å¯å˜å‚æ•°"><a href="#42-æ…ç”¨å¯å˜å‚æ•°" class="headerlink" title="42.æ…ç”¨å¯å˜å‚æ•°"></a>42.æ…ç”¨å¯å˜å‚æ•°</h3><p>å®šä¹‰å‚æ•°æ•°ç›®ä¸å®šçš„æ–¹æ³•æ—¶ï¼Œå¯å˜å‚æ•°æ–¹æ³•æ˜¯ä¸€ç§å¾ˆæ–¹ä¾¿çš„æ–¹å¼ï¼Œä½†æ˜¯å®ƒä»¬ä¸åº”è¯¥è¢«è¿‡åº¦æ»¥ç”¨ï¼Œä½¿ç”¨ä¸å½“ï¼Œå°†äº§ç”Ÿæ··ä¹±çš„ç»“æœã€‚</p><h3 id="43-è¿”å›é›¶é•¿åº¦çš„æ•°ç»„æˆ–è€…é›†åˆï¼Œè€Œä¸æ˜¯null"><a href="#43-è¿”å›é›¶é•¿åº¦çš„æ•°ç»„æˆ–è€…é›†åˆï¼Œè€Œä¸æ˜¯null" class="headerlink" title="43.è¿”å›é›¶é•¿åº¦çš„æ•°ç»„æˆ–è€…é›†åˆï¼Œè€Œä¸æ˜¯null"></a>43.è¿”å›é›¶é•¿åº¦çš„æ•°ç»„æˆ–è€…é›†åˆï¼Œè€Œä¸æ˜¯null</h3><h3 id="44-ä¸ºæ‰€æœ‰å¯¼å‡ºçš„APIå…ƒç´ ç¼–å†™æ–‡æ¡£æ³¨é‡Š"><a href="#44-ä¸ºæ‰€æœ‰å¯¼å‡ºçš„APIå…ƒç´ ç¼–å†™æ–‡æ¡£æ³¨é‡Š" class="headerlink" title="44.ä¸ºæ‰€æœ‰å¯¼å‡ºçš„APIå…ƒç´ ç¼–å†™æ–‡æ¡£æ³¨é‡Š"></a>44.ä¸ºæ‰€æœ‰å¯¼å‡ºçš„APIå…ƒç´ ç¼–å†™æ–‡æ¡£æ³¨é‡Š</h3><h2 id="ä¸ƒã€é€šç”¨ç¨‹åºè®¾è®¡"><a href="#ä¸ƒã€é€šç”¨ç¨‹åºè®¾è®¡" class="headerlink" title="ä¸ƒã€é€šç”¨ç¨‹åºè®¾è®¡"></a>ä¸ƒã€é€šç”¨ç¨‹åºè®¾è®¡</h2><h3 id="45-å°†å±€éƒ¨å˜é‡çš„ä½œç”¨åŸŸæœ€å°åŒ–"><a href="#45-å°†å±€éƒ¨å˜é‡çš„ä½œç”¨åŸŸæœ€å°åŒ–" class="headerlink" title="45.å°†å±€éƒ¨å˜é‡çš„ä½œç”¨åŸŸæœ€å°åŒ–"></a>45.å°†å±€éƒ¨å˜é‡çš„ä½œç”¨åŸŸæœ€å°åŒ–</h3><p>è¦ä½¿ç”¨å±€éƒ¨å˜é‡çš„ä½œç”¨åŸŸæœ€å°åŒ–ï¼Œæœ€æœ‰åŠ›çš„æ–¹æ³•å°±æ˜¯åœ¨ç¬¬ä¸€æ¬¡ä½¿ç”¨å®ƒçš„åœ°æ–¹å£°æ˜ã€‚<br>å‡ ä¹æ¯ä¸ªå±€éƒ¨å˜é‡çš„å£°æ˜éƒ½åº”è¯¥åŒ…å«ä¸€ä¸ªåˆå§‹åŒ–è¡¨è¾¾å¼ã€‚</p><h3 id="46-for-eachå¾ªç¯ä¼˜å…ˆäºä¼ ç»Ÿçš„forå¾ªç¯"><a href="#46-for-eachå¾ªç¯ä¼˜å…ˆäºä¼ ç»Ÿçš„forå¾ªç¯" class="headerlink" title="46.for-eachå¾ªç¯ä¼˜å…ˆäºä¼ ç»Ÿçš„forå¾ªç¯"></a>46.for-eachå¾ªç¯ä¼˜å…ˆäºä¼ ç»Ÿçš„forå¾ªç¯</h3><p>è™½ç„¶for-eachå¾ªç¯åœ¨ç®€æ´æ€§å’Œé¢„é˜²bugæ–¹é¢æ¯”ä¼ ç»Ÿçš„forå¾ªç¯æœ‰ä¼˜åŠ¿ï¼Œä¸”æ²¡æœ‰æ€§èƒ½æŸå¤±ã€‚ä½†æ˜¯æœ‰ä¸‰ç§å¸¸è§æƒ…å†µæ— æ³•ä½¿ç”¨for-each:</p><ul><li>è¿‡æ»¤ï¼š å¦‚æœéœ€è¦éå†é›†åˆï¼Œå¹¶ä¸”åˆ é™¤é€‰å®šçš„å…ƒç´ ï¼Œå°±éœ€è¦ä½¿ç”¨æ˜¾å¼çš„è¿­ä»£å™¨ã€‚</li><li>è½¬æ¢ï¼š å¦‚æœéœ€è¦éå†åˆ—è¡¨æˆ–è€…æ•°ç»„ï¼Œå¹¶å–ä»£å®ƒéƒ¨åˆ†æˆ–è€…å…¨éƒ¨çš„å…ƒç´ å€¼ï¼Œå°±éœ€è¦åˆ—è¡¨è¿­ä»£å™¨æˆ–è€…æ•°ç»„ç´¢å¼•ã€‚</li><li>å¹³è¡Œè¿­ä»£ï¼š å¦‚æœéœ€è¦å¹¶è¡Œçš„éå†å¤šä¸ªé›†åˆï¼Œå°±éœ€è¦æ˜¾å¼çš„æ§åˆ¶è¿­ä»£å™¨æˆ–è€…ç´¢å¼•å˜é‡ã€‚</li></ul><h3 id="47-äº†è§£å’Œä½¿ç”¨ç±»åº“"><a href="#47-äº†è§£å’Œä½¿ç”¨ç±»åº“" class="headerlink" title="47.äº†è§£å’Œä½¿ç”¨ç±»åº“"></a>47.äº†è§£å’Œä½¿ç”¨ç±»åº“</h3><p>æ¯ä¸ªç¨‹åºå‘˜éƒ½åº”è¯¥ç†Ÿæ‚‰java.langã€java.utilã€java.ioä¸­çš„å†…å®¹ã€‚</p><h3 id="48-å¦‚æœéœ€è¦ç²¾ç¡®çš„ç­”æ¡ˆï¼Œè¯·é¿å…ä½¿ç”¨floatå’Œdouble"><a href="#48-å¦‚æœéœ€è¦ç²¾ç¡®çš„ç­”æ¡ˆï¼Œè¯·é¿å…ä½¿ç”¨floatå’Œdouble" class="headerlink" title="48.å¦‚æœéœ€è¦ç²¾ç¡®çš„ç­”æ¡ˆï¼Œè¯·é¿å…ä½¿ç”¨floatå’Œdouble"></a>48.å¦‚æœéœ€è¦ç²¾ç¡®çš„ç­”æ¡ˆï¼Œè¯·é¿å…ä½¿ç”¨floatå’Œdouble</h3><p>ä½¿ç”¨BigDecimalã€intæˆ–è€…longè¿›è¡Œè®¡ç®—ã€‚å¦‚æœæ•°å€¼é˜²ä¼ªä¸è¶…è¿‡9ä½åè¿›åˆ¶æ•°å­—ï¼Œå°±å¯ä»¥ä½¿ç”¨intï¼›å¦‚æœä¸è¶…è¿‡18ä½å°±å¯ä»¥ä½¿ç”¨longï¼›å¦‚æœæ•°å€¼è¶…è¿‡18ä½å°±å¿…é¡»ä½¿ç”¨BigDecimalã€‚</p><p>BigDecimalç¼ºç‚¹ï¼šä¸æ–¹ä¾¿ï¼Œæ…¢ã€‚</p><h3 id="49-åŸºæœ¬ç±»å‹ä¼˜å…ˆäºè£…ç®±åŸºæœ¬ç±»å‹"><a href="#49-åŸºæœ¬ç±»å‹ä¼˜å…ˆäºè£…ç®±åŸºæœ¬ç±»å‹" class="headerlink" title="49.åŸºæœ¬ç±»å‹ä¼˜å…ˆäºè£…ç®±åŸºæœ¬ç±»å‹"></a>49.åŸºæœ¬ç±»å‹ä¼˜å…ˆäºè£…ç®±åŸºæœ¬ç±»å‹</h3><p>åŸºæœ¬ç±»å‹ä¸è£…ç®±åŸºæœ¬ç±»å‹ä¹‹é—´ä¸»è¦åŒºåˆ«ï¼š</p><ul><li>åŸºæœ¬ç±»å‹åªæœ‰å€¼ï¼Œè€Œè£…ç®±åŸºæœ¬ç±»å‹åˆ™å…·æœ‰ä¸å®ƒä»¬çš„å€¼ä¸åŒçš„åŒä¸€æ€§ã€‚</li><li>åŸºæœ¬ç±»å‹åªæœ‰åŠŸèƒ½å®Œå¤‡çš„å€¼ï¼Œè€Œæ¯ä¸ªè£…ç®±åŸºæœ¬ç±»å‹é™¤äº†å®ƒå¯¹åº”åŸºæœ¬ç±»å‹çš„æ‰€æœ‰åŠŸèƒ½å€¼ä¹‹å¤–ï¼Œè¿˜æœ‰éåŠŸèƒ½å€¼ï¼šnullã€‚</li><li>åŸºæœ¬ç±»å‹é€šå¸¸æ¯”è£…ç®±åŸºæœ¬ç±»å‹æ›´èŠ‚çœç©ºé—´å’Œæ—¶é—´ã€‚</li></ul><p>ç¬¬ä¸€ä¸ªæ˜¯ä½œä¸ºé›†åˆä¸­çš„å…ƒç´ ã€é”®å’Œå€¼ã€‚ä½ ä¸èƒ½å°†åŸºæœ¬ç±»å‹æ”¾åœ¨é›†åˆä¸­ï¼Œå› æ­¤å¿…é¡»ä½¿ç”¨è£…ç®±åŸºæœ¬ç±»å‹ï¼ˆåœ¨ä»£ç ä¸­ä¸ç”¨è‡ªå·±å»è£…ç®±ï¼Œå¦‚æœæŠŠåŸºæœ¬ç±»å‹æ”¾å…¥é›†åˆä¸­ï¼Œé›†åˆä¼šè‡ªåŠ¨æŠŠåŸºæœ¬ç±»å‹è£…ç®±ï¼‰ã€‚ä¸èƒ½æ”¾åœ¨é›†åˆä¸­çš„åŸå› æ˜¯ï¼šåŸºæœ¬ç±»å‹å­˜æ”¾åœ¨æ ˆä¸Šï¼Œé›†åˆä¸­çš„å¼•ç”¨åˆ™å­˜åœ¨å †æˆ–æ–¹æ³•å–ä¸Šã€‚</p><p>åœ¨å‚æ•°åŒ–ç±»å‹ä¸­ï¼Œå¿…é¡»ä½¿ç”¨è£…ç®±åŸºæœ¬ç±»å‹ä½œä¸ºå‚æ•°ï¼ŒJavaä¸å…è®¸ä½¿ç”¨åŸºæœ¬ç±»å‹ï¼Œå› ä¸ºJavaæ³›å‹è¦æ±‚ä½¿ç”¨çš„æ˜¯å¯¹è±¡ç±»å‹ï¼ŒåŸºæœ¬ç±»å‹ä¸æ˜¯å¯¹è±¡ç±»å‹ã€‚</p><h3 id="50-å¦‚æœå…¶ä»–ç±»å‹æ›´é€‚åˆï¼Œåˆ™å°½é‡é¿å…ä½¿ç”¨å­—ç¬¦ä¸²"><a href="#50-å¦‚æœå…¶ä»–ç±»å‹æ›´é€‚åˆï¼Œåˆ™å°½é‡é¿å…ä½¿ç”¨å­—ç¬¦ä¸²" class="headerlink" title="50.å¦‚æœå…¶ä»–ç±»å‹æ›´é€‚åˆï¼Œåˆ™å°½é‡é¿å…ä½¿ç”¨å­—ç¬¦ä¸²"></a>50.å¦‚æœå…¶ä»–ç±»å‹æ›´é€‚åˆï¼Œåˆ™å°½é‡é¿å…ä½¿ç”¨å­—ç¬¦ä¸²</h3><p>å­—ç¬¦ä¸²ä¸é€‚åˆä»£æ›¿å…¶ä»–çš„å€¼ç±»å‹ã€‚<br>å­—ç¬¦ä¸²ä¸é€‚åˆä»£æ›¿æšä¸¾ç±»å‹ã€‚<br>å­—ç¬¦ä¸²ä¸é€‚åˆä»£æ›¿èšé›†ç±»å‹ã€‚<br>å­—ç¬¦ä¸²ä¹Ÿä¸é€‚åˆä»£æ›¿èƒ½åŠ›è¡¨ã€‚</p><h3 id="51-å½“å¿ƒå­—ç¬¦ä¸²è¿æ¥çš„æ€§èƒ½"><a href="#51-å½“å¿ƒå­—ç¬¦ä¸²è¿æ¥çš„æ€§èƒ½" class="headerlink" title="51.å½“å¿ƒå­—ç¬¦ä¸²è¿æ¥çš„æ€§èƒ½"></a>51.å½“å¿ƒå­—ç¬¦ä¸²è¿æ¥çš„æ€§èƒ½</h3><h3 id="52-é€šè¿‡æ¥å£å¼•ç”¨å¯¹è±¡"><a href="#52-é€šè¿‡æ¥å£å¼•ç”¨å¯¹è±¡" class="headerlink" title="52.é€šè¿‡æ¥å£å¼•ç”¨å¯¹è±¡"></a>52.é€šè¿‡æ¥å£å¼•ç”¨å¯¹è±¡</h3><p>å¦‚æœæœ‰é€‚åˆçš„æ¥å£ç±»å‹å­˜åœ¨ï¼Œé‚£ä¹ˆå¯¹äºå‚æ•°ã€è¿”å›å€¼ã€å˜é‡å’ŒåŸŸæ¥è¯´ï¼Œå°±éƒ½åº”è¯¥ä½¿ç”¨æ¥å£ç±»å‹è¿›è¡Œå£°æ˜ã€‚</p><p>å¦‚æœæ²¡æœ‰åˆé€‚çš„æ¥å£å­˜åœ¨ï¼Œå®Œå…¨å¯ä»¥ç”¨ç±»è€Œä¸æ˜¯æ¥å£æ¥å¼•ç”¨å¯¹è±¡ï¼š</p><ul><li>å¦‚æœå…·ä½“ç±»æ²¡æœ‰ç›¸å…³è”çš„æ¥å£ï¼Œä¸ç®¡å®ƒæ˜¯å¦è¡¨ç¤ºä¸€ä¸ªå€¼ï¼Œä½ éƒ½æ²¡æœ‰åˆ«çš„é€‰æ‹©ï¼Œåªæœ‰é€šè¿‡å®ƒçš„ç±»æ¥å¼•ç”¨å®ƒçš„å¯¹è±¡ã€‚</li><li>å¯¹è±¡å±äºä¸€ä¸ªæ¡†æ¶ï¼Œè€Œæ¡†æ¶çš„åŸºæœ¬ç±»å‹æ˜¯ç±»ï¼Œä¸æ˜¯æ¥å£ã€‚å¦‚æœå¯¹è±¡å±äºè¿™ç§åŸºäºç±»çš„æ¡†æ¶ï¼ˆclass-based</li><li>frameworkï¼‰ï¼Œå°±åº”è¯¥ç”¨ç›¸å…³çš„ç§¯ç´¯ï¼ˆbase classï¼‰æ¥å¼•ç”¨è¿™ä¸ªå¯¹è±¡ï¼Œè€Œä¸æ˜¯ç”¨å®ƒçš„å®ç°ç±»ã€‚</li></ul><h3 id="53-æ¥å£ä¼˜å…ˆäºåå°„æœºåˆ¶"><a href="#53-æ¥å£ä¼˜å…ˆäºåå°„æœºåˆ¶" class="headerlink" title="53.æ¥å£ä¼˜å…ˆäºåå°„æœºåˆ¶"></a>53.æ¥å£ä¼˜å…ˆäºåå°„æœºåˆ¶</h3><p>åå°„æœºåˆ¶ï¼š</p><ul><li>ä¸§å¤±äº†ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥çš„å¥½å¤„ï¼ŒåŒ…æ‹¬å¼‚å¸¸æ£€æŸ¥ã€‚å¦‚æœç¨‹åºä¼å›¾ç”¨åå°„æ–¹å¼è°ƒç”¨ä¸å­˜åœ¨çš„æ´»ä¸å¯è®¿é—®çš„æ–¹æ³•ï¼Œåœ¨è¿è¡Œæ—¶å®ƒå°†ä¼šå¤±è´¥ï¼Œé™¤éé‡‡ç”¨äº†ç‰¹åˆ«çš„é¢„é˜²æªæ–½ã€‚</li><li>æ‰§è¡Œåå°„è®¿é—®æ‰€éœ€çš„ä»£ç éå¸¸ç¬¨æ‹™å’Œå†—é•¿ã€‚ç¼–å†™è¿™æ ·çš„ä»£ç éå¸¸ä¹å‘³ï¼Œé˜…è¯»èµ·æ¥ä¹Ÿå¾ˆå›°éš¾ã€‚</li><li>æ€§èƒ½æŸå¤±ã€‚åå°„æ–¹æ³•è°ƒç”¨æ¯”æ™®é€šæ–¹æ³•è°ƒç”¨æ…¢äº†è®¸å¤šã€‚</li></ul><p>é€šå¸¸æ™®é€šåº”ç”¨ç¨‹åºåœ¨è¿è¡Œæ—¶ä¸åº”è¯¥ä»¥åå°„æ–¹å¼è®¿é—®å¯¹è±¡ã€‚<br>å¯¹äºæœ‰äº›ç¨‹åºï¼Œå®ƒä»¬å¿…é¡»ç”¨åˆ°åœ¨ç¼–è¯‘æ—¶æ— æ³•è·å–çš„ç±»ï¼Œä½†æ˜¯åœ¨ç¼–è¯‘æ—¶å­˜åœ¨é€‚å½“çš„æ¥å£æˆ–è€…è¶…ç±»ï¼Œé€šè¿‡å®ƒä»¬å¯ä»¥å¼•ç”¨è¿™ä¸ªç±»ã€‚å¦‚æœæ˜¯è¿™ç§æƒ…å†µï¼Œå°±å¯ä»¥ä»¥åå°„æ–¹å¼åˆ›å»ºå®ä¾‹ï¼Œç„¶åé€šè¿‡å®ƒä»¬çš„æ¥å£æˆ–è€…è¶…ç±»ï¼Œä»¥æ­£å¸¸çš„æ–¹å¼è®¿é—®è¿™äº›å®ä¾‹ã€‚å¦‚æœé€‚å½“çš„æ„é€ å™¨ä¸å¸¦å‚æ•°ï¼Œç”šè‡³æ ¹æœ¬ä¸éœ€è¦ä½¿ç”¨<code>java.lang.reflect</code>ï¼›<code>Class.newInstance</code>æ–¹æ³•å°±å·²ç»æä¾›äº†æ‰€éœ€çš„åŠŸèƒ½ã€‚</p><h3 id="54-è°¨æ…çš„ä½¿ç”¨æœ¬åœ°æ–¹æ³•"><a href="#54-è°¨æ…çš„ä½¿ç”¨æœ¬åœ°æ–¹æ³•" class="headerlink" title="54.è°¨æ…çš„ä½¿ç”¨æœ¬åœ°æ–¹æ³•"></a>54.è°¨æ…çš„ä½¿ç”¨æœ¬åœ°æ–¹æ³•</h3><h3 id="55-è°¨æ…çš„ä¼˜åŒ–"><a href="#55-è°¨æ…çš„ä¼˜åŒ–" class="headerlink" title="55.è°¨æ…çš„ä¼˜åŒ–"></a>55.è°¨æ…çš„ä¼˜åŒ–</h3><blockquote><p>å¾ˆå¤šè®¡ç®—ä¸Šçš„è¿‡å¤±éƒ½è¢«å½’å’äºæ•ˆç‡ï¼ˆæ²¡æœ‰å¿…è¦è¾¾åˆ°çš„æ•ˆç‡ï¼‰ï¼Œè€Œä¸æ˜¯ä»»ä½•å…¶ä»–çš„åŸå› â€”ç”šè‡³åŒ…æ‹¬ç›²ç›®çš„åšå‚»äº‹ã€‚<br>ä¸è¦å–è®¡è¾ƒæ•ˆç‡ä¸Šçš„ä¸€äº›å°å°çš„å¾—å¤±ï¼Œåœ¨97%çš„æƒ…å†µä¸‹ï¼Œä¸æˆç†Ÿçš„ä¼˜åŒ–æ‰æ˜¯ä¸€åˆ‡é—®é¢˜çš„æ ¹æºã€‚<br>åœ¨ä¼˜åŒ–æ–¹é¢ï¼Œæˆ‘ä»¬åº”è¯¥éµå®ˆä¸¤æ¡è§„åˆ™ï¼š<br>è§„åˆ™1: ä¸è¦è¿›è¡Œä¼˜åŒ–ã€‚<br>è§„åˆ™2: è¿˜æ˜¯ä¸è¦è¿›è¡Œä¼˜åŒ–â€”ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ä½ è¿˜æ²¡æœ‰ç»å¯¹æ¸…æ™°çš„æœªä¼˜åŒ–æ–¹æ¡ˆä¹‹å‰ï¼Œè¯·ä¸è¦ä¼˜åŒ–ã€‚</p></blockquote><p>ä¸è¦å› ä¸ºæ€§èƒ½è€Œç‰ºç‰²åˆç†çš„ç»“æ„ã€‚è¦åŠªåŠ›ç¼–å†™å¥½çš„ç¨‹åºè€Œä¸æ˜¯å¿«çš„ç¨‹åºã€‚å¥½çš„ç¨‹åºä½“ç°äº†ä¿¡æ¯éšè—çš„åŸåˆ™ï¼šåªè¦æœ‰å¯èƒ½ï¼Œå®ƒä»¬å°±ä¼šæŠŠè®¾è®¡å†³ç­–å‡ ç§åœ¨å•ä¸ªæ¨¡å—ä¸­ï¼Œå› æ­¤ï¼Œå¯ä»¥æ”¹å˜å•ä¸ªå†³ç­–ï¼Œè€Œä¸ä¼šå½±å“åˆ°ç³»ç»Ÿçš„å…¶ä»–éƒ¨åˆ†ã€‚</p><p>åœ¨è®¾è®¡çš„è¿‡ç¨‹ä¸­è€ƒè™‘æ€§èƒ½é—®é¢˜ã€‚åŠªåŠ›é¿å…é™åˆ¶æ€§èƒ½çš„è®¾è®¡å†³ç­–ã€‚</p><h3 id="56-éµå®ˆæ™®éæ¥å—çš„å‘½åæƒ¯ä¾‹"><a href="#56-éµå®ˆæ™®éæ¥å—çš„å‘½åæƒ¯ä¾‹" class="headerlink" title="56.éµå®ˆæ™®éæ¥å—çš„å‘½åæƒ¯ä¾‹"></a>56.éµå®ˆæ™®éæ¥å—çš„å‘½åæƒ¯ä¾‹</h3><h2 id="å…«ã€å¼‚å¸¸"><a href="#å…«ã€å¼‚å¸¸" class="headerlink" title="å…«ã€å¼‚å¸¸"></a>å…«ã€å¼‚å¸¸</h2><h3 id="57-åªé’ˆå¯¹å¼‚å¸¸çš„æƒ…å†µæ‰ä½¿ç”¨å¼‚å¸¸"><a href="#57-åªé’ˆå¯¹å¼‚å¸¸çš„æƒ…å†µæ‰ä½¿ç”¨å¼‚å¸¸" class="headerlink" title="57.åªé’ˆå¯¹å¼‚å¸¸çš„æƒ…å†µæ‰ä½¿ç”¨å¼‚å¸¸"></a>57.åªé’ˆå¯¹å¼‚å¸¸çš„æƒ…å†µæ‰ä½¿ç”¨å¼‚å¸¸</h3><p>å¼‚å¸¸æœºåˆ¶çš„è®¾è®¡åˆè¡·æ˜¯ç”¨äºä¸æ­£å¸¸çš„æƒ…å½¢ï¼Œæ‰€ä»¥å¾ˆå°‘ä¼šæœ‰JVMå®ç°è¯•å›¾å¯¹å®ƒä»¬è¿›è¡Œä¼˜åŒ–ï¼Œä½¿å¾—ä¸æ˜¾å¼çš„æµ‹è¯•ä¸€æ ·å¿«é€Ÿã€‚</p><p>æŠŠä»£ç æ”¾åœ¨try-catchå—ä¸­åè€Œé˜»æ­¢äº†ç°ä»£JVMå®ç°æœ¬æ¥å¯èƒ½è¦æ‰§è¡Œçš„æŸäº›ç‰¹å®šçš„ä¼˜åŒ–ã€‚</p><p>å¯¹æ•°ç»„è¿›è¡Œéå†çš„æ ‡å‡†æ¨¡å¼å¹¶ä¸ä¼šå¯¼è‡´å†—ä½™çš„æ£€æŸ¥ã€‚æœ‰äº›ç°ä»£çš„JVMå®ç°ä¼šå°†å®ƒä»¬ä¼˜åŒ–æ‰ã€‚</p><h3 id="58-å¯¹å¯æ¢å¤çš„æƒ…å†µä½¿ç”¨å—æ£€å¼‚å¸¸ï¼Œå¯¹ç¼–ç¨‹é”™è¯¯ä½¿ç”¨è¿è¡Œæ—¶å¼‚å¸¸"><a href="#58-å¯¹å¯æ¢å¤çš„æƒ…å†µä½¿ç”¨å—æ£€å¼‚å¸¸ï¼Œå¯¹ç¼–ç¨‹é”™è¯¯ä½¿ç”¨è¿è¡Œæ—¶å¼‚å¸¸" class="headerlink" title="58.å¯¹å¯æ¢å¤çš„æƒ…å†µä½¿ç”¨å—æ£€å¼‚å¸¸ï¼Œå¯¹ç¼–ç¨‹é”™è¯¯ä½¿ç”¨è¿è¡Œæ—¶å¼‚å¸¸"></a>58.å¯¹å¯æ¢å¤çš„æƒ…å†µä½¿ç”¨å—æ£€å¼‚å¸¸ï¼Œå¯¹ç¼–ç¨‹é”™è¯¯ä½¿ç”¨è¿è¡Œæ—¶å¼‚å¸¸</h3><h3 id="59-é¿å…ä¸å¿…è¦çš„ä½¿ç”¨å—æ£€å¼‚å¸¸"><a href="#59-é¿å…ä¸å¿…è¦çš„ä½¿ç”¨å—æ£€å¼‚å¸¸" class="headerlink" title="59.é¿å…ä¸å¿…è¦çš„ä½¿ç”¨å—æ£€å¼‚å¸¸"></a>59.é¿å…ä¸å¿…è¦çš„ä½¿ç”¨å—æ£€å¼‚å¸¸</h3><h3 id="60-ä¼˜å…ˆä½¿ç”¨æ ‡å‡†å¼‚å¸¸"><a href="#60-ä¼˜å…ˆä½¿ç”¨æ ‡å‡†å¼‚å¸¸" class="headerlink" title="60.ä¼˜å…ˆä½¿ç”¨æ ‡å‡†å¼‚å¸¸"></a>60.ä¼˜å…ˆä½¿ç”¨æ ‡å‡†å¼‚å¸¸</h3><p><img src="/media/article/15583547431411.jpg" alt=""></p><h3 id="61-æŠ›å‡ºåŸŸæŠ½è±¡ç›¸å¯¹åº”çš„å¼‚å¸¸"><a href="#61-æŠ›å‡ºåŸŸæŠ½è±¡ç›¸å¯¹åº”çš„å¼‚å¸¸" class="headerlink" title="61.æŠ›å‡ºåŸŸæŠ½è±¡ç›¸å¯¹åº”çš„å¼‚å¸¸"></a>61.æŠ›å‡ºåŸŸæŠ½è±¡ç›¸å¯¹åº”çš„å¼‚å¸¸</h3><p>æ›´é«˜å±‚æ¬¡çš„å®ç°åº”è¯¥æ•è·ä½å±‚çš„å¼‚å¸¸ï¼ŒåŒæ—¶æŠ›å‡ºå¯ä»¥æŒ‰ç…§é«˜å±‚æŠ½è±¡è¿›è¡Œè§£é‡Šçš„å¼‚å¸¸ã€‚<br>å¦‚æœä¸èƒ½é˜»æ­¢æˆ–è€…å¤„ç†æ¥è‡ªä½å±‚çš„å¼‚å¸¸ï¼Œä¸€èˆ¬åšæ³•æ˜¯ä½¿ç”¨å¼‚å¸¸è½¬è¯‘ï¼Œé™¤éä½å±‚æ–¹æ³•ç¢°å·§å¯ä»¥ä¿è¯å®ƒæŠ›å‡ºçš„æ‰€æœ‰å¼‚å¸¸å¯¹é«˜å±‚ä¹Ÿåˆé€‚æ‰å¯ä»¥å°†å¼‚å¸¸ä»ä½å±‚ä¼ æ’­åˆ°é«˜å±‚ã€‚å¼‚å¸¸é“¾å¯¹é«˜å±‚å’Œä½å±‚å¼‚å¸¸éƒ½æä¾›äº†æœ€ä½³åŠŸèƒ½ï¼šå®ƒå…è®¸æŠ›å‡ºé€‚å½“çš„é«˜å±‚å¼‚å¸¸ï¼ŒåŒæ—¶åˆèƒ½æ•è·ä½å±‚çš„åŸå› è¿›è¡Œå¤±è´¥åˆ†æã€‚</p><h3 id="62-æ¯ä¸ªæ–¹æ³•æŠ›å‡ºçš„å¼‚å¸¸éƒ½è¦æœ‰æ–‡æ¡£"><a href="#62-æ¯ä¸ªæ–¹æ³•æŠ›å‡ºçš„å¼‚å¸¸éƒ½è¦æœ‰æ–‡æ¡£" class="headerlink" title="62.æ¯ä¸ªæ–¹æ³•æŠ›å‡ºçš„å¼‚å¸¸éƒ½è¦æœ‰æ–‡æ¡£"></a>62.æ¯ä¸ªæ–¹æ³•æŠ›å‡ºçš„å¼‚å¸¸éƒ½è¦æœ‰æ–‡æ¡£</h3><p>å§‹ç»ˆè¦å•ç‹¬çš„å£°æ˜å—æ£€å¼‚å¸¸ï¼Œå¹¶ä¸”åˆ©ç”¨Javadocçš„@throwsæ ‡è®°ï¼Œå‡†ç¡®çš„è®°å½•ä¸‹æŠ›å‡ºçš„æ¯ä¸ªå¼‚å¸¸çš„æ¡ä»¶ã€‚</p><p>ä½¿ç”¨Javadocçš„@throwsæ ‡ç­¾è®°å½•ä¸‹ä¸€ä¸ªæ–¹æ³•å¯èƒ½æŠ›å‡ºçš„æ¯ä¸ªå—æ£€å¼‚å¸¸ï¼Œä½†æ˜¯ä¸è¦ä½¿ç”¨throwså…³é”®å­—å°†æœªå—æ£€å¼‚å¸¸åŒ…å«åœ¨æ–¹æ³•çš„å£°æ˜ä¸­ã€‚</p><p>å¦‚æœä¸€ä¸ªç±»ä¸­çš„è®¸å¤šæ–¹æ³•å¤„äºåŒæ ·çš„åŸå› è€ŒæŠ›å‡ºåŒä¸€ä¸ªå¼‚å¸¸ï¼Œåˆ™è¯¥ç±»çš„æ–‡æ¡£æ³¨é‡Šä¸­å¯¹è¿™ä¸ªå¼‚å¸¸å»ºç«‹æ–‡æ¡£ï¼Œæ˜¯å¯ä»¥æ¥å—çš„ã€‚</p><h3 id="63-åœ¨ç»†èŠ‚æ¶ˆæ¯ä¸­åŒ…å«èƒ½æ•è·å¤±è´¥çš„ä¿¡æ¯"><a href="#63-åœ¨ç»†èŠ‚æ¶ˆæ¯ä¸­åŒ…å«èƒ½æ•è·å¤±è´¥çš„ä¿¡æ¯" class="headerlink" title="63.åœ¨ç»†èŠ‚æ¶ˆæ¯ä¸­åŒ…å«èƒ½æ•è·å¤±è´¥çš„ä¿¡æ¯"></a>63.åœ¨ç»†èŠ‚æ¶ˆæ¯ä¸­åŒ…å«èƒ½æ•è·å¤±è´¥çš„ä¿¡æ¯</h3><p>ä¸ºäº†æ•è·å¤±è´¥ï¼Œå¼‚å¸¸çš„ç»†èŠ‚ä¿¡æ¯åº”è¯¥åŒ…å«æ‰€æœ‰â€œå¯¹è¯¥å¼‚å¸¸æœ‰è´¡çŒ®â€çš„å‚æ•°å’ŒåŸŸçš„å€¼ã€‚</p><h3 id="64-åŠªåŠ›ä½¿å¤±è´¥ä¿æŒåŸå­æ€§"><a href="#64-åŠªåŠ›ä½¿å¤±è´¥ä¿æŒåŸå­æ€§" class="headerlink" title="64.åŠªåŠ›ä½¿å¤±è´¥ä¿æŒåŸå­æ€§"></a>64.åŠªåŠ›ä½¿å¤±è´¥ä¿æŒåŸå­æ€§</h3><p>ä¸€èˆ¬è€Œè¨€ï¼Œå¤±è´¥çš„æ–¹æ³•è°ƒç”¨åº”è¯¥ä½¿å¯¹è±¡ä¿æŒåœ¨è¢«è°ƒç”¨ä¹‹å‰çš„çŠ¶æ€ã€‚</p><h3 id="65-ä¸è¦å¿½ç•¥å¼‚å¸¸"><a href="#65-ä¸è¦å¿½ç•¥å¼‚å¸¸" class="headerlink" title="65.ä¸è¦å¿½ç•¥å¼‚å¸¸"></a>65.ä¸è¦å¿½ç•¥å¼‚å¸¸</h3><h2 id="ä¹ã€å¹¶å‘"><a href="#ä¹ã€å¹¶å‘" class="headerlink" title="ä¹ã€å¹¶å‘"></a>ä¹ã€å¹¶å‘</h2><h3 id="66-åŒæ­¥è®¿é—®å…±äº«çš„å¯å˜æ•°æ®"><a href="#66-åŒæ­¥è®¿é—®å…±äº«çš„å¯å˜æ•°æ®" class="headerlink" title="66.åŒæ­¥è®¿é—®å…±äº«çš„å¯å˜æ•°æ®"></a>66.åŒæ­¥è®¿é—®å…±äº«çš„å¯å˜æ•°æ®</h3><p>Javaè¯­è¨€è§„èŒƒä¿è¯è¯»æˆ–å†™ä¸€ä¸ªå˜é‡æ˜¯åŸå­çš„ï¼Œé™¤éè¿™ä¸ªå˜é‡çš„ç±»å‹ä¸ºlongæˆ–è€…double[JLSï¼Œ17.4.7]ã€‚å¯¹äºè¿™å¥è¯ä¸è¦è¯¯è§£ï¼Œè™½ç„¶è¯­è¨€è§„èŒƒä¿è¯äº†çº¿ç¨‹åœ¨è¯»å–åŸå­æ•°æ®çš„æ—¶å€™ï¼Œä¸ä¼šçœ‹åˆ°ä»»æ„çš„æ•°å€¼ï¼Œä½†æ˜¯å®ƒå¹¶ä¸ä¿è¯ä¸€ä¸ªçº¿ç¨‹å†™å…¥çš„å€¼å¯¹äºå¦ä¸€ä¸ªçº¿ç¨‹å°†æ˜¯å¯è§çš„ã€‚ä¸ºäº†åœ¨çº¿ç¨‹ä¹‹é—´è¿›è¡Œå¯é çš„é€šä¿¡ï¼Œä¹Ÿä¸ºäº†äº’æ–¥è®¿é—®ï¼ŒåŒæ­¥æ˜¯å¿…è¦çš„ã€‚</p><h3 id="67-é¿å…è¿‡åº¦åŒæ­¥"><a href="#67-é¿å…è¿‡åº¦åŒæ­¥" class="headerlink" title="67.é¿å…è¿‡åº¦åŒæ­¥"></a>67.é¿å…è¿‡åº¦åŒæ­¥</h3><p>ä¸ºäº†é¿å…æ­»é”å’Œæ•°æ®ç ´åï¼Œåƒä¸‡ä¸è¦ä»åŒæ­¥åŒºåŸŸå†…éƒ¨è°ƒç”¨å¤–æ¥æ–¹æ³•ï¼Œè¦å°½é‡é™åˆ¶åŒæ­¥åŒºåŸŸå†…éƒ¨çš„å·¥ä½œé‡ã€‚</p><h3 id="68-executorå’Œtaskä¼˜å…ˆäºçº¿ç¨‹"><a href="#68-executorå’Œtaskä¼˜å…ˆäºçº¿ç¨‹" class="headerlink" title="68.executorå’Œtaskä¼˜å…ˆäºçº¿ç¨‹"></a>68.executorå’Œtaskä¼˜å…ˆäºçº¿ç¨‹</h3><h3 id="69-å¹¶å‘å·¥å…·ä¼˜å…ˆäºwaitå’Œnotify"><a href="#69-å¹¶å‘å·¥å…·ä¼˜å…ˆäºwaitå’Œnotify" class="headerlink" title="69.å¹¶å‘å·¥å…·ä¼˜å…ˆäºwaitå’Œnotify"></a>69.å¹¶å‘å·¥å…·ä¼˜å…ˆäºwaitå’Œnotify</h3><p>java.util.concurrentä¸­æ›´é«˜çº§çš„çš„å·¥å…·åˆ†æˆä¸‰ç±»ï¼šExeccutor Frameworkã€å¹¶å‘é›†åˆï¼ˆConcurrent Collectionï¼‰ä»¥åŠåŒæ­¥å™¨ï¼ˆSynchronizerï¼‰ã€‚</p><p>åŒæ­¥å™¨æ˜¯ä¸€äº›ä½¿çº¿ç¨‹èƒ½å¤Ÿç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹çš„å¯¹è±¡ï¼Œå…è®¸å®ƒä»¬åè°ƒåŠ¨ä½œã€‚å¸¸ç”¨çš„æ˜¯CountDownLatchå’ŒSemaphoreã€‚ä¸å¸¸ç”¨çš„æ˜¯CyclicBarrierå’ŒExchangerã€‚</p><p>å¯¹äºé—´æ­‡å¼çš„å®šæ—¶ï¼Œå§‹ç»ˆåº”è¯¥ä¼˜å…ˆä½¿ç”¨System.nanoTimeï¼Œè€Œä¸æ˜¯ä½¿ç”¨System.currentTimeMillsã€‚System.nanoTimeæ›´åŠ å‡†ç¡®ä¹Ÿæ›´åŠ ç²¾ç¡®ï¼Œå®ƒä¸å—ç³»ç»Ÿçš„å®æ—¶æ—¶é’Ÿçš„è°ƒæ•´æ‰€å½±å“ã€‚</p><p>å¦‚æœä½ åœ¨ç»´æŠ¤ä½¿ç”¨waitå’Œnotifyçš„ä»£ç ï¼ŒåŠ¡å¿…ç¡®ä¿å§‹ç»ˆæ˜¯åˆ©ç”¨æ ‡å‡†çš„æ¨¡å¼ä»whileå¾ªç¯å†…éƒ¨è°ƒç”¨waitã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä½ åº”è¯¥ä¼˜å…ˆä½¿ç”¨notifyAllï¼Œè€Œä¸æ˜¯ä½¿ç”¨notifyã€‚å¦‚æœä½¿ç”¨notifyï¼Œè¯·ä¸€å®šå°å¿ƒï¼Œä»¥ç¡®ä¿ç¨‹åºçš„æ´»æ€§ã€‚</p><h3 id="70-çº¿ç¨‹å®‰å…¨æ€§çš„æ–‡æ¡£åŒ–"><a href="#70-çº¿ç¨‹å®‰å…¨æ€§çš„æ–‡æ¡£åŒ–" class="headerlink" title="70.çº¿ç¨‹å®‰å…¨æ€§çš„æ–‡æ¡£åŒ–"></a>70.çº¿ç¨‹å®‰å…¨æ€§çš„æ–‡æ¡£åŒ–</h3><p>ä¸€ä¸ªç±»ä¸ºäº†å¯è¢«å¤šä¸ªçº¿ç¨‹å®‰å…¨çš„ä½¿ç”¨ï¼Œå¿…é¡»åœ¨æ–‡æ¡£ä¸­æ¸…æ¥šçš„è¯´æ˜å®ƒæ‰€æ”¯æŒçš„çº¿ç¨‹å®‰å…¨çº§åˆ«ã€‚</p><ul><li>ä¸å¯å˜çš„ï¼ˆimmutableï¼‰è¿™ä¸ªç±»æ˜¯ä¸å¯å˜çš„ã€‚æ‰€ä»¥ä¸éœ€è¦å¤–éƒ¨åŒæ­¥ã€‚ä¾‹å¦‚ï¼šStringã€Longã€BigIntegerã€‚</li><li>æ— æ¡ä»¶çš„çº¿ç¨‹å®‰å…¨ï¼ˆunconditionally thread-safeï¼‰è¿™ä¸ªç±»çš„å®ä¾‹æ˜¯å¯å˜çš„ï¼Œä½†æ˜¯è¿™ä¸ªç±»æœ‰ç€è¶³å¤Ÿçš„å†…éƒ¨åŒæ­¥ï¼Œæ‰€ä»¥ï¼Œå®ƒçš„å®ä¾‹å¯ä»¥è¢«å¹¶å‘ä½¿ç”¨ï¼Œæ— éœ€ä»»ä½•å¤–éƒ¨åŒæ­¥ã€‚ä¾‹å¦‚ï¼šRandomã€ConcurrentHashMapã€‚</li><li>æœ‰æ¡ä»¶çš„çº¿ç¨‹å®‰å…¨ï¼ˆconditionally thread-safeï¼‰é™¤äº†æœ‰äº›æ–¹æ³•ä¸ºè¿›è¡Œå®‰å…¨çš„å¹¶å‘ä½¿ç”¨è€Œéœ€è¦å¤–éƒ¨åŒæ­¥ä¹‹å¤–ï¼Œè¿™ç§çº¿ç¨‹å®‰å…¨çº§åˆ«ä¸æ— æ¡ä»¶çš„çº¿ç¨‹å®‰å…¨ç›¸åŒã€‚ä¾‹å¦‚ï¼šCollections.synchronizedåŒ…è£…è¿”å›çš„é›†åˆï¼Œå®ƒä»¬çš„è¿­ä»£å™¨ï¼ˆiteratorï¼‰è¦æ±‚å¤–éƒ¨åŒæ­¥ã€‚</li><li>éçº¿ç¨‹å®‰å…¨ï¼ˆnot thread-safeï¼‰è¿™ä¸ªç±»çš„å®ä¾‹æ˜¯å¯å˜çš„ã€‚ä¸ºäº†å¹¶å‘åœ°ä½¿ç”¨å®ƒä»¬ï¼Œå®¢æˆ·ç«¯å¿…é¡»åˆ©ç”¨è‡ªå·±é€‰æ‹©çš„å¤–éƒ¨åŒæ­¥åŒ…å›´æ¯ä¸ªæ–¹æ³•è°ƒç”¨ã€‚ä¾‹å¦‚ï¼šArrayListã€HashMapã€‚</li><li>çº¿ç¨‹å¯¹ç«‹ï¼ˆthread-hostileï¼‰è¿™ä¸ªç±»ä¸èƒ½å®‰å…¨çš„è¢«å¤šä¸ªçº¿ç¨‹å¹¶å‘ä½¿ç”¨ï¼Œå³ä½¿æ‰€æœ‰çš„æ–¹æ³•è°ƒç”¨éƒ½è¢«å¤–éƒ¨åŒæ­¥åŒ…å›´ã€‚</li></ul><h3 id="71-æ…ç”¨å»¶è¿Ÿåˆå§‹åŒ–"><a href="#71-æ…ç”¨å»¶è¿Ÿåˆå§‹åŒ–" class="headerlink" title="71.æ…ç”¨å»¶è¿Ÿåˆå§‹åŒ–"></a>71.æ…ç”¨å»¶è¿Ÿåˆå§‹åŒ–</h3><p>å»¶è¿Ÿåˆå§‹åŒ–ï¼ˆlazy initializationï¼‰æ˜¯å»¶è¿Ÿåˆ°éœ€è¦åŸŸçš„å€¼æ—¶æ‰å°†å®ƒåˆå§‹åŒ–çš„è¿™ç§è¡Œä¸ºã€‚<br>å¤§å¤šæ•°çš„åŸŸåº”è¯¥æ­£å¸¸åœ°è¿›è¡Œåˆå§‹åŒ–ï¼Œè€Œä¸æ˜¯å»¶è¿Ÿåˆå§‹åŒ–ã€‚å¦‚æœä¸ºäº†è¾¾åˆ°æ€§èƒ½ç›®çš„ï¼Œæˆ–è€…ä¸ºäº†ç ´åæœ‰å®³çš„åˆå§‹åŒ–å¾ªç¯ï¼Œå¿…é¡»å»¶è¿Ÿåˆå§‹åŒ–ä¸€ä¸ªåŸŸåˆ™ï¼š<br>å¯¹äºå®ä¾‹åŸŸï¼Œå°±ä½¿ç”¨åŒé‡æ£€æŸ¥æ¨¡å¼ï¼ˆdouble-check idiomï¼‰ï¼›<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">private volatile FieldType field;</span><br><span class="line">FieldType getField()&#123;</span><br><span class="line">    FieldType result = field;</span><br><span class="line">    if(result == null)&#123;</span><br><span class="line">        synchronized(this)&#123;</span><br><span class="line">            result = field;</span><br><span class="line">            if(result == null)&#123;</span><br><span class="line">                field = result = computeFieldValue();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å¯¹äºé™æ€åŸŸï¼Œåˆ™ä½¿ç”¨lazy initialization holder class idiomï¼›<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">private static class FieldHolder&#123;</span><br><span class="line">    static final FieldType field = computeFieldValue();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">static FieldType getField()&#123;return FieldHolder.field;&#125;</span><br></pre></td></tr></table></figure></p><p>å¯¹äºå¯ä»¥æ¥å—é‡å¤åˆå§‹åŒ–çš„å®ä¾‹åŸŸï¼Œä¹Ÿå¯ä»¥è€ƒè™‘ä½¿ç”¨å•é‡æ£€æŸ¥æ¨¡å¼ï¼ˆsingle-check idiomï¼‰ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">private volatile FieldType field;</span><br><span class="line"></span><br><span class="line">private FieldType getField()&#123;</span><br><span class="line"></span><br><span class="line">    FieldType result = field;</span><br><span class="line">    if(result == null)&#123;</span><br><span class="line">        field = result = computeFieldValue();</span><br><span class="line">    &#125;</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="72-ä¸è¦ä¾èµ–äºçº¿ç¨‹è°ƒåº¦å™¨"><a href="#72-ä¸è¦ä¾èµ–äºçº¿ç¨‹è°ƒåº¦å™¨" class="headerlink" title="72.ä¸è¦ä¾èµ–äºçº¿ç¨‹è°ƒåº¦å™¨"></a>72.ä¸è¦ä¾èµ–äºçº¿ç¨‹è°ƒåº¦å™¨</h3><h3 id="73-é¿å…ä½¿ç”¨çº¿ç¨‹ç»„"><a href="#73-é¿å…ä½¿ç”¨çº¿ç¨‹ç»„" class="headerlink" title="73.é¿å…ä½¿ç”¨çº¿ç¨‹ç»„"></a>73.é¿å…ä½¿ç”¨çº¿ç¨‹ç»„</h3><p>çº¿ç¨‹ç»„çš„åˆè¡·æ˜¯ä½œä¸ºä¸€ç§éš”ç¦»appletçš„æœºåˆ¶ï¼Œå½“ç„¶æ˜¯å‡ºäºå®‰å…¨çš„è€ƒè™‘ã€‚çº¿ç¨‹ç»„å¹¶æ²¡æœ‰æä¾›å¤ªå¤šæœ‰ç”¨çš„åŠŸèƒ½ï¼Œè€Œä¸”å®ƒä»¬æä¾›çš„è®¸å¤šåŠŸèƒ½è¿˜éƒ½æ˜¯æœ‰ç¼ºé™·çš„ã€‚</p><h2 id="åã€åºåˆ—åŒ–"><a href="#åã€åºåˆ—åŒ–" class="headerlink" title="åã€åºåˆ—åŒ–"></a>åã€åºåˆ—åŒ–</h2><h3 id="74-è°¨æ…çš„å®ç°Serializableæ¥å£"><a href="#74-è°¨æ…çš„å®ç°Serializableæ¥å£" class="headerlink" title="74.è°¨æ…çš„å®ç°Serializableæ¥å£"></a>74.è°¨æ…çš„å®ç°Serializableæ¥å£</h3><p>å®ç°Serializableæ¥å£è€Œä»˜å‡ºçš„æœ€å¤§ä»£ä»·æ˜¯ï¼Œä¸€æ—¦ä¸€ä¸ªç±»è¢«å‘å¸ƒï¼Œå°±å¤§å¤§é™ä½äº†â€œæ”¹å˜è¿™ä¸ªç±»çš„å®ç°â€çš„çµæ´»æ€§ã€‚</p><p>å¦‚æœæ¥å—äº†é»˜è®¤çš„åºåˆ—åŒ–å½¢å¼ï¼Œå¹¶ä¸”ä»¥åè¦æ”¹å˜è¿™ä¸ªç±»çš„å†…éƒ¨è¡¨ç¤ºæ³•ï¼Œç»“æœå¯èƒ½å¯¼è‡´åºåˆ—åŒ–å½¢å¼çš„ä¸å…¼å®¹ã€‚</p><p>ç¬¬äºŒä¸ªä»£ä»·æ˜¯ï¼Œå®ƒå¢åŠ äº†å‡ºç°Bugå’Œå®‰å…¨æ¼æ´çš„å¯èƒ½æ€§ã€‚</p><p>å®ç°Serializableç¬¬ä¸‰ä¸ªä»£ä»·æ˜¯ï¼Œéšç€ç±»å‘è¡Œæ–°çš„ç‰ˆæœ¬ï¼Œç›¸å…³çš„æµ‹è¯•è´Ÿæ‹…ä¹Ÿå¢åŠ äº†ã€‚</p><p>ä¸ºäº†ç»§æ‰¿è€Œè®¾è®¡çš„ç±»åº”è¯¥å°½å¯èƒ½å°‘çš„è¶‹åŠ¿çº¿Serializableæ¥å£ï¼Œç”¨æˆ·çš„æ¥å£ä¹Ÿåº”è¯¥å°½å¯èƒ½å°‘çš„ç»§æ‰¿Serializableæ¥å£ã€‚å¦‚æœè¿åäº†è¿™æ¡è§„åˆ™ï¼Œæ‰©å±•è¿™ä¸ªç±»æˆ–è€…å®ç°è¯¥æ¥å£çš„ç¨‹åºå‘˜å°±ä¼šèƒŒä¸Šæ²‰é‡çš„è´Ÿæ‹…ã€‚ç„¶è€Œæœ‰äº›æƒ…å†µä¸‹ï¼Œè¿™æ¡è§„åˆ™ç¡®å®é€‚åˆçš„ã€‚ä¾‹å¦‚ï¼šå¦‚æœä¸€ä¸ªç±»æˆ–è€…æ¥å£å­˜åœ¨çš„ç›®çš„ä¸»è¦æ˜¯ä¸ºäº†å‚åŠ åˆ°æŸä¸ªæ¡†æ¶ä¸­ï¼Œè¯¥æ¡†æ¶è¦æ±‚æ‰€æœ‰çš„å‚ä¸è€…éƒ½å¿…é¡»å®ç°Serializableæ¥å£ï¼Œé‚£ä¹ˆå¯¹äºç±»æˆ–è€…æ¥å£æ¥è¯´å®ç°æ‰©å±•Serializableæ˜¯æœ‰æ„ä¹‰çš„ã€‚</p><p>å¦‚æœä¸€ä¸ªä¸“é—¨ä¸ºäº†ç»§æ‰¿è€Œè®¾è®¡çš„ç±»ä¸æ˜¯å¯åºåˆ—åŒ–çš„ï¼Œå°±ä¸å¯èƒ½ç¼–å†™å‡ºå¯åºåˆ—åŒ–çš„å­ç±»ã€‚ç‰¹åˆ«æ˜¯ï¼Œå¦‚æœè¶…ç±»æ²¡æœ‰æä¾›å¯è®¿é—®çš„æ— å‚æ„é€ å™¨ï¼Œå­ç±»ä¹Ÿä¸å¯èƒ½åšåˆ°åºåˆ—åŒ–ã€‚å¯¹äºæœªç»§æ‰¿è€Œè®¾è®¡çš„ä¸å¯åºåˆ—åŒ–çš„ç±»ï¼Œä½ åº”è¯¥æä¾›ä¸€ä¸ªæ— å‚æ„é€ å™¨ã€‚</p><h3 id="75-è€ƒè™‘ä½¿ç”¨è‡ªå®šä¹‰çš„åºåˆ—åŒ–å½¢å¼"><a href="#75-è€ƒè™‘ä½¿ç”¨è‡ªå®šä¹‰çš„åºåˆ—åŒ–å½¢å¼" class="headerlink" title="75.è€ƒè™‘ä½¿ç”¨è‡ªå®šä¹‰çš„åºåˆ—åŒ–å½¢å¼"></a>75.è€ƒè™‘ä½¿ç”¨è‡ªå®šä¹‰çš„åºåˆ—åŒ–å½¢å¼</h3><p>å¦‚æœä¸€ä¸ªå¯¹è±¡çš„ç‰©ç†è¡¨ç¤ºæ³•ç­‰åŒäºå®ƒçš„é€»è¾‘å†…å®¹ï¼Œå¯èƒ½å°±é€‚åˆäºä½¿ç”¨é»˜è®¤çš„åºåˆ—åŒ–å½¢å¼ã€‚ä¾‹å¦‚ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public class Name implements Serializable&#123;</span><br><span class="line">    private final String lastName;</span><br><span class="line">    </span><br><span class="line">    private final String firstName;</span><br><span class="line">    </span><br><span class="line">    private final String middleName;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å³ä½¿ä½ ç¡®å®šäº†é»˜è®¤çš„åºåˆ—åŒ–å½¢å¼æ˜¯åˆé€‚çš„ï¼Œé€šå¸¸è¿˜å¿…é¡»æä¾›ä¸€ä¸ªreadObjectæ–¹æ³•ä¿è¯çº¦æŸå…³ç³»å’Œå®‰å…¨æ€§ã€‚</p><p>å½“ä¸€ä¸ªå¯¹è±¡çš„ç‰©ç†è¡¨ç¤ºæ³•ä¸å®ƒçš„é€»è¾‘æ•°æ®å†…å®¹æœ‰å®è´¨æ€§çš„åŒºåˆ«æ—¶ï¼Œä½¿ç”¨é»˜è®¤åºåˆ—åŒ–å½¢å¼ä¼šæœ‰ä»¥ä¸‹4ä¸ªç¼ºç‚¹ï¼š</p><ul><li>å®ƒä½¿è¿™ä¸ªç±»çš„å¯¼å‡ºAPIæ°¸è¿œåœ°æŸç¼šåœ¨è¯¥ç±»çš„å†…éƒ¨è¡¨ç¤ºæ³•ä¸Šã€‚</li><li>å®ƒä¼šæ¶ˆè€—è¿‡å¤šçš„æ—¶é—´ã€‚</li><li>å®ƒä¼šæ¶ˆè€—è¿‡å¤šç©ºé—´ã€‚</li><li>å®ƒä¼šå¼•èµ·æ ˆæº¢å‡ºã€‚</li></ul><p>å¦‚æœæ‰€æœ‰çš„å®ä¾‹åŸŸéƒ½æ˜¯ç¬æ—¶çš„ï¼ˆtransientï¼‰ï¼Œä»æŠ€æœ¯è§’åº¦è€Œè¨€ï¼Œä¸è°ƒç”¨DefaultWriteObjectå’ŒdefaultReadObjectä¹Ÿæ˜¯å…è®¸çš„ï¼Œä½†æ˜¯ä¸æ¨èè¿™æ ·åšã€‚<br>åœ¨å†³å®šå°†ä¸€ä¸ªåŸŸåšæˆétransientçš„ä¹‹å‰ï¼Œè¯·ä¸€å®šè¦ç¡®ä¿¡å®ƒçš„å€¼å°†æ˜¯è¯¥å¯¹è±¡é€»è¾‘çŠ¶æ€çš„ä¸€éƒ¨åˆ†ã€‚<br>å¦‚æœåœ¨è¯»å–æ•´ä¸ªå¯¹è±¡çŠ¶æ€çš„ä»»ä½•å…¶ä»–æ–¹æ³•ä¸Šå¼ºåˆ¶ä»»ä½•åŒæ­¥ï¼Œåˆ™ä¹Ÿå¿…é¡»åœ¨å¯¹è±¡åºåˆ—åŒ–ä¸Šå¼ºåˆ¶è¿™ç§åŒæ­¥ã€‚<br>ä¸ç®¡ä½ é€‰æ‹©äº†å“ªç§åºåˆ—åŒ–å½¢å¼ï¼Œéƒ½è¦ä¸ºè‡ªå·±ç¼–å†™çš„æ¯ä¸ªå¯åºåˆ—åŒ–çš„ç±»å£°æ˜ä¸€ä¸ªæ˜¾å¼çš„åºåˆ—ç‰ˆæœ¬UIDï¼ˆserial version UIDï¼‰ã€‚</p><h3 id="76-ä¿æŠ¤æ€§çš„ç¼–å†™readObjectæ–¹æ³•"><a href="#76-ä¿æŠ¤æ€§çš„ç¼–å†™readObjectæ–¹æ³•" class="headerlink" title="76.ä¿æŠ¤æ€§çš„ç¼–å†™readObjectæ–¹æ³•"></a>76.ä¿æŠ¤æ€§çš„ç¼–å†™readObjectæ–¹æ³•</h3><p><strong><em>è®°å¾—å›æ¥çœ‹ååºåˆ—åŒ–ä»£ç </em></strong></p><p>å½“ä¸€ä¸ªå¯¹è±¡è¢«ååºåˆ—åŒ–çš„æ—¶å€™ï¼Œå¯¹äºå®¢æˆ·ç«¯ä¸åº”è¯¥æ‹¥æœ‰çš„å¯¹è±¡å¼•ç”¨ï¼Œå¦‚æœå“ªä¸ªåŸŸåŒ…å«äº†è¿™æ ·çš„å¯¹è±¡å¼•ç”¨ï¼Œå°±å¿…é¡»è¦åšä¿æŠ¤æ€§æ‹·è´ï¼Œè¿™æ˜¯éå¸¸é‡è¦çš„ã€‚ä¿æŠ¤æ€§æ‹·è´åœ¨æœ‰æ•ˆæ€§æ£€æŸ¥ä¹‹å‰è¿›è¡Œã€‚</p><p>ä¸è¦ä½¿ç”¨writeUnsharedå’ŒreadUnsharedæ–¹æ³•ã€‚</p><p>å¯¹äºéfinalçš„å¯åºåˆ—åŒ–ç±»ï¼ŒreadObjectæ–¹æ³•ä¸å¯ä»¥è°ƒç”¨å¯è¢«è¦†ç›–çš„æ–¹æ³•ï¼Œæ— è®ºæ˜¯ç›´æ¥è°ƒç”¨è¿˜æ˜¯é—´æ¥è°ƒç”¨éƒ½ä¸å¯ä»¥ã€‚å¦‚æœè¿åäº†è§„åˆ™ï¼Œå¹¶è¦†ç›–äº†è¯¥æ–¹æ³•ï¼Œè¢«è¦†ç›–çš„æ–¹æ³•å°†åœ¨å­ç±»çš„çŠ¶æ€è¢«åºåˆ—åŒ–ä¹‹å‰å…ˆè¿è¡Œï¼Œç¨‹åºå¾ˆå¯èƒ½å¤±è´¥ã€‚</p><p>readObjectæ–¹æ³•æŒ‡å¯¼ï¼š</p><ul><li>å¯¹äºå¯¹è±¡å¼•ç”¨åŸŸå¿…é¡»ä¿æŒä¸ºç§æœ‰çš„ç±»ï¼Œè¦ä¿æŠ¤æ€§çš„æ‹·è´è¿™äº›åŸŸä¸­çš„æ¯ä¸ªå¯¹è±¡ã€‚ä¸å¯å˜ç±»çš„å¯å˜ç»„ä»¶å°±å±äºè¿™ä¸€ç±»åˆ«ã€‚</li><li>å¯¹äºä»»ä½•çº¦æŸæ¡ä»¶ï¼Œå¦‚æœæ£€æŸ¥å¤±è´¥ï¼Œåˆ™æŠ›å‡ºä¸€ä¸ªInvalidObjectExceptionå¼‚å¸¸ã€‚è¿™äº›æ£€æŸ¥åŠ¨ä½œåº”è¯¥è·Ÿåœ¨æ‰€æœ‰çš„ä¿æŠ¤æ€§æ‹·è´ä¹‹åã€‚</li><li>å¦‚æœæ•´ä¸ªå¯¹è±¡å›¾åœ¨è¢«ååºåˆ—åŒ–ä¹‹åå¿…é¡»è¿›è¡ŒéªŒè¯ï¼Œå°±åº”è¯¥ä½¿ç”¨ObjectInputValidationæ¥å£ã€‚</li><li>æ— è®ºæ˜¯ç›´æ¥æ–¹å¼è¿˜æ˜¯é—´æ¥æ–¹å¼ï¼Œéƒ½ä¸è¦è°ƒç”¨ç±»ä¸­ä»»ä½•å¯è¢«è¦†ç›–çš„æ–¹æ³•ã€‚</li></ul><h3 id="77-å¯¹äºå®ä¾‹æ§åˆ¶ï¼Œæšä¸¾ç±»å‹ä¼˜å…ˆäºreadResolve"><a href="#77-å¯¹äºå®ä¾‹æ§åˆ¶ï¼Œæšä¸¾ç±»å‹ä¼˜å…ˆäºreadResolve" class="headerlink" title="77.å¯¹äºå®ä¾‹æ§åˆ¶ï¼Œæšä¸¾ç±»å‹ä¼˜å…ˆäºreadResolve"></a>77.å¯¹äºå®ä¾‹æ§åˆ¶ï¼Œæšä¸¾ç±»å‹ä¼˜å…ˆäºreadResolve</h3><p>å¦‚æœè¿™ä¸ªç±»çš„å£°æ˜åŠ ä¸Šäº†â€œimplements Serializableâ€çš„å­—æ ·ï¼Œå®ƒå°±ä¸å†æ˜¯ä¸€ä¸ªå•ä¾‹ç±»ã€‚æ— è®ºä½¿ç”¨é»˜è®¤çš„åºåˆ—åŒ–å½¢å¼ï¼Œè¿˜æ˜¯è‡ªå®šä¹‰çš„åºåˆ—åŒ–å½¢å¼ï¼Œéƒ½ä¼šè¿”å›ä¸€ä¸ªæ–°å»ºçš„å®ä¾‹ï¼Œè¿™ä¸ªæ–°å»ºå®ä¾‹ä¸ç”¨äºè¯¥ç±»åˆå§‹åŒ–æ—¶åˆ›å»ºçš„å®ä¾‹ã€‚</p><p>readResolveç‰¹æ€§å…è®¸ä½ ç”¨readObjectåˆ›å»ºçš„å®ä¾‹ä»£æ›¿å¦ä¸€ä¸ªå®ä¾‹ã€‚å¯¹äºä¸€ä¸ªæ­£åœ¨è¢«åºåˆ—åŒ–çš„å¯¹è±¡ï¼Œå¦‚æœå®ƒçš„ç±»å®šä¹‰äº†ä¸€ä¸ªreadResolveæ–¹æ³•ï¼Œå¹¶ä¸”å…·å¤‡æ­£ç¡®çš„å£°æ˜ï¼Œé‚£ä¹ˆåœ¨ååºåˆ—åŒ–åï¼Œæ–°å»ºå¯¹è±¡ä¸Šçš„readResolveæ–¹æ³•å°±ä¼šè¢«è°ƒç”¨ï¼Œè¯¥æ–¹æ³•è¿”å›çš„å¯¹è±¡å¼•ç”¨å°†è¢«è¿”å›ï¼Œå–ä»£æ–°å»ºå¯¹è±¡ï¼ŒæŒ‡å‘æ–°å»ºå¯¹è±¡çš„å¼•ç”¨ä¸éœ€è¦å†è¢«ä¿ç•™ï¼Œå› æ­¤ç«‹å³æˆä¸ºåƒåœ¾å›æ”¶å¯¹è±¡ã€‚</p><p>å¦‚æœreadResolveæ–¹æ³•å¿½ç•¥è¢«ååºåˆ—åŒ–çš„å¯¹è±¡ï¼Œåªè¿”å›è¯¥ç±»åˆå§‹åŒ–æ—¶åˆ›å»ºçš„å®ä¾‹ã€‚å¦‚æœä¾èµ–readResolveè¿›è¡Œå®ä¾‹æ§åˆ¶ï¼Œå¸¦æœ‰å¯¹è±¡å¼•ç”¨ç±»å‹çš„æ‰€æœ‰å®ä¾‹åŸŸéƒ½å¿…é¡»å£°æ˜ä¸ºtransientçš„ã€‚</p><p>readResolveçš„å¯è®¿é—®æ€§å¾ˆé‡è¦ã€‚å¦‚æœæŠŠreadResolveæ–¹æ³•æ”¾åœ¨ä¸€ä¸ªfinalç±»ä¸Šï¼Œå®ƒå°±åº”è¯¥æ˜¯ç§æœ‰çš„ã€‚å¦‚æœå§readResolveæ–¹æ³•æ”¾åœ¨ä¸€ä¸ªéfinalç±»ä¸Šï¼Œå°±å¿…é¡»è€ƒè™‘å®ƒçš„å¯è®¿é—®æ€§ã€‚</p><p>å°½å¯èƒ½çš„ä½¿ç”¨æšä¸¾ç±»å‹æ¥å®æ–½å®ä¾‹æ§åˆ¶çš„çº¦æŸæ¡ä»¶ã€‚å¦‚æœåšä¸åˆ°ï¼ŒåŒæ—¶åˆéœ€è¦ä¸€ä¸ªæ—¢å¯åºåˆ—åŒ–åˆæ˜¯å®ä¾‹å—æ§ï¼ˆinstance-controlledï¼‰çš„ç±»ï¼Œå°±å¿…é¡»æä¾›ä¸€ä¸ªreadResolveæ–¹æ³•ï¼Œå¹¶ç¡®ä¿è¯¥ç±»çš„æ‰€æœ‰å®ä¾‹åŸŸéƒ½ä¸ºåŸºæœ¬ç±»å‹ï¼Œæˆ–è€…æ˜¯transientçš„ã€‚</p><h3 id="78-è€ƒè™‘ç”¨åºåˆ—åŒ–ä»£ç†ä»£æ›¿åºåˆ—åŒ–å®ä¾‹"><a href="#78-è€ƒè™‘ç”¨åºåˆ—åŒ–ä»£ç†ä»£æ›¿åºåˆ—åŒ–å®ä¾‹" class="headerlink" title="78.è€ƒè™‘ç”¨åºåˆ—åŒ–ä»£ç†ä»£æ›¿åºåˆ—åŒ–å®ä¾‹"></a>78.è€ƒè™‘ç”¨åºåˆ—åŒ–ä»£ç†ä»£æ›¿åºåˆ—åŒ–å®ä¾‹</h3><p>æ¯å½“ä½ å‘ç°è‡ªå·±å¿…é¡»åœ¨ä¸€ä¸ªä¸èƒ½è¢«å®¢æˆ·ç«¯æ‰©å±•çš„ç±»ä¸Šç¼–å†™readObjectæˆ–è€…writeObjectæ–¹æ³•çš„æ—¶å€™ï¼Œå°±åº”è¯¥è€ƒè™‘ä½¿ç”¨åºåˆ—åŒ–ä»£ç†æ¨¡å¼ã€‚è¦æƒ³æ–‡ä»¶çš„å¸¦æœ‰é‡è¦çº¦æŸæ¡ä»¶çš„å¯¹è±¡åºåˆ—åŒ–ï¼Œè¿™ç§æ¨¡å¼å¯èƒ½æ˜¯æœ€å®¹æ˜“çš„ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;æ‘˜è‡ªã€ŠEffective Javaã€‹&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&quot;Effective-Java&quot;&gt;&lt;a href=&quot;#Effective-Java&quot; class=&quot;headerlink&quot; title=&quot;Effective J
      
    
    </summary>
    
    
      <category term="Java" scheme="https://zhongyp.me/tags/Java/"/>
    
      <category term="ç¬”è®°" scheme="https://zhongyp.me/tags/%E7%AC%94%E8%AE%B0/"/>
    
  </entry>
  
  <entry>
    <title>Java æšä¸¾ç±»</title>
    <link href="https://zhongyp.me/java/2019-05-01-java-enum/"/>
    <id>https://zhongyp.me/java/2019-05-01-java-enum/</id>
    <published>2019-04-30T16:00:00.000Z</published>
    <updated>2019-06-26T02:45:28.470Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>Javaæšä¸¾ç±»ç¬”è®°ï¼Œæ‘˜è‡ªã€Šç–¯ç‹‚Javaè®²ä¹‰ã€‹</p></blockquote><h2 id="æšä¸¾ç±»"><a href="#æšä¸¾ç±»" class="headerlink" title="æšä¸¾ç±»"></a>æšä¸¾ç±»</h2><p>åœ¨æ—©æœŸä»£ç ä¸­ï¼Œå¯èƒ½ä¼šç›´æ¥ä½¿ç”¨ç®€å•çš„é™æ€å¸¸é‡è¡¨ç¤ºæšä¸¾ï¼Œä¾‹å¦‚å¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public static final int SEASON_SPRING = 1;</span><br><span class="line">public static final int SEASON_SUMMER = 2;</span><br><span class="line">public static final int SEASON_FALL = 3;</span><br><span class="line">public static final int SEASON_WINTER = 4;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯è¿™ç§æ–¹å¼å®šä¹‰ä¼šå­˜åœ¨å¦‚ä¸‹é—®é¢˜ï¼š</p><ul><li>ç±»å‹ä¸å®‰å…¨ï¼šå¯èƒ½å­˜åœ¨SEASON_SPRING + SEASON_FALLã€‚</li><li>æ²¡æœ‰å‘½åç©ºé—´ï¼šå½“éœ€è¦ä½¿ç”¨å­£èŠ‚æ—¶ï¼Œå¿…é¡»åœ¨SPRINGé’±ä½¿ç”¨SEASON_å‰ç¼€ï¼Œå¦åˆ™ç¨‹åºå¯èƒ½ä¸å…¶ä»–ç±»ä¸­çš„é™æ€å¸¸é‡æ··æ·†ã€‚</li><li>æ‰“å°è¾“å‡ºçš„æ„ä¹‰ä¸æ˜ç¡®ï¼šå½“è¾“å‡ºæŸä¸ªå­£èŠ‚æ—¶ï¼Œå®é™…çš„è¾“å‡ºå€¼æ—¶æ•°å­—ã€‚</li></ul><p>JDK1.5 ä¹‹åæ–°å¢äº†enumå…³é”®å­—ï¼Œç”¨æ¥å®šä¹‰æšä¸¾ç±»ã€‚æšä¸¾ç±»æ˜¯ä¸€ç§ç‰¹æ®Šç±»ï¼Œæœ‰è‡ªå·±çš„æˆå‘˜å˜é‡ã€æ–¹æ³•ï¼Œå¯ä»¥å®ç°ä¸€ä¸ªæˆ–è€…å¤šä¸ªæ¥å£ï¼Œå¯ä»¥å®šä¹‰è‡ªå·±çš„æ„é€ å™¨ã€‚ä¸€ä¸ªJavaæºæ–‡ä»¶ä¸­æœ€å¤šåªèƒ½å®šä¸€ä¸ªpublicè®¿é—®æƒé™çš„æšä¸¾ç±»ï¼Œä¸”è¯¥Javaæºæ–‡ä»¶å¿…é¡»å’Œè¯¥æšä¸¾ç±»çš„ç±»åç›¸åŒã€‚å’Œæ™®é€šç±»åŒºåˆ«å¦‚ä¸‹ï¼š</p><ul><li>ä½¿ç”¨enumå®šä¹‰çš„é»˜è®¤æšä¸¾ç±»é»˜è®¤ç»§æ‰¿äº†java.lang.Enumç±»ã€‚å…¶ä¸­java.lang.Enumç±»å®ç°äº†java.lang.Serializableå’Œjava.lang.Comparableä¸¤ä¸ªæ¥å£ã€‚</li><li>ä½¿ç”¨enumå®šä¹‰ã€<strong>éæŠ½è±¡</strong>çš„æšä¸¾ç±»é»˜è®¤ä¼šä½¿ç”¨finalä¿®é¥°ï¼Œå› æ­¤ä¸èƒ½æ´¾ç”Ÿå­ç±»ã€‚</li><li>æšä¸¾ç±»çš„æ„é€ å™¨åªèƒ½ä½¿ç”¨privateè®¿é—®æ§åˆ¶ç¬¦ã€‚</li><li>æšä¸¾ç±»æ‰€æœ‰çš„å®ä¾‹å¿…é¡»åœ¨æšä¸¾ç±»çš„ç¬¬ä¸€è¡Œæ˜¾ç¤ºåˆ—å‡ºï¼Œå¦åˆ™è¿™ä¸ªæšä¸¾ç±»æ°¸è¿œéƒ½ä¸èƒ½äº§ç”Ÿå®ä¾‹ã€‚</li></ul><p>Javaæšä¸¾ç±»å‹åŸºæœ¬æ€æƒ³ï¼šé€šè¿‡å…¬æœ‰çš„é™æ€finalåŸŸä¸ºæ¯ä¸ªæšä¸¾å¸¸é‡åˆ°å¤„å®ä¾‹çš„ç±»ã€‚å› ä¸ºæ²¡æœ‰å¯ä»¥è®¿é—®çš„æ„é€ å™¨ï¼Œæšä¸¾ç±»å‹æ˜¯çœŸæ­£çš„finalã€‚</p><h3 id="1-æšä¸¾ç±»çš„æˆå‘˜å˜é‡ã€æ–¹æ³•å’Œæ„é€ å™¨"><a href="#1-æšä¸¾ç±»çš„æˆå‘˜å˜é‡ã€æ–¹æ³•å’Œæ„é€ å™¨" class="headerlink" title="1. æšä¸¾ç±»çš„æˆå‘˜å˜é‡ã€æ–¹æ³•å’Œæ„é€ å™¨"></a>1. æšä¸¾ç±»çš„æˆå‘˜å˜é‡ã€æ–¹æ³•å’Œæ„é€ å™¨</h3><p>æšä¸¾ç±»ä¹Ÿæ˜¯ä¸€ç§æ¯”è¾ƒç‰¹æ®Šçš„ç±»ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public enum Gender&#123;</span><br><span class="line">    MALE(&quot;ç”·&quot;),FEMALE(&quot;å¥³&quot;);</span><br><span class="line">    private final String name;</span><br><span class="line">    private Gender(String name)&#123;</span><br><span class="line">        this.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    public String getName()&#123;</span><br><span class="line">        return this.name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç å¯ä»¥çœ‹å‡ºï¼Œæšä¸¾ç±»ä¸­åˆ—å‡ºæšä¸¾å€¼æ—¶ï¼Œå®é™…ä¸Šå°±æ˜¯è°ƒç”¨æ„é€ å™¨åˆ›å»ºæšä¸¾ç±»å¯¹è±¡ï¼Œåªæ˜¯è¿™é‡Œä¸æ˜¯ä½¿ç”¨newå…³é”®å­—ï¼Œä¹Ÿæ— éœ€æ˜¾å¼è°ƒç”¨æ„é€ å™¨ã€‚</p><p>ä¸Šé¢<code>MALE(&quot;ç”·&quot;),FEMALE(&quot;å¥³&quot;)</code>ç­‰åŒäº<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">public static void final Gender MALE = new Gender(&quot;ç”·&quot;)ï¼›</span><br><span class="line">public static void final Gender FEMALE = new Gender(&quot;å¥³&quot;)ï¼›</span><br></pre></td></tr></table></figure></p><h3 id="2-å®ç°æ¥å£çš„æšä¸¾ç±»"><a href="#2-å®ç°æ¥å£çš„æšä¸¾ç±»" class="headerlink" title="2. å®ç°æ¥å£çš„æšä¸¾ç±»"></a>2. å®ç°æ¥å£çš„æšä¸¾ç±»</h3><p>æ¥å£ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public interface GenderDesc&#123;</span><br><span class="line">    void info();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å®ç°ç±»ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public enum Gender&#123;</span><br><span class="line">    MALE(&quot;ç”·&quot;)&#123;</span><br><span class="line">        public void info()&#123;</span><br><span class="line">            System.out.println(&quot;men&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,FEMALE(&quot;å¥³&quot;)&#123;</span><br><span class="line">        public void info()&#123;</span><br><span class="line">            System.out.println(&quot;women&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    private final String name;</span><br><span class="line">    private Gender(String name)&#123;</span><br><span class="line">        this.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    public String getName()&#123;</span><br><span class="line">        return this.name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><strong>æ³¨ï¼š</strong>å¹¶éæ‰€æœ‰çš„æšä¸¾ç±»éƒ½ä½¿ç”¨finalä¿®é¥°ï¼ŒéæŠ½è±¡çš„æšä¸¾ç±»æ‰é»˜è®¤ä½¿ç”¨finalä¿®é¥°ã€‚å¯¹äºä¸€ä¸ªæŠ½è±¡çš„æšä¸¾ç±»ï¼Œç³»ç»Ÿé»˜è®¤ä½¿ç”¨abstractä¿®é¥°ï¼Œè€Œä¸æ˜¯finalã€‚</p><h3 id="3-åŒ…å«æŠ½è±¡æ–¹æ³•çš„æŠ½è±¡ç±»"><a href="#3-åŒ…å«æŠ½è±¡æ–¹æ³•çš„æŠ½è±¡ç±»" class="headerlink" title="3. åŒ…å«æŠ½è±¡æ–¹æ³•çš„æŠ½è±¡ç±»"></a>3. åŒ…å«æŠ½è±¡æ–¹æ³•çš„æŠ½è±¡ç±»</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">public enum Operation&#123;</span><br><span class="line"></span><br><span class="line">    PLUS&#123;</span><br><span class="line">        public double eval(double x, double y)&#123;</span><br><span class="line">            return x+y;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    MINUS&#123;</span><br><span class="line">        public double eval(double x, double y)&#123;</span><br><span class="line">            return x-y;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    TIMES&#123;</span><br><span class="line">        public double eval(double x, double y)&#123;</span><br><span class="line">            return x*y;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    DIVIDE&#123;</span><br><span class="line">        public double eval(double x, double y)&#123;</span><br><span class="line">            return x/y;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    public abstract double eval(double x, double y);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å¼•ç”¨"><a href="#å¼•ç”¨" class="headerlink" title="å¼•ç”¨"></a>å¼•ç”¨</h2><p><a href="https://book.douban.com/subject/3246499/" target="_blank" rel="noopener">ç–¯ç‹‚Javaè®²ä¹‰</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;Javaæšä¸¾ç±»ç¬”è®°ï¼Œæ‘˜è‡ªã€Šç–¯ç‹‚Javaè®²ä¹‰ã€‹&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;æšä¸¾ç±»&quot;&gt;&lt;a href=&quot;#æšä¸¾ç±»&quot; class=&quot;headerlink&quot; title=&quot;æšä¸¾ç±»&quot;&gt;&lt;/a&gt;æšä¸¾ç±»&lt;/h2&gt;&lt;p&gt;åœ¨æ—©æœŸä»£ç ä¸­ï¼Œå¯èƒ½
      
    
    </summary>
    
    
      <category term="Java" scheme="https://zhongyp.me/tags/Java/"/>
    
      <category term="ç¬”è®°" scheme="https://zhongyp.me/tags/%E7%AC%94%E8%AE%B0/"/>
    
  </entry>
  
  <entry>
    <title>Java Serializable</title>
    <link href="https://zhongyp.me/java/2019-04-27-java-serializable/"/>
    <id>https://zhongyp.me/java/2019-04-27-java-serializable/</id>
    <published>2019-04-26T16:00:00.000Z</published>
    <updated>2019-06-26T02:46:34.471Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>Javaåºåˆ—åŒ–ç¬”è®°ï¼Œæ‘˜è‡ªã€Šç–¯ç‹‚Javaè®²ä¹‰ã€‹</p></blockquote><h2 id="Java-åºåˆ—åŒ–"><a href="#Java-åºåˆ—åŒ–" class="headerlink" title="Java åºåˆ—åŒ–"></a>Java åºåˆ—åŒ–</h2><h3 id="1-åºåˆ—åŒ–çš„å«ä¹‰å’Œæ„ä¹‰"><a href="#1-åºåˆ—åŒ–çš„å«ä¹‰å’Œæ„ä¹‰" class="headerlink" title="1.åºåˆ—åŒ–çš„å«ä¹‰å’Œæ„ä¹‰"></a>1.åºåˆ—åŒ–çš„å«ä¹‰å’Œæ„ä¹‰</h3><p>å¯¹è±¡åºåˆ—åŒ–æŒ‡å°†ä¸€ä¸ªJavaå¯¹è±¡å†™å…¥IOæµä¸­ã€‚<br>å¯¹è±¡æ”¯æŒåºåˆ—åŒ–åˆ™å¿…é¡»è®©å®ƒçš„ç±»æ˜¯å¯åºåˆ—åŒ–çš„ã€‚è¯¥ç±»å¿…é¡»å®ç°å¦‚ä¸‹ä¸¤ä¸ªæ¥å£ä¹‹ä¸€</p><ul><li><code>Serializable</code></li><li><code>Externalizable</code></li></ul><p>å»ºè®®ï¼šJavaBeanç±»éƒ½å®ç°Serializableã€‚</p><h3 id="2-ä½¿ç”¨å¯¹è±¡æµå®ç°åºåˆ—åŒ–"><a href="#2-ä½¿ç”¨å¯¹è±¡æµå®ç°åºåˆ—åŒ–" class="headerlink" title="2.ä½¿ç”¨å¯¹è±¡æµå®ç°åºåˆ—åŒ–"></a>2.ä½¿ç”¨å¯¹è±¡æµå®ç°åºåˆ—åŒ–</h3><ul><li>ååºåˆ—åŒ–è¯»å–çš„ä»…ä»…æ˜¯Javaå¯¹è±¡çš„æ•°æ®ï¼Œè€Œä¸æ˜¯Javaç±»ï¼Œå› æ­¤é‡‡ç”¨ååºåˆ—åŒ–æ¢å¤Javaå¯¹è±¡æ—¶ï¼Œå¿…é¡»æä¾›è¯¥Javaå¯¹è±¡æ‰€å±ç±»çš„classæ–‡ä»¶ï¼Œå¦åˆ™å°†ä¼šå¼•å‘ClassNotFoundExceptionå¼‚å¸¸ã€‚</li><li>ååºåˆ—åŒ–æ— éœ€é€šè¿‡æ„é€ å™¨æ¥åˆå§‹åŒ–Javaå¯¹è±¡ã€‚</li><li>å¦‚æœä½¿ç”¨åºåˆ—åŒ–æœºåˆ¶å‘æ–‡ä»¶ä¸­å†™å…¥äº†å¤šä¸ªJavaå¯¹è±¡ï¼Œä½¿ç”¨ååºåˆ—åŒ–æœºåˆ¶æ¢å¤å¯¹è±¡æ—¶å¿…é¡»æŒ‰å®é™…å†™å…¥é¡ºåºè¯»å–ã€‚</li><li>å½“ä¸€ä¸ªå¯åºåˆ—åŒ–ç±»æœ‰å¤šä¸ªçˆ¶ç±»æ—¶ï¼Œè¿™äº›çˆ¶ç±»è¦ä¹ˆæœ‰æ— å‚æ•°æ„é€ å™¨ï¼Œè¦ä¹ˆä¹Ÿæ˜¯å¯åºåˆ—åŒ–çš„ï¼Œå¦åˆ™æŠ›å‡ºInvalidClassExceptionã€‚</li><li>å¦‚æœçˆ¶ç±»æ—¶ä¸å¯åºåˆ—åŒ–çš„ï¼Œåªå¸¦æœ‰æ— å‚æ•°æ„é€ å™¨ï¼Œåˆ™è¯¥çˆ¶ç±»ä¸­å®šä¹‰çš„æˆå‘˜å˜é‡å€¼ä¸ä¼šåºåˆ—åŒ–åˆ°äºŒè¿›åˆ¶æµä¸­ã€‚ï¼ˆååºåˆ—åŒ–æ—¶ä¼šè°ƒç”¨çˆ¶ç±»çš„æ— å‚æ„é€ å™¨ï¼Œé‡æ–°å®ä¾‹åŒ–çˆ¶ç±»å¯¹è±¡ï¼‰</li></ul><h3 id="3-å¯¹è±¡å¼•ç”¨çš„åºåˆ—åŒ–"><a href="#3-å¯¹è±¡å¼•ç”¨çš„åºåˆ—åŒ–" class="headerlink" title="3.å¯¹è±¡å¼•ç”¨çš„åºåˆ—åŒ–"></a>3.å¯¹è±¡å¼•ç”¨çš„åºåˆ—åŒ–</h3><p>Javaåºåˆ—åŒ–æœºåˆ¶ç®—æ³•ï¼š</p><ul><li>æ‰€æœ‰ä¿å­˜åˆ°ç£ç›˜ä¸­çš„å¯¹è±¡éƒ½æœ‰ä¸€ä¸ªåºåˆ—åŒ–ç¼–å·ã€‚</li><li>å½“ç¨‹åºè¯•å›¾åºåˆ—åŒ–ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œç¨‹åºå°†å…ˆæ£€æŸ¥è¯¥å¯¹è±¡æ˜¯å¦å·²ç»è¢«åºåˆ—åŒ–è¿‡ï¼Œåªæœ‰è¯¥å¯¹è±¡ä»æœªè¢«åºåˆ—åŒ–è¿‡ï¼Œç³»ç»Ÿæ‰ä¼šå°†è¯¥å¯¹è±¡è½¬æ¢æˆå­—èŠ‚åºåˆ—å¹¶è¾“å‡ºã€‚</li><li>å¦‚æœæŸä¸ªå¯¹è±¡å·²ç»åºåˆ—åŒ–è¿‡ï¼Œç¨‹åºå°†ç›´æ¥è¾“å‡ºä¸€ä¸ªåºåˆ—åŒ–ç¼–å·ï¼Œè€Œä¸æ˜¯å†æ¬¡é‡æ–°åºåˆ—åŒ–è¯¥å¯¹è±¡ã€‚</li></ul><p>æ³¨ï¼šå½“ç¨‹åºåºåˆ—åŒ–ä¸€ä¸ªå¯å˜å¯¹è±¡æ—¶ï¼Œåªæœ‰ç¬¬ä¸€æ¬¡writeObject()æ–¹æ³•è¾“å‡ºæ—¶æ‰ä¼šå°†è¯¥å¯¹è±¡è½¬æ¢æˆå­—èŠ‚åºåˆ—å¹¶è¾“å‡ºï¼Œå½“å†æ¬¡è°ƒç”¨writeObject()æ–¹æ³•æ—¶ï¼Œç¨‹åºåªæ˜¯è¾“å‡ºå‰é¢çš„åºåˆ—åŒ–ç¼–å·ï¼Œå³ä½¿åé¢è¯¥å¯¹è±¡çš„å®ä¾‹å˜é‡å€¼å·²è¢«æ”¹å˜ï¼Œæ”¹å˜çš„å®ä¾‹å˜é‡å€¼ä¹Ÿä¸ä¼šè¢«è¾“å‡ºã€‚</p><h3 id="4-è‡ªå®šä¹‰åºåˆ—åŒ–"><a href="#4-è‡ªå®šä¹‰åºåˆ—åŒ–" class="headerlink" title="4.è‡ªå®šä¹‰åºåˆ—åŒ–"></a>4.è‡ªå®šä¹‰åºåˆ—åŒ–</h3><blockquote><p>å½“å¯¹æŸä¸ªå¯¹è±¡è¿›è¡Œåºåˆ—åŒ–æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æŠŠè¯¥å¯¹è±¡çš„æ‰€æœ‰å®ä¾‹å˜é‡ä¾æ¬¡è¿›è¡Œåºåˆ—åŒ–ï¼Œå¦‚æœæŸä¸ªå®ä¾‹å˜é‡å¼•ç”¨å¦ä¸€ä¸ªå¯¹è±¡ï¼Œåˆ™è¢«å¼•ç”¨çš„å¯¹è±¡ä¹Ÿä¼šè¢«åºåˆ—åŒ–ï¼›å¦‚æœè¢«å¼•ç”¨çš„å¯¹è±¡å®ä¾‹å˜é‡ä¹Ÿå¼•ç”¨äº†å…¶ä»–å¯¹è±¡ï¼Œåˆ™è¢«å¼•ç”¨çš„å¯¹è±¡ä¹Ÿä¼šè¢«åºåˆ—åŒ–ï¼Œè¿™ç§æƒ…å†µè¢«ç§°ä¸ºé€’å½’åºåˆ—åŒ–ã€‚</p></blockquote><h4 id="4-1-transientå…³é”®å­—"><a href="#4-1-transientå…³é”®å­—" class="headerlink" title="4.1 transientå…³é”®å­—"></a>4.1 transientå…³é”®å­—</h4><p>åœ¨å®ä¾‹å˜é‡å‰ä½¿ç”¨transientå…³é”®å­—ä¿®é¥°ï¼Œå¯ä»¥æŒ‡å®šJavaåºåˆ—åŒ–æ—¶æ— éœ€ç†ä¼šè¯¥å®ä¾‹å˜é‡ã€‚<br>transientå…³é”®å­—åªèƒ½ç”¨äºä¿®é¥°å®ä¾‹å˜é‡ï¼Œä¸èƒ½ç”¨äºä¿®é¥°Javaç¨‹åºä¸­çš„å…¶ä»–æˆåˆ†ã€‚<br>transientå…³é”®å­—ä¿®é¥°å®ä¾‹å˜é‡å°†è¢«å®Œå…¨éš”ç¦»åœ¨åºåˆ—åŒ–æœºåˆ¶ä¹‹å¤–ï¼Œè¿™æ ·å¯¼è‡´åœ¨ååºåˆ—åŒ–æ¢å¤Javaå¯¹è±¡æ—¶æ— æ³•å–å¾—è¯¥å®ä¾‹çš„å˜é‡å€¼ã€‚</p><h4 id="4-2-è‡ªå®šä¹‰åºåˆ—åŒ–"><a href="#4-2-è‡ªå®šä¹‰åºåˆ—åŒ–" class="headerlink" title="4.2 è‡ªå®šä¹‰åºåˆ—åŒ–"></a>4.2 è‡ªå®šä¹‰åºåˆ—åŒ–</h4><p>åœ¨ç±»ä¸­æä¾›å¦‚ä¸‹æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•ç”¨ä»¥å®ç°è‡ªå®šä¹‰åºåˆ—åŒ–ã€‚</p><ul><li><code>private void writeObject(java.io.ObjectOutputStream out)throws IOException</code></li><li><code>private void readObject(java.io.ObjectInputStream in)throws IOException,ClassNotFoundException</code></li><li><code>private void readObjectNoData()throws ObjectStreamException</code></li></ul><p>æ³¨ï¼šwriteObjectçš„é¡ºåºä¸readObjectçš„é¡ºåºä¸€è‡´ï¼Œå¦åˆ™ä¸èƒ½æ­£å¸¸æ¢å¤Javaå¯¹è±¡ã€‚</p><p>writeReplaceæ–¹æ³•ç”±åºåˆ—åŒ–æœºåˆ¶è°ƒç”¨ï¼Œåªè¦è¯¥æ–¹æ³•å­˜åœ¨ã€‚åœ¨åºåˆ—åŒ–æŸä¸ªå¯¹è±¡å‰ï¼Œå…ˆè°ƒç”¨è¯¥å¯¹è±¡writeReplace()æ–¹æ³•ï¼Œå¦‚æœè¯¥æ–¹æ³•è¿”å›å¦ä¸€ä¸ªJavaå¯¹è±¡ï¼Œåˆ™ç³»ç»Ÿè½¬åŒ–åºåˆ—åŒ–å¦ä¸€ä¸ªå¯¹è±¡ã€‚<br>ä¸writeReplaceæ–¹æ³•ç›¸å¯¹çš„æ˜¯ï¼ŒreadResolve()ï¼Œè¿™ä¸ªæ–¹æ³•åœ¨readObject()åè¢«è°ƒç”¨ï¼Œè¯¥æ–¹æ³•çš„è¿”å›å€¼å°†ä»£æ›¿åŸæ¥ååºåˆ—åŒ–çš„å¯¹è±¡ï¼ŒåŸæ¥çš„å¯¹è±¡è¢«ä¸¢å¼ƒã€‚<br>readResolve()åœ¨åºåˆ—åŒ–å•ä¾‹ç±»å’Œæšä¸¾ç±»æ—¶å°¤å…¶æœ‰ç”¨ã€‚æ‰€æœ‰çš„å•ä¾‹ç±»å’Œæšä¸¾ç±»åœ¨å®ç°åºåˆ—åŒ–æ—¶éƒ½åº”è¯¥æä¾›readResolveæ–¹æ³•ï¼Œè¿™æ ·æ‰èƒ½ä¿è¯ååºåˆ—åŒ–çš„æ­£å¸¸ã€‚</p><h3 id="5-è‡ªå®šä¹‰åºåˆ—åŒ–æœºåˆ¶"><a href="#5-è‡ªå®šä¹‰åºåˆ—åŒ–æœºåˆ¶" class="headerlink" title="5.è‡ªå®šä¹‰åºåˆ—åŒ–æœºåˆ¶"></a>5.è‡ªå®šä¹‰åºåˆ—åŒ–æœºåˆ¶</h3><p>Javaé™¤äº†Serializableï¼Œè¿˜æä¾›äº†å¦ä¸€ç§åºåˆ—åŒ–æœºåˆ¶ï¼Œè¿™ç§åºåˆ—åŒ–æ–¹å¼å®Œå…¨ç”±ç¨‹åºå‘˜å†³å®šå­˜å‚¨å’Œæ¢å¤å¯¹è±¡æ•°æ®ã€‚è¦å®ç°è¯¥ç›®æ ‡ï¼ŒJavaå¿…é¡»å®ç°Externalizableæ¥å£ï¼Œæ¥å£ä¸­æ–¹æ³•å¦‚ä¸‹ï¼š</p><ul><li><code>void readExternal(ObjectInput in)</code>ï¼šéœ€è¦å®ç°readExternalæ–¹æ³•å®ç°ååºåˆ—åŒ–ã€‚</li><li><code>void writeExternal(ObjectOutput out)</code>ï¼šéœ€è¦å®ç°writeExternalæ–¹æ³•æ¥ä¿å­˜å¯¹è±¡çŠ¶æ€ã€‚</li></ul><p>ä¸¤ç§åºåˆ—åŒ–æœºåˆ¶çš„å¯¹æ¯”ï¼š</p><p>Serializable</p><ul><li>ç³»ç»Ÿè‡ªåŠ¨ä¿å­˜å¿…è¦ä¿¡æ¯</li><li>Javaå†…å»ºæ”¯æŒï¼Œæ˜“äºå®ç°ï¼Œåªéœ€å®ç°è¯¥æ¥å£å³å¯ï¼Œæ— éœ€ä»»ä½•ä»£ç æ”¯æŒï¼ˆä¹Ÿå¯ä»¥è‡ªå®šä¹‰ï¼‰</li><li>æ€§èƒ½ç•¥å·®</li></ul><p>Externalizable</p><ul><li>ç¨‹åºå‘˜å†³å®šå­˜å‚¨å“ªäº›ä¿¡æ¯</li><li>ä»…ä»…æä¾›ç©ºæ–¹æ³•ï¼Œå¿…é¡»è‡ªå®šä¹‰å®ç°åºåˆ—åŒ–</li><li>æ€§èƒ½ç•¥é«˜</li></ul><blockquote><p><strong>æ³¨æ„</strong></p><ul><li>å¯¹è±¡çš„ç±»åã€å±æ€§ï¼ˆåŸºæœ¬ç±»å‹ã€æ•°ç»„ã€å¯¹å…¶ä»–å¯¹è±¡çš„å¼•ç”¨ï¼‰éƒ½ä¼šè¢«åºåˆ—åŒ–ï¼›æ–¹æ³•ã€staticå±æ€§ã€transientå±æ€§éƒ½ä¸ä¼šè¢«åºåˆ—åŒ–ã€‚</li><li>å®ç°Serializableæ¥å£çš„ç±»å¦‚æœéœ€è¦æƒ³è®©æŸä¸ªå±æ€§ä¸è¢«åºåˆ—åŒ–ï¼Œå¯åœ¨å±æ€§å‰åŠ transientä¿®é¥°ç¬¦ï¼Œè€Œä¸æ˜¯åŠ staticã€‚</li><li>ä¿è¯åºåˆ—åŒ–å¯¹è±¡çš„å±æ€§çš„ç±»å‹ä¹Ÿæ˜¯å¯åºåˆ—åŒ–çš„ï¼Œå¦åˆ™éœ€è¦ä½¿ç”¨transientå…³é”®å­—æ¥ä¿®é¥°è¯¥å±æ€§ï¼Œè¦ä¸ç„¶ï¼Œåˆ™è¯¥ç±»æ˜¯ä¸å¯åºåˆ—åŒ–çš„ã€‚</li><li>ååºåˆ—åŒ–å¯¹è±¡æ—¶å¿…é¡»æœ‰åºåˆ—åŒ–å¯¹è±¡çš„classæ–‡ä»¶ã€‚</li></ul></blockquote><h3 id="6-ç‰ˆæœ¬"><a href="#6-ç‰ˆæœ¬" class="headerlink" title="6.ç‰ˆæœ¬"></a>6.ç‰ˆæœ¬</h3><p>ååºåˆ—åŒ–Javaå¯¹è±¡æ—¶å¿…é¡»æä¾›è¯¥å¯¹è±¡çš„classæ–‡ä»¶ï¼Œå¦‚æœé¡¹ç›®å‡çº§ï¼ŒJavaå¦‚ä½•ä¿è¯ä¸¤ä¸ªclassæ–‡ä»¶çš„å…¼å®¹æ€§ï¼Ÿ</p><p>Javaåºåˆ—åŒ–æœºåˆ¶å…è®¸ä¸ºåºåˆ—åŒ–ç±»æä¾›ä¸€ä¸ªprivate static finalçš„serialVersionUIDå±æ€§å€¼ï¼Œè¯¥å±æ€§å€¼ç”¨äºè¡¨ç¤ºè¯¥Javaç±»çš„åºåˆ—åŒ–ç‰ˆæœ¬ã€‚</p><ul><li>å¦‚æœä¿®æ”¹ç±»æ—¶ä»…ä»…ä¿®æ”¹äº†æ–¹æ³•ï¼Œåˆ™ååºåˆ—åŒ–å®Œå…¨ä¸å—ä»»ä½•å½±å“ï¼Œç±»å®šä¹‰æ— éœ€ä¿®æ”¹serialVersionUIDçš„å±æ€§å€¼ã€‚</li><li>å¦‚æœä¿®é¥°ç±»æ—¶ä»…ä»…ä¿®æ”¹äº†é™æ€å±æ€§æˆ–ç¬æ€å±æ€§ï¼Œåˆ™ååºåŒ–ä¸å—ä»»ä½•å½±å“ï¼Œç±»å®šä¹‰æ— éœ€ä¿®æ”¹serialVersionUIDå±æ€§å€¼ã€‚</li><li>å¦‚æœä¿®æ”¹ç±»æ—¶ä¿®é¥°äº†éé™æ€ã€éç¬æ€å±æ€§ï¼Œåˆ™å¯èƒ½å¯¼è‡´åºåˆ—åŒ–ç‰ˆæœ¬ä¸å…¼å®¹ï¼Œå¦‚æœå¯¹è±¡æµä¸­çš„å¯¹è±¡å’Œæ–°ç±»ä¸­åŒ…å«åŒåçš„å±æ€§ï¼Œè€Œå±æ€§ç±»å‹ä¸åŒï¼Œåˆ™ååºåˆ—åŒ–å¤±è´¥ï¼Œç±»å®šä¹‰åº”è¯¥æ›´æ–°serialVersionUIDå±æ€§å€¼ã€‚å¦‚æœå¯¹è±¡æµä¸­å¯¹è±¡æ¯”æ–°ç±»ä¸­åŒ…å«æ›´å¤šçš„å±æ€§ï¼Œåˆ™å¤šå¤„çš„å±æ€§å€¼è¢«å¿½ç•¥ï¼Œåºåˆ—åŒ–ç‰ˆæœ¬å¯ä»¥å…¼å®¹ï¼Œç±»å®šä¹‰å¯ä»¥ä¸æ›´æ–°serialVersionUIDå±æ€§å€¼ï¼›ä½†ååºåˆ—åŒ–å¾—åˆ°çš„æ–°å¯¹è±¡ä¸­å¤šå¤„çš„å±æ€§å€¼éƒ½æ˜¯nullï¼ˆå¼•ç”¨ç±»å‹å±æ€§ï¼‰æˆ–0ï¼ˆåŸºæœ¬ç±»å‹å±æ€§ï¼‰ã€‚</li></ul><h2 id="å¼•ç”¨"><a href="#å¼•ç”¨" class="headerlink" title="å¼•ç”¨"></a>å¼•ç”¨</h2><p><a href="https://book.douban.com/subject/3246499/" target="_blank" rel="noopener">ç–¯ç‹‚Javaè®²ä¹‰</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;Javaåºåˆ—åŒ–ç¬”è®°ï¼Œæ‘˜è‡ªã€Šç–¯ç‹‚Javaè®²ä¹‰ã€‹&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;Java-åºåˆ—åŒ–&quot;&gt;&lt;a href=&quot;#Java-åºåˆ—åŒ–&quot; class=&quot;headerlink&quot; title=&quot;Java åºåˆ—åŒ–&quot;&gt;&lt;/a&gt;Java 
      
    
    </summary>
    
    
      <category term="Java" scheme="https://zhongyp.me/tags/Java/"/>
    
      <category term="ç¬”è®°" scheme="https://zhongyp.me/tags/%E7%AC%94%E8%AE%B0/"/>
    
  </entry>
  
  <entry>
    <title>Spring Transaction Management(è¯‘æ–‡)</title>
    <link href="https://zhongyp.me/transaction/2019-03-07-spring-transaction-management/"/>
    <id>https://zhongyp.me/transaction/2019-03-07-spring-transaction-management/</id>
    <published>2019-03-06T16:00:00.000Z</published>
    <updated>2019-06-26T06:02:34.284Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Spring-äº‹åŠ¡ç®¡ç†"><a href="#Spring-äº‹åŠ¡ç®¡ç†" class="headerlink" title="Spring äº‹åŠ¡ç®¡ç†"></a>Spring äº‹åŠ¡ç®¡ç†</h1><p>ç¿»è¯‘è‡ª<a href="https://docs.spring.io/spring/docs/4.2.x/spring-framework-reference/html/transaction.html#transaction-motivation" target="_blank" rel="noopener">spring/docs/4.2.x</a></p><p>ç¿»è¯‘è¿‡ç¨‹ä¸­ä½¿ç”¨å·¥å…·ï¼šgoogleç¿»è¯‘ï¼Œæ¬§è·¯è¯å…¸</p><p>åè¯è§£é‡Šï¼š<br>JTAï¼šJava Transaction API<br>JPAï¼šJava Persistence API<br>JDOï¼šJava Data Object<br>CMTï¼š Container Managed Transactions<br>JNDIï¼šJava Naming and Directory Interface<br>JMSï¼š Java Message Service<br>JCAï¼š Java EE Connector Architecture</p><h2 id="1-äº‹åŠ¡ç®¡ç†"><a href="#1-äº‹åŠ¡ç®¡ç†" class="headerlink" title="1. äº‹åŠ¡ç®¡ç†"></a>1. äº‹åŠ¡ç®¡ç†</h2><h2 id="1-1-Springæ¡†æ¶äº‹åŠ¡ç®¡ç†ä»‹ç»"><a href="#1-1-Springæ¡†æ¶äº‹åŠ¡ç®¡ç†ä»‹ç»" class="headerlink" title="1.1 Springæ¡†æ¶äº‹åŠ¡ç®¡ç†ä»‹ç»"></a>1.1 Springæ¡†æ¶äº‹åŠ¡ç®¡ç†ä»‹ç»</h2><p>å…¨æ–¹é¢çš„äº‹åŠ¡æ”¯æŒæ˜¯ä½¿ç”¨Springæ¡†æ¶çš„æœ€å¼•äººæ³¨ç›®çš„åŸå› ä¹‹ä¸€ã€‚Springæ¡†æ¶ä¸ºäº‹åŠ¡ç®¡ç†æä¾›ä¸€è‡´æ€§æŠ½è±¡æä¾›äº†å¦‚ä¸‹å¥½å¤„ï¼š</p><ul><li>ä¸€è‡´æ€§ç¼–ç¨‹æ¨¡å‹æ¨ªè·¨ä¸åŒçš„äº‹åŠ¡APIsï¼Œä¾‹å¦‚ JTAï¼ŒJPAï¼ŒJDOã€‚</li><li>æ”¯æŒå£°æ˜å¼äº‹åŠ¡ç®¡ç†</li><li>å’Œå¤æ‚ç¼–ç¨‹äº‹åŠ¡APIsï¼ˆä¾‹å¦‚JTAï¼‰ç›¸æ¯”ï¼ŒSpringæä¾›æ›´ç®€å•çš„ç¼–ç¨‹äº‹åŠ¡ç®¡ç†çš„APIã€‚</li><li>ä¸Springçš„æ•°æ®è®¿é—®æŠ½è±¡æœ‰è‰¯å¥½çš„é›†æˆã€‚</li></ul><p>ä¸‹é¢çš„éƒ¨åˆ†æè¿°Springæ¡†æ¶çš„äº‹åŠ¡value-addså’ŒæŠ€æœ¯ã€‚(è¿™éƒ¨åˆ†ä¹ŸåŒ…å«å¯¹äºæœ€å¥½äº‹åŠ¡ç®¡ç†çš„å®è·µï¼Œåº”ç”¨æœåŠ¡å™¨é›†æˆå’Œå¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆçš„è®¨è®º)</p><ul><li><a href="#1-2-Springæ¡†æ¶äº‹åŠ¡æ”¯æŒæ¨¡å‹çš„ä¼˜åŠ¿">Springæ¡†æ¶äº‹åŠ¡æ”¯æŒæ¨¡å‹çš„ä¼˜åŠ¿</a>æè¿°ä½ ä¸ºä»€ä¹ˆä¼šä½¿ç”¨Springæ¡†æ¶çš„äº‹åŠ¡æŠ½è±¡ï¼Œè€Œä¸æ˜¯é€‰æ‹©EJBçš„å®¹å™¨ç®¡ç†äº‹åŠ¡æˆ–è€…é€šè¿‡ä¸“æœ‰çš„APIï¼ˆä¾‹å¦‚Hibernateï¼‰é©±åŠ¨æœ¬åœ°äº‹åŠ¡ã€‚</li><li><a href="#1-3-ç†è§£Springæ¡†æ¶äº‹åŠ¡æŠ½è±¡">ç†è§£Springæ¡†æ¶çš„äº‹åŠ¡æŠ½è±¡</a>æ¦‚è¿°æ ¸å¿ƒç±»å’Œæè¿°æ€æ ·é…ç½®å’Œæ€æ ·ä»å„ç§ç±»å‹çš„æ•°æ®æºä¸­è·å–æ•°æ®æºã€‚</li><li><a href="#1-4-å°†èµ„æºä¸äº‹åŠ¡åŒæ­¥">å°†èµ„æºä¸äº‹åŠ¡åŒæ­¥</a>æè¿°åº”ç”¨ä»£ç æ€æ ·ç¡®ä¿èµ„æºçš„åˆ›å»ºï¼Œå¤ç”¨å’Œæ­£ç¡®çš„æ¸…ç†ã€‚</li><li><a href="#1-5-å£°æ˜å¼äº‹åŠ¡ç®¡ç†">å£°æ˜å¼äº‹åŠ¡ç®¡ç†</a>æè¿°æ”¯æŒå£°æ˜å¼äº‹åŠ¡ç®¡ç†ã€‚</li><li><a href="#1-6-ç¼–ç¨‹äº‹åŠ¡ç®¡ç†">ç¼–ç¨‹äº‹åŠ¡ç®¡ç†</a>åŒ…å«æ”¯æŒç¼–ç¨‹äº‹åŠ¡ç®¡ç†ã€‚</li><li><a href="#1-8-äº‹åŠ¡çº¦æŸäº‹ä»¶">äº‹åŠ¡çº¦æŸäº‹ä»¶</a>æè¿°ä½ å¯ä»¥æ€æ ·åœ¨äº‹åŠ¡ä¸­ä½¿ç”¨åº”ç”¨ç¨‹åºäº‹ä»¶ã€‚</li></ul><h2 id="1-2-Springæ¡†æ¶äº‹åŠ¡æ”¯æŒæ¨¡å‹çš„ä¼˜åŠ¿"><a href="#1-2-Springæ¡†æ¶äº‹åŠ¡æ”¯æŒæ¨¡å‹çš„ä¼˜åŠ¿" class="headerlink" title="1.2 Springæ¡†æ¶äº‹åŠ¡æ”¯æŒæ¨¡å‹çš„ä¼˜åŠ¿"></a>1.2 Springæ¡†æ¶äº‹åŠ¡æ”¯æŒæ¨¡å‹çš„ä¼˜åŠ¿</h2><p>ä¼ ç»Ÿä¸Šï¼ŒJava EEçš„å¼€å‘è€…å¯¹äºäº‹åŠ¡ç®¡ç†æœ‰ä¸¤ç§é€‰æ‹©ï¼šå…¨å±€æˆ–è€…æœ¬åœ°äº‹åŠ¡ç®¡ç†ï¼Œè¿™ä¸¤ç§éƒ½æœ‰å¾ˆå¤§çš„å±€é™æ€§ã€‚å…¨å±€å’Œæœ¬åœ°äº‹åŠ¡ç®¡ç†å°†åœ¨ä¸‹é¢çš„ä¸¤å°èŠ‚ä¸­å›é¡¾ï¼Œæ¥ç€æ˜¯Springæ¡†æ¶ç®¡ç†æ”¯æŒè§£å†³å…¨å±€å’Œæœ¬åœ°äº‹åŠ¡ç®¡ç†æ¨¡å‹å±€é™æ€§çš„è®¨è®ºã€‚</p><h3 id="1-2-1-å…¨å±€äº‹åŠ¡"><a href="#1-2-1-å…¨å±€äº‹åŠ¡" class="headerlink" title="1.2.1 å…¨å±€äº‹åŠ¡"></a>1.2.1 å…¨å±€äº‹åŠ¡</h3><p>å…¨éƒ¨äº‹åŠ¡ç®¡ç†å…è®¸ä½ å’Œå¤šä¸ªäº‹åŠ¡èµ„æºä¸€å—è¿è¡Œï¼Œäº‹åŠ¡èµ„æºä¸€èˆ¬æ˜¯å…³ç³»å‹æ•°æ®åº“å’Œæ¶ˆæ¯é˜Ÿåˆ—ã€‚åº”ç”¨æœåŠ¡å™¨é€šè¿‡JTAç®¡ç†å…¨å±€äº‹åŠ¡ï¼ŒJTAæ˜¯ä¸€ä¸ªç”¨èµ·æ¥ç¬¨é‡çš„APIï¼ˆéƒ¨åˆ†æ˜¯ç”±äºå®ƒçš„å¼‚å¸¸æ¨¡å‹å†³å®šçš„ï¼‰ã€‚æ­¤å¤–ï¼ŒJTA<code>UserTransaction</code>æ­£å¸¸æ¥è¯´éœ€è¦JNDIå¼•å…¥èµ„æºï¼Œæ„å‘³ç€ä¸ºäº†ä½¿ç”¨JTAä½ è¿˜éœ€è¦ä½¿ç”¨JNDIã€‚æ˜¾ç„¶ï¼Œå…¨å±€äº‹åŠ¡çš„ä½¿ç”¨å°†ä¼šé™åˆ¶åº”ç”¨ä»£ç æ½œåœ¨çš„å¤ç”¨ï¼ŒåŒæ—¶JTAåªèƒ½åœ¨åº”ç”¨æœåŠ¡å™¨ç¯å¢ƒä¸­å¯ç”¨ã€‚<br>å…ˆå‰ï¼Œä½¿ç”¨å…¨å±€äº‹åŠ¡æ¯”è¾ƒå¥½çš„æ–¹å¼æ˜¯é€šè¿‡EJBçš„å®¹å™¨ç®¡ç†äº‹åŠ¡ï¼šCMTæ˜¯ä¸€å¼ å£°æ˜å¼äº‹åŠ¡ç®¡ç†è¡¨ï¼ˆå¯¹äºç¼–ç¨‹äº‹åŠ¡ç®¡ç†ä¹ŸåŒæ ·å¥½ç”¨ï¼‰ã€‚EJB CMTåˆ é™¤äº†å…³è”äº‹åŠ¡JNDIçš„æŸ¥æ‰¾ï¼Œå°½ç®¡EJBè‡ªå·±å¿…é¡»è¦ä½¿ç”¨JNDIã€‚å®ƒæ¶ˆé™¤äº†ç¼–å†™Javaä»£ç ä»¥æ§åˆ¶äº‹åŠ¡çš„å¤§éƒ¨åˆ†ä½†ä¸æ˜¯å…¨éƒ¨çš„éœ€è¦ã€‚CMTæœ€å¤§çš„ç¼ºé™·æ˜¯æ†ç»‘JTAå’Œåº”ç”¨çš„æœåŠ¡å™¨ç¯å¢ƒã€‚åŒæ—¶ï¼ŒCMTåªæœ‰åœ¨EJBsé‡Œå®ç°ä¸šåŠ¡é€»è¾‘æ‰å¯ç”¨ï¼Œæˆ–è€…è‡³å°‘åœ¨ä¸€ä¸ªäº‹åŠ¡EJB facadeä¹‹å‰ã€‚é€šå¸¸EJBçš„è´Ÿé¢å½±å“å¤ªå¤§ä»¥è‡´äºè¿™ä¸æ˜¯ä¸€ä¸ªæœ‰å¸å¼•åŠ›çš„æ–¹æ¡ˆï¼Œå°¤å…¶æ˜¯é¢å¯¹å£°æ˜å¼äº‹åŠ¡ç®¡ç†çš„å¼•äººæ³¨ç›®çš„å¤‡é€‰æ–¹æ¡ˆã€‚</p><h3 id="1-2-2-æœ¬åœ°äº‹åŠ¡"><a href="#1-2-2-æœ¬åœ°äº‹åŠ¡" class="headerlink" title="1.2.2 æœ¬åœ°äº‹åŠ¡"></a>1.2.2 æœ¬åœ°äº‹åŠ¡</h3><p>æœ¬åœ°äº‹åŠ¡æ˜¯ç‰¹å®šäºèµ„æºçš„ï¼Œæ¯”å¦‚ä¸€ä¸ªäº‹åŠ¡å…³è”ä¸€ä¸ªJDBCè¿æ¥ã€‚æœ¬åœ°äº‹åŠ¡å¯èƒ½ä½¿ç”¨ç®€å•ï¼Œä½†æ˜¯æœ‰æ˜æ˜¾çš„ç¼ºé™·ï¼šå®ƒä»¬ä¸èƒ½åœ¨å¤šä¸ªäº‹åŠ¡èµ„æºä¸Šå·¥ä½œã€‚ä¸¾ä¸ªä¾‹å­ï¼Œä½¿ç”¨JDBCè¿æ¥çš„ç®¡ç†äº‹åŠ¡ä»£ç ä¸èƒ½åœ¨å…¨å±€JTAäº‹åŠ¡ä¸­è¿è¡Œã€‚å› ä¸ºåº”ç”¨æœåŠ¡å™¨ä¸å‚ä¸äº‹åŠ¡ç®¡ç†ï¼Œå®ƒä¸èƒ½ç¡®ä¿è·¨å¤šä¸ªæ•°æ®æºçš„æ­£ç¡®æ€§ã€‚ï¼ˆå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå¤§å¤šæ•°åº”ç”¨ä½¿ç”¨å•ä¸ªäº‹åŠ¡èµ„æºï¼‰å¦ä¸€ä¸ªç¼ºé™·æ˜¯æœ¬åœ°äº‹åŠ¡åœ¨ç¼–ç¨‹æ¨¡å‹ä¸­æ˜¯ä¾µå…¥å¼çš„ã€‚</p><h3 id="1-2-3-Springæ¡†æ¶çš„ä¸€è‡´æ€§ç¼–ç¨‹æ¨¡å‹"><a href="#1-2-3-Springæ¡†æ¶çš„ä¸€è‡´æ€§ç¼–ç¨‹æ¨¡å‹" class="headerlink" title="1.2.3 Springæ¡†æ¶çš„ä¸€è‡´æ€§ç¼–ç¨‹æ¨¡å‹"></a>1.2.3 Springæ¡†æ¶çš„ä¸€è‡´æ€§ç¼–ç¨‹æ¨¡å‹</h3><p>Spring è§£å†³äº†å…¨å±€å’Œæœ¬åœ°äº‹åŠ¡çš„ç¼ºé™·ã€‚å®ƒå…è®¸ç¨‹åºå‘˜åœ¨ä»»ä½•ç¯å¢ƒä¸­ä½¿ç”¨ä¸€è‡´æ€§ç¼–ç¨‹æ¨¡å‹ã€‚ä½ å†™ä¸€æ¬¡ä»£ç ï¼Œå®ƒå¯ä»¥åœ¨ä¸åŒç¯å¢ƒä¸­çš„ä¸åŒäº‹åŠ¡ç®¡ç†ç­–ç•¥ä¸­å—ç›Šã€‚Springæ¡†æ¶æä¾›å£°æ˜å’Œç¼–ç¨‹äº‹åŠ¡ç®¡ç†ã€‚å¤§å¤šæ•°ç”¨æˆ·ä½¿ç”¨åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹è¢«æ¨èä½¿ç”¨çš„å£°æ˜å¼äº‹åŠ¡æ¨¡å‹ã€‚<br>å¯¹äºç¼–ç¨‹å¼äº‹åŠ¡ç®¡ç†ï¼Œå¼€å‘è€…å°†ä½¿ç”¨Spring æ¡†æ¶çš„äº‹åŠ¡æŠ½è±¡ï¼Œå®ƒå¯ä»¥åœ¨åº•å±‚çš„äº‹åŠ¡åŸºç¡€è®¾æ–½ä¸Šè¿è¡Œã€‚å¯¹äºå£°æ˜å¼æ¨¡å‹ï¼Œå¼€å‘ç»å¸¸å†™ä¸€ç‚¹æˆ–è€…æ²¡æœ‰ä»£ç å»å…³è”äº‹åŠ¡ç®¡ç†ï¼Œå› æ­¤ä¸ä¾èµ–Springæ¡†æ¶çš„äº‹åŠ¡APIæˆ–è€…å…¶ä»–çš„äº‹åŠ¡APIã€‚</p><blockquote><p><b>å¯¹äºäº‹åŠ¡ç®¡ç†ï¼Œä½ æ˜¯å¦éœ€è¦åº”ç”¨æœåŠ¡å™¨ï¼Ÿ</b><br>Spring æ¡†æ¶äº‹åŠ¡ç®¡ç†æ”¯æŒå½“ä¼ä¸šJavaåº”ç”¨éœ€è¦åº”ç”¨æœåŠ¡å™¨æ—¶ä¿®æ”¹ä¼ ç»Ÿè§„åˆ™ã€‚<br>å°¤å…¶ï¼Œä½ åªæ˜¯éœ€è¦é€šè¿‡EJBså£°æ˜äº‹åŠ¡è€Œä¸æ˜¯éœ€è¦åº”ç”¨æœåŠ¡å™¨ã€‚äº‹å®ä¸Šï¼Œ<strong>å³ä½¿ä½ çš„åº”ç”¨æœåŠ¡å™¨æœ‰çš„JTAèƒ½</strong>åŠ›ï¼Œå¯¹æ¯”EJB CMTï¼Œä½ å¯èƒ½å†³å®šä½¿ç”¨Springæ¡†æ¶çš„å£°æ˜å¼äº‹åŠ¡æä¾›æ›´å¤šèƒ½åŠ›å’Œä¸€ä¸ªå¯Œæœ‰æˆæ•ˆçš„ç¼–ç¨‹æ¨¡å‹ã€‚<br>é€šå¸¸ä½ éœ€è¦ä½¿ç”¨åº”ç”¨æœåŠ¡å™¨çš„JTAèƒ½åŠ›ä»…ä»…å› ä¸ºä½ çš„åº”ç”¨éœ€è¦è·¨å¤šä¸ªèµ„æºå»å¤„ç†äº‹åŠ¡ï¼Œè¿™ç§æƒ…å†µå¯¹äºè®¸å¤šåº”ç”¨æ˜¯ä¸éœ€è¦çš„ï¼Œè®¸å¤šé«˜ç«¯åº”ç”¨ä½¿ç”¨ä¸€ä¸ªé«˜æ‰©å±•æ€§çš„æ•°æ®åº“ï¼ˆå¦‚ï¼šOracle RACï¼‰ä»£æ›¿å¤šä¸ªèµ„æºã€‚ç‹¬ç«‹äº‹åŠ¡ç®¡ç†å¦‚ Atomikos Transactions å’Œ JOTMæ˜¯å…¶ä»–é€‰æ‹©ã€‚å½“ç„¶ï¼Œä½ å¯èƒ½éœ€è¦å…¶ä»–åº”ç”¨æœåŠ¡å™¨èƒ½åŠ›ï¼Œå¦‚Javaæ¶ˆæ¯æœåŠ¡å’ŒJCAã€‚<br>Springæ¡†æ¶ç»™ä½ å½“éœ€è¦æ‰©å±•ä½ çš„åº”ç”¨å»å®Œæ•´åŠ è½½åº”ç”¨æœåŠ¡å™¨çš„é€‰æ‹©ï¼Œæ›¿ä»£ä½¿ç”¨EJB CMTæˆ–è€…JTAçš„å”¯ä¸€æ–¹å¼æ˜¯ä½¿ç”¨æœ¬åœ°äº‹åŠ¡ï¼ˆå¦‚ï¼šJDBCè¿æ¥ï¼‰å†™ä»£ç çš„æ—¥å­ä¸€å»ä¸å¤è¿”äº†ï¼Œå¦‚æœä½ éœ€è¦åœ¨å…¨å±€æˆ–è€…CMTä¸­è¿è¡Œè¯¥æœ¬åœ°äº‹åŠ¡ä»£ç å°†ä¼šé¢å¯¹å¤§é‡çš„è¿”å·¥ã€‚ä½¿ç”¨Springæ¡†æ¶ï¼Œä½ ä»…ä»…éœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­å®šä¹‰ä¸€äº›beanï¼Œè€Œä¸æ˜¯éœ€è¦å»ä¿®æ”¹ä»£ç ã€‚</p></blockquote><h2 id="1-3-ç†è§£Springæ¡†æ¶äº‹åŠ¡æŠ½è±¡"><a href="#1-3-ç†è§£Springæ¡†æ¶äº‹åŠ¡æŠ½è±¡" class="headerlink" title="1.3 ç†è§£Springæ¡†æ¶äº‹åŠ¡æŠ½è±¡"></a>1.3 ç†è§£Springæ¡†æ¶äº‹åŠ¡æŠ½è±¡</h2><p><strong>springæ¡†æ¶äº‹åŠ¡æŠ½è±¡çš„å…³é”®æ˜¯äº‹åŠ¡ç­–ç•¥çš„æ¦‚å¿µ</strong>ï¼Œé€šè¿‡<code>org.springframework.transaction.PlatformTransactionManager</code>æ¥å£å®šä¹‰äº‹åŠ¡ç­–ç•¥ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public interface PlatformTransactionManager&#123;</span><br><span class="line">    TransactionStatus getTransaction(TransactionDefinition) throws TransactionException;</span><br><span class="line">    void commit(TransactionStatus status) throws TransactionException;</span><br><span class="line">    void rollback(TransactionStatus status) throws TransactionException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>è¿™ä¸ªä¸»è¦æ˜¯Javaçš„æœåŠ¡æä¾›å‘ç°æœºåˆ¶ï¼Œå°½ç®¡å¯ä»¥ä»åº”ç”¨ä»£ç ä¸­ä»¥ç¼–ç¨‹æ–¹å¼ä½¿ç”¨ã€‚å› ä¸º<code>PlatformTransactionManager</code>æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ƒå¯ä»¥åœ¨è¢«éœ€è¦æ˜¯å¾ˆå®¹æ˜“çš„ä»¿åˆ¶æˆ–è€…å­˜æ ¹ã€‚å®ƒå’Œç±»ä¼¼JNDIçš„æŸ¥æ‰¾ç­–ç•¥æ— å…³ã€‚<br>å®šä¹‰<code>PlatformTransactionManager</code>çš„æ¥å£å®ç°å’Œspring IoCå®¹å™¨ä¸­çš„å…¶ä»–å¯¹è±¡ï¼ˆæˆ–beanï¼‰ç›¸åŒã€‚å³ä½¿ä½ ä½¿ç”¨JTAï¼Œä»…æ­¤ä¸€é¡¹å¥½å¤„ä¹Ÿä½¿å¾—Spingæ¡†æ¶äº‹åŠ¡å€¼å¾—è¢«æŠ½è±¡ã€‚ç›¸æ¯”äºç›´æ¥ä½¿ç”¨JTAï¼Œä½¿ç”¨Springäº‹åŠ¡æŠ½è±¡å¯ä»¥è®©æµ‹è¯•äº‹åŠ¡ä»£ç æ›´ç®€å•ã€‚<br>å¯ä»¥è¢«ä»»ä½•<code>PlatformTransactionManager</code>æ¥å£çš„å®ç°æ–¹æ³•æŠ›å‡ºçš„éæ£€æŸ¥ï¼ˆç»§æ‰¿<code>java.lang.RuntimeException</code>çš„ç±»ï¼‰çš„<code>TransactionException</code>å†æ¬¡ç¬¦åˆSpringçš„ç†å¿µã€‚äº‹åŠ¡åŸºç¡€è®¾æ–½çš„æ•…éšœå‡ ä¹æ€»æ˜¯è‡´å‘½çš„ã€‚åº”ç”¨ä»£ç åœ¨æå°‘æ•°æƒ…å†µä¸‹å¯ä»¥ä»äº‹åŠ¡å¤±è´¥ä¸­æ¢å¤ï¼Œåº”ç”¨å¼€å‘è€…å¯ä»¥é€‰æ‹©æ•è·å’Œå¤„ç†<code>TransactionException</code>ã€‚é‡ç‚¹æ˜¯å¼€å‘è€…ä¸å¿…å¼ºåˆ¶å»è¿™æ ·åšã€‚<br><code>getTransaction(..)</code>æ–¹æ³•è¿”å›<code>TransactionStatus</code>å¯¹è±¡ï¼Œä¾èµ–ä¸€ä¸ª<code>TransactionDefinition</code>å‚æ•°ã€‚è¿”å›çš„<code>Transaction</code>å¯èƒ½ä»£è¡¨ä¸€ä¸ªæ–°äº‹åŠ¡ï¼Œæˆ–è€…å¯ä»¥ä»£è¡¨ä¸€ä¸ªå·²ç»å­˜åœ¨çš„äº‹åŠ¡å¦‚æœæ­¤äº‹åŠ¡åœ¨å½“å‰è°ƒç”¨æ ˆä¸­å­˜åœ¨åŒ¹é…çš„äº‹åŠ¡ã€‚åè€…çš„æ„ä¹‰æ˜¯åœ¨Java EEäº‹åŠ¡ä¸Šä¸‹æ–‡ä¸­ï¼Œä¸€ä¸ªçº¿ç¨‹çš„æ‰§è¡Œå’Œä¸€ä¸ª<code>TransactionStatus</code>ç›¸å…³è”ã€‚<code>TransactionDefinition</code>æ¥å£æŒ‡å®šï¼š</p><ul><li>Isolation: å½“å‰äº‹åŠ¡å’Œå…¶ä»–äº‹åŠ¡åœ¨å·¥ä½œä¸­çš„éš”ç¦»ç¨‹åº¦ã€‚ä¾‹å¦‚ï¼š æ­¤äº‹åŠ¡æ˜¯å¦å¯ä»¥çœ‹åˆ°æ¥è‡ªå…¶ä»–äº‹åŠ¡çš„æœªæäº¤çš„å†™å…¥ï¼Ÿ</li><li>Propagation: é€šå¸¸ï¼Œåœ¨äº‹åŠ¡èŒƒå›´å†…è¿è¡Œçš„æ‰€æœ‰ä»£ç éƒ½å°†åœ¨æ­¤äº‹åŠ¡ä¸­è¿è¡Œã€‚ä½†æ˜¯ï¼Œä½ å¯ä»¥é€‰æ‹©åœ¨äº‹åŠ¡ä¸Šä¸‹æ–‡å·²ç»å­˜åœ¨ä¸”æ‰§è¡Œäº‹åŠ¡æ–¹æ³•çš„äº‹ä»¶ä¸­æŒ‡å®šè¡Œä¸ºã€‚ä¾‹å¦‚ï¼šä»£ç å¯ä»¥åœ¨å·²å­˜åœ¨çš„äº‹åŠ¡ä¸­ç»§ç»­è¿è¡Œï¼ˆå¸¸è§æƒ…å†µï¼‰;æˆ–è€…æŒ‚èµ·å·²å­˜åœ¨çš„äº‹åŠ¡ï¼Œæ–°å»ºäº‹åŠ¡ã€‚Springæä¾›äº†EJB CMTä¸­ç†Ÿæ‚‰çš„æ‰€æœ‰äº‹åŠ¡ä¼ æ’­é€‰æ‹©ã€‚äº†è§£Springä¸­å…³äºäº‹åŠ¡ä¼ æ’­è¯­ä¹‰ï¼Œ<a href="https://docs.spring.io/spring/docs/4.2.x/spring-framework-reference/html/transaction.html#tx-propagation" target="_blank" rel="noopener">äº‹åŠ¡ä¼ æ’­</a>ã€‚</li><li>Timeout: åœ¨è¶…æ—¶å’Œåº•å±‚äº‹åŠ¡åŸºç¡€è®¾æ–½è‡ªåŠ¨å›æ»šäº‹åŠ¡ä¹‹å‰ï¼Œäº‹åŠ¡å¯ä»¥è¿è¡Œå¤šä¹…ï¼Ÿ</li><li>Read-only status: å½“ä½ çš„ä»£ç è¯»å–ä½†æ˜¯ä¸ä¿®æ”¹æ•°æ®æ•°æ®æ—¶å¯ä»¥ä½¿ç”¨åªè¯»äº‹åŠ¡ã€‚åªè¯»äº‹åŠ¡åœ¨æŸäº›æƒ…å†µä¸‹æ˜¯æœ‰ç”¨çš„ä¼˜åŒ–ï¼Œä¾‹å¦‚å½“ä½ ä½¿ç”¨Hibernateæ—¶ã€‚</li></ul><p>è¿™äº›äº‹åŠ¡åæ˜ å‡ºäº†æ ‡å‡†çš„äº‹åŠ¡æ¦‚å¿µï¼Œå¦‚æœéœ€è¦ï¼Œè¯·å‚é˜…è®¨è®ºäº‹åŠ¡éš”ç¦»ç­‰çº§å’Œå…¶ä»–æ ¸å¿ƒäº‹åŠ¡æ¦‚å¿µçš„èµ„æºã€‚ç†è§£è¿™äº›æ¦‚å¿µå¯¹ä½¿ç”¨Springæ¡†æ¶æˆ–è€…å…¶ä»–äº‹åŠ¡ç®¡ç†çš„è§£å†³æ–¹æ¡ˆæ˜¯å¾ˆå¿…è¦çš„ã€‚</p><p><code>TransactionStatus</code>æ¥å£æä¾›ç®€å•çš„äº‹åŠ¡ä»£ç å»æ§åˆ¶äº‹åŠ¡æ‰§è¡Œå’ŒæŸ¥è¯¢äº‹åŠ¡çŠ¶æ€ã€‚è¿™äº›æ¦‚å¿µåº”è¯¥æ˜¯ç†Ÿæ‚‰çš„ï¼Œå®ƒä»¬å¯¹æ‰€æœ‰äº‹åŠ¡APIséƒ½æ˜¯é€šç”¨çš„ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public interface TransactionStatus extends SavepointManager&#123;</span><br><span class="line">    boolean isNewTransaction();</span><br><span class="line">    boolean hasSavepoint();</span><br><span class="line">    void setRollbackOnly();</span><br><span class="line">    boolean isRollbackOnly();</span><br><span class="line">    void flush();</span><br><span class="line">    boolean isCompleted();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ— è®ºä½ åœ¨Springä¸­é€‰æ‹©å£°æ˜å¼äº‹åŠ¡è¿˜æ˜¯ç¼–ç¨‹å¼äº‹åŠ¡ç®¡ç†ï¼Œå®šä¹‰æ­£ç¡®çš„<code>PlatformTransactionManager</code>å®ç°æ˜¯ç»å¯¹å¿…è¦çš„ã€‚é€šå¸¸é€šè¿‡ä¾èµ–æ³¨å…¥å®šä¹‰è¿™ä¸ªå®ç°ã€‚</p><p><code>PlatformTransactionManager</code>å®ç°é€šå¸¸éœ€è¦äº†è§£ä»–ä»¬è¿è¡Œçš„ç¯å¢ƒï¼šJDBCï¼ŒJTAï¼ŒHibernateç­‰ç­‰ã€‚ä¸‹é¢çš„ä¾‹å­å±•ç¤ºä½ æ€æ ·å®šä¹‰ä¸€ä¸ªæœ¬åœ°çš„<code>PlatformTransactionManager</code>å®ç°ã€‚ï¼ˆè¿™ä¸ªä¾‹å­é€‚ç”¨æ™®é€šçš„JDBCã€‚ï¼‰<br>å®šä¹‰ä¸€ä¸ªJDBC<code>DataSource</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;bean id=&quot;dataSource&quot; class=&quot;org.apache.commons.dbcp.BasicDataSource&quot; destroy-method=&quot;close&quot;&gt;</span><br><span class="line">    &lt;property name=&quot;driverClassName&quot; value=&quot;$&#123;jdbc.driverClassName&#125;&quot; /&gt;</span><br><span class="line">    &lt;property name=&quot;url&quot; value=&quot;$&#123;jdbc.url&#125;&quot; /&gt;</span><br><span class="line">    &lt;property name=&quot;username&quot; value=&quot;$&#123;jdbc.username&#125;&quot; /&gt;</span><br><span class="line">    &lt;property name=&quot;password&quot; value=&quot;$&#123;jdbc.password&#125;&quot; /&gt;</span><br><span class="line">&lt;/bean&gt;</span><br></pre></td></tr></table></figure></p><p>ç›¸å…³<code>PlatformTransactionManager</code>çš„beanå®šä¹‰å°†æœ‰ä¸€ä¸ª<code>DataSource</code>å®šä¹‰çš„å¼•ç”¨ã€‚å®ƒçœ‹èµ·æ¥åƒè¿™æ ·ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean id=&quot;txManager&quot; class=&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;&gt;</span><br><span class="line">    &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot;&gt;</span><br><span class="line">&lt;/bean&gt;</span><br></pre></td></tr></table></figure></p><p>å¦‚æœä½ åœ¨Java EEå®¹å™¨ä¸­ä½¿ç”¨JTAï¼Œä½ å°†ä½¿ç”¨é€šè¿‡å®¹å™¨ä»JNDIä¸­è·å–çš„<code>DataSource</code>ï¼Œå’ŒSpringçš„JtaTransactionManagerç›¸å…³è”ã€‚è¿™å°±æ˜¯JTAå’ŒJNDIæŸ¥æ‰¾ç‰ˆæœ¬çš„æ ·å­ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">    xmlns:jee=&quot;http://www.springframework.org/schema/jee&quot;</span><br><span class="line">    xsi:schemaLocation=&quot;</span><br><span class="line">        http://www.springframework.org/schema/beans</span><br><span class="line">        http://www.springframework.org/schema/beans/spring-beans.xsd</span><br><span class="line">        http://www.springframework.org/schema/jee</span><br><span class="line">        http://www.springframework.org/schema/jee/spring-jee.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;jee:jndi-lookup id=&quot;dataSource&quot; jndi-name=&quot;jdbc/jpetstore&quot;/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id=&quot;txManager&quot; class=&quot;org.springframework.transaction.jta.JtaTransactionManager&quot; /&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- other &lt;bean/&gt; definitions here --&gt;</span><br><span class="line"></span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure><p><code>JtaTransactionManager</code>ä¸éœ€è¦çŸ¥é“<code>DataSource</code>æˆ–è€…å…¶ä»–æŒ‡å®šçš„èµ„æºï¼Œå› ä¸ºå®ƒä½¿ç”¨å®¹å™¨çš„å…¨å±€äº‹åŠ¡ç®¡ç†åŸºç¡€è®¾æ–½ã€‚</p><blockquote><p>ä»¥ä¸Šå®šä¹‰çš„<code>dataSource</code>beanä½¿ç”¨<code>jee</code>å‘½åç©ºé—´çš„<code>&lt;jdni-lookup/&gt;</code>æ ‡ç­¾ã€‚å¯¹äº<code>schema-based</code>çš„æ›´å¤šé…ç½®ä¿¡æ¯ï¼Œ<a href="https://docs.spring.io/spring/docs/4.2.x/spring-framework-reference/html/xsd-configuration.html" target="_blank" rel="noopener">Chapter40, XML Schema-based é…ç½®</a>ï¼Œå¯¹äº<code>&lt;jee/&gt;</code>æ ‡ç­¾çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·çœ‹<a href="https://docs.spring.io/spring/docs/4.2.x/spring-framework-reference/html/xsd-configuration.html#xsd-config-body-schemas-jee" target="_blank" rel="noopener">Section 40.2.3</a></p></blockquote><p>ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨è½»æ¾çš„ä½¿ç”¨Hibernateæœ¬åœ°äº‹åŠ¡ï¼Œæ­£å¦‚åœ¨ä¸‹é¢å±•ç¤ºçš„ä¾‹å­ã€‚è¿™ç§æƒ…å†µï¼Œä½ éœ€è¦å®šä¹‰ä¸€ä¸ªHibernate<code>LocalSessionFactoryBean</code>ï¼Œä½ çš„ä»£ç å°†ä½¿ç”¨å®ƒå»è·å–Hibernate<code>Session</code>å®ä¾‹ã€‚</p><p><code>DataSource</code>beanå®šä¹‰å’Œä¹‹å‰ç¤ºä¾‹æœ¬åœ°JDBCä¾‹å­ç›¸ä¼¼ï¼Œæ‰€ä»¥ä¸‹é¢ä¸åœ¨å±•ç¤ºã€‚</p><blockquote><p>å¦‚æœ<code>DataSource</code>è¢«ä»»ä½•éJTAäº‹åŠ¡ç®¡ç†ä½¿ç”¨ï¼Œå°†é€šè¿‡JNDIæŸ¥æ‰¾ï¼ŒJava EEå®¹å™¨ç®¡ç†ï¼Œç„¶åå®ƒå°†æ˜¯éäº‹åŠ¡æ€§çš„ï¼Œå› ä¸ºæ˜¯ä½¿ç”¨Springæ¡†æ¶ç®¡ç†äº‹åŠ¡ï¼Œè€Œä¸æ˜¯Java EEå®¹å™¨ã€‚</p></blockquote><p><code>txManager</code>bean åœ¨è¿™ç§æƒ…å†µä¸‹æ˜¯å±äº<code>HibernateTransactionManager</code>ç±»å‹ã€‚ä»¥ç›¸åŒçš„æ–¹å¼ï¼Œæ­£å¦‚<code>DataSourceTransactionManager</code>éœ€è¦å¼•ç”¨<code>DataSource</code>ï¼Œ<code>HiberanteTransactionManager</code>éœ€è¦å¼•ç”¨<code>SessionFactory</code>ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean id=&quot;sessionFactory&quot; class=&quot;org.springframework.orm.hibernate5.LocalSessionFactoryBean&quot;&gt;</span><br><span class="line">    &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot;/&gt;</span><br><span class="line">    &lt;property name=&quot;mappingResources&quot;&gt;</span><br><span class="line">        &lt;list&gt;</span><br><span class="line">            &lt;value&gt;org/springframework/samples/petclinic/hibernate/petclinic.hbm.xml&lt;/value&gt;</span><br><span class="line">        &lt;/list&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    &lt;property name=&quot;hibernateProperties&quot;&gt;</span><br><span class="line">        &lt;value&gt;</span><br><span class="line">            hibernate.dialect=$&#123;hibernate.dialect&#125;</span><br><span class="line">        &lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">&lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">&lt;bean id=&quot;txManager&quot; class=&quot;org.springframework.orm.hibernate5.HibernateTransactionManager&quot;&gt;</span><br><span class="line">    &lt;property name=&quot;sessionFactory&quot; ref=&quot;sessionFactory&quot;/&gt;</span><br><span class="line">&lt;/bean&gt;</span><br></pre></td></tr></table></figure><p>å¦‚æœä½ ä½¿ç”¨Hibernateå’ŒJava EEå®¹å™¨ç®¡ç†JTAäº‹åŠ¡ï¼Œä½ åº”è¯¥ä½¿ç”¨ä¸ä¹‹å‰JDBCçš„JTAä¾‹å­ç›¸åŒçš„<code>JtaTransactionManager</code>ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean id=&quot;txManager&quot; class=&quot;org.springframework.transaction.jta.JtaTransactionManager&quot;/&gt;</span><br></pre></td></tr></table></figure><blockquote><p>å¦‚æœä½ ä½¿ç”¨JTAï¼Œä½ çš„äº‹åŠ¡ç®¡ç†å®šä¹‰å°†çœ‹èµ·æ¥ä¸€æ ·ï¼Œè€Œä¸ç®¡ä½ ç”¨äº†ä»€ä¹ˆæ•°æ®è®¿é—®æŠ€æœ¯ï¼Œæ˜¯JDBCï¼ŒHibernate JPAæˆ–è€…å…¶ä»–æ”¯æŒçš„æŠ€æœ¯ã€‚è¿™ä¸ªæ˜¯ç¡®å®šçš„äº‹å®ï¼ŒJTA äº‹åŠ¡æ˜¯å…¨å±€äº‹åŠ¡ï¼Œå¯ä»¥åŠ å…¥ä»»ä½•çš„äº‹åŠ¡èµ„æºã€‚</p></blockquote><p>å¯¹äºä»¥ä¸Šæ‰€æœ‰æƒ…å†µï¼Œåº”ç”¨ä»£ç ä¸éœ€è¦ æ”¹å˜ã€‚ä½ å¯ä»¥é€šè¿‡æ”¹å˜é…ç½®æ¥æ”¹å˜å¦‚ä½•ç®¡ç†äº‹åŠ¡ï¼Œå³ä½¿ä½ ä»æœ¬åœ°äº‹åŠ¡æ”¹ä¸ºå…¨å±€äº‹åŠ¡ï¼Œåä¹‹äº¦ç„¶ã€‚</p><h2 id="1-4-å°†èµ„æºä¸äº‹åŠ¡åŒæ­¥"><a href="#1-4-å°†èµ„æºä¸äº‹åŠ¡åŒæ­¥" class="headerlink" title="1.4 å°†èµ„æºä¸äº‹åŠ¡åŒæ­¥"></a>1.4 å°†èµ„æºä¸äº‹åŠ¡åŒæ­¥</h2><p>ç°åœ¨ä½ åº”è¯¥å¾ˆæ¸…æ¥šå¦‚ä½•åˆ›å»ºä¸åŒçš„äº‹åŠ¡ç®¡ç†ï¼Œå’Œå®ƒä»¬æ€æ ·å’Œéœ€è¦è¢«åŒæ­¥äº‹åŠ¡ç›¸å…³èµ„æºé“¾æ¥ï¼ˆä¾‹å¦‚ï¼š<code>DataSourceTransactionManager</code>é“¾æ¥JDBC<code>DataSource</code>ï¼Œ<code>HibernateTransactionManager</code>é“¾æ¥Hibernate<code>SessionFactory</code>ï¼Œç­‰ç­‰ã€‚ï¼‰è¿™ä¸ªç« èŠ‚æè¿°åº”ç”¨ä»£ç æ€æ ·ç›´æ¥æˆ–è€…éç›´æ¥ä½¿ç”¨æŒä¹…APIï¼Œå¦‚JDBCï¼ŒHibernateï¼Œæˆ–è€…JDOï¼Œç¡®ä¿è¿™äº›èµ„æºè¢«åˆ›å»ºï¼Œå¤ç”¨ï¼Œå’Œæ­£ç¡®çš„æ¸…ç†ã€‚è¿™ä¸ªç« èŠ‚ä¹Ÿè®¨è®ºäº‹åŠ¡åŒæ­¥æ€æ ·é€šè¿‡ç›¸åº”çš„<code>PlatformTransactionManager</code>è§¦å‘ã€‚</p><h3 id="1-4-1-é«˜çº§åŒæ­¥æ–¹å¼"><a href="#1-4-1-é«˜çº§åŒæ­¥æ–¹å¼" class="headerlink" title="1.4.1 é«˜çº§åŒæ­¥æ–¹å¼"></a>1.4.1 é«˜çº§åŒæ­¥æ–¹å¼</h3><p>é¦–é€‰æ–¹æ³•æ˜¯ä½¿ç”¨SpringåŸºäºé«˜çº§æ¨¡æ¿çš„æŒä¹…æ€§é›†æˆAPIsæˆ–è€…ä½¿ç”¨æœ¬åœ°ORM APIsä¸transacton-awareå·¥å‚beanæˆ–è€…ä»£ç†ä¸€èµ·ä½¿ç”¨ï¼Œæ¥ç®¡ç†æœ¬åœ°èµ„æºå·¥å‚ã€‚transaction-awareè§£å†³æ–¹æ¡ˆåœ¨å†…éƒ¨å¤„ç†èµ„æºçš„åˆ›å»ºï¼Œå¤ç”¨ï¼Œæ¸…ç†ï¼Œèµ„æºçš„å¯é€‰äº‹åŠ¡åŒæ­¥å’Œå¼‚å¸¸æ˜ å°„ã€‚å› æ­¤ç”¨æˆ·æ•°æ®è®¿é—®ä»£ç ä¸å¿…è§£å†³è¿™äº›ä»»åŠ¡ï¼Œä½†æ˜¯å¯ä»¥å®Œå…¨å…³æ³¨äºéæ ·æ¿æŒä¹…é€»è¾‘ã€‚é€šå¸¸ï¼Œä½ ä½¿ç”¨æœ¬åœ°ORM APIæˆ–è€…ä½¿ç”¨æ¨¡ç‰ˆæ–¹å¼é€šè¿‡ä½¿ç”¨<code>JdbcTemplate</code>è¿›è¡ŒJDBCè®¿é—®ã€‚è¿™äº›è§£å†³æ–¹æ¡ˆåœ¨æœ¬å‚è€ƒæ–‡æ¡£çš„éšåç« èŠ‚ä¸­æœ‰è¯¦ç»†è¯´æ˜ã€‚</p><h3 id="1-4-2-ä½çº§åŒæ­¥æ–¹å¼"><a href="#1-4-2-ä½çº§åŒæ­¥æ–¹å¼" class="headerlink" title="1.4.2 ä½çº§åŒæ­¥æ–¹å¼"></a>1.4.2 ä½çº§åŒæ­¥æ–¹å¼</h3><p>ç±»ä¾‹å¦‚ï¼š<code>DataSourceUtils</code>ï¼ˆJDBCï¼‰ï¼Œ<code>EntityManagerFactoryUtils</code>(JPA)ï¼Œ<code>SessionFactoryUtils</code>ï¼ˆHibernateï¼‰ï¼Œ<code>PersistenceManagerFactoryUtils</code>(JDO)ï¼Œç­‰ç±»å­˜åœ¨äºè¾ƒä½çº§åˆ«ã€‚<br>æœ¬åœ°æŒä¹…åŒ–APIsï¼Œä½ ä½¿ç”¨è¿™äº›ç±»å»ç¡®ä¿Springæ¡†æ¶ç®¡ç†çš„å®ä¾‹è¢«æ­£ç¡®è·å–ï¼Œäº‹åŠ¡è¢«åŒæ­¥ï¼ˆå¯é€‰ï¼‰ï¼Œåœ¨è¿›ç¨‹ä¸­å‘ç”Ÿçš„å¼‚å¸¸æ­£ç¡®çš„è¢«æ˜ å°„åˆ°ä¸€è‡´çš„APIã€‚<br>ä¾‹å¦‚ï¼Œåœ¨JDBCçš„æƒ…å†µä¸‹ï¼Œè€Œä¸æ˜¯åœ¨<code>DataSource</code>è°ƒç”¨<code>getConnection()</code>æ–¹æ³•çš„ä¼ ç»Ÿçš„JDBCæ–¹å¼,ä½ æ›¿æ¢ä½¿ç”¨Springçš„<code>org.springframework.jdbc.datasource.DataSourceUtils</code>ç±»ï¼Œå¦‚ä¸‹:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Connection conn = DataSourceUtils.getConnection(dataSource);</span><br></pre></td></tr></table></figure></p><p>å¦‚æœä¸€ä¸ªå·²ç»å­˜åœ¨çš„äº‹åŠ¡æœ‰ä¸€ä¸ªé“¾æ¥å’Œå®ƒåŒæ­¥ï¼Œè¿™ä¸ªå®ä¾‹å°†è¢«è¿”å›ã€‚å¦åˆ™ï¼Œè¿™ä¸ªæ–¹æ³•è°ƒç”¨å‡ºæ–¹æ³•æ–°é“¾æ¥çš„åˆ›å»ºï¼Œè¿™ä¸ªé“¾æ¥ï¼ˆå¯é€‰ï¼‰è¢«åŒæ­¥åˆ°å·²ç»ä»»ä½•å·²å­˜åœ¨çš„äº‹åŠ¡ä¸Šï¼Œä½¿å¾—åœ¨éšåçš„åŒä¸€äº‹åŠ¡ä¸­é‡å¤è°ƒç”¨ã€‚ å¦‚ä¸Šæ‰€è¿°ï¼Œä»»ä½•<code>SQLException</code>åœ¨Springæ¡†æ¶<code>CannotGetJdbcConnectionException</code>ä¸­æ˜¯è¢«åŒ…æ‹¬çš„ï¼Œæ˜¯Springæ¡†æ¶éæ ¡éªŒæ•°æ®è®¿é—®å¼‚å¸¸ä¹‹ä¸€ã€‚è¿™ä¸ªæ–¹å¼æä¾›äº†æ¯”ä½ ä»<code>SQLException</code>ä¸­è½»æ¾è·çš„æ›´å¤šçš„ä¿¡æ¯ï¼Œç¡®ä¿è·¨æ•°æ®åº“çš„å¯ç§»æ¤æ€§ï¼Œè®¾ç½®è·¨ä¸åŒçš„æŒä¹…åŒ–æŠ€æœ¯ã€‚</p><p>è¿™ç§æ–¹å¼è¿è¡Œä¹Ÿæ²¡æœ‰Springäº‹åŠ¡ç®¡ç†ï¼ˆäº‹åŠ¡åŒæ­¥æ—¶å¯é€‰çš„ï¼‰ï¼Œæ‰€ä»¥æ— è®ºä½ æ˜¯å¦ä½¿ç”¨Springäº‹åŠ¡ç®¡ç†ï¼Œä½ éƒ½å¯ä»¥ä½¿ç”¨å®ƒã€‚</p><p>å½“ç„¶ï¼Œä¸€æ—¦ä½ ä½¿ç”¨äº†Springçš„JDBCæ”¯æŒï¼ŒJPAæ”¯æŒæˆ–è€…Hibernateæ”¯æŒï¼Œä½ é€šå¸¸æ›´å–œæ¬¢ä¸ä½¿ç”¨<code>DataSourceUtils</code>æˆ–è€…å…¶ä»–çš„ç±»ï¼Œå› ä¸ºç›¸æ¯”äºç›´æ¥ä½¿ç”¨ç›¸å…³çš„APIsï¼Œé€šè¿‡SpringæŠ½è±¡ä½ å°†å·¥ä½œçš„æ›´å¿«ä¹ã€‚ä¾‹å¦‚ï¼šä½ ä½¿ç”¨Spring<code>JdbcTemplate</code>æˆ–è€…<code>jdbc.object</code>åŒ…å»ç®€åŒ–ä½ ä½¿ç”¨çš„JDBCï¼Œåœ¨å¹•åå‘ç”Ÿçš„é“¾æ¥æ¢å¤ï¼Œä½ å°†ä¸åœ¨éœ€è¦å†™ä»»ä½•ç‰¹å®šä»£ç ã€‚</p><h3 id="1-4-3-TransactionAwareDataSourceProxy"><a href="#1-4-3-TransactionAwareDataSourceProxy" class="headerlink" title="1.4.3 TransactionAwareDataSourceProxy"></a>1.4.3 TransactionAwareDataSourceProxy</h3><p><code>TransactionAwareDataSourceProxy</code>ç±»ä½œä¸ºä¸€ä¸ªä½çº§å­˜åœ¨ã€‚è¿™æ˜¯ä¸€ä¸ª<code>DataSource</code>çš„ä»£ç†ï¼Œå®ƒåŒ…è£…ç›®æ ‡DataSourceä»¥å¢åŠ å¯¹Springç®¡ç†çš„äº‹åŠ¡çš„è®¤è¯†ã€‚åœ¨è¿™ä¸ªæ–¹é¢ï¼Œå®ƒç±»ä¼¼äºé€šè¿‡Java EEæœåŠ¡å™¨æä¾›çš„äº‹åŠ¡JNDI<code>DataSource</code>ã€‚</p><p>ä½¿ç”¨è¿™ä¸ªç´¯æ ¹æœ¬ä¸éœ€è¦æˆ–è€…ä¸å¯å–ï¼Œé™¤éå½“å·²å­˜åœ¨çš„ä»£ç å¿…é¡»è¢«è°ƒç”¨å’Œä¼ é€’äº†ä¸€ä¸ªæ ‡å‡†JDBC<code>DataSource</code>æ¥å£å®ç°ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä»£ç å¯èƒ½æœ‰ç”¨ï¼Œä½†æ˜¯å‚ä¸Springçš„äº‹åŠ¡ç®¡ç†ã€‚æœ€å¥½æ˜¯é€šè¿‡ä½¿ç”¨ä¸Šé¢æåˆ°çš„é«˜çº§æŠ½è±¡å»å†™æ–°ä»£ç ã€‚</p><h2 id="1-5-å£°æ˜å¼äº‹åŠ¡ç®¡ç†"><a href="#1-5-å£°æ˜å¼äº‹åŠ¡ç®¡ç†" class="headerlink" title="1.5 å£°æ˜å¼äº‹åŠ¡ç®¡ç†"></a>1.5 å£°æ˜å¼äº‹åŠ¡ç®¡ç†</h2><blockquote><p>å¤§å¤šæ•°Springæ¡†æ¶ç”¨æˆ·é€‰æ‹©å£°æ˜å¼äº‹åŠ¡ç®¡ç†ã€‚æ­¤é€‰é¡¹å¯¹åº”ç”¨ç¨‹åºä»£ç çš„å½±å“æœ€å°ï¼Œå› æ­¤æœ€ç¬¦åˆéä¾µå…¥å¼è½»é‡çº§å®¹å™¨çš„ç†æƒ³ã€‚</p></blockquote><p>ä½¿ç”¨Springåˆ‡é¢ç¼–ç¨‹çš„Spring æ¡†æ¶çš„å£°æ˜å¼äº‹åŠ¡ç®¡ç†æˆä¸ºå¯èƒ½ã€‚ä½†æ˜¯ï¼Œç”±äºäº‹åŠ¡åˆ‡é¢ä»£ç éšSpring Frameworkå‘è¡Œç‰ˆä¸€èµ·æä¾›å¹¶ä¸”å¯èƒ½ä»¥æ ·æ¿æ–¹å¼ä½¿ç”¨ï¼Œå› æ­¤é€šå¸¸æ²¡å¿…è¦ç†è§£AOPæ¦‚å¿µæ¥æœ‰æ•ˆåœ°ä½¿ç”¨æ­¤ä»£ç ã€‚</p><p>Spring æ¡†æ¶çš„å£°æ˜å¼äº‹åŠ¡ç®¡ç†å’Œ EJB CMTåœ¨ç»™å•ä¸ªæ–¹æ³•çº§åˆ«æŒ‡å®šï¼ˆç¼ºå°‘ï¼‰äº‹åŠ¡çš„è¡Œä¸ºæ˜¯ç›¸ä¼¼çš„ã€‚åœ¨éœ€è¦çš„æƒ…å†µä¸‹ï¼Œä¸ä½¿ç”¨äº‹åŠ¡ä¸Šä¸‹æ–‡è°ƒç”¨<code>setRollbackOnly()</code>æ˜¯å¯èƒ½çš„ã€‚ä¸¤ç§äº‹åŠ¡ç®¡ç†ç±»å‹çš„ä¸åŒç‚¹æ˜¯ï¼š</p><ul><li>å’Œ EJB CMTä¸ä¸€æ ·ï¼Œç»‘å®šJTAï¼ŒSpringæ¡†æ¶çš„å£°æ˜å¼äº‹åŠ¡ç®¡ç†å¯ä»¥åœ¨ä»»ä½•ç¯å¢ƒä¸­è¿è¡Œã€‚ä¹Ÿå¯ä»¥é€šè¿‡è°ƒæ•´é…ç½®æ–‡ä»¶ä½¿ç”¨JTAäº‹åŠ¡æˆ–è€…ä½¿ç”¨JDBCï¼ŒJPAï¼ŒHibernateæˆ–è€…JDOæœ¬åœ°äº‹åŠ¡ã€‚</li><li>ä½ å¯ä»¥å¯¹ä»»æ„ç±»ç”¨Springæ¡†æ¶å£°æ˜å¼äº‹åŠ¡ç®¡ç†ï¼Œä¸ä»…ä»…æ˜¯å¯¹äºåƒEJBsçš„ç‰¹æ®Šç±»ã€‚</li><li>Springæ¡†æ¶æä¾›å£°æ˜å¼å›æ»šè§„åˆ™ï¼Œæ²¡æœ‰å’ŒEJBç­‰æ•ˆçš„åŠŸèƒ½ã€‚æä¾›ç¼–ç¨‹å¼å’Œå£°æ˜å¼ä¸¤ç§å›æ»šè§„åˆ™æ”¯æŒã€‚</li><li>Springæ¡†æ¶å…è®¸é€šè¿‡ä½¿ç”¨AOPè‡ªå®šä¹‰äº‹åŠ¡è¡Œä¸ºã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥åœ¨äº‹åŠ¡å›æ»šçš„æƒ…å†µä¸‹æ’å…¥è‡ªå®šä¹‰è¡Œä¸ºã€‚ä½ éšç€äº‹åŠ¡adviceä¹Ÿå¯ä»¥æ·»åŠ ä»»æ„adviceã€‚ä½¿ç”¨EJB CMTï¼Œé™¤äº†<code>setRollbackOnly</code>ä½ æ— æ³•å½±å“å®¹å™¨çš„äº‹åŠ¡ç®¡ç†ã€‚</li><li>Springæ¡†æ¶å’Œé«˜ç«¯æœåŠ¡å™¨ä¸€æ ·ä¸æ”¯æŒè·¨è¿œç¨‹è°ƒç”¨äº‹åŠ¡ä¸Šä¸‹æ–‡ä¼ æ’­ç‰¹æ€§ã€‚å¦‚æœä½ éœ€è¦ä½¿ç”¨è¿™ç§ç‰¹æ€§ï¼Œæˆ‘ä»¬å»ºè®®ä½ ä½¿ç”¨EJBã€‚ä½†æ˜¯ï¼Œä½¿ç”¨è¿™ç§ç‰¹æ€§ä¹‹å‰è€ƒç•¥æ¸…æ¥šï¼Œå› ä¸ºä¸€èˆ¬æ¥è¯´ï¼Œä¸æƒ³æ”¯æŒäº‹åŠ¡çš„è·¨è¿œç¨‹è°ƒç”¨ã€‚</li></ul><blockquote><p><b>TransactionProxyFactoryBeanåœ¨å“ªï¼Ÿ</b><br>   åœ¨Spingçš„2.0ç‰ˆæœ¬åŠä»¥ä¸Šç‰ˆæœ¬çš„å£°æ˜äº‹åŠ¡é…ç½®å’Œä»¥å‰çš„Springç‰ˆæœ¬æœ‰å¾ˆå¤§çš„åŒºåˆ«ã€‚ä¸»è¦çš„ä¸åŒæ˜¯ä¸åœ¨éœ€è¦é…ç½®<code>TransactionProxyFactoryBean</code>beansã€‚<br>   Spring2.0ç‰ˆæœ¬ä¹‹å‰çš„é…ç½®ä¾ç„¶æ˜¯100%æœ‰æ•ˆçš„é…ç½®ï¼›å°†æ–°<code>&lt;tx:tags/&gt;</code>è§†ä¸ºä»£è¡¨ä½ ç®€å•çš„å®šä¹‰<code>TransactionProxyFactoryBean</code> beansã€‚   </p></blockquote><p>å›æ»šè§„åˆ™çš„æ¦‚å¿µæ˜¯é‡è¦çš„ï¼šå®ƒä»¬å…è®¸ä½ å¤´æŒ‡å®šå“ªç§å¼‚å¸¸ï¼ˆæˆ–è€…æŠ›å‡ºï¼‰åº”è¯¥é€ æˆè‡ªåŠ¨çš„å›æ»šã€‚ä½ ä»¥å£°æ˜çš„æ–¹å¼æŒ‡å®šå®ƒï¼Œåœ¨é…ç½®ä¸­ï¼Œä¸åœ¨Javaä»£ç ä¸­ã€‚å› æ­¤ï¼Œå°½ç®¡ä½ å¯ä»¥å§‹ç»ˆåœ¨<code>TransactionStatus</code>å¯¹è±¡ä¸Šè°ƒç”¨<code>setRollbackOnly</code>æ–¹æ³•å»å›æ»šå½“å‰äº‹åŠ¡ï¼Œä½†æ˜¯å¤§å¤šæ•°ä½ å¸¸å¸¸å¯ä»¥æŒ‡å®š<code>MyApplicationException</code>å¿…é¡»æ€»æ˜¯é€ æˆå›æ»šçš„è§„åˆ™ã€‚è¿™ä¸ªé€‰æ‹©å¯¹çš„é‡å¤§ä¼˜åŠ¿æ˜¯ä¸šåŠ¡å¯¹è±¡ä¸ä¾èµ–äº‹åŠ¡åŸºç¡€è®¾æ–½ã€‚ä¾‹å¦‚ï¼Œå®ƒä»¬é€šå¸¸éœ€è¦å¯¼å…¥Spring äº‹åŠ¡APIsæˆ–è€…å…¶ä»–Spring APIsã€‚</p><p>å°½ç®¡EJBå®¹å™¨é»˜è®¤è¡Œä¸ºåœ¨ç³»ç»Ÿå¼‚å¸¸ï¼ˆé€šå¸¸æ˜¯è¿è¡Œæ—¶å¼‚å¸¸ï¼‰ä¸­è‡ªåŠ¨å›æ»šäº‹åŠ¡ï¼ŒEJB CMTåœ¨åº”ç”¨å¼‚å¸¸ï¼ˆé™¤<code>java.rmi.RemoteException</code>å¤–çš„æ£€æŸ¥æ—¶å¼‚å¸¸ï¼‰ä¸­ä¸è‡ªåŠ¨å›æ»šäº‹åŠ¡ã€‚è™½ç„¶Springå£°æ˜å¼äº‹åŠ¡ç®¡ç†çš„é»˜è®¤è¡Œä¸ºéµå¾ªEJBçº¦å®šï¼ˆä»…ä»…åœ¨éæ£€æŸ¥å¼‚å¸¸æ—¶è‡ªåŠ¨å›æ»šï¼‰ï¼Œä½†æ˜¯ï¼Œè‡ªå®šä¹‰è¿™ä¸ªè¡Œä¸ºæ˜¯ç»å¸¸æœ‰ç”¨çš„ã€‚</p><h3 id="1-5-1-ç†è§£å£°æ˜å¼äº‹åŠ¡ç®¡ç†å®ç°"><a href="#1-5-1-ç†è§£å£°æ˜å¼äº‹åŠ¡ç®¡ç†å®ç°" class="headerlink" title="1.5.1 ç†è§£å£°æ˜å¼äº‹åŠ¡ç®¡ç†å®ç°"></a>1.5.1 ç†è§£å£°æ˜å¼äº‹åŠ¡ç®¡ç†å®ç°</h3><p>ç®€å•çš„å‘Šè¯‰ä½ å»ä½¿ç”¨<code>@Transactional</code>æ³¨è§£å»æ³¨è§£ä½ çš„ç±»ï¼Œåœ¨é…ç½®ä¸­æ·»åŠ <code>@EnableTransactionMangement</code>ï¼Œç„¶åæœŸå¾…ä½ ç†è§£å®ƒå…¨éƒ¨æ€æ ·è¿è¡Œçš„æ˜¯ä¸è¶³å¤Ÿçš„ã€‚è¿™ä¸ªç« èŠ‚è§£é‡Šåœ¨å‘ç”Ÿä¸äº‹åŠ¡ç›¸å…³çš„é—®é¢˜æ—¶Springçš„å£°æ˜å¼äº‹åŠ¡åŸºç¡€è®¾æ–½å†…éƒ¨å·¥ä½œåŸç†ã€‚<br>å…³äºSpringæ¡†æ¶çš„è¯´æ˜ä¹¦äº‹åŠ¡æ”¯æŒæœ€é‡è¦çš„æ¦‚å¿µæ˜¯é€šè¿‡AOPä»£ç†å¯ç”¨è¿™ä¸ªæ”¯æŒï¼Œäº‹åŠ¡adviceç”±å…ƒæ•°æ®ï¼ˆç›®å‰åŸºäºXMLæˆ–è€…æ³¨è§£ï¼‰é©±åŠ¨ã€‚äº‹åŠ¡å…ƒæ•°æ®å’ŒAOPçš„ç»„åˆç”Ÿæˆä¸€ä¸ªä»£ç†ï¼Œè¿™ä¸ªä»£ç†ä½¿ç”¨<code>TransactionInterceptor</code>å’Œé€‚å½“çš„<code>PlatfromTransactionManager</code>å®ç°æ¥é©±åŠ¨å›´ç»•æ–¹æ³•è°ƒç”¨çš„äº‹åŠ¡ã€‚</p><blockquote><p>Spring AOP åŒ…å«åœ¨<a href="https://docs.spring.io/spring/docs/4.2.x/spring-framework-reference/html/aop.html" target="_blank" rel="noopener">Chapter 10, Aspect Oriented Programming with Spring.</a></p></blockquote><p>ä»æ¦‚å¿µä¸Šè®²ï¼Œè°ƒç”¨åœ¨ä¸€ä¸ªäº‹åŠ¡ä»£ç†ä¸Šçš„ä¸€ä¸ªæ–¹æ³•åƒè¿™æ ·ï¼š</p><p><img src="media/15528176890745.png" alt=""></p><h3 id="1-5-2-å£°æ˜å¼äº‹åŠ¡å®ç°çš„ä¾‹å­"><a href="#1-5-2-å£°æ˜å¼äº‹åŠ¡å®ç°çš„ä¾‹å­" class="headerlink" title="1.5.2 å£°æ˜å¼äº‹åŠ¡å®ç°çš„ä¾‹å­"></a>1.5.2 å£°æ˜å¼äº‹åŠ¡å®ç°çš„ä¾‹å­</h3><p>è€ƒè™‘ä¸‹é¢çš„æ¥å£ï¼Œå’Œéšåçš„å®ç°ã€‚è¿™ä¸ªä¾‹å­ä½¿ç”¨<code>Foo</code>å’Œ<code>Bar</code>ç±»ä½œä¸ºæ ‡å¿—ç¬¦ï¼Œä»¥ä¾¿äºä½ å¯ä»¥ä¸ç”¨ç®¡ä¸ä½ç‰¹æ®ŠåŸŸæ¨¡å‹ï¼Œåªé›†ä¸­å…³æ³¨äº‹åŠ¡çš„ä½¿ç”¨ã€‚å¯¹äºè¿™ä¸ªä¾‹å­çš„ç›®çš„ï¼Œåœ¨æ¯ä¸€ä¸ªå®ç°æ–¹æ³•ä½“å†…ï¼Œ<code>DefaultFooService</code>ç±»æŠ›å‡º<code>UnsupportedOperationException</code>å®ä¾‹çš„äº‹å®æ˜¯å¥½çš„ï¼›å®ƒå…è®¸ä½ æŸ¥çœ‹åˆ›å»ºçš„äº‹åŠ¡å’Œç„¶åå›æ»šæ¥å“åº”<code>UnsupportedOperationException</code>å®ä¾‹ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">package x.y.service;</span><br><span class="line"></span><br><span class="line">public interface FooService &#123;</span><br><span class="line"></span><br><span class="line">    Foo getFoo(String fooName);</span><br><span class="line"></span><br><span class="line">    Foo getFoo(String fooName, String barName);</span><br><span class="line"></span><br><span class="line">    void insertFoo(Foo foo);</span><br><span class="line"></span><br><span class="line">    void updateFoo(Foo foo);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">package x.y.service;</span><br><span class="line"></span><br><span class="line">public class DefaultFooService implements FooService &#123;</span><br><span class="line"></span><br><span class="line">    public Foo getFoo(String fooName) &#123;</span><br><span class="line">        throw new UnsupportedOperationException();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Foo getFoo(String fooName, String barName) &#123;</span><br><span class="line">        throw new UnsupportedOperationException();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void insertFoo(Foo foo) &#123;</span><br><span class="line">        throw new UnsupportedOperationException();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void updateFoo(Foo foo) &#123;</span><br><span class="line">        throw new UnsupportedOperationException();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡è®¾<code>FooService</code>æ¥å£çš„å‰é¢ä¸¤ä¸ªæ–¹æ³•ï¼Œ<code>getFoo(String)</code>å’Œ<code>getFoo(String, String)</code>ï¼Œå¿…é¡»åœ¨ä¸€ä¸ªå¸¦æœ‰åªè¯»è¯­ä¹‰äº‹åŠ¡çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œï¼Œå’Œå…¶ä»–çš„æ–¹æ³•ï¼Œ<code>insertFoo(Foo)</code>å’Œ<code>updateFoo(Foo)</code>ï¼Œå¿…é¡»åœ¨å¸¦æœ‰åªè¯»è¯­ä¹‰äº‹åŠ¡ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œã€‚å¦‚ä¸‹é…ç½®åœ¨ä¸‹é¢çš„å‡ æ®µä¸­è¢«è¯¦ç»†è§£é‡Šã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">    xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot;</span><br><span class="line">    xmlns:tx=&quot;http://www.springframework.org/schema/tx&quot;</span><br><span class="line">    xsi:schemaLocation=&quot;</span><br><span class="line">        http://www.springframework.org/schema/beans</span><br><span class="line">        http://www.springframework.org/schema/beans/spring-beans.xsd</span><br><span class="line">        http://www.springframework.org/schema/tx</span><br><span class="line">        http://www.springframework.org/schema/tx/spring-tx.xsd</span><br><span class="line">        http://www.springframework.org/schema/aop</span><br><span class="line">        http://www.springframework.org/schema/aop/spring-aop.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- this is the service object that we want to make transactional --&gt;</span><br><span class="line">    &lt;bean id=&quot;fooService&quot; class=&quot;x.y.service.DefaultFooService&quot;/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- the transactional advice (what &apos;happens&apos;; see the &lt;aop:advisor/&gt; bean below) --&gt;</span><br><span class="line">    &lt;tx:advice id=&quot;txAdvice&quot; transaction-manager=&quot;txManager&quot;&gt;</span><br><span class="line">        &lt;!-- the transactional semantics... --&gt;</span><br><span class="line">        &lt;tx:attributes&gt;</span><br><span class="line">            &lt;!-- all methods starting with &apos;get&apos; are read-only --&gt;</span><br><span class="line">            &lt;tx:method name=&quot;get*&quot; read-only=&quot;true&quot;/&gt;</span><br><span class="line">            &lt;!-- other methods use the default transaction settings (see below) --&gt;</span><br><span class="line">            &lt;tx:method name=&quot;*&quot;/&gt;</span><br><span class="line">        &lt;/tx:attributes&gt;</span><br><span class="line">    &lt;/tx:advice&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- ensure that the above transactional advice runs for any execution</span><br><span class="line">        of an operation defined by the FooService interface --&gt;</span><br><span class="line">    &lt;aop:config&gt;</span><br><span class="line">        &lt;aop:pointcut id=&quot;fooServiceOperation&quot; expression=&quot;execution(* x.y.service.FooService.*(..))&quot;/&gt;</span><br><span class="line">        &lt;aop:advisor advice-ref=&quot;txAdvice&quot; pointcut-ref=&quot;fooServiceOperation&quot;/&gt;</span><br><span class="line">    &lt;/aop:config&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- don&apos;t forget the DataSource --&gt;</span><br><span class="line">    &lt;bean id=&quot;dataSource&quot; class=&quot;org.apache.commons.dbcp.BasicDataSource&quot; destroy-method=&quot;close&quot;&gt;</span><br><span class="line">        &lt;property name=&quot;driverClassName&quot; value=&quot;oracle.jdbc.driver.OracleDriver&quot;/&gt;</span><br><span class="line">        &lt;property name=&quot;url&quot; value=&quot;jdbc:oracle:thin:@rj-t42:1521:elvis&quot;/&gt;</span><br><span class="line">        &lt;property name=&quot;username&quot; value=&quot;scott&quot;/&gt;</span><br><span class="line">        &lt;property name=&quot;password&quot; value=&quot;tiger&quot;/&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- similarly, don&apos;t forget the PlatformTransactionManager --&gt;</span><br><span class="line">    &lt;bean id=&quot;txManager&quot; class=&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;&gt;</span><br><span class="line">        &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot;/&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- other &lt;bean/&gt; definitions here --&gt;</span><br><span class="line"></span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure><p>æ£€æŸ¥å‰é¢çš„é…ç½®ã€‚ä½ æƒ³åˆ›å»ºä¸€ä¸ªæœåŠ¡å¯¹è±¡ï¼Œ<code>fooService</code>beanã€‚è¦åº”ç”¨çš„äº‹åŠ¡è¯­ä¹‰è¢«å°è£…åœ¨<code>&lt;tx:advice/&gt;</code>å®šä¹‰ä¸­ã€‚<code>&lt;tx:advice/&gt;</code>å®šä¹‰è¯»ä½œâ€œåœ¨åªè¯»äº‹åŠ¡ä¸Šä¸‹æ–‡ä¸­æ‰€æœ‰è¦æ‰§è¡Œçš„æ–¹æ³•ä»¥<code>get</code>å¼€å¤´ï¼Œæ‰€æœ‰å…¶ä»–è¦æ‰§è¡Œçš„æ–¹æ³•å¸¦æœ‰é»˜è®¤äº‹åŠ¡è¯­ä¹‰ã€‚â€œ<code>&lt;tx:advice/&gt;</code>æ ‡ç­¾çš„<code>transaction-manager</code>å±æ€§è¢«è®¾ç½®ä¸ºå°†è¦é©±åŠ¨äº‹åŠ¡çš„<code>PlatformTransactionManager</code>bean çš„nameï¼Œåœ¨å½“å‰çš„é…ç½®æ–‡ä»¶ä¸­ï¼Œæ˜¯<code>txManager</code>beanã€‚</p><blockquote><p>å¦‚æœä½ æƒ³è®¾ç½®<code>PlatformTransactionManager</code>beançš„nameä¸º<code>transactionManager</code>ï¼Œä½ å¯ä»¥å¿½ç•¥äº‹åŠ¡adviceçš„<code>transaction-manager</code>å±æ€§ã€‚å¦‚æœä½ æƒ³ä½¿ç”¨ä»»ä½•å…¶ä»–çš„nameç»™<code>PlatformTransactionManager</code>beanï¼Œæ­£å¦‚åœ¨ä¹‹å‰çš„ä¾‹å­ä¸­ï¼Œä½ ä¹‹åå¿…é¡»æ˜ç¡®çš„ä½¿ç”¨<code>transaction-manager</code>å±æ€§ã€‚</p></blockquote><p><code>&lt;aop:config/&gt;</code>çš„å®šä¹‰ç¡®ä¿åœ¨ç¨‹åºä¸­é€‚å½“çš„ç‚¹æ‰§è¡Œé€šè¿‡<code>txAdvice</code>beanå®šä¹‰çš„äº‹åŠ¡adviceã€‚é¦–å…ˆä½ å®šä¹‰ä¸€ä¸ªåˆ‡å…¥ç‚¹ï¼Œåˆ‡å…¥ç‚¹ä¸åœ¨<code>FooService</code>æ¥å£ï¼ˆ<code>fooServiceOperation</code>ï¼‰ä¸­å®šä¹‰çš„ä»»ä½•æ“ä½œæ‰§è¡Œçš„ç›¸åŒ¹é…ã€‚ç„¶åä½¿ç”¨advisorå…³è”åˆ‡å…¥ç‚¹å’ŒtxAdviceã€‚ç»“æœè¡¨æ˜åœ¨æ‰§è¡Œ<code>fooServiceOperation</code>æ—¶ï¼Œé€šè¿‡<code>txAdvice</code>å®šä¹‰çš„adviceå°†ä¼šè¿è¡Œã€‚</p><p>åœ¨<code>&lt;aop:pointcut/&gt;</code>å…ƒç´ ä¸­å®šä¹‰çš„è¡¨è¾¾å¼ï¼Œæ˜¯ä¸€ä¸ªAspectJåˆ‡å…¥ç‚¹è¡¨è¾¾å¼ï¼›æŸ¥çœ‹<a href="https://docs.spring.io/spring/docs/4.2.x/spring-framework-reference/html/aop.html" target="_blank" rel="noopener">Chapter 10, Aspect Oriented Programming with Spring</a>äº†è§£æ›´å¤šæœ‰å…³Springä¸­çš„åˆ‡å…¥ç‚¹è¡¨è¾¾å¼çš„è¯¦ç»†ä¿¡æ¯ã€‚</p><p>ä¸€ä¸ªå¸¸è§çš„éœ€æ±‚æ—¶åˆ›å»ºä¸€ä¸ªå…¨éƒ¨æœåŠ¡å±‚çš„äº‹åŠ¡ã€‚å®ç°è¿™ç§éœ€æ±‚çš„æœ€å¥½æ–¹å¼æ˜¯åªä¿®æ”¹åˆ‡å…¥ç‚¹è¡¨è¾¾å¼å»åŒ¹é…åœ¨ä½ æœåŠ¡å±‚çš„æ‰€æœ‰æ“ä½œã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;aop:config&gt;</span><br><span class="line">    &lt;aop:pointcut id=&quot;fooServiceMethods&quot; expression=&quot;execution(* x.y.service.*.*(..))&quot;/&gt;</span><br><span class="line">    &lt;aop:advisor advice-ref=&quot;txAdvice&quot; pointcut-ref=&quot;fooServiceMethods&quot;/&gt;</span><br><span class="line">&lt;/aop:config&gt;</span><br></pre></td></tr></table></figure><blockquote><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼šå®ƒå‡è®¾ä½ æ‰€æœ‰æœåŠ¡æ¥å£åœ¨<code>x.y.service</code>åŒ…ä¸­å®šä¹‰ï¼›æŸ¥çœ‹<a href="https://docs.spring.io/spring/docs/4.2.x/spring-framework-reference/html/aop.html" target="_blank" rel="noopener">Chapter 10, Aspect Oriented Programming with Spring </a>äº†è§£æ›´å¤šä¿¡æ¯ã€‚</p></blockquote><p>ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»åˆ†æäº†é…ç½®ï¼Œä½ å¯èƒ½ä¼šé—®ä½ è‡ªå·±ï¼Œâ€œè¿™æ‰€æœ‰çš„é…ç½®å®é™…ä¸Šåšäº†ä»€ä¹ˆï¼Ÿâ€ã€‚</p><p>ä»¥ä¸Šé…ç½®å°†è¢«ç”¨æ¥å»åˆ›å»ºä¸€ä¸ªäº‹åŠ¡ä»£ç†å›´ç»•ä»<code>fooService</code>bean å®šä¹‰åˆ›å»ºçš„å¯¹è±¡ã€‚è¿™ä¸ªä»£ç†å°†ä½¿ç”¨äº‹åŠ¡adviceé…ç½®ï¼Œä»¥ä¾¿äºåœ¨ä»£ç†ä¸Šè°ƒç”¨ä¸€ä¸ªé€‚å½“çš„æ–¹æ³•æ—¶ï¼Œä¸€ä¸ªäº‹åŠ¡å¼€å§‹ï¼ŒæŒ‚èµ·ï¼Œè¢«æ ‡è®°ä¸ºåªè¯»ç­‰ç­‰ï¼Œå–å†³äºä¸è¯¥æ–¹æ³•å…³è”çš„äº‹åŠ¡é…ç½®ã€‚è€ƒè™‘ä¸€ä¸‹æµ‹è¯•é©±åŠ¨ä»¥ä¸Šé…ç½®çš„ä»£ç ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public final class Boot &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(final String[] args) throws Exception &#123;</span><br><span class="line">        ApplicationContext ctx = new ClassPathXmlApplicationContext(&quot;context.xml&quot;, Boot.class);</span><br><span class="line">        FooService fooService = (FooService) ctx.getBean(&quot;fooService&quot;);</span><br><span class="line">        fooService.insertFoo (new Foo());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œä¸Šé¢çš„ä»£ç çš„è¾“å‡ºå°†ç±»ä¼¼ä¸‹é¢çš„ã€‚ï¼ˆä¸ºæ¸…æ¥šèµ·è§ï¼ŒLog4Jè¾“å‡ºå’ŒDefaultFooServiceç±»çš„insertFooï¼ˆ..ï¼‰æ–¹æ³•æŠ›å‡ºçš„UnsupportedOperationExceptionçš„å †æ ˆè·Ÿè¸ªå·²è¢«æˆªæ–­ã€‚ï¼‰</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;!-- the Spring container is starting up... --&gt;</span><br><span class="line">[AspectJInvocationContextExposingAdvisorAutoProxyCreator] - Creating implicit proxy for bean &apos;fooService&apos; with 0 common interceptors and 1 specific interceptors</span><br><span class="line"></span><br><span class="line">&lt;!-- the DefaultFooService is actually proxied --&gt;</span><br><span class="line">[JdkDynamicAopProxy] - Creating JDK dynamic proxy for [x.y.service.DefaultFooService]</span><br><span class="line"></span><br><span class="line">&lt;!-- ... the insertFoo(..) method is now being invoked on the proxy --&gt;</span><br><span class="line">[TransactionInterceptor] - Getting transaction for x.y.service.FooService.insertFoo</span><br><span class="line"></span><br><span class="line">&lt;!-- the transactional advice kicks in here... --&gt;</span><br><span class="line">[DataSourceTransactionManager] - Creating new transaction with name [x.y.service.FooService.insertFoo]</span><br><span class="line">[DataSourceTransactionManager] - Acquired Connection [org.apache.commons.dbcp.PoolableConnection@a53de4] for JDBC transaction</span><br><span class="line"></span><br><span class="line">&lt;!-- the insertFoo(..) method from DefaultFooService throws an exception... --&gt;</span><br><span class="line">[RuleBasedTransactionAttribute] - Applying rules to determine whether transaction should rollback on java.lang.UnsupportedOperationException</span><br><span class="line">[TransactionInterceptor] - Invoking rollback for transaction on x.y.service.FooService.insertFoo due to throwable [java.lang.UnsupportedOperationException]</span><br><span class="line"></span><br><span class="line">&lt;!-- and the transaction is rolled back (by default, RuntimeException instances cause rollback) --&gt;</span><br><span class="line">[DataSourceTransactionManager] - Rolling back JDBC transaction on Connection [org.apache.commons.dbcp.PoolableConnection@a53de4]</span><br><span class="line">[DataSourceTransactionManager] - Releasing JDBC Connection after transaction</span><br><span class="line">[DataSourceUtils] - Returning JDBC Connection to DataSource</span><br><span class="line"></span><br><span class="line">Exception in thread &quot;main&quot; java.lang.UnsupportedOperationException at x.y.service.DefaultFooService.insertFoo(DefaultFooService.java:14)</span><br><span class="line">&lt;!-- AOP infrastructure stack trace elements removed for clarity --&gt;</span><br><span class="line">at $Proxy0.insertFoo(Unknown Source)</span><br><span class="line">at Boot.main(Boot.java:11)</span><br></pre></td></tr></table></figure><h3 id="1-5-3-å›æ»šä¸€ä¸ªå£°æ˜å¼äº‹åŠ¡"><a href="#1-5-3-å›æ»šä¸€ä¸ªå£°æ˜å¼äº‹åŠ¡" class="headerlink" title="1.5.3 å›æ»šä¸€ä¸ªå£°æ˜å¼äº‹åŠ¡"></a>1.5.3 å›æ»šä¸€ä¸ªå£°æ˜å¼äº‹åŠ¡</h3><p>ä¸Šé¢çš„ç« èŠ‚æ¦‚è¿°äº†å¦‚ä½•åœ¨ä½ çš„åº”ç”¨ä¸­ç»™ç±»ï¼ˆé€šå¸¸æ˜¯æœåŠ¡å±‚ç±»ï¼‰å£°æ˜å¼çš„æŒ‡å®šäº‹åŠ¡è®¾ç½®ã€‚è¿™ä¸ªç« èŠ‚æè¿°å¦‚æœä»¥ä¸€ç§ç®€å•çš„å£°æ˜å¼æ–¹å¼æ§åˆ¶äº‹åŠ¡å›æ»šã€‚<br>å‘Springæ¡†æ¶çš„äº‹åŠ¡åŸºç¡€è®¾æ–½è¡¨æ˜å›æ»šä¸€ä¸ªäº‹åŠ¡çš„æ¨èçš„æ–¹å¼æ˜¯åœ¨å½“å‰ä¸€ä¸ªäº‹åŠ¡ä¸Šä¸‹æ–‡ä»æ‰§è¡Œçš„ä»£ç ä¸­æŠ›å‡º<code>Exception</code>ã€‚Springæ¡†æ¶äº‹åŠ¡åŸºç¡€è®¾æ–½ä»£ç å°†æ•è·æ‰€æœ‰æœªå¤„ç†å¼‚å¸¸ï¼Œå› ä¸ºå®ƒä¼šè°ƒç”¨å †æ ˆï¼Œåšå‡ºåˆ¤å®šæ˜¯å¦æ ‡è®°å›æ»šäº‹åŠ¡æ ‡è¯†ã€‚</p><p>åœ¨å®ƒçš„é»˜è®¤é…ç½®ä¸­ï¼ŒSpringæ¡†æ¶çš„äº‹åŠ¡åŸºç¡€è®¾æ–½ä»£ç ä»…ä»…åœ¨runtimeï¼Œuncheckedå¼‚å¸¸æ—¶æ ‡è®°å›æ»šäº‹åŠ¡ï¼›ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æŠ›å‡ºçš„å¼‚å¸¸æ˜¯ä¸€ä¸ªå®ä¾‹æˆ–è€…RuntimeExceptionçš„å­ç±»ã€‚ï¼ˆErrorsåœ¨é»˜è®¤é…ç½®ä¸‹ä¹Ÿä¼šå›æ»šï¼‰ã€‚åœ¨ä¸€ä¸ªäº‹åŠ¡æ–¹æ³•ä¸­æŠ›å‡ºçš„å·²æ£€æŸ¥å¼‚å¸¸åœ¨é»˜è®¤é…ç½®ä¸‹ä¸ä¼šé€ æˆå›æ»šã€‚</p><p>ä½ å¯ä»¥å‡†ç¡®çš„é…ç½®å“ªäº›ç±»å‹çš„å¼‚å¸¸æ ‡è®°äº‹åŠ¡å›æ»šï¼ŒåŒ…æ‹¬å·²æ£€æŸ¥çš„å¼‚å¸¸ã€‚ä¸‹é¢çš„XMLç‰‡æ®µæ¼”ç¤ºä½ æ€æ ·ç»™å·²æ£€æŸ¥å’Œåº”ç”¨æŒ‡å®šå¼‚å¸¸ç±»å‹é…ç½®å›æ»šã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;tx:advice id=&quot;txAdvice&quot; transaction-manager=&quot;txManager&quot;&gt;</span><br><span class="line">    &lt;tx:attributes&gt;</span><br><span class="line">    &lt;tx:method name=&quot;get*&quot; read-only=&quot;true&quot; rollback-for=&quot;NoProductInStockException&quot;/&gt;</span><br><span class="line">    &lt;tx:method name=&quot;*&quot;/&gt;</span><br><span class="line">    &lt;/tx:attributes&gt;</span><br><span class="line">&lt;/tx:advice&gt;</span><br></pre></td></tr></table></figure><p>å¦‚æœå½“æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸çš„æ—¶å€™ï¼Œä½ ä¸æƒ³äº‹åŠ¡å›æ»šï¼Œä½ ä¹Ÿå¯ä»¥æŒ‡å®šâ€˜ä¸å›æ»šè§„åˆ™â€™ã€‚ä¸‹é¢çš„åˆ—å­å‘Šè¯‰ä½ Springæ¡†æ¶çš„äº‹åŠ¡åŸºç¡€è®¾æ–½å³ä½¿é¢å¯¹æœªå¤„ç†çš„InstrumentNotFoundExceptionä¹Ÿè¦æäº¤<strong>ä¼´éš</strong>äº‹åŠ¡ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;tx:advice id=&quot;txAdvice&quot;&gt;</span><br><span class="line">    &lt;tx:attributes&gt;</span><br><span class="line">    &lt;tx:method name=&quot;updateStock&quot; no-rollback-for=&quot;InstrumentNotFoundException&quot;/&gt;</span><br><span class="line">    &lt;tx:method name=&quot;*&quot;/&gt;</span><br><span class="line">    &lt;/tx:attributes&gt;</span><br><span class="line">&lt;/tx:advice&gt;</span><br></pre></td></tr></table></figure><p>å½“Springæ¡†æ¶çš„äº‹åŠ¡åŸºç¡€è®¾æ–½ç¼“å­˜ä¸€ä¸ªå¼‚å¸¸ï¼Œå‚è€ƒå›æ»šé…ç½®è§„åˆ™æ¥å†³å®šæ˜¯å¦æ ‡è®°å›æ»šäº‹åŠ¡æ—¶ï¼Œå¼ºåŒ¹é…è§„åˆ™èƒœåˆ©ã€‚å› æ­¤ï¼Œåœ¨ä¸‹é¢é…ç½®çš„è¿™ç§æƒ…å†µï¼Œé™¤<code>InstrumentNotFoundException</code>ä»¥å¤–çš„æ‰€æœ‰å¼‚å¸¸éƒ½ä¼šé€ æˆä¼´éšäº‹åŠ¡çš„å›æ»šã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;tx:advice id=&quot;txAdvice&quot;&gt;</span><br><span class="line">    &lt;tx:attributes&gt;</span><br><span class="line">    &lt;tx:method name=&quot;*&quot; rollback-for=&quot;Throwable&quot; no-rollback-for=&quot;InstrumentNotFoundException&quot;/&gt;</span><br><span class="line">    &lt;/tx:attributes&gt;</span><br><span class="line">&lt;/tx:advice&gt;</span><br></pre></td></tr></table></figure><p>ä½ å¯ä»¥è¡¨ç¤ºä¸€ä¸ªéœ€è¦ç¼–ç¨‹å¼å›æ»šã€‚å°½ç®¡éå¸¸ç®€å•ï¼Œè¿™ä¸ªè¿›ç¨‹æ—¶ä¾µå…¥å¼çš„ï¼ŒSpringæ¡†æ¶çš„äº‹åŠ¡åŸºç¡€è®¾æ–½å°†ç´§ç´§ä¾µå…¥ä½ çš„ä»£ç ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public void resolvePosition() &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        // some business logic...</span><br><span class="line">    &#125; catch (NoProductInStockException ex) &#123;</span><br><span class="line">        // trigger rollback programmatically</span><br><span class="line">        TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœæœ‰å¯èƒ½å¼ºçƒˆæ¨èä½¿ç”¨å£°æ˜å¼é€”å¾„å›æ»šäº‹åŠ¡ã€‚ç¼–ç¨‹å¼äº‹åŠ¡å›æ»šåº”è¯¥åœ¨ä½ ç»å¯¹éœ€è¦æ—¶ä½¿ç”¨ï¼Œä½†æ˜¯å®ƒçš„ç”¨æ³•åœ¨å®ç°åŸºäºPOJOçš„æ¸…æ´æ¡†æ¶æ—¶å¾ˆæ˜æ˜¾ã€‚</p><h3 id="1-5-4-ç»™ä¸åŒçš„beané…ç½®ä¸åŒçš„äº‹åŠ¡è¯­ä¹‰"><a href="#1-5-4-ç»™ä¸åŒçš„beané…ç½®ä¸åŒçš„äº‹åŠ¡è¯­ä¹‰" class="headerlink" title="1.5.4 ç»™ä¸åŒçš„beané…ç½®ä¸åŒçš„äº‹åŠ¡è¯­ä¹‰"></a>1.5.4 ç»™ä¸åŒçš„beané…ç½®ä¸åŒçš„äº‹åŠ¡è¯­ä¹‰</h3><p>è€ƒè™‘å…·æœ‰å¤šä¸ªæœåŠ¡å±‚å¯¹è±¡çš„æƒ…å†µï¼Œå¹¶ä¸”æ‚¨å¸Œæœ›å¯¹æ¯ä¸ªå¯¹è±¡åº”ç”¨å®Œå…¨ä¸åŒçš„äº‹åŠ¡é…ç½®ã€‚ä½¿ç”¨ä¸åŒçš„åˆ‡å…¥ç‚¹å’Œadvice-refå±æ€§å€¼å®šä¹‰ä¸åŒçš„&lt;aopï¼šadvisor /&gt;å…ƒç´ ã€‚ä½œä¸ºæ¯”è¾ƒï¼Œé¦–å…ˆå‡è®¾æ‚¨çš„æ‰€æœ‰æœåŠ¡å±‚ç±»éƒ½åœ¨æ ¹x.y.serviceåŒ…ä¸­å®šä¹‰ã€‚è¦ä½¿æ‰€æœ‰ä½œä¸ºåœ¨è¯¥åŒ…ï¼ˆæˆ–å­åŒ…ä¸­ï¼‰ä¸­å®šä¹‰çš„ç±»çš„å®ä¾‹çš„beanä»¥åŠä»¥Serviceç»“å°¾çš„åç§°å…·æœ‰é»˜è®¤çš„äº‹åŠ¡é…ç½®ï¼Œæ‚¨å°†ç¼–å†™ä»¥ä¸‹å†…å®¹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">    xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot;</span><br><span class="line">    xmlns:tx=&quot;http://www.springframework.org/schema/tx&quot;</span><br><span class="line">    xsi:schemaLocation=&quot;</span><br><span class="line">        http://www.springframework.org/schema/beans</span><br><span class="line">        http://www.springframework.org/schema/beans/spring-beans.xsd</span><br><span class="line">        http://www.springframework.org/schema/tx</span><br><span class="line">        http://www.springframework.org/schema/tx/spring-tx.xsd</span><br><span class="line">        http://www.springframework.org/schema/aop</span><br><span class="line">        http://www.springframework.org/schema/aop/spring-aop.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;aop:config&gt;</span><br><span class="line"></span><br><span class="line">        &lt;aop:pointcut id=&quot;serviceOperation&quot;</span><br><span class="line">                expression=&quot;execution(* x.y.service..*Service.*(..))&quot;/&gt;</span><br><span class="line"></span><br><span class="line">        &lt;aop:advisor pointcut-ref=&quot;serviceOperation&quot; advice-ref=&quot;txAdvice&quot;/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;/aop:config&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- these two beans will be transactional... --&gt;</span><br><span class="line">    &lt;bean id=&quot;fooService&quot; class=&quot;x.y.service.DefaultFooService&quot;/&gt;</span><br><span class="line">    &lt;bean id=&quot;barService&quot; class=&quot;x.y.service.extras.SimpleBarService&quot;/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- ... and these two beans won&apos;t --&gt;</span><br><span class="line">    &lt;bean id=&quot;anotherService&quot; class=&quot;org.xyz.SomeService&quot;/&gt; &lt;!-- (not in the right package) --&gt;</span><br><span class="line">    &lt;bean id=&quot;barManager&quot; class=&quot;x.y.service.SimpleBarManager&quot;/&gt; &lt;!-- (doesn&apos;t end in &apos;Service&apos;) --&gt;</span><br><span class="line"></span><br><span class="line">    &lt;tx:advice id=&quot;txAdvice&quot;&gt;</span><br><span class="line">        &lt;tx:attributes&gt;</span><br><span class="line">            &lt;tx:method name=&quot;get*&quot; read-only=&quot;true&quot;/&gt;</span><br><span class="line">            &lt;tx:method name=&quot;*&quot;/&gt;</span><br><span class="line">        &lt;/tx:attributes&gt;</span><br><span class="line">    &lt;/tx:advice&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- other transaction infrastructure beans such as a PlatformTransactionManager omitted... --&gt;</span><br><span class="line"></span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢çš„ä¾‹å­å±•ç¤ºæ€æ ·ä½¿ç”¨ä¸¤ç§å®Œå…¨ä¸åŒçš„äº‹åŠ¡è®¾ç½®é…ç½®ä¸¤ç§ä¸åŒçš„beanã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">    xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot;</span><br><span class="line">    xmlns:tx=&quot;http://www.springframework.org/schema/tx&quot;</span><br><span class="line">    xsi:schemaLocation=&quot;</span><br><span class="line">        http://www.springframework.org/schema/beans</span><br><span class="line">        http://www.springframework.org/schema/beans/spring-beans.xsd</span><br><span class="line">        http://www.springframework.org/schema/tx</span><br><span class="line">        http://www.springframework.org/schema/tx/spring-tx.xsd</span><br><span class="line">        http://www.springframework.org/schema/aop</span><br><span class="line">        http://www.springframework.org/schema/aop/spring-aop.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;aop:config&gt;</span><br><span class="line"></span><br><span class="line">        &lt;aop:pointcut id=&quot;defaultServiceOperation&quot;</span><br><span class="line">                expression=&quot;execution(* x.y.service.*Service.*(..))&quot;/&gt;</span><br><span class="line"></span><br><span class="line">        &lt;aop:pointcut id=&quot;noTxServiceOperation&quot;</span><br><span class="line">                expression=&quot;execution(* x.y.service.ddl.DefaultDdlManager.*(..))&quot;/&gt;</span><br><span class="line"></span><br><span class="line">        &lt;aop:advisor pointcut-ref=&quot;defaultServiceOperation&quot; advice-ref=&quot;defaultTxAdvice&quot;/&gt;</span><br><span class="line"></span><br><span class="line">        &lt;aop:advisor pointcut-ref=&quot;noTxServiceOperation&quot; advice-ref=&quot;noTxAdvice&quot;/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;/aop:config&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- this bean will be transactional (see the &apos;defaultServiceOperation&apos; pointcut) --&gt;</span><br><span class="line">    &lt;bean id=&quot;fooService&quot; class=&quot;x.y.service.DefaultFooService&quot;/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- this bean will also be transactional, but with totally different transactional settings --&gt;</span><br><span class="line">    &lt;bean id=&quot;anotherFooService&quot; class=&quot;x.y.service.ddl.DefaultDdlManager&quot;/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;tx:advice id=&quot;defaultTxAdvice&quot;&gt;</span><br><span class="line">        &lt;tx:attributes&gt;</span><br><span class="line">            &lt;tx:method name=&quot;get*&quot; read-only=&quot;true&quot;/&gt;</span><br><span class="line">            &lt;tx:method name=&quot;*&quot;/&gt;</span><br><span class="line">        &lt;/tx:attributes&gt;</span><br><span class="line">    &lt;/tx:advice&gt;</span><br><span class="line"></span><br><span class="line">    &lt;tx:advice id=&quot;noTxAdvice&quot;&gt;</span><br><span class="line">        &lt;tx:attributes&gt;</span><br><span class="line">            &lt;tx:method name=&quot;*&quot; propagation=&quot;NEVER&quot;/&gt;</span><br><span class="line">        &lt;/tx:attributes&gt;</span><br><span class="line">    &lt;/tx:advice&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- other transaction infrastructure beans such as a PlatformTransactionManager omitted... --&gt;</span><br><span class="line"></span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure><h3 id="1-5-5-lt-tx-advice-gt-è®¾ç½®"><a href="#1-5-5-lt-tx-advice-gt-è®¾ç½®" class="headerlink" title="1.5.5 &lt;tx:advice/&gt;è®¾ç½®"></a>1.5.5 <code>&lt;tx:advice/&gt;</code>è®¾ç½®</h3><p>è¿™ä¸ªç« èŠ‚æ€»ç»“å¯ä»¥æŒ‡å®šä½¿ç”¨<code>&lt;tx:advice/&gt;æ ‡ç­¾çš„å„ç§äº‹åŠ¡é…ç½®ã€‚é»˜è®¤çš„</code><a href="tx:advice/" target="_blank" rel="noopener">tx:advice/</a>`è®¾ç½®ï¼š</p><ul><li>ä¼ æ’­ç‰¹æ€§æ˜¯ <code>REQUIRED</code></li><li>éš”ç¦»ç­‰çº§æ˜¯ <code>DEFAULT</code></li><li>äº‹åŠ¡æ˜¯è¯»/å†™</li><li>äº‹åŠ¡è¶…æ—¶é»˜è®¤ä¸ºåº•å±‚äº‹åŠ¡ç³»ç»Ÿçš„é»˜è®¤è¶…æ—¶ï¼Œå¦‚æœä¸æ”¯æŒè¶…æ—¶åˆ™ä¸ºnone</li><li>ä»»æ„<code>RuntimeException</code>è§¦å‘å›æ»šï¼Œä»»æ„çš„æ£€æŸ¥æ—¶å¼‚å¸¸ä¸å›æ»šã€‚</li></ul><p>ä½ å¯ä»¥æ”¹å˜è¿™äº›é»˜è®¤è®¾ç½®ï¼›åµŒå¥—åœ¨<code>&lt;tx:advice/&gt;</code>å’Œ<code>&lt;tx:attributes/&gt;</code>æ ‡ç­¾ä¸­çš„<code>&lt;tx:method/&gt;</code>æ ‡ç­¾çš„å„ç§å±æ€§æ€»ç»“å¦‚ä¸‹ï¼š<br><a href="tx:method/" target="_blank" rel="noopener">tx:method/</a> è®¾ç½®:<br><img src="media/15531331224039.jpg" alt=""></p><h3 id="1-5-6-ä½¿ç”¨-Transactional"><a href="#1-5-6-ä½¿ç”¨-Transactional" class="headerlink" title="1.5.6 ä½¿ç”¨@Transactional"></a>1.5.6 ä½¿ç”¨@Transactional</h3><p>é™¤äº†åŸºäºXMLçš„æ–¹å¼å£°æ˜äº‹åŠ¡é…ç½®ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨åŸºäºæ³¨è§£çš„æ–¹å¼ã€‚ç›´æ¥åœ¨Javaæºä»£ç ä¸­å£°æ˜äº‹åŠ¡è¯­ä¹‰ä½¿å£°æ˜æ›´æ¥è¿‘è¢«ä½œç”¨çš„ä»£ç ã€‚æ²¡æœ‰å¤ªå¤šè¿‡åº¦è€¦åˆçš„å±é™©ï¼Œå› ä¸ºæ— è®ºå¦‚ä½•ï¼Œä»¥äº‹åŠ¡æ–¹å¼ä½¿ç”¨çš„ä»£ç å‡ ä¹æ€»æ˜¯ä»¥è¿™ç§æ–¹å¼éƒ¨ç½²ã€‚</p><blockquote><p>æ ‡å‡†<code>javax.transaction.Transactional</code>æ³¨è§£æ”¯æŒä½¿ç”¨Springè‡ªå·±çš„æ³¨è§£ç›´æ¥æ›¿æ¢ã€‚è¯·å‚è€ƒJTA 1.2 æ–‡æ¡£äº†è§£æ›´å¤šè¯¦ç»†èµ„æ–™ã€‚</p></blockquote><p>ä½¿ç”¨@Transactionalæ³¨é‡Šæ‰€æä¾›çš„æ˜“ç”¨æ€§æœ€å¥½é€šè¿‡ä¸€ä¸ªç¤ºä¾‹æ¥è¯´æ˜ï¼Œè¯¥ç¤ºä¾‹å°†åœ¨åé¢çš„æ–‡æœ¬ä¸­è¿›è¡Œè¯´æ˜ã€‚è€ƒè™‘ä»¥ä¸‹ç±»å®šä¹‰ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// the service class that we want to make transactional</span><br><span class="line">@Transactional</span><br><span class="line">public class DefaultFooService implements FooService &#123;</span><br><span class="line"></span><br><span class="line">    Foo getFoo(String fooName);</span><br><span class="line"></span><br><span class="line">    Foo getFoo(String fooName, String barName);</span><br><span class="line"></span><br><span class="line">    void insertFoo(Foo foo);</span><br><span class="line"></span><br><span class="line">    void updateFoo(Foo foo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å½“ä¸Šé¢çš„POJOè¢«å®šä¹‰ä¸ºSpring IoCå®¹å™¨ä¸­çš„beanæ—¶ï¼Œå¯ä»¥é€šè¿‡ä»…æ·»åŠ ä¸€è¡ŒXMLé…ç½®æ¥ä½¿beanå®ä¾‹æˆä¸ºäº‹åŠ¡æ€§çš„ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;!-- from the file &apos;context.xml&apos; --&gt;</span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">    xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot;</span><br><span class="line">    xmlns:tx=&quot;http://www.springframework.org/schema/tx&quot;</span><br><span class="line">    xsi:schemaLocation=&quot;</span><br><span class="line">        http://www.springframework.org/schema/beans</span><br><span class="line">        http://www.springframework.org/schema/beans/spring-beans.xsd</span><br><span class="line">        http://www.springframework.org/schema/tx</span><br><span class="line">        http://www.springframework.org/schema/tx/spring-tx.xsd</span><br><span class="line">        http://www.springframework.org/schema/aop</span><br><span class="line">        http://www.springframework.org/schema/aop/spring-aop.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- this is the service object that we want to make transactional --&gt;</span><br><span class="line">    &lt;bean id=&quot;fooService&quot; class=&quot;x.y.service.DefaultFooService&quot;/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- enable the configuration of transactional behavior based on annotations --&gt;</span><br><span class="line">    &lt;tx:annotation-driven transaction-manager=&quot;txManager&quot;/&gt;&lt;!-- a PlatformTransactionManager is still required --&gt;</span><br><span class="line">    &lt;bean id=&quot;txManager&quot; class=&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;&gt;</span><br><span class="line">        &lt;!-- (this dependency is defined somewhere else) --&gt;</span><br><span class="line">        &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot;/&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- other &lt;bean/&gt; definitions here --&gt;</span><br><span class="line"></span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure><blockquote><p>å¦‚æœè¦è¿æ¥çš„<code>PlatformTransactionManager</code>çš„beançš„åå­—æ˜¯<code>transactionManager</code>ï¼Œä½ å¯ä»¥å¿½ç•¥<code>&lt;tx:annotation-driven</code>/&gt;çš„<code>transaction-manager</code>å±æ€§ã€‚å¦‚æœä½ è¦ä¾èµ–æ³¨å…¥çš„<code>PlatformTransactionManager</code>beanæœ‰ä»»ä½•å…¶ä»–çš„åå­—ï¼Œä½ å¿…é¡»å’Œä¸Šé¢çš„ä¾‹å­ä¸€æ ·æ˜ç¡®çš„ä½¿ç”¨<code>transaction-manager</code>ã€‚<br>å¦‚æœä½ åŸºäºJavaé…ç½®ï¼Œ<code>@EnableTransactionManagement</code>æ³¨è§£æä¾›æœ‰æ•ˆçš„æ”¯æŒã€‚åªéœ€æ·»åŠ <code>@Configuration</code>æ³¨è§£ç±»ã€‚æŸ¥çœ‹å…¨éƒ¨è¯¦ç»†å†…å®¹è¯·çœ‹javadocsã€‚</p></blockquote><blockquote><p><b>æ–¹æ³•å¯è§æ€§å’Œ@Transaction</b><br>å½“ä½¿ç”¨ä»£ç†æ—¶ï¼Œä»…ä»…å¯¹äºpublicå¯è§æ€§çš„æ–¹æ³•åº”ç”¨<code>@Transactional</code>æ³¨è§£ã€‚å¦‚æœä½ å¯¹protectedï¼Œprivateæˆ–è€…åŒ…å†…å¯è§çš„æ–¹æ³•ä½¿ç”¨<code>@Transactional</code>æ³¨è§£ï¼Œè™½ç„¶æ²¡æœ‰é”™è¯¯ï¼Œä½†æ˜¯è¿™ä¸ªå·²ç»æ³¨è§£çš„æ–¹æ³•ä¸å±•ç¤ºå·²é…ç½®çš„äº‹åŠ¡é…ç½®ã€‚å¦‚æœä½ éœ€è¦ç›´æ¥épublicçš„æ–¹æ³•ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨AspectJï¼ˆè§ä¸‹æ–‡ï¼‰ã€‚</p></blockquote><p>ä½ å¯ä»¥åœ¨ä¸€ä¸ªæ¥å£å®šä¹‰ï¼Œæ¥å£ä¸Šçš„æ–¹æ³•ï¼Œç±»å®šä¹‰æˆ–è€…ç±»ä¸Šçš„publicæ–¹æ³•å‰é¢è®¾ç½®<code>@Transactional</code>ã€‚ä½†æ˜¯ï¼Œåªæœ‰<code>@Transactional</code>æ³¨è§£æ˜¯ä¸è¶³ä»¥æ¿€æ´»äº‹åŠ¡è¡Œä¸ºçš„ã€‚<code>@Transactional</code>æ³¨è§£æ˜¯ä¸€ä¸ªç®€å•çš„å…ƒæ•°æ®ï¼Œå®ƒå¯ä»¥è¢«ä¸€äº›è¿è¡Œæ—¶çš„åŸºç¡€è®¾æ–½æ¶ˆè´¹ï¼Œè¿™ä¸ªåŸºç¡€è®¾æ–½æ˜¯<code>@Transactional</code>-awareå’Œå¯ä»¥ä½¿ç”¨å…ƒæ•°æ®é…ç½®å…·æœ‰äº‹åŠ¡è¡Œä¸ºçš„é€‚å½“çš„beanã€‚åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œ<code>&lt;tx:annotation-driven/&gt;</code>å…ƒç´ æ‰“å¼€äº‹åŠ¡è¡Œä¸ºã€‚</p><blockquote><p>Spring æ¨èä½ åªä½¿ç”¨<code>@Transactional</code>æ³¨è§£å…·ä½“ç±»ï¼ˆå’Œå…·ä½“ç±»çš„æ–¹æ³•ï¼‰ï¼Œè€Œä¸æ˜¯æ³¨è§£æ¥å£ã€‚ä½ é€šå¸¸å¯ä»¥åœ¨ä¸€ä¸ªæ¥å£ï¼ˆæˆ–è€…ä¸€ä¸ªæ¥å£çš„æ–¹æ³•ï¼‰ä¸Šé…ç½®<code>@Transactional</code>æ³¨è§£ï¼Œä½†æ˜¯ï¼Œä»…ä»…åœ¨ä½ ä½¿ç”¨åŸºäºæ¥å£ä»£ç†çš„æ–¹å¼æ—¶æ‰èƒ½è·å¾—ä½ æœŸæœ›çš„è¿è¡Œã€‚Javaæ³¨è§£ä¸ä»æ¥å£ç»§æ‰¿Javaæ³¨è§£çš„äº‹å®æ„å‘³ç€å¦‚æœä½ ä½¿ç”¨åŸºäºç±»çš„ä»£ç†ï¼ˆ<code>proxy-target-class=&quot;true&quot;</code>ï¼‰æˆ–è€…åŸºäºåˆ‡é¢ç»‡å…¥ï¼ˆ<code>mode=&quot;&quot;aspectj</code>ï¼‰ï¼Œç„¶åä»£ç†å’Œç»‡å…¥çš„åŸºç¡€è®¾æ–½å°†ä¸è¯†åˆ«äº‹åŠ¡è®¾ç½®ï¼Œå¹¶ä¸”è¿™ä¸ªå¯¹è±¡ä¸è¢«åŒ…è£¹åœ¨äº‹åŠ¡ä»£ç†ä¸­ï¼Œè¿™å°†æ˜¯éå¸¸ç³Ÿç³•çš„ã€‚</p></blockquote><blockquote><p>åœ¨ä»£ç†æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰ä¸­ï¼Œä»…å¤–éƒ¨çš„æ–¹æ³•é€šè¿‡ä»£ç†è°ƒç”¨è¿›å…¥ä¼šè¢«æ‹¦æˆªã€‚è¿™æ„å‘³ç€è‡ªæˆ‘è°ƒç”¨ï¼Œå®é™…ä¸Šï¼Œåœ¨ç›®æ ‡å¯¹è±¡çš„æ–¹æ³•è°ƒç”¨ç›®æ ‡å¯¹è±¡çš„å…¶ä»–æ–¹æ³•å°†ä¸ä¼šåœ¨è¿è¡Œæ—¶å¼•èµ·ä¸€ä¸ªå®é™…çš„äº‹åŠ¡ï¼Œå³ä½¿è¢«è°ƒç”¨çš„æ–¹æ³•ä½¿ç”¨<code>@Transactional</code>æ ‡è®°ã€‚è¿™ä¸ªä»£ç†ä¹Ÿå¿…é¡»å®Œæ•´çš„åˆå§‹åŒ–å»æä¾›ä½ æœŸæœ›çš„è¡Œä¸ºï¼Œå› æ­¤ï¼Œä½ ä¸åº”è¯¥åœ¨ä½ çš„åˆå§‹åŒ–ä»£ç ä¸­ä¾èµ–è¿™ä¸ªç‰¹æ€§ï¼Œå³<code>@PostConstruct</code>ã€‚</p></blockquote><p>å¦‚æœä½ å¸Œæœ›è‡ªæˆ‘è°ƒç”¨ä¹Ÿè¢«åŒ…è£¹åœ¨äº‹åŠ¡ä¸­ï¼Œå¯ä»¥è€ƒè™‘åˆ‡é¢æ¨¡å¼ï¼ˆåœ¨ä¸‹é¢çš„è¡¨æ ¼ä¸­æŸ¥çœ‹æ¨¡å¼çš„å±æ€§ï¼‰çš„ä½¿ç”¨ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œé¦–å…ˆä¸ä¼šæœ‰ä¸€ä¸ªä»£ç†ï¼›ç›¸åï¼Œä¸ºäº†å°†<code>@Transactional</code>è½¬æ¢ä¸ºä»»ä½•ç±»å‹æ–¹æ³•ä¸Šçš„è¿è¡Œæ—¶è¡Œä¸ºï¼Œç›®æ ‡ç±»å°†è¢«ç»‡å…¥ï¼ˆå®ƒçš„å­—èŠ‚ç å°†è¢«ä¿®æ”¹ï¼‰ã€‚</p><p><table><tr><td>XML Attribute</td><td>Annotation Attribute</td><td>Default</td><td>Description</td></tr><tr><td><code>transaction-manger</code></td><td>N/A(æŸ¥çœ‹<code>TransactionManagementConfigurer</code> javadocs)</td><td>transactionManager</td><td>è¦ä½¿ç”¨çš„äº‹åŠ¡ç®¡ç†å™¨çš„åç§°ã€‚ä»…åœ¨å¦‚æœäº‹åŠ¡ç®¡ç†å™¨çš„åç§°ä¸æ˜¯<code>transactionManager</code>æ—¶éœ€è¦ï¼Œå¦‚ä¸Šé¢çš„ä¾‹å­æ‰€ç¤º</td></tr><tr><td><code>mode</code></td><td><code>mode</code></td><td>proxy</td><td>é»˜è®¤æ¨¡å¼â€œä»£ç†â€è¿›ç¨‹ä½¿ç”¨Springçš„AOPæ¡†æ¶ï¼ˆä»¥ä¸‹ä»£ç†è¯­ä¹‰ï¼Œæ­£å¦‚ä¸Šé¢è®¨è®ºçš„ï¼Œä»…é€‚ç”¨äºé€šè¿‡ä»£ç†è¿›å…¥çš„æ–¹æ³•è°ƒç”¨ï¼‰ä»£ç†è¢«æ³¨è§£çš„beanã€‚æ›¿ä»£æ¨¡å¼â€œaspectjâ€ä»£æ›¿ä½¿ç”¨Springçš„AspectJäº‹åŠ¡åˆ‡é¢ç»‡å…¥å—å½±å“çš„ç±»ï¼Œä¿®æ”¹ç›®æ ‡ç±»å­—èŠ‚ç ä»¥åº”ç”¨ä»»ä½•ç±»å‹çš„æ–¹æ³•è°ƒç”¨ã€‚AspectJ ç»‡å…¥éœ€è¦spring-aspects.jaråœ¨classpathä¸­ï¼ŒåŒæ—¶åŠ è½½æ—¶ç»‡å…¥ï¼ˆç¼–è¯‘æ—¶ç»‡å…¥ï¼‰å¼€å¯ã€‚ï¼ˆæŸ¥çœ‹æ€æ ·è®¾ç½®åŠ è½½æ—¶ç»‡å…¥çš„è¯¦ç»†å†…å®¹ï¼Œè¯·è®¿é—®<a href="https://docs.spring.io/spring/docs/4.2.x/spring-framework-reference/html/aop.html#aop-aj-ltw-spring" target="_blank" rel="noopener">Springé…ç½®</a>ï¼‰</td></tr><tr><td><code>proxy-target-class</code></td><td><code>proxyTargetClass</code></td><td>false</td><td>ä»…é€‚ç”¨ä»£ç†æ¨¡å¼ã€‚æ§åˆ¶ç»™å¸¦æœ‰<code>@Transactional</code>æ³¨è§£çš„æ³¨è§£ç±»åˆ›å»ºä»€ä¹ˆç±»å‹çš„äº‹åŠ¡ä»£ç†ã€‚å¦‚æœ<code>proxy-target-class</code>å±æ€§è®¾ç½®ä¸º<code>true</code>ï¼ŒåŸºäºç±»çš„ä»£ç†å°†è¢«åˆ›å»ºã€‚å¦‚æœ<code>proxy-target-class</code>ä¸ºfalseæˆ–è€…è¿™ä¸ªå±æ€§è¢«å¿½ç•¥ï¼Œæ ‡å‡†JDKåŸºäºæ¥å£çš„ä»£ç†å°†è¢«åˆ›å»ºã€‚ï¼ˆè¯¦ç»†æ£€æŸ¥ä¸åŒç±»å‹ä»£ç†è¯·æŸ¥çœ‹<a href="https://docs.spring.io/spring/docs/4.2.x/spring-framework-reference/html/aop.html#aop-proxyingï¼‰&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;`order`&lt;/td&gt;&lt;td&gt;`order`&lt;/td&gt;&lt;td&gt;Ordered.LOWEST_PRECEDENCE&lt;/td&gt;&lt;td&gt;å®šä¹‰äº‹åŠ¡adviceçš„orderé€‚ç”¨äºå¸¦æœ‰`@Transaction`æ³¨è§£çš„beanã€‚ï¼ˆå…³äºæœ‰å…³AOP adviceçš„è§„åˆ™çš„æ›´å¤šä¿¡æ¯ï¼ŒæŸ¥çœ‹[Advice ordering](https://docs.spring.io/spring/docs/4.2.x/spring-framework-reference/html/aop.html#aop-ataspectj-advice-ordering" target="_blank" rel="noopener">10.6 ä»£ç†æœºåˆ¶</a>ã€‚ï¼‰ä¸æŒ‡å®šorderingæ„å‘³ç€AOPå­ç³»ç»Ÿå†³å®šadviceçš„order</td></tr></table></p><blockquote><p><code>@EnableTransactionManagement</code>å’Œ<code>&lt;tx:annotation-driven/&gt;</code>åªæŸ¥æ‰¾å®ƒä»¬å®šä¹‰åœ¨ç›¸åŒåº”ç”¨ä¸Šä¸‹æ–‡beanä¸Šçš„<code>@Transactional</code>ã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœä½ åœ¨ä¸€ä¸ª<code>WebApplicationContext</code>ä¸­ç»™ä¸€ä¸ª<code>DispatcherServlet</code>æ·»åŠ æ³¨è§£é©±åŠ¨é…ç½®ï¼Œå®ƒä»…ä»…æ£€æŸ¥ä½ controllerå¸¦æœ‰<code>@Transactional</code>çš„beanï¼Œè€Œä¸æ˜¯ä½ çš„serviceã€‚äº†è§£æ›´å¤šä¿¡æ¯æŸ¥çœ‹<a href="https://docs.spring.io/spring/docs/4.2.x/spring-framework-reference/html/mvc.html#mvc-servlet" target="_blank" rel="noopener">The DispatcherServlet</a>ã€‚</p></blockquote><p>åœ¨è¯„ä¼°æ–¹æ³•çš„äº‹åŠ¡è®¾ç½®æ—¶ï¼Œæ´¾ç”Ÿæœ€å¤šçš„ä½ç½®ä¼˜å…ˆã€‚ä¸‹é¢åˆ—å­çš„è¿™ç§æƒ…å†µï¼Œ<code>DefaultFooService</code>ç±»åœ¨ç±»çº§åˆ«ä¸­ä½¿ç”¨åªè¯»äº‹åŠ¡è®¾ç½®æ³¨è§£ï¼Œä½†æ˜¯ï¼Œåœ¨ç›¸åŒçš„ç±»ä¸­ï¼Œåœ¨<code>updateFoo(Foo)</code>æ–¹æ³•ä¸Šçš„<code>@Transactional</code>æ³¨è§£ä¼˜å…ˆäºç±»çº§åˆ«å®šä¹‰çš„äº‹åŠ¡è®¾ç½®ã€‚</p><blockquote><p><b>@Transactional è®¾ç½®</b><br><code>@Transactional</code>æ³¨è§£æ˜¯ä¸€ä¸ªå…ƒæ•°æ®ï¼Œè¿™ä¸ªå…ƒæ•°æ®æŒ‡å®šä¸€ä¸ªæ¥å£ï¼Œç±»æˆ–è€…æ–¹æ³•å¿…é¡»æœ‰äº‹åŠ¡è¯­ä¹‰ï¼›ä¾‹å¦‚ï¼Œâ€œå½“æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œå¼€å§‹ä¸€ä¸ªå…¨æ–°çš„åªè¯»äº‹åŠ¡ï¼Œä¸­æ­¢ä»»ä½•å·²å­˜åœ¨çš„äº‹åŠ¡â€œã€‚é»˜è®¤çš„<code>@Transactional</code>è®¾ç½®å¦‚ä¸‹ï¼š</p></blockquote><ul><li>ä¼ æ’­ç‰¹æ€§è®¾ç½®æ˜¯<code>PROPAGATION_REQUIRED</code>ã€‚</li><li>éš”ç¦»ç­‰çº§æ˜¯<code>ISOLATION_DEFAULT</code>ã€‚</li><li>äº‹åŠ¡æ˜¯è¯»/å†™ã€‚</li><li>äº‹åŠ¡è¶…æ—¶é»˜è®¤æ˜¯åº•å±‚äº‹åŠ¡ç³»ç»Ÿçš„é»˜è®¤è¶…æ—¶ï¼Œæˆ–è€…å¦‚æœä¸æ”¯æŒè¶…æ—¶ä¸ºnoneã€‚</li><li>ä»»ä½•<code>RuntimeException</code>è§¦å‘å›æ»šï¼Œä»»ä½•å·²æ ¡éªŒå¼‚å¸¸ä¸ä¼šã€‚</li></ul><p>è¿™äº›é»˜è®¤è®¾ç½®å¯ä»¥æ”¹å˜ï¼›åœ¨ä¸‹è¡¨ä¸­æ€»ç»“äº†<code>@Transactional</code>æ³¨è§£çš„å„ç§å±æ€§ï¼š</p><p><table><tr><td>Property</td><td>Type</td><td>Description</td></tr><tr><td>value</td><td>String</td><td>å¯é€‰é™å®šç¬¦ï¼ŒæŒ‡å®šè¦ä½¿ç”¨çš„äº‹åŠ¡ç®¡ç†å™¨</td></tr><tr><td>propagation</td><td>enum:<code>Propagation</code></td><td>å¯é€‰ä¼ æ’­ç‰¹æ€§è®¾ç½®</td></tr><tr><td><code>isolation</code></td><td>enum:<code>Isolation</code></td><td>å¯é€‰éš”ç¦»çº§åˆ«</td></tr><tr><td><code>readOnly</code></td><td>boolean</td><td>è¯»/å†™ vs åªè¯»</td></tr><tr><td><code>timeout</code></td><td>int(ç§’ç²’åº¦)</td><td>äº‹åŠ¡è¶…æ—¶</td></tr><tr><td><code>rollbackFor</code></td><td>ç±»çš„å¯¹è±¡æ•°ç»„ï¼Œå¿…é¡»ä»<code>Throwable</code>æ´¾ç”Ÿ</td><td>å¯é€‰å¼‚å¸¸ç±»æ•°ç»„ï¼Œè¿™äº›å¼‚å¸¸å¿…é¡»é€ æˆå›æ»š</td></tr><tr><td><code>rollbackForClassName</code></td><td>ç±»çš„åç§°æ•°ç»„ï¼Œç±»å¿…é¡»ä»<code>Throwable</code>æ´¾ç”Ÿ</td><td>å¯é€‰å¼‚å¸¸ç±»åç§°æ•°ç»„ï¼Œå¿…é¡»é€ æˆå›æ»š</td></tr><tr><td><code>noRollbackFor</code></td><td>ç±»çš„å¯¹è±¡æ•°ç»„ï¼Œå¿…é¡»ä»<code>Throwable</code>æ´¾ç”Ÿ</td><td>å¯é€‰å¼‚å¸¸ç±»æ•°ç»„ï¼Œè¿™äº›å¼‚å¸¸å¿…é¡»ä¸é€ æˆå›æ»š</td></tr><tr><td><code>noRollbackForClassName</code></td><td>ç±»çš„åç§°æ•°ç»„ï¼Œç±»å¿…é¡»ä»<code>Throwable</code>æ´¾ç”Ÿ</td><td>å¯é€‰å¼‚å¸¸ç±»åç§°æ•°ç»„ï¼Œå¿…é¡»ä¸é€ æˆå›æ»š</td></tr></table><br>ç›®å‰ï¼Œä½ æ— æ³•æ˜ç¡®çš„æŒæ§äº‹åŠ¡çš„åç§°ï¼Œå¦‚æœé€‚ç”¨ï¼Œå…¶ä¸­<code>name</code>è¡¨ç¤ºå°†åœ¨äº‹åŠ¡ç›‘è§†å™¨ä¸­æ˜¾ç¤ºçš„äº‹åŠ¡åç§°ï¼Œä»¥åŠæ—¥å¿—è®°å½•è¾“å‡ºã€‚å¯¹äºå£°æ˜å¼äº‹åŠ¡ï¼Œäº‹åŠ¡åæ€»æ˜¯å…¨é‡ç±»å+â€œ.â€+äº‹åŠ¡çš„advisedç±»çš„æ–¹æ³•åã€‚ä¾‹å¦‚ï¼Œå¦‚æœ<code>BusinessService</code>ç±»çš„<code>handlePayment(...)</code>æ–¹æ³•å¼€å§‹ä¸€ä¸ªäº‹åŠ¡ï¼Œäº‹åŠ¡åç§°å°†ä¼šæ˜¯<code>com.foo.BusinessService.handlePayment</code>ã€‚</p><h4 id="ä½¿ç”¨-Transactionalçš„å¤šä¸ªäº‹åŠ¡ç®¡ç†"><a href="#ä½¿ç”¨-Transactionalçš„å¤šä¸ªäº‹åŠ¡ç®¡ç†" class="headerlink" title="ä½¿ç”¨@Transactionalçš„å¤šä¸ªäº‹åŠ¡ç®¡ç†"></a>ä½¿ç”¨@Transactionalçš„å¤šä¸ªäº‹åŠ¡ç®¡ç†</h4><p>å¤§å¤šæ•°Springåº”ç”¨ä»…ä»…éœ€è¦å•ä¸ªäº‹åŠ¡ç®¡ç†ï¼Œä½†æ˜¯å¯èƒ½ä¹Ÿä¼šæœ‰åœ¨å•ä¸ªåº”ç”¨ä¸­ä½ æƒ³å¤šä¸ªç‹¬ç«‹äº‹åŠ¡ç®¡ç†çš„æƒ…å†µã€‚<code>@Transactional</code>æ³¨è§£çš„å±æ€§å€¼å¯ä»¥è¢«ç”¨æ¥é€‰æ‹©æ€§æŒ‡å®šè¦ä½¿ç”¨çš„<code>PlatformTransactionManager</code>ã€‚è¿™å¯ä»¥æ˜¯beançš„åç§°æˆ–è€…äº‹åŠ¡ç®¡ç†beançš„å€¼ã€‚ä¾‹å¦‚ï¼Œå¦‚ä¸‹Javaä»£ç ä½¿ç”¨çš„é™å®šç¬¦å€¼ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public class TransactionalService&#123;</span><br><span class="line"></span><br><span class="line">    @Transactional(&quot;order&quot;)</span><br><span class="line">    public void setSomething(String name)&#123;...&#125;</span><br><span class="line">    </span><br><span class="line">    @Transactional(&quot;account&quot;)</span><br><span class="line">    public void doSomething()&#123;...&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥åœ¨åº”ç”¨ä¸Šä¸‹æ–‡ä¸­å’Œå¦‚ä¸‹çš„äº‹åŠ¡ç®¡ç†beanå£°æ˜ç»„åˆ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;tx:annotation-driven/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id=&quot;transactionManager1&quot; class=&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;&gt;</span><br><span class="line">        ...</span><br><span class="line">        &lt;qualifier value=&quot;order&quot;/&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id=&quot;transactionManager2&quot; class=&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;&gt;</span><br><span class="line">        ...</span><br><span class="line">        &lt;qualifier value=&quot;account&quot;/&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ<code>TransactionalService</code>çš„ä¸¤ä¸ªæ–¹æ³•å°†åœ¨å•ç‹¬äº‹åŠ¡ç®¡ç†å™¨ä¸‹è¿è¡Œï¼Œé€šè¿‡â€œorderâ€å’Œâ€œaccountâ€åŒºåˆ†ã€‚å¦‚æœæ²¡æœ‰æ‰¾åˆ°æŒ‡å®šé™å®šç¬¦çš„<code>PlatformTransactionManager</code>çš„beanï¼Œå°†ä¸€ç›´ä½¿ç”¨<code>&lt;tx:annotation-driven&gt;</code>é»˜è®¤çš„ç›®æ ‡beanåç§°<code>transactionManager</code>ã€‚</p><h4 id="è‡ªå®šä¹‰å¿«æ·æ–¹å¼æ³¨è§£"><a href="#è‡ªå®šä¹‰å¿«æ·æ–¹å¼æ³¨è§£" class="headerlink" title="è‡ªå®šä¹‰å¿«æ·æ–¹å¼æ³¨è§£"></a>è‡ªå®šä¹‰å¿«æ·æ–¹å¼æ³¨è§£</h4><p>å¦‚æœä½ å‘ç°ä½ åœ¨è®¸å¤šä¸åŒæ–¹æ³•ä¸Šé‡å¤ä½¿ç”¨<code>@Transactional</code>çš„ç›¸åŒå±æ€§å€¼ï¼Œ[Springâ€™s meta-annotaion support]å…è®¸ä½ åœ¨ä½ çš„æŒ‡å®šä½¿ç”¨æƒ…å†µä¸‹å®šä¹‰è‡ªå®šä¹‰å¿«æ·æ–¹å¼çš„æ³¨è§£ã€‚ä¾‹å¦‚ï¼Œå¦‚ä¸‹æ³¨è§£çš„å®šä¹‰ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">@Target(&#123;ElementType.METHOD, ElementType.TYPE&#125;)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Transactional(&quot;order&quot;)</span><br><span class="line">public @interface OrderTx &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Target(&#123;ElementType.METHOD, ElementType.TYPE&#125;)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Transactional(&quot;account&quot;)</span><br><span class="line">public @interface AccountTx &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…è®¸æˆ‘ä»¬å°†ä¸Šä¸€å°èŠ‚çš„ä¾‹å­å†™ä¸ºå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public class TransactionalService&#123;</span><br><span class="line">    </span><br><span class="line">    @OrderTx</span><br><span class="line">    public void setSomething(String name)&#123;...&#125;</span><br><span class="line">    </span><br><span class="line">    @AccountTx</span><br><span class="line">    public void doSomething()&#123;...&#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨äº†å®šä¹‰äº‹åŠ¡ç®¡ç†å™¨çš„é™å®šç¬¦è¯­æ³•ï¼Œä½†æ˜¯æˆ‘ä»¬ä¹Ÿå¯ä»¥åŒ…å«ä¼ æ’­ç‰¹æ€§è¡Œä¸ºï¼Œå›æ»šè§„åˆ™ï¼Œè¶…æ—¶ç­‰ç­‰ã€‚</p><h3 id="1-5-7-äº‹åŠ¡ä¼ æ’­ç‰¹æ€§"><a href="#1-5-7-äº‹åŠ¡ä¼ æ’­ç‰¹æ€§" class="headerlink" title="1.5.7 äº‹åŠ¡ä¼ æ’­ç‰¹æ€§"></a>1.5.7 äº‹åŠ¡ä¼ æ’­ç‰¹æ€§</h3><p>è¿™ä¸ªç« èŠ‚æè¿°åœ¨Springä¸­çš„äº‹åŠ¡ä¼ ç»Ÿç‰¹æ€§çš„ä¸€äº›è¯­ä¹‰ã€‚è¯·æ³¨æ„è¿™ä¸ªç« èŠ‚ä¸æ˜¯é€‚å½“çš„ä¸€ä¸ªäº‹åŠ¡ä¼ æ’­ç‰¹æ€§ä»‹ç»ï¼›äºŒæ˜¯è¯¦ç»†æè¿°åœ¨Springä¸­å…³äºäº‹åŠ¡ä¼ æ’­ç‰¹æ€§çš„ä¸€äº›è¯­ä¹‰ã€‚</p><p>åœ¨Springç®¡ç†çš„äº‹åŠ¡ä¸­ï¼Œæ³¨æ„ç‰©ç†å’Œé€»è¾‘äº‹åŠ¡çš„åŒºåˆ«ï¼Œå’Œäº‹åŠ¡ä¼ æ’­ç‰¹æ€§è®¾ç½®å¦‚ä½•åº”ç”¨æ­¤å·®å¼‚ã€‚<br><img src="media/15534834588483.jpg" alt=""></p><p><code>PROPAGATION_REQUIRES_NEW</code>ï¼Œä¸<code>PROPAGATION_REQUIRED</code>ç›¸æ¯”ï¼Œä¸ºæ¯ä¸€ä¸ªäº‹åŠ¡ä½œç”¨åŸŸä½¿ç”¨ä¸€ä¸ªç‹¬ç«‹çš„äº‹åŠ¡ã€‚åœ¨é‚£ç§æƒ…å†µä¸‹ï¼Œåº•å±‚çš„ç‰©ç†äº‹åŠ¡æ˜¯ä¸åŒçš„ï¼Œå› æ­¤å¯ä»¥ç‹¬ç«‹çš„æäº¤æˆ–è€…å›æ»šï¼Œå¤–éƒ¨äº‹åŠ¡ä¸å—å†…éƒ¨äº‹åŠ¡å›æ»šçŠ¶æ€çš„å½±å“ã€‚</p><h4 id="Nested"><a href="#Nested" class="headerlink" title="Nested"></a>Nested</h4><p><code>PROPAGATION_NESTED</code>ä½¿ç”¨å…·æœ‰å¤šä¸ªä¿å­˜ç‚¹çš„å•ä¸ªç‰©ç†äº‹åŠ¡ï¼Œå®ƒå¯ä»¥å›æ»šåˆ°è¯¥äº‹åŠ¡ã€‚ä¸€äº›å±€éƒ¨æ˜¯å›æ»šå…è®¸å†…éƒ¨äº‹åŠ¡åŸŸåœ¨å®ƒçš„ä½œç”¨åŸŸè§¦å‘å›æ»šï¼Œä½¿ç”¨å¤–éƒ¨äº‹åŠ¡å¯ä»¥ç»§ç»­ç‰©ç†äº‹åŠ¡è€Œä¸ç”¨ç®¡ä¸€äº›å·²ç»å›æ»šçš„æ“ä½œã€‚è¿™ä¸ªè®¾ç½®å¸¸ç”¨æ¥æ˜ å°„JDBCçš„ä¿å­˜ç‚¹ã€‚å› æ­¤ä»…ä»…å’ŒJDBCèµ„æºäº‹åŠ¡ä¸€èµ·å·¥ä½œã€‚æŸ¥çœ‹Springçš„<code>DataSourceTransactionManager</code>ã€‚</p><h3 id="1-5-8-Advising-äº‹åŠ¡æ“ä½œ"><a href="#1-5-8-Advising-äº‹åŠ¡æ“ä½œ" class="headerlink" title="1.5.8 Advising äº‹åŠ¡æ“ä½œ"></a>1.5.8 Advising äº‹åŠ¡æ“ä½œ</h3><p>å‡å¦‚ä½ æƒ³åŒæ—¶æ‰§è¡Œäº‹åŠ¡å’Œä¸€äº›åŸºç¡€å‰–æadviceã€‚ä½ æ€æ ·åœ¨<code>&lt;tx:annotaion-driven/&gt;</code>çš„ä¸Šä¸‹æ–‡ä¸­å®ç°è¿™ç‚¹ï¼Ÿ</p><p>å½“ä½ è°ƒç”¨<code>updateFoo(Foo)</code>æ–¹æ³•ï¼Œä½ æƒ³çœ‹åˆ°å¦‚ä¸‹åŠ¨ä½œï¼š</p><ul><li>é…ç½®çš„å‰–æåˆ‡é¢å¯åŠ¨</li><li>äº‹åŠ¡adviceæ‰§è¡Œ</li><li>advisedå¯¹è±¡ä¸Šçš„æ–¹æ³•æ‰§è¡Œ</li><li>äº‹åŠ¡æäº¤</li><li>å‰–æåˆ‡é¢ç²¾ç¡®æŠ¥å‘Šæ•´ä¸ªäº‹åŠ¡æ–¹æ³•è°ƒç”¨æœŸé—´</li></ul><blockquote><p>è¿™ä¸ªç« èŠ‚ä¸å…³å¿ƒè¯¦ç»†ä»‹ç»AOPï¼ˆé™¤éAOPé€‚ç”¨äºäº‹åŠ¡ï¼‰ã€‚æœ‰å…³ä»¥ä¸‹AOPé…ç½®å’ŒAOPçš„è¯¦ç»†ä»‹ç»ï¼Œè¯·å‚è§<a href="https://docs.spring.io/spring/docs/4.2.x/spring-framework-reference/html/aop.html" target="_blank" rel="noopener">Chapter 10,Aspect Oriented Programming with Spring</a>ã€‚</p></blockquote><p>è¿™æ˜¯ä¸Šé¢è®¨è®ºç®€å•å‰–æåˆ‡é¢çš„ä»£ç ã€‚adviceçš„æ’åºç”±<code>Ordered</code>æ¥å£æ§åˆ¶ã€‚äº†è§£advice æ’åºçš„å…¨éƒ¨è¯¦ç»†å†…å®¹ï¼ŒæŸ¥çœ‹<a href="https://docs.spring.io/spring/docs/4.2.x/spring-framework-reference/html/aop.html#aop-ataspectj-advice-ordering" target="_blank" rel="noopener">the section called â€œAdvice orderingâ€</a>..</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">package x.y;</span><br><span class="line"></span><br><span class="line">import org.aspectj.lang.ProceedingJoinPoint;</span><br><span class="line">import org.springframework.util.StopWatch;</span><br><span class="line">import org.springframework.core.Ordered;</span><br><span class="line"></span><br><span class="line">public class SimpleProfiler implements Ordered &#123;</span><br><span class="line"></span><br><span class="line">    private int order;</span><br><span class="line"></span><br><span class="line">    // allows us to control the ordering of advice</span><br><span class="line">    public int getOrder() &#123;</span><br><span class="line">        return this.order;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setOrder(int order) &#123;</span><br><span class="line">        this.order = order;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // this method is the around advice</span><br><span class="line">    public Object profile(ProceedingJoinPoint call) throws Throwable &#123;</span><br><span class="line">        Object returnValue;</span><br><span class="line">        StopWatch clock = new StopWatch(getClass().getName());</span><br><span class="line">        try &#123;</span><br><span class="line">            clock.start(call.toShortString());</span><br><span class="line">            returnValue = call.proceed();</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            clock.stop();</span><br><span class="line">            System.out.println(clock.prettyPrint());</span><br><span class="line">        &#125;</span><br><span class="line">        return returnValue;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">    xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot;</span><br><span class="line">    xmlns:tx=&quot;http://www.springframework.org/schema/tx&quot;</span><br><span class="line">    xsi:schemaLocation=&quot;</span><br><span class="line">        http://www.springframework.org/schema/beans</span><br><span class="line">        http://www.springframework.org/schema/beans/spring-beans.xsd</span><br><span class="line">        http://www.springframework.org/schema/tx</span><br><span class="line">        http://www.springframework.org/schema/tx/spring-tx.xsd</span><br><span class="line">        http://www.springframework.org/schema/aop</span><br><span class="line">        http://www.springframework.org/schema/aop/spring-aop.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id=&quot;fooService&quot; class=&quot;x.y.service.DefaultFooService&quot;/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- this is the aspect --&gt;</span><br><span class="line">    &lt;bean id=&quot;profiler&quot; class=&quot;x.y.SimpleProfiler&quot;&gt;</span><br><span class="line">        &lt;!-- execute before the transactional advice (hence the lower order number) --&gt;</span><br><span class="line">        &lt;property name=&quot;order&quot; __value=&quot;1&quot;__/&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;tx:annotation-driven transaction-manager=&quot;txManager&quot; __order=&quot;200&quot;__/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;aop:config&gt;</span><br><span class="line">            &lt;!-- this advice will execute around the transactional advice --&gt;</span><br><span class="line">            &lt;aop:aspect id=&quot;profilingAspect&quot; ref=&quot;profiler&quot;&gt;</span><br><span class="line">                &lt;aop:pointcut id=&quot;serviceMethodWithReturnValue&quot;</span><br><span class="line">                        expression=&quot;execution(!void x.y..*Service.*(..))&quot;/&gt;</span><br><span class="line">                &lt;aop:around method=&quot;profile&quot; pointcut-ref=&quot;serviceMethodWithReturnValue&quot;/&gt;</span><br><span class="line">            &lt;/aop:aspect&gt;</span><br><span class="line">    &lt;/aop:config&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id=&quot;dataSource&quot; class=&quot;org.apache.commons.dbcp.BasicDataSource&quot; destroy-method=&quot;close&quot;&gt;</span><br><span class="line">        &lt;property name=&quot;driverClassName&quot; value=&quot;oracle.jdbc.driver.OracleDriver&quot;/&gt;</span><br><span class="line">        &lt;property name=&quot;url&quot; value=&quot;jdbc:oracle:thin:@rj-t42:1521:elvis&quot;/&gt;</span><br><span class="line">        &lt;property name=&quot;username&quot; value=&quot;scott&quot;/&gt;</span><br><span class="line">        &lt;property name=&quot;password&quot; value=&quot;tiger&quot;/&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id=&quot;txManager&quot; class=&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;&gt;</span><br><span class="line">        &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot;/&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°é…ç½®çš„ç»“æœæ˜¯ä¸€ä¸ªfooService beanï¼Œå®ƒå…·æœ‰æŒ‰æ‰€éœ€é¡ºåºåº”ç”¨äºå®ƒçš„åˆ†æå’Œäº‹åŠ¡åˆ‡é¢ã€‚ä½ å¯ä»¥ä»¥ç±»ä¼¼çš„æ–¹å¼é…ç½®ä»»æ„æ•°é‡çš„å…¶ä»–åˆ‡é¢ã€‚</p><p>ä»¥ä¸‹ç¤ºä¾‹å®ç°ä¸ä¸Šè¿°ç›¸åŒçš„é…ç½®ï¼Œä½†æ˜¯ä½¿ç”¨çº¯ç²¹çš„XMLå£°æ˜å¼é€”å¾„ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">    xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot;</span><br><span class="line">    xmlns:tx=&quot;http://www.springframework.org/schema/tx&quot;</span><br><span class="line">    xsi:schemaLocation=&quot;</span><br><span class="line">        http://www.springframework.org/schema/beans</span><br><span class="line">        http://www.springframework.org/schema/beans/spring-beans.xsd</span><br><span class="line">        http://www.springframework.org/schema/tx</span><br><span class="line">        http://www.springframework.org/schema/tx/spring-tx.xsd</span><br><span class="line">        http://www.springframework.org/schema/aop</span><br><span class="line">        http://www.springframework.org/schema/aop/spring-aop.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;bean id=&quot;fooService&quot; class=&quot;x.y.service.DefaultFooService&quot;/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- the profiling advice --&gt;</span><br><span class="line">    &lt;bean id=&quot;profiler&quot; class=&quot;x.y.SimpleProfiler&quot;&gt;</span><br><span class="line">        &lt;!-- execute before the transactional advice (hence the lower order number) --&gt;</span><br><span class="line">        __&lt;property name=&quot;order&quot; value=&quot;1__&quot;/&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;aop:config&gt;</span><br><span class="line">        &lt;aop:pointcut id=&quot;entryPointMethod&quot; expression=&quot;execution(* x.y..*Service.*(..))&quot;/&gt;</span><br><span class="line">        &lt;!-- will execute after the profiling advice (c.f. the order attribute) --&gt;</span><br><span class="line"></span><br><span class="line">        &lt;aop:advisor advice-ref=&quot;txAdvice&quot; pointcut-ref=&quot;entryPointMethod&quot; __order=&quot;2__&quot;/&gt;</span><br><span class="line">        &lt;!-- order value is higher than the profiling aspect --&gt;</span><br><span class="line"></span><br><span class="line">        &lt;aop:aspect id=&quot;profilingAspect&quot; ref=&quot;profiler&quot;&gt;</span><br><span class="line">            &lt;aop:pointcut id=&quot;serviceMethodWithReturnValue&quot;</span><br><span class="line">                    expression=&quot;execution(!void x.y..*Service.*(..))&quot;/&gt;</span><br><span class="line">            &lt;aop:around method=&quot;profile&quot; pointcut-ref=&quot;serviceMethodWithReturnValue&quot;/&gt;</span><br><span class="line">        &lt;/aop:aspect&gt;</span><br><span class="line"></span><br><span class="line">    &lt;/aop:config&gt;</span><br><span class="line"></span><br><span class="line">    &lt;tx:advice id=&quot;txAdvice&quot; transaction-manager=&quot;txManager&quot;&gt;</span><br><span class="line">        &lt;tx:attributes&gt;</span><br><span class="line">            &lt;tx:method name=&quot;get*&quot; read-only=&quot;true&quot;/&gt;</span><br><span class="line">            &lt;tx:method name=&quot;*&quot;/&gt;</span><br><span class="line">        &lt;/tx:attributes&gt;</span><br><span class="line">    &lt;/tx:advice&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- other &lt;bean/&gt; definitions such as a DataSource and a PlatformTransactionManager here --&gt;</span><br><span class="line"></span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šé…ç½®çš„ç»“æœæ˜¯ä¸€ä¸ª<code>fooService</code>beanï¼Œå®ƒå…·æœ‰é€‚ç”¨äºå®ƒçš„æ‰€éœ€æ’åºçš„å‰–æå’Œäº‹åŠ¡åˆ‡é¢ã€‚å¦‚æœä½ æƒ³è¦åœ¨äº‹åŠ¡adviceåœ¨è¿›å…¥ä¹‹åï¼Œäº‹åŠ¡adviceå‡ºå»ä¹‹å‰ï¼Œæ‰§è¡Œçš„å‰–æadviceï¼Œä½ åªéœ€ç®€å•çš„æ›´æ¢å‰–æåˆ‡é¢beançš„orderå±æ€§å€¼ï¼Œä½¿å¾—å®ƒæ¯”äº‹åŠ¡adviceçš„é¡ºåºå€¼æ›´é«˜ã€‚</p><p>ä½ ä½¿ç”¨ç±»ä¼¼çš„æ–¹å¼é…ç½®å…¶ä»–çš„åˆ‡é¢ã€‚</p><h3 id="1-5-9-ä½¿ç”¨å¸¦æœ‰åˆ‡é¢çš„-Transactional"><a href="#1-5-9-ä½¿ç”¨å¸¦æœ‰åˆ‡é¢çš„-Transactional" class="headerlink" title="1.5.9 ä½¿ç”¨å¸¦æœ‰åˆ‡é¢çš„@Transactional"></a>1.5.9 ä½¿ç”¨å¸¦æœ‰åˆ‡é¢çš„@Transactional</h3><p>åœ¨ä¸€ä¸ªSpringå®¹å™¨ä¹‹å¤–ï¼Œé€šè¿‡AspectJåˆ‡é¢ï¼Œä¹Ÿå¯èƒ½ä½¿ç”¨Springæ¡†æ¶çš„<code>@Transactional</code>çš„æ”¯æŒã€‚å¦‚æœè¿™æ ·åšï¼Œä½ é¦–å…ˆä½¿ç”¨<code>@Transactional</code>æ³¨è§£ä½ çš„ç±»ï¼ˆå’Œå¯é€‰æ‹©çš„ä½ çš„ç±»æ–¹æ³•ï¼‰ï¼Œç„¶åä½ ä½¿ç”¨å®šä¹‰åœ¨<code>spring-aspects.jar</code>çš„<code>org.springframework.transaction.aspectj.AnnotationTransactionAspect</code>è¿æ¥ï¼ˆç»‡å…¥ï¼‰ä½ çš„åº”ç”¨ã€‚è¿˜å¿…é¡»ä½¿ç”¨äº‹åŠ¡ç®¡ç†å™¨é…ç½®ä½ çš„åˆ‡é¢ã€‚ä½ å½“ç„¶å¯ä»¥ä½¿ç”¨Springæ¡†æ¶çš„IoCå®¹å™¨å»ç®¡ç†ä¾èµ–æ³¨å…¥åˆ‡é¢ã€‚é…ç½®äº‹åŠ¡ç®¡ç†å™¨åˆ‡é¢çš„æœ€ç®€å•æ–¹å¼æ˜¯ä½¿ç”¨<code>&lt;tx:annotation-driven/&gt;</code>å…ƒç´ å’Œç»™<code>aspectj</code>æŒ‡å®š<code>mode</code>å±æ€§ï¼Œæ­£å¦‚åœ¨<a href="https://docs.spring.io/spring/docs/4.2.x/spring-framework-reference/html/transaction.html#transaction-declarative-annotations" target="_blank" rel="noopener">Section 16.5.6 Using @Transactional</a>ã€‚å› ä¸ºæˆ‘ä»¬å…³æ³¨åœ¨ä¸€ä¸ªSpringå®¹å™¨ä¹‹å¤–ç¨‹åºçš„è¿è¡Œï¼Œæˆ‘ä»¬å°†ä¼šå‘ä½ å±•ç¤ºå¦‚ä½•ä»¥ç¼–ç¨‹çš„æ–¹å¼å®ç°å®ƒã€‚</p><blockquote><p> åœ¨ç»§ç»­ä¹‹å‰ï¼Œä½ å¯èƒ½æƒ³è¦åˆ†åˆ«å»è¯»<a href="">Section 16.5.6 Using @Transactional</a>å’Œ<a href="https://docs.spring.io/spring/docs/4.2.x/spring-framework-reference/html/aop.html" target="_blank" rel="noopener">Chapter 10, Aspect Oriented Programming with Spring</a>ã€‚</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">// construct an appropriate transaction manager</span><br><span class="line">DataSourceTransactionManager txManager = new DataSourceTransactionManager(getDataSource());</span><br><span class="line"></span><br><span class="line">// configure the AnnotationTransactionAspect to use it; this must be done before executing any transactional methods</span><br><span class="line">AnnotationTransactionAspect.aspectOf().setTransactionManager(txManager);</span><br></pre></td></tr></table></figure><blockquote><p>å½“ä½¿ç”¨åˆ‡é¢ï¼Œä½ å¿…é¡»æ³¨è§£å®ç°ç±»ï¼ˆå’Œ/æˆ– ç±»é‡Œçš„æ–¹æ³•ï¼‰ï¼Œä¸æ˜¯ç±»å®ç°çš„æ¥å£ã€‚<br>AspectJ éµå®ˆJavaçš„è§„åˆ™ï¼Œä¸ç»§æ‰¿æ¥å£ä¸Šçš„æ³¨è§£ã€‚</p></blockquote><p>åœ¨ç±»ä¸Šçš„<code>@Transactional</code>æ³¨è§£ç»™åœ¨ç±»é‡Œçš„ä»»ä½•æ–¹æ³•çš„æ‰§è¡ŒæŒ‡å®šé»˜è®¤äº‹åŠ¡è¯­ä¹‰ã€‚<br>åœ¨åœ¨ç±»é‡Œçš„æ–¹æ³•ä¸Šçš„<code>@Transactional</code>æ³¨è§£è¦†ç›–ç±»æä¾›æ³¨è§£ï¼ˆå¦‚æœå­˜åœ¨ï¼‰çš„é»˜è®¤äº‹åŠ¡è¯­ä¹‰ã€‚ä¸ç®¡æ˜¯å¦å¯è§ï¼Œä»»ä½•çš„æ–¹æ³•å¯èƒ½è¢«æ³¨è§£ã€‚</p><p>ä½¿ç”¨<code>AnnotationTransactionAspect</code>ç»‡å…¥ä½ çš„åº”ç”¨ï¼Œä½ è¦ä¹ˆä½¿ç”¨AspectJï¼ˆ<a href="https://www.eclipse.org/aspectj/doc/released/devguide/index.html" target="_blank" rel="noopener">AspectJ Development Guide</a>ï¼‰æ„å»ºä½ çš„åº”ç”¨ï¼Œè¦ä¹ˆä½¿ç”¨åŠ è½½æ—¶ç»‡å…¥ã€‚ä½¿ç”¨AspectJåŠ è½½æ—¶ç»‡å…¥çš„è®¨è®ºè¯·çœ‹<a href="https://docs.spring.io/spring/docs/4.2.x/spring-framework-reference/html/aop.html#aop-aj-ltw" target="_blank" rel="noopener">Load-time weaving with AspectJ in the Spring Framework</a></p><h2 id="1-6-ç¼–ç¨‹äº‹åŠ¡ç®¡ç†"><a href="#1-6-ç¼–ç¨‹äº‹åŠ¡ç®¡ç†" class="headerlink" title="1.6 ç¼–ç¨‹äº‹åŠ¡ç®¡ç†"></a>1.6 ç¼–ç¨‹äº‹åŠ¡ç®¡ç†</h2><p>Springæ¡†æ¶æä¾›ä¸¤ç§ç¼–ç¨‹äº‹åŠ¡ç®¡ç†å·¥å…·ï¼š</p><ul><li>ä½¿ç”¨<code>TransactionTemplate</code>ã€‚</li><li>ç›´æ¥ä½¿ç”¨<code>PlatformTransactionManager</code>å®ç°ã€‚</li></ul><p>å¯¹äºç¼–ç¨‹å¼äº‹åŠ¡ç®¡ç†Springå›¢é˜Ÿé€šå¸¸å»ºè®®ä½¿ç”¨<code>TransactionTemplate</code>ã€‚ç¬¬äºŒç§ç›¸ä¼¼é€”å¾„æ˜¯ä½¿ç”¨JTA<code>UserTransaction</code>APIï¼Œè™½ç„¶å¼‚å¸¸å¤„ç†ä¸æ˜¯é‚£ä¹ˆç¬¨é‡ã€‚</p><h3 id="1-6-1-ä½¿ç”¨TransactionTemplate"><a href="#1-6-1-ä½¿ç”¨TransactionTemplate" class="headerlink" title="1.6.1 ä½¿ç”¨TransactionTemplate"></a>1.6.1 ä½¿ç”¨TransactionTemplate</h3><p><code>TransactionTemplate</code> é‡‡ç”¨ä¸å…¶ä»–Springæ¨¡ç‰ˆï¼ˆä¾‹å¦‚<code>JdbcTemplate</code>ï¼‰ä¸€æ ·çš„æ–¹å¼ã€‚å®ƒä½¿ç”¨ä¸€ä¸ªå›è°ƒçš„æ–¹æ³•ï¼Œä½¿åº”ç”¨ä»£ç ä¸å¿…æ‰§è¡Œæ ·æ¿è·å–å’Œé‡Šæ”¾äº‹åŠ¡èµ„æºï¼Œå¹¶äº§ç”Ÿé©±åŠ¨ç¨‹åºçš„ä»£ç ï¼Œä»¥ä¾¿äºè¢«ç¼–å†™çš„ä»£ç ä»…å…³æ³¨å¼€å‘äººå‘˜æƒ³è¦åšçš„äº‹æƒ…ã€‚</p><blockquote><p>æ­£å¦‚ä½ å°†åœ¨å¦‚ä¸‹çš„ä¾‹å­ä¸­çœ‹åˆ°çš„ï¼Œä½¿ç”¨<code>TransactionTemplate</code>ç»å¯¹å°†ä½ å’ŒSpringçš„äº‹åŠ¡åŸºç¡€æ¶æ„å’ŒAPIç»“åˆåœ¨ä¸€èµ·ã€‚</p></blockquote><p>åº”ç”¨ä»£ç å¿…é¡»åœ¨äº‹åŠ¡ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œï¼Œæ˜ç¡®çš„ä½¿ç”¨<code>TransactionTemplate</code>ï¼Œçœ‹èµ·æ¥å’Œå¦‚ä¸‹çš„ç›¸ä¼¼ã€‚ä½ ä½œä¸ºä¸€ä¸ªåº”ç”¨å¼€å‘è€…ï¼Œå†™ä¸€ä¸ª<code>TransactionCallback</code>å®ç°ï¼ˆé€šå¸¸è¡¨ç°ä¸ºä¸€ä¸ªåŒ¿åå†…éƒ¨ç±»ï¼‰ï¼Œè¿™ä¸ªå®ç°åŒ…å«åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œçš„ä»£ç ã€‚ç„¶åå°†è‡ªå®šä¹‰<code>TransactionCallback</code>çš„å®ä¾‹ï¼Œä¼ é€’ç»™<code>TransactionTemplate</code>ä¸Šå…¬å¼€çš„<code>execute(...)</code>æ–¹æ³•ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public class SimpleService implements Service &#123;</span><br><span class="line"></span><br><span class="line">    // single TransactionTemplate shared amongst all methods in this instance</span><br><span class="line">    private final TransactionTemplate transactionTemplate;</span><br><span class="line"></span><br><span class="line">    // use constructor-injection to supply the PlatformTransactionManager</span><br><span class="line">    public SimpleService(PlatformTransactionManager transactionManager) &#123;</span><br><span class="line">        Assert.notNull(transactionManager, &quot;The &apos;transactionManager&apos; argument must not be null.&quot;);</span><br><span class="line">        this.transactionTemplate = new TransactionTemplate(transactionManager);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Object someServiceMethod() &#123;</span><br><span class="line">        return transactionTemplate.execute(new TransactionCallback() &#123;</span><br><span class="line">            // the code in this method executes in a transactional context</span><br><span class="line">            public Object doInTransaction(TransactionStatus status) &#123;</span><br><span class="line">                updateOperation1();</span><br><span class="line">                return resultOfUpdateOperation2();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœæ²¡æœ‰è¿”å›å€¼ï¼Œæ–¹ä¾¿çš„ä½¿ç”¨<code>TransactionCallbackWithoutResult</code>ç±»å’Œä¸€ä¸ªåŒ¿åå†…éƒ¨ç±»å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">transactionTemplate.execute(new TransactionCallbackWithoutResult() &#123;</span><br><span class="line">    protected void doInTransactionWithoutResult(TransactionStatus status) &#123;</span><br><span class="line">        updateOperation1();</span><br><span class="line">        updateOperation2();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>åœ¨å›è°ƒä¸­çš„ä»£ç å¯ä»¥é€šè¿‡æä¾›çš„<code>TransactionStatus</code>å¯¹è±¡ä¸Šè°ƒç”¨<code>setRollbackOnly()</code>æ–¹æ³•å›æ»šè¿™ä¸ªäº‹åŠ¡ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">transactionTemplate.execute(new TransactionCallbackWithoutResult() &#123;</span><br><span class="line"></span><br><span class="line">    protected void doInTransactionWithoutResult(TransactionStatus status) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            updateOperation1();</span><br><span class="line">            updateOperation2();</span><br><span class="line">        &#125; catch (SomeBusinessExeption ex) &#123;</span><br><span class="line">            status.setRollbackOnly();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="æŒ‡å®šäº‹åŠ¡è®¾ç½®"><a href="#æŒ‡å®šäº‹åŠ¡è®¾ç½®" class="headerlink" title="æŒ‡å®šäº‹åŠ¡è®¾ç½®"></a>æŒ‡å®šäº‹åŠ¡è®¾ç½®</h4><p>ä½ å¯ä»¥ä»¥ç¼–ç¨‹æ–¹å¼æˆ–é…ç½®æ–¹å¼åœ¨TransactionTemplateä¸ŠæŒ‡å®šä¾‹å¦‚ä¼ æ’­ç‰¹æ€§æ¨¡å¼ï¼Œéš”ç¦»ç­‰çº§ï¼Œè¶…æ—¶ç­‰ç­‰çš„äº‹åŠ¡è®¾ç½®ã€‚é»˜è®¤çš„<code>TransactionTemplate</code>å®ä¾‹æœ‰<a href="https://docs.spring.io/spring/docs/4.2.x/spring-framework-reference/html/transaction.html#transaction-declarative-txadvice-settings" target="_blank" rel="noopener">é»˜è®¤äº‹åŠ¡è®¾ç½®</a>ã€‚å¦‚ä¸‹çš„ä¾‹å­å±•ç¤ºå¯¹äºä¸€ä¸ªæŒ‡å®š<code>TransactionTemplate</code>äº‹åŠ¡è®¾ç½®çš„ç¼–ç¨‹å¼å®šåˆ¶ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public class SimpleService implements Service &#123;</span><br><span class="line"></span><br><span class="line">    private final TransactionTemplate transactionTemplate;</span><br><span class="line"></span><br><span class="line">    public SimpleService(PlatformTransactionManager transactionManager) &#123;</span><br><span class="line">        Assert.notNull(transactionManager, &quot;The &apos;transactionManager&apos; argument must not be null.&quot;);</span><br><span class="line">        this.transactionTemplate = new TransactionTemplate(transactionManager);</span><br><span class="line"></span><br><span class="line">        // the transaction settings can be set here explicitly if so desired</span><br><span class="line">        this.transactionTemplate.setIsolationLevel(TransactionDefinition.ISOLATION_READ_UNCOMMITTED);</span><br><span class="line">        this.transactionTemplate.setTimeout(30); // 30 seconds</span><br><span class="line">        // and so forth...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸‹çš„ä¾‹å­å®šä¹‰äº†ä¸€ä¸ªä½¿ç”¨ä¸€äº›è‡ªå®šä¹‰äº‹åŠ¡è®¾ç½®çš„<code>TransactionTemplate</code>ï¼Œä½¿ç”¨Spring XMLé…ç½®ã€‚ç„¶åå¯ä»¥å°†<code>sharedTransactionTemplate</code>æ³¨å…¥åˆ°å°½å¯èƒ½å¤šçš„éœ€è¦çš„æœåŠ¡ä¸­ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean id=&quot;sharedTransactionTemplate&quot;</span><br><span class="line">        class=&quot;org.springframework.transaction.support.TransactionTemplate&quot;&gt;</span><br><span class="line">    &lt;property name=&quot;isolationLevelName&quot; value=&quot;ISOLATION_READ_UNCOMMITTED&quot;/&gt;</span><br><span class="line">    &lt;property name=&quot;timeout&quot; value=&quot;30&quot;/&gt;</span><br><span class="line">&lt;/bean&gt;</span><br></pre></td></tr></table></figure><p>æœ€åï¼Œ<code>TransactionTemplate</code>ç±»çš„å®ä¾‹æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå› ä¸ºå®åŠ›ä¸ä¿æŒä»»ä½•ä¼šè¯çŠ¶æ€ã€‚ä½†æ˜¯ï¼Œ<code>TransactionTemplate</code>å®ä¾‹ä¼šä¿æŒé…ç½®çŠ¶æ€ï¼Œå› æ­¤å½“è®¸å¤šç±»å¯èƒ½å…±äº«ä¸€ä¸ª<code>TransactionTemplate</code>çš„ä¸€ä¸ªå•ä¾‹æ—¶ï¼Œå¦‚æœä¸€ä¸ªç±»éœ€è¦ä½¿ç”¨ä¸€ä¸ªå¸¦æœ‰ä¸åŒè®¾ç½®ï¼ˆä¾‹å¦‚ï¼Œä¸åŒéš”ç¦»ç­‰çº§ï¼‰çš„<code>TransactionTemplate</code>ï¼Œä½ å°±éœ€è¦å»åˆ›å»ºä¸€ä¸ªä¸¤ä¸ªä¸åŒçš„<code>TransactionTemplate</code>å®ä¾‹ã€‚</p><h3 id="1-6-2-ä½¿ç”¨PlatformTransactionManager"><a href="#1-6-2-ä½¿ç”¨PlatformTransactionManager" class="headerlink" title="1.6.2 ä½¿ç”¨PlatformTransactionManager"></a>1.6.2 ä½¿ç”¨PlatformTransactionManager</h3><p>ä½ ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨<code>org.springframework.transaction.PlatformTransactionManager</code>ç®¡ç†ä½ çš„äº‹åŠ¡ã€‚ç®€å•çš„é€šè¿‡ä¸€ä¸ªbeanå¼•ç”¨ä¼ é€’ä½ æ­£åœ¨ç”¨çš„<code>PlatformTransactionManager</code>çš„å®ç°ç»™ä½ çš„beanã€‚ç„¶åï¼Œä½¿ç”¨<code>TransactionDefinition</code>å’Œ<code>TransactionStatus</code>å¯¹è±¡ä½ å¯ä»¥å‘èµ·ï¼Œå›æ»šå’Œæäº¤äº‹åŠ¡ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">DefaultTransactionDefinition def = new DefaultTransactionDefinition();</span><br><span class="line">// explicitly setting the transaction name is something that can only be done programmatically</span><br><span class="line">def.setName(&quot;SomeTxName&quot;);</span><br><span class="line">def.setPropagationBehavior(TransactionDefinition.PROPAGATION_REQUIRED);</span><br><span class="line"></span><br><span class="line">TransactionStatus status = txManager.getTransaction(def);</span><br><span class="line">try &#123;</span><br><span class="line">    // execute your business logic here</span><br><span class="line">&#125;</span><br><span class="line">catch (MyException ex) &#123;</span><br><span class="line">    txManager.rollback(status);</span><br><span class="line">    throw ex;</span><br><span class="line">&#125;</span><br><span class="line">txManager.commit(status);</span><br></pre></td></tr></table></figure><h2 id="1-7-ç¼–ç¨‹å¼å’Œå£°æ˜å¼äº‹åŠ¡ç®¡ç†å™¨çš„é€‰æ‹©"><a href="#1-7-ç¼–ç¨‹å¼å’Œå£°æ˜å¼äº‹åŠ¡ç®¡ç†å™¨çš„é€‰æ‹©" class="headerlink" title="1.7 ç¼–ç¨‹å¼å’Œå£°æ˜å¼äº‹åŠ¡ç®¡ç†å™¨çš„é€‰æ‹©"></a>1.7 ç¼–ç¨‹å¼å’Œå£°æ˜å¼äº‹åŠ¡ç®¡ç†å™¨çš„é€‰æ‹©</h2><p>ç¼–ç¨‹å¼äº‹åŠ¡ç®¡ç†ä»…ä»…åœ¨ä½ å¦‚æœæœ‰ä¸€ä¸ªå°æ•°é‡çš„äº‹åŠ¡æ“ä½œæƒ…å†µä¸‹æ‰æ˜¯ä¸€ä¸ªå¥½æƒ³æ³•ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ æœ‰ä¸€ä¸ªwebåº”ç”¨éœ€è¦ä»…ä»…ä¸»è¦æ˜¯updateæ“ä½œçš„äº‹åŠ¡ï¼Œä½ ä¸å¯èƒ½æƒ³å»ä½¿ç”¨Springæˆ–è€…å…¶ä»–ä»»ä½•æŠ€æœ¯å»è®¾ç½®äº‹åŠ¡ä»£ç†ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½¿ç”¨<code>transactionTemplate</code>å¯èƒ½æ˜¯ä¸€ä¸ªå¥½æ–¹æ³•ã€‚å¯èƒ½æ˜ç¡®çš„è®¾ç½®äº‹åŠ¡åç§°å¯ä»¥ä»…åœ¨ä½¿ç”¨ç¼–ç¨‹å¼é€”å¾„è¿›è¡Œäº‹åŠ¡ç®¡ç†çš„æƒ…å†µä¸‹å»åšã€‚</p><p>ä»å¦ä¸€æ–¹é¢ï¼Œå¦‚æœä½ çš„åº”ç”¨æœ‰å¾ˆå¤šäº‹åŠ¡æ“ä½œï¼Œå£°æ˜å¼äº‹åŠ¡ç®¡ç†é€šå¸¸æ˜¯åˆç®—çš„ã€‚å®ƒä¿æŒäº‹åŠ¡ç®¡ç†æ‘†è„±ä¸šåŠ¡é€»è¾‘ï¼Œé…ç½®ä¸å›°éš¾ã€‚å½“ä½¿ç”¨Springæ¡†æ¶ï¼Œè€Œä¸æ˜¯EJB CMTæ—¶ï¼Œå£°æ˜å¼äº‹åŠ¡é…ç½®çš„æˆæœ¬å°†å¤§å¤§é™ä½ã€‚</p><h2 id="1-8-äº‹åŠ¡çº¦æŸäº‹ä»¶"><a href="#1-8-äº‹åŠ¡çº¦æŸäº‹ä»¶" class="headerlink" title="1.8 äº‹åŠ¡çº¦æŸäº‹ä»¶"></a>1.8 äº‹åŠ¡çº¦æŸäº‹ä»¶</h2><p>ä½œä¸ºSpring 4.2ï¼Œä¸€ä¸ªäº‹ä»¶çš„ç›‘å¬å¯ä»¥è¢«çº¦æŸä¸ºäº‹åŠ¡çš„ä¸€ä¸ªé˜¶æ®µã€‚å¸¸ç”¨çš„ä¾‹å­æ˜¯å½“äº‹åŠ¡å·²ç»æˆåŠŸçš„å®Œæˆæ—¶å»å¤„ç†äº‹ä»¶ï¼šå½“å½“å‰äº‹åŠ¡çš„ç»“æœå¯¹äºç›‘å¬å™¨å®é™…ä¸Šå¾ˆé‡è¦æ—¶ï¼Œè¿™å…è®¸äº‹ä»¶è¢«æ›´çµæ´»åœ°ä½¿ç”¨ã€‚<br>æ³¨å†Œä¸€ä¸ªå¸¸è§„çš„ç›‘å¬äº‹ä»¶å¯ä»¥é€šè¿‡<code>@EventListener</code>æ³¨è§£ã€‚å¦‚æœä½ éœ€è¦å’Œäº‹åŠ¡ç»‘å®šå®ƒä½¿ç”¨<code>@TransactionEventListener</code>ã€‚å½“ä½ è¿™æ ·åšæ—¶ï¼Œç›‘å¬å™¨å°†é»˜è®¤çº¦æŸäº‹åŠ¡æäº¤é˜¶æ®µã€‚<br>æˆ‘ä»¬ä¸¾ä¸ªä¾‹å­è¯´æ˜è¿™ä¸ªæ¦‚å¿µã€‚</p><p>å‡è®¾ä¸€ä¸ªç»„ä»¶å‘å¸ƒäº†ä¸€ä¸ªè®¢å•åˆ›å»ºçš„äº‹ä»¶ï¼Œæˆ‘ä»¬æƒ³è¦å®šä¹‰ä¸€ä¸ªç›‘å¬å™¨ï¼Œè¯¥ç›‘å¬å™¨åªåº”è¯¥åœ¨äº‹ä»¶æˆåŠŸæäº¤æ—¶æ‰å¤„ç†è¯¥äº‹ä»¶ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public class MyComponent &#123;</span><br><span class="line"></span><br><span class="line">    @TransactionalEventListener</span><br><span class="line">    public void handleOrderCreatedEvent(CreationEvent&lt;Order&gt; creationEvent) &#123;</span><br><span class="line">          ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><code>TransactionalEventListener</code>æ³¨è§£æš´éœ²ä¸€ä¸ª<code>phase</code>å±æ€§ï¼Œè¿™ä¸ªå±æ€§å…è®¸è‡ªå®šä¹‰ç›‘å¬å™¨åº”è¯¥çº¦æŸäº‹åŠ¡çš„å“ªä¸ªphaseã€‚è¿™ä¸ªæœ‰æ•ˆçš„phasesæ˜¯<code>BEFORE_COMMIT</code>ï¼Œ<code>AFTER_COMMIT</code>(default)ï¼Œ<code>AFTER_ROLLBACK</code>å’Œ<code>AFTER_COMPLETION</code>ï¼Œå®ƒä»¬èšåˆäº‹åŠ¡çš„å®Œæ•´æ€§ï¼ˆæ˜¯ä¸€ä¸ªæäº¤æˆ–è€…ä¸€ä¸ªå›æ»šï¼‰ã€‚</p><p>å¦‚æœæ²¡æœ‰æ­£åœ¨è¿è¡Œçš„äº‹åŠ¡ï¼Œç”±äºæˆ‘ä»¬æ— æ³•éµå®ˆæ‰€éœ€çš„è¯­ä¹‰ï¼Œç›‘å¬å™¨æ ¹æœ¬ä¸ä¼šè¢«è°ƒç”¨ã€‚ä½†æ˜¯ï¼Œå®ƒå¯èƒ½é€šè¿‡è®¾ç½®æ³¨è§£çš„<code>fallbackExecution</code>å±æ€§ä¸ºtrueå»è¦†ç›–è¯¥è¡Œä¸ºã€‚</p><h2 id="1-9-æŒ‡å®šåº”ç”¨æœåŠ¡å™¨çš„é›†æˆ"><a href="#1-9-æŒ‡å®šåº”ç”¨æœåŠ¡å™¨çš„é›†æˆ" class="headerlink" title="1.9 æŒ‡å®šåº”ç”¨æœåŠ¡å™¨çš„é›†æˆ"></a>1.9 æŒ‡å®šåº”ç”¨æœåŠ¡å™¨çš„é›†æˆ</h2><p>Springçš„äº‹åŠ¡æŠ½è±¡é€šå¸¸æ˜¯åº”ç”¨æœåŠ¡å™¨ä¸å¯çŸ¥ã€‚æ­¤å¤–ï¼ŒSpringçš„<code>JtaTransactionManager</code>ç±»ï¼Œå¯ä»¥å¯é€‰æ‰§è¡Œå¯¹äºJTA<code>UserTransaction</code>å’Œ<code>TransactionManager</code>å¯¹è±¡çš„JNDIæŸ¥æ‰¾ï¼Œå¯¹äºåè€…å¯¹è±¡ï¼Œè‡ªåŠ¨æ£€æŸ¥åœ°å€ï¼Œè¯¥åœ°å€å› åº”ç”¨æœåŠ¡å™¨è€Œå˜åŒ–ã€‚è®¿é—®JTA TransactionManagerå…è®¸å¢å¼ºçš„äº‹åŠ¡è¯­ä¹‰ï¼Œç‰¹åˆ«æ˜¯æ”¯æŒäº‹åŠ¡æš‚åœã€‚äº†è§£è¯¦ç»†è¯·æŸ¥çœ‹<code>JtaTransactionManager</code>javadocsã€‚</p><p>Springçš„<code>JtaTransactionManager</code>åœ¨Java EEåº”ç”¨æœåŠ¡å™¨ä¸Šè¿è¡Œçš„æ ‡å‡†é€‰æ‹©ï¼Œå¹¶å·²çŸ¥å¯ä»¥åœ¨æ‰€æœ‰å¸¸ç”¨çš„æœåŠ¡å™¨ä¸Šè¿è¡Œã€‚é«˜çº§åŠŸèƒ½ï¼ˆäº‹åŠ¡æš‚åœï¼‰åœ¨å¾ˆå¤šæœåŠ¡å™¨ä¸Šè¿è¡Œå¾ˆå¥½ï¼ŒåŒ…æ‹¬GlassFishï¼ŒJBosså’ŒGeronimoï¼Œä¸éœ€è¦ä»»ä½•ç‰¹æ®Šé…ç½®ã€‚ä½†æ˜¯ï¼Œå¯¹äºå®Œæ•´çš„æ”¯æŒäº‹åŠ¡æš‚åœå’Œè¿›ä¸€æ­¥çš„é«˜çº§é›†æˆï¼ŒSpring shipå¯¹äºWebLogicæœåŠ¡å™¨å’ŒWebSphereç‰¹æ®Šé€‚é…ã€‚è¿™äº›é€‚é…åœ¨å¦‚ä¸‹ç« èŠ‚è®¨è®ºã€‚</p><p>å¯¹äºæ ‡å‡†åœºæ™¯ï¼ŒåŒ…æ‹¬Weblogic Serverå’ŒWebSphereï¼Œè€ƒè™‘ä½¿ç”¨å®šåˆ¶<code>&lt;tx:jta-trasaction-manager/&gt;</code>é…ç½®å…ƒç´ ã€‚å½“å·²é…ç½®æ—¶ï¼Œè¿™å…ƒç´ è‡ªåŠ¨æ£€æŸ¥åº•å±‚æœåŠ¡å™¨å’Œé€‰æ‹©é€‚ç”¨äºè¯¥å¹³å°çš„æœ€å¥½çš„äº‹åŠ¡ç®¡ç†å™¨ã€‚è¿™æ„å‘³ç€ä½ å°†ä¸éœ€è¦å¿…é¡»æ˜¾å¼çš„é…ç½®æŒ‡å®šæœåŠ¡å™¨é€‚é…ç±»ï¼ˆåœ¨å¦‚ä¸‹ç« èŠ‚è®¨è®ºï¼‰ï¼›ç›¸åï¼Œå®ƒä»¬æ˜¯è‡ªåŠ¨é€‰æ‹©çš„ï¼Œæ ‡å‡†çš„<code>JtaTransactionManager</code>æ˜¯é»˜è®¤çš„åå¤‡ã€‚</p><h3 id="1-9-1-IBM-WebSphere"><a href="#1-9-1-IBM-WebSphere" class="headerlink" title="1.9.1 IBM WebSphere"></a>1.9.1 IBM WebSphere</h3><p>åœ¨WebSphere6.1.0.9åŠä»¥ä¸Šç‰ˆæœ¬ï¼Œå»ºè®®Spring JTAäº‹åŠ¡ç®¡ç†å™¨ä½¿ç”¨<code>WebSphereUowTransactionManager</code>ã€‚è¿™ä¸ªç‰¹æ®Šçš„é€‚é…å™¨åˆ©ç”¨äº†IBMâ€™s <code>UOWManager</code> APIï¼Œåœ¨WebSphereåº”ç”¨æœåŠ¡å™¨6.0.2.19å’Œä»¥åç‰ˆæœ¬ï¼Œ6.1.0.9å’Œä»¥åç‰ˆæœ¬æ˜¯é€‚ç”¨çš„ã€‚ä½¿ç”¨è¿™ä¸ªé€‚é…å™¨ï¼Œé©±åŠ¨Springäº‹åŠ¡æš‚åœï¼ˆæš‚åœ/æ¢å¤ ç”±<code>PROPAGATION_REQUIRES_NEW</code>å‘èµ·ï¼‰æ˜¯ç”±IBMå®˜æ–¹æ”¯æŒçš„ã€‚</p><h3 id="1-9-2-Oracle-WebLogic-Server"><a href="#1-9-2-Oracle-WebLogic-Server" class="headerlink" title="1.9.2 Oracle WebLogic Server"></a>1.9.2 Oracle WebLogic Server</h3><p>åœ¨Weblogic ServeråŠä»¥åç‰ˆæœ¬ä¸­ï¼Œä½ é€šå¸¸å°†ä½¿ç”¨<code>WebLogicJtaTransactionManager</code>è€Œä¸æ˜¯å­˜<code>JtaTransactionManager</code>ç±»ã€‚æ™®é€š<code>JtaTransactionManager</code>çš„è¿™ä¸ªç‰¹æ®Šçš„Weblogicç‰¹å®šçš„å­ç±»åœ¨Weblogicç®¡ç†çš„äº‹åŠ¡ç¯å¢ƒä¸­æ”¯æŒSpringçš„äº‹åŠ¡å…¨éƒ¨åŠŸèƒ½ï¼Œè¶…å‡ºæ ‡å‡†çš„JTAè¯­ä¹‰ï¼šç‰¹æ€§åŒ…æ‹¬äº‹åŠ¡åç§°ï¼Œæ¯ä¸ªäº‹åŠ¡çš„éš”ç¦»ç­‰çº§ï¼Œä»¥åŠåœ¨æ‰€æœ‰çš„æƒ…å†µä¸‹æ­£ç¡®çš„æ¢å¤äº‹åŠ¡ã€‚</p><h2 id="1-10-å¸¸è§é—®é¢˜è§£å†³"><a href="#1-10-å¸¸è§é—®é¢˜è§£å†³" class="headerlink" title="1.10 å¸¸è§é—®é¢˜è§£å†³"></a>1.10 å¸¸è§é—®é¢˜è§£å†³</h2><h3 id="1-10-1-å¯¹äºç‰¹å®šæ•°æ®æºé”™è¯¯çš„äº‹åŠ¡ç®¡ç†å™¨çš„ä½¿ç”¨"><a href="#1-10-1-å¯¹äºç‰¹å®šæ•°æ®æºé”™è¯¯çš„äº‹åŠ¡ç®¡ç†å™¨çš„ä½¿ç”¨" class="headerlink" title="1.10.1 å¯¹äºç‰¹å®šæ•°æ®æºé”™è¯¯çš„äº‹åŠ¡ç®¡ç†å™¨çš„ä½¿ç”¨"></a>1.10.1 å¯¹äºç‰¹å®šæ•°æ®æºé”™è¯¯çš„äº‹åŠ¡ç®¡ç†å™¨çš„ä½¿ç”¨</h3><p>æ­£ç¡®çš„ä½¿ç”¨<code>PlatformTransactionManager</code>å®ç°åŸºäºä½ äº‹åŠ¡æŠ€æœ¯å’Œéœ€æ±‚çš„é€‰æ‹©ã€‚æ­£ç¡®çš„ä½¿ç”¨ï¼ŒSpringæ¡†æ¶ä»…æä¾›ä¸€ä¸ªç®€å•ç›´æ¥å’Œè½»ä¾¿çš„æŠ½è±¡ã€‚å¦‚æœä½ æ­£åœ¨ä½¿ç”¨å…¨å±€äº‹åŠ¡ï¼Œä½ å¿…é¡»ä½¿ç”¨<code>org.springframework.transaction.jta.JtaTransactionManager</code>ç±»ï¼ˆæˆ–è€…ä¸€ä¸ªæŒ‡å®šçš„åº”ç”¨æœåŠ¡å™¨å­ç±»ï¼‰è¿›è¡Œä½ æ‰€æœ‰çš„äº‹åŠ¡æ“ä½œã€‚å¦åˆ™äº‹åŠ¡åŸºç¡€è®¾æ–½åœ¨èµ„æºï¼ˆä¾‹å¦‚å®¹å™¨çš„<code>DataSource</code>å®ä¾‹ï¼‰ä¸Šå°è¯•ä½¿ç”¨æœ¬åœ°äº‹åŠ¡ã€‚è¿™æ ·çš„æœ¬åœ°äº‹åŠ¡æ²¡æœ‰æ„ä¹‰ï¼Œä¸€ä¸ªå¥½çš„åº”ç”¨æœåŠ¡å™¨æŠŠå®ƒä»¬å½“ä½œé”™è¯¯ã€‚</p><h2 id="1-11-é›†æˆèµ„æº"><a href="#1-11-é›†æˆèµ„æº" class="headerlink" title="1.11 é›†æˆèµ„æº"></a>1.11 é›†æˆèµ„æº</h2><p>äº†è§£æ›´å¤šå…³äºSpringæ¡†æ¶çš„äº‹åŠ¡æ”¯æŒä¿¡æ¯ï¼š</p><ul><li><a href="http://www.javaworld.com/javaworld/jw-01-2009/jw-01-spring-transactions.html" target="_blank" rel="noopener">Distributed transaction in Springï¼Œwith and without XA</a>æ˜¯ä¸€ä¸ªJavaWorldæ¼”ç¤ºæ–‡ç¨¿ï¼Œå…¶ä¸­Springçš„David Syerå¼•å¯¼æ‚¨åœ¨Springåº”ç”¨ç¨‹åºä¸­é€šè¿‡åˆ†å¸ƒå¼äº‹åŠ¡çš„ä¸ƒç§æ¨¡å¼ï¼Œå…¶ä¸­ä¸‰ç§æ¨¡å¼ä½¿ç”¨XAï¼Œå¦å¤–å››ç§æ²¡æœ‰ã€‚</li><li><a href="http://www.infoq.com/minibooks/JTDS" target="_blank" rel="noopener">Java äº‹åŠ¡è®¾è®¡ç­–ç•¥</a>æ˜¯ä¸€æœ¬ä»<a href="http://www.infoq.com/" target="_blank" rel="noopener">InfoQ</a>å¾—åˆ°çš„ä¹¦ï¼ŒInfoQæä¾›ä¸€ä¸ªJavaäº‹åŠ¡å¿«é€Ÿä»‹ç»ã€‚å®ƒè¿˜åŒ…æ‹¬å¦‚ä½•ä½¿ç”¨Spring Frameworkå’ŒEJB3é…ç½®å’Œä½¿ç”¨äº‹åŠ¡çš„å¹¶æ’ç¤ºä¾‹ã€‚</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Spring-äº‹åŠ¡ç®¡ç†&quot;&gt;&lt;a href=&quot;#Spring-äº‹åŠ¡ç®¡ç†&quot; class=&quot;headerlink&quot; title=&quot;Spring äº‹åŠ¡ç®¡ç†&quot;&gt;&lt;/a&gt;Spring äº‹åŠ¡ç®¡ç†&lt;/h1&gt;&lt;p&gt;ç¿»è¯‘è‡ª&lt;a href=&quot;https://docs.spring.io
      
    
    </summary>
    
    
      <category term="è¯‘æ–‡" scheme="https://zhongyp.me/tags/%E8%AF%91%E6%96%87/"/>
    
      <category term="äº‹åŠ¡" scheme="https://zhongyp.me/tags/%E4%BA%8B%E5%8A%A1/"/>
    
  </entry>
  
  <entry>
    <title>å¤šçº¿ç¨‹é€šä¿¡</title>
    <link href="https://zhongyp.me/concurrency/2018-12-06-thread-communication/"/>
    <id>https://zhongyp.me/concurrency/2018-12-06-thread-communication/</id>
    <published>2018-12-05T16:00:00.000Z</published>
    <updated>2019-08-07T11:24:28.427Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-å…±äº«å˜é‡çš„å¯è§æ€§"><a href="#1-å…±äº«å˜é‡çš„å¯è§æ€§" class="headerlink" title="1. å…±äº«å˜é‡çš„å¯è§æ€§"></a>1. å…±äº«å˜é‡çš„å¯è§æ€§</h2><p>çº¿ç¨‹é€šä¿¡ä¸»è¦æ˜¯é€šè¿‡å¯¹å…±äº«å˜é‡çš„è¯»å†™æ¥è¿›è¡Œçš„ï¼Œä¸€èˆ¬å…±äº«å˜é‡ï¼Œæˆ‘ä»¬ä¼šé‡‡ç”¨ä½¿å…±äº«å˜é‡ä¸å¯å˜æˆ–è€…åœ¨ä»»ä½•è®¿é—®çŠ¶æ€å˜é‡çš„æ—¶å€™ä½¿ç”¨åŒæ­¥ä¸¤ç§æªæ–½è¿›è¡Œå˜é‡å…±äº«ã€‚</p><h2 id="2-ä½¿ç”¨é”åŒæ­¥å…±äº«å˜é‡çŠ¶æ€"><a href="#2-ä½¿ç”¨é”åŒæ­¥å…±äº«å˜é‡çŠ¶æ€" class="headerlink" title="2. ä½¿ç”¨é”åŒæ­¥å…±äº«å˜é‡çŠ¶æ€"></a>2. ä½¿ç”¨é”åŒæ­¥å…±äº«å˜é‡çŠ¶æ€</h2><h3 id="2-1-synchronizedï¼ˆå†…ç½®é”ï¼‰"><a href="#2-1-synchronizedï¼ˆå†…ç½®é”ï¼‰" class="headerlink" title="2.1 synchronizedï¼ˆå†…ç½®é”ï¼‰"></a>2.1 synchronizedï¼ˆå†…ç½®é”ï¼‰</h3><p>synchronizedæˆ‘ä»¬çŸ¥é“å¸¸å¸¸ç”¨æ¥ä¸´ç•ŒåŒºäº’æ–¥æ‰§è¡Œï¼Œä½†æ˜¯é™¤æ­¤ä¹‹å¤–ï¼Œå®ƒè¿˜æœ‰æœ€é‡è¦çš„åŠŸèƒ½ï¼šé”çš„å†…å­˜è¯­ä¹‰ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">class MonitorExample&#123;</span><br><span class="line">    int a = 0;</span><br><span class="line">    public synchronized void writer()&#123;// 1</span><br><span class="line">        a++; // 2</span><br><span class="line">    &#125; // 3</span><br><span class="line">    public synchronized void reader()&#123; // 4</span><br><span class="line">        int i=a; // 5</span><br><span class="line">    &#125; // 6</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡è®¾çº¿ç¨‹A<strong>å…ˆ</strong>æ‰§è¡Œwriter()æ–¹æ³•ï¼Œ<strong>éšå</strong>çº¿ç¨‹Bæ‰§è¡Œreader()æ–¹æ³•ã€‚æ ¹æ®JMMçš„happens-beforeè§„åˆ™ï¼Œè¿™æ®µä»£ç åŒ…å«çš„happens-beforeå…³ç³»å¯ä»¥åˆ†ä¸º3ç±»ã€‚</p><p>1ï¼‰æ ¹æ®ç¨‹åºæ¬¡åºè§„åˆ™ï¼Œ1 happens-before2, 2 happens-before 3; 4 happens-before 5, 5 happens-before 6ã€‚</p><p>2) æ ¹æ®ç›‘è§†å™¨é”è§„åˆ™ï¼Œ3 happens-before 4ã€‚<br>3) æ ¹æ®happens-beforeçš„ä¼ é€’æ€§ï¼Œ2 happens-before 5ã€‚</p><p><strong>æ³¨ï¼š</strong>happens-beforeè§„åˆ™ä¿è¯äº†çº¿ç¨‹Aæ‰§è¡Œåçš„ç»“æœå¯¹Bå¯è§ï¼Œä½†æ˜¯çº¿ç¨‹Açš„ä»£ç ä¸ä¸€å®šåœ¨çº¿ç¨‹Bä¹‹å‰æ‰§è¡Œã€‚ä¸Šé¢Aä¸Bçº¿ç¨‹æ˜¯æœ‰å…ˆåé¡ºåºçš„ï¼Œä¸»è¦æ˜¯ä¸ºäº†æ–¹ä¾¿è§£é‡Šé”çš„å†…å­˜è¯­ä¹‰ã€‚ </p><p><img src="/media/article/happens-before-relation.jpg" alt="happens-beofre"><br>å›¾ç‰‡æ¥è‡ª<a href="">Javaå¹¶å‘ç¼–ç¨‹è‰ºæœ¯å›¾3-24</a></p><p>é”é‡Šæ”¾å’Œé”è·å–çš„å†…å­˜è¯­ä¹‰ï¼š</p><p><strong>çº¿ç¨‹Aé‡Šæ”¾ä¸€ä¸ªé”ï¼Œå®è´¨ä¸Šæ˜¯çº¿ç¨‹Aå‘æ¥ä¸‹æ¥å°†è¦è·å–çš„è¿™ä¸ªé”çš„æŸä¸ªçº¿ç¨‹å‘å‡ºäº†ï¼ˆçº¿ç¨‹Aå¯¹å…±äº«å˜é‡æ‰€åšä¿®æ”¹çš„ï¼‰æ¶ˆæ¯ã€‚</strong></p><p><strong>çº¿ç¨‹Bé‡Šæ”¾ä¸€ä¸ªé”ï¼Œå®è´¨ä¸Šæ˜¯çº¿ç¨‹Bæ¥æ”¶äº†ä¹‹å‰æŸä¸ªçº¿ç¨‹å‘å‡ºçš„ï¼ˆé‡Šæ”¾è¿™ä¸ªé”ä¹‹å‰å¯¹å…±äº«å˜é‡æ‰€åšçš„ä¿®æ”¹çš„ï¼‰æ¶ˆæ¯ã€‚</strong></p><p><strong>çº¿ç¨‹Aé‡Šæ”¾é”ï¼Œçº¿ç¨‹Bè·å–é”ï¼Œè¿™ä¸ªè¿‡ç¨‹å®è´¨ä¸Šæ˜¯çº¿ç¨‹Aé€šè¿‡ä¸»å†…å­˜å‘çº¿ç¨‹Bå‘é€æ¶ˆæ¯ã€‚</strong></p><p><img src="/media/article/lock-acquire-state.png" alt="lock-acquire-state"><br>å›¾ç‰‡æ¥è‡ª<a href="">Javaå¹¶å‘ç¼–ç¨‹è‰ºæœ¯å›¾3-26</a></p><h3 id="2-2-ReentrantLock"><a href="#2-2-ReentrantLock" class="headerlink" title="2.2 ReentrantLock"></a>2.2 ReentrantLock</h3><h2 id="3-ä½¿ç”¨åŒæ­¥åŸè¯­"><a href="#3-ä½¿ç”¨åŒæ­¥åŸè¯­" class="headerlink" title="3. ä½¿ç”¨åŒæ­¥åŸè¯­"></a>3. ä½¿ç”¨åŒæ­¥åŸè¯­</h2><h3 id="3-1-volatile"><a href="#3-1-volatile" class="headerlink" title="3.1 volatile"></a>3.1 volatile</h3><p>volatileæˆ‘ä»¬ç†ŸçŸ¥çš„ç‰¹æ€§æ˜¯ï¼š</p><p>1.å¯è§æ€§</p><p>å¯¹ä¸€ä¸ªvolatileå˜é‡çš„è¯»ï¼Œæ€»èƒ½çœ‹åˆ°ä»»æ„çº¿ç¨‹å¯¹è¿™ä¸ªvolatileå˜é‡æœ€åçš„å†™å…¥ã€‚</p><p>2.æœ‰åºæ€§</p><p>å¦‚æœç¨‹åºæ˜¯åœ¨å¤šå¤„ç†å™¨ä¸Šè¿è¡Œï¼Œå°±ä¸ºcmpxchgæŒ‡ä»¤åŠ ä¸Šlockå‰ç¼€ã€‚lockå‰ç¼€æŒ‡ä»¤å®é™…ä¸Šç›¸å½“äºä¸€ä¸ªå†…å­˜å±éšœï¼ˆä¹Ÿæˆå†…å­˜æ …æ ï¼‰ï¼Œå®ƒç¡®ä¿æŒ‡ä»¤é‡æ’åºæ—¶ä¸ä¼šæŠŠå…¶åé¢çš„æŒ‡ä»¤æ’åˆ°å†…å­˜å±éšœä¹‹å‰çš„ä½ç½®ï¼Œä¹Ÿä¸ä¼šæŠŠå‰é¢çš„æŒ‡ä»¤æ’åˆ°å†…å­˜å±éšœçš„åé¢ï¼›å³åœ¨æ‰§è¡Œåˆ°å†…å­˜å±éšœè¿™å¥æŒ‡ä»¤æ—¶ï¼Œåœ¨å®ƒå‰é¢çš„æ“ä½œå·²ç»å…¨éƒ¨å®Œæˆã€‚</p><h3 id="3-2-final"><a href="#3-2-final" class="headerlink" title="3.2 final"></a>3.2 final</h3><h2 id="4-å…¶ä»–æ–¹å¼çš„çº¿ç¨‹æ¶ˆæ¯é€šä¿¡"><a href="#4-å…¶ä»–æ–¹å¼çš„çº¿ç¨‹æ¶ˆæ¯é€šä¿¡" class="headerlink" title="4. å…¶ä»–æ–¹å¼çš„çº¿ç¨‹æ¶ˆæ¯é€šä¿¡"></a>4. å…¶ä»–æ–¹å¼çš„çº¿ç¨‹æ¶ˆæ¯é€šä¿¡</h2><h2 id="4-1-ç­‰å¾…é€šçŸ¥-wait-notify"><a href="#4-1-ç­‰å¾…é€šçŸ¥-wait-notify" class="headerlink" title="4.1 ç­‰å¾…é€šçŸ¥(wait/notify)"></a>4.1 ç­‰å¾…é€šçŸ¥(wait/notify)</h2><h2 id="4-2-ç®¡é“é€šä¿¡"><a href="#4-2-ç®¡é“é€šä¿¡" class="headerlink" title="4.2 ç®¡é“é€šä¿¡"></a>4.2 ç®¡é“é€šä¿¡</h2><h2 id="4-3-Thread-join"><a href="#4-3-Thread-join" class="headerlink" title="4.3 Thread.join()"></a>4.3 Thread.join()</h2><h2 id="4-4-ThreadLocal"><a href="#4-4-ThreadLocal" class="headerlink" title="4.4 ThreadLocal"></a>4.4 ThreadLocal</h2><h2 id="å¼•ç”¨"><a href="#å¼•ç”¨" class="headerlink" title="å¼•ç”¨"></a>å¼•ç”¨</h2><p><a href="">Javaå¹¶å‘ç¼–ç¨‹å®è·µ</a><br><a href="">Javaå¹¶å‘ç¼–ç¨‹è‰ºæœ¯</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;1-å…±äº«å˜é‡çš„å¯è§æ€§&quot;&gt;&lt;a href=&quot;#1-å…±äº«å˜é‡çš„å¯è§æ€§&quot; class=&quot;headerlink&quot; title=&quot;1. å…±äº«å˜é‡çš„å¯è§æ€§&quot;&gt;&lt;/a&gt;1. å…±äº«å˜é‡çš„å¯è§æ€§&lt;/h2&gt;&lt;p&gt;çº¿ç¨‹é€šä¿¡ä¸»è¦æ˜¯é€šè¿‡å¯¹å…±äº«å˜é‡çš„è¯»å†™æ¥è¿›è¡Œçš„ï¼Œä¸€èˆ¬å…±äº«å˜é‡ï¼Œæˆ‘ä»¬ä¼šé‡‡ç”¨ä½¿å…±
      
    
    </summary>
    
    
      <category term="å¹¶å‘" scheme="https://zhongyp.me/tags/%E5%B9%B6%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>çº¿ç¨‹å®‰å…¨</title>
    <link href="https://zhongyp.me/concurrency/2018-12-06-thread-security/"/>
    <id>https://zhongyp.me/concurrency/2018-12-06-thread-security/</id>
    <published>2018-12-05T16:00:00.000Z</published>
    <updated>2019-06-18T11:06:43.122Z</updated>
    
    <content type="html"><![CDATA[<h1 id="çº¿ç¨‹å®‰å…¨-è¯»ä¹¦ç¬”è®°"><a href="#çº¿ç¨‹å®‰å…¨-è¯»ä¹¦ç¬”è®°" class="headerlink" title="çº¿ç¨‹å®‰å…¨-è¯»ä¹¦ç¬”è®°"></a>çº¿ç¨‹å®‰å…¨-è¯»<a href="#å¼•ç”¨">ä¹¦</a>ç¬”è®°</h1><h2 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h2><p>çº¿ç¨‹å®‰å…¨å®šä¹‰ï¼šå½“å¤šä¸ªçº¿ç¨‹è®¿é—®ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œå¦‚æœä¸ç”¨è€ƒè™‘è¿™äº›çº¿ç¨‹åœ¨è¿è¡Œæ—¶ç¯å¢ƒçš„è°ƒåº¦å’Œäº¤æ›¿æ‰§è¡Œï¼Œä¹Ÿä¸éœ€è¦è¿›è¡Œé¢å¤–çš„åŒæ­¥ï¼Œæˆ–è€…åœ¨è°ƒç”¨æ–¹è¿›è¡Œä»»ä½•å…¶ä»–çš„åè°ƒåŠ¨ä½œï¼Œè°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„è¡Œä¸ºéƒ½å¯ä»¥è·å¾—æ­£ç¡®çš„ç»“æœï¼Œé‚£è¿™ä¸ª<strong>å¯¹è±¡å°±æ˜¯çº¿ç¨‹å®‰å…¨çš„</strong>ã€‚æ‘˜è‡³<a href="https://github.com/zhongyp/mybook/blob/master/java/JAVA%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%AE%9E%E8%B7%B5.pdf" target="_blank" rel="noopener">ã€ŠJavaå¹¶å‘ç¼–ç¨‹å®è·µã€‹</a><br>ç¼–å†™çš„çº¿ç¨‹å®‰å…¨çš„ä»£ç ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯ç®¡ç†å¯¹çŠ¶æ€ï¼ˆstateï¼‰çš„è®¿é—®ï¼Œè€Œä¸”é€šå¸¸éƒ½æ˜¯å…±äº«çš„ã€å¯å˜çš„çŠ¶æ€ã€‚å…±äº«æŒ‡ä¸€ä¸ªå˜é‡å¯ä»¥è¢«å¤šä¸ªçº¿ç¨‹è®¿é—®ï¼›å¯å˜å˜é‡çš„å€¼åœ¨ç”Ÿå‘½å‘¨æœŸå†…å¯ä»¥æ”¹å˜ã€‚<br>æ— è®ºä½•æ—¶ï¼Œåªè¦æœ‰å¤šäºä¸€ä¸ªçš„çº¿ç¨‹è®¿é—®ç»™å®šçš„çŠ¶æ€å˜é‡ï¼Œè€Œä¸”å…¶ä¸­æŸä¸ªçº¿ç¨‹ä¼šå†™å…¥è¯¥å˜é‡ï¼Œæ­¤æ—¶å¿…é¡»ä½¿ç”¨åŒæ­¥æ¥åè°ƒçº¿ç¨‹å¯¹è¯¥å˜é‡çš„è®¿é—®ã€‚<br>ä¿è¯å¯¹è±¡çº¿ç¨‹å®‰å…¨çš„ä¸‰ç§æªæ–½ï¼š</p><ul><li>ä¸è·¨çº¿ç¨‹å…±äº«å˜é‡</li><li>ä½¿çŠ¶æ€å˜é‡ä¸å¯å˜</li><li>åœ¨ä»»ä½•è®¿é—®çŠ¶æ€å˜é‡çš„æ—¶å€™ä½¿ç”¨åŒæ­¥</li></ul><h2 id="2-Javaçº¿ç¨‹å®‰å…¨"><a href="#2-Javaçº¿ç¨‹å®‰å…¨" class="headerlink" title="2. Javaçº¿ç¨‹å®‰å…¨"></a>2. Javaçº¿ç¨‹å®‰å…¨</h2><h3 id="2-1-çº¿ç¨‹å®‰å…¨å¼ºå¼±ç­‰çº§"><a href="#2-1-çº¿ç¨‹å®‰å…¨å¼ºå¼±ç­‰çº§" class="headerlink" title="2.1 çº¿ç¨‹å®‰å…¨å¼ºå¼±ç­‰çº§"></a>2.1 çº¿ç¨‹å®‰å…¨å¼ºå¼±ç­‰çº§</h3><p>Javaè¯­è¨€ä¸­æ“ä½œå„ç§å…±äº«çš„æ•°æ®å¯æ ¹æ®å®‰å…¨ç¨‹åº¦åˆ†ä¸ºä»¥ä¸‹5ç±»ï¼š</p><h4 id="2-1-1-ä¸å¯å˜"><a href="#2-1-1-ä¸å¯å˜" class="headerlink" title="2.1.1 ä¸å¯å˜"></a>2.1.1 ä¸å¯å˜</h4><p>åœ¨Javaçº¿ç¨‹é‡Œé¢ï¼Œä¸å¯å˜ï¼ˆImmutableï¼‰çš„å¯¹è±¡ä¸€å®šæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ— è®ºæ˜¯å¯¹è±¡çš„æ–¹æ³•å®ç°è¿˜æ˜¯æ–¹æ³•çš„è°ƒç”¨è€…ï¼Œéƒ½ä¸éœ€è¦å†è¿›è¡Œä»»ä½•çš„çº¿ç¨‹å®‰å…¨ä¿éšœæªæ–½ã€‚</p><p>Javaè¯­è¨€ä¸­ï¼Œå¦‚æœå…±äº«æ•°æ®æ˜¯ä¸€ä¸ªåŸºæœ¬æ•°æ®ç±»å‹ï¼Œåªè¦åœ¨å®šä¹‰æ—¶ä½¿ç”¨finalå…³é”®å­—ä¿®é¥°å®ƒå°±å¯ä»¥ä¿è¯å®ƒæ˜¯ä¸å¯å˜çš„ï¼›å¦‚æœå…±äº«æ•°æ®æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œé‚£å°±éœ€è¦ä¿è¯å¯¹è±¡çš„è¡Œä¸ºä¸ä¼šå¯¹å…¶çŠ¶æ€äº§ç”Ÿä»»ä½•å½±å“æ‰è¡Œã€‚åªè¦ä¸€ä¸ªä¸å¯å˜çš„å¯¹è±¡è¢«æ­£ç¡®æ„å»ºå‡ºæ¥ï¼ˆæ²¡æœ‰å‘ç”Ÿ<a href="https://www.cnblogs.com/straybirds/p/8640748.html" target="_blank" rel="noopener">thiså¼•ç”¨é€ƒé€¸</a>çš„æƒ…å†µï¼‰ï¼Œé‚£ä¹ˆå…¶å¤–éƒ¨çš„å¯è§çŠ¶æ€ä¹Ÿä¸ä¼šæ”¹å˜ã€‚ä¿è¯å¯¹è±¡çš„è¡Œä¸ºä¸å½±å“è‡ªå·±çŠ¶æ€çš„é€”å¾„æœ‰å¾ˆå¤šç§ï¼Œæœ€ç®€å•çš„å°±æ˜¯æŠŠå¯¹è±¡ä¸­å¸¦æœ‰çŠ¶æ€çš„å˜é‡éƒ½å£°æ˜ä¸ºfinalã€‚</p><h4 id="2-1-2-ç»å¯¹çº¿ç¨‹å®‰å…¨"><a href="#2-1-2-ç»å¯¹çº¿ç¨‹å®‰å…¨" class="headerlink" title="2.1.2 ç»å¯¹çº¿ç¨‹å®‰å…¨"></a>2.1.2 ç»å¯¹çº¿ç¨‹å®‰å…¨</h4><p>ä¸ç®¡è¿è¡Œæ—¶ç¯å¢ƒå¦‚ä½•ï¼Œè°ƒç”¨è€…éƒ½ä¸éœ€è¦ä»»ä½•é¢å¤–çš„åŒæ­¥æªæ–½ã€‚</p><h4 id="2-1-3-ç›¸å¯¹çº¿ç¨‹å®‰å…¨"><a href="#2-1-3-ç›¸å¯¹çº¿ç¨‹å®‰å…¨" class="headerlink" title="2.1.3 ç›¸å¯¹çº¿ç¨‹å®‰å…¨"></a>2.1.3 ç›¸å¯¹çº¿ç¨‹å®‰å…¨</h4><p>å¯¹è±¡å•ç‹¬çš„æ“ä½œæ—¶çº¿ç¨‹å®‰å…¨çš„ï¼Œæˆ‘ä»¬åœ¨è°ƒç”¨çš„æ—¶å€™ä¸éœ€è¦åšé¢å¤–çš„ä¿éšœæªæ–½ï¼Œå¯¹äºç‰¹å®šé¡ºåºçš„è¿ç»­è°ƒç”¨ï¼Œå°±å¯èƒ½éœ€è¦åœ¨è°ƒç”¨ç«¯ä½¿ç”¨é¢å¤–çš„åŒæ­¥æ‰‹æ®µæ¥ä¿è¯è°ƒç”¨çš„æ­£ç¡®æ€§ã€‚ä¾‹å¦‚ï¼šVectorã€ConcurrentHashMapç­‰ã€‚</p><h4 id="2-1-4-çº¿ç¨‹å…¼å®¹"><a href="#2-1-4-çº¿ç¨‹å…¼å®¹" class="headerlink" title="2.1.4 çº¿ç¨‹å…¼å®¹"></a>2.1.4 çº¿ç¨‹å…¼å®¹</h4><p>çº¿ç¨‹å…¼å®¹æ˜¯æŒ‡å¯¹è±¡æœ¬èº«ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡åœ¨è°ƒç”¨ç«¯æ­£ç¡®çš„ä½¿ç”¨åŒæ­¥æ‰‹æ®µæ¥ä¿è¯å¯¹è±¡åœ¨å¹¶å‘ç¯å¢ƒä¸­å®‰å…¨åœ°ä½¿ç”¨ã€‚ä¾‹å¦‚ï¼šHashMapç­‰ã€‚</p><h4 id="2-1-5-çº¿ç¨‹å¯¹ç«‹"><a href="#2-1-5-çº¿ç¨‹å¯¹ç«‹" class="headerlink" title="2.1.5 çº¿ç¨‹å¯¹ç«‹"></a>2.1.5 çº¿ç¨‹å¯¹ç«‹</h4><p>çº¿ç¨‹å¯¹ç«‹æŒ‡ä¸ç®¡è°ƒç”¨ç«¯æ˜¯å¦é‡‡å–äº†åŒæ­¥æªæ–½ï¼Œéƒ½æ— æ³•åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­å¹¶å‘ä½¿ç”¨ä»£ç ã€‚ä¾‹å¦‚ï¼šThreadç±»ä¸­çš„suspend(),resume()æ–¹æ³•ã€‚</p><h3 id="2-2-Javaçº¿ç¨‹å®‰å…¨å®ç°"><a href="#2-2-Javaçº¿ç¨‹å®‰å…¨å®ç°" class="headerlink" title="2.2 Javaçº¿ç¨‹å®‰å…¨å®ç°"></a>2.2 Javaçº¿ç¨‹å®‰å…¨å®ç°</h3><h4 id="2-2-1-äº’æ–¥åŒæ­¥"><a href="#2-2-1-äº’æ–¥åŒæ­¥" class="headerlink" title="2.2.1 äº’æ–¥åŒæ­¥"></a>2.2.1 äº’æ–¥åŒæ­¥</h4><p>äº’æ–¥åŒæ­¥(Mutual Exclusion &amp; Synchronization)æ˜¯æœ€å¸¸è§çš„ä¸€ç§å¹¶å‘æ­£ç¡®æ€§ä¿éšœæ‰‹æ®µï¼ŒåŒæ­¥æ˜¯æŒ‡åœ¨å¤šä¸ªçº¿ç¨‹å¹¶å‘è®¿é—®å…±äº«æ•°æ®æ—¶ï¼Œä¿è¯å…±äº«æ•°æ®åœ¨åŒä¸€ä¸ªæ—¶åˆ»åªè¢«ä¸€æ¡çº¿ç¨‹ä½¿ç”¨ã€‚æ˜¯ä¸€ç§æ‚²è§‚çš„å¹¶å‘ç­–ç•¥ï¼Œæ— è®ºæ˜¯å¦å¹¶å‘éƒ½éœ€è¦åŠ é”ã€‚<br>æ‰‹æ®µï¼šsynchronizedã€ReentrantLockã€‚<br>ç¼ºç‚¹ï¼šçº¿ç¨‹é˜»å¡å’Œå”¤é†’å¸¦æ¥çš„æ€§èƒ½é—®é¢˜ï¼Œå› æ­¤äº’æ–¥åŒæ­¥ä¹Ÿç§°ä¸ºé˜»å¡åŒæ­¥(Blocking Synchronization)ã€‚</p><h4 id="2-2-2-éé˜»å¡åŒæ­¥"><a href="#2-2-2-éé˜»å¡åŒæ­¥" class="headerlink" title="2.2.2 éé˜»å¡åŒæ­¥"></a>2.2.2 éé˜»å¡åŒæ­¥</h4><p>éé˜»å¡åŒæ­¥(Non-Blocking Synchronization)æ˜¯åŸºäºå†²çªæ£€æµ‹çš„ä¹è§‚å¹¶å‘ç­–ç•¥ï¼Œé€šä¿—çš„è®²å°±æ˜¯å…ˆè¿›è¡Œæ“ä½œï¼Œå¦‚æœæ²¡æœ‰å…¶ä»–çº¿ç¨‹äº‰ç”¨å…±äº«æ•°æ®ï¼Œåˆ™æ“ä½œæˆåŠŸï¼Œå¦åˆ™äº§ç”Ÿå†²çªï¼Œç„¶åè¿›è¡Œè¡¥å¿æªæ–½ï¼ˆæœ€å¸¸è§çš„å°±æ˜¯ä¸æ–­çš„é‡è¯•ï¼ŒçŸ¥é“è¯•æˆåŠŸä¸ºæ­¢ï¼‰ã€‚<br>è¦æ±‚ï¼šç¡¬ä»¶æŒ‡ä»¤é›†çš„å‘å±•ï¼Œéœ€è¦æ“ä½œå’Œæ£€æµ‹ä¸¤ä¸ªæ­¥éª¤å…·å¤‡åŸå­æ€§ã€‚<br>å¸¸è§æŒ‡ä»¤ï¼šæµ‹è¯•å¹¶è®¾ç½®(Test-and-Set)ã€è·å–å¹¶å¢åŠ (Fetch-and-Increment)ã€äº¤æ¢(Swap)ã€æ¯”è¾ƒå¹¶äº¤æ¢(Compare-and-Swap,CAS)ã€åŠ è½½é“¾æ¥/æ¡ä»¶å­˜å‚¨(Load-linked/Store-Conditional,LL/SC)ã€‚</p><h4 id="2-2-3-æ— åŒæ­¥æ–¹æ¡ˆ"><a href="#2-2-3-æ— åŒæ­¥æ–¹æ¡ˆ" class="headerlink" title="2.2.3 æ— åŒæ­¥æ–¹æ¡ˆ"></a>2.2.3 æ— åŒæ­¥æ–¹æ¡ˆ</h4><p>è¦ä¿è¯çº¿ç¨‹åŒæ­¥ï¼Œä¸ä¸€å®šå°±è¦è¿›è¡ŒåŒæ­¥ï¼Œä¸¤è€…æ²¡æœ‰å› æœå…³ç³»ã€‚åŒæ­¥åªæ˜¯ä¿è¯å…±äº«æ•°æ®äº‰ç”¨æ—¶æ­£ç¡®æ€§çš„æ‰‹æ®µï¼Œå¦‚æœæœ‰äº›ä»£ç ä¸æ¶‰åŠå…±äº«æ•°æ®ï¼Œè‡ªç„¶æ— éœ€åŒæ­¥ä¿è¯å…±äº«æ•°æ®äº‰ç”¨æ—¶çš„æ­£ç¡®æ€§ã€‚</p><ul><li>å¯é‡å…¥ä»£ç ï¼ˆReentrant Codeï¼‰ï¼šè¿™ç§ä»£ç ä¹Ÿå«çº¯ä»£ç ï¼ˆPure Codeï¼‰ï¼Œå¯ä»¥åœ¨ä»£ç æ‰§è¡Œçš„ä»»ä½•æ—¶åˆ»ä¸­æ–­å®ƒï¼Œè½¬å»æ‰§è¡Œå¦å¤–ä¸€æ®µä»£ç ï¼Œè€Œæ§åˆ¶æƒå›æ¥åç»§ç»­æ‰§è¡Œä»£ç ï¼Œç¨‹åºä¸ä¼šå‡ºç°ä»»ä½•é”™è¯¯ã€‚</li><li>çº¿ç¨‹æœ¬åœ°å­˜å‚¨ï¼ˆThread Local Storageï¼‰ï¼šå¦‚æœä¸€æ®µä»£ç æ‰€éœ€è¦çš„æ•°æ®å¿…é¡»ä¸å…¶ä»–ä»£ç å…±äº«ï¼Œé‚£å°±çœ‹çœ‹è¿™äº›å…±äº«æ•°æ®çš„ä»£ç æ˜¯å¦èƒ½ä¿è¯åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œï¼Œå¦‚æœèƒ½ä¿è¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠå…±äº«æ•°æ®çš„å¯è§èŒƒå›´é™åˆ¶åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¹‹å†…ï¼Œæ— éœ€åŒæ­¥ä¹Ÿèƒ½å®ç°çº¿ç¨‹ä¹‹é—´ä¸å‡ºç°æ•°æ®äº‰ç”¨çš„é—®é¢˜ã€‚</li></ul><h2 id="3-Javaé”ä¼˜åŒ–"><a href="#3-Javaé”ä¼˜åŒ–" class="headerlink" title="3. Javaé”ä¼˜åŒ–"></a>3. Javaé”ä¼˜åŒ–</h2><p>ä¸ºäº†åœ¨çº¿ç¨‹ä¹‹é—´æ›´é«˜æ•ˆåœ°å…±äº«æ•°æ®ï¼Œä»¥åŠè§£å†³æ•°æ®ç«äº‰é—®é¢˜ï¼ŒJDKå®ç°äº†å„ç§é”çš„ä¼˜åŒ–æŠ€æœ¯ï¼Œå¦‚é€‚åº”æ€§è‡ªæ—‹(Adaptive Spinning)ã€é”æ¶ˆé™¤(Lock Elimination)ã€é”ç²—åŒ–(Lock Coarsening)ã€è½»é‡çº§é”(Lightweight Locking)ã€åå‘é”(Biased Locking)ç­‰ã€‚</p><h4 id="3-1-è‡ªæ—‹é”ä¸è‡ªé€‚åº”æ€§è‡ªæ—‹"><a href="#3-1-è‡ªæ—‹é”ä¸è‡ªé€‚åº”æ€§è‡ªæ—‹" class="headerlink" title="3.1 è‡ªæ—‹é”ä¸è‡ªé€‚åº”æ€§è‡ªæ—‹"></a>3.1 è‡ªæ—‹é”ä¸è‡ªé€‚åº”æ€§è‡ªæ—‹</h4><p>äº’æ–¥åŒæ­¥å¯¹æ€§èƒ½æœ€å¤§çš„å½±å“æ˜¯é˜»å¡çš„å®ç°ï¼ŒæŒ‚èµ·å’Œæ¢å¤çº¿ç¨‹çš„æ“ä½œéƒ½éœ€è¦è½¬å…¥å†…æ ¸æ€å®Œæˆï¼Œè¿™äº›æ“ä½œç»™å¹¶å‘æ€§èƒ½å¸¦æ¥å¾ˆå¤§çš„å‹åŠ›ã€‚å¦‚æœè·å–å…±äº«æ•°æ®é”æ—¶ä»…éœ€è¦ç­‰å¾…å¾ˆçŸ­çš„æ—¶é—´ï¼Œä¸ºäº†å¾ˆçŸ­çš„æ—¶é—´å»æŒ‚èµ·å’Œæ¢å¤çº¿ç¨‹å¹¶ä¸å€¼å¾—ã€‚å¦‚æœå¤„ç†å™¨æœ‰ä¸€ä¸ªä»¥ä¸Šçš„å¤„ç†å™¨ï¼Œæˆ‘ä»¬å¯ä»¥çº¿ç¨‹è®©è¯·æ±‚é”çš„çº¿ç¨‹å¿™å¾ªç¯ï¼Œä¸æ”¾å¼ƒå¤„ç†å™¨çš„æ‰§è¡Œæ—¶é—´ï¼Œè¿™é¡¹æŠ€æœ¯å°±æ˜¯æ‰€è°“çš„è‡ªæ—‹é”ã€‚<br>è‡ªé€‚åº”è‡ªæ—‹é”æ„å‘³ç€è‡ªæ—‹çš„æ—¶é—´ä¸å†å›ºå®šï¼Œæ ¹æ®å‰ä¸€æ¬¡åœ¨åŒä¸€ä¸ªé”ä¸Šçš„è‡ªæ—‹æ—¶é—´åŠé”çš„æ‹¥æœ‰è€…çš„çŠ¶æ€æ¥å†³å®šã€‚</p><h4 id="3-2-é”æ¶ˆé™¤"><a href="#3-2-é”æ¶ˆé™¤" class="headerlink" title="3.2 é”æ¶ˆé™¤"></a>3.2 é”æ¶ˆé™¤</h4><p>é”æ¶ˆé™¤æ˜¯æŒ‡è™šæ‹Ÿæœºå³æ—¶ç¼–è¯‘å™¨åœ¨è¿è¡Œæ—¶ï¼Œå¯¹ä¸€äº›ä»£ç è¦æ±‚åŒæ­¥ï¼Œä½†æ˜¯è¢«æ£€æµ‹åˆ°ä¸å¯èƒ½å­˜åœ¨å…±äº«æ•°æ®ç«äº‰çš„é”è¿›è¡Œæ¶ˆé™¤ã€‚é”æ¶ˆé™¤çš„ä¸»è¦åˆ¤å®šä¾æ®æ¥æºäºé€ƒé€¸åˆ†æçš„æ•°æ®æ”¯æŒï¼Œå¦‚æœåˆ¤æ–­åˆ°ä¸€æ®µä»£ç ä¸­ï¼Œåœ¨å †ä¸Šçš„æ‰€æœ‰æ•°æ®éƒ½ä¸ä¼šé€ƒé€¸å‡ºå»è¢«å…¶ä»–çº¿ç¨‹è®¿é—®åˆ°ï¼Œé‚£å°±å¯ä»¥æŠŠå®ƒä»¬å½“ä½œæ ˆä¸Šæ•°æ®å¯¹å¾…ï¼Œè®¤ä¸ºæ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼ŒåŒæ­¥åŠ é”è‡ªç„¶æ— éœ€æ‰§è¡Œã€‚</p><h4 id="3-3-é”ç²—åŒ–"><a href="#3-3-é”ç²—åŒ–" class="headerlink" title="3.3 é”ç²—åŒ–"></a>3.3 é”ç²—åŒ–</h4><p>å¦‚æœä¸€ç³»åˆ—çš„è¿ç»­æ“ä½œéƒ½å¯¹åŒä¸€ä¸ªå¯¹è±¡åå¤åŠ é”è§£é”ï¼Œç”šè‡³åŠ é”æ“ä½œå‡ºç°åœ¨å¾ªç¯ä½“ä¸­ã€‚å¦‚æœè™šæ‹Ÿæœºæ¢æµ‹åˆ°æœ‰è¿™æ ·ä¸€ä¸²é›¶ç¢çš„æ“ä½œéƒ½å¯¹ä¸€ä¸ªå¯¹è±¡åŠ é”ï¼Œå°†ä¼šæŠŠåŠ é”åŒæ­¥çš„èŒƒå›´æ‰©å±•ï¼ˆç²—åŒ–ï¼‰åˆ°æ•´ä¸ªæ“ä½œåºåˆ—çš„å¤–éƒ¨ï¼Œè¿™æ ·åªåŠ é”ä¸€æ¬¡å°±å¯ä»¥ã€‚</p><h4 id="3-4-è½»é‡çº§é”"><a href="#3-4-è½»é‡çº§é”" class="headerlink" title="3.4 è½»é‡çº§é”"></a>3.4 è½»é‡çº§é”</h4><p>è½»é‡çº§é”æ˜¯JDK1.6 ä¸­åŠ å…¥çš„æ–°å‹é”æœºåˆ¶ï¼Œè½»é‡çº§æ˜¯ç›¸å¯¹äºä½¿ç”¨æ“ä½œç³»ç»Ÿäº’æ–¥é‡æ¥å®ç°ä¼ ç»Ÿé”è€Œè¨€ï¼Œå› æ­¤ä¼ ç»Ÿé”æœºåˆ¶è¢«ç§°ä¸ºé‡é‡çº§é”ã€‚è½»é‡çº§é”æœ¬æ„æŒ‡åœ¨æ²¡æœ‰å¤šçº¿ç¨‹ç«äº‰çš„å‰æä¸‹ï¼Œå‡å°‘ä¼ ç»Ÿçš„é‡é‡çº§é”ä½¿ç”¨æ“ä½œç³»ç»Ÿäº’æ–¥é‡äº§ç”Ÿçš„æ€§èƒ½æ¶ˆè€—ã€‚</p><p>HotSpotè™šæ‹Ÿæœºçš„å¯¹è±¡å¤´(Object Header)åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œç¬¬ä¸€ç”¨äºå­˜å‚¨è‡ªèº«çš„è¿è¡Œæ—¶æ•°æ®ï¼Œè¿™éƒ¨åˆ†æ•°æ®çš„é•¿åº¦åœ¨32ä½å’Œ64ä½çš„è™šæ‹Ÿæœºåˆ†åˆ«æ˜¯32ä¸ªå’Œ64ä¸ªbitsï¼Œå®˜ç½‘ç§°å®ƒä¸ºâ€Mark Wordâ€ã€‚å¦ä¸€éƒ¨åˆ†ç”¨äºå­˜å‚¨æŒ‡å‘æ–¹æ³•åŒºå¯¹è±¡ç±»å‹æ•°æ®çš„æŒ‡é’ˆï¼Œå¦‚æœæ˜¯æ•°ç»„å¯¹è±¡çš„è¯ï¼Œè¿˜æœ‰ä¸€ä¸ªé¢å¤–çš„éƒ¨åˆ†ç”¨äºå­˜å‚¨æ•°ç»„é•¿åº¦ã€‚<br><img src="/media/article/object-header.png" alt="mark word"><br>è¡¨æ‘˜è‡ª<a href="#è½»é‡çº§é”">Javaå¹¶å‘ç¼–ç¨‹è‰ºæœ¯ 2.2å°èŠ‚</a><br>å¯¹è±¡å¤´ä¿¡æ¯æ˜¯ä¸å¯¹è±¡è‡ªèº«å®šä¹‰çš„æ•°æ®æ— å…³çš„é¢å¤–å­˜å‚¨æˆæœ¬ï¼Œè€ƒè™‘åˆ°è™šæ‹Ÿæœºç©ºé—´æ•ˆç‡ï¼ŒMark Wordè¢«è®¾è®¡æˆä¸€ä¸ªéå›ºå®šçš„æ•°æ®ç»“æ„ä»¥ä¾¿åœ¨æå°çš„ç©ºé—´å†…å­˜å‚¨å°½é‡å¤šçš„ä¿¡æ¯ï¼Œæ ¹æ®å¯¹è±¡çš„çŠ¶æ€å¤ç”¨è‡ªå·±çš„å­˜å‚¨ç©ºé—´ã€‚<br>HotSpot è™šæ‹Ÿæœºå¯¹è±¡å¤´Mark Wordä¸åŒçŠ¶æ€ä¸‹å­˜å‚¨å†…å®¹è¡¨ï¼š<br><img src="/media/article/markword.png" alt="mark word"><br>è¡¨æ‘˜è‡ª<a href="#è½»é‡çº§é”">æ·±å…¥ç†è§£Javaè™šæ‹Ÿæœº-JVMé«˜çº§ç‰¹æ€§ä¸å®è·µ 13.3å°èŠ‚</a><br>ä¸Šè¡¨ä¸­å­˜å‚¨å†…å®¹åˆ—æ˜¯Mark Wordä¸­é™¤æ ‡å¿—ä½å¤–ï¼Œå…¶ä»–çš„30bitç©ºé—´çš„å­˜å‚¨å†…å®¹ï¼ŒçŠ¶æ€åˆ—æ˜¯æŒ‡ä¸åŒçš„é”çŠ¶æ€ï¼Œå¦‚ï¼šè½»é‡çº§é”ï¼Œé‡é‡çº§é”ç­‰ç­‰ã€‚å…·ä½“å†…å®¹å­˜å‚¨å ä½å¦‚ä¸‹å›¾æ‰€ç¤º<br><img src="/media/article/markword-status.png" alt="mark word status"><br>è¡¨æ‘˜è‡ª<a href="#è½»é‡çº§é”">Javaå¹¶å‘ç¼–ç¨‹è‰ºæœ¯ 2.2å°èŠ‚</a><br>è½»é‡çº§é”çš„æ‰§è¡Œè¿‡ç¨‹ï¼šåœ¨ä»£ç è¿›å…¥åŒæ­¥å—çš„æ—¶å€™ï¼Œå¦‚æœæ­¤åŒæ­¥å¯¹è±¡æ²¡æœ‰è¢«é”å®šï¼ˆé”æ ‡å¿—ä½ä¸ºâ€œ01â€çŠ¶æ€ï¼‰ï¼Œè™šæ‹Ÿæœºé¦–å…ˆåœ¨å½“å‰çº¿ç¨‹çš„æ ˆå¸§ä¸­å»ºç«‹ä¸€ä¸ªåä¸ºé”è®°å½•ï¼ˆLock Recordï¼‰çš„ç©ºé—´ï¼Œç”¨äºå­˜å‚¨é”å¯¹è±¡ç›®å‰çš„Mark Wordæ‹·è´ï¼Œå¦‚å›¾ï¼š<br><img src="/media/article/markword-cas-before.png" alt="markword-cas-before"><br>å›¾æ‘˜è‡ª<a href="#è½»é‡çº§é”">æ·±å…¥ç†è§£Javaè™šæ‹Ÿæœº-JVMé«˜çº§ç‰¹æ€§ä¸å®è·µ 13.3å°èŠ‚</a><br>ç„¶åï¼Œè™šæ‹Ÿæœºå°†ä½¿ç”¨CASæ“ä½œå°è¯•å°†å¯¹è±¡çš„Mark Wordæ›´æ–°ä¸ºæŒ‡å‘Lock Recordçš„æŒ‡é’ˆã€‚å¦‚æœè¿™ä¸ªæ›´æ–°æˆåŠŸäº†ï¼Œé‚£ä¹ˆè¯¥çº¿ç¨‹å°±æ‹¥æœ‰äº†è¯¥å¯¹è±¡çš„é”ï¼Œå¹¶ä¸”å¯¹è±¡Mark Wordçš„é”æ ‡å¿—ä½å°†è½¬ä¸ºâ€œ00â€ï¼Œå³è¡¨ç¤ºè¯¥å¯¹è±¡å¤„äºè½»é‡çº§é”å®šçŠ¶æ€ã€‚<br><img src="/media/article/markword-cas-after.png" alt="markword-cas-after"><br>å›¾æ‘˜è‡ª<a href="#è½»é‡çº§é”">æ·±å…¥ç†è§£Javaè™šæ‹Ÿæœº-JVMé«˜çº§ç‰¹æ€§ä¸å®è·µ 13.3å°èŠ‚</a><br>å¦‚æœæ›´æ–°å¤±è´¥ï¼Œè™šæ‹Ÿæœºé¦–å…ˆä¼šæ£€æŸ¥å¯¹è±¡çš„Mark Wordæ˜¯å¦æŒ‡å‘å½“å‰çº¿ç¨‹çš„æ ˆå¸§ï¼Œå¦‚æœæ˜¯ï¼Œå°±è¯´æ˜å½“å‰çº¿ç¨‹å·²ç»æ‹¥æœ‰äº†è¯¥å¯¹è±¡çš„é”ï¼Œå¯ç›´æ¥è¿›å…¥åŒæ­¥ä»£ç å—ç»§ç»­æ‰§è¡Œï¼Œå¦åˆ™è¯´æ˜è¿™ä¸ªé”å¯¹è±¡è¢«å…¶ä»–çº¿ç¨‹æŠ¢å äº†ã€‚å¦‚æœæœ‰ä¸¤æ¡ä»¥ä¸Šï¼ˆåŒ…æ‹¬ä¸¤æ¡ï¼‰çš„çº¿ç¨‹äº‰ç”¨åŒä¸€ä¸ªé”ï¼Œè½»é‡çº§é”ä¸å†æœ‰æ•ˆè¦è†¨èƒ€ä¸ºé‡é‡çº§é”ï¼Œé”æ ‡å¿—çš„çŠ¶æ€å€¼å˜ä¸ºâ€œ10â€ï¼ŒMark Wordä¸­å­˜å‚¨çš„å°±æ˜¯æŒ‡å‘é‡é‡çº§é”çš„æŒ‡é’ˆï¼Œåé¢ç­‰å¾…çš„çº¿ç¨‹ä¹Ÿè¦è¿›å…¥é˜»å¡çŠ¶æ€ã€‚<br>è½»é‡çº§é”åˆå§‹åŒ–åŠè†¨èƒ€æµç¨‹å›¾ï¼š<br><img src="/media/article/lightweight-expand.png" alt="lightweight"><br>å›¾æ‘˜è‡ª<a href="#è½»é‡çº§é”">Javaå¹¶å‘ç¼–ç¨‹è‰ºæœ¯ 2.2å°èŠ‚</a><br>è§£é”è¿‡ç¨‹ä¹Ÿæ˜¯é€šè¿‡CASæ“ä½œæ¥è¿›è¡Œçš„ï¼Œå¦‚æœå¯¹è±¡çš„Mark Wordä»æŒ‡å‘çº¿ç¨‹çš„é”è®°å½•ï¼Œå°±ç”¨CASæ“ä½œæŠŠå¯¹è±¡å½“å‰çš„Mark Wordå’Œçº¿ç¨‹ä¸­å¤åˆ¶çš„Displaced Mark Wordæ›¿æ¢å›æ¥ï¼Œå¦‚æœæ›¿æ¢æˆåŠŸï¼ŒåŒæ­¥å®Œæˆã€‚æ›¿æ¢å¤±è´¥ï¼Œæœ‰å…¶ä»–çº¿ç¨‹å°è¯•è·å–è¯¥é”ï¼Œæ­¤æ—¶é”å·²ç»è†¨èƒ€ï¼Œå°±è¦åœ¨é‡Šæ”¾é”çš„åŒæ—¶ï¼Œå”¤é†’è¢«æŒ‚èµ·çš„çº¿ç¨‹ã€‚</p><h4 id="3-5-åå‘é”"><a href="#3-5-åå‘é”" class="headerlink" title="3.5 åå‘é”"></a>3.5 åå‘é”</h4><p>åå‘é”ç›®çš„æ˜¯æ¶ˆé™¤æ•°æ®åœ¨æ— ç«äº‰æƒ…å†µä¸‹çš„åŒæ­¥åŸè¯­ã€‚<br>ä½¿ç”¨åœºæ™¯ï¼šé”ä¸ä»…ä¸å­˜åœ¨å¤šçº¿ç¨‹ç«äº‰ï¼Œè€Œä¸”æ€»æ˜¯ç”±åŒä¸€çº¿ç¨‹å¤šæ¬¡è·å¾—ã€‚<br>åå‘é”åŸç†ï¼šå½“é”å¯¹è±¡ç¬¬ä¸€æ¬¡è¢«çº¿ç¨‹è·å–çš„æ—¶å€™ï¼Œè™šæ‹Ÿæœºå°†ä¼šæŠŠå¯¹è±¡å¤´ä¸­çš„æ ‡å¿—ä½è®¾ä¸ºâ€œ01â€ï¼ˆMark Wordè§3.4å°èŠ‚çš„è¡¨ä¸­ï¼‰ï¼Œå³åå‘æ¨¡å¼ã€‚åŒæ—¶ä½¿ç”¨CASæ“ä½œæŠŠè·å–åˆ°è¿™ä¸ªé”çš„çº¿ç¨‹çš„IDè®°å½•åœ¨å¯¹è±¡çš„Mark Wordä¹‹ä¸­ï¼Œå¦‚æœCASæ“ä½œæˆåŠŸï¼ŒæŒæœ‰åå‘é”çš„çº¿ç¨‹ä»¥åæ¯æ¬¡è¿›å…¥è¿™ä¸ªé”ç›¸å…³çš„åŒæ­¥æ—¶ï¼Œè™šæ‹Ÿæœºéƒ½å¯ä»¥ä¸å†è¿›è¡Œä»»ä½•åŒæ­¥æ“ä½œï¼Œåªéœ€ç®€å•æµ‹è¯•å¯¹è±¡å¤´çš„Mark Wordæ˜¯å¦å­˜å‚¨ç€æŒ‡å‘å½“å‰çº¿ç¨‹çš„åå‘é”ã€‚å¦‚æœæµ‹è¯•æˆåŠŸï¼Œè¡¨ç¤ºçº¿ç¨‹å·²ç»è·å¾—é”ã€‚å¦‚æœæµ‹è¯•å¤±è´¥ï¼Œåˆ™éœ€è¦åœ¨æµ‹è¯•ä¸€ä¸‹Mark Wordä¸­åå‘é”çš„æ ‡è¯†æ˜¯å¦è®¾ç½®æˆâ€01â€ï¼šå¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œåˆ™ä½¿ç”¨CASç«äº‰é”ï¼Œå¦‚æœç«äº‰æˆåŠŸï¼Œåˆ™å°†Mark Wordä¸­çº¿ç¨‹IDè®¾ç½®ä¸ºå½“å‰çº¿ç¨‹IDï¼Œç»§ç»­æ‰§è¡ŒåŒæ­¥å—ï¼›å¦‚æœç«äº‰å¤±è´¥ï¼Œåˆ™è¿›è¡Œåå‘é”æ’¤é”€ã€‚å¦‚æœè®¾ç½®äº†åˆ™å°è¯•ä½¿ç”¨CASå°†å¯¹è±¡å¤´çš„åå‘é”æŒ‡å‘å½“å‰çº¿ç¨‹ã€‚<br>åå‘é”æ’¤é”€ï¼ˆRevoke Biasï¼‰ï¼šå½“æœ‰å¦å¤–ä¸€ä¸ªçº¿ç¨‹å°è¯•å»è·å–è¿™ä¸ªé”æ—¶ï¼Œåå‘æ¨¡å¼ç»“æŸã€‚åå‘é”çš„æ’¤é”€ï¼Œéœ€è¦ç­‰å¾…å…¨å±€å®‰å…¨ç‚¹ï¼ˆåœ¨è¿™ä¸ªæ—¶é—´ç‚¹ä¸Šæ²¡æœ‰æ­£åœ¨æ‰§è¡Œçš„å­—èŠ‚ç ï¼‰ã€‚å®ƒé¦–å…ˆæš‚åœæ‹¥æœ‰åå‘é”çš„çº¿ç¨‹ï¼Œç„¶åæ£€æŸ¥æŒæœ‰åå‘é”çš„çº¿ç¨‹æ˜¯å¦æ´»ç€ï¼Œå¦‚æœä¸å¤„äºæ´»åŠ¨çŠ¶æ€ï¼Œåˆ™å°†å¯¹è±¡å¤´è®¾ç½®æˆæ— é”çŠ¶æ€ï¼›å¦‚æœçº¿ç¨‹è¿˜æ´»ç€ï¼Œæ‹¥æœ‰åå‘é”çš„æ ˆä¼šè¢«æ‰§è¡Œï¼Œéå†åå‘å¯¹è±¡çš„é”è®°å½•ï¼Œæ ˆä¸­çš„é”è®°å½•å’Œå¯¹è±¡å¤´çš„Mark Wordè¦ä¹ˆé‡æ–°åå‘äºå…¶ä»–çº¿ç¨‹ï¼Œè¦ä¹ˆæ¢å¤åˆ°æ— é”æˆ–è€…æ ‡è®°å¯¹è±¡ä¸é€‚åˆä½œä¸ºåå‘é”ï¼Œæœ€åå”¤é†’æš‚åœçš„çº¿ç¨‹ã€‚<br>åå‘é”ã€è½»é‡çº§é”çš„çŠ¶æ€è½¬åŒ–åŠå¯¹è±¡Mark Wordçš„å…³ç³»å¦‚å›¾ï¼š<br><img src="/media/article/markword-change.png" alt="markword-change"><br>å›¾æ‘˜è‡ª<a href="#åå‘é”">æ·±å…¥ç†è§£Javaè™šæ‹Ÿæœº-JVMé«˜çº§ç‰¹æ€§ä¸å®è·µ 13.3å°èŠ‚</a><br>åå‘é”åˆå§‹åŒ–åŠè†¨èƒ€æµç¨‹å›¾ï¼š<br><img src="/media/article/bias-expand.png" alt="bias-expand"><br>å›¾æ‘˜è‡ª<a href="#åå‘é”">Javaå¹¶å‘ç¼–ç¨‹è‰ºæœ¯ 2.2å°èŠ‚</a></p><h4 id="3-6-è½»é‡çº§é”ã€åå‘é”ã€é‡é‡çº§é”å¯¹æ¯”"><a href="#3-6-è½»é‡çº§é”ã€åå‘é”ã€é‡é‡çº§é”å¯¹æ¯”" class="headerlink" title="3.6 è½»é‡çº§é”ã€åå‘é”ã€é‡é‡çº§é”å¯¹æ¯”"></a>3.6 è½»é‡çº§é”ã€åå‘é”ã€é‡é‡çº§é”å¯¹æ¯”</h4><p>åå‘é”åˆå§‹åŒ–åŠè†¨èƒ€æµç¨‹å›¾ï¼š<br><img src="/media/article/lock-advantage-disadvantage.png" alt="lock"><br>å›¾æ‘˜è‡ª<a href="#è½»é‡çº§é”ã€åå‘é”ã€é‡é‡çº§é”å¯¹æ¯”">Javaå¹¶å‘ç¼–ç¨‹è‰ºæœ¯ 2.2å°èŠ‚</a></p><h2 id="å¼•ç”¨"><a href="#å¼•ç”¨" class="headerlink" title="å¼•ç”¨"></a>å¼•ç”¨</h2><p><a href="">æ·±å…¥ç†è§£Javaè™šæ‹Ÿæœº-JVMé«˜çº§ç‰¹æ€§ä¸å®è·µ</a><br><a href="">Javaå¹¶å‘ç¼–ç¨‹å®è·µ</a><br><a href="">Javaå¹¶å‘ç¼–ç¨‹è‰ºæœ¯</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;çº¿ç¨‹å®‰å…¨-è¯»ä¹¦ç¬”è®°&quot;&gt;&lt;a href=&quot;#çº¿ç¨‹å®‰å…¨-è¯»ä¹¦ç¬”è®°&quot; class=&quot;headerlink&quot; title=&quot;çº¿ç¨‹å®‰å…¨-è¯»ä¹¦ç¬”è®°&quot;&gt;&lt;/a&gt;çº¿ç¨‹å®‰å…¨-è¯»&lt;a href=&quot;#å¼•ç”¨&quot;&gt;ä¹¦&lt;/a&gt;ç¬”è®°&lt;/h1&gt;&lt;h2 id=&quot;1-æ¦‚è¿°&quot;&gt;&lt;a href=&quot;#1-æ¦‚
      
    
    </summary>
    
    
      <category term="å¹¶å‘" scheme="https://zhongyp.me/tags/%E5%B9%B6%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>çº¿ç¨‹å¯åŠ¨ä¸ç»ˆæ­¢</title>
    <link href="https://zhongyp.me/concurrency/2018-12-04-thread-start-end/"/>
    <id>https://zhongyp.me/concurrency/2018-12-04-thread-start-end/</id>
    <published>2018-12-03T16:00:00.000Z</published>
    <updated>2019-06-17T10:15:12.977Z</updated>
    
    <content type="html"><![CDATA[<h3 id="1-æ„é€ çº¿ç¨‹"><a href="#1-æ„é€ çº¿ç¨‹" class="headerlink" title="1. æ„é€ çº¿ç¨‹"></a>1. æ„é€ çº¿ç¨‹</h3><h4 id="1-1-æ„é€ çº¿ç¨‹çš„æ–¹å¼"><a href="#1-1-æ„é€ çº¿ç¨‹çš„æ–¹å¼" class="headerlink" title="1.1 æ„é€ çº¿ç¨‹çš„æ–¹å¼"></a>1.1 æ„é€ çº¿ç¨‹çš„æ–¹å¼</h4><p>Javaæ„é€ ä¸€ä¸ªçº¿ç¨‹æœ‰ä¸¤ç§æ–¹å¼ï¼š</p><p>ä¸€ç§æ˜¯å£°æ˜å­ç±»ç»§æ‰¿Threadçˆ¶ç±»å¹¶é‡å†™çˆ¶ç±»çš„runæ–¹æ³•ã€‚å¦‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">// çº¿ç¨‹ç±»</span><br><span class="line">class PrimeThread extends Thread &#123;</span><br><span class="line">    long minPrime;</span><br><span class="line">    PrimeThread(long minPrime) &#123;</span><br><span class="line">        this.minPrime = minPrime;</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    public void run() &#123;</span><br><span class="line">        // compute primes larger than minPrime</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//å¯åŠ¨çº¿ç¨‹å®ä¾‹</span><br><span class="line">PrimeThread p = new PrimeThread(143);</span><br><span class="line">p.start();</span><br></pre></td></tr></table></figure></p><p>å¦ä¸€ç§æ–¹å¼æ˜¯å£°æ˜å­ç±»å®ç°Runnableæ¥å£ï¼Œå¹¶å®ç°runæ–¹æ³•ã€‚å¦‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// çº¿ç¨‹ç±»</span><br><span class="line">class PrimeRun implements Runnable &#123;</span><br><span class="line">    long minPrime;</span><br><span class="line">    PrimeRun(long minPrime) &#123;</span><br><span class="line">        this.minPrime = minPrime;</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    public void run() &#123;</span><br><span class="line">        // compute primes larger than minPrime</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">//å¯åŠ¨çº¿ç¨‹å®ä¾‹</span><br><span class="line">PrimeRun p = new PrimeRun(143);</span><br><span class="line">new Thread(p).start();</span><br></pre></td></tr></table></figure></p><p>ä¸¤è€…å…¶å®åœ¨æœ¬è´¨ä¸Šæ˜¯ä¸€è‡´çš„ï¼Œå› ä¸ºThreadç±»ä¹Ÿç»§æ‰¿äº†Runableæ¥å£ï¼Œæ‰€ä»¥éƒ½å®ç°/é‡å†™Runableä¸­çš„runæ–¹æ³•ã€‚Javaå°†çº¿ç¨‹çš„æ‰§è¡Œå’Œæ‰§è¡Œå¯¹è±¡æŠ½è±¡å¼€æ¥ï¼ŒJDKä¸­æ‰§è¡Œçš„æ˜¯Threadç±»ï¼ŒExecutoræ¡†æ¶ï¼Œå¯æ‰§è¡Œç›®æ ‡æœ‰Runableï¼ŒCallableã€‚å¯¹äºæ„é€ çº¿ç¨‹çš„æ–¹å¼ç¬¬ä¸€ç§æ–¹å¼å¹¶ä¸æ¨èï¼Œå› ä¸ºç»§æ‰¿Threadç±»é™å®šäº†å…¶åŸºæœ¬è¡Œä¸ºï¼Œåœ¨è®¾è®¡ä¸Šè¿åå¤šç”¨ç»„åˆ å°‘ç”¨ç»§æ‰¿çš„åŸåˆ™ï¼Œæ‰€ä»¥ä¸€èˆ¬æ„é€ çº¿ç¨‹ä½¿ç”¨ç¬¬äºŒç§æ–¹å¼ï¼Œå®ç°Runableæ¥å£ã€‚</p><h4 id="1-2-æ„é€ çº¿ç¨‹çš„å±æ€§"><a href="#1-2-æ„é€ çº¿ç¨‹çš„å±æ€§" class="headerlink" title="1.2 æ„é€ çº¿ç¨‹çš„å±æ€§"></a>1.2 æ„é€ çº¿ç¨‹çš„å±æ€§</h4><p>æ„é€ çº¿ç¨‹æ—¶éœ€è¦æä¾›çº¿ç¨‹æ‰€éœ€è¦çš„å±æ€§ã€‚ä¸€ä¸ªæ–°çš„ï¼ˆchildï¼‰çº¿ç¨‹å¯¹è±¡æ˜¯ç”±parentçº¿ç¨‹è¿›è¡Œç©ºé—´åˆ†é…çš„ï¼Œè€Œchildçº¿ç¨‹ç»§æ‰¿äº†parentæ˜¯å¦ä¸ºDaemonã€ä¼˜å…ˆçº§ã€å’ŒåŠ è½½èµ„æºçš„contextClassLoaderä»¥åŠå¯ç»§æ‰¿çš„ThreadLocalç­‰å±æ€§ï¼ŒåŒæ—¶åˆ†é…å”¯ä¸€çš„IDæ¥è¡¨ç¤ºè¿™ä¸ªchildçº¿ç¨‹ã€‚å¦‚æœåˆ›å»ºçº¿ç¨‹å®ä¾‹åéœ€è¦ä¿®æ”¹çº¿ç¨‹å±æ€§ï¼Œåˆ™å¯ä»¥é€šè¿‡Threadæä¾›çš„ä¸€äº›ä¿®æ”¹å±æ€§çš„æ–¹æ³•è¿›è¡Œä¿®æ”¹ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">setPriority() // ä¼˜å…ˆçº§</span><br><span class="line">getPriority()</span><br><span class="line">setName()ã€‚// çº¿ç¨‹å</span><br><span class="line">getName()</span><br><span class="line">setDaemon() // å®ˆæŠ¤çº¿ç¨‹</span><br><span class="line">isDaemon()</span><br><span class="line">getContextClassLoader()ã€‚// èµ„æºåŠ è½½</span><br><span class="line">setContextClassLoader()</span><br><span class="line">getStackTrace() </span><br><span class="line">getAllStackTraces()</span><br><span class="line">checkAccess()</span><br><span class="line">isCCLOverridden()</span><br><span class="line">auditSubclass() </span><br><span class="line">dumpThreads()</span><br><span class="line">getThreads()</span><br><span class="line">getId()</span><br><span class="line">getState()</span><br><span class="line">setDefaultUncaughtExceptionHandler()</span><br><span class="line">getDefaultUncaughtExceptionHandler()</span><br><span class="line">getUncaughtExceptionHandler()</span><br><span class="line">setUncaughtExceptionHandler()</span><br><span class="line">dispatchUncaughtException()</span><br><span class="line">processQueue()</span><br></pre></td></tr></table></figure></p><p>å½“ç„¶æ„é€ çº¿ç¨‹æ—¶æœ‰äº›å±æ€§è¿˜å¯ä»¥åœ¨åˆ›å»ºçº¿ç¨‹å®ä¾‹æ—¶å°±è®¾ç½®ï¼Œå¦‚çº¿ç¨‹ç»„ï¼Œæ ˆå¤§å°ï¼Œæ ˆåç§°ï¼Œæƒé™æ§åˆ¶ä¸Šä¸‹æ–‡ï¼Œå¯ç»§æ‰¿çš„ThreadLocalï¼Œä¸‹é¢æ˜¯JDKåˆå§‹åŒ–ä¸€ä¸ªçº¿ç¨‹å®ä¾‹æ—¶çš„ä»£ç ï¼Œæ‘˜è‡³<a href="https://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html" target="_blank" rel="noopener">JDK8</a>ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> *</span><br><span class="line"> * @param g</span><br><span class="line"> * @param target</span><br><span class="line"> * @param name</span><br><span class="line"> * @param stackSize çº¿ç¨‹çš„æ ˆå¤§å° æ ¹æ®å‚æ•°ä¼ é€’è¿‡ç¨‹å¯ä»¥çœ‹å‡ºé»˜è®¤å¤§å°ä¸ºé›¶ï¼Œå³ä½¿ç”¨é»˜è®¤çš„çº¿ç¨‹æ ˆå¤§å°</span><br><span class="line"> * @param acc è®¿é—®æ§åˆ¶æƒé™</span><br><span class="line"> * @param inheritThreadLocals // å¯ç»§æ‰¿çš„ThreadLocal</span><br><span class="line"> *</span><br><span class="line"> * ThreadGroup çº¿ç¨‹ç»„ï¼ˆThreadGroupï¼‰å°±æ˜¯ç”±çº¿ç¨‹ç»„æˆçš„ç®¡ç†çº¿ç¨‹çš„ç±»ï¼Œ</span><br><span class="line"> *     è¿™ä¸ªç±»æ˜¯java.lang.ThreadGroupç±»ã€‚</span><br><span class="line"> *     å®šä¹‰ä¸€ä¸ªçº¿ç¨‹ç»„ï¼Œé€šè¿‡ä»¥ä¸‹ä»£ç å¯ä»¥å®ç°ã€‚</span><br><span class="line"> *     ThreadGroup group=new ThreadGroup(&quot;group&quot;);</span><br><span class="line"> *     Thread thread=new Thread(group,&quot;the first thread of group&quot;);</span><br><span class="line"> *     ThreadGroupç±»ä¸­çš„æŸäº›æ–¹æ³•ï¼Œå¯ä»¥å¯¹çº¿ç¨‹ç»„ä¸­çš„çº¿ç¨‹äº§ç”Ÿä½œç”¨ã€‚ä¾‹å¦‚ï¼ŒsetMaxPriority()æ–¹æ³•å¯ä»¥è®¾å®šçº¿ç¨‹ç»„ä¸­çš„æ‰€æœ‰çº¿ç¨‹æ‹¥æœ‰æœ€å¤§çš„ä¼˜å…ˆæƒã€‚</span><br><span class="line"> */</span><br><span class="line">private void init(ThreadGroup g, Runnable target, String name,</span><br><span class="line">                  long stackSize, AccessControlContext acc,</span><br><span class="line">                  boolean inheritThreadLocals) &#123;</span><br><span class="line">    if (name == null) &#123;// çº¿ç¨‹åï¼Œå¯ç›¸åŒ</span><br><span class="line">        throw new NullPointerException(&quot;name cannot be null&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    this.name = name;</span><br><span class="line"></span><br><span class="line">    Thread parent = currentThread();// è·å–å½“å‰çº¿ç¨‹ï¼Œå¹¶ä½œä¸ºçˆ¶çº¿ç¨‹ã€‚</span><br><span class="line">    SecurityManager security = System.getSecurityManager();// è·å–å®‰å…¨ç­–ç•¥</span><br><span class="line">    if (g == null) &#123;</span><br><span class="line">        /* Determine if it&apos;s an applet or not */</span><br><span class="line"></span><br><span class="line">        /* If there is a security manager, ask the security manager</span><br><span class="line">           what to do. */</span><br><span class="line">        if (security != null) &#123;//å¦‚æœå­˜åœ¨å®‰å…¨ç®¡ç†å™¨ï¼Œåˆ™è·å–å®ƒé‡å†™çš„çº¿ç¨‹ç»„</span><br><span class="line">            g = security.getThreadGroup();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        /* If the security doesn&apos;t have a strong opinion of the matter</span><br><span class="line">           use the parent thread group. */</span><br><span class="line">        if (g == null) &#123;</span><br><span class="line">            g = parent.getThreadGroup();//ä½¿ç”¨çˆ¶çº¿ç¨‹ç»„</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /* checkAccess regardless of whether or not threadgroup is</span><br><span class="line">       explicitly passed in. */</span><br><span class="line">    g.checkAccess();</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">     * Do we have the required permissions?</span><br><span class="line">     */</span><br><span class="line">    if (security != null) &#123;</span><br><span class="line">        if (isCCLOverridden(getClass())) &#123;</span><br><span class="line">            security.checkPermission(SUBCLASS_IMPLEMENTATION_PERMISSION);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    g.addUnstarted();</span><br><span class="line"></span><br><span class="line">    this.group = g;</span><br><span class="line">    this.daemon = parent.isDaemon();//ç»§æ‰¿çˆ¶çº¿ç¨‹çš„å®ˆæŠ¤å±æ€§</span><br><span class="line">    this.priority = parent.getPriority();//ç»§æ‰¿çˆ¶çº¿ç¨‹çš„ä¼˜å…ˆçº§</span><br><span class="line">    //ç»§æ‰¿çˆ¶çº¿ç¨‹åŠ è½½èµ„æºçš„contextClassLoader</span><br><span class="line">    if (security == null || isCCLOverridden(parent.getClass()))</span><br><span class="line">        this.contextClassLoader = parent.getContextClassLoader();</span><br><span class="line">    else</span><br><span class="line">        this.contextClassLoader = parent.contextClassLoader;</span><br><span class="line">    this.inheritedAccessControlContext =</span><br><span class="line">            acc != null ? acc : AccessController.getContext();</span><br><span class="line">    this.target = target;</span><br><span class="line">    setPriority(priority);</span><br><span class="line">    // ç»§æ‰¿çˆ¶çº¿ç¨‹å¯ç»§æ‰¿çš„ThreadLocal</span><br><span class="line">    if (inheritThreadLocals &amp;&amp; parent.inheritableThreadLocals != null)</span><br><span class="line">        this.inheritableThreadLocals =</span><br><span class="line">            ThreadLocal.createInheritedMap(parent.inheritableThreadLocals);</span><br><span class="line">    /* Stash the specified stack size in case the VM cares */</span><br><span class="line">    this.stackSize = stackSize;</span><br><span class="line"></span><br><span class="line">    /* Set thread ID */</span><br><span class="line">    tid = nextThreadID();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="1-3-å¯åŠ¨çº¿ç¨‹"><a href="#1-3-å¯åŠ¨çº¿ç¨‹" class="headerlink" title="1.3 å¯åŠ¨çº¿ç¨‹"></a>1.3 å¯åŠ¨çº¿ç¨‹</h4><p>çº¿ç¨‹å¯¹è±¡åœ¨åˆå§‹åŒ–å®Œæˆåï¼Œè°ƒç”¨startæ–¹æ³•å°±å¯ä»¥å¯åŠ¨çº¿ç¨‹ã€‚<br><strong><em>æ³¨æ„ï¼šå¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ï¼Œæœ€å¥½ä¸ºè¿™ä¸ªçº¿ç¨‹è®¾ç½®çº¿ç¨‹åç§°ï¼Œè¿™è¡Œæœ‰åŠ©äºåˆ†ææˆ–è€…æ’æŸ¥é—®é¢˜</em></strong></p><h3 id="2-ä¸­æ–­çº¿ç¨‹"><a href="#2-ä¸­æ–­çº¿ç¨‹" class="headerlink" title="2. ä¸­æ–­çº¿ç¨‹"></a>2. ä¸­æ–­çº¿ç¨‹</h3><h4 id="2-1-ä¸­æ–­çš„åŸç†"><a href="#2-1-ä¸­æ–­çš„åŸç†" class="headerlink" title="2.1 ä¸­æ–­çš„åŸç†"></a>2.1 ä¸­æ–­çš„åŸç†</h4><p>ä¸­æ–­ï¼Œå¯ä»¥ç†è§£ä¸ºè¿è¡Œä¸­çš„çº¿ç¨‹ï¼Œæ˜¯å¦è¢«å…¶ä»–çº¿ç¨‹è¿›è¡Œäº†ä¸­æ–­æ“ä½œã€‚ä¸­æ–­æ“ä½œåŒ…å«ä¸‰ä¸ªæ–¹æ³•ã€‚interrupt(),interrupted(),isInterrupted()ã€‚ä¸‹é¢æˆ‘ä»¬å°†å¯¹è¿™ä¸ªæ–¹æ³•è¿›è¡Œè¯¦ç»†äº†è§£ã€‚</p><h5 id="2-1-1-interrupt"><a href="#2-1-1-interrupt" class="headerlink" title="2.1.1 interrupt()"></a>2.1.1 interrupt()</h5><p>ä¸­æ–­æ“ä½œé€šè¿‡è°ƒç”¨çº¿ç¨‹çš„interrupt()æ–¹æ³•è¿›è¡Œã€‚ä¾‹å¦‚çº¿ç¨‹Aä¸­æ–­çº¿ç¨‹Bï¼Œåœ¨çº¿ç¨‹Açš„ä»£ç ä¸­è°ƒç”¨ThreadB.interrupt() å³å¯ã€‚</p><p>interrupt()æ–¹æ³•ä¸æ˜¯ç›´æ¥å°†çº¿ç¨‹ç»ˆæ­¢ï¼Œè€Œæ˜¯é’ˆå¯¹äºä¸åŒæƒ…å†µè¿›è¡Œä¸åŒå¤„ç†ã€‚</p><ol><li>é™¤éç»ˆæ­¢çš„æ˜¯å½“å‰çº¿ç¨‹ï¼ˆå§‹ç»ˆè¢«å…è®¸ï¼‰ï¼Œå¦åˆ™è°ƒç”¨checkAccessæ–¹æ³•ï¼Œå¯èƒ½ä¼šå¯¼è‡´æŠ›å‡ºSecurityExceptionå¼‚å¸¸ã€‚</li><li>å¦‚æœè°ƒç”¨Objectç±»çš„wait(),wait(long)æˆ–è€…wait(long, int)ç­‰æ–¹æ³•ï¼Œæˆ–è€…è°ƒç”¨æ­¤çº¿ç¨‹çš„join(),join(long),join(long, int), sleep(long), sleep(long, int)æ–¹æ³•ï¼Œ<strong><em>æ­¤çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€å°†è¢«æ¸…é™¤ï¼ŒåŒæ—¶å°†æŠ›å‡ºInterruptedExceptionå¼‚å¸¸</em></strong>ã€‚</li><li>å¦‚æœæ­¤çº¿ç¨‹åœ¨å¯ä¸­æ–­é€šé“çš„IOæ“ä½œä¸Šï¼Œé€šé“å°†è¢«å…³é—­ï¼Œçº¿ç¨‹è¢«è®¾ç½®ä¸­æ–­çŠ¶æ€ï¼ŒåŒæ—¶å°†æŠ›å‡ºClosedByInterruptExceptionå¼‚å¸¸ã€‚</li><li>å¦‚æœçº¿ç¨‹åœ¨é€‰æ‹©å™¨(Selector)é˜»å¡ï¼Œçº¿ç¨‹å°†è¢«è®¾ç½®ä¸­æ–­çŠ¶æ€ï¼Œç«‹å³ä»é€‰æ‹©æ“ä½œä¸­è¿”å›ï¼Œå¯èƒ½å¸¦æœ‰éé›¶å€¼ï¼Œå°±åƒé€‰æ‹©å™¨å”¤é†’æ–¹æ³•è¢«è°ƒç”¨ä¸€æ ·ã€‚</li><li>å¦‚æœä»¥ä¸Šçš„æ¡ä»¶éƒ½ä¸æ»¡è¶³ï¼Œæ­¤çº¿ç¨‹å°†è¢«è®¾ç½®ä¸­æ–­çŠ¶æ€ã€‚</li><li>ä¸­æ–­ä¸å­˜æ´»çš„çº¿ç¨‹ä¸ä¼šæœ‰ä»»ä½•å½±å“ã€‚</li></ol><p>ç¿»è¯‘è‡ª<a href="https://docs.oracle.com/javase/7/docs/api/" target="_blank" rel="noopener">Java se7docs</a></p><p>æ³¨ï¼šSelectorï¼ˆé€‰æ‹©å™¨ï¼‰æ˜¯Java NIOä¸­èƒ½å¤Ÿæ£€æµ‹ä¸€åˆ°å¤šä¸ªNIOé€šé“ï¼Œå¹¶èƒ½å¤ŸçŸ¥æ™“é€šé“æ˜¯å¦ä¸ºè¯¸å¦‚è¯»å†™äº‹ä»¶åšå¥½å‡†å¤‡çš„ç»„ä»¶ã€‚è¿™æ ·ï¼Œä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹å¯ä»¥ç®¡ç†å¤šä¸ªchannelï¼Œä»è€Œç®¡ç†å¤šä¸ªç½‘ç»œè¿æ¥ã€‚<br><strong><em>æ³¨æ„ï¼š</em></strong><br>å¯¹äºä¼šæŠ›å‡ºå¼‚å¸¸çš„æƒ…å†µï¼Œå¼‚å¸¸ä¸€å®šè¦å¤„ç†ï¼Œä¸€èˆ¬å­çº¿ç¨‹å¼‚å¸¸ä¸èƒ½æŠ›å‡ºéè¿è¡Œæ—¶å¼‚å¸¸ï¼Œæ‰€ä»¥å­çº¿ç¨‹æˆ‘ä»¬éœ€è¦æŠ›å‡ºè¿è¡Œæ—¶å¼‚å¸¸ï¼Œç”¨äºç»™çˆ¶çº¿ç¨‹æ•è·ã€‚æˆ–è€…åœ¨catchå—ä¸­ä½¿ç”¨ Thread.currentThread().interrupt() é‡æ–°æŠ›å‡ºä¸­æ–­æ¥ä¿è¯è°ƒç”¨æ ˆçš„é«˜å±‚çš„ä»£ç çŸ¥é“å½“å‰çº¿ç¨‹çš„ä¸­æ–­ã€‚</p><h5 id="2-1-2-interrupted"><a href="#2-1-2-interrupted" class="headerlink" title="2.1.2 interrupted()"></a>2.1.2 interrupted()</h5><p>interrupted()ä¸»è¦æœ‰ä»¥ä¸‹ä¸¤ä¸ªåŠŸèƒ½ï¼š</p><ol><li>æµ‹è¯•<strong><em>å½“å‰çº¿ç¨‹</em></strong>æ˜¯å¦è¢«ä¸­æ–­,æ¸…é™¤çº¿ç¨‹ä¸­æ–­çŠ¶æ€ã€‚æ¢å¥è¯è¯´å°±æ˜¯ï¼Œå¦‚æœå½“å‰æ–¹æ³•è¢«æˆåŠŸè°ƒç”¨ä¸¤æ¬¡ï¼Œåˆ™è¿”å›falseï¼ˆé™¤éå½“å‰çº¿ç¨‹åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨æ­¤æ–¹æ³•åç¬¬äºŒæ¬¡è°ƒç”¨æ­¤æ–¹æ³•å‰è¢«å†æ¬¡ä¸­æ–­ï¼‰ã€‚</li><li>çº¿ç¨‹ä¸­æ–­è¢«å¿½ç•¥ï¼Œåœ¨ä¸­æ–­æ—¶çº¿ç¨‹å¤„äºä¸æ´»åŠ¨çš„çŠ¶æ€å°†è¢«æ­¤æ–¹æ³•åæ˜ è¿”å›falseã€‚</li></ol><p>interrupted()ä¸åŒäºinterrupt(),æ­¤æ–¹æ³•ç”¨äºæµ‹è¯•å½“å‰çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­ï¼Œå¹¶æ¸…é™¤ä¸­æ–­çŠ¶æ€ã€‚ä»£ç ç¤ºä¾‹å¦‚ä¸‹ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args) &#123;</span><br><span class="line">    Thread thread = new InterruptThread();</span><br><span class="line">    thread.start();</span><br><span class="line">    SleepUtils.sleep(1);</span><br><span class="line">    thread.interrupt();</span><br><span class="line">&#125;</span><br><span class="line">static class InterruptThread extends Thread&#123;</span><br><span class="line">   @Override</span><br><span class="line">   public void run() &#123;</span><br><span class="line">       int count = 0;</span><br><span class="line">       while(true)&#123;</span><br><span class="line">           count++;</span><br><span class="line">           if(Thread.currentThread().interrupted())&#123;//æ­¤å¤„ä»…ä»…æ˜¯ä¸ºäº†ç¤ºä¾‹</span><br><span class="line">               break;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h5 id="2-1-3-isInterrupted"><a href="#2-1-3-isInterrupted" class="headerlink" title="2.1.3 isInterrupted()"></a>2.1.3 isInterrupted()</h5><ol><li>isInterruptedè™½ç„¶ä¹Ÿæ˜¯æµ‹è¯•çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­ï¼Œä½†æ˜¯æ­¤æ–¹æ³•ä¸ä¼šæ›´æ”¹çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€ã€‚</li><li>çº¿ç¨‹ä¸­æ–­è¢«å¿½ç•¥ï¼Œåœ¨ä¸­æ–­æ—¶çº¿ç¨‹å¤„äºä¸æ´»åŠ¨çš„çŠ¶æ€å°†è¢«æ­¤æ–¹æ³•åæ˜ è¿”å›falseã€‚</li></ol><h3 id="3-ç»ˆæ­¢çº¿ç¨‹"><a href="#3-ç»ˆæ­¢çº¿ç¨‹" class="headerlink" title="3. ç»ˆæ­¢çº¿ç¨‹"></a>3. ç»ˆæ­¢çº¿ç¨‹</h3><h4 id="3-1-è¿‡æœŸçš„suspend-ã€resume-å’Œstop"><a href="#3-1-è¿‡æœŸçš„suspend-ã€resume-å’Œstop" class="headerlink" title="3.1 è¿‡æœŸçš„suspend()ã€resume()å’Œstop()"></a>3.1 è¿‡æœŸçš„suspend()ã€resume()å’Œstop()</h4><p>åœ¨Java APIä¸­ï¼Œsuspend()ã€resume()å’Œstop()ä¸‰ä¸ªæ–¹æ³•æ˜¯è¿‡æœŸçš„ï¼Œä¸å»ºè®®ä½¿ç”¨çš„ã€‚<br>ä¸»è¦åŸå› æ˜¯ï¼šsuspend()åœ¨è°ƒç”¨åï¼Œçº¿ç¨‹ä¸æ˜¯æ”¾å·²ç»å æœ‰çš„èµ„æºæ¯”å¦‚è¯´é”ï¼Œè€Œæ˜¯å æœ‰ç€èµ„æºè¿›å…¥ç¡çœ ï¼Œè¿™æ ·å®¹æ˜“å¼•å‘æ­»é”çŠ¶æ€ã€‚stop()æ–¹æ³•åœ¨ç»ˆç»“ä¸€ä¸ªçº¿ç¨‹æ—¶ä¸ä¼šä¿è¯çº¿ç¨‹èµ„æºçš„é‡Šæ”¾ï¼Œå› æ­¤å¯¼è‡´çº¿ç¨‹å¤„äºä¸ç¡®å®šçš„çŠ¶æ€ä¸‹ã€‚</p><p><strong><em>sleepå’ŒsuspendåŒºåˆ«ï¼š</em></strong><br>ç›¸åŒç‚¹ï¼šsleepå’Œsuspendéƒ½ä¼šæŒæœ‰å æœ‰çš„èµ„æºä¸é‡Šæ”¾ã€‚<br>ä¸åŒç‚¹ï¼šsleepé˜»å¡ï¼ˆTIMED_WAITINGï¼‰åï¼Œç»è¿‡ä¸€æ®µæ—¶é—´è‡ªè¡Œæ¢å¤è¿è¡Œã€‚è€Œsuspendå¿…é¡»ä½¿ç”¨resume()æ˜¾ç¤ºçš„æ¢å¤ï¼Œå¦‚æœä¸ä½¿ç”¨resume()æˆ–è€…resume()å¤±è´¥ï¼Œå¾ˆå®¹æ˜“å¼•èµ·èµ„æºå ç”¨å¯¼è‡´çš„æ­»é”ã€‚</p><h4 id="3-2-å®‰å…¨çš„ç»ˆæ­¢çº¿ç¨‹"><a href="#3-2-å®‰å…¨çš„ç»ˆæ­¢çº¿ç¨‹" class="headerlink" title="3.2 å®‰å…¨çš„ç»ˆæ­¢çº¿ç¨‹"></a>3.2 å®‰å…¨çš„ç»ˆæ­¢çº¿ç¨‹</h4><p>åœ¨ç¬¬2å°èŠ‚æåˆ°çš„ä¸­æ–­æ˜¯çº¿ç¨‹çš„ä¸€ä¸ªæ ‡ç¤ºä½ï¼Œä¸­æ–­æ“ä½œæ˜¯ä¸€ç§ç®€ä¾¿çš„çº¿ç¨‹é—´äº¤äº’æ–¹å¼ï¼Œè¿™ç§äº¤äº’æ–¹å¼é€‚åˆç”¨æ¥å–æ¶ˆå’Œåœæ­¢ä»»åŠ¡ã€‚é™¤äº†ä¸­æ–­ï¼Œè¿˜å¯ä»¥ä½¿ç”¨åŒæ­¥å˜é‡æ¥æ§åˆ¶æ˜¯å¦åœæ­¢å¹¶ç»ˆæ­¢è¯¥çº¿ç¨‹ã€‚<br><strong><em>çº¿ç¨‹çš„ç»ˆæ­¢ä¸æ˜¯ç›´æ¥å¼ºåˆ¶çº¿ç¨‹åœæ­¢ï¼Œè€Œæ˜¯å¼•å¯¼çº¿ç¨‹è¿è¡Œç»“æŸã€‚</em></strong></p><h3 id="å¼•ç”¨"><a href="#å¼•ç”¨" class="headerlink" title="å¼•ç”¨"></a>å¼•ç”¨</h3><p><a href="https://www.ibm.com/developerworks/cn/java/j-lo-javasecurity/" target="_blank" rel="noopener">Java å®‰å…¨æ¨¡å‹ä»‹ç»</a><br><a href="https://docs.oracle.com/javase/7/docs/api/" target="_blank" rel="noopener">Class Thread</a><br><a href="https://my.oschina.net/u/2500836/blog/1538667" target="_blank" rel="noopener">Javaçº¿ç¨‹(1)-Threadç±»æºç </a><br><a href="https://book.douban.com/subject/26591326/" target="_blank" rel="noopener">Javaå¹¶å‘ç¼–ç¨‹è‰ºæœ¯</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;1-æ„é€ çº¿ç¨‹&quot;&gt;&lt;a href=&quot;#1-æ„é€ çº¿ç¨‹&quot; class=&quot;headerlink&quot; title=&quot;1. æ„é€ çº¿ç¨‹&quot;&gt;&lt;/a&gt;1. æ„é€ çº¿ç¨‹&lt;/h3&gt;&lt;h4 id=&quot;1-1-æ„é€ çº¿ç¨‹çš„æ–¹å¼&quot;&gt;&lt;a href=&quot;#1-1-æ„é€ çº¿ç¨‹çš„æ–¹å¼&quot; class=&quot;head
      
    
    </summary>
    
    
      <category term="å¹¶å‘" scheme="https://zhongyp.me/tags/%E5%B9%B6%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>Java Classæ–‡ä»¶ç»“æ„</title>
    <link href="https://zhongyp.me/jvm/2018-11-22-class-structure/"/>
    <id>https://zhongyp.me/jvm/2018-11-22-class-structure/</id>
    <published>2018-11-21T16:00:00.000Z</published>
    <updated>2019-08-11T11:00:47.748Z</updated>
    
    <content type="html"><![CDATA[<h2 id="classç»“æ„"><a href="#classç»“æ„" class="headerlink" title="classç»“æ„"></a>classç»“æ„</h2><blockquote><p>ç¿»è¯‘è‡ª<a href="https://docs.oracle.com/javase/specs/jvms/se7/html/jvms-4.html" target="_blank" rel="noopener">Chapter 4.The class File Format</a></p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ClassFile &#123;</span><br><span class="line">    u4             magic;</span><br><span class="line">    u2             minor_version;</span><br><span class="line">    u2             major_version;</span><br><span class="line">    u2             constant_pool_count;</span><br><span class="line">    cp_info        constant_pool[constant_pool_count-1];</span><br><span class="line">    u2             access_flags;</span><br><span class="line">    u2             this_class;</span><br><span class="line">    u2             super_class;</span><br><span class="line">    u2             interfaces_count;</span><br><span class="line">    u2             interfaces[interfaces_count];</span><br><span class="line">    u2             fields_count;</span><br><span class="line">    field_info     fields[fields_count];</span><br><span class="line">    u2             methods_count;</span><br><span class="line">    method_info    methods[methods_count];</span><br><span class="line">    u2             attributes_count;</span><br><span class="line">    attribute_info attributes[attributes_count];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="magic"><a href="#magic" class="headerlink" title="magic"></a>magic</h3><p>ç”¨æ¥è¯†åˆ«classæ–‡ä»¶ï¼Œå›ºå®šå€¼ï¼š0xCAFEBABEã€‚å…³äº0xCAFEBABEè¿˜æœ‰ä¸€ä¸ªæ•…äº‹<a href="https://leokongwq.github.io/2016/12/31/java-magic-0xCAFEBABE.html" target="_blank" rel="noopener">javaé­”æ³•ä¹‹0xCAFEBABE</a></p><h3 id="minor-version-major-version"><a href="#minor-version-major-version" class="headerlink" title="minor_version, major_version"></a>minor_version, major_version</h3><p>minor_versionå’Œmajor_versioné¡¹çš„å€¼æ˜¯æ­¤ç±»æ–‡ä»¶çš„æ¬¡è¦ç‰ˆæœ¬å·å’Œä¸»è¦ç‰ˆæœ¬å·ã€‚ä¸»è¦ç‰ˆæœ¬å·å’Œæ¬¡è¦ç‰ˆæœ¬å·ä¸€èµ·ç¡®å®šç±»æ–‡ä»¶æ ¼å¼çš„ç‰ˆæœ¬ã€‚å¦‚æœç±»æ–‡ä»¶å…·æœ‰ä¸»ç‰ˆæœ¬å·Må’Œæ¬¡ç‰ˆæœ¬å·mï¼Œåˆ™æˆ‘ä»¬å°†å…¶ç±»æ–‡ä»¶æ ¼å¼çš„ç‰ˆæœ¬è¡¨ç¤ºä¸ºM.m.å› æ­¤ï¼Œç±»æ–‡ä»¶æ ¼å¼ç‰ˆæœ¬å¯ä»¥æŒ‰å­—å…¸é¡ºåºæ’åºï¼Œä¾‹å¦‚ï¼Œ1.5 &lt;2.0 &lt;2.1ã€‚</p><p>å½“ä¸”ä»…å½“vä½äºæŸä¸ªè¿ç»­èŒƒå›´Mi.0â‰¤vâ‰¤Mj.mæ—¶ï¼ŒJavaè™šæ‹Ÿæœºå®ç°å¯ä»¥æ”¯æŒç‰ˆæœ¬vçš„ç±»æ–‡ä»¶æ ¼å¼ã€‚ Java SEå¹³å°çš„å‘è¡Œç‰ˆçº§è´Ÿè´£ç¡®å®šJavaè™šæ‹Ÿæœºå®ç°ç¬¦åˆçš„èŒƒå›´ã€‚</p><p>JDK 1.0.2ç‰ˆä¸­çš„Oracle Javaè™šæ‹Ÿæœºå®ç°æ”¯æŒåŒ…å«45.0åˆ°45.3ç±»çš„ç±»æ–‡ä»¶æ ¼å¼ã€‚ JDKå‘å¸ƒçš„1.1.*æ”¯æŒç±»æ–‡ä»¶æ ¼å¼ç‰ˆæœ¬èŒƒå›´ä¸º45.0åˆ°45.65535ï¼ˆå«ï¼‰ã€‚å¯¹äºkâ‰¥2ï¼ŒJDKç‰ˆæœ¬1.kæ”¯æŒ45.0åˆ°44 + k.0èŒƒå›´å†…çš„ç±»æ–‡ä»¶æ ¼å¼ç‰ˆæœ¬ã€‚</p><h3 id="constant-pool-count"><a href="#constant-pool-count" class="headerlink" title="constant_pool_count"></a>constant_pool_count</h3><p>constant_pool_counté¡¹çš„å€¼ç­‰äºconstant_poolè¡¨ä¸­çš„æ¡ç›®æ•°åŠ 1ã€‚å¦‚æœconstant_poolç´¢å¼•å¤§äºé›¶ä¸”å°äºconstant_pool_countï¼Œåˆ™è®¤ä¸ºå®ƒæ˜¯æœ‰æ•ˆçš„ï¼ŒÂ§4.4.5ä¸­æ³¨æ˜äº†longå’Œdoubleç±»å‹çš„å¸¸é‡ã€‚</p><h3 id="constant-pool"><a href="#constant-pool" class="headerlink" title="constant_pool[]"></a>constant_pool[]</h3><p>constant_poolæ˜¯ä¸€ä¸ªå­˜å‚¨å„ç§å­—ç¬¦ä¸²å¸¸é‡ã€ç±»å’Œæ¥å£åç§°ã€å­—æ®µåç§°ä»¥åŠåœ¨Classæ–‡ä»¶ç»“æ„å’Œå­ç»“æ„ä¸­å¼•ç”¨çš„å…¶ä»–å¸¸é‡çš„ç»“æ„è¡¨ã€‚æ¯ä¸ªconstant_poolè¡¨çš„æ¡ç›®çš„æ ¼å¼ç”±å®ƒçš„ç¬¬ä¸€ä¸ªâ€˜tagâ€™å­—èŠ‚æŒ‡å‡ºã€‚<br>constant_poolè¡¨çš„ç´¢å¼•ä»1åˆ°constant_pool_count-1ã€‚</p><h3 id="access-flags"><a href="#access-flags" class="headerlink" title="access_flags"></a>access_flags</h3><p>access_flagsé¡¹çš„å€¼æ˜¯ç”¨æ¥è¡¨ç¤ºè®¿é—®æƒé™å’Œç±»æˆ–è€…æ¥å£çš„å±æ€§çš„æ ‡å¿—çš„æ©ç ã€‚è®¾ç½®æ—¶ï¼Œæ¯ä¸ªæ ‡å¿—çš„è§£é‡Šå¦‚è¡¨4.1æ‰€ç¤ºã€‚</p><p>Table 4.1. ç±»è®¿é—®å’Œå±æ€§ä¿®é¥°ç¬¦</p><p>Flag Name    Value    Interpretation</p><p>ACC_PUBLIC    0x0001    Declared public; å¯ä»¥è¢«å¤–éƒ¨åŒ…è®¿é—®ã€‚<br>ACC_FINAL    0x0010    Declared final; ä¸å…è®¸æœ‰å­ç±»ã€‚<br>ACC_SUPER    0x0020    åœ¨invokespecialæŒ‡ä»¤è°ƒç”¨æ—¶ç‰¹åˆ«å¤„ç†è¶…ç±»æ–¹æ³•ã€‚<br>ACC_INTERFACE    0x0200    æ ‡è¯†æ¥å£ç±»ã€‚<br>ACC_ABSTRACT    0x0400    Declared abstract; ä¸èƒ½è¢«å®ä¾‹åŒ–ã€‚<br>ACC_SYNTHETIC    0x1000    Declared synthetic; ä¸å†æºä»£ç ä¸­ä½“ç°ã€‚<br>ACC_ANNOTATION    0x2000    Declared as an annotation type.<br>ACC_ENUM    0x4000    Declared as an enum type.</p><p>å¯ä»¥ç”¨ACC_SYNTHETICæ ‡å¿—æ ‡è®°ç±»ï¼Œä»¥æŒ‡ç¤ºå®ƒæ˜¯ç”±ç¼–è¯‘å™¨ç”Ÿæˆçš„ï¼Œå¹¶ä¸”ä¸å‡ºç°åœ¨æºä»£ç ä¸­ã€‚</p><p>ACC_ENUM æ ‡å¿—æŒ‡ç¤ºè¿™ä¸ªç±»æˆ–è€…å®ƒçš„çˆ¶ç±»æ˜¯è¢«å®šä¹‰ä¸ºæšä¸¾ç±»å‹ã€‚</p><p>ä¸€ä¸ªæ¥å£çš„ç‰¹å¾æ˜¯è¢«è®¾ç½®ACC_INTERFACEæ ‡å¿—ã€‚å¦‚æœæ²¡æœ‰è®¾ç½®ACC_INTERFACEæ ‡å¿—ï¼Œè¿™ä¸ªç±»æ–‡ä»¶å®šä¹‰çš„æ˜¯ä¸€ä¸ªç±»è€Œä¸æ˜¯ä¸€ä¸ªæ¥å£ã€‚</p><p>å¦‚æœè¿™ä¸ªç±»è®¾ç½®äº†ACC_INTERFACEæ ‡å¿—ï¼Œå®ƒçš„ACC_ABSTRACTä¹Ÿä¸€å®šè¢«è®¾ç½®äº†(JLS Â§9.1.1.1)ã€‚è¿™æ ·çš„ç±»æ–‡ä»¶ä¸èƒ½è®¾ç½®å…¶ACC_FINALï¼ŒACC_SUPERæˆ–ACC_ENUMæ ‡å¿—ã€‚</p><p>æ³¨è§£ç±»å‹å¿…é¡»è®¾ç½®ACC_ANNOTATIONæ ‡å¿—ã€‚å¦‚æœè®¾ç½®äº†ACC_ANNOTATIONæ ‡å¿—ï¼Œåˆ™ä¹Ÿå¿…é¡»è®¾ç½®ACC_INTERFACEæ ‡å¿—ã€‚å¦‚æœè¿™ä¸ªç±»æ–‡ä»¶æ²¡æœ‰è®¾ç½®ACC_INTERFACEæ ‡å¿—ï¼Œå®ƒå¯ä»¥è®¾ç½®Table 4.1ä¸­é™¤ACC_ANNOTATIONä¹‹å¤–çš„ä»»ä½•å…¶ä»–æ ‡å¿—ã€‚ä½†æ˜¯ï¼Œè¿™ä¸ªç±»ä¸èƒ½åŒæ—¶è®¾ç½®ACC_FINALå’ŒACC_ABSTRACTæ ‡å¿—(JLS Â§8.1.1.2)ã€‚</p><p>ACC_SUPERæ ‡å¿—æŒ‡ç¤ºå¦‚æœå®ƒå‡ºç°åœ¨æ­¤ç±»ä¸­ï¼Œåˆ™ç”±invokespecialæŒ‡ä»¤ï¼ˆÂ§invokespecialï¼‰è¡¨ç¤ºä¸¤ä¸ªå¤‡ç”¨è¯­ä¹‰ä¸­çš„å“ªä¸€ä¸ªã€‚ Javaè™šæ‹ŸæœºæŒ‡ä»¤é›†çš„ç¼–è¯‘å™¨åº”è®¾ç½®ACC_SUPERæ ‡å¿—ã€‚</p><p>ACC_SUPERæ ‡å¿—çš„å­˜åœ¨æ˜¯ä¸ºäº†ä¸æ—§ç¼–è¯‘å™¨ä¸ºJavaç¼–ç¨‹è¯­è¨€ç¼–è¯‘çš„ä»£ç å‘åå…¼å®¹ã€‚åœ¨ç‰ˆæœ¬1.0.2ä¹‹å‰çš„Oracle JDKä¸­ï¼Œç¼–è¯‘å™¨ç”Ÿæˆäº†ClassFile access_flagsï¼Œå…¶ä¸­ç°åœ¨è¡¨ç¤ºACC_SUPERçš„æ ‡å¿—æ²¡æœ‰æŒ‡å®šå«ä¹‰ï¼Œå¹¶ä¸”Oracleçš„Javaè™šæ‹Ÿæœºå®ç°å¿½ç•¥äº†è¯¥æ ‡å¿—ï¼ˆå¦‚æœå·²è®¾ç½®ï¼‰ã€‚</p><p>è¡¨4.1ä¸­æœªåˆ†é…çš„access_flagsé¡¹çš„æ‰€æœ‰ä½éƒ½ä¿ç•™ä¾›å°†æ¥ä½¿ç”¨ã€‚å®ƒä»¬åº”è¯¥åœ¨ç”Ÿæˆçš„ç±»æ–‡ä»¶ä¸­è®¾ç½®ä¸ºé›¶ï¼Œå¹¶ä¸”åº”è¯¥è¢«Javaè™šæ‹Ÿæœºçš„å®ç°å¿½ç•¥ã€‚</p><h3 id="this-class"><a href="#this-class" class="headerlink" title="this_class"></a>this_class</h3><p>this_classé¡¹çš„å€¼å¿…é¡»æ˜¯ä¸€ä¸ªåœ¨constant_poolè¡¨ä¸­çš„æœ‰æ•ˆç´¢å¼•ã€‚constant_poolç´¢å¼•indexå¤„çš„æ¡ç›®å¿…é¡»æ˜¯ä¸€ä¸ªåœ¨æ­¤ç±»æ–‡ä»¶ä¸­å®šä¹‰çš„ç±»æˆ–è€…æ¥å£çš„CONSTANT_Class_infoç»“æ„ã€‚</p><h3 id="super-class"><a href="#super-class" class="headerlink" title="super_class"></a>super_class</h3><p>å¯¹äºä¸€ä¸ªç±»ï¼Œçˆ¶ç±»é¡¹çš„å€¼è¦ä¹ˆæ˜¯0ï¼Œè¦ä¹ˆæ˜¯ä¸€ä¸ªåœ¨å¸¸é‡æ± è¡¨ä¸­çš„æœ‰æ•ˆç´¢å¼•ã€‚å¦‚æœçˆ¶ç±»é¡¹çš„å€¼é0ï¼Œåˆ™åœ¨å¸¸é‡æ± è¡¨ç´¢å¼•indexä½ç½®ä¸Šçš„æ¡ç›®ä¸€å®šæ˜¯CONSTANT_Class_infoç»“æ„(Â§4.4.1)ï¼ŒæŒ‡ç¤ºclassæ–‡ä»¶ä¸­å®šä¹‰çš„ç±»çš„ç›´æ¥çˆ¶ç±»ã€‚ç›´æ¥çˆ¶ç±»æˆ–è€…ä»»ä½•å…¶ä»–çˆ¶ç±»éƒ½ä¸ä¼šåœ¨å®ƒçš„Classæ–‡ä»¶ç»“æ„çš„access_flagsé¡¹ä¸Šè®¾ç½®ACC_FINALæ ‡å¿—ã€‚</p><p>å¦‚æœçˆ¶ç±»é¡¹çš„å€¼æ˜¯0ï¼Œåˆ™è¿™ä¸ªç±»æ–‡ä»¶å¿…é¡»æ˜¯Objectç±»ï¼Œå”¯ä¸€ä¸ªæ²¡æœ‰ç›´æ¥çˆ¶ç±»çš„ç±»æˆ–è€…æ¥å£ã€‚</p><p>å¯¹äºä¸€ä¸ªæ¥å£ï¼Œçˆ¶ç±»é¡¹çš„å€¼å¿…é¡»æ€»æ˜¯ä¸€ä¸ªåœ¨å¸¸é‡æ± è¡¨ä¸­çš„æœ‰æ•ˆç´¢å¼•ã€‚åœ¨æ­¤ç´¢å¼•ä¸Šçš„å¸¸é‡æ± æ¡ç›®å¿…é¡»æ˜¯ä¸€ä¸ªCONSTANT_Class_infoç»“æ„æŒ‡ç¤ºObjectç±»ã€‚</p><h3 id="interfaces-count"><a href="#interfaces-count" class="headerlink" title="interfaces_count"></a>interfaces_count</h3><p>interfaces_counté¡¹çš„å€¼æ˜¯è¿™ä¸ªç±»æˆ–è€…æ¥å£ç±»å‹çš„ç›´æ¥çˆ¶æ¥å£çš„æ•°é‡ã€‚</p><h3 id="interfaces"><a href="#interfaces" class="headerlink" title="interfaces[]"></a>interfaces[]</h3><p>æ¥å£æ•°ç»„ä¸­çš„æ¯ä¸ªå€¼éƒ½å¿…é¡»æ˜¯ä¸€ä¸ªåœ¨å¸¸é‡æ± è¡¨ä¸­çš„æœ‰æ•ˆç´¢å¼•ã€‚åœ¨å¸¸é‡æ± è¡¨ä¸­ç´¢å¼•æ˜¯interfaces[i]ï¼ˆ0&lt;=i&lt;interfaces_countï¼‰çš„å€¼ä¸Šçš„æ¯ä¸ªæ¡ç›®å¿…é¡»æ˜¯è¡¨ç¤ºä¸€ä¸ªæ¥å£çš„CONSTANT_Class_info ç»“æ„ (Â§4.4.1)ï¼Œè¿™ä¸ªæ¥å£æ˜¯è¿™ä¸ªç±»æˆ–è€…è¿™ä¸ªæ¥å£ç±»å‹çš„çˆ¶æ¥å£ï¼Œåœ¨ç±»å‹çš„æ¥æºä¸­ç»™å‡ºçš„ä»å·¦åˆ°å³çš„é¡ºåºã€‚</p><h3 id="fields-count"><a href="#fields-count" class="headerlink" title="fields_count"></a>fields_count</h3><p>fields_counté¡¹çš„å€¼æ˜¯å­—æ®µè¡¨ä¸­field_infoç»“æ„çš„æ•°é‡ã€‚field_infoç»“æ„æŒ‡ç¤ºæ‰€æœ‰å­—æ®µï¼ŒåŒ…æ‹¬åœ¨è¿™ä¸ªç±»æˆ–è€…æ¥å£ç±»å‹ä¸­çš„ç±»å˜é‡å’Œå®ä¾‹å˜é‡ã€‚</p><h3 id="fields"><a href="#fields" class="headerlink" title="fields[]"></a>fields[]</h3><p>å­—æ®µè¡¨ä¸­çš„æ¯ä¸ªå€¼éƒ½å¿…é¡»æ˜¯ä¸€ä¸ªç»™å‡ºåœ¨è¿™ä¸ªç±»æˆ–è€…æ¥å£ä¸­çš„å­—æ®µçš„å®Œæ•´æè¿°çš„field_info(Â§4.5)ç»“æ„ã€‚å­—æ®µè¡¨ä»…ä»…åŒ…å«åœ¨è¿™ä¸ªç±»æˆ–è€…æ¥å£ä¸­å®šä¹‰çš„é‚£äº›å­—æ®µã€‚ä¸åŒ…å«ä»çˆ¶ç±»æˆ–è€…çˆ¶æ¥å£ä¸­ç»§æ‰¿çš„å­—æ®µã€‚</p><h3 id="methods-count"><a href="#methods-count" class="headerlink" title="methods_count"></a>methods_count</h3><p>methods_countçš„å€¼ç»™å‡ºäº†æ–¹æ³•è¡¨ä¸­çš„methods_infoç»“æ„çš„æ•°é‡ã€‚</p><h3 id="methods"><a href="#methods" class="headerlink" title="methods[]"></a>methods[]</h3><p>æ–¹æ³•è¡¨ä¸­çš„æ¯ä¸ªå€¼éƒ½å¿…é¡»æ˜¯ä¸€ä¸ªç»™å‡ºä¸€ä¸ªåœ¨è¿™ä¸ªç±»æˆ–è€…æ¥å£ä¸­æ–¹æ³•çš„å®Œæ•´æè¿°çš„method_infoç»“æ„ã€‚å¦‚æœä¸€ä¸ªmethod_infoç»“æ„çš„access_flagsé¡¹æœªè®¾ç½®ACC_NATIVEå’ŒACC_ABSTRACTæ ‡å¿—ï¼ŒJavaè™šæ‹Ÿæœºä¹Ÿæä¾›äº†å®ç°è¿™ä¸ªæ–¹æ³•çš„æŒ‡ä»¤ã€‚</p><p>method_infoç»“æ„æŒ‡ç¤ºäº†æ‰€æœ‰åœ¨è¿™ä¸ªç±»æˆ–è€…æ¥å£ç±»å‹ä¸­å®šä¹‰çš„æ–¹æ³•ï¼ŒåŒ…æ‹¬å®ä¾‹æ–¹æ³•ï¼Œç±»æ–¹æ³•ï¼Œå®åŠ›åˆå§‹åŒ–æ–¹æ³•ä»¥åŠä»»ä½•ç±»æˆ–è€…æ¥å£åˆå§‹åŒ–æ–¹æ³•(Â§2.9)ã€‚æ–¹æ³•è¡¨ä¸åŒ…å«ç»§æ‰¿è‡ªçˆ¶ç±»æˆ–è€…çˆ¶æ¥å£çš„æ–¹æ³•ã€‚</p><h3 id="attributes-count"><a href="#attributes-count" class="headerlink" title="attributes_count"></a>attributes_count</h3><p>attributes_counté¡¹çš„å€¼ç»™å‡ºäº†åœ¨è¿™ä¸ªç±»çš„å±æ€§è¡¨ä¸­çš„å±æ€§æ•°é‡ã€‚</p><h3 id="attributes"><a href="#attributes" class="headerlink" title="attributes[]"></a>attributes[]</h3><p>å±æ€§è¡¨çš„æ¯ä¸ªå€¼éƒ½å¿…é¡»æ˜¯ä¸€ä¸ªattribute_info(Â§4.7)ç»“æ„ã€‚</p><p>æœ¬è§„èŒƒå®šä¹‰çš„å±æ€§å‡ºç°åœ¨ClassFileç»“æ„çš„å±æ€§è¡¨ä¸­çš„æ˜¯InnerClassesï¼ˆÂ§4.7.6ï¼‰ï¼ŒEnclosingMethodï¼ˆÂ§4.7.7ï¼‰ï¼ŒSyntheticï¼ˆÂ§4.7.8ï¼‰ï¼ŒSignatureï¼ˆÂ§4.7.9ï¼‰ï¼Œ SourceFileï¼ˆÂ§4.7.10ï¼‰ï¼ŒSourceDebugExtensionï¼ˆÂ§4.7.11ï¼‰ï¼Œä¸æ¨èä½¿ç”¨ï¼ˆÂ§4.7.15ï¼‰ï¼ŒRuntimeVisibleAnnotationsï¼ˆÂ§4.7.16ï¼‰ï¼ŒRuntimeInvisibleAnnotationsï¼ˆÂ§4.7.17ï¼‰å’ŒBootstrapMethodsï¼ˆÂ§4.7.21ï¼‰å±æ€§ã€‚</p><p>å¦‚æœä¸€ä¸ªJavaè™šæ‹Ÿæœºçš„å®ç°å®ç°è¯†åˆ«å‡ºclassæ–‡ä»¶çš„ç‰ˆæœ¬åœ¨49.0ç‰ˆæœ¬ä»¥ä¸Šï¼Œå®ƒå¿…é¡»è¯†åˆ«å’Œæ­£ç¡®çš„è¯»å–åœ¨49.0æˆ–è€…æ›´é«˜ç‰ˆæœ¬classæ–‡ä»¶çš„æ–‡ä»¶ç»“æ„çš„å±æ€§è¡¨ä¸­æ‰¾åˆ°çš„ç­¾å(Â§4.7.9)ï¼ŒRuntimeVisibleAnnotations (Â§4.7.16)å’Œ RuntimeInvisibleAnnotations (Â§4.7.17) å±æ€§ã€‚</p><p>å¦‚æœJavaè™šæ‹Ÿæœºå®ç°è¯†åˆ«å‡º51.0æˆ–æ›´é«˜ç‰ˆæœ¬çš„classæ–‡ä»¶ï¼Œå®ƒå¿…é¡»è¯†åˆ«å’Œæ­£ç¡®çš„è¯»å–åœ¨51.0æˆ–æ›´é«˜ç‰ˆæœ¬çš„classæ–‡ä»¶çš„æ–‡ä»¶ç»“æ„çš„å±æ€§è¡¨ä¸­æ‰¾åˆ°çš„BootstrapMethods (Â§4.7.21) å±æ€§ã€‚</p><p>ä¸€ä¸ªJavaè™šæ‹Ÿæœºçš„å®ç°éœ€è¦é™é»˜å¿½ç•¥å®ƒæ— æ³•è¯†åˆ«çš„ClassFileç»“æ„çš„å±æ€§è¡¨ä¸­çš„ä»»ä½•æˆ–æ‰€æœ‰å±æ€§ã€‚ä¸å…è®¸åœ¨æœ¬è§„èŒƒä¸­å®šä¹‰çš„å±æ€§å½±å“ç±»æ–‡ä»¶çš„è¯­ä¹‰ï¼Œä½†ä»…å…è®¸æä¾›å…¶ä»–æè¿°æ€§ä¿¡æ¯ï¼ˆç¬¬4.7.1èŠ‚ï¼‰ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;classç»“æ„&quot;&gt;&lt;a href=&quot;#classç»“æ„&quot; class=&quot;headerlink&quot; title=&quot;classç»“æ„&quot;&gt;&lt;/a&gt;classç»“æ„&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;ç¿»è¯‘è‡ª&lt;a href=&quot;https://docs.oracle.com/j
      
    
    </summary>
    
    
      <category term="JVM" scheme="https://zhongyp.me/tags/JVM/"/>
    
      <category term="ç¬”è®°" scheme="https://zhongyp.me/tags/%E7%AC%94%E8%AE%B0/"/>
    
  </entry>
  
  <entry>
    <title>å¹¶å‘çŸ¥è¯†æ¶æ„</title>
    <link href="https://zhongyp.me/concurrency/2018-11-27-concurrency-structure/"/>
    <id>https://zhongyp.me/concurrency/2018-11-27-concurrency-structure/</id>
    <published>2018-11-15T16:00:00.000Z</published>
    <updated>2019-06-06T02:20:23.865Z</updated>
    
    <content type="html"><![CDATA[<p><img src="/media/article/concurrency.png" alt="Javaå¹¶å‘æ¶æ„å›¾"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;img src=&quot;/media/article/concurrency.png&quot; alt=&quot;Javaå¹¶å‘æ¶æ„å›¾&quot;&gt;&lt;/p&gt;

      
    
    </summary>
    
    
      <category term="å¹¶å‘" scheme="https://zhongyp.me/tags/%E5%B9%B6%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>Gitå¸¸ç”¨å‘½ä»¤æ€»ç»“</title>
    <link href="https://zhongyp.me/utils/2018-10-23-git/"/>
    <id>https://zhongyp.me/utils/2018-10-23-git/</id>
    <published>2018-10-22T16:00:00.000Z</published>
    <updated>2019-06-17T00:35:38.851Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Git"><a href="#Git" class="headerlink" title="Git"></a>Git</h2><p>ç³»ç»Ÿç³»ç»Ÿæ€§çš„å­¦ä¹ Gitï¼Œè¯·ç§»æ­¥<a href="https://git-scm.com/book/zh/v2/%E8%B5%B7%E6%AD%A5-%E5%85%B3%E4%BA%8E%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6" target="_blank" rel="noopener">Gitä¸­æ–‡å­¦ä¹ æ–‡æ¡£</a>ï¼Œè¿™ç¯‡æ–‡ç« åªæ˜¯åˆ†ç±»è®°å½•ä¸€ä¸‹gitçš„å¸¸ç”¨å‘½ä»¤ã€‚<br><img src="/media/article/15403035072735.png" alt="Gitç‰ˆæœ¬æ§åˆ¶ç³»ç»ŸVCSåŸºæœ¬æ“ä½œæµç¨‹å›¾"></p><h2 id="å¸¸ç”¨å‘½ä»¤æ€»ç»“"><a href="#å¸¸ç”¨å‘½ä»¤æ€»ç»“" class="headerlink" title="å¸¸ç”¨å‘½ä»¤æ€»ç»“"></a>å¸¸ç”¨å‘½ä»¤æ€»ç»“</h2><h3 id="Gitåˆå§‹åŒ–"><a href="#Gitåˆå§‹åŒ–" class="headerlink" title="Gitåˆå§‹åŒ–"></a>Gitåˆå§‹åŒ–</h3><p><code>git init</code> å°†å½“å‰ç›®å½•å˜ä¸ºæœ¬åœ°ä»“åº“ï¼ˆ.gitï¼‰<br><code>git clone</code> å…‹éš†ä¸€ä¸ªè¿œç¨‹ä»“åº“åˆ°æœ¬åœ°<br><code>git clone -b branch url</code> å…‹éš†è¿œç¨‹ä»“åº“æŒ‡å®šbranchåˆ†æ”¯åˆ°æœ¬åœ°<br><code>git config user.name</code> æŸ¥çœ‹ç”¨æˆ·å<br><code>git config user.email</code> æŸ¥çœ‹é‚®ç®±</p><h3 id="è®¾ç½®ä¸é…ç½®"><a href="#è®¾ç½®ä¸é…ç½®" class="headerlink" title="è®¾ç½®ä¸é…ç½®"></a>è®¾ç½®ä¸é…ç½®</h3><p><code>git config -global user.name/email &quot;å‚æ•°&quot;</code> gitæ˜¯åˆ†å¸ƒå¼ç‰ˆæœ¬æ§åˆ¶ï¼Œæ‰€ä»¥æ·»åŠ ç”¨æˆ·åå’Œé‚®ç®±ä½œä¸ºä¸€ä¸ªæ ‡è¯†<br><code>ssh -keygen -t rsa -C &quot;email&quot;</code> ç”Ÿæˆæœ¬åœ°ssh key</p><h3 id="æœ¬åœ°ç‰ˆæœ¬åº“"><a href="#æœ¬åœ°ç‰ˆæœ¬åº“" class="headerlink" title="æœ¬åœ°ç‰ˆæœ¬åº“"></a>æœ¬åœ°ç‰ˆæœ¬åº“</h3><p><code>git add &quot;filename.*&quot;</code> æ·»åŠ åˆ°æš‚å­˜åŒº<br><code>git commit -m &quot;filename.*&quot;</code> æäº¤åˆ°æœ¬åœ°ä»“åº“<br><code>git commit --amend</code> å°è¯•é‡æ–°æäº¤ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git add file1 // å°†file1 æ·»åŠ è‡³ç¼“å­˜åŒº</span><br><span class="line">git commmit -m &quot;update files&quot; //æäº¤file1åˆ°æœ¬åœ°ä»“åº“,æäº¤å®Œå‘ç°å¿˜è®°file2æ²¡æœ‰æäº¤ï¼Œåˆ™ä½ å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼Œæäº¤file2å¹¶è¦†ç›–ä¹‹å‰çš„æäº¤ä¿¡æ¯ã€‚</span><br><span class="line">git add file2 // æ·»åŠ file2</span><br><span class="line">git commit -amend // å°è¯•é‡æ–°æäº¤commitä¿¡æ¯ï¼Œå¹¶è¦†ç›–æ‰ä¹‹å‰çš„æäº¤ä¿¡æ¯</span><br></pre></td></tr></table></figure><p><code>git status</code> æŸ¥çœ‹æœ¬åœ°ä»“åº“çŠ¶æ€<br><code>git diff filename.*</code> æŸ¥çœ‹å°šæœªæš‚å­˜çš„æ–‡ä»¶ä¿®æ”¹çš„éƒ¨åˆ†<br><code>git diff --cached</code>æˆ–<code>git diff --staged</code>æŸ¥çœ‹å·²æš‚å­˜çš„æ–‡ä»¶ä¿®æ”¹çš„éƒ¨åˆ†<br><code>git log</code> commitçš„æ—¥å¿—<br><code>git log --pretty=oneline</code> æ—¥å¿—æ˜¾ç¤ºä¸ºç¼©ç•¥ç‰ˆ<br>æ³¨ï¼š<code>git reset</code> ä¸åŠ <code>--hard</code>å‚æ•°å¯¹å½“å‰å·¥ä½œåŒºæ–‡ä»¶ä¸ä¼šæœ‰ä»»ä½•ä¿®æ”¹ï¼Œåªæ˜¯å¯¹ç¼“å­˜åŒºè¿›è¡Œæ“ä½œã€‚ä¸€æ—¦åŠ äº†å‚æ•°ï¼Œæ“ä½œä¸€å®šè¦æ…é‡ï¼Œå¦åˆ™ä½ å½“å‰å·¥ä½œåŒºä¸­çš„ä¿®æ”¹å°†ä¼šå…¨éƒ¨è¢«æ¸…é™¤ã€‚<br><code>git reset HEAD file</code> å°†fileé€€å›åˆ°å½“å‰ç‰ˆæœ¬ï¼ˆä»…ä»…æ˜¯å¯¹ç¼“å­˜åŒºè¿›è¡Œæ“ä½œï¼‰<br><code>git reset --hard HEAD^</code> é€€å›åˆ°ä¸Šä¸€ç‰ˆæœ¬<br><code>git reset --hard HEAD^^</code> é€€å›åˆ°å‰äºŒçš„ç‰ˆæœ¬<br><code>git reset --hard HEAD~100</code> é€€å›åˆ°å‰100ç‰ˆæœ¬<br><code>git reset --hard ç‰ˆæœ¬å·</code> é€€å›åˆ°ä¸€ä¸ªç‰¹å®šçš„ç‰ˆæœ¬<br><code>git reflog</code> æŸ¥çœ‹æ‰€æœ‰æ“ä½œæ—¥å¿—ï¼ŒåŒ…æ‹¬åˆ†æ”¯å’Œåˆ é™¤çš„commit<br><code>git reset --mixed</code> å°†å½“å‰æ–‡ä»¶æ’¤å‡ºç¼“å­˜åŒºï¼Œä¿ç•™æ–‡ä»¶ä¿®æ”¹<br><code>git rm --cached file</code> åˆ é™¤ç¼“å­˜åŒºfile<br><code>git checkout -- file</code> æ¢å¤å·¥ä½œåŒºfileï¼ˆå–æ¶ˆå·¥ä½œåŒºæ–‡ä»¶çš„ä¿®æ”¹ï¼‰</p><h3 id="è¿œç¨‹ç‰ˆæœ¬åº“"><a href="#è¿œç¨‹ç‰ˆæœ¬åº“" class="headerlink" title="è¿œç¨‹ç‰ˆæœ¬åº“"></a>è¿œç¨‹ç‰ˆæœ¬åº“</h3><p><code>git remote add origin è¿œç¨‹gitåœ°å€</code> è¿æ¥<br><code>git push -u origin master</code> æŠŠæœ¬åœ°åº“åˆ†æ”¯masterå†…å®¹æ¨é€åˆ°è¿œç¨‹åº“ï¼ˆ-u å‘½ä»¤åœ¨ç¬¬ä¸€æ¬¡å…³è”æœ¬åœ°åº“å’Œè¿œç¨‹åº“æ—¶ä½¿ç”¨ï¼‰<br><code>git clone url</code> å…‹éš†è¿œç¨‹(url)åº“</p><h3 id="gitåˆ†æ”¯æ“ä½œ"><a href="#gitåˆ†æ”¯æ“ä½œ" class="headerlink" title="gitåˆ†æ”¯æ“ä½œ"></a>gitåˆ†æ”¯æ“ä½œ</h3><p>é¦–å…ˆmasterä¸»åˆ†æ”¯åº”è¯¥æ˜¯éå¸¸ç¨³å®šçš„ï¼Œä¹Ÿå°±æ˜¯ç”¨æ¥å‘å¸ƒæ–°ç‰ˆæœ¬ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä¸å…è®¸åœ¨ä¸Šé¢å¹²æ´»ï¼Œå¹²æ´»ä¸€èˆ¬æƒ…å†µä¸‹åœ¨æ–°å»ºçš„devåˆ†æ”¯ä¸Šå¹²æ´»ï¼Œå¹²å®Œåï¼Œæ¯”å¦‚ä¸Šè¦å‘å¸ƒï¼Œæˆ–è€…è¯´devåˆ†æ”¯ä»£ç ç¨³å®šåå¯ä»¥åˆå¹¶åˆ°ä¸»åˆ†æ”¯masterä¸Šæ¥ã€‚</p><p><code>git branch</code> æŸ¥çœ‹åˆ†æ”¯<br><code>git checkout</code> åˆ‡æ¢åˆ†æ”¯<br><code>git checkout -b</code>  åˆ›å»ºå¹¶åˆ‡æ¢åˆ†æ”¯<br><code>git merge</code> åˆå¹¶åˆ°å½“å‰åˆ†æ”¯<br><code>git branch -d</code>åˆ é™¤æŸåˆ†æ”¯<br><code>git merge --no-ff -m &quot;æ³¨é‡Š&quot;</code>åˆ†æ”¯åˆå¹¶åˆ†æ”¯ç¦ç”¨fast forward<br><code>git stash</code> å°†å½“å‰åˆ†æ”¯çš„å·¥ä½œç°åœºä¿ç•™ä¸‹æ¥<br><code>git stash list</code> æŸ¥çœ‹å·¥ä½œç°åœº<br><code>git stash apply</code> æ¢å¤å†…å®¹ä½†æ˜¯ä½ éœ€è¦git stash dropåˆ é™¤stash<br><code>git stash pop</code> æ¢å¤çš„åŒæ—¶æŠŠstashå†…å®¹ä¹Ÿåˆ é™¤<br><code>git remote</code> æŸ¥çœ‹è¿œç¨‹åº“çš„ä¿¡æ¯<br><code>git remote -v</code> æŸ¥çœ‹è¿œç¨‹åº“çš„è¯¦ç»†ä¿¡æ¯<br><code>git push origin master</code> masterä¸ºæœ¬åœ°çš„åˆ†æ”¯åæ¨é€åˆ†æ”¯<br><code>git checkout -b dev origin/dev</code> devä¸ºåˆ†æ”¯åï¼Œåšå®Œå¼€å‘å<br><code>git push origin dev</code> æ¨é€åˆ°è¿œç¨‹åº“<br><code>git pull</code> æŠ“å–æœ€æ–°çš„æäº¤,å¹¶å°è¯•è‡ªåŠ¨åˆå¹¶åˆ°æœ¬åœ°å½“å‰æ‰€åœ¨çš„åˆ†æ”¯<br><code>git fetch</code> æŠ“å–æœ€æ–°çš„æäº¤ï¼Œä¸ä¼šè‡ªåŠ¨åˆå¹¶ï¼Œå¿…é¡»æ‰‹åŠ¨ã€‚<br><code>git rebase</code> å˜åŸº,å°†æäº¤åˆ°æŸä¸€åˆ†æ”¯ä¸Šçš„æ‰€æœ‰ä¿®æ”¹éƒ½ç§»è‡³å¦ä¸€åˆ†æ”¯ä¸Š<br><code>git rebase --continue</code> <strong><em>ç»§ç»­å˜åŸºæ“ä½œï¼Œä¸€èˆ¬ç”¨äºç¬¬ä¸€æ¬¡å˜åŸºå¤±è´¥åï¼Œè§£å†³å†²çªæ–‡ä»¶ï¼Œå°†å†²çªæ–‡ä»¶æ·»åŠ åˆ°ç¼“å­˜åŒºï¼Œä¸è¦æäº¤ï¼Œç„¶åå†æ‰§è¡Œæ­¤å‘½ä»¤ã€‚å¦‚æœæäº¤äº†ï¼Œæ‰§è¡Œ<code>git rebase --skip</code>å‘½ä»¤å–æ¶ˆrebaseçŠ¶æ€ã€‚</em></strong><br><code>git branch --set-upstream dev origin/dev</code> æŒ‡å®šæœ¬åœ°devåˆ†æ”¯ï¼ˆå·²ç»åˆ›å»ºçš„ï¼‰ä¸è¿œç¨‹origin/devåˆ†æ”¯çš„è¿æ¥<br><code>git branch -u origin/dev</code> æŒ‡å®šå½“å‰æ‰€åœ¨è¿æ¥è¿œç¨‹origin/devåˆ†æ”¯çš„è¿æ¥<br><code>git checkout --track origin/dev</code> åˆ›å»ºæ–°çš„devåˆ†æ”¯ï¼Œåˆ¶å®šè¿œç¨‹è¿æ¥origin/dev</p><blockquote><p>å¦‚æœé¡ºç€ä¸€ä¸ªåˆ†æ”¯èµ°ä¸‹å»èƒ½å¤Ÿåˆ°è¾¾å¦ä¸€ä¸ªåˆ†æ”¯ï¼Œé‚£ä¹ˆGitåœ¨åˆå¹¶ä¸¤è€…çš„æ—¶å€™ï¼Œåªä¼šç®€å•çš„å°†æŒ‡é’ˆå‘å‰æ¨è¿›ï¼ˆæŒ‡é’ˆå³ç§»ï¼‰ï¼Œå› ä¸ºè¿™ç§æƒ…å†µä¸‹çš„åˆå¹¶æ“ä½œæ²¡æœ‰éœ€è¦è§£å†³çš„åˆ†æ­§â€”â€”è¿™å°±å«åš â€œå¿«è¿›ï¼ˆfast-forwardï¼‰â€ã€‚</p></blockquote><h3 id="å¤šäººåä½œ"><a href="#å¤šäººåä½œ" class="headerlink" title="å¤šäººåä½œ"></a>å¤šäººåä½œ</h3><ol><li>æ¯å¼€å‘ä¸€ä¸ªæ–°ç‰¹æ€§å¯ä»¥æ–°å»ºä¸€ä¸ªæœ¬åœ°ç‰¹æ€§åˆ†æ”¯ï¼Œå¼€å‘å®Œæˆååˆå¹¶åˆ°æœ¬åœ°ä¸»çº¿ã€‚</li><li>å¦‚æœä¸ä½¿ç”¨ç‰¹æ€§åˆ†æ”¯å¼€å‘å¯ä»¥ä½¿ç”¨<code>git stash</code>ä¿å­˜å½“å‰çš„å·¥ä½œç©ºé—´ã€‚</li><li>è¿œç¨‹ä»£ç å’Œæœ¬åœ°ä»£ç åˆå¹¶æœ‰ä¸¤ç§æ–¹å¼ï¼Œ<code>git pull</code>å’Œ<code>git fetch</code>ï¼Œ<code>git pull</code>å‘½ä»¤ä¼šè‡ªåŠ¨åˆå¹¶è¿œç¨‹ä»£ç ï¼Œå†²çªåéœ€è¦è§£å†³å†²çªåæäº¤ã€‚<code>git fetch</code>ä¸è‡ªåŠ¨å’Œæœ¬åœ°ä»£ç åˆå¹¶ï¼Œéœ€è¦æ‰‹åŠ¨mergeã€‚</li><li>åœ¨åˆå¹¶æ—¶ï¼Œæ ¹æ®é¡¹ç›®æƒ…å†µä½¿ç”¨<a href="https://git-scm.com/book/zh/v2/Git-%E5%88%86%E6%94%AF-%E5%8F%98%E5%9F%BA" target="_blank" rel="noopener">å˜åŸº</a>ï¼Œ<code>git pull --rebase</code>å¯ä»¥ä¿æŒè‡ªåŠ¨åˆå¹¶çš„æƒ…å†µä¸‹è¿›è¡Œå˜åŸºã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè¿œç¨‹åº“ä¸ä¿ç•™æœ¬åœ°æ“ä½œå†å²ï¼Œæ‰€ä»¥æœ¬åœ°ä¸è¿œç¨‹ä»£ç åˆå¹¶æ—¶æœ€å¥½ä½¿ç”¨å˜åŸºã€‚</li><li><strong><em>ä½¿ç”¨å˜åŸºåŸåˆ™</em></strong>ï¼šåªå¯¹å°šæœªæ¨é€æˆ–åˆ†äº«ç»™åˆ«äººçš„æœ¬åœ°ä¿®æ”¹æ‰§è¡Œå˜åŸºæ“ä½œæ¸…ç†å†å²ï¼Œä»ä¸å¯¹å·²æ¨é€è‡³åˆ«å¤„çš„æäº¤æ‰§è¡Œå˜åŸºæ“ä½œï¼Œè¿™æ ·ï¼Œä½ æ‰èƒ½äº«å—åˆ°ä¸¤ç§æ–¹å¼å¸¦æ¥çš„ä¾¿åˆ©ã€‚</li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;Git&quot;&gt;&lt;a href=&quot;#Git&quot; class=&quot;headerlink&quot; title=&quot;Git&quot;&gt;&lt;/a&gt;Git&lt;/h2&gt;&lt;p&gt;ç³»ç»Ÿç³»ç»Ÿæ€§çš„å­¦ä¹ Gitï¼Œè¯·ç§»æ­¥&lt;a href=&quot;https://git-scm.com/book/zh/v2/%E8%B5%B7%E
      
    
    </summary>
    
    
      <category term="Utils" scheme="https://zhongyp.me/tags/Utils/"/>
    
  </entry>
  
</feed>
