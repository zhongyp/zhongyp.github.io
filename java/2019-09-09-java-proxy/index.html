
<!DOCTYPE html>
<html lang="zh-Hans">


<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="theme-color" content="#202020">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="google-site-verification" content="9GY-OrjvdT8TkXuLJFSJcJqolHfXKJ5NVYKRUv8mCRM">
  
    <meta name="keywords" content="Java,åŠ¨æ€ä»£ç†æµ…æ">
  

  
    <meta name="description" content="é’Ÿå®‡é¹çš„åšå®¢,é’Ÿå®‡é¹,ä¸ªäººåšå®¢">
  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <link rel="icon" type="image/x-icon" href="/logo.png">
  <title>åŠ¨æ€ä»£ç†æµ…æ [ zhongyp&#39;blog ]</title>
  
    <!-- stylesheets list from config.yml -->
    
      <link rel="stylesheet" href="/css/pure.min.css">
    
      <link rel="stylesheet" href="/css/simple.css">
    
  
</head>


<body>
  <nav class="home-menu pure-menu pure-menu-horizontal pure-menu-fixed">
  <ul class="pure-menu-list float-r clearfix">
    
      <!-- <li class="pure-menu-item toc-menu pure-menu-has-children pure-menu-allow-hover">
        <a id="menu-main-post" class="pure-menu-link" href="javascript:;">
          <img class="menu-icon" src="/logo.png" alt="MENU">
        </a>
      </li> -->
      <li class="pure-menu-item pure-menu-has-children pure-menu-allow-hover">
        <a id="menu-main" class="pure-menu-link" href="javascript:;">
          <img class="menu-icon" src="/logo.png" alt="MENU">
        </a>
        <ul class="pure-menu-children">
        
          
            <li class="pure-menu-item"><a href="/" class="pure-menu-link">é¦–é¡µ</a></li>
          
          
          
            <li class="pure-menu-item"><a href="/tags" class="pure-menu-link">æ ‡ç­¾</a></li>
          
          
          
            <li class="pure-menu-item"><a href="/search" class="pure-menu-link">æœç´¢</a></li>
          
          
          
            <li class="pure-menu-item"><a href="/about" class="pure-menu-link">å…³äº</a></li>
          
          
      </ul>
      </li>
    
  </ul>
  <a class="pure-menu-heading" href="/">
      <h1 class="title">zhongyp&#39;blog</h1>
      <!-- <span>é’Ÿå®‡é¹çš„åšå®¢</span> -->
  </a>
  <!-- 
  <img class="logo" id="logo" src="/logo.png" alt="logo">
   -->
</nav>


  <div class="container" id="content-outer">
    <div class="inner" id="content-inner">
      <article class="post" id="post">
  <header class="post-header text-center">
    <h1 class="title">
      åŠ¨æ€ä»£ç†æµ…æ
    </h1>
    
    <time class="time" datetime="2019-09-06T16:00:00.000Z">
      2019-09-07
    </time>
     |
    <span id="busuanzi_container_page_pv">æœ¬æ–‡æ€»é˜…è¯»é‡<span id="busuanzi_value_page_pv"></span>æ¬¡
</span>
    <hr>
  </header>
  <div class="post-content">
    <h2 id="1-åŠ¨æ€ä»£ç†"><a href="#1-åŠ¨æ€ä»£ç†" class="headerlink" title="1. åŠ¨æ€ä»£ç†"></a>1. åŠ¨æ€ä»£ç†</h2><p>ä»£ç†æ˜¯ä¸€ç§å¸¸ç”¨çš„è®¾è®¡æ¨¡å¼ï¼Œå…¶ç›®çš„å°±æ˜¯ä¸ºå…¶ä»–å¯¹è±¡æä¾›ä¸€ä¸ªä»£ç†ä»¥æ§åˆ¶å¯¹æŸä¸ªå¯¹è±¡çš„è®¿é—®ã€‚ä»£ç†ç±»è´Ÿè´£ä¸ºå§”æ‰˜ç±»é¢„å¤„ç†æ¶ˆæ¯ï¼Œè¿‡æ»¤æ¶ˆæ¯å¹¶è½¬å‘æ¶ˆæ¯ï¼Œä»¥åŠè¿›è¡Œæ¶ˆæ¯è¢«å§”æ‰˜ç±»æ‰§è¡Œåçš„åç»­å¤„ç†ã€‚</p>
<p>åŠ¨æ€ä»£ç†åˆ™æ˜¯ä¸€ç§æ–¹ä¾¿è¿è¡Œæ—¶åŠ¨æ€æ„å»ºä»£ç†ã€åŠ¨æ€å¤„ç†ä»£ç†æ–¹æ³•è°ƒç”¨çš„æœºåˆ¶ã€‚</p>
<p>å®ç°åŠ¨æ€ä»£ç†çš„æ–¹å¼æœ‰å¾ˆå¤šï¼Œå¦‚ ASMã€AspectJã€Javassistã€Java Proxyç­‰ã€‚<br><img src="/media/article/15688575046625.png" alt="jclasslib"><br>å›¾ç‰‡å¼•ç”¨è‡ª<a href="https://tech.meituan.com/2019/09/05/java-bytecode-enhancement.html" target="_blank" rel="noopener">ã€Šç¾å›¢æŠ€æœ¯å›¢é˜Ÿã€‹-å­—èŠ‚ç å¢å¼ºæŠ€æœ¯æ¢ç´¢</a></p>
<h2 id="2-åå°„"><a href="#2-åå°„" class="headerlink" title="2. åå°„"></a>2. åå°„</h2><p>Java åŠ¨æ€ä»£ç†ä¸­é™¤äº†å­—èŠ‚ç å¢å¼ºæŠ€æœ¯å¤–ï¼Œæœ€ä¸»è¦çš„å°±æ˜¯Javaçš„åå°„æœºåˆ¶ã€‚</p>
<blockquote>
<p>Reflection is commonly used by programs which require the ability to examine or modify the runtime behavior of applications running in the Java virtual machine. This is a relatively advanced feature and should be used only by developers who have a strong grasp of the fundamentals of the language. With that caveat in mind, reflection is a powerful technique and can enable applications to perform operations which would otherwise be impossible. â€“å¼•ç”¨è‡ª<a href="https://docs.oracle.com/javase/tutorial/reflect/index.html" target="_blank" rel="noopener">Java Reflection API</a></p>
</blockquote>
<p>åœ¨Javaä¸­çš„åå°„æœºåˆ¶æ˜¯æŒ‡åœ¨è¿è¡ŒçŠ¶æ€ä¸­ï¼Œå¯¹äºä»»æ„ä¸€ä¸ªç±»éƒ½èƒ½å¤ŸçŸ¥é“è¿™ä¸ªç±»æ‰€æœ‰çš„å±æ€§å’Œæ–¹æ³•;å¹¶ä¸”å¯¹äºä»»æ„ä¸€ä¸ªå¯¹è±¡ï¼Œéƒ½èƒ½å¤Ÿè°ƒç”¨å®ƒçš„ä»»æ„ä¸€ä¸ªæ–¹æ³•;è¿™ç§åŠ¨æ€è·å–ä¿¡æ¯ä»¥åŠåŠ¨æ€è°ƒç”¨å¯¹è±¡æ–¹æ³•çš„åŠŸèƒ½æˆä¸ºJavaè¯­è¨€çš„åå°„æœºåˆ¶ã€‚</p>
<h2 id="3-å¸¸ç”¨çš„ä¸‰ç§ä»£ç†æ–¹å¼"><a href="#3-å¸¸ç”¨çš„ä¸‰ç§ä»£ç†æ–¹å¼" class="headerlink" title="3. å¸¸ç”¨çš„ä¸‰ç§ä»£ç†æ–¹å¼"></a>3. å¸¸ç”¨çš„ä¸‰ç§ä»£ç†æ–¹å¼</h2><blockquote>
<p>åœ¨Java è¯­è¨€ä¸­ï¼Œä»ç»‡å…¥åˆ‡é¢çš„æ–¹å¼ä¸Šæ¥çœ‹ï¼Œå­˜åœ¨ä¸‰ç§ç»‡å…¥æ–¹å¼ï¼šç¼–è¯‘æœŸç»‡å…¥ã€ç±»åŠ è½½æœŸç»‡å…¥å’Œè¿è¡ŒæœŸç»‡å…¥ã€‚ç¼–è¯‘æœŸç»‡å…¥æ˜¯æŒ‡åœ¨Javaç¼–è¯‘æœŸï¼Œé‡‡ç”¨ç‰¹æ®Šçš„ç¼–è¯‘å™¨ï¼Œå°†åˆ‡é¢ç»‡å…¥åˆ°Javaç±»ä¸­ï¼›è€Œç±»åŠ è½½æœŸç»‡å…¥åˆ™æŒ‡é€šè¿‡ç‰¹æ®Šçš„ç±»åŠ è½½å™¨ï¼Œåœ¨ç±»å­—èŠ‚ç åŠ è½½åˆ°JVMæ—¶ï¼Œç»‡å…¥åˆ‡é¢ï¼›è¿è¡ŒæœŸç»‡å…¥åˆ™æ˜¯é‡‡ç”¨CGLibå·¥å…·æˆ–JDKåŠ¨æ€ä»£ç†è¿›è¡Œåˆ‡é¢çš„ç»‡å…¥ã€‚</p>
</blockquote>
<h3 id="3-1-JavaåŠ¨æ€ä»£ç†ç±»"><a href="#3-1-JavaåŠ¨æ€ä»£ç†ç±»" class="headerlink" title="3.1 JavaåŠ¨æ€ä»£ç†ç±»"></a>3.1 JavaåŠ¨æ€ä»£ç†ç±»</h3><p><a href="https://github.com/zhongyp/demo/tree/master/src/main/java/com/zhongyp/advanced/proxy" target="_blank" rel="noopener">ä»£ç ç¤ºä¾‹</a>ğŸ‘ˆğŸ»ğŸ‘ˆğŸ»ğŸ‘ˆğŸ»</p>
<p>Javaé€šè¿‡<code>Proxy</code>ç±»å’Œ<code>InvocationHandler</code>æ¥å£ç”ŸæˆåŠ¨æ€ä»£ç†ç±»<code>$Proxy0</code>ã€‚</p>
<p><img src="/media/article/java-proxy.001.png" alt="java-proxy"></p>
<p>ç”Ÿæˆçš„<code>$Proxy0</code>ä»£ç†ç±»ï¼Œè¿™ä¸ªä»£ç†ç±»å®ç°äº†äº†æ‰€æœ‰çš„æ¥å£(å‚æ•°æ¥å£ç±»æ•°ç»„ä¸­çš„æ‰€æœ‰æ¥å£):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">//</span><br><span class="line">// Source code recreated from a .class file by IntelliJ IDEA</span><br><span class="line">// (powered by Fernflower decompiler)</span><br><span class="line">//</span><br><span class="line"></span><br><span class="line">package com.zhongyp.advanced.proxy;</span><br><span class="line"></span><br><span class="line">import java.lang.reflect.InvocationHandler;</span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line">import java.lang.reflect.Proxy;</span><br><span class="line">import java.lang.reflect.UndeclaredThrowableException;</span><br><span class="line"></span><br><span class="line">final class $Proxy0 extends Proxy implements TestService, TestService1 &#123;</span><br><span class="line">    private static Method m1;</span><br><span class="line">    private static Method m3;</span><br><span class="line">    private static Method m4;</span><br><span class="line">    private static Method m6;</span><br><span class="line">    private static Method m2;</span><br><span class="line">    private static Method m5;</span><br><span class="line">    private static Method m0;</span><br><span class="line"></span><br><span class="line">    public $Proxy0(InvocationHandler var1) throws  &#123;</span><br><span class="line">        super(var1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public final boolean equals(Object var1) throws  &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            return (Boolean)super.h.invoke(this, m1, new Object[]&#123;var1&#125;);</span><br><span class="line">        &#125; catch (RuntimeException | Error var3) &#123;</span><br><span class="line">            throw var3;</span><br><span class="line">        &#125; catch (Throwable var4) &#123;</span><br><span class="line">            throw new UndeclaredThrowableException(var4);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public final void test() throws  &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            super.h.invoke(this, m3, (Object[])null);</span><br><span class="line">        &#125; catch (RuntimeException | Error var2) &#123;</span><br><span class="line">            throw var2;</span><br><span class="line">        &#125; catch (Throwable var3) &#123;</span><br><span class="line">            throw new UndeclaredThrowableException(var3);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public final void test3() throws  &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            super.h.invoke(this, m4, (Object[])null);</span><br><span class="line">        &#125; catch (RuntimeException | Error var2) &#123;</span><br><span class="line">            throw var2;</span><br><span class="line">        &#125; catch (Throwable var3) &#123;</span><br><span class="line">            throw new UndeclaredThrowableException(var3);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public final void test4() throws  &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            super.h.invoke(this, m6, (Object[])null);</span><br><span class="line">        &#125; catch (RuntimeException | Error var2) &#123;</span><br><span class="line">            throw var2;</span><br><span class="line">        &#125; catch (Throwable var3) &#123;</span><br><span class="line">            throw new UndeclaredThrowableException(var3);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public final String toString() throws  &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            return (String)super.h.invoke(this, m2, (Object[])null);</span><br><span class="line">        &#125; catch (RuntimeException | Error var2) &#123;</span><br><span class="line">            throw var2;</span><br><span class="line">        &#125; catch (Throwable var3) &#123;</span><br><span class="line">            throw new UndeclaredThrowableException(var3);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public final void test1() throws  &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            super.h.invoke(this, m5, (Object[])null);</span><br><span class="line">        &#125; catch (RuntimeException | Error var2) &#123;</span><br><span class="line">            throw var2;</span><br><span class="line">        &#125; catch (Throwable var3) &#123;</span><br><span class="line">            throw new UndeclaredThrowableException(var3);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public final int hashCode() throws  &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            return (Integer)super.h.invoke(this, m0, (Object[])null);</span><br><span class="line">        &#125; catch (RuntimeException | Error var2) &#123;</span><br><span class="line">            throw var2;</span><br><span class="line">        &#125; catch (Throwable var3) &#123;</span><br><span class="line">            throw new UndeclaredThrowableException(var3);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            m1 = Class.forName(&quot;java.lang.Object&quot;).getMethod(&quot;equals&quot;, Class.forName(&quot;java.lang.Object&quot;));</span><br><span class="line">            m3 = Class.forName(&quot;com.zhongyp.advanced.proxy.TestService&quot;).getMethod(&quot;test&quot;);</span><br><span class="line">            m4 = Class.forName(&quot;com.zhongyp.advanced.proxy.TestService&quot;).getMethod(&quot;test3&quot;);</span><br><span class="line">            m6 = Class.forName(&quot;com.zhongyp.advanced.proxy.TestService1&quot;).getMethod(&quot;test4&quot;);</span><br><span class="line">            m2 = Class.forName(&quot;java.lang.Object&quot;).getMethod(&quot;toString&quot;);</span><br><span class="line">            m5 = Class.forName(&quot;com.zhongyp.advanced.proxy.TestService1&quot;).getMethod(&quot;test1&quot;);</span><br><span class="line">            m0 = Class.forName(&quot;java.lang.Object&quot;).getMethod(&quot;hashCode&quot;);</span><br><span class="line">        &#125; catch (NoSuchMethodException var2) &#123;</span><br><span class="line">            throw new NoSuchMethodError(var2.getMessage());</span><br><span class="line">        &#125; catch (ClassNotFoundException var3) &#123;</span><br><span class="line">            throw new NoClassDefFoundError(var3.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-1-1-JavaåŠ¨æ€ä»£ç†æºç è§£æ"><a href="#3-1-1-JavaåŠ¨æ€ä»£ç†æºç è§£æ" class="headerlink" title="3.1.1 JavaåŠ¨æ€ä»£ç†æºç è§£æ"></a>3.1.1 JavaåŠ¨æ€ä»£ç†æºç è§£æ</h4><blockquote>
<p>Classå¯¹è±¡æ¯ä¸ªç±»åªæœ‰ä¸€ä¸ªï¼ˆåŒä¸€ä¸ªç±»åŠ è½½å™¨çš„æƒ…å†µä¸‹ï¼‰ï¼Œè¯¥Classå¯¹è±¡åœ¨ç±»åŠ è½½é˜¶æ®µç”Ÿæˆï¼Œå­˜å‚¨åœ¨å†…å­˜ä¸­ï¼ŒéJavaè™šæ‹Ÿæœºå †ï¼Œæ˜¯è¯¥ç±»å¯¹å¤–è®¿é—®çš„å”¯ä¸€å…¥å£ã€‚<a href="https://docs.oracle.com/javase/specs/jls/se9/html/jls-12.html#jls-12.4" target="_blank" rel="noopener">Java Language Specification 12.4</a></p>
</blockquote>
<p>Javaç”ŸæˆåŠ¨æ€ä»£ç†ç±»çš„æ ¸å¿ƒæ–¹æ³•æ˜¯ï¼šProxyClassFactoryçš„<code>Class&lt;?&gt; apply(ClassLoader loader, Class&lt;?&gt;[] interfaces)</code>ã€‚</p>
<p>æˆ‘ä»¬å…ˆä»æ–¹æ³•å‚æ•°å¼€å§‹ï¼Œ<code>ClassLoader loader</code>æ¥å£ç±»åŠ è½½å™¨ï¼Œ<code>Class&lt;?&gt;[] interfaces</code>æ¥å£ç±»çš„Classã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">// éå†æ¥å£ç±»çš„Classæ•°ç»„</span><br><span class="line">  for (Class&lt;?&gt; intf : interfaces) &#123;</span><br><span class="line">      </span><br><span class="line">      Class&lt;?&gt; interfaceClass = null;</span><br><span class="line">      try &#123;</span><br><span class="line">          // åå°„è·å¾—æ¥å£ç±»Classå¯¹è±¡</span><br><span class="line">          interfaceClass = Class.forName(intf.getName(), false, loader);</span><br><span class="line">      &#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">      </span><br><span class="line">      &#125;</span><br><span class="line">      // æ ¡éªŒæ˜¯å¦æ˜¯åŒä¸€ä¸ªç±»åŠ è½½å™¨ï¼Œå¦‚æœæ˜¯ä¸åŒçš„ç±»åŠ è½½å™¨ï¼Œç”Ÿæˆçš„æ¥å£Classå¯¹è±¡æ˜¯ä¸åŒçš„</span><br><span class="line">      if (interfaceClass != intf) &#123;</span><br><span class="line">          throw new IllegalArgumentException(</span><br><span class="line">              intf + &quot; is not visible from class loader&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">      // JavaåŠ¨æ€ä»£ç†ä»…æ”¯æŒæ¥å£ä»£ç†</span><br><span class="line">      if (!interfaceClass.isInterface()) &#123;</span><br><span class="line">          throw new IllegalArgumentException(</span><br><span class="line">              interfaceClass.getName() + &quot; is not an interface&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">      // ä½¿ç”¨Setæ¥éªŒè¯ä¼ å…¥çš„æ¥å£æ•°ç»„ä¸­æ˜¯å¦å­˜åœ¨ç›¸åŒçš„æ¥å£</span><br><span class="line">      if (interfaceSet.put(interfaceClass, Boolean.TRUE) != null) &#123;</span><br><span class="line">          throw new IllegalArgumentException(</span><br><span class="line">              &quot;repeated interface: &quot; + interfaceClass.getName());</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>ä¸‹é¢è¿™ä¹ˆå¤šä»£ç æ˜¯ä¸ºäº†ç»™ä¸‹é¢ç”Ÿæˆçš„ä»£ç†ç±»æ‰¾åˆ°ä¸€ä¸ªåˆç†çš„åŒ…åå’Œç±»åï¼Œå¦‚æœæ¥å£æ•°ç»„ä¸­æœ‰épublicå±æ€§çš„æ¥å£ï¼Œå¦‚æœæ­¤æ¥å£çš„åŒ…åä¸ä¸ºnullï¼Œåˆ™ä½¿ç”¨è¿™ä¸ªæ¥å£çš„åŒ…åï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤çš„<code>com.sun.proxy</code>åŒ…åï¼Œç±»ååˆ™æ˜¯ä¸Šè¿°â€œåŒ…å+$Proxy+è‡ªå¢æ•°å­—â€ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">String proxyPkg = null;     </span><br><span class="line">int accessFlags = Modifier.PUBLIC | Modifier.FINAL;</span><br><span class="line">for (Class&lt;?&gt; intf : interfaces) &#123;</span><br><span class="line">    int flags = intf.getModifiers();</span><br><span class="line">    if (!Modifier.isPublic(flags)) &#123;</span><br><span class="line">        accessFlags = Modifier.FINAL;</span><br><span class="line">        String name = intf.getName();</span><br><span class="line">        int n = name.lastIndexOf(&apos;.&apos;);</span><br><span class="line">        String pkg = ((n == -1) ? &quot;&quot; : name.substring(0, n + 1));</span><br><span class="line">        if (proxyPkg == null) &#123;</span><br><span class="line">            proxyPkg = pkg;</span><br><span class="line">        &#125; else if (!pkg.equals(proxyPkg)) &#123;</span><br><span class="line">            throw new IllegalArgumentException(</span><br><span class="line">                &quot;non-public interfaces from different packages&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (proxyPkg == null) &#123;</span><br><span class="line">    // if no non-public proxy interfaces, use com.sun.proxy package</span><br><span class="line">    proxyPkg = ReflectUtil.PROXY_PACKAGE + &quot;.&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// ä½¿ç”¨è‡ªå¢æ•°å­—åŒºåˆ†ä¸åŒçš„ç±»</span><br><span class="line">long num = nextUniqueNumber.getAndIncrement();</span><br><span class="line">String proxyName = proxyPkg + proxyClassNamePrefix + num;</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢å°±æ˜¯æ•´ä¸ªåŠ¨æ€ä»£ç†æœ€æ ¸å¿ƒçš„ä»£ç ã€‚ç”Ÿæˆä»£ç†ç±»classæ–‡ä»¶çš„å­—èŠ‚ç ï¼Œæ ¹æ®è¿™ä¸ªæ–‡ä»¶çš„å­—èŠ‚ç ç”Ÿæˆä»£ç†ç±»çš„Classå¯¹è±¡ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// ç”Ÿæˆå­—èŠ‚æ•°ç»„ï¼Œè¿™ä¸ªå­—èŠ‚æ•°ç»„æ˜¯ç”Ÿæˆçš„Classæ–‡ä»¶çš„å­—èŠ‚æ•°ç»„ï¼Œå°†è¿™ä¸ªå­—èŠ‚æµè¾“å‡ºåˆ°classæ–‡ä»¶ï¼Œå°±æ˜¯ä¸Šé¢çš„$Proxy0ä»£ç†ç±»ã€‚  </span><br><span class="line">byte[] proxyClassFile = ProxyGenerator.generateProxyClass(</span><br><span class="line"> proxyName, interfaces, accessFlags);</span><br><span class="line">try &#123;</span><br><span class="line"> // é€šè¿‡åˆšæ‰ç”Ÿæˆçš„ä»£ç†ç±»æ–‡ä»¶ï¼Œç”Ÿæˆä»£ç†ç±»çš„Classå¯¹è±¡ã€‚</span><br><span class="line"> return defineClass0(loader, proxyName,</span><br><span class="line">                     proxyClassFile, 0, proxyClassFile.length);</span><br><span class="line">&#125; catch (ClassFormatError e) &#123;</span><br><span class="line"> throw new IllegalArgumentException(e.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>æœ€å°åŒ–ä¾èµ–å…³ç³»ï¼Œå‡å°‘ä¾èµ–æ„å‘³ç€ç®€åŒ–å¼€å‘å’Œç»´æŠ¤ï¼ŒJDKæœ¬èº«çš„æ”¯æŒï¼Œå¯èƒ½æ¯”cglibæ›´åŠ å¯é ã€‚</li>
<li>å¹³æ»‘è¿›è¡ŒJDKç‰ˆæœ¬å‡çº§ï¼Œè€Œå­—èŠ‚ç ç±»åº“é€šå¸¸éœ€è¦è¿›è¡Œæ›´æ–°æ¥ä¿è¯åœ¨æ–°ç‰ˆJavaä¸Šèƒ½å¤Ÿä½¿ç”¨ã€‚</li>
<li>ä»£ç å®ç°ç®€å•ã€‚</li>
<li>å¦‚æœä»…ä»…åœ¨åŒä¸€ä¸ªç±»åŠ è½½å™¨ä¸‹å¯¹ä¸€ä¸ªç±»åšå¤šæ¬¡åˆ›å»ºä»£ç†æ“ä½œï¼ŒJavaåŠ¨æ€ä»£ç†å¿«äºCglibã€‚</li>
</ul>
<h3 id="3-1-2-CglibåŠ¨æ€ä»£ç†"><a href="#3-1-2-CglibåŠ¨æ€ä»£ç†" class="headerlink" title="3.1.2 CglibåŠ¨æ€ä»£ç†"></a>3.1.2 CglibåŠ¨æ€ä»£ç†</h3><p>ä¸‹å›¾æ˜¯cglibåŠ¨æ€ä»£ç†ç”Ÿæˆä»£ç†ç±»å®ä¾‹çš„ä»£ç å¤§è‡´æµç¨‹ï¼š<br><img src="/media/article/cglib-processor.png" alt="cglib-processor"></p>
<blockquote>
<p><strong>TIPS</strong><br>åœ¨åŒä¸€ä¸ªç±»åŠ è½½å™¨ä¸‹ç”ŸæˆåŒä¸€ä¸ªåŠ¨æ€ä»£ç†ç±»çš„æ€§èƒ½æ¯”è¾ƒåˆ†æã€‚<br>cglibç”Ÿæˆ1wæ¬¡å¤§æ¦‚æ˜¯220msã€‚JDKåŠ¨æ€ä»£ç†1wæ¬¡å¤§æ¦‚æ˜¯110msã€‚<br>cglibç”Ÿæˆ10wæ¬¡å¤§æ¦‚æ˜¯520msã€‚JDKåŠ¨æ€ä»£ç†10wæ¬¡å¤§æ¦‚æ˜¯520msã€‚<br>cglibç”Ÿæˆ100wæ¬¡å¤§æ¦‚æ˜¯3290msã€‚JDKåŠ¨æ€ä»£ç†100wæ¬¡å¤§æ¦‚æ˜¯3610msã€‚</p>
</blockquote>
<p>ç¤ºä¾‹ä»£ç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">long start = System.currentTimeMillis();</span><br><span class="line">for (int i = 0; i &lt; 10000 ; i++) &#123;</span><br><span class="line">    TestServiceImpl testService = new TestServiceImpl();</span><br><span class="line">    // å£°æ˜è‡ªå·±çš„å¤„ç†ç±»</span><br><span class="line">    MyInvokeHandler myInvokeHandler = new MyInvokeHandler(testService);</span><br><span class="line">    // ç¬¬ä¸€æ¬¡ç”Ÿæˆä»£ç†ç±»</span><br><span class="line">    TestService proxy = (TestService)     Proxy.newProxyInstance(TestService.class.getClassLoader(),new Class[]&#123;TestService.class, TestService1.class&#125;,myInvokeHandler);</span><br><span class="line">    // ç¬¬äºŒæ¬¡ç”Ÿæˆä»£ç†ç±»ï¼Œç¬¬äºŒæ¬¡ç”Ÿæˆçš„ä»£ç†ç±»ä»weakCacheä¸­ç›´æ¥è·å–ï¼Œä¸å†é‡æ–°ç”Ÿæˆ</span><br><span class="line">    // ä»£ç†ç±»è°ƒç”¨æ¥å£æ–¹æ³•</span><br><span class="line">    proxy.test();</span><br><span class="line">&#125;</span><br><span class="line">System.out.println(System.currentTimeMillis()-start);</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">long start = System.currentTimeMillis();</span><br><span class="line">Enhancer enhancer = new Enhancer();</span><br><span class="line">LogInterceptor logInterceptor = new LogInterceptor();</span><br><span class="line">for (int i = 0; i &lt; 10000; i++) &#123;</span><br><span class="line">  // è®¾ç½®è¶…ç±»ï¼Œcglibæ˜¯é€šè¿‡ç»§æ‰¿æ¥å®ç°çš„</span><br><span class="line">  enhancer.setSuperclass(UserDao.class);</span><br><span class="line">  enhancer.setCallback(logInterceptor);</span><br><span class="line">  // åˆ›å»ºä»£ç†ç±»</span><br><span class="line">  Dao dao = (Dao)enhancer.create();</span><br><span class="line">  dao.select();</span><br><span class="line">&#125;</span><br><span class="line">System.out.println(System.currentTimeMillis()-start);</span><br></pre></td></tr></table></figure>
<p>cglibåŠ¨æ€ä»£ç†åŸºäºASMæŠ€æœ¯ï¼Œä½¿ç”¨ASMæŠ€æœ¯çš„éƒ¨åˆ†å°±æ˜¯å›¾ä¸­æ ‡çº¢çš„æ¨¡å—ã€‚</p>
<blockquote>
<p><strong><a href="https://asm.ow2.io/" target="_blank" rel="noopener">ASM</a>æŠ€æœ¯æ˜¯ä¸ªå•¥ï¼Ÿ</strong><br>ASM æ˜¯ä¸€ä¸ª Java å­—èŠ‚ç æ“æ§æ¡†æ¶ã€‚å®ƒèƒ½å¤Ÿä»¥äºŒè¿›åˆ¶å½¢å¼ä¿®æ”¹å·²æœ‰ç±»æˆ–è€…åŠ¨æ€ç”Ÿæˆç±»ã€‚ASM å¯ä»¥ç›´æ¥äº§ç”ŸäºŒè¿›åˆ¶ class æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥åœ¨ç±»è¢«åŠ è½½å…¥ Java è™šæ‹Ÿæœºä¹‹å‰åŠ¨æ€æ”¹å˜ç±»è¡Œä¸ºã€‚ASM ä»ç±»æ–‡ä»¶ä¸­è¯»å…¥ä¿¡æ¯åï¼Œèƒ½å¤Ÿæ”¹å˜ç±»è¡Œä¸ºï¼Œåˆ†æç±»ä¿¡æ¯ï¼Œç”šè‡³èƒ½å¤Ÿæ ¹æ®ç”¨æˆ·è¦æ±‚ç”Ÿæˆæ–°ç±»ã€‚<br>ASMæ˜¯ä¸€ä¸ªé€šç”¨çš„Javaå­—èŠ‚ç æ“ä½œå’Œåˆ†ææ¡†æ¶ã€‚å®ƒå¯ä»¥ç›´æ¥ä»¥äºŒè¿›åˆ¶å½¢å¼ç”¨äºä¿®æ”¹ç°æœ‰ç±»æˆ–åŠ¨æ€ç”Ÿæˆç±»ã€‚ ASMæä¾›äº†ä¸€äº›å¸¸è§çš„å­—èŠ‚ç è½¬æ¢å’Œåˆ†æç®—æ³•ï¼Œå¯ä»¥ä»ä¸­æ„å»ºå®šåˆ¶çš„å¤æ‚è½¬æ¢å’Œä»£ç åˆ†æå·¥å…·ã€‚ ASMæä¾›ä¸å…¶ä»–Javaå­—èŠ‚ç æ¡†æ¶ç±»ä¼¼çš„åŠŸèƒ½ï¼Œä½†ä¾§é‡äºæ€§èƒ½ã€‚å› ä¸ºå®ƒçš„è®¾è®¡å’Œå®ç°æ˜¯å°½å¯èƒ½çš„å°å’Œå°½å¯èƒ½å¿«ï¼Œæ‰€ä»¥å®ƒéå¸¸é€‚åˆåœ¨åŠ¨æ€ç³»ç»Ÿä¸­ä½¿ç”¨ï¼ˆä½†å½“ç„¶ä¹Ÿå¯ä»¥ä»¥é™æ€æ–¹å¼ä½¿ç”¨ï¼Œä¾‹å¦‚åœ¨ç¼–è¯‘å™¨ä¸­ä½¿ç”¨ï¼‰ã€‚<br>ASMåº”ç”¨å¹¿æ³›ï¼šOpenJDK lambda call sitesï¼Œ<a href="http://hg.openjdk.java.net/jdk8/jdk8/nashorn/file/096dc407d310/src/jdk/nashorn/internal/codegen/ClassEmitter.java" target="_blank" rel="noopener">Nashorn compiler</a><br>CGLIBï¼Œä»¥åŠ¨æ€ç”Ÿæˆä»£ç†ç±»ï¼ˆç”¨äºå…¶ä»–é¡¹ç›®ï¼Œä¾‹å¦‚Mockitoå’ŒEasyMockï¼‰ï¼ŒGradleï¼Œåœ¨è¿è¡Œæ—¶ç”Ÿæˆä¸€äº›ç±»ã€‚</p>
</blockquote>
<p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>æœ‰çš„æ—¶å€™è°ƒç”¨ç›®æ ‡å¯èƒ½ä¸ä¾¿å®ç°é¢å¤–æ¥å£ï¼Œä»æŸç§è§’åº¦çœ‹ï¼Œé™å®šè°ƒç”¨è€…å®ç°æ¥å£æ˜¯æœ‰äº›ä¾µå…¥æ€§çš„å®è·µï¼Œç±»ä¼¼cglibåŠ¨æ€ä»£ç†å°±æ²¡æœ‰è¿™ç§é™åˆ¶ã€‚</li>
<li>åªæ“ä½œæˆ‘ä»¬å…³å¿ƒçš„ç±»ï¼Œä¸å¿…ä¸ºå…¶ä»–ç›¸å…³ç±»å¢åŠ å·¥ä½œé‡ã€‚</li>
<li>é«˜æ€§èƒ½ã€‚</li>
</ul>
<p>ç”Ÿæˆçš„ä»£ç†ç±»ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br></pre></td><td class="code"><pre><span class="line">//</span><br><span class="line">// Source code recreated from a .class file by IntelliJ IDEA</span><br><span class="line">// (powered by Fernflower decompiler)</span><br><span class="line">//</span><br><span class="line"></span><br><span class="line">package com.zhongyp.advanced.proxy.cglib;</span><br><span class="line"></span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line">import org.springframework.cglib.core.ReflectUtils;</span><br><span class="line">import org.springframework.cglib.core.Signature;</span><br><span class="line">import org.springframework.cglib.proxy.Callback;</span><br><span class="line">import org.springframework.cglib.proxy.Factory;</span><br><span class="line">import org.springframework.cglib.proxy.MethodInterceptor;</span><br><span class="line">import org.springframework.cglib.proxy.MethodProxy;</span><br><span class="line"></span><br><span class="line">public class UserDao$$EnhancerByCGLIB$$c00e2e9b extends UserDao implements Factory &#123;</span><br><span class="line">    private boolean CGLIB$BOUND;</span><br><span class="line">    public static Object CGLIB$FACTORY_DATA;</span><br><span class="line">    private static final ThreadLocal CGLIB$THREAD_CALLBACKS;</span><br><span class="line">    private static final Callback[] CGLIB$STATIC_CALLBACKS;</span><br><span class="line">    private MethodInterceptor CGLIB$CALLBACK_0;</span><br><span class="line">    private static Object CGLIB$CALLBACK_FILTER;</span><br><span class="line">    private static final Method CGLIB$update$0$Method;</span><br><span class="line">    private static final MethodProxy CGLIB$update$0$Proxy;</span><br><span class="line">    private static final Object[] CGLIB$emptyArgs;</span><br><span class="line">    private static final Method CGLIB$select$1$Method;</span><br><span class="line">    private static final MethodProxy CGLIB$select$1$Proxy;</span><br><span class="line">    private static final Method CGLIB$equals$2$Method;</span><br><span class="line">    private static final MethodProxy CGLIB$equals$2$Proxy;</span><br><span class="line">    private static final Method CGLIB$toString$3$Method;</span><br><span class="line">    private static final MethodProxy CGLIB$toString$3$Proxy;</span><br><span class="line">    private static final Method CGLIB$hashCode$4$Method;</span><br><span class="line">    private static final MethodProxy CGLIB$hashCode$4$Proxy;</span><br><span class="line">    private static final Method CGLIB$clone$5$Method;</span><br><span class="line">    private static final MethodProxy CGLIB$clone$5$Proxy;</span><br><span class="line"></span><br><span class="line">    static void CGLIB$STATICHOOK1() &#123;</span><br><span class="line">        CGLIB$THREAD_CALLBACKS = new ThreadLocal();</span><br><span class="line">        CGLIB$emptyArgs = new Object[0];</span><br><span class="line">        Class var0 = Class.forName(&quot;com.zhongyp.advanced.proxy.cglib.UserDao$$EnhancerByCGLIB$$c00e2e9b&quot;);</span><br><span class="line">        Class var1;</span><br><span class="line">        Method[] var10000 = ReflectUtils.findMethods(new String[]&#123;&quot;update&quot;, &quot;()V&quot;, &quot;select&quot;, &quot;()V&quot;&#125;, (var1 = Class.forName(&quot;com.zhongyp.advanced.proxy.cglib.UserDao&quot;)).getDeclaredMethods());</span><br><span class="line">        CGLIB$update$0$Method = var10000[0];</span><br><span class="line">        CGLIB$update$0$Proxy = MethodProxy.create(var1, var0, &quot;()V&quot;, &quot;update&quot;, &quot;CGLIB$update$0&quot;);</span><br><span class="line">        CGLIB$select$1$Method = var10000[1];</span><br><span class="line">        CGLIB$select$1$Proxy = MethodProxy.create(var1, var0, &quot;()V&quot;, &quot;select&quot;, &quot;CGLIB$select$1&quot;);</span><br><span class="line">        var10000 = ReflectUtils.findMethods(new String[]&#123;&quot;equals&quot;, &quot;(Ljava/lang/Object;)Z&quot;, &quot;toString&quot;, &quot;()Ljava/lang/String;&quot;, &quot;hashCode&quot;, &quot;()I&quot;, &quot;clone&quot;, &quot;()Ljava/lang/Object;&quot;&#125;, (var1 = Class.forName(&quot;java.lang.Object&quot;)).getDeclaredMethods());</span><br><span class="line">        CGLIB$equals$2$Method = var10000[0];</span><br><span class="line">        CGLIB$equals$2$Proxy = MethodProxy.create(var1, var0, &quot;(Ljava/lang/Object;)Z&quot;, &quot;equals&quot;, &quot;CGLIB$equals$2&quot;);</span><br><span class="line">        CGLIB$toString$3$Method = var10000[1];</span><br><span class="line">        CGLIB$toString$3$Proxy = MethodProxy.create(var1, var0, &quot;()Ljava/lang/String;&quot;, &quot;toString&quot;, &quot;CGLIB$toString$3&quot;);</span><br><span class="line">        CGLIB$hashCode$4$Method = var10000[2];</span><br><span class="line">        CGLIB$hashCode$4$Proxy = MethodProxy.create(var1, var0, &quot;()I&quot;, &quot;hashCode&quot;, &quot;CGLIB$hashCode$4&quot;);</span><br><span class="line">        CGLIB$clone$5$Method = var10000[3];</span><br><span class="line">        CGLIB$clone$5$Proxy = MethodProxy.create(var1, var0, &quot;()Ljava/lang/Object;&quot;, &quot;clone&quot;, &quot;CGLIB$clone$5&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    final void CGLIB$update$0() &#123;</span><br><span class="line">        super.update();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public final void update() &#123;</span><br><span class="line">        MethodInterceptor var10000 = this.CGLIB$CALLBACK_0;</span><br><span class="line">        if (this.CGLIB$CALLBACK_0 == null) &#123;</span><br><span class="line">            CGLIB$BIND_CALLBACKS(this);</span><br><span class="line">            var10000 = this.CGLIB$CALLBACK_0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (var10000 != null) &#123;</span><br><span class="line">            var10000.intercept(this, CGLIB$update$0$Method, CGLIB$emptyArgs, CGLIB$update$0$Proxy);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            super.update();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    final void CGLIB$select$1() &#123;</span><br><span class="line">        super.select();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public final void select() &#123;</span><br><span class="line">        MethodInterceptor var10000 = this.CGLIB$CALLBACK_0;</span><br><span class="line">        if (this.CGLIB$CALLBACK_0 == null) &#123;</span><br><span class="line">            CGLIB$BIND_CALLBACKS(this);</span><br><span class="line">            var10000 = this.CGLIB$CALLBACK_0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (var10000 != null) &#123;</span><br><span class="line">            var10000.intercept(this, CGLIB$select$1$Method, CGLIB$emptyArgs, CGLIB$select$1$Proxy);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            super.select();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    final boolean CGLIB$equals$2(Object var1) &#123;</span><br><span class="line">        return super.equals(var1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public final boolean equals(Object var1) &#123;</span><br><span class="line">        MethodInterceptor var10000 = this.CGLIB$CALLBACK_0;</span><br><span class="line">        if (this.CGLIB$CALLBACK_0 == null) &#123;</span><br><span class="line">            CGLIB$BIND_CALLBACKS(this);</span><br><span class="line">            var10000 = this.CGLIB$CALLBACK_0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (var10000 != null) &#123;</span><br><span class="line">            Object var2 = var10000.intercept(this, CGLIB$equals$2$Method, new Object[]&#123;var1&#125;, CGLIB$equals$2$Proxy);</span><br><span class="line">            return var2 == null ? false : (Boolean)var2;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return super.equals(var1);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    final String CGLIB$toString$3() &#123;</span><br><span class="line">        return super.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public final String toString() &#123;</span><br><span class="line">        MethodInterceptor var10000 = this.CGLIB$CALLBACK_0;</span><br><span class="line">        if (this.CGLIB$CALLBACK_0 == null) &#123;</span><br><span class="line">            CGLIB$BIND_CALLBACKS(this);</span><br><span class="line">            var10000 = this.CGLIB$CALLBACK_0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return var10000 != null ? (String)var10000.intercept(this, CGLIB$toString$3$Method, CGLIB$emptyArgs, CGLIB$toString$3$Proxy) : super.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    final int CGLIB$hashCode$4() &#123;</span><br><span class="line">        return super.hashCode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public final int hashCode() &#123;</span><br><span class="line">        MethodInterceptor var10000 = this.CGLIB$CALLBACK_0;</span><br><span class="line">        if (this.CGLIB$CALLBACK_0 == null) &#123;</span><br><span class="line">            CGLIB$BIND_CALLBACKS(this);</span><br><span class="line">            var10000 = this.CGLIB$CALLBACK_0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (var10000 != null) &#123;</span><br><span class="line">            Object var1 = var10000.intercept(this, CGLIB$hashCode$4$Method, CGLIB$emptyArgs, CGLIB$hashCode$4$Proxy);</span><br><span class="line">            return var1 == null ? 0 : ((Number)var1).intValue();</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return super.hashCode();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    final Object CGLIB$clone$5() throws CloneNotSupportedException &#123;</span><br><span class="line">        return super.clone();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected final Object clone() throws CloneNotSupportedException &#123;</span><br><span class="line">        MethodInterceptor var10000 = this.CGLIB$CALLBACK_0;</span><br><span class="line">        if (this.CGLIB$CALLBACK_0 == null) &#123;</span><br><span class="line">            CGLIB$BIND_CALLBACKS(this);</span><br><span class="line">            var10000 = this.CGLIB$CALLBACK_0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return var10000 != null ? var10000.intercept(this, CGLIB$clone$5$Method, CGLIB$emptyArgs, CGLIB$clone$5$Proxy) : super.clone();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static MethodProxy CGLIB$findMethodProxy(Signature var0) &#123;</span><br><span class="line">        String var10000 = var0.toString();</span><br><span class="line">        switch(var10000.hashCode()) &#123;</span><br><span class="line">        case -1949253108:</span><br><span class="line">            if (var10000.equals(&quot;update()V&quot;)) &#123;</span><br><span class="line">                return CGLIB$update$0$Proxy;</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">        case -1716030215:</span><br><span class="line">            if (var10000.equals(&quot;select()V&quot;)) &#123;</span><br><span class="line">                return CGLIB$select$1$Proxy;</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">        case -508378822:</span><br><span class="line">            if (var10000.equals(&quot;clone()Ljava/lang/Object;&quot;)) &#123;</span><br><span class="line">                return CGLIB$clone$5$Proxy;</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">        case 1826985398:</span><br><span class="line">            if (var10000.equals(&quot;equals(Ljava/lang/Object;)Z&quot;)) &#123;</span><br><span class="line">                return CGLIB$equals$2$Proxy;</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">        case 1913648695:</span><br><span class="line">            if (var10000.equals(&quot;toString()Ljava/lang/String;&quot;)) &#123;</span><br><span class="line">                return CGLIB$toString$3$Proxy;</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">        case 1984935277:</span><br><span class="line">            if (var10000.equals(&quot;hashCode()I&quot;)) &#123;</span><br><span class="line">                return CGLIB$hashCode$4$Proxy;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public UserDao$$EnhancerByCGLIB$$c00e2e9b() &#123;</span><br><span class="line">        CGLIB$BIND_CALLBACKS(this);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void CGLIB$SET_THREAD_CALLBACKS(Callback[] var0) &#123;</span><br><span class="line">        CGLIB$THREAD_CALLBACKS.set(var0);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void CGLIB$SET_STATIC_CALLBACKS(Callback[] var0) &#123;</span><br><span class="line">        CGLIB$STATIC_CALLBACKS = var0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static final void CGLIB$BIND_CALLBACKS(Object var0) &#123;</span><br><span class="line">        UserDao$$EnhancerByCGLIB$$c00e2e9b var1 = (UserDao$$EnhancerByCGLIB$$c00e2e9b)var0;</span><br><span class="line">        if (!var1.CGLIB$BOUND) &#123;</span><br><span class="line">            var1.CGLIB$BOUND = true;</span><br><span class="line">            Object var10000 = CGLIB$THREAD_CALLBACKS.get();</span><br><span class="line">            if (var10000 == null) &#123;</span><br><span class="line">                var10000 = CGLIB$STATIC_CALLBACKS;</span><br><span class="line">                if (CGLIB$STATIC_CALLBACKS == null) &#123;</span><br><span class="line">                    return;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            var1.CGLIB$CALLBACK_0 = (MethodInterceptor)((Callback[])var10000)[0];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Object newInstance(Callback[] var1) &#123;</span><br><span class="line">        CGLIB$SET_THREAD_CALLBACKS(var1);</span><br><span class="line">        UserDao$$EnhancerByCGLIB$$c00e2e9b var10000 = new UserDao$$EnhancerByCGLIB$$c00e2e9b();</span><br><span class="line">        CGLIB$SET_THREAD_CALLBACKS((Callback[])null);</span><br><span class="line">        return var10000;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Object newInstance(Callback var1) &#123;</span><br><span class="line">        CGLIB$SET_THREAD_CALLBACKS(new Callback[]&#123;var1&#125;);</span><br><span class="line">        UserDao$$EnhancerByCGLIB$$c00e2e9b var10000 = new UserDao$$EnhancerByCGLIB$$c00e2e9b();</span><br><span class="line">        CGLIB$SET_THREAD_CALLBACKS((Callback[])null);</span><br><span class="line">        return var10000;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Object newInstance(Class[] var1, Object[] var2, Callback[] var3) &#123;</span><br><span class="line">        CGLIB$SET_THREAD_CALLBACKS(var3);</span><br><span class="line">        UserDao$$EnhancerByCGLIB$$c00e2e9b var10000 = new UserDao$$EnhancerByCGLIB$$c00e2e9b;</span><br><span class="line">        switch(var1.length) &#123;</span><br><span class="line">        case 0:</span><br><span class="line">            var10000.&lt;init&gt;();</span><br><span class="line">            CGLIB$SET_THREAD_CALLBACKS((Callback[])null);</span><br><span class="line">            return var10000;</span><br><span class="line">        default:</span><br><span class="line">            throw new IllegalArgumentException(&quot;Constructor not found&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Callback getCallback(int var1) &#123;</span><br><span class="line">        CGLIB$BIND_CALLBACKS(this);</span><br><span class="line">        MethodInterceptor var10000;</span><br><span class="line">        switch(var1) &#123;</span><br><span class="line">        case 0:</span><br><span class="line">            var10000 = this.CGLIB$CALLBACK_0;</span><br><span class="line">            break;</span><br><span class="line">        default:</span><br><span class="line">            var10000 = null;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return var10000;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setCallback(int var1, Callback var2) &#123;</span><br><span class="line">        switch(var1) &#123;</span><br><span class="line">        case 0:</span><br><span class="line">            this.CGLIB$CALLBACK_0 = (MethodInterceptor)var2;</span><br><span class="line">        default:</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Callback[] getCallbacks() &#123;</span><br><span class="line">        CGLIB$BIND_CALLBACKS(this);</span><br><span class="line">        return new Callback[]&#123;this.CGLIB$CALLBACK_0&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setCallbacks(Callback[] var1) &#123;</span><br><span class="line">        this.CGLIB$CALLBACK_0 = (MethodInterceptor)var1[0];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static &#123;</span><br><span class="line">        CGLIB$STATICHOOK1();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-1-3-AspectJ"><a href="#3-1-3-AspectJ" class="headerlink" title="3.1.3 AspectJ"></a>3.1.3 AspectJ</h3><p>AspectJæ˜¯ç›®å‰å®ç°AOPæ¡†æ¶ä¸­æœ€æˆç†Ÿï¼ŒåŠŸèƒ½æœ€ä¸°å¯Œçš„è¯­è¨€ã€‚å½“ç„¶ï¼ŒAspectJéœ€è¦ä½¿ç”¨é¢å¤–çš„ç¼–è¯‘å™¨ã€‚</p>
<p>AspectJå¯ä»¥é€šè¿‡å¤šç§æ–¹å¼å®ç°ï¼ŒåŒ…æ‹¬æºç ç»‡å…¥æˆ–å­—èŠ‚ç ç»‡å…¥ï¼Œå¹¶ä¸”å¯ä»¥ç›´æ¥åœ¨è™šæ‹Ÿæœºï¼ˆVMï¼‰ä¸­å®ç°ã€‚åœ¨æ‰€æœ‰æƒ…å†µä¸‹ï¼ŒAspectJç¨‹åºéƒ½å°†æˆä¸ºåœ¨Java VMä¸­è¿è¡Œçš„æœ‰æ•ˆJavaç¨‹åºã€‚å—åˆ‡é¢å½±å“çš„ç±»ä¸ä¸å—å½±å“çš„ç±»å…·æœ‰äºŒè¿›åˆ¶å…¼å®¹æ€§ï¼ˆä»¥ä¿æŒä¸ä¸å—å½±å“çš„åŸå§‹æ–‡ä»¶ç¼–è¯‘çš„ç±»å…¼å®¹ï¼‰ã€‚æ”¯æŒå¤šç§å®ç°æ–¹å¼ä½¿è¯¥è¯­è¨€å¯ä»¥éšç€æŠ€æœ¯çš„å˜åŒ–è€Œå‘å±•ï¼Œå¹¶ä¸”ä¸Javaå…¼å®¹å¯ç¡®ä¿å¹³å°å¯ç”¨æ€§ã€‚<br>AspectJé‡‡ç”¨ç¼–è¯‘æœŸç»‡å…¥å’Œç±»åŠ è½½æœŸç»‡å…¥çš„æ–¹å¼ç»‡å…¥åˆ‡é¢ï¼Œæ˜¯è¯­è¨€çº§çš„AOPå®ç°ï¼Œæä¾›äº†å®Œå¤‡çš„AOPæ”¯æŒã€‚å®ƒç”¨AspectJè¯­è¨€å®šä¹‰åˆ‡é¢ï¼Œåœ¨ç¼–è¯‘æœŸæˆ–ç±»åŠ è½½æœŸå°†åˆ‡é¢ç»‡å…¥åˆ°Javaç±»ä¸­ã€‚<br>AspectJæä¾›äº†ä¸¤ç§åˆ‡é¢ç»‡å…¥æ–¹å¼ï¼Œç¬¬ä¸€ç§é€šè¿‡ç‰¹æ®Šç¼–è¯‘å™¨ï¼Œåœ¨ç¼–è¯‘æœŸï¼Œå°†AspectJè¯­è¨€ç¼–å†™çš„åˆ‡é¢ç±»ç»‡å…¥åˆ°Javaç±»ä¸­ï¼Œå¯ä»¥é€šè¿‡ä¸€ä¸ªAntæˆ–Mavenä»»åŠ¡æ¥å®Œæˆè¿™ä¸ªæ“ä½œï¼›ç¬¬äºŒç§æ–¹å¼æ˜¯ç±»åŠ è½½æœŸç»‡å…¥ï¼Œä¹Ÿç®€ç§°ä¸ºLTWï¼ˆLoad Time Weavingï¼‰ã€‚<br>ä½¿ç”¨AspectJ LTWæœ‰ä¸¤ä¸ªä¸»è¦æ­¥éª¤ï¼Œç¬¬ä¸€ï¼Œé€šè¿‡JVMçš„-javaagentå‚æ•°è®¾ç½®LTWçš„ç»‡å…¥å™¨ç±»åŒ…ï¼Œä»¥ä»£ç†JVMé»˜è®¤çš„ç±»åŠ è½½å™¨ï¼›ç¬¬äºŒï¼ŒLTWç»‡å…¥å™¨éœ€è¦ä¸€ä¸ªaop.xmlæ–‡ä»¶ï¼Œåœ¨è¯¥æ–‡ä»¶ä¸­æŒ‡å®šåˆ‡é¢ç±»å’Œéœ€è¦è¿›è¡Œåˆ‡é¢ç»‡å…¥çš„ç›®æ ‡ç±»ã€‚</p>
<p>è®¾ç½®-javaagent JVMå‚æ•°çš„æ–¹æ³•:<br>(1)åœ¨Eclipseä¸‹çš„è®¾ç½®:<br>è¿è¡Œç±»-&gt;å³é”®å•å‡»-&gt;Run As-&gt;Runâ€¦ï¼Œå¯ä»¥åœ¨å¼¹å‡ºçš„Runè®¾ç½®çª—å£è®¾ç½®è¯¥ç±»çš„å„é¡¹è¿è¡Œå±æ€§ï¼Œåˆ‡æ¢åˆ°Arguments Tabé¡µï¼Œåœ¨VM argumentsä¸­é€šè¿‡-javaagentæŒ‡å®šAspectJ ç»‡å…¥å™¨ç±»åŒ…ã€‚-javaagent:E:\workspace\lib\spring2.5\aspectjweaver.jar<br>(2)åœ¨Tomcatä¸‹çš„è®¾ç½®<br>æ‰“å¼€&lt;Tomcat_Home&gt;\bin\catalina.batï¼Œåœ¨è¯¥æ‰¹å¤„ç†æ–‡ä»¶å¤´éƒ¨æ·»åŠ ä»¥ä¸‹çš„è®¾ç½®ï¼š<br>set JAVA_OPTS=-javaagent:E:\workspace\lib\spring2.5\aspectjweaver.jar</p>
<h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h2><p>1.Javaç”ŸæˆåŠ¨æ€ä»£ç†çš„æ—¶å€™ï¼Œä½¿ç”¨WeakCacheç¼“å­˜å·²ç»ç”Ÿæˆçš„åŠ¨æ€ä»£ç†å·¥å‚ï¼Œç–‘é—®ç‚¹åœ¨äºï¼Œä¸ºä»€ä¹ˆç¼“å­˜çš„keyä½¿ç”¨çš„æ˜¯<a href="/java/2019-09-15-reference/">å¼±å¼•ç”¨</a>ï¼Ÿ</p>
<p>ç­”: ç±»ä¸­çš„é™æ€å˜é‡ï¼Œå½“å®ƒæŒæœ‰ä¸€ä¸ªæŒ‡å‘ä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨æ—¶ï¼Œå®ƒå°±ä½œä¸ºGC Rootï¼Œç¬¬ä¸€ç±»è¢«åˆ—ä¸ºGC Rootçš„å…ƒç´ å°±æ˜¯é™æ€æˆå‘˜å˜é‡ã€‚å› æ­¤è‹¥ç¼“å­˜ä¸å†éœ€è¦æ—¶ï¼Œä½¿ç”¨å¼ºå¼•ç”¨ä¼šè®©GCè¿›è¡Œæ ‡è®°åˆ†ææ—¶è®¤ä¸ºä»GC Rootå¯è¾¾ï¼Œä¸å¤ªä¼šå»æ ‡è®°è¿™å—å†…å­˜ï¼Œåä¹‹èƒ½å¤Ÿæœ‰æ•ˆåœ°æ ‡è®°è¿™äº›ç¼“å­˜ï¼Œä»è€Œæé«˜å†…å­˜å›æ”¶æ•ˆç‡ã€‚å¼•ç”¨è‡ª<a href="https://segmentfault.com/q/1010000011711958" target="_blank" rel="noopener">ä¸ºä»€ä¹ˆjdkåŠ¨æ€ä»£ç†ç±»çš„ç¼“å­˜æ˜¯å¼±å¼•ç”¨</a></p>
<p>ä¸ªäººåˆ†æ: æ—¢ç„¶ç¼“å­˜ä»£ç†å·¥å‚ç±»ï¼Œä¸ºä»€ä¹ˆä¸ä½¿ç”¨SoftReferenceï¼Œè¿™æ ·åªæœ‰å†…å­˜ç©ºé—´ä¸å¤Ÿæ—¶æ‰ä¼šè¿›è¡Œå›æ”¶ã€‚è¿™æ ·å¯ä»¥æœ€å¤§é™åº¦çš„ç¼“å­˜ç”Ÿæˆçš„ä»£ç†å·¥å‚ï¼Ÿ<br>å¦‚æœä½¿ç”¨SoftReferenceï¼Œå½“æœåŠ¡ä½¿ç”¨åŠ¨æ€ä»£ç†è¾ƒå¤šæ—¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´é¢‘ç¹çš„FullGCã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a href="https://www.ibm.com/developerworks/cn/java/j-lo-proxy1/index.html" target="_blank" rel="noopener">JavaåŠ¨æ€ä»£ç†æœºåˆ¶åˆ†æåŠæ‰©å±•ï¼Œç¬¬1éƒ¨åˆ†</a><br><a href="https://www.cnblogs.com/whirly/p/10154887.html" target="_blank" rel="noopener">Java åŠ¨æ€ä»£ç†è¯¦è§£</a><br><a href="https://tech.meituan.com/2019/09/05/java-bytecode-enhancement.html" target="_blank" rel="noopener">å­—èŠ‚ç å¢å¼ºæŠ€æœ¯æ¢ç´¢</a><br><a href="https://segmentfault.com/q/1010000011711958" target="_blank" rel="noopener">ä¸ºä»€ä¹ˆjdkåŠ¨æ€ä»£ç†ç±»çš„ç¼“å­˜æ˜¯å¼±å¼•ç”¨</a><br><a href="https://docs.oracle.com/javase/tutorial/reflect/index.html" target="_blank" rel="noopener">Java Reflection API</a><br><a href="https://www.iteye.com/blog/log-cd-562056" target="_blank" rel="noopener">AspectJ LTW(Load Time Weaving)</a><br><a href="https://www.eclipse.org/aspectj/doc/released/progguide/index.html" target="_blank" rel="noopener">The AspectJTM Programming Guide</a></p>

  </div>
  <div>
        <ul class="post-copyright">
          <li class="post-copyright-author">
            <strong>æœ¬æ–‡ä½œè€…ï¼š </strong>zhongyp</li>
          <li class="post-copyright-link">
            <strong>æœ¬æ–‡é“¾æ¥ï¼š</strong>
            <a href="https://zhongyp.me/java/2019-09-09-java-proxy/" title="ä½¿ç”¨simpleä¸»é¢˜å¹¶å¼€å§‹å†™ä½œ">https://zhongyp.me/java/2019-09-09-java-proxy/</a>
          </li>
          <li class="post-copyright-license">
            <strong>ç‰ˆæƒå£°æ˜ï¼š </strong>æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</li>
        </ul>

  </div>
  <div class="post-tags">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li></ul>
  </div>
</article>
  
    <div class="post-nav">
      <div class="post-nav-item post-nav-next">
        
          <span>ã€ˆ </span>
          <a href="/jvm/2019-08-18-jvm-classloading/" rel="next" title="Javaè™šæ‹Ÿæœºç±»åŠ è½½æœºåˆ¶">
          Javaè™šæ‹Ÿæœºç±»åŠ è½½æœºåˆ¶
          </a>
        
      </div>
  
      <div class="post-nav-item post-nav-prev">
        
          <a href="/jvm/2019-09-08-jvm-structure/" rel="prev" title="Javaè™šæ‹ŸæœºçŸ¥è¯†ç‚¹æ¶æ„å›¾">
            Javaè™šæ‹ŸæœºçŸ¥è¯†ç‚¹æ¶æ„å›¾
          </a>
          <span>ã€‰</span>
        
      </div>
    </div>
  


  <div id="toc" class="toc-article">
    <strong class="toc-title">ç›®å½•</strong>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-åŠ¨æ€ä»£ç†"><span class="toc-text">1. åŠ¨æ€ä»£ç†</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-åå°„"><span class="toc-text">2. åå°„</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-å¸¸ç”¨çš„ä¸‰ç§ä»£ç†æ–¹å¼"><span class="toc-text">3. å¸¸ç”¨çš„ä¸‰ç§ä»£ç†æ–¹å¼</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-JavaåŠ¨æ€ä»£ç†ç±»"><span class="toc-text">3.1 JavaåŠ¨æ€ä»£ç†ç±»</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-1-JavaåŠ¨æ€ä»£ç†æºç è§£æ"><span class="toc-text">3.1.1 JavaåŠ¨æ€ä»£ç†æºç è§£æ</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-2-CglibåŠ¨æ€ä»£ç†"><span class="toc-text">3.1.2 CglibåŠ¨æ€ä»£ç†</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-3-AspectJ"><span class="toc-text">3.1.3 AspectJ</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FAQ"><span class="toc-text">FAQ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#å‚è€ƒèµ„æ–™"><span class="toc-text">å‚è€ƒèµ„æ–™</span></a></li></ol>
  </div>



<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>

    </div>

    

  </div>

  <footer class="footer text-center">
    <div id="bottom-inner">

      <a href="http://programer.group" target="_blank">ä¸»ç«™</a> |
      <a href="http://zhongyp.me">DO IT</a> |
      <a href="https://github.com/zhongyp" target="_blank">GitHub</a> |
      <a href="http://hexo.io" target="_blank">Hexo</a> |
      <a href="https://github.com/zhongyp/hexo-theme-simple" target="_blank">Theme simple</a> |
      <a href="https://github.com/microacup/hexo-theme-micorb" target="_blank">Base on theme microb</a> |
      <a><span id="busuanzi_container_site_pv">æœ¬ç«™è®¿å®¢æ•°<span id="busuanzi_value_site_uv"></span>äººæ¬¡</span></a> |
      <a><span id="busuanzi_container_site_pv">æœ¬ç«™è®¿é—®é‡<span id="busuanzi_value_site_pv"></span>æ¬¡</span></a>
    </div>
  </footer>

  

<script>
  (function(window, document, undefined) {

    var timer = null;

    function returnTop() {
      cancelAnimationFrame(timer);
      timer = requestAnimationFrame(function fn() {
        var oTop = document.body.scrollTop || document.documentElement.scrollTop;
        if (oTop > 0) {
          document.body.scrollTop = document.documentElement.scrollTop = oTop - 50;
          timer = requestAnimationFrame(fn);
        } else {
          cancelAnimationFrame(timer);
        }
      });
    }

    var hearts = [];
    window.requestAnimationFrame = (function() {
      return window.requestAnimationFrame ||
        window.webkitRequestAnimationFrame ||
        window.mozRequestAnimationFrame ||
        window.oRequestAnimationFrame ||
        window.msRequestAnimationFrame ||
        function(callback) {
          setTimeout(callback, 1000 / 60);
        }
    })();
    init();

    function init() {
      css(".heart{z-index:9999;width: 10px;height: 10px;position: fixed;background: #f00;transform: rotate(45deg);-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);}.heart:after,.heart:before{content: '';width: inherit;height: inherit;background: inherit;border-radius: 50%;-webkit-border-radius: 50%;-moz-border-radius: 50%;position: absolute;}.heart:after{top: -5px;}.heart:before{left: -5px;}");
      attachEvent();
      gameloop();
      addMenuEvent();
    }

    function gameloop() {
      for (var i = 0; i < hearts.length; i++) {
        if (hearts[i].alpha <= 0) {
          document.body.removeChild(hearts[i].el);
          hearts.splice(i, 1);
          continue;
        }
        hearts[i].y--;
        hearts[i].scale += 0.004;
        hearts[i].alpha -= 0.013;
        hearts[i].el.style.cssText = "left:" + hearts[i].x + "px;top:" + hearts[i].y + "px;opacity:" + hearts[i].alpha + ";transform:scale(" + hearts[i].scale + "," + hearts[i].scale + ") rotate(45deg);background:" + hearts[i].color;
      }
      requestAnimationFrame(gameloop);
    }

    /**
     * ç»™logoè®¾ç½®ç‚¹å‡»äº‹ä»¶
     *
     * - å›åˆ°é¡¶éƒ¨
     * - å‡ºç°çˆ±å¿ƒ
     */
    function attachEvent() {
      var old = typeof window.onclick === "function" && window.onclick;
      var logo = document.getElementById("logo");
      if (logo) {
        logo.onclick = function(event) {
          returnTop();
          old && old();
          createHeart(event);
        }
      }

    }

    function createHeart(event) {
      var d = document.createElement("div");
      d.className = "heart";
      hearts.push({
        el: d,
        x: event.clientX - 5,
        y: event.clientY - 5,
        scale: 1,
        alpha: 1,
        color: randomColor()
      });
      document.body.appendChild(d);
    }

    function css(css) {
      var style = document.createElement("style");
      style.type = "text/css";
      try {
        style.appendChild(document.createTextNode(css));
      } catch (ex) {
        style.styleSheet.cssText = css;
      }
      document.getElementsByTagName('head')[0].appendChild(style);
    }

    function randomColor() {
      // return "rgb(" + (~~(Math.random() * 255)) + "," + (~~(Math.random() * 255)) + "," + (~~(Math.random() * 255)) + ")";
      return "#F44336";
    }

    function addMenuEvent() {
      // var menu = document.getElementById('menu-main-post');
      // if (menu) {
      //   var toc = document.getElementById('toc');
      //   if (toc) {
      //     menu.onclick = function() {
      //       if (toc) {
      //         if (toc.style.display == 'block') {
      //           toc.style.display = 'none';
      //         } else {
      //           toc.style.display = 'block';
      //         }
      //       }
      //     };
      //   } else {
      //     menu.style.display = 'none';
      //   }
      // }
    }

  })(window, document);
</script>


  



</body>
</html>
